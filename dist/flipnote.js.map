{"version":3,"sources":["webpack://flipnote/webpack/universalModuleDefinition","webpack://flipnote/webpack/bootstrap","webpack://flipnote/./encoders/bmp.js","webpack://flipnote/./encoders/gif.js","webpack://flipnote/./encoders/lzw.js","webpack://flipnote/./encoders/wav.js","webpack://flipnote/./flipnote.js","webpack://flipnote/./loader/arrayBufferLoader.js","webpack://flipnote/./loader/fileLoader.js","webpack://flipnote/./loader/index.js","webpack://flipnote/./loader/urlLoader.js","webpack://flipnote/./parser/index.js","webpack://flipnote/./parser/kwz.js","webpack://flipnote/./parser/ppm.js","webpack://flipnote/./player/audio.js","webpack://flipnote/./player/index.js","webpack://flipnote/./utils/adpcm.js","webpack://flipnote/./utils/byteArray.js","webpack://flipnote/./utils/dataStream.js","webpack://flipnote/./webgl/canvas.js","webpack://flipnote/./webgl/shader.frag","webpack://flipnote/./webgl/shader.vert"],"names":["roundToNearest","value","n","Math","ceil","BitmapEncoder","width","height","bpp","vWidth","vHeight","fileHeader","dataStream","ArrayBuffer","writeUtf8","dibHeader","writeUint32","writeInt32","writeUint16","seek","colors","palette","Uint32Array","pow","index","length","color","setPaletteCount","setCompression","pixelData","pixels","pixelsLength","Uint8Array","w","y","srcOffset","destOffset","set","slice","sections","buffer","headerByteLength","byteLength","setFilelength","setPixelOffset","concat","Blob","type","window","URL","createObjectURL","getBlob","img","Image","src","getUrl","flipnote","frameIndex","format","constructor","bmp","setPixels","getFramePixels","setPalette","getFramePalette","GifEncoder","delay","repeat","colorDepth","data","ByteArray","paletteSize","p","writeHeader","writeColorTable","writeNetscapeExt","header","writeUint8","writeBytes","graphicsControlExt","netscapeExt","desc","lzw","LZWEncoder","encode","writeGraphicsControlExt","writeImageDesc","writePixels","getBuffer","gif","globalPalette","flat","framerate","meta","loop","init","frameCount","writeFrame","EOF","BITS","HSIZE","masks","initCodeSize","max","accum","htab","Int32Array","codetab","cur_accum","cur_bits","a_count","remaining","curPixel","free_ent","maxcode","clear_flg","g_init_bits","undefined","ClearCode","EOFCode","c","outs","flush_char","cl_hash","output","hsize","i","init_bits","fcode","ent","disp","hsize_reg","hshift","n_bits","get_maxcode","nextPixel","outer_loop","cl_block","writeByte","compress","pix","code","char_out","WavEncoder","sampleRate","channels","bitsPerSample","headerBuffer","pcmData","version","VERSION","player","parser","ppmParser","kwzParser","bitmapEncoder","gifEncoder","wavEncoder","matches","source","load","resolve","reject","File","reader","FileReader","onload","event","target","result","onerror","readAsArrayBuffer","loaders","urlLoader","fileLoader","arrayBufferLoader","Promise","loader","xhr","XMLHttpRequest","open","responseType","onreadystatechange","e","readyState","status","response","statusText","send","arrayBuffer","DataView","magic","getUint32","FRAMERATES","PALETTE","WHITE","BLACK","RED","YELLOW","GREEN","BLUE","NONE","PALETTE_INDEX_MAP","TABLE_1","Uint16Array","TABLE_2","TABLE_3","values","a","b","d","LINE_TABLE","offset","f","g","h","_layers","_bitIndex","_bitValue","size","sectionCount","sectionMagic","readUtf8","substring","sectionLength","readUint32","_decodeMeta","_decodeFrameMeta","_decodeSoundHeader","_prevDecodedFrame","num","nextBits","readUint16","mask","creationTimestamp","Date","modifiedTimestamp","appVersion","rootAuthorId","readHex","parentAuthorId","currentAuthorId","rootAuthorName","readUtf16","parentAuthorName","currentAuthorName","rootFilename","parentFilename","currentFilename","thumbIndex","flags","frameSpeed","readUint8","layerFlags","thumbFrameIndex","lock","frame_count","frame_speed","thumb_index","timestamp","creation_timestamp","root","username","fsid","filename","parent","current","frameMeta","frameOffsets","frame","layerSize","frameAuthor","layerDepth","soundFlags","cameraFlag","push","bgmSpeed","bgmrate","trackSizes","soundMeta","depths","getLayerDepths","sort","diffingFlag","isPrevFrame","getDiffingFlag","decodeFrame","layerIndex","skip","tileOffsetY","tileOffsetX","subTileOffsetY","subTileOffsetX","x","pixelOffset","pixelBuffer","readBits","lineIndex","subarray","lineValue","lineIndexA","lineIndexB","line","pattern","useTable","layer","image","paletteOffset","pixel","useGlobalPalette","paletteMap","framePalette","map","indexOf","fill","layerOrder","getLayerOrder","forEach","getLayerPixels","trackIndex","id","track","Int16Array","outputOffset","adpcm","prevDiff","prevStepIndex","sample","diff","stepIndex","byte","bitPos","ADPCM_SAMPLE_TABLE_2","ADPCM_INDEX_TABLE_2","ADPCM_SAMPLE_TABLE_4","ADPCM_INDEX_TABLE_4","min","WIDTH","HEIGHT","_decodeHeader","_decodeAnimationHeader","_prevLayers","toString","padStart","join","unpacked","byteOffset","bitOffset","_frameDataLength","_soundDataLength","readInt16","readFilename","bgm_speed","spinoff","offsetTableLength","_frameOffsets","bgmLen","se1Len","se2Len","se3Len","paperColor","pen","isNewFrame","isTranslated","translateX","translateY","readInt8","layerEncoding","readLineEncoding","layerBitmap","chunkOffset","lineType","lineHeader","chunk","dest","layerColor","layers","arr","Array","test","audioTrack","channelCount","playbackRate","audio","document","createElement","preload","active","wav","writeFrames","url","revokeObjectURL","currentTime","play","pause","duration","flipnotePlayer","el","querySelector","canvas","_imgCanvas","antialias","preserveDrawingBuffer","_isOpen","_events","currentFrame","paused","customPalette","audioTracks","smoothRendering","note","fileLength","hasAudioTrack","decodeAudio","_audiorate","_seFlags","decodeSoundFlags","_playbackLoop","_hasPlaybackStarted","layerVisiblity","setMode","setFrame","emit","close","then","_load","catch","err","console","error","_frame","unset","clear","destroy","start","stop","_playBgm","setInterval","clearInterval","_stopAudio","firstFrame","_playFrameSe","nextFrame","encoderOptions","resize","drawFrame","toImage","forceUpdate","floor","_playbackFrameTime","layerBuffers","setPaperColor","drawLayer","filter","setFilter","mode","eventType","callback","events","callbackList","splice","args","apply","round","volume","muted","Int8Array","ADPCM_STEP_TABLE","step","page","pages","newPage","pageSize","cursor","getData","val","array","l","_data","_offset","whence","getUint8","setUint8","getInt8","setInt8","littleEndian","getUint16","setUint16","getInt16","setInt16","setUint32","getInt32","setInt32","count","bytes","reverse","readBytes","hex","toUpperCase","chars","str","char","String","fromCharCode","string","charCodeAt","webglCanvas","params","alpha","gl","getContext","program","createProgram","refs","shaders","textures","buffers","vShader","_createShader","VERTEX_SHADER","vertexShader","fShader","FRAGMENT_SHADER","fragmentShader","attachShader","linkProgram","getProgramParameter","LINK_STATUS","log","getProgramInfoLog","deleteProgram","Error","useProgram","vertBuffer","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","Float32Array","STATIC_DRAW","enableVertexAttribArray","vertexAttribPointer","FLOAT","activeTexture","TEXTURE0","tex","createTexture","bindTexture","TEXTURE_2D","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","uniforms","uniformCount","ACTIVE_UNIFORMS","name","getActiveUniform","getUniformLocation","uniform1i","u_bitmap","enable","BLEND","blendFunc","ONE","ONE_MINUS_SRC_ALPHA","shader","createShader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","deleteShader","toDataURL","LINEAR","NEAREST","u_isSmooth","TEXTURE_MIN_FILTER","TEXTURE_MAG_FILTER","textureType","ALPHA","LUMINANCE_ALPHA","uniform4f","clearColor","color1","color2","depth","texImage2D","UNSIGNED_BYTE","setColor","drawArrays","TRIANGLES","viewport","COLOR_BUFFER_BIT","texture","deleteTexture","deleteBuffer"],"mappings":"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","file":"flipnote.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"flipnote\"] = factory();\n\telse\n\t\troot[\"flipnote\"] = factory();\n})(typeof self !== 'undefined' ? self : this, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","import dataStream from \"../utils/dataStream\";\n\n// round number to nearest multiple of n\nexport function roundToNearest(value, n) {\n  return Math.ceil(value / n) * n;\n}\n\n// simple bitmap class for rendering images\n// https://en.wikipedia.org/wiki/BMP_file_format\n\nexport default class BitmapEncoder {\n\n  constructor(width, height, bpp) {\n    this.width = width;\n    this.height = height;\n    this.vWidth = roundToNearest(width, 4);\n    this.vHeight = roundToNearest(height, 4);\n    this.bpp = bpp;\n    this.fileHeader = new dataStream(new ArrayBuffer(14));\n    this.fileHeader.writeUtf8(\"BM\"); // \"BM\" file magic\n    // using BITMAPV4HEADER dib header variant:\n    this.dibHeader = new dataStream(new ArrayBuffer(108))\n    this.dibHeader.writeUint32(108); // DIB header length\n    this.dibHeader.writeInt32(width); // width\n    this.dibHeader.writeInt32(height); // height\n    this.dibHeader.writeUint16(1); // color panes (always 1)\n    this.dibHeader.writeUint16(bpp); // bits per pixel\n    this.dibHeader.writeUint32(3); // compression method (3 = BI_BITFIELDS for rgba, 0 = no compression for 8 bit)\n    this.dibHeader.writeUint32((this.vWidth * this.height) / (bpp / 8)); // image data size, (width * height) / bits per pixel\n    this.dibHeader.writeUint32(3780); // x res, pixel per meter\n    this.dibHeader.writeUint32(3780); // y res, pixel per meter\n    this.dibHeader.writeUint32(0); // the number of colors in the color palette, set by setPalette() method\n    this.dibHeader.writeUint32(0); // the number of important colors used, or 0 when every color is important; generally ignored\n    this.dibHeader.writeUint32(0x00FF0000); // red channel bitmask\n    this.dibHeader.writeUint32(0x0000FF00); // green channel bitmask\n    this.dibHeader.writeUint32(0x000000FF); // blue channel bitmask\n    this.dibHeader.writeUint32(0xFF000000); // alpha channel bitmask\n    this.dibHeader.writeUtf8(\"Win \"); // LCS_WINDOWS_COLOR_SPACE \"Win \"\n    /// rest can be left as nulls\n  }\n\n  static fromFlipnoteFrame(flipnote, frameIndex) {\n    const format = flipnote.constructor;\n    const bmp = new BitmapEncoder(format.width, format.height, 8);\n    bmp.setPixels(flipnote.getFramePixels(frameIndex));\n    bmp.setPalette(flipnote.getFramePalette(frameIndex));\n    return bmp;\n  }\n\n  setFilelength(value) {\n    this.fileHeader.seek(2);\n    this.fileHeader.writeUint32(value);\n  }\n\n  setPixelOffset(value) {\n    this.fileHeader.seek(10);\n    this.fileHeader.writeUint32(value);\n  }\n\n  setCompression(value) {\n    this.dibHeader.seek(16);\n    this.dibHeader.writeUint32(value);\n  }\n\n  setPaletteCount(value) {\n    this.dibHeader.seek(32);\n    this.dibHeader.writeUint32(value);\n  }\n\n  setPalette(colors) {\n    let palette = new Uint32Array(Math.pow(2, this.bpp));\n    for (let index = 0; index < colors.length; index++) {\n      let color = colors[index % colors.length];\n      // bmp color order is ARGB\n      palette[index] = 0xFF000000 | (color[0] << 16) | (color[1] << 8) | (color[2]);\n    }\n    this.setPaletteCount(palette.length); // set number of colors in DIB header\n    this.setCompression(0); // set compression to 0 so we're not using 32 bit\n    this.palette = palette;\n  }\n\n  setPixels(pixelData) {\n    let pixels;\n    let pixelsLength = this.vWidth * this.height;\n    switch (this.bpp) {\n      case 8:\n        pixels = new Uint8Array(pixelsLength);\n        break;\n      case 32:\n        pixels = new Uint32Array(pixelsLength);\n        break;\n    }\n    // pixel rows are stored \"upside down\" in bmps\n    let w = this.width;\n    for (let y = 0; y < this.height; y++) {\n      let srcOffset = (w * this.height) - ((y + 1) * w);\n      let destOffset = (y * this.width);\n      pixels.set(pixelData.slice(srcOffset, srcOffset + this.width), destOffset);\n    }\n    this.pixels = pixels;\n  }\n\n  getBlob() {\n    let sections = [this.fileHeader.buffer, this.dibHeader.buffer];\n    let headerByteLength = this.fileHeader.byteLength + this.dibHeader.byteLength;\n    switch (this.bpp) {\n      case 1:\n      case 4:\n      case 8:\n        this.setFilelength(headerByteLength + this.pixels.byteLength + this.palette.byteLength);\n        this.setPixelOffset(headerByteLength + this.palette.byteLength);\n        sections = sections.concat([this.palette.buffer, this.pixels.buffer]);\n        break;\n      case 16:\n      case 32:\n        this.setFilelength(headerByteLength + this.pixels.byteLength);\n        this.setPixelOffset(headerByteLength);\n        sections = sections.concat([this.pixels.buffer]);\n        break;\n    }\n    return new Blob(sections, {type: \"image/bitmap\"})\n  }\n\n  getUrl() {\n    return window.URL.createObjectURL(this.getBlob());\n  }\n\n  getImage() {\n    var img = new Image(this.width, this.height);\n    img.src = this.getUrl();\n    return img;\n  }\n\n}\n","import dataStream from \"../utils/dataStream\";\nimport { ByteArray } from \"../utils/byteArray\";\nimport { LZWEncoder } from \"./lzw\";\n\nexport default class GifEncoder {\n  constructor(width, height) {\n    this.width = width;\n    this.height = height;\n    this.delay = 100;\n    // -1 = no repeat, 0 = forever. anything else is repeat count\n    this.repeat = -1;\n    this.colorDepth = 8;\n    this.palette = [];\n    this.data = new ByteArray();\n  }\n\n  static fromFlipnote(flipnote) {\n    const format = flipnote.constructor;\n    const gif = new GifEncoder(format.width, format.height);\n    gif.palette = format.globalPalette.flat();\n    gif.delay = 100 / flipnote.framerate\n    gif.repeat = flipnote.meta.loop ? -1 : 0;\n    gif.init();\n    for (let frameIndex = 0; frameIndex < flipnote.frameCount; frameIndex++) {\n      gif.writeFrame(flipnote.getFramePixels(frameIndex, true));\n    }\n    return gif;\n  }\n\n  static fromFlipnoteFrame(flipnote, frameIndex) {\n    const format = flipnote.constructor;\n    const gif = new GifEncoder(format.width, format.height);\n    gif.palette = format.globalPalette.flat();\n    gif.delay = 100 / flipnote.framerate\n    gif.repeat = flipnote.meta.loop ? -1 : 0;\n    gif.init();\n    gif.writeFrame(flipnote.getFramePixels(frameIndex, true));\n    return gif;\n  }\n\n  init() {\n    let paletteSize = this.palette.length / 3;\n    for (var p = 1; 1 << p < paletteSize; p += 1) {\n      continue;\n    }\n    this.colorDepth = p;\n    this.writeHeader();\n    this.writeColorTable();\n    this.writeNetscapeExt();\n  }\n\n  writeHeader() {\n    const header = new dataStream(new ArrayBuffer(13));\n    header.writeUtf8(\"GIF89a\");\n    // Logical Screen Descriptor\n    header.writeUint16(this.width);\n    header.writeUint16(this.height);\n    header.writeUint8(\n      0x80 | // 1 : global color table flag = 1 (gct used)\n      (this.colorDepth - 1) // 6-8 : gct size\n    );\n    header.writeUint8(0);\n    header.writeUint8(0);\n    this.data.writeBytes(new Uint8Array(header.buffer));\n  }\n\n  writeColorTable() {\n    const palette = new Uint8Array(3 * Math.pow(2, this.colorDepth));\n    palette.set(this.palette, 0);\n    this.data.writeBytes(palette);\n  }\n\n  writeGraphicsControlExt() {\n    const graphicsControlExt = new dataStream(new ArrayBuffer(8));\n    graphicsControlExt.writeBytes([\n      0x21, // extension introducer\n      0xF9, // graphic control label\n      4, // block size\n      0 // bitfield\n    ]);\n    graphicsControlExt.writeUint16(this.delay); // loop flag\n    graphicsControlExt.writeBytes([\n      0,\n      0\n    ]);\n    this.data.writeBytes(new Uint8Array(graphicsControlExt.buffer));\n  }\n\n  writeNetscapeExt() {\n    const netscapeExt = new dataStream(new ArrayBuffer(19));\n    netscapeExt.writeBytes([\n      0x21, // extension introducer\n      0xFF, // app extension label\n      11, // block size\n    ]);\n    netscapeExt.writeUtf8('NETSCAPE2.0');\n    netscapeExt.writeUint8(3); // subblock size\n    netscapeExt.writeUint8(1); // loop subblock id\n    netscapeExt.writeUint16(this.repeat); // loop flag\n    this.data.writeBytes(new Uint8Array(netscapeExt.buffer));\n  }\n\n  writeImageDesc() {\n    const desc = new dataStream(new ArrayBuffer(10));\n    desc.writeUint8(0x2C);\n    desc.writeUint16(0); // image left\n    desc.writeUint16(0); // image top\n    desc.writeUint16(this.width);\n    desc.writeUint16(this.height);\n    desc.writeUint8(0);\n    this.data.writeBytes(new Uint8Array(desc.buffer));\n  }\n\n  writePixels(pixels) {\n    const lzw = new LZWEncoder(this.width, this.height, pixels, this.colorDepth);\n    lzw.encode(this.data);\n  }\n\n  writeFrame(pixels) {\n    this.writeGraphicsControlExt();\n    this.writeImageDesc();\n    this.writePixels(pixels);\n  }\n\n  getBuffer() {\n    return this.data.getBuffer();\n  }\n\n  getBlob() {\n    return new Blob([this.getBuffer()], {type: \"image/gif\"})\n  }\n\n  getUrl() {\n    return window.URL.createObjectURL(this.getBlob());\n  }\n\n  getImage() {\n    var img = new Image(this.width, this.height);\n    img.src = this.getUrl();\n    return img;\n  }\n}","/*\n  LZWEncoder.js\n\n  Authors\n  Kevin Weiner (original Java version - kweiner@fmsware.com)\n  Thibault Imbert (AS3 version - bytearray.org)\n  Johan Nordberg (JS version - code@johan-nordberg.com)\n  James Daniel (ES6 version)\n\n  Acknowledgements\n  GIFCOMPR.C - GIF Image compression routines\n  Lempel-Ziv compression based on 'compress'. GIF modifications by\n  David Rowley (mgardi@watdcsu.waterloo.edu)\n  GIF Image compression - modified 'compress'\n  Based on: compress.c - File compression ala IEEE Computer, June 1984.\n  By Authors: Spencer W. Thomas (decvax!harpo!utah-cs!utah-gr!thomas)\n  Jim McKie (decvax!mcvax!jim)\n  Steve Davies (decvax!vax135!petsd!peora!srd)\n  Ken Turkowski (decvax!decwrl!turtlevax!ken)\n  James A. Woods (decvax!ihnp4!ames!jaw)\n  Joe Orost (decvax!vax135!petsd!joe)\n*/\n\nconst EOF = -1;\nconst BITS = 12;\nconst HSIZE = 5003; // 80% occupancy\nconst masks = [0x0000, 0x0001, 0x0003, 0x0007, 0x000F, 0x001F,\n             0x003F, 0x007F, 0x00FF, 0x01FF, 0x03FF, 0x07FF,\n             0x0FFF, 0x1FFF, 0x3FFF, 0x7FFF, 0xFFFF];\n\nexport class LZWEncoder {\n  constructor(width, height, pixels, colorDepth) {\n    this.width = width;\n    this.height = height;\n    this.pixels = pixels;\n    this.colorDepth = colorDepth;\n    this.initCodeSize = Math.max(2, this.colorDepth);\n    this.accum = new Uint8Array(256);\n    this.htab = new Int32Array(HSIZE);\n    this.codetab = new Int32Array(HSIZE);\n    this.cur_accum = 0;\n    this.cur_bits = 0;\n    this.a_count;\n    this.remaining;\n    this.curPixel = 0;\n    this.free_ent = 0; // first unused entry\n    this.maxcode;\n    // block compression parameters -- after all codes are used up,\n    // and compression rate changes, start over.\n    this.clear_flg = false;\n    // Algorithm: use open addressing double hashing (no chaining) on the\n    // prefix code / next character combination. We do a variant of Knuth's\n    // algorithm D (vol. 3, sec. 6.4) along with G. Knott's relatively-prime\n    // secondary probe. Here, the modular division first probe is gives way\n    // to a faster exclusive-or manipulation. Also do block compression with\n    // an adaptive reset, whereby the code table is cleared when the compression\n    // ratio decreases, but after the table fills. The variable-length output\n    // codes are re-sized at this point, and a special CLEAR code is generated\n    // for the decompressor. Late addition: construct the table according to\n    // file size for noticeable speed improvement on small files. Please direct\n    // questions about this implementation to ames!jaw.\n    this.g_init_bits = undefined;\n    this.ClearCode = undefined;\n    this.EOFCode = undefined;\n  }\n\n  // Add a character to the end of the current packet, and if it is 254\n  // characters, flush the packet to disk.\n  char_out(c, outs) {\n    this.accum[this.a_count++] = c;\n    if (this.a_count >= 254) this.flush_char(outs);\n  }\n\n  // Clear out the hash table\n  // table clear for block compress\n  cl_block(outs) {\n    cl_hash(HSIZE);\n    this.free_ent = this.ClearCode + 2;\n    this.clear_flg = true;\n    output(this.ClearCode, outs);\n  }\n\n  // Reset code table\n  cl_hash(hsize) {\n    for (var i = 0; i < hsize; ++i) this.htab[i] = -1;\n  }\n\n  compress(init_bits, outs) {\n    var fcode, c, i, ent, disp, hsize_reg, hshift;\n\n    // Set up the globals: this.g_init_bits - initial number of bits\n    this.g_init_bits = init_bits;\n\n    // Set up the necessary values\n    this.clear_flg = false;\n    this.n_bits = this.g_init_bits;\n    this.maxcode = this.get_maxcode(this.n_bits);\n\n    this.ClearCode = 1 << (init_bits - 1);\n    this.EOFCode = this.ClearCode + 1;\n    this.free_ent = this.ClearCode + 2;\n\n    this.a_count = 0; // clear packet\n\n    ent = this.nextPixel();\n\n    hshift = 0;\n    for (fcode = HSIZE; fcode < 65536; fcode *= 2) ++hshift;\n    hshift = 8 - hshift; // set hash code range bound\n    hsize_reg = HSIZE;\n    this.cl_hash(hsize_reg); // clear hash table\n\n    this.output(this.ClearCode, outs);\n\n    outer_loop: while ((c = this.nextPixel()) != EOF) {\n      fcode = (c << BITS) + ent;\n      i = (c << hshift) ^ ent; // xor hashing\n      if (this.htab[i] === fcode) {\n        ent = this.codetab[i];\n        continue;\n      } else if (this.htab[i] >= 0) { // non-empty slot\n        disp = hsize_reg - i; // secondary hash (after G. Knott)\n        if (i === 0) disp = 1;\n        do {\n          if ((i -= disp) < 0) i += hsize_reg;\n          if (this.htab[i] === fcode) {\n            ent = this.codetab[i];\n            continue outer_loop;\n          }\n        } while (this.htab[i] >= 0);\n      }\n      this.output(ent, outs);\n      ent = c;\n      if (this.free_ent < 1 << BITS) {\n        this.codetab[i] = this.free_ent++; // code -> hasthis.htable\n        this.htab[i] = fcode;\n      } else {\n        this.cl_block(outs);\n      }\n    }\n\n    // Put out the final code.\n    this.output(ent, outs);\n    this.output(this.EOFCode, outs);\n  }\n\n  encode(outs) {\n    outs.writeByte(this.initCodeSize); // write \"initial code size\" byte\n    this.remaining = this.width * this.height; // reset navigation variables\n    this.curPixel = 0;\n    this.compress(this.initCodeSize + 1, outs); // compress and write the pixel data\n    outs.writeByte(0); // write block terminator\n  }\n\n  // Flush the packet to disk, and reset the this.accumulator\n  flush_char(outs) {\n    if (this.a_count > 0) {\n      outs.writeByte(this.a_count);\n      outs.writeBytes(this.accum, 0, this.a_count);\n      this.a_count = 0;\n    }\n  }\n\n  get_maxcode(n_bits) {\n    return (1 << n_bits) - 1;\n  }\n\n  // Return the next pixel from the image\n  nextPixel() {\n    if (this.remaining === 0) return EOF;\n    --this.remaining;\n    var pix = this.pixels[this.curPixel++];\n    return pix & 0xff;\n  }\n\n  output(code, outs) {\n    this.cur_accum &= masks[this.cur_bits];\n\n    if (this.cur_bits > 0) this.cur_accum |= (code << this.cur_bits);\n    else this.cur_accum = code;\n\n    this.cur_bits += this.n_bits;\n\n    while (this.cur_bits >= 8) {\n      this.char_out((this.cur_accum & 0xff), outs);\n      this.cur_accum >>= 8;\n      this.cur_bits -= 8;\n    }\n\n    // If the next entry is going to be too big for the code size,\n    // then increase it, if possible.\n    if (this.free_ent > this.maxcode || this.clear_flg) {\n      if (this.clear_flg) {\n        this.maxcode = this.get_maxcode(this.n_bits = this.g_init_bits);\n        this.clear_flg = false;\n      } else {\n        ++this.n_bits;\n        if (this.n_bits == BITS) this.maxcode = 1 << BITS;\n        else this.maxcode = this.get_maxcode(this.n_bits);\n      }\n    }\n\n    if (code == this.EOFCode) {\n      // At EOF, write the rest of the buffer.\n      while (this.cur_bits > 0) {\n        this.char_out((this.cur_accum & 0xff), outs);\n        this.cur_accum >>= 8;\n        this.cur_bits -= 8;\n      }\n      this.flush_char(outs);\n    }\n  }\n}\n","import dataStream from \"../utils/dataStream\";\n\nexport default class WavEncoder {\n  constructor(sampleRate, channels=1, bitsPerSample=16) {\n    this.sampleRate = sampleRate;\n    this.channels = channels;\n    this.bitsPerSample = bitsPerSample;\n    // Write WAV file header\n    // Reference: http://www.topherlee.com/software/pcm-tut-wavformat.html\n    let headerBuffer = new ArrayBuffer(44);\n    let header = new dataStream(headerBuffer);\n    // \"RIFF\" indent\n    header.writeUtf8(\"RIFF\");\n    // filesize (set later)\n    header.writeUint32(0);\n    // \"WAVE\" indent\n    header.writeUtf8(\"WAVE\");\n    // \"fmt \" section header\n    header.writeUtf8(\"fmt \");\n    // fmt section length\n    header.writeUint32(16);\n    // specify audio format is pcm (type 1)\n    header.writeUint16(1);\n    // number of audio channels\n    header.writeUint16(this.channels);\n    // audio sample rate\n    header.writeUint32(this.sampleRate);\n    // byterate = (sampleRate * bitsPerSample * channelCount) / 8\n    header.writeUint32((this.sampleRate * this.bitsPerSample * this.channels) / 8);\n    // blockalign = (bitsPerSample * channels) / 8\n    header.writeUint16((this.bitsPerSample * this.channels) / 8);\n    // bits per sample\n    header.writeUint16(this.bitsPerSample);\n    // \"data\" section header\n    header.writeUtf8(\"data\");\n    // data section length (set later)\n    header.writeUint32(0);\n    this.header = header;\n    this.pcmData = null;\n  }\n\n  writeFrames(pcmData) {\n    let header = this.header;\n    // fill in filesize\n    header.seek(4);\n    header.writeUint32(header.byteLength + pcmData.byteLength);\n    // fill in data section length\n    header.seek(40);\n    header.writeUint32(pcmData.byteLength);\n    this.pcmData = pcmData;\n  }\n\n  getBlob() {\n    return new Blob([this.header.buffer, this.pcmData.buffer], {type: \"audio/wav\"});\n  }\n}","import player from \"./player\";\nimport parser from \"./parser\";\nimport ppmParser from \"./parser/ppm\";\nimport kwzParser from \"./parser/kwz\";\nimport bitmapEncoder from \"./encoders/bmp\";\nimport wavEncoder from \"./encoders/wav\";\nimport gifEncoder from \"./encoders/gif\";\nimport dataStream from \"./utils/dataStream\";\n\nexport default {\n  version: VERSION,\n  player,\n  parser,\n  ppmParser,\n  kwzParser,\n  bitmapEncoder,\n  gifEncoder,\n  wavEncoder,\n  dataStream,\n};\n\n","export default {\n\n  matches: function(source) {\n    return (source instanceof ArrayBuffer);\n  },\n\n  load: function(source, resolve, reject) {\n    resolve(source);\n  }\n\n}","export default {\n\n  matches: function(source) {\n    return (source instanceof File);\n  },\n\n  load: function(source, resolve, reject) {\n    var reader = new FileReader();\n    reader.onload = (event) => {\n      resolve(event.target.result)\n    };\n    reader.onerror = (event) => {\n      reject({type: \"fileReadError\"});\n    };\n    reader.readAsArrayBuffer(source);\n  }\n\n}","import urlLoader from \"./urlLoader\";\nimport fileLoader from \"./fileLoader\";\nimport arrayBufferLoader from \"./arrayBufferLoader\";\n\nconst loaders = [\n  urlLoader,\n  fileLoader,\n  arrayBufferLoader\n];\n\nexport default function load(source) {\n  return new Promise(function (resolve, reject) {\n    for (var i = 0; i < loaders.length; i++) {\n      var loader = loaders[i];\n      if (loader.matches(source)) {\n        loader.load(source, resolve, reject);\n        break;\n      }\n    }\n  });\n}","export default {\n\n  matches: function(source) {\n    return typeof source === \"string\";\n  },\n\n  load: function(source, resolve, reject) {\n    var xhr = new XMLHttpRequest();\n    xhr.open(\"GET\", source, true);\n    xhr.responseType = \"arraybuffer\"; \n    xhr.onreadystatechange = function (e) {\n      if (xhr.readyState === 4) {\n        if (xhr.status >= 200 && xhr.status < 300) {\n          resolve(xhr.response);\n        } else {\n          reject({\n            type: \"httpError\",\n            status: xhr.status,\n            statusText: xhr.statusText\n          });\n        }\n      }\n    };\n    xhr.send(null);\n  }\n\n}","import ppmParser from \"./ppm\";\nimport kwzParser from \"./kwz\";\n\nexport default function parser(arrayBuffer) {\n  // check the buffer's magic to identify which format it uses\n  let data = new DataView(arrayBuffer, 0, 4);\n  let magic = data.getUint32(0);\n  // check if magic is PARA (ppm magic)\n  if (magic == 0x50415241) {\n    return new ppmParser(arrayBuffer);\n  } \n  // check if magic is KFH (kwz magic)\n  else if ((magic & 0xFFFFFF00) == 0x4B464800) {\n    return new kwzParser(arrayBuffer);\n  }\n  return null;\n}","import dataStream from \"../utils/dataStream\";\n\nimport {\n  ADPCM_INDEX_TABLE_2,\n  ADPCM_INDEX_TABLE_4,\n  ADPCM_SAMPLE_TABLE_2,\n  ADPCM_SAMPLE_TABLE_4\n} from \"../utils/adpcm\";\n\nconst FRAMERATES = [\n  0.2,\n  0.5,\n  1,\n  2,\n  4, \n  6,\n  8,\n  12, \n  20,\n  24,\n  30\n];\n\nconst PALETTE = {\n  WHITE:  [0xff, 0xff, 0xff],\n  BLACK:  [0x10, 0x10, 0x10],\n  RED:    [0xff, 0x10, 0x10],\n  YELLOW: [0xff, 0xe7, 0x00],\n  GREEN:  [0x00, 0x86, 0x31],\n  BLUE:   [0x00, 0x38, 0xce],\n  NONE:   [0xff, 0xff, 0xff]\n};\n\nconst PALETTE_INDEX_MAP = [\n  'WHITE',\n  'BLACK',\n  'RED',\n  'YELLOW',\n  'GREEN',\n  'BLUE',\n  'NONE'\n];\n\n// table1 - commonly occuring line offsets\nconst TABLE_1 = new Uint16Array([\n  0x0000, 0x0CD0, 0x19A0, 0x02D9, 0x088B, 0x0051, 0x00F3, 0x0009,\n  0x001B, 0x0001, 0x0003, 0x05B2, 0x1116, 0x00A2, 0x01E6, 0x0012,\n  0x0036, 0x0002, 0x0006, 0x0B64, 0x08DC, 0x0144, 0x00FC, 0x0024,\n  0x001C, 0x0004, 0x0334, 0x099C, 0x0668, 0x1338, 0x1004, 0x166C\n]);\n// table2 - commonly occuring line offsets, but the lines are shifted to the left by one pixel\nconst TABLE_2 = new Uint16Array([\n  0x0000, 0x0CD0, 0x19A0, 0x0003, 0x02D9, 0x088B, 0x0051, 0x00F3, \n  0x0009, 0x001B, 0x0001, 0x0006, 0x05B2, 0x1116, 0x00A2, 0x01E6, \n  0x0012, 0x0036, 0x0002, 0x02DC, 0x0B64, 0x08DC, 0x0144, 0x00FC, \n  0x0024, 0x001C, 0x099C, 0x0334, 0x1338, 0x0668, 0x166C, 0x1004\n]);\n// table3 - line offsets, but the lines are shifted to the left by one pixel\nconst TABLE_3 = new Uint16Array(6561);\nvar values = [0, 3, 7, 1, 4, 8, 2, 5, 6];\nlet index = 0;\nfor (let a = 0; a < 9; a++)\n  for (let b = 0; b < 9; b++)\n    for (let c = 0; c < 9; c++)\n      for (let d = 0; d < 9; d++) {\n        TABLE_3[index] = ((values[a] * 9 + values[b]) * 9 + values[c]) * 9 + values[d];\n        index++;\n      }\n\n// linetable - contains every possible sequence of pixels for each tile line\nconst LINE_TABLE = new Uint16Array(6561 * 8);\nvar values = [0x0000, 0xFF00, 0x00FF];\nlet offset = 0;\nfor (let a = 0; a < 3; a++)\n  for (let b = 0; b < 3; b++)\n    for (let c = 0; c < 3; c++)\n      for (let d = 0; d < 3; d++)\n        for (let e = 0; e < 3; e++)\n          for (let f = 0; f < 3; f++)\n            for (let g = 0; g < 3; g++)\n              for (let h = 0; h < 3; h++) {\n                LINE_TABLE.set([\n                  values[b], \n                  values[a], \n                  values[d], \n                  values[c], \n                  values[f], \n                  values[e], \n                  values[h], \n                  values[g]\n                ], offset);\n                offset += 8;\n              }\n\nexport default class kwzParser extends dataStream {\n\n  constructor(arrayBuffer) {\n    super(arrayBuffer);\n    this.type = \"KWZ\";\n    this._layers = [\n      new Uint16Array(320 * 240),\n      new Uint16Array(320 * 240),\n      new Uint16Array(320 * 240),\n    ];\n    this._bitIndex = 0;\n    this._bitValue = 0;\n    this.load();\n  }\n\n  load() {\n    this.seek(0);\n    this.sections = {};\n    let size = this.byteLength - 256;\n    let offset = 0;\n    let sectionCount = 0;\n    // counting sections should mitigate against one of mrnbayoh's notehax exploits\n    while ((offset < size) && (sectionCount < 6)) {\n      this.seek(offset);\n      let sectionMagic = this.readUtf8(4).substring(0, 3);\n      let sectionLength = this.readUint32();\n      this.sections[sectionMagic] = {\n        offset: offset,\n        length: sectionLength\n      };\n      offset += sectionLength + 8;\n      sectionCount += 1;\n    }\n\n    this._decodeMeta();\n    this._decodeFrameMeta();\n    this._decodeSoundHeader();\n    this.sampleRate = 16364;\n    this.palette = PALETTE;\n    this._prevDecodedFrame = null;\n  }\n\n  readBits(num) {\n    if (this._bitIndex + num > 16) {\n      let nextBits = this.readUint16();\n      this._bitValue |= nextBits << (16 - this._bitIndex);\n      this._bitIndex -= 16;\n    }\n    let mask = (1 << num) - 1;\n    let result = this._bitValue & mask;\n    this._bitValue >>= num;\n    this._bitIndex += num;\n    return result;\n  }\n\n  _decodeMeta() {\n    this.seek(this.sections[\"KFH\"].offset + 12);\n    let creationTimestamp = new Date((this.readUint32() + 946684800) * 1000),\n        modifiedTimestamp = new Date((this.readUint32() + 946684800) * 1000),\n        appVersion = this.readUint32(),\n        rootAuthorId = this.readHex(10),\n        parentAuthorId = this.readHex(10),\n        currentAuthorId = this.readHex(10),\n        rootAuthorName = this.readUtf16(11),\n        parentAuthorName = this.readUtf16(11),\n        currentAuthorName = this.readUtf16(11),\n        rootFilename = this.readUtf8(28),\n        parentFilename = this.readUtf8(28),\n        currentFilename = this.readUtf8(28),\n        frameCount = this.readUint16(),\n        thumbIndex = this.readUint16(),\n        flags = this.readUint16(),\n        frameSpeed = this.readUint8(),\n        layerFlags = this.readUint8();\n    this.frameCount = frameCount;\n    this.thumbFrameIndex = thumbIndex;\n    this.frameSpeed = frameSpeed;\n    this.framerate = FRAMERATES[frameSpeed];\n    this.meta = {\n      lock: flags & 0x1,\n      loop: (flags >> 1) & 0x01,\n      frame_count: frameCount,\n      frame_speed: frameSpeed,\n      thumb_index: thumbIndex,\n      timestamp: modifiedTimestamp,\n      creation_timestamp: creationTimestamp,\n      root: {\n        username: rootAuthorName,\n        fsid: rootAuthorId,\n        filename: rootFilename,\n      },\n      parent: {\n        username: parentAuthorName,\n        fsid: parentAuthorId,\n        filename: parentFilename,\n      },\n      current: {\n        username: currentAuthorName,\n        fsid: currentAuthorId,\n        filename: currentFilename,\n      },\n    };\n  }\n\n  _decodeFrameMeta() {\n    this.frameMeta = [];\n    this.frameOffsets = [];\n    this.seek(this.sections[\"KMI\"].offset + 8);\n    offset = this.sections[\"KMC\"].offset + 12;\n    for (let i = 0; i < this.frameCount; i++) {\n      let frame = {\n        flags: this.readUint32(),\n        layerSize: [\n          this.readUint16(),\n          this.readUint16(),\n          this.readUint16()\n        ],\n        frameAuthor: this.readHex(10),\n        layerDepth: [\n          this.readUint8(),\n          this.readUint8(),\n          this.readUint8(),\n        ],\n        soundFlags: this.readUint8(),\n        cameraFlag: this.readUint32(),\n      };\n      this.frameMeta.push(frame);\n      this.frameOffsets.push(offset);\n      offset += frame.layerSize[0] + frame.layerSize[1] + frame.layerSize[2];\n    }\n  }\n\n  _decodeSoundHeader() {\n    let offset = this.sections[\"KSN\"].offset + 8;\n    this.seek(offset);\n    let bgmSpeed = this.readUint32();\n    this.bgmSpeed = bgmSpeed;\n    this.bgmrate = FRAMERATES[bgmSpeed];\n    let trackSizes = new Uint32Array(this.buffer, offset + 4, 20);\n    this.soundMeta = {\n      \"bgm\": {offset: offset += 28,            length: trackSizes[0]},\n      \"se1\": {offset: offset += trackSizes[0], length: trackSizes[1]},\n      \"se2\": {offset: offset += trackSizes[1], length: trackSizes[2]},\n      \"se3\": {offset: offset += trackSizes[2], length: trackSizes[3]},\n      \"se4\": {offset: offset += trackSizes[3], length: trackSizes[4]},\n    };\n  }\n\n  getDiffingFlag(frameIndex) {\n    return ~(this.frameMeta[frameIndex].flags >> 4) & 0x07;\n  }\n\n  getLayerDepths(frameIndex) {\n    return this.frameMeta[frameIndex].layerDepth;\n  }\n\n  // sort layer indices sorted by depth, drom bottom to top\n  getLayerOrder(frameIndex) {\n    const depths = this.getLayerDepths(frameIndex);\n    return [2, 1, 0].sort((a, b) => depths[b] - depths[a]);\n  }\n\n  decodeFrame(frameIndex, diffingFlag=0x7, isPrevFrame=false) {\n    // if this frame is being decoded as a prev frame, then we only want to decode the layers necessary\n    if (isPrevFrame)\n      diffingFlag &= this.getDiffingFlag(frameIndex + 1);\n    // the prevDecodedFrame check is an optimisation for decoding frames in full sequence\n    if ((frameIndex !== 0) && (this._prevDecodedFrame !== frameIndex - 1) && (diffingFlag))\n      this.decodeFrame(frameIndex - 1, diffingFlag=diffingFlag, isPrevFrame=true);\n\n    let meta = this.frameMeta[frameIndex];\n    let offset = this.frameOffsets[frameIndex];\n\n    for (let layerIndex = 0; layerIndex < 3; layerIndex++) {\n      this.seek(offset);\n      let layerSize = meta.layerSize[layerIndex];\n      offset += layerSize;\n\n      // if the layer is 38 bytes then it hasn't changed at all since the previous frame, so we can skip it\n      if (layerSize === 38) continue;\n\n      if ((diffingFlag >> layerIndex) & 0x1 === 0) continue;\n\n      this._bitIndex = 16;\n      this._bitValue = 0;\n      let skip = 0;\n\n      for (let tileOffsetY = 0; tileOffsetY < 240; tileOffsetY += 128) {\n        for (let tileOffsetX = 0; tileOffsetX < 320; tileOffsetX += 128) {\n          for (let subTileOffsetY = 0; subTileOffsetY < 128; subTileOffsetY += 8) {\n            let y = tileOffsetY + subTileOffsetY;\n            if (y >= 240) break;\n\n            for (let subTileOffsetX = 0; subTileOffsetX < 128; subTileOffsetX += 8) {\n              let x = tileOffsetX + subTileOffsetX;\n              if (x >= 320) break;\n\n              if (skip) {\n                skip -= 1;\n                continue;\n              }\n\n              let pixelOffset = y * 320 + x;\n              let pixelBuffer = this._layers[layerIndex];\n\n              let type = this.readBits(3);\n\n              if (type == 0) {\n                let lineIndex = TABLE_1[this.readBits(5)];\n                let pixels = LINE_TABLE.subarray(lineIndex * 8, lineIndex * 8 + 8);\n                pixelBuffer.set(pixels, pixelOffset);\n                pixelBuffer.set(pixels, pixelOffset + 320);\n                pixelBuffer.set(pixels, pixelOffset + 640);\n                pixelBuffer.set(pixels, pixelOffset + 960);\n                pixelBuffer.set(pixels, pixelOffset + 1280);\n                pixelBuffer.set(pixels, pixelOffset + 1600);\n                pixelBuffer.set(pixels, pixelOffset + 1920);\n                pixelBuffer.set(pixels, pixelOffset + 2240);\n              } \n\n              else if (type == 1) {\n                let lineIndex = this.readBits(13);\n                let pixels = LINE_TABLE.subarray(lineIndex * 8, lineIndex * 8 + 8);\n                pixelBuffer.set(pixels, pixelOffset);\n                pixelBuffer.set(pixels, pixelOffset + 320);\n                pixelBuffer.set(pixels, pixelOffset + 640);\n                pixelBuffer.set(pixels, pixelOffset + 960);\n                pixelBuffer.set(pixels, pixelOffset + 1280);\n                pixelBuffer.set(pixels, pixelOffset + 1600);\n                pixelBuffer.set(pixels, pixelOffset + 1920);\n                pixelBuffer.set(pixels, pixelOffset + 2240);\n              } \n              \n              else if (type == 2) {\n                let lineValue = this.readBits(5);\n                let lineIndexA = TABLE_1[lineValue];\n                let lineIndexB = TABLE_2[lineValue];\n                let a = LINE_TABLE.subarray(lineIndexA * 8, lineIndexA * 8 + 8);\n                let b = LINE_TABLE.subarray(lineIndexB * 8, lineIndexB * 8 + 8);\n                pixelBuffer.set(a, pixelOffset);\n                pixelBuffer.set(b, pixelOffset + 320);\n                pixelBuffer.set(a, pixelOffset + 640);\n                pixelBuffer.set(b, pixelOffset + 960);\n                pixelBuffer.set(a, pixelOffset + 1280);\n                pixelBuffer.set(b, pixelOffset + 1600);\n                pixelBuffer.set(a, pixelOffset + 1920);\n                pixelBuffer.set(b, pixelOffset + 2240);\n              } \n              \n              else if (type == 3) {\n                let lineIndexA = this.readBits(13);\n                let lineIndexB = TABLE_3[lineIndexA];\n                let a = LINE_TABLE.subarray(lineIndexA * 8, lineIndexA * 8 + 8);\n                let b = LINE_TABLE.subarray(lineIndexB * 8, lineIndexB * 8 + 8);\n                pixelBuffer.set(a, pixelOffset);\n                pixelBuffer.set(b, pixelOffset + 320);\n                pixelBuffer.set(a, pixelOffset + 640);\n                pixelBuffer.set(b, pixelOffset + 960);\n                pixelBuffer.set(a, pixelOffset + 1280);\n                pixelBuffer.set(b, pixelOffset + 1600);\n                pixelBuffer.set(a, pixelOffset + 1920);\n                pixelBuffer.set(b, pixelOffset + 2240);\n              }\n\n              else if (type == 4) {\n                let mask = this.readBits(8);\n                for (let line = 0; line < 8; line++) {\n                  let lineIndex = 0;\n                  if (mask & (1 << line)) {\n                    lineIndex = TABLE_1[this.readBits(5)];\n                  } else {\n                    lineIndex = this.readBits(13);\n                  }\n                  let pixels = LINE_TABLE.subarray(lineIndex * 8, lineIndex * 8 + 8);\n                  pixelBuffer.set(pixels, pixelOffset + line * 320);\n                }\n              }\n\n              else if (type == 5) {\n                skip = this.readBits(5);\n                continue;\n              }\n\n              // type 6 doesnt exist\n\n              else if (type == 7) {\n                let pattern = this.readBits(2);\n                let useTable = this.readBits(1);\n                let lineIndexA = 0;\n                let lineIndexB = 0;\n\n                if (useTable) {\n                  lineIndexA = TABLE_1[this.readBits(5)];\n                  lineIndexB = TABLE_1[this.readBits(5)];\n                  pattern = (pattern + 1) % 4;\n                } else {\n                  lineIndexA = this.readBits(13);\n                  lineIndexB = this.readBits(13);\n                }\n\n                let a = LINE_TABLE.subarray(lineIndexA * 8, lineIndexA * 8 + 8);\n                let b = LINE_TABLE.subarray(lineIndexB * 8, lineIndexB * 8 + 8);\n\n                if (pattern == 0) {\n                  pixelBuffer.set(a, pixelOffset);\n                  pixelBuffer.set(b, pixelOffset + 320);\n                  pixelBuffer.set(a, pixelOffset + 640);\n                  pixelBuffer.set(b, pixelOffset + 960);\n                  pixelBuffer.set(a, pixelOffset + 1280);\n                  pixelBuffer.set(b, pixelOffset + 1600);\n                  pixelBuffer.set(a, pixelOffset + 1920);\n                  pixelBuffer.set(b, pixelOffset + 2240);\n                } else if (pattern == 1) {\n                  pixelBuffer.set(a, pixelOffset);\n                  pixelBuffer.set(a, pixelOffset + 320);\n                  pixelBuffer.set(b, pixelOffset + 640);\n                  pixelBuffer.set(a, pixelOffset + 960);\n                  pixelBuffer.set(a, pixelOffset + 1280);\n                  pixelBuffer.set(b, pixelOffset + 1600);\n                  pixelBuffer.set(a, pixelOffset + 1920);\n                  pixelBuffer.set(a, pixelOffset + 2240);\n                } else if (pattern == 2) {\n                  pixelBuffer.set(a, pixelOffset);\n                  pixelBuffer.set(b, pixelOffset + 320);\n                  pixelBuffer.set(a, pixelOffset + 640);\n                  pixelBuffer.set(a, pixelOffset + 960);\n                  pixelBuffer.set(b, pixelOffset + 1280);\n                  pixelBuffer.set(a, pixelOffset + 1600);\n                  pixelBuffer.set(a, pixelOffset + 1920);\n                  pixelBuffer.set(b, pixelOffset + 2240);\n                } else if (pattern == 3) {\n                  pixelBuffer.set(a, pixelOffset);\n                  pixelBuffer.set(b, pixelOffset + 320);\n                  pixelBuffer.set(b, pixelOffset + 640);\n                  pixelBuffer.set(a, pixelOffset + 960);\n                  pixelBuffer.set(b, pixelOffset + 1280);\n                  pixelBuffer.set(b, pixelOffset + 1600);\n                  pixelBuffer.set(a, pixelOffset + 1920);\n                  pixelBuffer.set(b, pixelOffset + 2240);\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n\n    this._prevDecodedFrame = frameIndex;\n    // return this._layers;\n    return [\n      new Uint8Array(this._layers[0].buffer),\n      new Uint8Array(this._layers[1].buffer),\n      new Uint8Array(this._layers[2].buffer),\n    ];\n  }\n\n  getFramePalette(frameIndex) {\n    let flags = this.frameMeta[frameIndex].flags;\n    return [\n      this.palette[PALETTE_INDEX_MAP[flags & 0xF]], // paper color\n      this.palette[PALETTE_INDEX_MAP[(flags >> 8) & 0xF]], // layer A color 1\n      this.palette[PALETTE_INDEX_MAP[(flags >> 12) & 0xF]], // layer A color 2\n      this.palette[PALETTE_INDEX_MAP[(flags >> 16) & 0xF]], // layer B color 1\n      this.palette[PALETTE_INDEX_MAP[(flags >> 20) & 0xF]], // layer B color 2\n      this.palette[PALETTE_INDEX_MAP[(flags >> 24) & 0xF]], // layer C color 1\n      this.palette[PALETTE_INDEX_MAP[(flags >> 28) & 0xF]], // layer C color 2\n    ];\n  }\n\n  // retuns an uint8 array where each item is a pixel's palette index\n  getLayerPixels(frameIndex, layerIndex) {\n    if (this._prevDecodedFrame !== frameIndex) {\n      this.decodeFrame(frameIndex);\n    }\n    const layer = this._layers[layerIndex];\n    const image = new Uint8Array((320 * 240));\n    const paletteOffset = layerIndex * 2 + 1;\n    for (let index = 0; index < layer.length; index++) {\n      let pixel = layer[index];\n      if (pixel & 0xff00) {\n        image[index] = paletteOffset;\n      } else if (pixel & 0x00ff) {\n        image[index] = paletteOffset + 1;\n      }\n    }\n    return image;\n  }\n\n  // retuns an uint8 array where each item is a pixel's palette index\n  getFramePixels(frameIndex, useGlobalPalette = false) {\n    let paletteMap;\n    if (useGlobalPalette) {\n      const framePalette = this.getFramePalette(frameIndex);\n      paletteMap = framePalette.map(color => kwzParser.globalPalette.indexOf(color));\n    } else {\n      paletteMap = [0, 1, 2, 3, 4, 5, 6];\n    }\n    const image = new Uint8Array((320 * 240));\n    image.fill(paletteMap[0]);\n    const layerOrder = this.getLayerOrder(frameIndex);\n    layerOrder.forEach(layerIndex => {\n      const layer = this.getLayerPixels(frameIndex, layerIndex);\n      // merge layer into image result\n      for (let index = 0; index < layer.length; index++) {\n        let pixel = layer[index];\n        if (pixel !== 0) {\n          image[index] = paletteMap[pixel];\n        }\n      }\n    });\n    return image;\n  }\n  \n  decodeSoundFlags() {\n    return this.frameMeta.map(frame => {\n      let soundFlags = frame.soundFlags;\n      return [\n        soundFlags & 0x1,\n        (soundFlags >> 1) & 0x1,\n        (soundFlags >> 2) & 0x1,\n        (soundFlags >> 3) & 0x1,\n      ];\n    });\n  }\n\n  hasAudioTrack(trackIndex) {\n    let id = [\"bgm\", \"se1\", \"se2\", \"se3\", \"se4\"][trackIndex];\n    return this.soundMeta[id].length > 0\n  }\n\n  decodeAudio(track) {\n    let meta = this.soundMeta[track];\n    let output = new Int16Array(16364 * 60);\n    let outputOffset = 0;\n    let adpcm = new Uint8Array(this.buffer, meta.offset, meta.length);\n    // initial decoder state\n    var prevDiff = 0;\n    var prevStepIndex = 40;\n    var sample, diff, stepIndex;\n    // loop through each byte in the raw adpcm data\n    for (let index = 0; index < adpcm.length; index++) {\n      var byte = adpcm[index];\n      var bitPos = 0;\n      while (bitPos < 8) {\n        if (prevStepIndex < 18 || bitPos == 6) {\n          // isolate 2-bit sample\n          sample = (byte >> bitPos) & 0x3;\n          // get diff\n          diff = prevDiff + ADPCM_SAMPLE_TABLE_2[sample + 4 * prevStepIndex];\n          // get step index\n          stepIndex = prevStepIndex + ADPCM_INDEX_TABLE_2[sample];\n          bitPos += 2;\n        }\n        else {\n          // isolate 4-bit sample\n          sample = (byte >> bitPos) & 0xF;\n          // get diff\n          diff = prevDiff + ADPCM_SAMPLE_TABLE_4[sample + 16 * prevStepIndex];\n          // get step index\n          stepIndex = prevStepIndex + ADPCM_INDEX_TABLE_4[sample];\n          bitPos += 4;\n        }\n        // clamp step index and diff\n        stepIndex = Math.max(0, Math.min(stepIndex, 79));\n        diff = Math.max(-2048, Math.min(diff, 2048));\n        // add result to output buffer\n        output[outputOffset] = (diff * 16);\n        outputOffset += 1;\n        // set prev decoder state\n        prevStepIndex = stepIndex;\n        prevDiff = diff;\n      }\n\n    }\n    return output.slice(0, outputOffset);\n  }\n}\n\nkwzParser.width = 320;\nkwzParser.height = 240;\nkwzParser.globalPalette = [\n  PALETTE.BLACK,\n  PALETTE.WHITE,\n  PALETTE.RED,\n  PALETTE.YELLOW,\n  PALETTE.GREEN,\n  PALETTE.BLUE,\n  PALETTE.NONE,\n];","/**\n * PPM decoder\n * Reads frames, audio, and metadata from Flipnote Studio PPM files \n * Based on my Python PPM decoder implementation (https://github.com/jaames/flipnote-tools)\n *  \n * Credits:\n *  PPM format reverse-engineering and documentation:\n *   - bricklife (http://ugomemo.g.hatena.ne.jp/bricklife/20090307/1236391313)\n *   - mirai-iro (http://mirai-iro.hatenablog.jp/entry/20090116/ugomemo_ppm)\n *   - harimau_tigris (http://ugomemo.g.hatena.ne.jp/harimau_tigris)\n *   - steven (http://www.dsibrew.org/wiki/User:Steven)\n *   - yellows8 (http://www.dsibrew.org/wiki/User:Yellows8)\n *   - PBSDS (https://github.com/pbsds)\n *   - jaames (https://github.com/jaames)\n *  Identifying the PPM sound codec:\n *   - Midmad from Hatena Haiku\n *   - WDLMaster from hcs64.com\n *  Helping me to identify issues with the Python decoder that this is based on:\n *   - Austin Burk (https://sudomemo.net)\n * \n *  Lastly, a huge thanks goes to Nintendo for creating Flipnote Studio, \n *  and to Hatena for providing the Flipnote Hatena online service, both of which inspired so many c:\n*/\n\nimport dataStream from \"../utils/dataStream\";\n\nimport {\n  ADPCM_INDEX_TABLE_4,\n  ADPCM_SAMPLE_TABLE_4\n} from \"../utils/adpcm\";\n\n// internal framerate value -> FPS table\nconst FRAMERATES = {\n  1: 0.5,\n  2: 1,\n  3: 2,\n  4: 4,\n  5: 6,\n  6: 12,\n  7: 20,\n  8: 30,\n};\n\nconst WIDTH = 256;\nconst HEIGHT = 192;\n\nconst PALETTE = {\n  WHITE: [0xff, 0xff, 0xff],\n  BLACK: [0x0e, 0x0e, 0x0e],\n  RED:   [0xff, 0x2a, 0x2a],\n  BLUE:  [0x0a, 0x39, 0xff],\n};\n\nexport default class ppmParser extends dataStream {\n  /**\n  * Create a ppmDecoder instance\n  * @param {ArrayBuffer} arrayBuffer - data to read from\n  */\n  constructor(arrayBuffer) {\n    super(arrayBuffer);\n    this.type = \"PPM\";\n    this._decodeHeader();\n    this._decodeAnimationHeader();\n    this._decodeSoundHeader();\n    this._decodeMeta();\n    this.sampleRate = 8192;\n    this.palette = PALETTE;\n    // create image buffers\n     this._layers = [\n      new Uint8Array(WIDTH * HEIGHT),\n      new Uint8Array(WIDTH * HEIGHT)\n    ];\n    this._prevLayers = [\n      new Uint8Array(WIDTH * HEIGHT),\n      new Uint8Array(WIDTH * HEIGHT)\n    ];\n    this._prevDecodedFrame = null;\n  }\n\n  static validateFSID(fsid) {\n    return /[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(fsid);\n  }\n\n  static validateFilename(filename) {\n    return /[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(filename);\n  }\n\n  /**\n  * Read a packed filename\n  * @returns {string}\n  * @access protected\n  */\n  readFilename() {\n    return [\n      this.readHex(3),\n      this.readUtf8(13),\n      this.readUint16().toString().padStart(3, \"0\")\n    ].join(\"_\");\n  }\n\n  /**\n  * Unpack the line encoding flags for all 192 lines in a layer\n  * @returns {array}\n  * @access protected\n  */\n  readLineEncoding() {\n    var unpacked = new Uint8Array(HEIGHT);\n    for (var byteOffset = 0; byteOffset < 48; byteOffset ++) {\n      var byte = this.readUint8();\n      // each line's encoding type is stored as a 2-bit value\n      for (var bitOffset = 0; bitOffset < 8; bitOffset += 2) {\n        unpacked[byteOffset * 4 + bitOffset / 2] = (byte >> bitOffset) & 0x03;\n      }\n    }\n    return unpacked;\n  }\n\n  _decodeHeader() {\n    this.seek(0);\n    // decode header\n    // https://github.com/pbsds/hatena-server/wiki/PPM-format#file-header\n    let magic = this.readUint32();\n    this._frameDataLength = this.readUint32();\n    this._soundDataLength = this.readUint32();\n    this.frameCount = this.readUint16() + 1;\n    this.version = this.readUint16();\n  }\n\n  _decodeMeta() {\n    // https://github.com/pbsds/hatena-server/wiki/PPM-format#file-header\n    this.seek(0x10);\n    var lock = this.readUint16(),\n        thumbIndex = this.readInt16(),\n        rootAuthorName = this.readUtf16(11),\n        parentAuthorName = this.readUtf16(11),\n        currentAuthorName = this.readUtf16(11),\n        parentAuthorId = this.readHex(8, true),\n        currentAuthorId = this.readHex(8, true),\n        parentFilename = this.readFilename(),\n        currentFilename = this.readFilename(),\n        rootAuthorId = this.readHex(8, true);\n    this.seek(0x9A);\n    var timestamp = new Date((this.readUint32() + 946684800) * 1000);\n    this.seek(0x06A6);\n    var flags = this.readUint16();\n    this.thumbFrameIndex = thumbIndex;\n    this.meta = {\n      lock: lock,\n      loop: flags >> 1 & 0x01,\n      frame_count: this.frameCount,\n      frame_speed: this.frameSpeed,\n      bgm_speed: this.bgmSpeed,\n      thumb_index: thumbIndex,\n      timestamp: timestamp,\n      spinoff: (currentAuthorId !== parentAuthorId) || (currentAuthorId !== rootAuthorId),\n      root: {\n        filename: null,\n        username: rootAuthorName,\n        fsid: rootAuthorId,\n      },\n      parent: {\n        username: parentAuthorName,\n        fsid: parentAuthorId,\n        filename: parentFilename\n      },\n      current: {\n        username: currentAuthorName,\n        fsid: currentAuthorId,\n        filename: currentFilename\n      },\n    };\n  }\n\n  _decodeAnimationHeader() {\n    // jump to the start of the animation data section\n    // https://github.com/pbsds/hatena-server/wiki/PPM-format#animation-data-section\n    this.seek(0x06A0);\n    var offsetTableLength = this.readUint16();\n    // skip padding + flags\n    this.seek(0x06A8);\n    // read frame offsets and build them into a table\n    this._frameOffsets = new Uint32Array(offsetTableLength / 4).map(value => {\n      return 0x06A8 + offsetTableLength + this.readUint32();\n    });\n  }\n\n  _decodeSoundHeader() {\n    // https://github.com/pbsds/hatena-server/wiki/PPM-format#sound-data-section\n    // offset = frame data offset + frame data length + sound effect flags\n    var offset = 0x06A0 + this._frameDataLength + this.frameCount;\n    // account for multiple-of-4 padding\n    if (offset % 2 != 0) offset += 4 - (offset % 4);\n    this.seek(offset);\n    var bgmLen = this.readUint32();\n    var se1Len = this.readUint32();\n    var se2Len = this.readUint32();\n    var se3Len = this.readUint32();\n    this.frameSpeed = 8 - this.readUint8();\n    this.bgmSpeed = 8 - this.readUint8();\n    offset += 32;\n    this.framerate = FRAMERATES[this.frameSpeed];\n    this.bgmrate = FRAMERATES[this.bgmSpeed];\n    this.soundMeta = {\n      \"bgm\": {offset: offset,           length: bgmLen},\n      \"se1\": {offset: offset += bgmLen, length: se1Len},\n      \"se2\": {offset: offset += se1Len, length: se2Len},\n      \"se3\": {offset: offset += se2Len, length: se3Len},\n    };\n  }\n\n  /**\n  * Check whether or not a given frame is based on the previous one\n  * @param {number} index - zero-based frame index \n  * @returns {boolean}\n  */\n  isNewFrame(index) {\n    this.seek(this._frameOffsets[index]);\n    var header = this.readUint8();\n    return (header >> 7) & 0x1;\n  }\n\n  /**\n  * Get the color palette for a given frame\n  * @param {number} index - zero-based frame index \n  * @returns {array} rgba palette in order of paper, layer1, layer2\n  */\n  getFramePalette(index) {\n    this.seek(this._frameOffsets[index]);\n    const palette = this.palette;\n    var header = this.readUint8();\n    var paperColor = header & 0x1;\n    var pen = [\n      palette.BLACK,\n      paperColor == 1 ? palette.BLACK : palette.WHITE,\n      palette.RED,\n      palette.BLUE,\n    ];\n    return [\n      paperColor == 1 ? palette.WHITE : palette.BLACK,\n      pen[(header >> 1) & 0x3], // layer 1 color\n      pen[(header >> 3) & 0x3], // layer 2 color\n    ];\n  }\n\n  /**\n  * Decode a frame\n  * @param {number} index - zero-based frame index \n  * @returns {array} - 2 uint8 arrays representing each layer\n  * */\n  decodeFrame(index) {\n    if ((index !== 0) && (this._prevDecodedFrame !== index - 1) && (!this.isNewFrame(index)))\n      this.decodeFrame(index - 1);\n    // https://github.com/pbsds/hatena-server/wiki/PPM-format#animation-frame\n    this.seek(this._frameOffsets[index]);\n    var header = this.readUint8();\n    var isNewFrame = (header >> 7) & 0x1;\n    var isTranslated = (header >> 5) & 0x3;\n    var translateX = 0;\n    var translateY = 0;\n    // copy the current layer buffers to the previous ones\n    this._prevLayers[0].set(this._layers[0]);\n    this._prevLayers[1].set(this._layers[1]);\n    this._prevDecodedFrame = index;\n    // reset current layer buffers\n    this._layers[0].fill(0);\n    this._layers[1].fill(0);\n\n    if (isTranslated) {\n      translateX = this.readInt8();\n      translateY = this.readInt8();\n    }\n\n    var layerEncoding = [\n      this.readLineEncoding(),\n      this.readLineEncoding(),\n    ];\n     // start decoding layer bitmaps\n    for (var layer = 0; layer < 2; layer++) {\n      var layerBitmap = this._layers[layer];\n      for (var line = 0; line < HEIGHT; line++) {\n        var chunkOffset = line * WIDTH;\n        var lineType = layerEncoding[layer][line];\n        switch(lineType) {\n          // line type 0 = blank line, decode nothing\n          case 0:\n            break;\n          // line types 1 + 2 = compressed bitmap line\n          case 1:\n          case 2:\n            var lineHeader = this.readUint32(false);\n            // line type 2 starts as an inverted line\n            if (lineType == 2) layerBitmap.fill(0xFF, chunkOffset, chunkOffset + WIDTH);\n            // loop through each bit in the line header\n            while (lineHeader & 0xFFFFFFFF) {\n              // if the bit is set, this 8-pix wide chunk is stored\n              // else we can just leave it blank and move on to the next chunk\n              if (lineHeader & 0x80000000) {\n                var chunk = this.readUint8();\n                // unpack chunk bits\n                for (var pixel = 0; pixel < 8; pixel++) {\n                  layerBitmap[chunkOffset + pixel] = (chunk >> pixel & 0x1) ? 0xFF : 0x00;\n                }\n              }\n              chunkOffset += 8;\n              // shift lineheader to the left by 1 bit, now on the next loop cycle the next bit will be checked\n              lineHeader <<= 1;\n            }\n            break;\n          // line type 3 = raw bitmap line\n          case 3:\n            while(chunkOffset < (line + 1) * WIDTH) {\n              var chunk = this.readUint8();\n              for (var pixel = 0; pixel < 8; pixel++) {\n                layerBitmap[chunkOffset + pixel] = (chunk >> pixel & 0x1) ? 0xFF : 0x00;\n              }\n              chunkOffset += 8;\n            }\n            break;\n        }\n      }\n    }\n    // if the current frame is based on changes from the preivous one, merge them by XORing their values\n    if (!isNewFrame) {\n      var dest, src;\n      // loop through each line\n      for (var y = 0; y < HEIGHT; y++) {\n        // skip to next line if this one falls off the top edge of the screen\n        if (y - translateY < 0) continue;\n        // stop once the bottom screen edge has been reached\n        if (y - translateY >= HEIGHT) break;\n        // loop through each pixel in the line\n        for (var x = 0; x < WIDTH; x++) {\n          // skip to the next pixel if this one falls off the left edge of the screen\n          if (x - translateX < 0) continue;\n          // stop diffing this line once the right screen edge has been reached\n          if (x - translateX >= WIDTH) break;\n          dest = x + y * WIDTH;\n          src = dest - (translateX + translateY * WIDTH);\n          // diff pixels with a binary XOR\n          this._layers[0][dest] ^= this._prevLayers[0][src];\n          this._layers[1][dest] ^= this._prevLayers[1][src];\n        }\n      }\n    }\n    return this._layers;\n  }\n\n  // retuns an uint8 array where each item is a pixel's palette index\n  getLayerPixels(frameIndex, layerIndex) {\n    if (this._prevDecodedFrame !== frameIndex) {\n      this.decodeFrame(frameIndex);\n    }\n    const layer = this._layers[layerIndex];\n    const image = new Uint8Array((256 * 192));\n    const layerColor = layerIndex + 1\n    for (let pixel = 0; pixel < image.length; pixel++) {\n      if (layer[pixel] !== 0) {\n        image[pixel] = layerColor;\n      }\n    }\n    return image;\n  }\n\n  // retuns an uint8 array where each item is a pixel's palette index\n  getFramePixels(frameIndex, useGlobalPalette = false) {\n    let paletteMap;\n    if (useGlobalPalette) {\n      const framePalette = this.getFramePalette(frameIndex);\n      paletteMap = framePalette.map(color => ppmParser.globalPalette.indexOf(color));\n    } else {\n      paletteMap = [0, 1, 2];\n    }\n    const layers = this.decodeFrame(frameIndex);\n    const image = new Uint8Array((256 * 192));\n    image.fill(paletteMap[0]);\n    for (let pixel = 0; pixel < image.length; pixel++) {\n      let a = layers[0][pixel];\n      let b = layers[1][pixel];\n      if (b) image[pixel] = paletteMap[2];\n      if (a) image[pixel] = paletteMap[1];\n    }\n    return image;\n  }\n\n  hasAudioTrack(trackIndex) {\n    let id = [\"bgm\", \"se1\", \"se2\", \"se3\"][trackIndex];\n    return this.soundMeta[id].length > 0;\n  }\n\n  /**\n  * Decode an audio track to 32-bit adpcm\n  * @param {string} track - track name, \"bgm\" | \"se1\" | \"se2\" | \"se3\"\n  * @returns {Int16Array}\n  */\n  decodeAudio(track) {\n    let meta = this.soundMeta[track];\n    let adpcm = new Uint8Array(this.buffer, meta.offset, meta.length);\n    let output = new Int16Array(adpcm.length * 2);\n    let outputOffset = 0;\n    // initial decoder state\n    var prevDiff = 0;\n    var prevStepIndex = 0;\n    var sample, diff, stepIndex;\n    // loop through each byte in the raw adpcm data\n    for (let index = 0; index < adpcm.length; index++) {\n      let byte = adpcm[index];\n      var bitPos = 0;\n      while (bitPos < 8) {\n        // isolate 4-bit sample\n        sample = (byte >> bitPos) & 0xF;\n        // get diff\n        diff = prevDiff + ADPCM_SAMPLE_TABLE_4[sample + 16 * prevStepIndex];\n        // get step index\n        stepIndex = prevStepIndex + ADPCM_INDEX_TABLE_4[sample];\n        // clamp step index and diff\n        stepIndex = Math.max(0, Math.min(stepIndex, 79));\n        diff = Math.max(-32767, Math.min(diff, 32767));\n        // add result to output buffer\n        output[outputOffset] = (diff);\n        outputOffset += 1;\n        // set prev decoder state\n        prevStepIndex = stepIndex;\n        prevDiff = diff;\n        // move to next sample\n        bitPos += 4;\n      }\n    }\n    return output;\n  }\n\n  /**\n  * Decode the sound effect usage for each frame\n  * @returns {array}\n  */\n  decodeSoundFlags() {\n    this.seek(0x06A0 + this._frameDataLength);\n    // per msdn docs - the array map callback is only invoked for array indicies that have assigned values\n    // so when we create an array, we need to fill it with something before we can map over it\n    var arr = new Array(this.frameCount).fill([]);\n    return arr.map(value => {\n      var byte = this.readUint8();\n      return [byte & 0x1, (byte >> 1) & 0x1, (byte >> 2) & 0x1];\n    });\n  }\n}\n\nppmParser.width = WIDTH;\nppmParser.height = HEIGHT;\nppmParser.globalPalette = [\n  PALETTE.BLACK,\n  PALETTE.WHITE,\n  PALETTE.RED,\n  PALETTE.BLUE\n];","import wavEncoder from \"../encoders/wav\";\n\nexport default class audioTrack {\n  /**\n  * Create a new audio player\n  */\n  constructor (id, type) {\n    this.id = id;\n    this.channelCount = 1;\n    this.bitsPerSample = 16;\n    this.sampleRate = 0;\n    this.playbackRate = 1;\n    this.audio = document.createElement(\"audio\");\n    this.audio.preload = true;\n    this.active = false;\n  }\n  \n  /**\n  * Set the audio track\n  * @param {Int16Array} pcmData - mono-channel 16-bit PCM audio\n  * @param {number} playbackRate - audio playback rate (1 = default)\n  */\n  set(pcmData, playbackRate) {\n    // the HTML5 audio element supports PCM audio if it's in a WAV wrapper\n    let wav = new wavEncoder(this.sampleRate * playbackRate, this.channelCount, this.bitsPerSample);\n    wav.writeFrames(pcmData);\n    this.url = window.URL.createObjectURL(wav.getBlob());\n    // use the blob url for the audio element\n    this.audio.src = this.url;\n    this.active = true;\n    this.playbackRate = playbackRate;\n    this.length = pcmData.length;\n  }\n\n  get duration() {\n    return this.audio.duration;\n  }\n\n  /**\n  * Clear the audio track\n  */\n  unset() {\n    if (this.active) {\n      window.URL.revokeObjectURL(this.url);\n      this.audio.src = \"\";\n      this.audio.load();\n      this.active = false;\n      this.playbackRate = 1;\n      this.length = null;\n    }\n  }\n\n  /**\n  * Start audio playback\n  * @param {number} offset - offset to begin playback at\n  */\n  start(offset) {\n    if (this.active) {\n      this.audio.currentTime = offset || 0;\n      this.audio.play();\n    }\n  }\n\n  /**\n  * Stop audio playback\n  */\n  stop() {\n    if (this.active) {\n      this.audio.pause();\n    }\n  }\n}","import canvas from \"../webgl/canvas\";\nimport parser from \"../parser\";\nimport loader from \"../loader\";\nimport audioTrack from \"./audio\";\nimport webglCanvas from \"../webgl/canvas\";\n\n/** flipnote player API, based on HTMLMediaElement (https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement) */ \nexport default class flipnotePlayer {\n  /**\n  * Create new flipnote player\n  * @param {string | HTMLCanvasElement} el - HTML Canvas Element to use, or CSS selector for one\n  * @param {number} width - canvas width in pixels\n  * @param {number} height - canvas height in pixels\n  */\n  constructor(el, width, height) {\n    // if `el` is a string, use it to select an Element, else assume it's an element\n    el = (\"string\" == typeof el) ? document.querySelector(el) : el;\n    this.canvas = new canvas(el, width, height);\n    this._imgCanvas = new canvas(document.createElement(\"canvas\"), width, height, {\n      antialias: true,\n      preserveDrawingBuffer: true,\n    });\n    this._isOpen = false;\n    this._events = {};\n    this.loop = false;\n    this.currentFrame = 0;\n    this.paused = true;\n    this.customPalette = null;\n    this.audioTracks = [\n      new audioTrack(\"se1\"),\n      new audioTrack(\"se2\"),\n      new audioTrack(\"se3\"),\n      new audioTrack(\"se4\"),\n      new audioTrack(\"bgm\"),\n    ];\n    this.smoothRendering = false;\n  }\n\n  /**\n  * Get the index of the current frame \n  */\n  get currentFrame() {\n    return this._frame;\n  }\n\n  /**\n  * Set the current frame\n  */\n  set currentFrame(index) {\n    this.setFrame(index);\n  }\n\n  /**\n  * Get current playback time in seconds\n  */\n  get currentTime() {\n    return this._isOpen ? this.currentFrame * (1 / this.framerate) : null;\n  }\n\n  /**\n  * Set current playback time in seconds\n  */\n  set currentTime(value) {\n    if ((this._isOpen) && (value < this.duration) && (value > 0)) {\n      this.setFrame(Math.round(value / (1 / this.framerate)));\n    }\n  }\n\n  /**\n  * Get audio volume\n  */\n  get volume() {\n    return this.audioTracks[3].audio.volume;\n  }\n\n  /**\n  * Set audio volume\n  */\n  set volume(value) {\n    for (let i = 0; i < this.audioTracks.length; i++) {\n      this.audioTracks[i].audio.volume = value;\n    }\n  }\n\n  /**\n  * Get audio mute\n  */\n  get muted() {\n    return this.audioTracks[3].audio.muted;\n  }\n\n  /**\n  * Set audio mute\n  */\n  set muted(value) {\n    for (let i = 0; i < this.audioTracks.length; i++) {\n      this.audioTracks[i].audio.muted = value;\n    }\n  }\n\n  /**\n  * Get the duration of the Flipnote in seconds\n  */\n  get duration() {\n    return this._isOpen ? this.frameCount * (1 / this.framerate) : null;\n  }\n\n  /**\n  * Get the Flipnote framerate in frames-per-second\n  */\n  get framerate() {\n    return this.note.framerate;\n  }\n\n  /**\n  * Get the audio playback rate by comparing audio and frame speeds\n  * @access protected\n  */\n  get _audiorate() {\n    return (1 / this.note.bgmrate) / (1 / this.note.framerate);\n  }\n\n  /**\n  * Load a Flipnote into the player\n  * @param {ArrayBuffer} buffer - ppm data\n  * @access protected\n  */\n  _load(buffer) {\n    var note = new parser(buffer);\n    this.note = note;\n    this.meta = note.meta;\n    this.type = note.type;\n    this.frameCount = note.frameCount;\n    this.frameSpeed = note.frameSpeed;\n    this.fileLength = note.byteLength;\n    this.loop = note.meta.loop == 1;\n    this.paused = true;\n    this._isOpen = true;\n    this.audioTracks.forEach(track => {\n      track.sampleRate = note.sampleRate;\n    });\n    if (this.customPalette) {\n      this.setPalette(this.customPalette);\n    }\n    if (this.note.hasAudioTrack(1)) this.audioTracks[0].set(this.note.decodeAudio(\"se1\"), 1);\n    if (this.note.hasAudioTrack(2)) this.audioTracks[1].set(this.note.decodeAudio(\"se2\"), 1);\n    if (this.note.hasAudioTrack(3)) this.audioTracks[2].set(this.note.decodeAudio(\"se3\"), 1);\n    if (this.type === \"KWZ\" && this.note.hasAudioTrack(4)) this.audioTracks[3].set(this.note.decodeAudio(\"se4\"), 1);\n    if (this.note.hasAudioTrack(0)) this.audioTracks[4].set(this.note.decodeAudio(\"bgm\"), this._audiorate);\n    this._seFlags = this.note.decodeSoundFlags();\n    this._playbackLoop = null;\n    this._hasPlaybackStarted = false;\n    this.layerVisiblity = {\n      1: true,\n      2: true,\n      3: true\n    };\n    this.setMode(this.type);\n    this.setFrame(this.note.thumbFrameIndex);\n    this.emit(\"load\");\n  }\n\n  /**\n  * Load a Flipnote into the player\n  * @param {String} source - ppm url\n  */\n  open(source) {\n    if (this._isOpen) this.close();\n    return loader(source)\n      .then((buffer) => {\n        this._load(buffer);\n      })\n      .catch((err) => {\n        console.error(\"Error loading Flipnote:\", err);\n      });\n  }\n\n  /**\n  * Close the currently loaded Flipnote and clear the player canvas\n  */\n  close() {\n    this.pause();\n    this.note = null;\n    this._isOpen = false;\n    this.paused = true;\n    this.loop = null;\n    this.meta = null;\n    this.frameCount = null;\n    this.frameSpeed = null;\n    this._frame = 0;\n    for (let i = 0; i < this.audioTracks.length; i++) {\n      this.audioTracks[i].unset();\n    }\n    this._seFlags = null;\n    this._hasPlaybackStarted = null;\n    this.canvas.clear();\n    this._imgCanvas.clear();\n  }\n\n  /**\n  * Destroy this player instance cleanly\n  */\n  destroy() {\n    this.close();\n    this.canvas.destroy();\n    this._imgCanvas.destroy();\n  }\n\n  /**\n  * Play the sound effects for a given frame\n  * @param {number} index - zero-based frame index\n  * @access protected\n  */\n  _playFrameSe(index) {\n    var flags = this._seFlags[index];\n    for (let i = 0; i < flags.length; i++) {\n      if (flags[i] && this.audioTracks[i].active) this.audioTracks[i].start();\n    }\n  }\n\n  /**\n  * Play the Flipnote BGM\n  * @access protected\n  */\n  _playBgm() {\n    this.audioTracks[4].start(this.currentTime);\n  }\n\n  /**\n  * Stop all audio tracks\n  * @access protected\n  */\n  _stopAudio() {\n    for (let i = 0; i < this.audioTracks.length; i++) {\n      this.audioTracks[i].stop();\n    }\n  }\n\n  /**\n  * Begin Flipnote playback\n  */\n  play() {\n    if ((!this._isOpen) || (!this.paused)) return null;\n    this.paused = false;\n    if ((!this._hasPlaybackStarted) || ((!this.loop) && (this.currentFrame == this.frameCount - 1))) this._frame = 0;\n    this._playBgm();\n    this._playbackLoop = setInterval(() => {\n      if (this.paused) clearInterval(this._playbackLoop);\n      // if the end of the flipnote has been reached\n      if (this.currentFrame >= this.frameCount -1) {\n        this._stopAudio();\n        if (this.loop) {\n          this.firstFrame();\n          this._playBgm(0);\n          this.emit(\"playback:loop\");\n        } else {\n          this.pause();\n          this.emit(\"playback:end\");\n        }\n      } else {\n        this._playFrameSe(this.currentFrame);\n        this.nextFrame();\n      }\n    }, 1000 / this.framerate);\n    this._hasPlaybackStarted = true;\n    this.emit(\"playback:start\");\n  }\n\n  /**\n  * Pause Flipnote playback\n  */\n  pause() {\n    if ((!this._isOpen) || (this.paused)) return null;\n    // break the playback loop\n    clearInterval(this._playbackLoop);\n    this.paused = true;\n    this._stopAudio();\n    this.emit(\"playback:stop\");\n  }\n\n  /**\n  * Get a specific frame as an image data URL\n  * @param {number|string} index - zero-based frame index, or pass \"thumb\" to get the thumbnail frame\n  * @param {string} type - image MIME type, default is image/png\n  * @param {number} encoderOptions - number between 0 and 1 indicating image quality if type is image/jpeg or image/webp\n  */\n  getFrameImage(index, width, height, type, encoderOptions) {\n    if (!this._isOpen) return null;\n    var canvas = this._imgCanvas;\n    if (canvas.width !== width || canvas.height !== height) canvas.resize(width, height);\n    // clamp frame index\n    index = (index == \"thumb\") ? (this.note.thumbFrameIndex) : (Math.max(0, Math.min(index, this.frameCount - 1)));\n    this.drawFrame(index, canvas);\n    return canvas.toImage(type, encoderOptions);\n  }\n\n  setPalette(palette) {\n    this.customPalette = palette;\n    this.note.palette = palette;\n    this.forceUpdate();\n  }\n\n  /**\n  * Jump to a specific frame\n  * @param {number} index - zero-based frame index\n  */\n  setFrame(index) {\n    if ((!this._isOpen) || (index === this.currentFrame)) return null;\n    // clamp frame index\n    index = Math.max(0, Math.min(Math.floor(index), this.frameCount - 1));\n    this._frame = index;\n    this._playbackFrameTime = 0;\n    this.drawFrame(index, this.canvas);\n    this.emit(\"frame:update\", this.currentFrame);\n  }\n\n  /**\n  * Draw a frame to a given canvas\n  * @param {number} index - zero-based frame index\n  * @param {webglCanvas} canvas - webgl frame canvas\n  */\n  drawFrame(frameIndex, canvas) {\n    let colors = this.note.getFramePalette(frameIndex);\n    let layerBuffers = this.note.decodeFrame(frameIndex);\n    canvas.setPaperColor(colors[0]);\n    canvas.clear();\n    if (this.note.type == \"PPM\") {\n      if (this.layerVisiblity[2]) canvas.drawLayer(layerBuffers[1], 256, 192, colors[2], [0,0,0,0]);\n      if (this.layerVisiblity[1]) canvas.drawLayer(layerBuffers[0], 256, 192, colors[1], [0,0,0,0]);\n    } else if (this.note.type == \"KWZ\") {\n      // loop through each layer\n      this.note.getLayerOrder(frameIndex).forEach(layerIndex => {\n        // only draw layer if it's visible\n        if (this.layerVisiblity[layerIndex + 1]) {\n          canvas.drawLayer(layerBuffers[layerIndex], 320, 240, colors[layerIndex * 2 + 1], colors[layerIndex * 2 + 2]);\n        }\n      });\n    }\n  }\n\n  /**\n  * Jump to the thumbnail frame\n  */\n  thumbnailFrame() {\n    this.currentFrame = this.note.thumbFrameIndex;\n  }\n\n  /**\n  * Jump to the next frame in the animation\n  */\n  nextFrame() {\n    if ((this.loop) && (this.currentFrame >= this.frameCount -1)) {\n      this.currentFrame = 0;\n    } else {\n      this.currentFrame += 1;\n    }\n  }\n\n  /**\n  * Jump to the previous frame in the animation\n  */\n  prevFrame() {\n    if ((this.loop) && (this.currentFrame <= 0)) {\n      this.currentFrame = this.frameCount - 1;\n    } else {\n      this.currentFrame -= 1;\n    }\n  }\n\n  /**\n  * Jump to the last frame in the animation\n  */\n  lastFrame() {\n    this.currentFrame = this.frameCount - 1;\n  }\n\n  /**\n  * Jump to the first frame in the animation\n  */\n  firstFrame() {\n    this.currentFrame = 0;\n  }\n\n  /**\n  * Resize player canvas\n  * @param {number} width - canvas width in pixels\n  * @param {number} height - canvas height in pixels\n  */\n  resize(width, height) {\n    this.canvas.resize(width, height);\n    this.forceUpdate();\n  }\n\n  /**\n  * Set layer visibility\n  * @param {number} index - layer number = 1, 2, 3\n  * @param {boolean} value\n  */\n  setLayerVisibility(index, value) {\n    this.layerVisiblity[index] = value;\n    this.forceUpdate();\n  }\n\n  /**\n  * Set smooth rendering\n  * @param {boolean} value\n  */\n  setSmoothRendering(value) {\n    var filter = value ? \"linear\" : \"nearest\";\n    this.canvas.setFilter(filter);\n    this.forceUpdate();\n    this.smoothRendering = value;\n  }\n\n  /**\n  * Set the mode depending on format\n  * @param {string} mode - \"KWZ\" | \"PPM\"\n  */\n  setMode(mode) {\n    this.canvas.setMode(mode);\n    this._imgCanvas.setMode(mode);\n  }\n\n  /**\n  * Force the player to redraw\n  */\n  forceUpdate() {\n    if (this._isOpen) {\n      this.drawFrame(this.currentFrame, this.canvas);\n    }\n  }\n\n  /**\n  * Register an event callback\n  * @param {string} eventType - event type\n  * @param {function} callback - event callback function\n  */\n  on(eventType, callback) {\n    var events = this._events;\n    (events[eventType] || (events[eventType] = [])).push(callback);\n  }\n\n  /**\n  * Remove an event callback\n  * @param {string} eventType - event type\n  * @param {function} callback - event callback function\n  */\n  off(eventType, callback) {\n    var callbackList = this._events[eventType];\n    if (callbackList) callbackList.splice(callbackList.indexOf(callback), 1);\n  }\n\n  /**\n  * Emit an event (used internally)\n  * @param {string} eventType - event type\n  * @param {...} args - arguments to be passed to event callback\n  */\n  emit(eventType, ...args) {\n    var callbackList = this._events[eventType] || [];\n    for (var i = 0; i < callbackList.length; i++) {\n      callbackList[i].apply(null, args); \n    }\n  }\n\n}","export const ADPCM_INDEX_TABLE_2 = new Int8Array([\n  -1, 2, -1, 2\n]);\n\nexport const ADPCM_INDEX_TABLE_4 = new Int8Array([\n  -1, -1, -1, -1, 2, 4, 6, 8,\n  -1, -1, -1, -1, 2, 4, 6, 8\n]);\n\n// note that this is a slight deviation from the normal adpcm table\nexport const ADPCM_STEP_TABLE = new Int16Array([\n  7, 8, 9, 10, 11, 12, 13, 14, 16, 17,\n  19, 21, 23, 25, 28, 31, 34, 37, 41, 45,\n  50, 55, 60, 66, 73, 80, 88, 97, 107, 118,\n  130, 143, 157, 173, 190, 209, 230, 253, 279, 307,\n  337, 371, 408, 449, 494, 544, 598, 658, 724, 796,\n  876, 963, 1060, 1166, 1282, 1411, 1552, 1707, 1878, 2066,\n  2272, 2499, 2749, 3024, 3327, 3660, 4026, 4428, 4871, 5358,\n  5894, 6484, 7132, 7845, 8630, 9493, 10442, 11487, 12635, 13899,\n  15289, 16818, 18500, 20350, 22385, 24623, 27086, 29794, 32767, 0\n]);\n\nexport const ADPCM_SAMPLE_TABLE_2 = new Int16Array(90 * 4);\nfor (let sample = 0; sample < 4; sample++) {\n  for (let stepIndex = 0; stepIndex < 90; stepIndex++) {\n    let step = ADPCM_STEP_TABLE[stepIndex];\n    let diff = step >> 3;\n    if (sample & 1) diff += step;\n    if (sample & 2) diff = -diff;\n    ADPCM_SAMPLE_TABLE_2[sample + 4 * stepIndex] = diff;\n  }\n}\n\nexport const ADPCM_SAMPLE_TABLE_4 = new Int16Array(90 * 16);\nfor (let sample = 0; sample < 16; sample++) {\n  for (let stepIndex = 0; stepIndex < 90; stepIndex++) {\n    let step = ADPCM_STEP_TABLE[stepIndex];\n    let diff = step >> 3;\n    if (sample & 4) diff += step;\n    if (sample & 2) diff += step >> 1;\n    if (sample & 1) diff += step >> 2;\n    if (sample & 8) diff = -diff;\n    ADPCM_SAMPLE_TABLE_4[sample + 16 * stepIndex] = diff;\n  }\n}","export class ByteArray {\n  constructor() {\n    this.page = -1;\n    this.pages = [];\n    this.newPage();\n  }\n  \n  newPage() {\n    this.pages[++this.page] = new Uint8Array(ByteArray.pageSize);\n    this.cursor = 0;\n  }\n  \n  getData() {\n    const data = new Uint8Array((this.page) * ByteArray.pageSize + this.cursor);\n    this.pages.map((page, index) => {\n      if (index === this.page) {\n        data.set(page.slice(0, this.cursor), index * ByteArray.pageSize);\n      } else {\n        data.set(page, index * ByteArray.pageSize);\n      }\n    });\n    return data;\n  }\n\n  getBuffer() {\n    const data = this.getData();\n    return data.buffer;\n  }\n  \n  writeByte(val) {\n    if (this.cursor >= ByteArray.pageSize) this.newPage();\n    this.pages[this.page][this.cursor++] = val;\n  }\n\n  writeBytes(array, offset, length) {\n    for (var l = length || array.length, i = offset || 0; i < l; i++)\n      this.writeByte(array[i]);\n  }\n}\n\nByteArray.pageSize = 4096;","/** datastream serves as a wrapper around the DataView API to help keep track of the offset into the stream */\nexport default class dataStream {\n  /**\n  * Create a fileReader instance\n  * @param {ArrayBuffer} arrayBuffer - data to read from\n  */\n  constructor(arrayBuffer) {\n    this.buffer = arrayBuffer;\n    this._data = new DataView(arrayBuffer);\n    this._offset = 0;\n  }\n\n  get bytes() {\n    return new Uint8Array(this.buffer);\n  }\n\n  /**\n  * Get the length of the stream\n  * @returns {number}\n  */\n  get byteLength() {\n    return this._data.byteLength;\n  }\n\n  /**\n  * based on the seek method from Python's file objects - https://www.tutorialspoint.com/python/file_seek.htm\n  * @param {number} offset - position of the read pointer within the stream\n  * @param {number} whence - (optional) defaults to absolute file positioning,\n  *                          1 = offset is relative to the current position\n  *                          2 = offset is relative to the stream's end\n  */\n  seek(offset, whence) {\n    switch (whence) {\n      case 2:\n        this._offset = this._data.byteLength + offset;\n        break;\n      case 1:\n        this._offset += offset;\n        break;\n      case 0:\n      default:\n        this._offset = offset;\n        break;\n    }\n  }\n\n  /**\n  * Read an unsigned 8-bit integer from the stream, and automatically increment the offset\n  * @returns {number}\n  */\n  readUint8() {\n    var val = this._data.getUint8(this._offset);\n    this._offset += 1;\n    return val;\n  }\n\n  /**\n  * Write an unsigned 8-bit integer to the stream, and automatically increment the offset\n  * @param {number} value - value to write\n  */\n  writeUint8(value) {\n    this._data.setUint8(this._offset, value);\n    this._offset += 1;\n  }\n\n  /**\n  * Read a signed 8-bit integer from the stream, and automatically increment the offset\n  * @returns {number}\n  */\n  readInt8() {\n    var val = this._data.getInt8(this._offset);\n    this._offset += 1;\n    return val;\n  }\n\n  /**\n  * Write a signed 8-bit integer to the stream, and automatically increment the offset\n  * @param {number} value - value to write\n  */\n  writeInt8(value) {\n    this._data.setInt8(this._offset, value);\n    this._offset += 1;\n  }\n\n  /**\n  * Read an unsigned 16-bit integer from the stream, and automatically increment the offset\n  * @param {boolean} littleEndian - defaults to true, set to false to read data in big endian byte order\n  * @returns {number}\n  */\n  readUint16(littleEndian=true) {\n    var val = this._data.getUint16(this._offset, littleEndian);\n    this._offset += 2;\n    return val;\n  }\n\n  /**\n  * Write an unsigned 16-bit integer to the stream, and automatically increment the offset\n  * @param {number} value - value to write\n  * @param {boolean} littleEndian - defaults to true, set to false to write data in big endian byte order\n  */\n  writeUint16(value, littleEndian=true) {\n    this._data.setUint16(this._offset, value, littleEndian);\n    this._offset += 2;\n  }\n\n  /**\n  * Read a signed 16-bit integer from the stream, and automatically increment the offset\n  * @param {boolean} littleEndian - defaults to true, set to false to read data in big endian byte order\n  * @returns {number}\n  */\n  readInt16(littleEndian=true) {\n    var val = this._data.getInt16(this._offset, littleEndian);\n    this._offset += 2;\n    return val;\n  }\n\n  /**\n  * Write a signed 16-bit integer to the stream, and automatically increment the offset\n  * @param {number} value - value to write\n  * @param {boolean} littleEndian - defaults to true, set to false to write data in big endian byte order\n  */\n  writeInt16(value, littleEndian=true) {\n    this._data.setInt16(this._offset, value, littleEndian);\n    this._offset += 2;\n  }\n\n  /**\n  * Read an unsigned 32-bit integer from the stream, and automatically increment the offset\n  * @param {boolean} littleEndian - defaults to true, set to false to read data in big endian byte order\n  * @returns {number}\n  */\n  readUint32(littleEndian=true) {\n    var val = this._data.getUint32(this._offset, littleEndian);\n    this._offset += 4;\n    return val;\n  }\n\n  /**\n  * Write an unsigned 32-bit integer to the stream, and automatically increment the offset\n  * @param {number} value - value to write\n  * @param {boolean} littleEndian - defaults to true, set to false to write data in big endian byte order\n  */\n  writeUint32(value, littleEndian=true) {\n    this._data.setUint32(this._offset, value, littleEndian);\n    this._offset += 4;\n  }\n\n  /**\n  * Read a signed 32-bit integer from the stream, and automatically increment the offset\n  * @param {boolean} littleEndian - defaults to true, set to false to read data in big endian byte order\n  * @returns {number}\n  */\n  readInt32(littleEndian=true) {\n    var val = this._data.getInt32(this._offset, littleEndian);\n    this._offset += 4;\n    return val;\n  }\n\n  /**\n  * Write a signed 32-bit integer to the stream, and automatically increment the offset\n  * @param {number} value - value to write\n  * @param {boolean} littleEndian - defaults to true, set to false to write data in big endian byte order\n  */\n  writeInt32(value, littleEndian=true) {\n    this._data.setInt32(this._offset, value, littleEndian);\n    this._offset += 4;\n  }\n\n  /**\n  * Read bytes and return an array\n  * @param {number} count - number of bytes to read\n  * @returns {Uint8Array}\n  */\n  readBytes(count) {\n    var bytes = new Uint8Array(this._data.buffer, this._offset, count);\n    this._offset += bytes.byteLength;\n    return bytes;\n  }\n\n  /**\n  * Write bytes from an array\n  * @param {Array} bytes - array of byte values\n  * @returns {Uint8Array}\n  */\n  writeBytes(bytes) {\n    bytes.forEach(byte => this.writeUint8(byte));\n  }\n\n  /**\n  * Read bytes and return a hex string\n  * @param {number} count - number of bytes to read\n  * @param {bool} reverse - pass true to reverse byte order\n  * @returns {string}\n  */\n  readHex(count, reverse=false) {\n    var bytes = this.readBytes(count);\n    let hex = [];\n    for (let i = 0; i < bytes.length; i++) {\n      hex.push(bytes[i].toString(16).padStart(2, \"0\"));\n    }\n    if (reverse) hex.reverse();\n    return hex.join(\"\").toUpperCase();\n  }\n\n  /**\n  * Read (simple) utf8 string\n  * @param {number} count - number of characters to read\n  * @returns {string}\n  */\n  readUtf8(count) {\n    var chars = this.readBytes(count);\n    var str = \"\";\n    for (let i = 0; i < chars.length; i++) {\n      let char = chars[i];\n      if (char == 0) break;\n      str += String.fromCharCode(char);\n    }\n    return str;\n  }\n\n  /**\n  * Write (simple) utf8 string\n  * @param {string} string - string to write\n  */\n  writeUtf8(string) {\n    for (let i = 0; i < string.length; i++) {\n      let char = string.charCodeAt(i);\n      this.writeUint8(char);\n    }\n  }\n\n  /**\n  * Read (simple) utf16 string\n  * @param {number} count - number of characters to read\n  * @returns {string}\n  */\n  readUtf16(count) {\n    var chars = new Uint16Array(this._data.buffer, this._offset, count);\n    this._offset += chars.byteLength;\n    var str = \"\";\n    for (let i = 0; i < chars.length; i++) {\n      let char = chars[i];\n      if (char == 0) break;\n      str += String.fromCharCode(char);\n    }\n    return str;\n  }\n}","import vertexShader from \"./shader.vert\";\nimport fragmentShader from \"./shader.frag\";\n\n/** webgl canvas wrapper class */\nexport default class webglCanvas {\n  /**\n  * Create a rendering canvas\n  * @param {HTMLCanvasElement} el - The HTML canvas element\n  * @param {number} width - width of the canvas in pixels\n  * @param {number} height - height of the canvas in pixels\n  * @param {Object} params - optional params to pass to web gl context\n  */\n  constructor(el, width=640, height=480, params={antialias: false, alpha: false}) {\n    this.width = el.width = width;\n    this.height = el.height = height; \n    var gl = el.getContext(\"webgl\", params);\n    var program = gl.createProgram();\n    this.program = program;\n    this.el = el;\n    this.gl = gl;\n    this.refs = {\n      shaders:[],\n      textures:[],\n      buffers: []\n    };\n    // set up shaders\n    var vShader = this._createShader(gl.VERTEX_SHADER, vertexShader);\n    var fShader = this._createShader(gl.FRAGMENT_SHADER, fragmentShader);\n    gl.attachShader(program, vShader);\n    gl.attachShader(program, fShader);\n    // link program\n    gl.linkProgram(program);\n    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\n      let log = gl.getProgramInfoLog(program);\n      gl.deleteProgram(program);\n      throw new Error(log);\n    }\n    // activate the program\n    gl.useProgram(program);\n    // create quad that fills the screen, this will be our drawing surface\n    var vertBuffer = gl.createBuffer();\n    gl.bindBuffer(gl.ARRAY_BUFFER, vertBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([1,  1, -1, 1, -1, -1, 1, 1, -1, -1, 1, -1]), gl.STATIC_DRAW);\n    gl.enableVertexAttribArray(0);\n    gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);\n    this.refs.buffers.push(vertBuffer);\n    // create texture to use as the layer bitmap\n    gl.activeTexture(gl.TEXTURE0);\n    var tex = gl.createTexture();\n    gl.bindTexture(gl.TEXTURE_2D, tex);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n    // get uniform locations\n    this.uniforms = {};\n    let uniformCount = gl.getProgramParameter(program, gl.ACTIVE_UNIFORMS);\n    for (let i = 0; i < uniformCount; i++) {\n      let name = gl.getActiveUniform(program, i).name;\n      this.uniforms[name] = gl.getUniformLocation(program, name);\n    }\n    gl.uniform1i(this.uniforms.u_bitmap, 0);\n    this.setFilter(\"linear\");\n    this.setMode(\"PPM\");\n    this.refs.textures.push(tex);\n    gl.enable(gl.BLEND);\n    gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\n  }\n  \n  /**\n  * Util to compile and attach a new shader\n  * @param {shader type} type - gl.VERTEX_SHADER | gl.FRAGMENT_SHADER\n  * @param {string} source - GLSL code for the shader\n  * @returns {shader} compiled webgl shader\n  * @access protected \n  */\n  _createShader(type, source) {\n    var gl = this.gl;\n    var shader = gl.createShader(type);\n    gl.shaderSource(shader, source);\n    gl.compileShader(shader);\n    // test if shader compilation was successful\n    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\n      let log = gl.getShaderInfoLog(shader);\n      gl.deleteShader(shader);\n      throw new Error(log);\n    }\n    this.refs.shaders.push(shader);\n    return shader;\n  }\n\n  /**\n  * get the canvas content as an image\n  * @param {string} type - image MIME type, default is image/png\n  * @param {number} encoderOptions - number between 0 and 1 indicating image quality if type is image/jpeg or image/webp\n  * @returns {DataUrl}\n  */\n  toImage(type, encoderOptions) {\n    return this.el.toDataURL(type, encoderOptions);\n  }\n\n  /**\n  * Set the texture filter\n  * @param {string} filter - \"linear\" | \"nearest\"\n  */\n  setFilter(filter) {\n    var gl = this.gl;\n    filter = filter == \"linear\" ? gl.LINEAR : gl.NEAREST;\n    gl.uniform1i(this.uniforms.u_isSmooth, filter == \"linear\" ? 0 : 1);\n    gl.activeTexture(gl.TEXTURE0);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filter);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filter);\n  }\n\n  /**\n  * Set the canvas mode depending on format\n  * @param {string} mode - \"KWZ\" | \"PPM\"\n  */\n  setMode(mode) {\n    const { gl } = this;\n    if (mode === \"PPM\") {\n      this.textureType = gl.ALPHA;\n    } else if (mode === \"KWZ\") {\n      this.textureType = gl.LUMINANCE_ALPHA;\n    }\n  }\n\n  /**\n  * Set a color\n  * @param {string} color - name of the color's uniform variable\n  * @param {array} value - r,g,b color, each channel's value should be between 0 and 255\n  */\n  setColor(color, value) {\n    this.gl.uniform4f(this.uniforms[color], value[0]/255, value[1]/255, value[2]/255, 1);\n  }\n\n  /**\n  * Set an palette individual color\n  * @param {array} value - r,g,b color, each channel's value should be between 0 and 255\n  */\n  setPaperColor(value) {\n    this.gl.clearColor(value[0] / 255, value[1] / 255, value[2] / 255, 1);\n  }\n\n  /**\n  * Draw a single frame layer\n  * @param {Uint16Array} buffer - layer pixels\n  * @param {number} width - layer width\n  * @param {number} height - layer height\n  * @param {array} color1 - r,g,b for layer color 1, each channel's value should be between 0 and 255\n  * @param {array} color2 - r,g,b for layer color 2, each channel's value should be between 0 and 255\n  * @param {number} depth - layer depth (kwz only, but currently unused)\n  */\n  drawLayer(buffer, width, height, color1, color2, depth) {\n    let gl = this.gl;\n    gl.activeTexture(gl.TEXTURE0);\n    gl.texImage2D(gl.TEXTURE_2D, 0, this.textureType, width, height, 0, this.textureType, gl.UNSIGNED_BYTE, buffer);\n    // gl.uniform1f(gl.getUniformLocation(this.program, \"u_layerDepth\"), -depth/6);\n    this.setColor(\"u_color1\", color1);\n    this.setColor(\"u_color2\", color2);\n    gl.drawArrays(gl.TRIANGLES, 0, 6);\n  }\n\n  /**\n  * Resize canvas\n  * @param {number} width - width of the canvas in pixels\n  * @param {number} height - height of the canvas in pixels\n  */\n  resize(width=640, height=480) {\n    this.el.width = width;\n    this.el.height = height; \n    this.width = width;\n    this.height = height;\n    this.gl.viewport(0, 0, width, height);\n  }\n\n  /**\n  * Clear canvas\n  */\n  clear() {\n    this.gl.clear(this.gl.COLOR_BUFFER_BIT);\n  }\n\n  /** \n  * Destroy this canvas instance\n  */\n  destroy() {\n    // free resources\n    var refs = this.refs;\n    var gl = this.gl;\n    refs.shaders.forEach((shader) => {\n      gl.deleteShader(shader);\n    });\n    refs.shaders = [];\n    refs.textures.forEach((texture) => {\n      gl.deleteTexture(texture);\n    });\n    refs.textures = [];\n    refs.buffers.forEach((buffer) => {\n      gl.deleteBuffer(buffer);\n    });\n    refs.buffers = [];\n    gl.deleteProgram(this.program);\n    // shrink the canvas to reduce memory usage until it is garbage collected\n    gl.canvas.width = 1;\n    gl.canvas.height = 1;\n  }\n}","module.exports = \"precision mediump float;\\n#define GLSLIFY 1\\nvarying vec2 v_texcoord;\\nuniform vec4 u_color1;\\nuniform vec4 u_color2;\\nuniform sampler2D u_bitmap;\\nuniform bool u_isSmooth;\\nvoid main() {\\n  float weightColor1 = texture2D(u_bitmap, v_texcoord).a;\\n  float weightColor2 = texture2D(u_bitmap, v_texcoord).r;\\n  float alpha = 1.0;\\n  if (u_isSmooth) {\\n    weightColor1 = smoothstep(0.0, .9, weightColor1);\\n    weightColor2 = smoothstep(0.0, .9, weightColor2);\\n    float alpha = weightColor1 + weightColor2;\\n  }\\n  gl_FragColor = vec4(u_color1.rgb, alpha) * weightColor1 + vec4(u_color2.rgb, alpha) * weightColor2;\\n}\\n\"","module.exports = \"#define GLSLIFY 1\\nattribute vec4 a_position;\\nvarying vec2 v_texcoord;\\nvoid main() {\\n  gl_Position = a_position;\\n  v_texcoord = a_position.xy * vec2(0.5, -0.5) + 0.5;\\n}\""],"sourceRoot":""}