/*!!
 flipnote.js v5.0.0 (webcomponent build)
 Javascript parsing and in-browser playback for the .PPM and .KWZ animation formats used by Flipnote Studio and Flipnote Studio 3D.
 Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't endorsed by them in any way.
 2018 - 2021 James Daniel
 github.com/jaames/flipnote.js
 Keep on Flipnoting!
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t=t||self).flipnote={})}(this,(function(t){"use strict";function i(){}function n(t){return t()}function r(){return Object.create(null)}function e(t){t.forEach(n)}function s(t){return"function"==typeof t}function o(t,i){return t!=t?i==i:t!==i||t&&"object"==typeof t||"function"==typeof t}function h(t,i){t.appendChild(i)}function u(t,i,n){t.insertBefore(i,n||null)}function a(t){t.parentNode.removeChild(t)}function f(t){return document.createElement(t)}function c(t){return document.createTextNode(t)}function l(){return c(" ")}function v(t,i,n,r){return t.addEventListener(i,n,r),()=>t.removeEventListener(i,n,r)}function y(t,i,n){null==n?t.removeAttribute(i):t.getAttribute(i)!==n&&t.setAttribute(i,n)}function p(t,i,n){i in t?t[i]=n:y(t,i,n)}function d(t,i,n,r){t.style.setProperty(i,n,r?"important":"")}let m;function w(t){m=t}function b(){if(!m)throw new Error("Function called outside component initialization");return m}function g(){const t=b();return(i,n)=>{const r=t.$$.callbacks[i];if(r){const e=function(t,i){const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,!1,!1,i),n}(i,n);r.slice().forEach(i=>{i.call(t,e)})}}}const _=[],A=[],F=[],x=[],z=Promise.resolve();let P=!1;function S(t){F.push(t)}let C=!1;const T=new Set;function U(){if(!C){C=!0;do{for(let t=0;t<_.length;t+=1){const i=_[t];w(i),k(i.$$)}for(_.length=0;A.length;)A.pop()();for(let t=0;t<F.length;t+=1){const i=F[t];T.has(i)||(T.add(i),i())}F.length=0}while(_.length);for(;x.length;)x.pop()();P=!1,C=!1,T.clear()}}function k(t){if(null!==t.fragment){t.update(),e(t.before_update);const i=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,i),t.after_update.forEach(S)}}const E=new Set;let B,I;function O(t,i){t&&t.i&&(E.delete(t),t.i(i))}function M(t,i){const n=i.token={};function r(t,r,s,o){if(i.token!==n)return;i.resolved=o;let h=i.ctx;void 0!==s&&(h=h.slice(),h[s]=o);const u=t&&(i.current=t)(h);let a=!1;i.block&&(i.blocks?i.blocks.forEach((t,n)=>{n!==r&&t&&(B={r:0,c:[],p:B},function(t,i,n,r){if(t&&t.o){if(E.has(t))return;E.add(t),B.c.push(()=>{E.delete(t),r&&(n&&t.d(1),r())}),t.o(i)}}(t,1,1,()=>{i.blocks[n]=null}),B.r||e(B.c),B=B.p)}):i.block.d(1),u.c(),O(u,1),u.m(i.mount(),i.anchor),a=!0),i.block=u,i.blocks&&(i.blocks[r]=u),a&&U()}if((s=t)&&"object"==typeof s&&"function"==typeof s.then){const n=b();if(t.then(t=>{w(n),r(i.then,1,i.value,t),w(null)},t=>{w(n),r(i.catch,2,i.error,t),w(null)}),i.current!==i.pending)return r(i.pending,0),!0}else{if(i.current!==i.then)return r(i.then,1,i.value,t),!0;i.resolved=t}var s}function L(t,i){-1===t.$$.dirty[0]&&(_.push(t),P||(P=!0,z.then(U)),t.$$.dirty.fill(0)),t.$$.dirty[i/31|0]|=1<<i%31}function j(t,o,h,u,f,c,l=[-1]){const v=m;w(t);const y=o.props||{},p=t.$$={fragment:null,ctx:null,props:c,update:i,not_equal:f,bound:r(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(v?v.$$.context:[]),callbacks:r(),dirty:l};let d=!1;if(p.ctx=h?h(t,y,(i,n,...r)=>{const e=r.length?r[0]:n;return p.ctx&&f(p.ctx[i],p.ctx[i]=e)&&(p.bound[i]&&p.bound[i](e),d&&L(t,i)),n}):[],p.update(),d=!0,e(p.before_update),p.fragment=!!u&&u(p.ctx),o.target){if(o.hydrate){const t=function(t){return Array.from(t.childNodes)}(o.target);p.fragment&&p.fragment.l(t),t.forEach(a)}else p.fragment&&p.fragment.c();o.intro&&O(t.$$.fragment),function(t,i,r){const{fragment:o,on_mount:h,on_destroy:u,after_update:a}=t.$$;o&&o.m(i,r),S(()=>{const i=h.map(n).filter(s);u?u.push(...i):e(i),t.$$.on_mount=[]}),a.forEach(S)}(t,o.target,o.anchor),U()}w(v)}"function"==typeof HTMLElement&&(I=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){for(const t in this.$$.slotted)this.appendChild(this.$$.slotted[t])}attributeChangedCallback(t,i,n){this[t]=n}$destroy(){!function(t,i){const n=t.$$;null!==n.fragment&&(e(n.on_destroy),n.fragment&&n.fragment.d(i),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=i}$on(t,i){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(i),()=>{const t=n.indexOf(i);-1!==t&&n.splice(t,1)}}$set(){}});var D=function(t,i){return(D=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])})(t,i)};function R(t,i){function n(){this.constructor=t}D(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}var N=function(){return(N=Object.assign||function(t){for(var i,n=1,r=arguments.length;n<r;n++)for(var e in i=arguments[n])Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t}).apply(this,arguments)};function G(t,i,n,r){return new(n||(n=Promise))((function(e,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function h(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(t){t(i)}))).then(o,h)}u((r=r.apply(t,i||[])).next())}))}function W(t,i){var n,r,e,s,o={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]};return s={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function h(s){return function(h){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(e=2&s[0]?r.return:s[0]?r.throw||((e=r.return)&&e.call(r),0):r.next)&&!(e=e.call(r,s[1])).done)return e;switch(r=0,e&&(s=[2&s[0],e.value]),s[0]){case 0:case 1:e=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(e=o.trys,(e=e.length>0&&e[e.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!e||s[1]>e[0]&&s[1]<e[3])){o.label=s[1];break}if(6===s[0]&&o.label<e[1]){o.label=e[1],e=s;break}if(e&&o.label<e[2]){o.label=e[2],o.ops.push(s);break}e[2]&&o.ops.pop(),o.trys.pop();continue}s=i.call(t,o)}catch(t){s=[6,t],r=0}finally{n=e=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,h])}}}var $,Y,H=function(){function t(){this.pageSize=t.pageSize,this.currPageIndex=-1,this.pages=[],this.cursor=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.currPageIndex]=new Uint8Array(this.pageSize),this.currPage=this.pages[this.currPageIndex],this.cursor=0},t.prototype.getData=function(){for(var t=new Uint8Array(this.currPageIndex*this.pageSize+this.cursor),i=0;i<this.pages.length;i++){var n=this.pages[i];i===this.currPageIndex?t.set(n.slice(0,this.cursor),i*this.pageSize):t.set(n,i*this.pageSize)}return t},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(t){this.cursor>=this.pageSize&&this.newPage(),this.currPage[this.cursor++]=t},t.prototype.writeBytes=function(t,i,n){for(var r=n||t.length,e=i||0;e<r;e++)this.writeByte(t[e])},t.pageSize=2048,t}(),V=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.cursor=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,i){switch(i){case 2:this.cursor=this.data.byteLength+t;break;case 1:this.cursor+=t;break;case 0:default:this.cursor=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.cursor);return this.cursor+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.cursor,t),this.cursor+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.cursor);return this.cursor+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.cursor,t),this.cursor+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var i=this.data.getUint16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeUint16=function(t,i){void 0===i&&(i=!0),this.data.setUint16(this.cursor,t,i),this.cursor+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var i=this.data.getInt16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeInt16=function(t,i){void 0===i&&(i=!0),this.data.setInt16(this.cursor,t,i),this.cursor+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var i=this.data.getUint32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeUint32=function(t,i){void 0===i&&(i=!0),this.data.setUint32(this.cursor,t,i),this.cursor+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var i=this.data.getInt32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeInt32=function(t,i){void 0===i&&(i=!0),this.data.setInt32(this.cursor,t,i),this.cursor+=4},t.prototype.readBytes=function(t){var i=new Uint8Array(this.data.buffer,this.cursor,t);return this.cursor+=i.byteLength,i},t.prototype.writeBytes=function(t){var i=this;t.forEach((function(t){return i.writeUint8(t)}))},t.prototype.readHex=function(t,i){void 0===i&&(i=!1);for(var n=this.readBytes(t),r=[],e=0;e<n.length;e++)r.push(n[e].toString(16).padStart(2,"0"));return i&&r.reverse(),r.join("").toUpperCase()},t.prototype.readChars=function(t){for(var i=this.readBytes(t),n="",r=0;r<i.length;r++){var e=i[r];if(0===e)break;n+=String.fromCharCode(e)}return n},t.prototype.writeChars=function(t){for(var i=0;i<t.length;i++){var n=t.charCodeAt(i);this.writeUint8(n)}},t.prototype.readWideChars=function(t){for(var i=new Uint16Array(this.data.buffer,this.cursor,t),n="",r=0;r<i.length;r++){var e=i[r];if(0==e)break;n+=String.fromCharCode(e)}return this.cursor+=i.byteLength,n},t}(),q="undefined"!=typeof window&&void 0!==window.document,K="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;($=t.FlipnoteFormat||(t.FlipnoteFormat={}))[$.PPM=0]="PPM",$[$.KWZ=1]="KWZ",(Y=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[Y.BGM=0]="BGM",Y[Y.SE1=1]="SE1",Y[Y.SE2=2]="SE2",Y[Y.SE3=3]="SE3",Y[Y.SE4=4]="SE4";var Z=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return R(i,t),i.prototype.hasAudioTrack=function(t){return!!(this.soundMeta.hasOwnProperty(t)&&this.soundMeta[t].length>0)},i}(V),J=[{matches:function(t){return q&&"string"==typeof t},load:function(t,i,n){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(t){4===r.readyState&&(r.status>=200&&r.status<300?i(r.response):n({type:"httpError",status:r.status,statusText:r.statusText}))},r.send(null)}},{matches:function(t){return K&&"string"==typeof t},load:function(t,i,n){require("https").get(t,(function(t){var r=[];t.on("data",(function(t){return r.push(t)})),t.on("end",(function(){var t=Buffer.concat(r);i(t.buffer)})),t.on("error",(function(t){return n(t)}))}))}},{matches:function(t){return q&&"undefined"!=typeof File&&t instanceof File},load:function(t,i,n){if("undefined"!=typeof FileReader){var r=new FileReader;r.onload=function(t){i(r.result)},r.onerror=function(t){n({type:"fileReadError"})},r.readAsArrayBuffer(t)}else n()}},{matches:function(t){return K&&t instanceof Buffer},load:function(t,i,n){i(t.buffer)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,i,n){i(t)}}];function X(t,i,n){return t<i?i:t>n?n:t}function Q(t,i,n){for(var r=t.length/i,e=new Int16Array(r*n),s=i/n,o=0;o<e.length;o++)e[o]=t[Math.floor(o*s)];return e}var tt=new Int8Array([-1,2,-1,2]),it=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),nt=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function rt(t){for(var i=t.length,n=0,r=0;r<i;r++){var e=t[r];-32768!=e&&32767!=e||(n+=1)}return n/i}for(var et=[.5,.5,1,2,4,6,12,20,30],st={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},ot=function(i){function n(r,e){var s=i.call(this,r)||this;return s.format=t.FlipnoteFormat.PPM,s.formatString="PPM",s.width=n.width,s.height=n.height,s.numLayers=n.numLayers,s.rawSampleRate=n.rawSampleRate,s.sampleRate=n.sampleRate,s.globalPalette=n.globalPalette,s.prevDecodedFrame=null,s.decodeHeader(),s.decodeAnimationHeader(),s.decodeSoundHeader(),0!=(s.version>>4&15)&&s.decodeMeta(),s.layers=[new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height)],s.prevLayers=[new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height)],s.prevDecodedFrame=null,s}return R(n,i),n.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},n.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},n.prototype.decodeHeader=function(){this.seek(0);this.readUint32();this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},n.prototype.readFilename=function(){return[this.readHex(3),this.readChars(13),this.readUint16().toString().padStart(3,"0")].join("_")},n.prototype.decodeMeta=function(){this.seek(16);var t=this.readUint16(),i=this.readInt16(),n=this.readWideChars(11),r=this.readWideChars(11),e=this.readWideChars(11),s=this.readHex(8,!0),o=this.readHex(8,!0),h=this.readFilename(),u=this.readFilename(),a=this.readHex(8,!0);this.seek(154);var f=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=i,this.layerVisibility={1:0==(16&c),2:0==(32&c),3:!1},this.isSpinoff=o!==s||o!==a,this.meta={lock:1===t,loop:1==(c>>1&1),frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,thumbIndex:i,timestamp:f,root:{filename:null,username:n,fsid:a},parent:{username:r,fsid:s,filename:h},current:{username:e,fsid:o,filename:u}}},n.prototype.decodeAnimationHeader=function(){this.seek(1696);var t=this.readUint16(),i=t/4;this.seek(1704);for(var n=new Uint32Array(i),r=0;r<i;r++)n[r]=1704+t+this.readUint32();this.frameOffsets=n},n.prototype.decodeSoundHeader=function(){var i,n=1696+this.frameDataLength+this.frameCount;n%4!=0&&(n+=4-n%4),this.seek(n);var r=this.readUint32(),e=this.readUint32(),s=this.readUint32(),o=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),n+=32,this.framerate=et[this.frameSpeed],this.bgmrate=et[this.bgmSpeed],this.soundMeta=((i={})[t.FlipnoteAudioTrack.BGM]={offset:n,length:r},i[t.FlipnoteAudioTrack.SE1]={offset:n+=r,length:e},i[t.FlipnoteAudioTrack.SE2]={offset:n+=e,length:s},i[t.FlipnoteAudioTrack.SE3]={offset:n+=s,length:o},i)},n.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},n.prototype.readLineEncoding=function(){for(var t=new Uint8Array(n.height),i=0,r=0;r<48;r++)for(var e=this.readUint8(),s=0;s<8;s+=2)t[i++]=e>>s&3;return t},n.prototype.decodeFrame=function(t){this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.seek(this.frameOffsets[t]);var i=this.readUint8(),r=i>>7&1,e=i>>5&3,s=0,o=0;this.prevDecodedFrame=t,this.layers[0].fill(0),this.layers[1].fill(0),e&&(s=this.readInt8(),o=this.readInt8());for(var h=[this.readLineEncoding(),this.readLineEncoding()],u=0;u<2;u++)for(var a=this.layers[u],f=0;f<n.height;f++){var c=h[u][f],l=f*n.width;switch(c){case 0:break;case 1:case 2:var v=this.readUint32(!1);for(2==c&&a.fill(1,l,l+n.width);4294967295&v;){if(2147483648&v)for(var y=this.readUint8(),p=0;p<8;p++)a[l+p]=y>>p&1;l+=8,v<<=1}break;case 3:for(;l<(f+1)*n.width;){for(y=this.readUint8(),p=0;p<8;p++)a[l+p]=y>>p&1;l+=8}}}var d=this.layers[0],m=this.layers[1],w=this.prevLayers[0],b=this.prevLayers[1];if(!r)for(var g=void 0,_=void 0,A=0;A<n.height;A++)if(!(A-o<0)){if(A-o>=n.height)break;for(var F=0;F<n.width;F++)if(!(F-s<0)){if(F-s>=n.width)break;_=(g=F+A*n.width)-(s+o*n.width),d[g]^=w[_],m[g]^=b[_]}}return this.prevLayers[0].set(this.layers[0]),this.prevLayers[1].set(this.layers[1]),this.layers},n.prototype.getFrameLayerOrder=function(t){return[0,1]},n.prototype.getFramePaletteIndices=function(t){this.seek(this.frameOffsets[t]);var i=this.readUint8(),n=1!=(1&i),r=[n?0:1,n?0:1,2,3];return[n?1:0,r[i>>1&3],r[i>>3&3]]},n.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},n.prototype.getLayerPixels=function(t,i){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),e=this.layers[i],s=new Uint8Array(n.width*n.height),o=r[i+1],h=0;h<s.length;h++)1===e[h]&&(s[h]=o);return s},n.prototype.getFramePixels=function(t){var i=this.getFramePaletteIndices(t),r=this.decodeFrame(t),e=new Uint8Array(n.width*n.height),s=r[0],o=r[1],h=i[0],u=i[1],a=i[2];e.fill(h);for(var f=0;f<e.length;f++){var c=s[f],l=o[f];1===c?e[f]=u:1===l&&(e[f]=a)}return e},n.prototype.decodeSoundFlags=function(){this.seek(1696+this.frameDataLength);for(var t=this.frameCount,i=this.readBytes(t),n=new Array(t),r=0;r<t;r++){var e=i[r];n[r]=[0!=(1&e),0!=(2&e),0!=(4&e)]}return n},n.prototype.getAudioTrackRaw=function(t){var i=this.soundMeta[t];return this.seek(i.offset),this.readBytes(i.length)},n.prototype.decodeAudioTrack=function(t){for(var i=this.getAudioTrackRaw(t),n=i.length,r=new Int16Array(2*n),e=0,s=0,o=0,h=0,u=0,a=!0;e<n;){o=a?15&i[e]:i[e++]>>4,a=!a;var f=nt[h],c=f>>3;1&o&&(c+=f>>2),2&o&&(c+=f>>1),4&o&&(c+=f),8&o&&(c=-c),u=X(u+=c,-32768,32767),h=X(h+=it[o],0,88),r[s++]=u}return r},n.prototype.getAudioTrackPcm=function(i,n){void 0===n&&(n=this.sampleRate);var r=this.decodeAudioTrack(i),e=this.rawSampleRate;if(i===t.FlipnoteAudioTrack.BGM){var s=1/this.bgmrate/(1/this.framerate);e=this.rawSampleRate*s}return e!==n?Q(r,e,n):r},n.prototype.pcmAudioMix=function(t,i,n){void 0===n&&(n=0);for(var r=t.length,e=i.length,s=0;s<r&&!(n+s>e);s++){var o=i[n+s]+t[s]/2;i[n+s]=X(o,-32768,32767)}},n.prototype.getAudioMasterPcm=function(i){void 0===i&&(i=this.sampleRate);var n=this.frameCount*(1/this.framerate),r=Math.ceil(n*i),e=new Int16Array(r),s=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),h=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),u=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(s){var a=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,i);this.pcmAudioMix(a,e,0)}if(o||h||u)for(var f=i/this.framerate,c=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,i):null,l=h?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,i):null,v=u?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,i):null,y=this.decodeSoundFlags(),p=0;p<this.frameCount;p++){var d=Math.ceil(p*f),m=y[p];o&&m[0]&&this.pcmAudioMix(c,e,d),h&&m[1]&&this.pcmAudioMix(l,e,d),u&&m[2]&&this.pcmAudioMix(v,e,d)}return this.audioClipRatio=rt(e),e},n.defaultSettings={},n.format=t.FlipnoteFormat.PPM,n.width=256,n.height=192,n.numLayers=2,n.rawSampleRate=8192,n.sampleRate=32768,n.globalPalette=[st.WHITE,st.BLACK,st.RED,st.BLUE],n}(Z),ht=[.2,.5,1,2,4,6,8,12,20,24,30],ut={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},at=new Uint16Array(16),ft=0;ft<16;ft++)at[ft]=(1<<ft)-1;for(var ct=new Uint8Array(52488),lt=new Uint8Array(52488),vt=0,yt=0;yt<3;yt++)for(var pt=0;pt<3;pt++)for(var dt=0;dt<3;dt++)for(var mt=0;mt<3;mt++)for(var wt=0;wt<3;wt++)for(var bt=0;bt<3;bt++)for(var gt=0;gt<3;gt++)for(var _t=0;_t<3;_t++)ct.set([pt,yt,mt,dt,bt,wt,_t,gt],vt),lt.set([yt,mt,dt,bt,wt,_t,gt,pt],vt),vt+=8;var At=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,i){var n=ct.subarray(8*t,8*t+8);At.set(n,8*i)}));var Ft=new Uint8Array(256);[0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100].forEach((function(t,i){var n=ct.subarray(8*t,8*t+8);Ft.set(n,8*i)}));var xt=function(i){function n(r,e){void 0===e&&(e={});var s=i.call(this,r)||this;return s.format=t.FlipnoteFormat.KWZ,s.formatString="KWZ",s.width=n.width,s.height=n.height,s.numLayers=n.numLayers,s.rawSampleRate=n.rawSampleRate,s.sampleRate=n.sampleRate,s.globalPalette=n.globalPalette,s.prevFrameIndex=null,s.bitIndex=0,s.bitValue=0,s.settings=N(N({},n.defaultSettings),e),s.layers=[new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height)],s.bitIndex=0,s.bitValue=0,s.buildSectionMap(),s.settings.quickMeta?s.decodeMetaQuick():s.decodeMeta(),s.getFrameOffsets(),s.decodeSoundHeader(),s}return R(n,i),n.prototype.buildSectionMap=function(){this.seek(0),this.sections={};for(var t=this.byteLength-256,i=0,n=0;i<t&&n<6;){this.seek(i);var r=this.readChars(4).substring(0,3),e=this.readUint32();this.sections[r]={offset:i,length:e},i+=e+8,n+=1}},n.prototype.readBits=function(t){if(this.bitIndex+t>16){var i=this.readUint16();this.bitValue|=i<<16-this.bitIndex,this.bitIndex-=16}var n=this.bitValue&at[t];return this.bitValue>>=t,this.bitIndex+=t,n},n.prototype.decodeMeta=function(){this.seek(this.sections.KFH.offset+12);var t=new Date(1e3*(this.readUint32()+946684800)),i=new Date(1e3*(this.readUint32()+946684800)),n=(this.readUint32(),this.readHex(10)),r=this.readHex(10),e=this.readHex(10),s=this.readWideChars(11),o=this.readWideChars(11),h=this.readWideChars(11),u=this.readChars(28),a=this.readChars(28),f=this.readChars(28),c=this.readUint16(),l=this.readUint16(),v=this.readUint16(),y=this.readUint8(),p=this.readUint8();this.isSpinoff=e!==r||e!==n,this.frameCount=c,this.thumbFrameIndex=l,this.frameSpeed=y,this.framerate=ht[y],this.layerVisibility={1:0==(1&p),2:0==(2&p),3:0==(3&p)},this.meta={lock:0!=(1&v),loop:0!=(2&v),frameCount:c,frameSpeed:y,thumbIndex:l,timestamp:i,creationTimestamp:t,root:{username:s,fsid:n,filename:u},parent:{username:o,fsid:r,filename:a},current:{username:h,fsid:e,filename:f}}},n.prototype.decodeMetaQuick=function(){this.seek(this.sections.KFH.offset+8+196);var t=this.readUint16(),i=this.readUint16(),n=(this.readUint16(),this.readUint8());this.readUint8();this.frameCount=t,this.thumbFrameIndex=i,this.frameSpeed=n,this.framerate=ht[n]},n.prototype.getFrameOffsets=function(){for(var t=this.frameCount,i=this.sections.KMI,n=this.sections.KMC,r=new Uint32Array(t),e=new Uint32Array(t),s=[],o=i.offset+8,h=n.offset+12,u=0;u<t;u++){this.seek(o+4);var a=this.readUint16(),f=this.readUint16(),c=this.readUint16();r[u]=o,e[u]=h,o+=28,h+=a+f+c,s.push([a,f,c])}this.frameMetaOffsets=r,this.frameDataOffsets=e,this.frameLayerSizes=s},n.prototype.decodeSoundHeader=function(){var i;if(this.sections.hasOwnProperty("KSN")){var n=this.sections.KSN.offset+8;this.seek(n);var r=this.readUint32();this.bgmSpeed=r,this.bgmrate=ht[r];var e=new Uint32Array(this.buffer,n+4,20);this.soundMeta=((i={})[t.FlipnoteAudioTrack.BGM]={offset:n+=28,length:e[0]},i[t.FlipnoteAudioTrack.SE1]={offset:n+=e[0],length:e[1]},i[t.FlipnoteAudioTrack.SE2]={offset:n+=e[1],length:e[2]},i[t.FlipnoteAudioTrack.SE3]={offset:n+=e[2],length:e[3]},i[t.FlipnoteAudioTrack.SE4]={offset:n+=e[3],length:e[4]},i)}},n.prototype.getFramePaletteIndices=function(t){this.seek(this.frameMetaOffsets[t]);var i=this.readUint32();return[15&i,i>>8&15,i>>12&15,i>>16&15,i>>20&15,i>>24&15,i>>28&15]},n.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},n.prototype.getFrameDiffingFlag=function(t){return this.seek(this.frameMetaOffsets[t]),this.readUint32()>>4&7},n.prototype.getFrameLayerSizes=function(t){return this.seek(this.frameMetaOffsets[t]+4),[this.readUint16(),this.readUint16(),this.readUint16()]},n.prototype.getFrameLayerDepths=function(t){return this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]},n.prototype.getFrameAuthor=function(t){return this.seek(this.frameMetaOffsets[t]+10),this.readHex(10)},n.prototype.getFrameSoundFlags=function(t){this.seek(this.frameMetaOffsets[t]+23);var i=this.readUint8();return[0!=(1&i),0!=(2&i),0!=(4&i),0!=(8&i)]},n.prototype.getFrameCameraFlags=function(t){this.seek(this.frameMetaOffsets[t]+26);var i=this.readUint8();return[0!=(1&i),0!=(2&i),0!=(4&i)]},n.prototype.getFrameLayerOrder=function(t){var i=this.getFrameLayerDepths(t);return[2,1,0].sort((function(t,n){return i[n]-i[t]}))},n.prototype.decodeFrame=function(t,i,r){void 0===i&&(i=7),void 0===r&&(r=!1),this.prevFrameIndex!==t-1&&0!==t&&(r&&(i&=~this.getFrameDiffingFlag(t+1)),0!==i&&this.decodeFrame(t-1,i,!0));for(var e=this.frameDataOffsets[t],s=this.frameLayerSizes[t],o=0;o<3&&(!this.settings.dsiGalleryNote||3!==o);o++){this.seek(e);var h=s[o];if(e+=h,38!==h&&0!=(i>>o&1)){this.bitIndex=16,this.bitValue=0;for(var u=0,a=0;a<n.height;a+=128)for(var f=0;f<n.width;f+=128)for(var c=0;c<128;c+=8){var l=a+c;if(l>=n.height)break;for(var v=0;v<128;v+=8){var y=f+v;if(y>=n.width)break;if(u>0)u-=1;else{var p=l*n.width+y,d=this.layers[o],m=this.readBits(3);if(0==m){var w=this.readBits(5),b=At.subarray(8*w,8*w+8);d.set(b,p),d.set(b,p+320),d.set(b,p+640),d.set(b,p+960),d.set(b,p+1280),d.set(b,p+1600),d.set(b,p+1920),d.set(b,p+2240)}else if(1==m){w=this.readBits(13),b=ct.subarray(8*w,8*w+8);d.set(b,p),d.set(b,p+320),d.set(b,p+640),d.set(b,p+960),d.set(b,p+1280),d.set(b,p+1600),d.set(b,p+1920),d.set(b,p+2240)}else if(2==m){var g=this.readBits(5),_=At.subarray(8*g,8*g+8),A=Ft.subarray(8*g,8*g+8);d.set(_,p),d.set(A,p+320),d.set(_,p+640),d.set(A,p+960),d.set(_,p+1280),d.set(A,p+1600),d.set(_,p+1920),d.set(A,p+2240)}else if(3==m){g=this.readBits(13),_=ct.subarray(8*g,8*g+8),A=lt.subarray(8*g,8*g+8);d.set(_,p),d.set(A,p+320),d.set(_,p+640),d.set(A,p+960),d.set(_,p+1280),d.set(A,p+1600),d.set(_,p+1920),d.set(A,p+2240)}else if(4==m)for(var F=this.readBits(8),x=p,z=0;z<8;z++){if(0!=(1&F)){w=this.readBits(5),b=At.subarray(8*w,8*w+8);d.set(b,x)}else{w=this.readBits(13),b=ct.subarray(8*w,8*w+8);d.set(b,x)}F>>=1,x+=320}else{if(5==m){u=this.readBits(5);continue}if(7==m){var P=this.readBits(2);_=void 0,A=void 0;if(0!==this.readBits(1)){var S=this.readBits(5),C=this.readBits(5);_=At.subarray(8*S,8*S+8),A=At.subarray(8*C,8*C+8),P=(P+1)%4}else{S=this.readBits(13),C=this.readBits(13);_=ct.subarray(8*S,8*S+8),A=ct.subarray(8*C,8*C+8)}0==P?(d.set(_,p),d.set(A,p+320),d.set(_,p+640),d.set(A,p+960),d.set(_,p+1280),d.set(A,p+1600),d.set(_,p+1920),d.set(A,p+2240)):1==P?(d.set(_,p),d.set(_,p+320),d.set(A,p+640),d.set(_,p+960),d.set(_,p+1280),d.set(A,p+1600),d.set(_,p+1920),d.set(_,p+2240)):2==P?(d.set(_,p),d.set(A,p+320),d.set(_,p+640),d.set(_,p+960),d.set(A,p+1280),d.set(_,p+1600),d.set(_,p+1920),d.set(A,p+2240)):3==P&&(d.set(_,p),d.set(A,p+320),d.set(A,p+640),d.set(_,p+960),d.set(A,p+1280),d.set(A,p+1600),d.set(_,p+1920),d.set(A,p+2240))}}}}}}}return this.prevFrameIndex=t,this.layers},n.prototype.getLayerPixels=function(t,i){this.prevFrameIndex!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),e=this.layers[i],s=new Uint8Array(n.width*n.height),o=2*i+1,h=0;h<e.length;h++){var u=e[h];1===u?s[h]=r[o]:2===u&&(s[h]=r[o+1])}return s},n.prototype.getFramePixels=function(t){this.prevFrameIndex!==t&&this.decodeFrame(t);var i=this.getFramePaletteIndices(t),r=this.getFrameLayerOrder(t),e=this.layers[r[2]],s=this.layers[r[1]],o=this.layers[r[0]],h=2*r[2],u=2*r[1],a=2*r[0];if(this.settings.dsiGalleryNote){var f;(f=new Uint8Array(n.width*n.height)).fill(i[0]);for(var c=n.width-64,l=n.height-48,v=n.width,y=32;y<l;y++)for(var p=y*v,d=24;d<c;d++){w=e[p],b=s[p];0!==w?f[p]=i[h+w]:0!==b&&(f[p]=i[u+b]),p+=1}return f}(f=new Uint8Array(n.width*n.height)).fill(i[0]);for(var m=0;m<f.length;m++){var w=e[m],b=s[m],g=o[m];0!==w?f[m]=i[h+w]:0!==b?f[m]=i[u+b]:0!==g&&(f[m]=i[a+g])}return f},n.prototype.decodeSoundFlags=function(){for(var t=[],i=0;i<this.frameCount;i++)t.push(this.getFrameSoundFlags(i));return t},n.prototype.getAudioTrackRaw=function(t){var i=this.soundMeta[t];return new Uint8Array(this.buffer,i.offset,i.length)},n.prototype.decodeAudioTrack=function(t){var i=this.getAudioTrackRaw(t),n=new Int16Array(981840),r=0,e=0,s=0,o=0,h=0,u=0;this.settings.originalAudioSettings&&(s=40);for(var a=0;a<i.length;a++)for(var f=i[a],c=0;c<8;)s<18||c>4?(o=3&f,u=(h=nt[s])>>3,1&o&&(u+=h),2&o&&(u=-u),e+=u,s+=tt[o],f>>=2,c+=2):(o=15&f,u=(h=nt[s])>>3,1&o&&(u+=h>>2),2&o&&(u+=h>>1),4&o&&(u+=h),8&o&&(u=-u),e+=u,s+=it[o],f>>=4,c+=4),s=X(s,0,79),e=X(e,-2048,2047),n[r]=16*e,r+=1;return n.slice(0,r)},n.prototype.getAudioTrackPcm=function(i,n){void 0===n&&(n=this.sampleRate);var r=this.decodeAudioTrack(i),e=this.rawSampleRate;if(i===t.FlipnoteAudioTrack.BGM){var s=1/this.bgmrate/(1/this.framerate);e=this.rawSampleRate*s}return e!==n?Q(r,e,n):r},n.prototype.pcmAudioMix=function(t,i,n){void 0===n&&(n=0);for(var r=t.length,e=i.length,s=0;s<r&&!(n+s>e);s++){var o=i[n+s]+t[s];i[n+s]=X(o,-32768,32767)}},n.prototype.getAudioMasterPcm=function(i){void 0===i&&(i=this.sampleRate);var n=this.frameCount*(1/this.framerate),r=Math.ceil(n*i),e=new Int16Array(r),s=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),h=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),u=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(s){var f=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,i);this.pcmAudioMix(f,e,0)}if(o||h||u)for(var c=i/this.framerate,l=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,i):null,v=h?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,i):null,y=u?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,i):null,p=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,i):null,d=0;d<this.frameCount;d++){var m=this.getFrameSoundFlags(d),w=Math.ceil(d*c);o&&m[0]&&this.pcmAudioMix(l,e,w),h&&m[1]&&this.pcmAudioMix(v,e,w),u&&m[2]&&this.pcmAudioMix(y,e,w),a&&m[3]&&this.pcmAudioMix(p,e,w)}return this.audioClipRatio=rt(e),e},n.defaultSettings={quickMeta:!1,dsiGalleryNote:!1,originalAudioSettings:!1},n.format=t.FlipnoteFormat.KWZ,n.width=320,n.height=240,n.numLayers=3,n.rawSampleRate=16364,n.sampleRate=16364,n.globalPalette=[ut.WHITE,ut.BLACK,ut.RED,ut.YELLOW,ut.GREEN,ut.BLUE,ut.NONE],n}(Z);function zt(t,i){return function(t){return new Promise((function(i,n){for(var r=0;r<J.length;r++){var e=J[r];if(e.matches(t))return void e.load(t,i,n)}n("No loader available for source type")}))}(t).then((function(t){return new Promise((function(n,r){var e=new Uint8Array(t.slice(0,4)),s=e[0]<<24|e[1]<<16|e[2]<<8|e[3];1346458177===s?n(new ot(t,i)):1262897152==(4294967040&s)?n(new xt(t,i)):r()}))}))}var Pt=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],St=function(){function t(t,i,n){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=i,this.colorDepth=n,this.reset()}return t.prototype.reset=function(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0},t.prototype.char_out=function(t,i){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(i)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var i=0;i<t;++i)this.htab[i]=-1},t.prototype.compress=function(t,i){var n,r,e,s,o,h;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,s=this.nextPixel(),h=0,n=5003;n<65536;n*=2)++h;h=8-h,this.cl_hash(5003),this.output(this.ClearCode,i);t:for(;-1!=(r=this.nextPixel());)if(n=(r<<12)+s,e=r<<h^s,this.htab[e]!==n){if(this.htab[e]>=0){o=5003-e,0===e&&(o=1);do{if((e-=o)<0&&(e+=5003),this.htab[e]===n){s=this.codetab[e];continue t}}while(this.htab[e]>=0)}this.output(s,i),s=r,this.free_ent<4096?(this.codetab[e]=this.free_ent++,this.htab[e]=n):this.cl_block(i)}else s=this.codetab[e];this.output(s,i),this.output(this.EOFCode,i)},t.prototype.encode=function(t,i){this.pixels=t,i.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,i),i.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,i){for(this.cur_accum&=Pt[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(i)}},t}(),Ct=function(){function t(i,n,r){void 0===r&&(r={}),this.frameCount=0,this.dataUrl=null,this.width=i,this.height=n,this.data=new H,this.settings=N(N({},t.defaultSettings),r),this.compressor=new St(i,n,r.colorDepth)}return t.fromFlipnote=function(i,n){void 0===n&&(n={});var r=new t(i.width,i.height,N({delay:100/i.framerate,repeat:i.meta.loop?-1:0},n));r.palette=i.globalPalette;for(var e=0;e<i.frameCount;e++)r.writeFrame(i.getFramePixels(e));return r},t.fromFlipnoteFrame=function(i,n,r){void 0===r&&(r={});var e=new t(i.width,i.height,N({delay:100/i.framerate,repeat:-1},r));return e.palette=i.globalPalette,e.writeFrame(i.getFramePixels(n)),e},t.prototype.writeFrame=function(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1},t.prototype.writeFirstFrame=function(t){for(var i=this.palette.length,n=1;1<<n<i;n+=1)continue;this.settings.colorDepth=n,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt(),this.writeFrameHeader(),this.writePixels(t)},t.prototype.writeAdditionalFrame=function(t){this.writeFrameHeader(),this.writePixels(t)},t.prototype.writeHeader=function(){var t=new V(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.settings.colorDepth-1),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.settings.colorDepth)),i=0,n=0;n<this.palette.length;n+=1){var r=this.palette[n],e=r[0],s=r[1],o=r[2];r[3];t[i++]=e,t[i++]=s,t[i++]=o}this.data.writeBytes(t)},t.prototype.writeNetscapeExt=function(){var t=new V(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.settings.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeFrameHeader=function(){var t=new V(new ArrayBuffer(18)),i=this.settings.transparentBg?1:0;t.writeBytes([33,249,4,0|i]),t.writeUint16(this.settings.delay),t.writeBytes([0,0]),t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writePixels=function(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)},t.prototype.getArrayBuffer=function(){return this.data.getBuffer()},t.prototype.getBuffer=function(){if(K)return Buffer.from(this.getArrayBuffer());throw new Error("The Buffer object only available in NodeJS environments")},t.prototype.getBlob=function(){if(q)return new Blob([this.getArrayBuffer()],{type:"image/gif"});throw new Error("The Blob object is only available in browser environments")},t.prototype.getUrl=function(){if(q)return this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob());throw new Error("Data URLs are only available in browser environments")},t.prototype.revokeUrl=function(){if(!q)throw new Error("Data URLs are only available in browser environments");this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)},t.prototype.getImage=function(){if(q){var t=new Image(this.width,this.height);return t.src=this.getUrl(),t}throw new Error("Image objects are only available in browser environments")},t.defaultSettings={transparentBg:!1,delay:100,repeat:-1,colorDepth:8},t}(),Tt=function(){function t(t,i,n){void 0===i&&(i=1),void 0===n&&(n=16),this.sampleRate=t,this.channels=i,this.bitsPerSample=n;var r=new ArrayBuffer(44),e=new V(r);e.writeChars("RIFF"),e.writeUint32(0),e.writeChars("WAVE"),e.writeChars("fmt "),e.writeUint32(16),e.writeUint16(1),e.writeUint16(this.channels),e.writeUint32(this.sampleRate),e.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),e.writeUint16(this.bitsPerSample*this.channels/8),e.writeUint16(this.bitsPerSample),e.writeChars("data"),e.writeUint32(0),this.header=e,this.pcmData=null}return t.fromFlipnote=function(i){var n=i.sampleRate,r=new t(n,1,16),e=i.getAudioMasterPcm(n);return r.writeFrames(e),r},t.fromFlipnoteTrack=function(i,n){var r=i.sampleRate,e=new t(r,1,16),s=i.getAudioTrackPcm(n,r);return e.writeFrames(s),e},t.prototype.writeFrames=function(t){var i=this.header;i.seek(4),i.writeUint32(i.byteLength+t.byteLength),i.seek(40),i.writeUint32(t.byteLength),this.pcmData=t},t.prototype.getArrayBuffer=function(){var t=this.header.bytes,i=new Uint8Array(this.pcmData.buffer),n=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return n.set(t),n.set(i,t.byteLength),n.buffer},t.prototype.getBuffer=function(){if(K)return Buffer.from(this.getArrayBuffer());throw new Error("The Buffer object is only available in NodeJS environments")},t.prototype.getBlob=function(){if(q){var t=this.getArrayBuffer();return new Blob([t],{type:"audio/wav"})}throw new Error("The Blob object is only available in browser environments")},t}();function Ut(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const kt="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function Et(t,i){return"undefined"!=typeof WebGLTexture&&i instanceof WebGLTexture}const Bt="";function It(t,i,n,r){if(e=i,"undefined"!=typeof WebGLBuffer&&e instanceof WebGLBuffer)return i;var e;n=n||34962;const s=t.createBuffer();return function(t,i,n,r,e){t.bindBuffer(i,n),t.bufferData(i,r,e||35044)}(t,n,s,i,r),s}function Ot(t){return"indices"===t}const Mt=/coord|texture/i,Lt=/color|colour/i;function jt(t,i){let n;if(n=Mt.test(t)?2:Lt.test(t)?4:3,i%n>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${n} but ${i} values is not evenly divisible by ${n}. You should specify it.`);return n}function Dt(t,i){if(kt(t))return t;if(kt(t.data))return t.data;Array.isArray(t)&&(t={data:t});let n=t.type;return n||(n=Ot(i)?Uint16Array:Float32Array),new n(t.data)}function Rt(t,i){const n={};return Object.keys(i).forEach((function(r){if(!Ot(r)){const s=i[r],o=s.attrib||s.name||s.attribName||Bt+r;if(s.value){if(!Array.isArray(s.value)&&!kt(s.value))throw new Error("array.value is not array or typedarray");n[o]={value:s.value}}else{let i,h,u,a;if(s.buffer&&s.buffer instanceof WebGLBuffer)i=s.buffer,a=s.numComponents||s.size,h=s.type,u=s.normalize;else if("number"==typeof s||"number"==typeof s.data){const n=s.data||s,o=s.type||Float32Array,f=n*o.BYTES_PER_ELEMENT;h=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(o),u=void 0!==s.normalize?s.normalize:(e=o)===Int8Array||e===Uint8Array,a=s.numComponents||s.size||jt(r,n),i=t.createBuffer(),t.bindBuffer(34962,i),t.bufferData(34962,f,s.drawType||35044)}else{const n=Dt(s,r);i=It(t,n,void 0,s.drawType),h=Ut(n),u=void 0!==s.normalize?s.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(n),a=function(t,i){return t.numComponents||t.size||jt(i,function(t){return t.length?t:t.data}(t).length)}(s,r)}n[o]={buffer:i,numComponents:a,type:h,normalize:u,stride:s.stride||0,offset:s.offset||0,divisor:void 0===s.divisor?void 0:s.divisor,drawType:s.drawType}}}var e})),t.bindBuffer(34962,null),n}const Nt=["position","positions","a_position"];function Gt(t,i,n){const r=Rt(t,i),e=Object.assign({},n||{});e.attribs=Object.assign({},n?n.attribs:{},r);const s=i.indices;if(s){const i=Dt(s,"indices");e.indices=It(t,i,34963),e.numElements=i.length,e.elementType=Ut(i)}else e.numElements||(e.numElements=function(t,i){let n,r;for(r=0;r<Nt.length&&(n=Nt[r],!(n in i))&&(n=Bt+n,!(n in i));++r);r===Nt.length&&(n=Object.keys(i)[0]);const e=i[n];t.bindBuffer(34962,e.buffer);const s=t.getBufferParameter(34962,34660);var o;t.bindBuffer(34962,null);const h=s/(5120===(o=e.type)||5121===o?1:5122===o||5123===o?2:5124===o||5125===o||5126===o?4:0),u=e.numComponents||e.size,a=h/u;if(a%1!=0)throw new Error(`numComponents ${u} not correct for length ${length}`);return a}(t,e.attribs));return e}function Wt(t){return!!t.texStorage2D}const $t={};function Yt(t,i){return $t[i].bindPoint}function Ht(t,i){return function(n){t.uniform1i(i,n)}}function Vt(t,i){return function(n){t.uniform1iv(i,n)}}function qt(t,i){return function(n){t.uniform2iv(i,n)}}function Kt(t,i){return function(n){t.uniform3iv(i,n)}}function Zt(t,i){return function(n){t.uniform4iv(i,n)}}function Jt(t,i,n,r){const e=Yt(0,i);return Wt(t)?function(i){let s,o;Et(0,i)?(s=i,o=null):(s=i.texture,o=i.sampler),t.uniform1i(r,n),t.activeTexture(33984+n),t.bindTexture(e,s),t.bindSampler(n,o)}:function(i){t.uniform1i(r,n),t.activeTexture(33984+n),t.bindTexture(e,i)}}function Xt(t,i,n,r,e){const s=Yt(0,i),o=new Int32Array(e);for(let t=0;t<e;++t)o[t]=n+t;return Wt(t)?function(i){t.uniform1iv(r,o),i.forEach((function(i,r){let e,h;t.activeTexture(33984+o[r]),Et(0,i)?(e=i,h=null):(e=i.texture,h=i.sampler),t.bindSampler(n,h),t.bindTexture(s,e)}))}:function(i){t.uniform1iv(r,o),i.forEach((function(i,n){t.activeTexture(33984+o[n]),t.bindTexture(s,i)}))}}function Qt(t,i){return function(n){if(n.value)switch(t.disableVertexAttribArray(i),n.value.length){case 4:t.vertexAttrib4fv(i,n.value);break;case 3:t.vertexAttrib3fv(i,n.value);break;case 2:t.vertexAttrib2fv(i,n.value);break;case 1:t.vertexAttrib1fv(i,n.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,n.buffer),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,n.numComponents||n.size,n.type||5126,n.normalize||!1,n.stride||0,n.offset||0),void 0!==n.divisor&&t.vertexAttribDivisor(i,n.divisor)}}function ti(t,i){return function(n){if(n.value){if(t.disableVertexAttribArray(i),4!==n.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(i,n.value)}else t.bindBuffer(34962,n.buffer),t.enableVertexAttribArray(i),t.vertexAttribIPointer(i,n.numComponents||n.size,n.type||5124,n.stride||0,n.offset||0),void 0!==n.divisor&&t.vertexAttribDivisor(i,n.divisor)}}function ii(t,i){return function(n){if(n.value){if(t.disableVertexAttribArray(i),4!==n.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(i,n.value)}else t.bindBuffer(34962,n.buffer),t.enableVertexAttribArray(i),t.vertexAttribIPointer(i,n.numComponents||n.size,n.type||5125,n.stride||0,n.offset||0),void 0!==n.divisor&&t.vertexAttribDivisor(i,n.divisor)}}function ni(t,i,n){const r=n.size,e=n.count;return function(n){t.bindBuffer(34962,n.buffer);const s=n.size||n.numComponents||r,o=s/e,h=n.type||5126,u=$t[h].size*s,a=n.normalize||!1,f=n.offset||0,c=u/e;for(let r=0;r<e;++r)t.enableVertexAttribArray(i+r),t.vertexAttribPointer(i+r,o,h,a,u,f+c*r),void 0!==n.divisor&&t.vertexAttribDivisor(i+r,n.divisor)}}$t[5126]={Type:Float32Array,size:4,setter:function(t,i){return function(n){t.uniform1f(i,n)}},arraySetter:function(t,i){return function(n){t.uniform1fv(i,n)}}},$t[35664]={Type:Float32Array,size:8,setter:function(t,i){return function(n){t.uniform2fv(i,n)}}},$t[35665]={Type:Float32Array,size:12,setter:function(t,i){return function(n){t.uniform3fv(i,n)}}},$t[35666]={Type:Float32Array,size:16,setter:function(t,i){return function(n){t.uniform4fv(i,n)}}},$t[5124]={Type:Int32Array,size:4,setter:Ht,arraySetter:Vt},$t[35667]={Type:Int32Array,size:8,setter:qt},$t[35668]={Type:Int32Array,size:12,setter:Kt},$t[35669]={Type:Int32Array,size:16,setter:Zt},$t[5125]={Type:Uint32Array,size:4,setter:function(t,i){return function(n){t.uniform1ui(i,n)}},arraySetter:function(t,i){return function(n){t.uniform1uiv(i,n)}}},$t[36294]={Type:Uint32Array,size:8,setter:function(t,i){return function(n){t.uniform2uiv(i,n)}}},$t[36295]={Type:Uint32Array,size:12,setter:function(t,i){return function(n){t.uniform3uiv(i,n)}}},$t[36296]={Type:Uint32Array,size:16,setter:function(t,i){return function(n){t.uniform4uiv(i,n)}}},$t[35670]={Type:Uint32Array,size:4,setter:Ht,arraySetter:Vt},$t[35671]={Type:Uint32Array,size:8,setter:qt},$t[35672]={Type:Uint32Array,size:12,setter:Kt},$t[35673]={Type:Uint32Array,size:16,setter:Zt},$t[35674]={Type:Float32Array,size:16,setter:function(t,i){return function(n){t.uniformMatrix2fv(i,!1,n)}}},$t[35675]={Type:Float32Array,size:36,setter:function(t,i){return function(n){t.uniformMatrix3fv(i,!1,n)}}},$t[35676]={Type:Float32Array,size:64,setter:function(t,i){return function(n){t.uniformMatrix4fv(i,!1,n)}}},$t[35685]={Type:Float32Array,size:24,setter:function(t,i){return function(n){t.uniformMatrix2x3fv(i,!1,n)}}},$t[35686]={Type:Float32Array,size:32,setter:function(t,i){return function(n){t.uniformMatrix2x4fv(i,!1,n)}}},$t[35687]={Type:Float32Array,size:24,setter:function(t,i){return function(n){t.uniformMatrix3x2fv(i,!1,n)}}},$t[35688]={Type:Float32Array,size:48,setter:function(t,i){return function(n){t.uniformMatrix3x4fv(i,!1,n)}}},$t[35689]={Type:Float32Array,size:32,setter:function(t,i){return function(n){t.uniformMatrix4x2fv(i,!1,n)}}},$t[35690]={Type:Float32Array,size:48,setter:function(t,i){return function(n){t.uniformMatrix4x3fv(i,!1,n)}}},$t[35678]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:3553},$t[35680]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:34067},$t[35679]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:32879},$t[35682]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:3553},$t[36289]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:35866},$t[36292]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:35866},$t[36293]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:34067},$t[36298]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:3553},$t[36299]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:32879},$t[36300]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:34067},$t[36303]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:35866},$t[36306]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:3553},$t[36307]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:32879},$t[36308]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:34067},$t[36311]={Type:null,size:0,setter:Jt,arraySetter:Xt,bindPoint:35866};const ri={};function ei(t){const i=t.name;return i.startsWith("gl_")||i.startsWith("webgl_")}function si(t,i){const n=t.uniformSetters||t,r=arguments.length;for(let t=1;t<r;++t){const i=arguments[t];if(Array.isArray(i)){const t=i.length;for(let r=0;r<t;++r)si(n,i[r])}else for(const t in i){const r=n[t];r&&r(i[t])}}}function oi(t,i){const n={program:i,uniformSetters:function(t,i){let n=0;function r(i,r,e){const s=r.size>1&&"[0]"===r.name.substr(-3),o=r.type,h=$t[o];if(!h)throw new Error("unknown type: 0x"+o.toString(16));let u;if(h.bindPoint){const i=n;n+=r.size,u=s?h.arraySetter(t,o,i,e,r.size):h.setter(t,o,i,e,r.size)}else u=h.arraySetter&&s?h.arraySetter(t,e):h.setter(t,e);return u.location=e,u}const e={},s=t.getProgramParameter(i,35718);for(let n=0;n<s;++n){const s=t.getActiveUniform(i,n);if(ei(s))continue;let o=s.name;"[0]"===o.substr(-3)&&(o=o.substr(0,o.length-3));const h=t.getUniformLocation(i,s.name);h&&(e[o]=r(0,s,h))}return e}(t,i),attribSetters:function(t,i){const n={},r=t.getProgramParameter(i,35721);for(let e=0;e<r;++e){const r=t.getActiveAttrib(i,e);if(ei(r))continue;const s=t.getAttribLocation(i,r.name),o=ri[r.type],h=o.setter(t,s,o);h.location=s,n[r.name]=h}return n}(t,i)};return Wt(t)&&(n.uniformBlockSpec=function(t,i){const n=t.getProgramParameter(i,35718),r=[],e=[];for(let s=0;s<n;++s){e.push(s),r.push({});const n=t.getActiveUniform(i,s);if(ei(n))break;r[s].name=n.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(n){const s=n[0],o=n[1];t.getActiveUniforms(i,e,t[s]).forEach((function(t,i){r[i][o]=t}))}));const s={},o=t.getProgramParameter(i,35382);for(let n=0;n<o;++n){const r=t.getActiveUniformBlockName(i,n),e={index:t.getUniformBlockIndex(i,r),usedByVertexShader:t.getActiveUniformBlockParameter(i,n,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(i,n,35398),size:t.getActiveUniformBlockParameter(i,n,35392),uniformIndices:t.getActiveUniformBlockParameter(i,n,35395)};e.used=e.usedByVertexShader||e.usedByFragmentShader,s[r]=e}return{blockSpecs:s,uniformData:r}}(t,i),n.transformFeedbackInfo=function(t,i){const n={},r=t.getProgramParameter(i,35971);for(let e=0;e<r;++e){const r=t.getTransformFeedbackVarying(i,e);n[r.name]={index:e,type:r.type,size:r.size}}return n}(t,i)),n}ri[5126]={size:4,setter:Qt},ri[35664]={size:8,setter:Qt},ri[35665]={size:12,setter:Qt},ri[35666]={size:16,setter:Qt},ri[5124]={size:4,setter:ti},ri[35667]={size:8,setter:ti},ri[35668]={size:12,setter:ti},ri[35669]={size:16,setter:ti},ri[5125]={size:4,setter:ii},ri[36294]={size:8,setter:ii},ri[36295]={size:12,setter:ii},ri[36296]={size:16,setter:ii},ri[35670]={size:4,setter:ti},ri[35671]={size:8,setter:ti},ri[35672]={size:12,setter:ti},ri[35673]={size:16,setter:ti},ri[35674]={size:4,setter:ni,count:2},ri[35675]={size:9,setter:ni,count:3},ri[35676]={size:16,setter:ni,count:4};var hi="#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}",ui=function(){function t(t,i,n){if(void 0===i&&(i=640),void 0===n&&(n=480),this.refs={programs:[],shaders:[],textures:[],buffers:[],framebuffers:[]},!q)throw new Error("The WebGL renderer is only available in browser environments");var r=t.getContext("webgl",{antialias:!1,alpha:!0});this.el=t,this.gl=r,this.layerDrawProgram=this.createProgram(hi,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_palette;uniform sampler2D u_bitmap;uniform float u_paletteOffset;const vec4 transparent=vec4(0,0,0,0);void main(){float index=texture2D(u_bitmap,v_uv).a*255.;if(index>0.){gl_FragColor=texture2D(u_palette,vec2((u_paletteOffset+index)/255.,.5));}else{gl_FragColor=transparent;}}"),this.postProcessProgram=this.createProgram(hi,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,8,8),this.setBuffersAndAttribs(this.layerDrawProgram,this.quadBuffer),this.setBuffersAndAttribs(this.postProcessProgram,this.quadBuffer),this.paletteTexture=this.createTexture(r.RGBA,r.NEAREST,r.CLAMP_TO_EDGE,256,1),this.layerTexture=this.createTexture(r.ALPHA,r.NEAREST,r.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(r.RGBA,r.LINEAR,r.CLAMP_TO_EDGE),this.frameBuffer=this.createFrameBuffer(this.frameTexture),this.setCanvasSize(i,n)}return t.prototype.createProgram=function(t,i){var n=this.gl,r=this.createShader(n.VERTEX_SHADER,t),e=this.createShader(n.FRAGMENT_SHADER,i),s=n.createProgram();if(n.attachShader(s,r),n.attachShader(s,e),n.linkProgram(s),!n.getProgramParameter(s,n.LINK_STATUS)){var o=n.getProgramInfoLog(s);throw n.deleteProgram(s),new Error(o)}var h=oi(n,s);return this.refs.programs.push(s),h},t.prototype.createShader=function(t,i){var n=this.gl,r=n.createShader(t);if(n.shaderSource(r,i),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){var e=n.getShaderInfoLog(r);throw n.deleteShader(r),new Error(e)}return this.refs.shaders.push(r),r},t.prototype.createScreenQuad=function(t,i,n,r,e,s){for(var o=(e+1)*(s+1),h=e+1,u=new Float32Array(2*o),a=new Float32Array(2*o),f=0,c=0,l=0;l<=s;l++)for(var v=0;v<=e;v++){var y=v/e,p=l/s;u[f++]=t+n*y,u[f++]=i+r*p,a[c++]=y,a[c++]=p}var d=new Uint16Array(e*s*2*3),m=0;for(l=0;l<s;l++)for(v=0;v<e;v++)d[m++]=(l+0)*h+v,d[m++]=(l+1)*h+v,d[m++]=(l+0)*h+v+1,d[m++]=(l+0)*h+v+1,d[m++]=(l+1)*h+v,d[m++]=(l+1)*h+v+1;var w=Gt(this.gl,{position:{numComponents:2,data:u},texcoord:{numComponents:2,data:a},indices:d});for(var b in w.attribs)this.refs.buffers.push(w.attribs[b].buffer);return w},t.prototype.setBuffersAndAttribs=function(t,i){var n=this.gl;!function(t,i){for(const n in i){const r=t[n];r&&r(i[n])}}(t.attribSetters,i.attribs),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i.indices)},t.prototype.createTexture=function(t,i,n,r,e){void 0===r&&(r=1),void 0===e&&(e=1);var s=this.gl,o=s.createTexture();return s.bindTexture(s.TEXTURE_2D,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,i),s.texImage2D(s.TEXTURE_2D,0,t,r,e,0,t,s.UNSIGNED_BYTE,null),this.refs.textures.push(o),o},t.prototype.createFrameBuffer=function(t){var i=this.gl,n=i.createFramebuffer();return i.bindFramebuffer(i.FRAMEBUFFER,n),i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0),this.refs.framebuffers.push(n),n},t.prototype.setCanvasSize=function(t,i){var n=window.devicePixelRatio||1,r=t*n,e=i*n;this.el.width=r,this.el.height=e,this.screenWidth=r,this.screenHeight=e,this.el.style.width=t+"px",this.el.style.height=i+"px"},t.prototype.setInputSize=function(t,i){var n=this.gl;this.textureWidth=t,this.textureHeight=i,n.bindTexture(n.TEXTURE_2D,this.frameTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.textureWidth,this.textureHeight,0,n.RGBA,n.UNSIGNED_BYTE,null)},t.prototype.clearFrameBuffer=function(t){var i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.viewport(0,0,this.textureWidth,this.textureHeight);var n=t[0],r=t[1],e=t[2],s=t[3];i.clearColor(n/255,r/255,e/255,s/255),i.clear(i.COLOR_BUFFER_BIT)},t.prototype.setPalette=function(t){for(var i=this.gl,n=new Uint8Array(1024),r=0,e=0;e<t.length;e++){var s=t[e],o=s[0],h=s[1],u=s[2],a=s[3];n[r++]=o,n[r++]=h,n[r++]=u,n[r++]=a}i.bindTexture(i.TEXTURE_2D,this.paletteTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,256,1,0,i.RGBA,i.UNSIGNED_BYTE,n)},t.prototype.drawPixels=function(t,i){var n=this,r=n.gl,e=n.layerDrawProgram,s=n.layerTexture,o=n.textureWidth,h=n.textureHeight;r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer),r.viewport(0,0,o,h),r.useProgram(e.program),r.bindTexture(r.TEXTURE_2D,s),r.texImage2D(r.TEXTURE_2D,0,r.ALPHA,o,h,0,r.ALPHA,r.UNSIGNED_BYTE,t),si(e,{u_palette:this.paletteTexture,u_paletteOffset:i,u_bitmap:s,u_textureSize:[o,h],u_screenSize:[r.drawingBufferWidth,r.drawingBufferHeight]}),r.drawElements(r.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.composite=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.useProgram(this.postProcessProgram.program),t.clear(t.COLOR_BUFFER_BIT),si(this.postProcessProgram,{u_flipY:!0,u_tex:this.frameTexture,u_textureSize:[this.textureWidth,this.textureHeight],u_screenSize:[t.drawingBufferWidth,t.drawingBufferHeight]}),t.drawElements(t.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.resize=function(t,i){void 0===t&&(t=640),void 0===i&&(i=480),this.setCanvasSize(t,i)},t.prototype.destroy=function(){var t=this.refs,i=this.gl;t.shaders.forEach((function(t){i.deleteShader(t)})),t.shaders=[],t.framebuffers.forEach((function(t){i.deleteFramebuffer(t)})),t.framebuffers=[],t.textures.forEach((function(t){i.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){i.deleteBuffer(t)})),t.buffers=[],t.programs.forEach((function(t){i.deleteProgram(t)})),t.programs=[],i.canvas.width=1,i.canvas.height=1},t}(),ai=q?window.AudioContext||window.webkitAudioContext:null,fi=function(){function t(){if(this.useEq=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this.t=1,!q)throw new Error("The WebAudio player is only available in browser environments");this.ctx=new ai}return Object.defineProperty(t.prototype,"volume",{get:function(){return this.t},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),t.prototype.setBuffer=function(t,i){var n=t.length,r=this.ctx.createBuffer(1,n,i),e=r.getChannelData(0);if(t instanceof Float32Array)e.set(t,0);else if(t instanceof Int16Array)for(var s=0;s<n;s++)e[s]=t[s]/32767;this.buffer=r,this.sampleRate=i},t.prototype.connectEqNodesTo=function(t){var i=this.ctx,n=this.eqSettings,r=t;return n.forEach((function(t,e){var s=t[0],o=t[1],h=i.createBiquadFilter();h.frequency.value=s,h.gain.value=o,0===e?h.type="lowshelf":e===n.length-1?h.type="highshelf":h.type="peaking",r.connect(h),r=h})),r},t.prototype.initNodes=function(){var t=this.ctx,i=t.createBufferSource();i.buffer=this.buffer;var n=t.createGain();this.useEq?this.connectEqNodesTo(i).connect(n):i.connect(n);i.connect(n),n.connect(t.destination),this.source=i,this.gainNode=n,this.setVolume(this.t)},t.prototype.setVolume=function(t){this.t=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))},t.prototype.playFrom=function(t){this.initNodes(),this.source.start(0,t)},t.prototype.stop=function(){this.source.stop(0)},t}(),ci=function(){if(!q)return function(){};var t=document.createElement("a");return function(i,n){var r=window.URL.createObjectURL(i);t.href=r,t.download=n,t.click(),window.URL.revokeObjectURL(r)}}(),li=function(){function i(t,n,r){this.loop=!1,this.paused=!0,this.duration=0,this.isOpen=!1,this.events={},this.s=-1,this.h=-1,this.u=-1,this.hasPlaybackStarted=!1,this.wasPlaying=!1,this.isSeeking=!1,t="string"==typeof t?document.querySelector(t):t,this.canvas=new ui(t,n,r),this.audio=new fi,this.el=this.canvas.el,this.customPalette=null,this.state=N({},i.defaultState)}return Object.defineProperty(i.prototype,"currentFrame",{get:function(){return this.h},set:function(t){this.setFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"currentTime",{get:function(){return this.isOpen?this.u:null},set:function(t){this.isOpen&&t<=this.duration&&t>=0&&(this.setFrame(Math.round(t/(1/this.framerate))),this.u=t,this.emit("progress",this.progress))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"progress",{get:function(){return this.isOpen?this.u/this.duration*100:0},set:function(t){this.currentTime=this.duration*(t/100)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"volume",{get:function(){return this.audio.volume},set:function(t){this.audio.volume=t},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"muted",{get:function(){return!1},set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),i.prototype.setState=function(t){t=N(N({},this.state),t);this.state;this.emit("state:change")},i.prototype.open=function(t){return G(this,void 0,void 0,(function(){var i=this;return W(this,(function(n){return this.isOpen&&this.close(),[2,zt(t).then((function(t){return i.load(t)})).catch((function(t){throw i.emit("error",t),console.error("Error loading Flipnote:",t),"Error loading Flipnote"}))]}))}))},i.prototype.close=function(){this.pause(),this.note=null,this.isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.h=null,this.u=null,this.duration=null,this.loop=null,this.hasPlaybackStarted=null},i.prototype.load=function(t){this.note=t,this.meta=t.meta,this.noteFormat=t.format,this.noteFormatString=t.formatString,this.loop=t.meta.loop,this.duration=this.note.frameCount*(1/this.note.framerate),this.paused=!0,this.isOpen=!0,this.hasPlaybackStarted=!1,this.layerVisibility=this.note.layerVisibility;var i=this.note.sampleRate,n=t.getAudioMasterPcm();this.audio.setBuffer(n,i),this.canvas.setInputSize(t.width,t.height),this.setFrame(this.note.thumbFrameIndex),this.u=0,this.emit("load")},i.prototype.playAudio=function(){this.audio.playFrom(this.currentTime)},i.prototype.stopAudio=function(){this.audio.stop()},i.prototype.toggleEq=function(){this.stopAudio(),this.audio.useEq=!this.audio.useEq,this.playAudio()},i.prototype.toggleMute=function(){this.muted=!this.muted},i.prototype.playbackLoop=function(t){if(this.paused)return this.stopAudio(),null;var i=t/1e3,n=i-this.s;n>this.duration?this.loop?(this.currentTime=0,this.playAudio(),this.s=i,this.emit("playback:loop")):(this.pause(),this.emit("playback:end")):this.currentTime=n,requestAnimationFrame(this.playbackLoop.bind(this))},i.prototype.play=function(){if(window.__activeFlipnotePlayer=this,!this.isOpen||!this.paused)return null;this.hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.u=0),this.paused=!1,this.hasPlaybackStarted=!0,this.s=performance.now()/1e3-this.currentTime,this.playAudio(),requestAnimationFrame(this.playbackLoop.bind(this)),this.emit("playback:start")},i.prototype.pause=function(){if(!this.isOpen||this.paused)return null;this.paused=!0,this.stopAudio(),this.emit("playback:stop")},i.prototype.togglePlay=function(){this.paused?this.play():this.pause()},i.prototype.setFrame=function(t){this.isOpen&&t!==this.currentFrame&&(t=Math.max(0,Math.min(Math.floor(t),this.frameCount-1)),this.drawFrame(t),this.h=t,this.paused&&(this.u=t*(1/this.framerate),this.emit("progress",this.progress)),this.emit("frame:update",this.currentFrame))},i.prototype.nextFrame=function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1},i.prototype.prevFrame=function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1},i.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1},i.prototype.firstFrame=function(){this.currentFrame=0},i.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},i.prototype.startSeek=function(){this.isSeeking||(this.wasPlaying=!this.paused,this.pause(),this.isSeeking=!0)},i.prototype.seek=function(t){this.isSeeking&&(this.progress=t)},i.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},i.prototype.getMasterWav=function(){return Tt.fromFlipnote(this.note)},i.prototype.saveMasterWav=function(){var t=this.getMasterWav();ci(t.getBlob(),this.meta.current.filename+".wav")},i.prototype.getFrameGif=function(t,i){return void 0===i&&(i={}),Ct.fromFlipnoteFrame(this.note,t,i)},i.prototype.saveFrameGif=function(t,i){void 0===i&&(i={});var n=this.getFrameGif(t,i);ci(n.getBlob(),this.meta.current.filename+"_"+t.toString().padStart(3,"0")+".gif")},i.prototype.getAnimatedGif=function(t){return void 0===t&&(t={}),Ct.fromFlipnote(this.note,t)},i.prototype.saveAnimatedGif=function(t){void 0===t&&(t={});var i=this.getAnimatedGif(t);ci(i.getBlob(),this.meta.current.filename+".gif")},i.prototype.drawFrame=function(i){var n=this.note.getFramePalette(i),r=this.note.decodeFrame(i);if(this.canvas.setPalette(n),this.canvas.clearFrameBuffer(n[0]),this.note.format===t.FlipnoteFormat.PPM)this.layerVisibility[2]&&this.canvas.drawPixels(r[1],1),this.layerVisibility[1]&&this.canvas.drawPixels(r[0],0);else if(this.note.format===t.FlipnoteFormat.KWZ){var e=this.note.getFrameLayerOrder(i),s=e[0],o=e[1],h=e[2];this.layerVisibility[s+1]&&this.canvas.drawPixels(r[s],2*s),this.layerVisibility[o+1]&&this.canvas.drawPixels(r[o],2*o),this.layerVisibility[h+1]&&this.canvas.drawPixels(r[h],2*h)}this.canvas.composite()},i.prototype.forceUpdate=function(){this.isOpen&&this.drawFrame(this.currentFrame)},i.prototype.resize=function(t,i){this.canvas.resize(t,i),this.forceUpdate()},i.prototype.setLayerVisibility=function(t,i){this.layerVisibility[t]=i,this.forceUpdate()},i.prototype.toggleLayerVisibility=function(t){this.setLayerVisibility(t,!this.layerVisibility[t])},i.prototype.on=function(t,i){var n=this.events;(n[t]||(n[t]=[])).push(i)},i.prototype.off=function(t,i){var n=this.events[t];n&&n.splice(n.indexOf(i),1)},i.prototype.emit=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];for(var r=this.events[t]||[],e=0;e<r.length;e++)r[e].apply(null,i)},i.prototype.clearEvents=function(){this.events={}},i.prototype.destroy=function(){this.close(),this.canvas.destroy()},i.defaultState={noteType:null,isNoteOpen:!1,paused:!1,hasPlaybackStarted:!1,frame:-1,time:-1,loop:!1,volume:1,muted:!1,layerVisibility:{1:!0,2:!0,3:!0},isSeeking:!1,wasPlaying:!1},i}();function vi(t,i){return t.toString().padStart(i,"0")}function yi(t){return Math.floor(t%3600/60)+":"+vi(Math.round(t%60),2)}function pi(t,i){return t.replace(/<svg ([^>]*)>/,(function(t,n){return"<svg "+n+' style="'+i+'">'}))}function di(t){let n,r,o,c,p,m,w;return{c(){n=f("div"),r=f("div"),o=f("div"),c=l(),p=f("div"),this.c=i,y(o,"class","PlayerSlider__level"),d(o,"width",100*t[0]+"%"),y(p,"class","PlayerSlider__handle"),d(p,"left",100*t[0]+"%"),y(r,"class","PlayerSlider__track"),y(n,"class","PlayerSlider")},m(i,e){u(i,n,e),h(n,r),h(r,o),h(r,c),h(r,p),t[6](r),m||(w=[v(window,"mousemove",(function(){s(t[2]?t[5]:null)&&(t[2]?t[5]:null).apply(this,arguments)})),v(window,"mouseup",(function(){s(t[2]?t[4]:null)&&(t[2]?t[4]:null).apply(this,arguments)})),v(n,"mousedown",t[3])],m=!0)},p(i,[n]){t=i,1&n&&d(o,"width",100*t[0]+"%"),1&n&&d(p,"left",100*t[0]+"%")},i:i,o:i,d(i){i&&a(n),t[6](null),m=!1,e(w)}}}function mi(t,i,n){let r,{value:e=0}=i,s=!1;const o=(h=b(),u=g(),function(t,i){u(t,i),h.dispatchEvent&&h.dispatchEvent(new CustomEvent(t,{detail:i}))});var h,u;function a(t){t.preventDefault();const i=r.getBoundingClientRect(),n=i.height/2,s=i.width-2*n,h=t.pageX-i.left-n,u=Math.max(0,Math.min(1,h/s));e!==u&&o("change",{value:u})}return t.$set=t=>{"value"in t&&n(0,e=t.value)},[e,r,s,function(t){t.preventDefault(),n(2,s=!0),a(t),o("inputstart")},function(t){t.preventDefault(),n(2,s=!1),a(t),o("inputend")},a,function(t){A[t?"unshift":"push"](()=>{r=t,n(1,r)})}]}customElements.define("flipnote-player-slider-bar",class extends I{constructor(t){super(),this.shadowRoot.innerHTML="<style>.PlayerSlider{padding:4px 0;cursor:pointer}.PlayerSlider__track{position:relative;flex:1;height:4px;border-radius:3px;margin:6px 0;background:var(--flipnote-player-slider-track, #FFD3A6)}.PlayerSlider__level{position:absolute;width:100%;height:6px;margin:-1px;border-radius:8px;background:var(--flipnote-player-slider-level, #F36A2D)}.PlayerSlider__handle{display:none;position:absolute;top:0;height:10px;width:6px;margin-left:-3px;margin-top:-3px;border-radius:2px;background:var(--flipnote-player-slider-handle, #F36A2D)}.PlayerSlider:hover .PlayerSlider__handle{display:block}</style>",j(this,{target:this.shadowRoot},mi,di,o,{value:0}),t&&(t.target&&u(t.target,this,t.anchor),t.props&&(this.$set(t.props),U()))}static get observedAttributes(){return["value"]}get value(){return this.$$.ctx[0]}set value(t){this.$set({value:t}),U()}});function wi(t){let n,r=t[1][t[0]]+"";return{c(){n=f("div"),this.c=i,y(n,"class","PlayerIcon")},m(t,i){u(t,n,i),n.innerHTML=r},p(t,[i]){1&i&&r!==(r=t[1][t[0]]+"")&&(n.innerHTML=r)},i:i,o:i,d(t){t&&a(n)}}}const bi="fill:currentColor";function gi(t,i,n){let{icon:r="play"}=i;const e={play:pi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 241 240"><path fill-rule="evenodd" d="M74.137 48h8.985a4 4 0 012.129.614l91.994 57.84c7.48 4.704 9.732 14.582 5.028 22.062a16 16 0 01-5.028 5.03l-91.994 57.84a4 4 0 01-2.13.614h-8.984C68.54 192 64 187.461 64 181.863V58.137C64 52.54 68.539 48 74.137 48z"/></svg>',bi),pause:pi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M64 48h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16H64c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16zm88 0h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16h-24c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16z"/></svg>',bi),loader:pi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M120 176c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16zm48.497-28c4.419-7.653 14.204-10.275 21.857-5.856 7.653 4.418 10.275 14.203 5.856 21.856-4.418 7.653-14.203 10.275-21.856 5.856-7.653-4.418-10.275-14.203-5.857-21.856zm-118.85-5.856c7.652-4.419 17.437-1.797 21.856 5.856 4.418 7.653 1.796 17.438-5.857 21.856-7.653 4.419-17.438 1.797-21.856-5.856-4.419-7.653-1.797-17.438 5.856-21.856zm124.707-72c7.653-4.419 17.438-1.797 21.856 5.856 4.419 7.653 1.797 17.438-5.856 21.856-7.653 4.419-17.438 1.797-21.857-5.856-4.418-7.653-1.796-17.438 5.857-21.856zM43.79 76c4.418-7.653 14.203-10.275 21.856-5.856C73.3 74.562 75.921 84.347 71.503 92c-4.419 7.653-14.204 10.275-21.857 5.856C41.993 93.438 39.371 83.653 43.79 76zM120 32c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16z"/></svg>',bi),volumeOn:pi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M113.3 42.022a10 10 0 0110-1.2 10 10 0 015.7 9v140a10 10 0 01-5.7 9 9.116 9.116 0 01-4.3 1.001 10.009 10.009 0 01-6.2-2.2l-47.3-37.8H29c-5.523 0-10-4.478-10-10v-60c0-5.524 4.477-10 10-10h36.5zm82.986 17.298c17.008 16.234 25.715 36.022 25.715 58.68 0 22.37-8.465 43.147-24.992 61.928-4.378 4.975-11.96 5.459-16.936 1.08-4.975-4.378-5.46-11.96-1.08-16.936C191.798 149.52 198 134.297 198 118c0-16.009-5.96-29.554-18.286-41.32-4.794-4.576-4.97-12.172-.395-16.966 4.577-4.794 12.172-4.97 16.966-.394zM165.201 87.4c10.904 8.178 16.8 18.987 16.8 31.6 0 12.433-5.712 23.38-16.318 32.219-5.091 4.242-12.658 3.555-16.9-1.537-4.174-5.008-3.577-12.41 1.289-16.69l.246-.21c5.395-4.496 7.683-8.881 7.683-13.782 0-4.613-2.01-8.403-6.857-12.14l-.343-.26c-5.302-3.976-6.377-11.498-2.4-16.8 3.976-5.302 11.498-6.376 16.8-2.4z"/></svg>',bi),volumeOff:pi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M123.3 40.822a10 10 0 00-10 1.2l-47.8 37.8H29c-5.523 0-10 4.477-10 10v60c0 5.523 4.477 10 10 10h36.5l47.3 37.8a10.009 10.009 0 006.2 2.201 9.116 9.116 0 004.3-1 10 10 0 005.7-9v-140a10 10 0 00-5.7-9zm70.451 50.462c4.702-4.454 12.126-4.377 16.734.23 4.608 4.609 4.685 12.033.23 16.735l-.23.236L198.971 120l11.514 11.515c4.687 4.686 4.687 12.284 0 16.97-4.608 4.608-12.032 4.685-16.734.23l-.236-.23L182 136.971l-11.515 11.514-.236.23c-4.702 4.455-12.126 4.378-16.734-.23-4.608-4.608-4.685-12.032-.23-16.734l.23-.236L165.029 120l-11.514-11.515c-4.687-4.686-4.687-12.284 0-16.97 4.608-4.608 12.032-4.685 16.734-.23l.236.23L182 103.029l11.515-11.514.236-.23z"/></svg>',bi)};return t.$set=t=>{"icon"in t&&n(0,r=t.icon)},[r,e]}function _i(t){let i;return{c(){i=f("div"),i.textContent="Error",y(i,"class","FlipnotePlayer__overlay")},m(t,n){u(t,i,n)},d(t){t&&a(i)}}}function Ai(t){return{c:i,m:i,d:i}}function Fi(t){let i;return{c(){i=f("div"),i.innerHTML='<flipnote-player-icon icon="loader" class="FlipnotePlayer__loaderIcon"></flipnote-player-icon>',y(i,"class","FlipnotePlayer__overlay")},m(t,n){u(t,i,n)},d(t){t&&a(i)}}}function xi(t){let n;return{c(){n=f("div"),n.textContent="todo :)",y(n,"class","FlipnotePlayerControls FlipnotePlayerControls--full")},m(t,i){u(t,n,i)},p:i,d(t){t&&a(n)}}}function zi(t){let i,n,r,s,o,d,m,w,b,g,_,A,F,x,z,P,S,C,T,U,k;return{c(){i=f("div"),n=f("flipnote-player-slider-bar"),s=l(),o=f("div"),d=f("div"),m=f("button"),w=f("flipnote-player-icon"),g=l(),_=f("span"),A=c(t[6]),F=l(),x=f("div"),z=f("flipnote-player-icon"),S=l(),C=f("flipnote-player-slider-bar"),p(n,"class","FlipnotePlayerControls__progressBar"),p(n,"value",r=t[3]/100),p(w,"icon",b=t[4]?"pause":"play"),y(m,"class","Button FlipnotePlayerControls__playButton"),y(_,"class","FlipnotePlayerControls__frameCounter"),y(d,"class","FlipnotePlayerControls__groupLeft"),p(z,"class","FlipnotePlayerControls__muteIcon"),p(z,"icon",P=t[0]||0===t[5]?"volumeOff":"volumeOn"),p(C,"class","FlipnotePlayerControls__volumeBar"),p(C,"value",T=t[0]?0:t[5]),y(x,"class","FlipnotePlayerControls__groupRight"),y(o,"class","FlipnotePlayerControls__row"),y(i,"class","FlipnotePlayerControls FlipnotePlayerControls--default")},m(r,e){u(r,i,e),h(i,n),h(i,s),h(i,o),h(o,d),h(d,m),h(m,w),h(d,g),h(d,_),h(_,A),h(o,F),h(o,x),h(x,z),h(x,S),h(x,C),U||(k=[v(n,"change",t[9]),v(n,"inputstart",t[8]),v(n,"inputend",t[10]),v(m,"click",t[12]),v(z,"click",t[13]),v(C,"change",t[11])],U=!0)},p(t,i){8&i&&r!==(r=t[3]/100)&&p(n,"value",r),16&i&&b!==(b=t[4]?"pause":"play")&&p(w,"icon",b),64&i&&function(t,i){i=""+i,t.wholeText!==i&&(t.data=i)}(A,t[6]),33&i&&P!==(P=t[0]||0===t[5]?"volumeOff":"volumeOn")&&p(z,"icon",P),33&i&&T!==(T=t[0]?0:t[5])&&p(C,"value",T)},d(t){t&&a(i),U=!1,e(k)}}}function Pi(t){let i,n,r,s,o,c,d,m,w;return{c(){i=f("div"),n=f("button"),r=f("flipnote-player-icon"),o=l(),c=f("flipnote-player-slider-bar"),p(r,"icon",s=t[4]?"pause":"play"),y(n,"class","Button FlipnotePlayerControls__playButton"),p(c,"class","FlipnotePlayerControls__progressBar"),p(c,"value",d=t[3]/100),y(i,"class","FlipnotePlayerControls FlipnotePlayerControls--compact FlipnotePlayerControls__row")},m(e,s){u(e,i,s),h(i,n),h(n,r),h(i,o),h(i,c),m||(w=[v(n,"click",t[12]),v(c,"change",t[9]),v(c,"inputstart",t[8]),v(c,"inputend",t[10])],m=!0)},p(t,i){16&i&&s!==(s=t[4]?"pause":"play")&&p(r,"icon",s),8&i&&d!==(d=t[3]/100)&&p(c,"value",d)},d(t){t&&a(i),m=!1,e(w)}}}function Si(t){let n,r,e,s,o,c,p,d,m={ctx:t,current:null,token:null,pending:Fi,then:Ai,catch:_i,error:23};function w(t,i){return"compact"===t[1]?Pi:"default"===t[1]?zi:"full"===t[1]?xi:void 0}M(o=t[7],m);let b=w(t),g=b&&b(t);return{c(){n=f("div"),r=f("div"),e=f("canvas"),s=l(),m.block.c(),c=l(),g&&g.c(),this.c=i,y(e,"class","FlipnotePlayer__canvas"),y(r,"class","FlipnotePlayer__canvasArea"),y(n,"class","FlipnotePlayer")},m(i,o){u(i,n,o),h(n,r),h(r,e),t[16](e),h(r,s),m.block.m(r,m.anchor=null),m.mount=()=>r,m.anchor=null,h(n,c),g&&g.m(n,null),p||(d=v(e,"click",t[12]),p=!0)},p(i,[r]){t=i,m.ctx=t,128&r&&o!==(o=t[7])&&M(o,m),b===(b=w(t))&&g?g.p(t,r):(g&&g.d(1),g=b&&b(t),g&&(g.c(),g.m(n,null)))},i:i,o:i,d(i){i&&a(n),t[16](null),m.block.d(),m.token=null,m=null,g&&g.d(),p=!1,d()}}}function Ci(t,i,n){let r,e,{src:s=null}=i,{controls:o="default"}=i,{timeformat:h="frames"}=i,{muted:u=!1}=i,a=0,f=0,c=0,l=0,v=0,y=!1,p=1,d="";var m;m=()=>{n(17,r=new li(e,256,192)),r.on("load",()=>{n(19,c=r.frameCount),n(21,v=r.duration),n(5,p=r.volume),n(17,r.muted=u,r),r.resize(r.note.width,r.note.height)}),r.on("progress",t=>{n(3,a=t),n(20,l=r.currentTime)}),r.on("playback:start",()=>{n(4,y=!0)}),r.on("playback:stop",()=>{n(4,y=!1)}),r.on("frame:update",()=>{n(18,f=r.currentFrame+1)})},b().$$.on_mount.push(m);let w=new Promise((t,i)=>i());return t.$set=t=>{"src"in t&&n(14,s=t.src),"controls"in t&&n(1,o=t.controls),"timeformat"in t&&n(15,h=t.timeformat),"muted"in t&&n(0,u=t.muted)},t.$$.update=()=>{16384&t.$$.dirty&&s&&n(7,w=async function(t){await r.open(t)}(s)),131073&t.$$.dirty&&r&&n(17,r.muted=u,r),3964928&t.$$.dirty&&n(6,d="time"===h?`${yi(l)} / ${yi(v)}`:`${vi(f,3)} / ${vi(c,3)}`)},[u,o,e,a,y,p,d,w,function(t){r&&r.startSeek()},function(t){const{value:i}=t.detail;r&&r.seek(100*i)},function(t){r&&r.endSeek()},function(t){const{value:i}=t.detail;r&&(n(17,r.volume=i,r),n(5,p=i),p>0&&u&&n(0,u=!1))},function(){r&&r.togglePlay()},function(){n(0,u=!u)},s,h,function(t){A[t?"unshift":"push"](()=>{e=t,n(2,e)})}]}customElements.define("flipnote-player-icon",class extends I{constructor(t){super(),this.shadowRoot.innerHTML="<style>.PlayerIcon{width:100%;height:100%;color:var(--flipnote-player-icon-color, #F36A2D)}</style>",j(this,{target:this.shadowRoot},gi,wi,o,{icon:0}),t&&(t.target&&u(t.target,this,t.anchor),t.props&&(this.$set(t.props),U()))}static get observedAttributes(){return["icon"]}get icon(){return this.$$.ctx[0]}set icon(t){this.$set({icon:t}),U()}});class Ti extends I{constructor(t){super(),this.shadowRoot.innerHTML="<style>.Button{border:0;padding:0;outline:0;-webkit-appearance:none;display:block;font-family:inherit;font-size:inherit;text-align:center;cursor:pointer;background:var(--flipnote-player-button-background, #FFD3A6);color:var(--flipnote-player-button-color, #F36A2D);border-radius:4px}.Button flipnote-player-icon{display:block}.FlipnotePlayer{display:inline-block;position:relative;font-family:var(--flipnote-player-font-family, sans-serif)}.FlipnotePlayer__canvasArea{position:relative}.FlipnotePlayer__canvas{position:relative;display:block}.FlipnotePlayer__overlay{position:absolute;top:0;left:0;background:#e5e5e9;color:#4b4c53;width:100%;height:100%;display:flex;justify-content:center;align-items:center}@keyframes spin{from{transform:rotateZ(0)}to{transform:rotateZ(360deg)}}.FlipnotePlayer__loaderIcon{animation:spin infinite 1.2s linear}.FlipnotePlayerControls{background:var(--flipnote-player-controls-background, none)}.FlipnotePlayerControls__muteIcon{width:28px;height:28px}.FlipnotePlayerControls__row,.FlipnotePlayerControls__groupLeft,.FlipnotePlayerControls__groupRight{display:flex;align-items:center}.FlipnotePlayerControls__groupLeft{margin-right:auto}.FlipnotePlayerControls__groupRight{margin-left:auto}.FlipnotePlayerControls__playButton{height:32px;width:32px;padding:2px}.FlipnotePlayerControls__frameCounter{font-variant-numeric:tabular-nums}.FlipnotePlayerControls--compact .FlipnotePlayerControls__playButton{margin-right:12px}.FlipnotePlayerControls--compact .FlipnotePlayerControls__progressBar{flex:1}.FlipnotePlayerControls--default .FlipnotePlayerControls__playButton{margin-right:8px}.FlipnotePlayerControls--default .FlipnotePlayerControls__volumeBar{width:70px;margin-left:8px}</style>",j(this,{target:this.shadowRoot},Ci,Si,o,{src:14,controls:1,timeformat:15,muted:0}),t&&(t.target&&u(t.target,this,t.anchor),t.props&&(this.$set(t.props),U()))}static get observedAttributes(){return["src","controls","timeformat","muted"]}get src(){return this.$$.ctx[14]}set src(t){this.$set({src:t}),U()}get controls(){return this.$$.ctx[1]}set controls(t){this.$set({controls:t}),U()}get timeformat(){return this.$$.ctx[15]}set timeformat(t){this.$set({timeformat:t}),U()}get muted(){return this.$$.ctx[0]}set muted(t){this.$set({muted:t}),U()}}customElements.define("flipnote-player",Ti);var Ui=Ti;t.GifImage=Ct,t.KwzParser=xt,t.Player=li,t.PpmParser=ot,t.WavAudio=Tt,t.parseSource=zt,t.playerComponent=Ui,t.version="5.0.0",Object.defineProperty(t,"v",{value:!0})}));
