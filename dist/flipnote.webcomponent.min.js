/*!!
 flipnote.js v4.1.0 (webcomponent version)
 Browser-based playback of .ppm and .kwz animations from Flipnote Studio and Flipnote Studio 3D
 2018 - 2020 James Daniel
 github.com/jaames/flipnote.js
 Flipnote Studio is (c) Nintendo Co., Ltd.
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).flipnote={})}(this,(function(t){"use strict";function e(){}function n(t){return t()}function r(){return Object.create(null)}function i(t){t.forEach(n)}function o(t){return"function"==typeof t}function s(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function u(t,e){t.appendChild(e)}function a(t,e,n){t.insertBefore(e,n||null)}function l(t){t.parentNode.removeChild(t)}function c(t){return document.createElement(t)}function f(t){return document.createTextNode(t)}function h(){return f(" ")}function y(t,e,n,r){return t.addEventListener(e,n,r),()=>t.removeEventListener(e,n,r)}function d(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function p(t,e,n){e in t?t[e]=n:d(t,e,n)}function v(t,e,n,r){t.style.setProperty(e,n,r?"important":"")}let m;function b(t){m=t}function w(){if(!m)throw new Error("Function called outside component initialization");return m}function g(){const t=w();return(e,n)=>{const r=t.$$.callbacks[e];if(r){const i=function(t,e){const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,!1,!1,e),n}(e,n);r.slice().forEach(e=>{e.call(t,i)})}}}const F=[],x=[],_=[],A=[],P=Promise.resolve();let E=!1;function z(t){_.push(t)}let R=!1;const U=new Set;function C(){if(!R){R=!0;do{for(let t=0;t<F.length;t+=1){const e=F[t];b(e),S(e.$$)}for(F.length=0;x.length;)x.pop()();for(let t=0;t<_.length;t+=1){const e=_[t];U.has(e)||(U.add(e),e())}_.length=0}while(F.length);for(;A.length;)A.pop()();E=!1,R=!1,U.clear()}}function S(t){if(null!==t.fragment){t.update(),i(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(z)}}const k=new Set;let T,I;function B(t,e){t&&t.i&&(k.delete(t),t.i(e))}function M(t,e){const n=e.token={};function r(t,r,o,s){if(e.token!==n)return;e.resolved=s;let u=e.ctx;void 0!==o&&(u=u.slice(),u[o]=s);const a=t&&(e.current=t)(u);let l=!1;e.block&&(e.blocks?e.blocks.forEach((t,n)=>{n!==r&&t&&(T={r:0,c:[],p:T},function(t,e,n,r){if(t&&t.o){if(k.has(t))return;k.add(t),T.c.push(()=>{k.delete(t),r&&(n&&t.d(1),r())}),t.o(e)}}(t,1,1,()=>{e.blocks[n]=null}),T.r||i(T.c),T=T.p)}):e.block.d(1),a.c(),B(a,1),a.m(e.mount(),e.anchor),l=!0),e.block=a,e.blocks&&(e.blocks[r]=a),l&&C()}if((o=t)&&"object"==typeof o&&"function"==typeof o.then){const n=w();if(t.then(t=>{b(n),r(e.then,1,e.value,t),b(null)},t=>{b(n),r(e.catch,2,e.error,t),b(null)}),e.current!==e.pending)return r(e.pending,0),!0}else{if(e.current!==e.then)return r(e.then,1,e.value,t),!0;e.resolved=t}var o}function O(t,e){-1===t.$$.dirty[0]&&(F.push(t),E||(E=!0,P.then(C)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function L(t,s,u,a,c,f,h=[-1]){const y=m;b(t);const d=s.props||{},p=t.$$={fragment:null,ctx:null,props:f,update:e,not_equal:c,bound:r(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(y?y.$$.context:[]),callbacks:r(),dirty:h};let v=!1;if(p.ctx=u?u(t,d,(e,n,...r)=>{const i=r.length?r[0]:n;return p.ctx&&c(p.ctx[e],p.ctx[e]=i)&&(p.bound[e]&&p.bound[e](i),v&&O(t,e)),n}):[],p.update(),v=!0,i(p.before_update),p.fragment=!!a&&a(p.ctx),s.target){if(s.hydrate){const t=function(t){return Array.from(t.childNodes)}(s.target);p.fragment&&p.fragment.l(t),t.forEach(l)}else p.fragment&&p.fragment.c();s.intro&&B(t.$$.fragment),function(t,e,r){const{fragment:s,on_mount:u,on_destroy:a,after_update:l}=t.$$;s&&s.m(e,r),z(()=>{const e=u.map(n).filter(o);a?a.push(...e):i(e),t.$$.on_mount=[]}),l.forEach(z)}(t,s.target,s.anchor),C()}b(y)}"function"==typeof HTMLElement&&(I=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){for(const t in this.$$.slotted)this.appendChild(this.$$.slotted[t])}attributeChangedCallback(t,e,n){this[t]=n}$destroy(){!function(t,e){const n=t.$$;null!==n.fragment&&(i(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=e}$on(t,e){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(){}});var j=function(t,e){return(j=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function D(t,e){function n(){this.constructor=t}j(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var W=function(){return(W=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function G(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{a(r.next(t))}catch(t){o(t)}}function u(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))}function $(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}}var N=[{matches:function(t){return"string"==typeof t},load:function(t,e,n){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(t){4===r.readyState&&(r.status>=200&&r.status<300?e(r.response):n({type:"httpError",status:r.status,statusText:r.statusText}))},r.send(null)}},{matches:function(t){return"undefined"!=typeof File&&t instanceof File},load:function(t,e,n){if("undefined"!=typeof FileReader){var r=new FileReader;r.onload=function(t){e(r.result)},r.onerror=function(t){n({type:"fileReadError"})},r.readAsArrayBuffer(t)}else n()}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,n){e(t)}}];var H,Y=function(){function t(){this.page=-1,this.pages=[],this.cursor=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(t.pageSize),this.cursor=0},t.prototype.getData=function(){var e=this,n=new Uint8Array(this.page*t.pageSize+this.cursor);return this.pages.map((function(r,i){i===e.page?n.set(r.slice(0,e.cursor),i*t.pageSize):n.set(r,i*t.pageSize)})),n},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(e){this.cursor>=t.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=e},t.prototype.writeBytes=function(t,e,n){for(var r=n||t.length,i=e||0;i<r;i++)this.writeByte(t[i])},t.pageSize=4096,t}(),V=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.cursor=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,e){switch(e){case 2:this.cursor=this.data.byteLength+t;break;case 1:this.cursor+=t;break;case 0:default:this.cursor=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.cursor);return this.cursor+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.cursor,t),this.cursor+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.cursor);return this.cursor+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.cursor,t),this.cursor+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var e=this.data.getUint16(this.cursor,t);return this.cursor+=2,e},t.prototype.writeUint16=function(t,e){void 0===e&&(e=!0),this.data.setUint16(this.cursor,t,e),this.cursor+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var e=this.data.getInt16(this.cursor,t);return this.cursor+=2,e},t.prototype.writeInt16=function(t,e){void 0===e&&(e=!0),this.data.setInt16(this.cursor,t,e),this.cursor+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var e=this.data.getUint32(this.cursor,t);return this.cursor+=4,e},t.prototype.writeUint32=function(t,e){void 0===e&&(e=!0),this.data.setUint32(this.cursor,t,e),this.cursor+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var e=this.data.getInt32(this.cursor,t);return this.cursor+=4,e},t.prototype.writeInt32=function(t,e){void 0===e&&(e=!0),this.data.setInt32(this.cursor,t,e),this.cursor+=4},t.prototype.readBytes=function(t){var e=new Uint8Array(this.data.buffer,this.cursor,t);return this.cursor+=e.byteLength,e},t.prototype.writeBytes=function(t){var e=this;t.forEach((function(t){return e.writeUint8(t)}))},t.prototype.readHex=function(t,e){void 0===e&&(e=!1);for(var n=this.readBytes(t),r=[],i=0;i<n.length;i++)r.push(n[i].toString(16).padStart(2,"0"));return e&&r.reverse(),r.join("").toUpperCase()},t.prototype.readChars=function(t){for(var e=this.readBytes(t),n="",r=0;r<e.length;r++){var i=e[r];if(0===i)break;n+=String.fromCharCode(i)}return n},t.prototype.writeChars=function(t){for(var e=0;e<t.length;e++){var n=t.charCodeAt(e);this.writeUint8(n)}},t.prototype.readWideChars=function(t){for(var e=new Uint16Array(this.data.buffer,this.cursor,t),n="",r=0;r<e.length;r++){var i=e[r];if(0==i)break;n+=String.fromCharCode(i)}return this.cursor+=e.byteLength,n},t}();!function(t){t[t.BGM=0]="BGM",t[t.SE1=1]="SE1",t[t.SE2=2]="SE2",t[t.SE3=3]="SE3",t[t.SE4=4]="SE4"}(H||(H={}));var K=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.hasAudioTrack=function(t){return!!(this.soundMeta.hasOwnProperty(t)&&this.soundMeta[t].length>0)},e}(V);function X(t,e,n){return t<e?e:t>n?n:t}function q(t,e,n){for(var r=t.length/e,i=new Int16Array(r*n),o=e/n,s=0;s<i.length;s++)i[s]=t[Math.floor(s*o)];return i}function Z(t,e,n){void 0===n&&(n=0);for(var r=t.length,i=e.length,o=0;o<r&&!(n+o>i);o++){var s=e[n+o]+t[o]/2;e[n+o]=X(s,-32768,32767)}}for(var J=new Int8Array([-1,2,-1,2]),Q=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),tt=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),et=new Int16Array(360),nt=0;nt<4;nt++)for(var rt=0;rt<90;rt++){var it=(st=tt[rt])>>3;1&nt&&(it+=st),2&nt&&(it=-it),et[nt+4*rt]=it}var ot=new Int16Array(1440);for(nt=0;nt<16;nt++)for(rt=0;rt<90;rt++){var st;it=(st=tt[rt])>>3;4&nt&&(it+=st),2&nt&&(it+=st>>1),1&nt&&(it+=st>>2),8&nt&&(it=-it),ot[nt+16*rt]=it}for(var ut=[.5,.5,1,2,4,6,12,20,30],at={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},lt=function(t){function e(n){var r=t.call(this,n)||this;return r.type=e.type,r.width=e.width,r.height=e.height,r.globalPalette=e.globalPalette,r.rawSampleRate=e.rawSampleRate,r.sampleRate=e.sampleRate,r.prevDecodedFrame=null,r.decodeHeader(),r.decodeAnimationHeader(),r.decodeSoundHeader(),0!=(r.version>>4&15)&&r.decodeMeta(),r.layers=[new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height)],r.prevLayers=[new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height)],r.prevDecodedFrame=null,r}return D(e,t),e.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},e.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},e.prototype.decodeHeader=function(){this.seek(0);this.readUint32();this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},e.prototype.readFilename=function(){return[this.readHex(3),this.readChars(13),this.readUint16().toString().padStart(3,"0")].join("_")},e.prototype.decodeMeta=function(){this.seek(16);var t=this.readUint16(),e=this.readInt16(),n=this.readWideChars(11),r=this.readWideChars(11),i=this.readWideChars(11),o=this.readHex(8,!0),s=this.readHex(8,!0),u=this.readFilename(),a=this.readFilename(),l=this.readHex(8,!0);this.seek(154);var c=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var f=this.readUint16();this.thumbFrameIndex=e,this.meta={lock:1===t,loop:1==(f>>1&1),frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:e,timestamp:c,spinoff:s!==o||s!==l,root:{filename:null,username:n,fsid:l},parent:{username:r,fsid:o,filename:u},current:{username:i,fsid:s,filename:a}}},e.prototype.decodeAnimationHeader=function(){this.seek(1696);var t=this.readUint16(),e=t/4;this.seek(1704);for(var n=new Uint32Array(e),r=0;r<e;r++)n[r]=1704+t+this.readUint32();this.frameOffsets=n},e.prototype.decodeSoundHeader=function(){var t,e=1696+this.frameDataLength+this.frameCount;e%4!=0&&(e+=4-e%4),this.seek(e);var n=this.readUint32(),r=this.readUint32(),i=this.readUint32(),o=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),e+=32,this.framerate=ut[this.frameSpeed],this.bgmrate=ut[this.bgmSpeed],this.soundMeta=((t={})[H.BGM]={offset:e,length:n},t[H.SE1]={offset:e+=n,length:r},t[H.SE2]={offset:e+=r,length:i},t[H.SE3]={offset:e+=i,length:o},t)},e.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},e.prototype.getLayerOrder=function(t){return[0,1]},e.prototype.readLineEncoding=function(){for(var t=new Uint8Array(e.height),n=0,r=0;r<48;r++)for(var i=this.readUint8(),o=0;o<8;o+=2)t[n++]=i>>o&3;return t},e.prototype.decodeFrame=function(t){this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.seek(this.frameOffsets[t]);var n=this.readUint8(),r=n>>7&1,i=n>>5&3,o=0,s=0;this.prevLayers[0].set(this.layers[0]),this.prevLayers[1].set(this.layers[1]),this.prevDecodedFrame=t,this.layers[0].fill(0),this.layers[1].fill(0),i&&(o=this.readInt8(),s=this.readInt8());for(var u=[this.readLineEncoding(),this.readLineEncoding()],a=0;a<2;a++)for(var l=this.layers[a],c=0;c<e.height;c++){var f=u[a][c],h=c*e.width;switch(f){case 0:break;case 1:case 2:var y=this.readUint32(!1);for(2==f&&l.fill(1,h,h+e.width);4294967295&y;){if(2147483648&y)for(var d=this.readUint8(),p=0;p<8;p++)l[h+p]=d>>p&1;h+=8,y<<=1}break;case 3:for(;h<(c+1)*e.width;){for(d=this.readUint8(),p=0;p<8;p++)l[h+p]=d>>p&1;h+=8}}}var v=this.layers[0],m=this.layers[1],b=this.prevLayers[0],w=this.prevLayers[1];if(!r)for(var g=void 0,F=void 0,x=0;x<e.height;x++)if(!(x-s<0)){if(x-s>=e.height)break;for(var _=0;_<e.width;_++)if(!(_-o<0)){if(_-o>=e.width)break;F=(g=_+x*e.width)-(o+s*e.width),v[g]^=b[F],m[g]^=w[F]}}return this.layers},e.prototype.getFramePaletteIndices=function(t){this.seek(this.frameOffsets[t]);var e=this.readUint8(),n=1!=(1&e),r=[n?0:1,n?0:1,2,3];return[n?1:0,r[e>>1&3],r[e>>3&3]]},e.prototype.getFramePalette=function(t){var e=this;return this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},e.prototype.getLayerPixels=function(t,n){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),i=this.layers[n],o=new Uint8Array(e.width*e.height),s=r[n+1],u=0;u<o.length;u++)1===i[u]&&(o[u]=s);return o},e.prototype.getFramePixels=function(t){var n=this.getFramePaletteIndices(t),r=this.decodeFrame(t),i=new Uint8Array(e.width*e.height),o=r[0],s=r[1],u=n[0],a=n[1],l=n[2];i.fill(u);for(var c=0;c<i.length;c++){var f=o[c],h=s[c];1===f?i[c]=a:1===h&&(i[c]=l)}return i},e.prototype.decodeSoundFlags=function(){this.seek(1696+this.frameDataLength);for(var t=this.frameCount,e=this.readBytes(t),n=new Array(t),r=0;r<t;r++){var i=e[r];n[r]=[0!=(1&i),0!=(2&i),0!=(4&i)]}return n},e.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta[t];return this.seek(e.offset),this.readBytes(e.length)},e.prototype.decodeAudioTrack=function(t){for(var e=this.getAudioTrackRaw(t),n=e.length,r=new Int16Array(2*n),i=0,o=0,s=0,u=0,a=0,l=!0;i<n;){s=l?15&e[i]:e[i++]>>4,l=!l;var c=tt[u],f=c>>3;1&s&&(f+=c>>2),2&s&&(f+=c>>1),4&s&&(f+=c),8&s&&(f=-f),a=X(a+=f,-32768,32767),u=X(u+=Q[s],0,88),r[o++]=a}return r},e.prototype.getAudioTrackPcm=function(t,e){void 0===e&&(e=32768);var n=this.decodeAudioTrack(t),r=this.rawSampleRate;if(t===H.BGM){var i=Math.round(this.framerate/this.bgmrate);r=this.rawSampleRate*i}return r!==e?q(n,r,e):n},e.prototype.getAudioMasterPcm=function(t){void 0===t&&(t=32768);var e=this.frameCount*(1/this.framerate),n=Math.ceil(e*t),r=new Int16Array(n),i=this.hasAudioTrack(H.BGM),o=this.hasAudioTrack(H.SE1),s=this.hasAudioTrack(H.SE2),u=this.hasAudioTrack(H.SE3);i&&Z(this.getAudioTrackPcm(H.BGM,t),r,0);if(o||s||u)for(var a=this.decodeSoundFlags(),l=o?this.getAudioTrackPcm(H.SE1,t):null,c=s?this.getAudioTrackPcm(H.SE2,t):null,f=u?this.getAudioTrackPcm(H.SE3,t):null,h=t/this.rawSampleRate,y=Math.round(this.rawSampleRate/this.framerate)*h,d=0;d<this.frameCount;d++){var p=(d+.5)*y,v=a[d];o&&v[0]&&Z(l,r,p),s&&v[1]&&Z(c,r,p),u&&v[2]&&Z(f,r,p)}return r},e.type="PPM",e.width=256,e.height=192,e.rawSampleRate=8192,e.sampleRate=32768,e.globalPalette=[at.WHITE,at.BLACK,at.RED,at.BLUE],e}(K),ct=new Uint8Array(52488),ft=0,ht=0;ht<3;ht++)for(var yt=0;yt<3;yt++)for(var dt=0;dt<3;dt++)for(var pt=0;pt<3;pt++)for(var vt=0;vt<3;vt++)for(var mt=0;mt<3;mt++)for(var bt=0;bt<3;bt++)for(var wt=0;wt<3;wt++)ct.set([yt,ht,pt,dt,mt,vt,wt,bt],ft),ft+=8;var gt=new Uint8Array(52488);for(ft=0,ht=0;ht<2187;ht+=729)for(yt=0;yt<729;yt+=243)for(dt=0;dt<243;dt+=81)for(pt=0;pt<81;pt+=27)for(vt=0;vt<27;vt+=9)for(mt=0;mt<9;mt+=3)for(bt=0;bt<3;bt+=1)for(wt=0;wt<6561;wt+=2187){var Ft=ht+yt+dt+pt+vt+mt+bt+wt,xt=ct.subarray(8*Ft,8*Ft+8);gt.set(xt,ft),ft+=8}var _t=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,e){var n=ct.subarray(8*t,8*t+8);_t.set(n,8*e)}));var At=new Uint8Array(256);[0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100].forEach((function(t,e){var n=ct.subarray(8*t,8*t+8);At.set(n,8*e)}));var Pt=[.2,.5,1,2,4,6,8,12,20,24,30],Et={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},zt=function(t){function e(n){var r=t.call(this,n)||this;return r.type=e.type,r.width=e.width,r.height=e.height,r.globalPalette=e.globalPalette,r.rawSampleRate=e.rawSampleRate,r.sampleRate=e.sampleRate,r.prevDecodedFrame=null,r.bitIndex=0,r.bitValue=0,r.layers=[new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height)],r.bitIndex=0,r.bitValue=0,r.load(),r}return D(e,t),e.prototype.load=function(){this.seek(0),this.sections={},this.frameMeta=[];for(var t=this.byteLength-256,e=0,n=0;e<t&&n<6;){this.seek(e);var r=this.readChars(4).substring(0,3),i=this.readUint32();this.sections[r]={offset:e,length:i},e+=i+8,n+=1}this.decodeMeta(),this.decodeFrameMeta(),this.decodeSoundHeader()},e.prototype.readBits=function(t){if(this.bitIndex+t>16){var e=this.readUint16();this.bitValue|=e<<16-this.bitIndex,this.bitIndex-=16}var n=(1<<t)-1,r=this.bitValue&n;return this.bitValue>>=t,this.bitIndex+=t,r},e.prototype.decodeMeta=function(){this.seek(this.sections.KFH.offset+12);var t=new Date(1e3*(this.readUint32()+946684800)),e=new Date(1e3*(this.readUint32()+946684800)),n=(this.readUint32(),this.readHex(10)),r=this.readHex(10),i=this.readHex(10),o=this.readWideChars(11),s=this.readWideChars(11),u=this.readWideChars(11),a=this.readChars(28),l=this.readChars(28),c=this.readChars(28),f=this.readUint16(),h=this.readUint16(),y=this.readUint16(),d=this.readUint8();this.readUint8();this.frameCount=f,this.thumbFrameIndex=h,this.frameSpeed=d,this.framerate=Pt[d],this.meta={lock:1==(1&y),loop:1==(y>>1&1),frame_count:f,frame_speed:d,thumb_index:h,timestamp:e,creation_timestamp:t,root:{username:o,fsid:n,filename:a},parent:{username:s,fsid:r,filename:l},current:{username:u,fsid:i,filename:c}}},e.prototype.decodeFrameMeta=function(){this.frameOffsets=new Uint32Array(this.frameCount),this.seek(this.sections.KMI.offset+8);for(var t=this.sections.KMC.offset+12,e=0;e<this.frameCount;e++){var n={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readHex(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(n),this.frameOffsets[e]=t,t+=n.layerSize[0]+n.layerSize[1]+n.layerSize[2]}},e.prototype.decodeSoundHeader=function(){var t;if(this.sections.hasOwnProperty("KSN")){var e=this.sections.KSN.offset+8;this.seek(e);var n=this.readUint32();this.bgmSpeed=n,this.bgmrate=Pt[n];var r=new Uint32Array(this.buffer,e+4,20);this.soundMeta=((t={})[H.BGM]={offset:e+=28,length:r[0]},t[H.SE1]={offset:e+=r[0],length:r[1]},t[H.SE2]={offset:e+=r[1],length:r[2]},t[H.SE3]={offset:e+=r[2],length:r[3]},t[H.SE4]={offset:e+=r[3],length:r[4]},t)}},e.prototype.getDiffingFlag=function(t){return 7&~(this.frameMeta[t].flags>>4)},e.prototype.getLayerDepths=function(t){return this.frameMeta[t].layerDepth},e.prototype.getLayerOrder=function(t){var e=this.getLayerDepths(t);return[2,1,0].sort((function(t,n){return e[n]-e[t]}))},e.prototype.decodeFrame=function(t,n,r){void 0===n&&(n=7),void 0===r&&(r=!1),r&&(n&=this.getDiffingFlag(t+1)),this.prevDecodedFrame!==t-1&&n&&0!==t&&this.decodeFrame(t-1,n=n,r=!0);for(var i=this.frameMeta[t],o=this.frameOffsets[t],s=0;s<3;s++){this.seek(o);var u=i.layerSize[s];if(o+=u,38!==u&&0!=(n>>s&1)){this.bitIndex=16,this.bitValue=0;for(var a=0,l=0;l<e.height;l+=128)for(var c=0;c<e.width;c+=128)for(var f=0;f<128;f+=8){var h=l+f;if(h>=e.height)break;for(var y=0;y<128;y+=8){var d=c+y;if(d>=e.width)break;if(a)a-=1;else{var p=h*e.width+d,v=this.layers[s],m=this.readBits(3);if(0==m){var b=this.readBits(5),w=_t.subarray(8*b,8*b+8);v.set(w,p),v.set(w,p+320),v.set(w,p+640),v.set(w,p+960),v.set(w,p+1280),v.set(w,p+1600),v.set(w,p+1920),v.set(w,p+2240)}else if(1==m){b=this.readBits(13),w=ct.subarray(8*b,8*b+8);v.set(w,p),v.set(w,p+320),v.set(w,p+640),v.set(w,p+960),v.set(w,p+1280),v.set(w,p+1600),v.set(w,p+1920),v.set(w,p+2240)}else if(2==m){var g=this.readBits(5),F=_t.subarray(8*g,8*g+8),x=At.subarray(8*g,8*g+8);v.set(F,p),v.set(x,p+320),v.set(F,p+640),v.set(x,p+960),v.set(F,p+1280),v.set(x,p+1600),v.set(F,p+1920),v.set(x,p+2240)}else if(3==m){g=this.readBits(13),F=ct.subarray(8*g,8*g+8),x=gt.subarray(8*g,8*g+8);v.set(F,p),v.set(x,p+320),v.set(F,p+640),v.set(x,p+960),v.set(F,p+1280),v.set(x,p+1600),v.set(F,p+1920),v.set(x,p+2240)}else if(4==m)for(var _=this.readBits(8),A=0;A<8;A++)if(_&1<<A){b=this.readBits(5),w=_t.subarray(8*b,8*b+8);v.set(w,p+320*A)}else{b=this.readBits(13),w=ct.subarray(8*b,8*b+8);v.set(w,p+320*A)}else{if(5==m){a=this.readBits(5);continue}if(7==m){var P=this.readBits(2);F=void 0,x=void 0;if(this.readBits(1)){var E=this.readBits(5),z=this.readBits(5);F=_t.subarray(8*E,8*E+8),x=_t.subarray(8*z,8*z+8),P=(P+1)%4}else{E=this.readBits(13),z=this.readBits(13);F=ct.subarray(8*E,8*E+8),x=ct.subarray(8*z,8*z+8)}0==P?(v.set(F,p),v.set(x,p+320),v.set(F,p+640),v.set(x,p+960),v.set(F,p+1280),v.set(x,p+1600),v.set(F,p+1920),v.set(x,p+2240)):1==P?(v.set(F,p),v.set(F,p+320),v.set(x,p+640),v.set(F,p+960),v.set(F,p+1280),v.set(x,p+1600),v.set(F,p+1920),v.set(F,p+2240)):2==P?(v.set(F,p),v.set(x,p+320),v.set(F,p+640),v.set(F,p+960),v.set(x,p+1280),v.set(F,p+1600),v.set(F,p+1920),v.set(x,p+2240)):3==P&&(v.set(F,p),v.set(x,p+320),v.set(x,p+640),v.set(F,p+960),v.set(x,p+1280),v.set(x,p+1600),v.set(F,p+1920),v.set(x,p+2240))}}}}}}}return this.prevDecodedFrame=t,this.layers},e.prototype.getFramePaletteIndices=function(t){var e=this.frameMeta[t].flags;return[15&e,e>>8&15,e>>12&15,e>>16&15,e>>20&15,e>>24&15,e>>28&15]},e.prototype.getFramePalette=function(t){var e=this;return this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},e.prototype.getLayerPixels=function(t,n){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),i=this.layers[n],o=new Uint8Array(e.width*e.height),s=2*n+1,u=0;u<i.length;u++){var a=i[u];1===a?o[u]=r[s]:2===a&&(o[u]=r[s+1])}return o},e.prototype.getFramePixels=function(t){this.prevDecodedFrame!==t&&this.decodeFrame(t);var n=this.getFramePaletteIndices(t),r=new Uint8Array(e.width*e.height);r.fill(n[0]);for(var i=this.getLayerOrder(t),o=this.layers[i[2]],s=this.layers[i[1]],u=this.layers[i[0]],a=n[1],l=n[2],c=n[3],f=n[4],h=n[5],y=n[6],d=0;d<r.length;d++){var p=o[d],v=s[d],m=u[d];1===p?r[d]=a:2===p?r[d]=l:1===v?r[d]=c:2===v?r[d]=f:1===m?r[d]=h:2===m&&(r[d]=y)}return r},e.prototype.decodeSoundFlags=function(){return this.frameMeta.map((function(t){var e=t.soundFlags;return[0!=(1&e),0!=(2&e),0!=(4&e),0!=(8&e)]}))},e.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta[t];return new Uint8Array(this.buffer,e.offset,e.length)},e.prototype.decodeAudioTrack=function(t){for(var e,n,r,i=this.getAudioTrackRaw(t),o=new Int16Array(981840),s=0,u=0,a=40,l=0;l<i.length;l++)for(var c=i[l],f=0;f<8;)a<18||6==f?(n=u+et[(e=c>>f&3)+4*a],r=a+J[e],f+=2):(n=u+ot[(e=c>>f&15)+16*a],r=a+Q[e],f+=4),r=X(r,0,79),n=X(n,-2047,2047),o[s]=16*n,s+=1,a=r,u=n;return o.slice(0,s)},e.prototype.getAudioTrackPcm=function(t,e){void 0===e&&(e=32768);var n=this.decodeAudioTrack(t),r=this.rawSampleRate;if(t===H.BGM){var i=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*i}return r!==e?q(n,r,e):n},e.prototype.getAudioMasterPcm=function(t){void 0===t&&(t=32768);var e=this.frameCount*(1/this.framerate),n=Math.floor(e*t),r=new Int16Array(n),i=this.hasAudioTrack(H.BGM),o=this.hasAudioTrack(H.SE1),s=this.hasAudioTrack(H.SE2),u=this.hasAudioTrack(H.SE3),a=this.hasAudioTrack(H.SE4);i&&Z(this.getAudioTrackPcm(H.BGM,t),r,0);if(o||s||u)for(var l=Math.floor(t/this.framerate),c=this.decodeSoundFlags(),f=o?this.getAudioTrackPcm(H.SE1,t):null,h=s?this.getAudioTrackPcm(H.SE2,t):null,y=u?this.getAudioTrackPcm(H.SE3,t):null,d=a?this.getAudioTrackPcm(H.SE4,t):null,p=0;p<this.frameCount;p++){var v=l*p,m=c[p];o&&m[0]&&Z(f,r,v),s&&m[1]&&Z(h,r,v),u&&m[2]&&Z(y,r,v),a&&m[3]&&Z(d,r,v)}return r},e.type="KWZ",e.width=320,e.height=240,e.rawSampleRate=16364,e.sampleRate=32768,e.globalPalette=[Et.WHITE,Et.BLACK,Et.RED,Et.YELLOW,Et.GREEN,Et.BLUE,Et.NONE],e}(K);function Rt(t){return function(t){return new Promise((function(e,n){N.forEach((function(r){r.matches(t)&&r.load(t,e,n)}))}))}(t).then((function(t){return new Promise((function(e,n){var r=new Uint8Array(t.slice(0,4)),i=r[0]<<24|r[1]<<16|r[2]<<8|r[3];1346458177===i?e(new lt(t)):1262897152==(4294967040&i)?e(new zt(t)):n()}))}))}var Ut=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],Ct=function(){function t(t,e,n,r){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.pixels=n,this.colorDepth=r,this.initCodeSize=Math.max(2,this.colorDepth),this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.a_count,this.remaining,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}return t.prototype.char_out=function(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var e=0;e<t;++e)this.htab[e]=-1},t.prototype.compress=function(t,e){var n,r,i,o,s,u;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,o=this.nextPixel(),u=0,n=5003;n<65536;n*=2)++u;u=8-u,this.cl_hash(5003),this.output(this.ClearCode,e);t:for(;-1!=(r=this.nextPixel());)if(n=(r<<12)+o,i=r<<u^o,this.htab[i]!==n){if(this.htab[i]>=0){s=5003-i,0===i&&(s=1);do{if((i-=s)<0&&(i+=5003),this.htab[i]===n){o=this.codetab[i];continue t}}while(this.htab[i]>=0)}this.output(o,e),o=r,this.free_ent<4096?(this.codetab[i]=this.free_ent++,this.htab[i]=n):this.cl_block(e)}else o=this.codetab[i];this.output(o,e),this.output(this.EOFCode,e)},t.prototype.encode=function(t){t.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,t),t.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,e){for(this.cur_accum&=Ut[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}},t}(),St=function(){function t(e,n,r){void 0===r&&(r={}),this.palette=[],this.width=e,this.height=n,this.data=new Y,this.meta=W(W({},t.defaultMeta),r)}return t.fromFlipnote=function(e,n){void 0===n&&(n={});var r=new t(e.width,e.height,W({delay:100/e.framerate,repeat:e.meta.loop?-1:0},n));r.palette=e.globalPalette,r.init();for(var i=0;i<e.frameCount;i++)r.writeFrame(e.getFramePixels(i));return r},t.fromFlipnoteFrame=function(e,n,r){void 0===r&&(r={});var i=new t(e.width,e.height,W({delay:100/e.framerate,repeat:-1},r));return i.palette=e.globalPalette,i.init(),i.writeFrame(e.getFramePixels(n)),i},t.prototype.init=function(){for(var t=this.palette.length,e=1;1<<e<t;e+=1)continue;this.meta.colorDepth=e,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt()},t.prototype.writeHeader=function(){var t=new V(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.meta.colorDepth-1),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.meta.colorDepth)),e=0,n=0;n<this.palette.length;n+=1){var r=this.palette[n],i=r[0],o=r[1],s=r[2];r[3];t[e++]=i,t[e++]=o,t[e++]=s}this.data.writeBytes(t)},t.prototype.writeGraphicsControlExt=function(){var t=new V(new ArrayBuffer(8)),e=this.meta.transparentBg?1:0;t.writeBytes([33,249,4,0|e]),t.writeUint16(this.meta.delay),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeNetscapeExt=function(){var t=new V(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.meta.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeImageDesc=function(){var t=new V(new ArrayBuffer(10));t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writePixels=function(t){new Ct(this.width,this.height,t,this.meta.colorDepth).encode(this.data)},t.prototype.writeFrame=function(t){this.writeGraphicsControlExt(),this.writeImageDesc(),this.writePixels(t)},t.prototype.getBuffer=function(){return this.data.getBuffer()},t.prototype.getBlob=function(){return new Blob([this.getBuffer()],{type:"image/gif"})},t.prototype.getUrl=function(){return window.URL.createObjectURL(this.getBlob())},t.prototype.getImage=function(){var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},t.defaultMeta={transparentBg:!1,delay:100,repeat:-1,colorDepth:8},t}(),kt=function(){function t(t,e,n){void 0===e&&(e=1),void 0===n&&(n=16),this.sampleRate=t,this.channels=e,this.bitsPerSample=n;var r=new ArrayBuffer(44),i=new V(r);i.writeChars("RIFF"),i.writeUint32(0),i.writeChars("WAVE"),i.writeChars("fmt "),i.writeUint32(16),i.writeUint16(1),i.writeUint16(this.channels),i.writeUint32(this.sampleRate),i.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),i.writeUint16(this.bitsPerSample*this.channels/8),i.writeUint16(this.bitsPerSample),i.writeChars("data"),i.writeUint32(0),this.header=i,this.pcmData=null}return t.fromFlipnote=function(e){var n=e.sampleRate,r=new t(n,1,16),i=e.getAudioMasterPcm(n);return r.writeFrames(i),r},t.fromFlipnoteTrack=function(e,n){var r=e.sampleRate,i=new t(r,1,16),o=e.getAudioTrackPcm(n,r);return i.writeFrames(o),i},t.prototype.writeFrames=function(t){var e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t},t.prototype.getBlob=function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})},t}();const Tt={};{const t=Tt;t[5120]=Int8Array,t[5121]=Uint8Array,t[5122]=Int16Array,t[5123]=Uint16Array,t[5124]=Int32Array,t[5125]=Uint32Array,t[5126]=Float32Array,t[32819]=Uint16Array,t[32820]=Uint16Array,t[33635]=Uint16Array,t[5131]=Uint16Array,t[33640]=Uint32Array,t[35899]=Uint32Array,t[35902]=Uint32Array,t[36269]=Uint32Array,t[34042]=Uint32Array}function It(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const Bt="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function Mt(...t){console.error(...t)}function Ot(t,e){return"undefined"!=typeof WebGLRenderbuffer&&e instanceof WebGLRenderbuffer}function Lt(t,e){return"undefined"!=typeof WebGLTexture&&e instanceof WebGLTexture}const jt="";function Dt(t,e,n,r){if(i=e,"undefined"!=typeof WebGLBuffer&&i instanceof WebGLBuffer)return e;var i;n=n||34962;const o=t.createBuffer();return function(t,e,n,r,i){t.bindBuffer(e,n),t.bufferData(e,r,i||35044)}(t,n,o,e,r),o}function Wt(t){return"indices"===t}const Gt=/coord|texture/i,$t=/color|colour/i;function Nt(t,e){let n;if(n=Gt.test(t)?2:$t.test(t)?4:3,e%n>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${n} but ${e} values is not evenly divisible by ${n}. You should specify it.`);return n}function Ht(t,e){if(Bt(t))return t;if(Bt(t.data))return t.data;Array.isArray(t)&&(t={data:t});let n=t.type;return n||(n=Wt(e)?Uint16Array:Float32Array),new n(t.data)}function Yt(t,e){const n={};return Object.keys(e).forEach((function(r){if(!Wt(r)){const o=e[r],s=o.attrib||o.name||o.attribName||jt+r;if(o.value){if(!Array.isArray(o.value)&&!Bt(o.value))throw new Error("array.value is not array or typedarray");n[s]={value:o.value}}else{let e,u,a,l;if(o.buffer&&o.buffer instanceof WebGLBuffer)e=o.buffer,l=o.numComponents||o.size,u=o.type,a=o.normalize;else if("number"==typeof o||"number"==typeof o.data){const n=o.data||o,s=o.type||Float32Array,c=n*s.BYTES_PER_ELEMENT;u=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(s),a=void 0!==o.normalize?o.normalize:(i=s)===Int8Array||i===Uint8Array,l=o.numComponents||o.size||Nt(r,n),e=t.createBuffer(),t.bindBuffer(34962,e),t.bufferData(34962,c,o.drawType||35044)}else{const n=Ht(o,r);e=Dt(t,n,void 0,o.drawType),u=It(n),a=void 0!==o.normalize?o.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(n),l=function(t,e){return t.numComponents||t.size||Nt(e,function(t){return t.length?t:t.data}(t).length)}(o,r)}n[s]={buffer:e,numComponents:l,type:u,normalize:a,stride:o.stride||0,offset:o.offset||0,divisor:void 0===o.divisor?void 0:o.divisor,drawType:o.drawType}}}var i})),t.bindBuffer(34962,null),n}const Vt=["position","positions","a_position"];function Kt(t,e,n){const r=Yt(t,e),i=Object.assign({},n||{});i.attribs=Object.assign({},n?n.attribs:{},r);const o=e.indices;if(o){const e=Ht(o,"indices");i.indices=Dt(t,e,34963),i.numElements=e.length,i.elementType=It(e)}else i.numElements||(i.numElements=function(t,e){let n,r;for(r=0;r<Vt.length&&(n=Vt[r],!(n in e))&&(n=jt+n,!(n in e));++r);r===Vt.length&&(n=Object.keys(e)[0]);const i=e[n];t.bindBuffer(34962,i.buffer);const o=t.getBufferParameter(34962,34660);var s;t.bindBuffer(34962,null);const u=o/(5120===(s=i.type)||5121===s?1:5122===s||5123===s?2:5124===s||5125===s||5126===s?4:0),a=i.numComponents||i.size,l=u/a;if(l%1!=0)throw new Error(`numComponents ${a} not correct for length ${length}`);return l}(t,i.attribs));return i}function Xt(t){return!!t.texStorage2D}const qt=function(){const t={},e={};return function(n,r){return function(n){const r=n.constructor.name;if(!t[r]){for(const t in n)if("number"==typeof n[t]){const r=e[n[t]];e[n[t]]=r?`${r} | ${t}`:t}t[r]=!0}}(n),e[r]||"0x"+r.toString(16)}}(),Zt={textureColor:new Uint8Array([128,192,255,255]),textureOptions:{},crossOrigin:void 0},Jt=Bt;let Qt;function te(){return Qt=Qt||("undefined"!=typeof document&&document.createElement?document.createElement("canvas").getContext("2d"):null),Qt}const ee=6407,ne=33319;let re;function ie(t){if(!re){const t={6406:{textureFormat:6406,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1,2,2,4],type:[5121,5131,36193,5126]},6409:{textureFormat:6409,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1,2,2,4],type:[5121,5131,36193,5126]},6410:{textureFormat:6410,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[2,4,4,8],type:[5121,5131,36193,5126]}};t[ee]={textureFormat:ee,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3,6,6,12,2],type:[5121,5131,36193,5126,33635]},t[6408]={textureFormat:6408,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,8,8,16,2,2],type:[5121,5131,36193,5126,32819,32820]},t[33321]={textureFormat:6403,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1],type:[5121]},t[36756]={textureFormat:6403,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[1],type:[5120]},t[33325]={textureFormat:6403,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[4,2],type:[5126,5131]},t[33326]={textureFormat:6403,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[4],type:[5126]},t[33330]={textureFormat:36244,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[1],type:[5121]},t[33329]={textureFormat:36244,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[1],type:[5120]},t[33332]={textureFormat:36244,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[5123]},t[33331]={textureFormat:36244,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[5122]},t[33334]={textureFormat:36244,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[5125]},t[33333]={textureFormat:36244,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[5124]},t[33323]={textureFormat:ne,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[2],type:[5121]},t[36757]={textureFormat:ne,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[2],type:[5120]},t[33327]={textureFormat:ne,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[8,4],type:[5126,5131]},t[33328]={textureFormat:ne,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[8],type:[5126]},t[33336]={textureFormat:33320,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[5121]},t[33335]={textureFormat:33320,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[5120]},t[33338]={textureFormat:33320,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[5123]},t[33337]={textureFormat:33320,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[5122]},t[33340]={textureFormat:33320,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[5125]},t[33339]={textureFormat:33320,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[5124]},t[32849]={textureFormat:ee,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3],type:[5121]},t[35905]={textureFormat:ee,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[3],type:[5121]},t[36194]={textureFormat:ee,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3,2],type:[5121,33635]},t[36758]={textureFormat:ee,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[3],type:[5120]},t[35898]={textureFormat:ee,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6,4],type:[5126,5131,35899]},t[35901]={textureFormat:ee,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6,4],type:[5126,5131,35902]},t[34843]={textureFormat:ee,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6],type:[5126,5131]},t[34837]={textureFormat:ee,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[5126]},t[36221]={textureFormat:36248,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[3],type:[5121]},t[36239]={textureFormat:36248,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[3],type:[5120]},t[36215]={textureFormat:36248,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[6],type:[5123]},t[36233]={textureFormat:36248,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[6],type:[5122]},t[36209]={textureFormat:36248,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[5125]},t[36227]={textureFormat:36248,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[5124]},t[32856]={textureFormat:6408,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[5121]},t[35907]={textureFormat:6408,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[5121]},t[36759]={textureFormat:6408,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[4],type:[5120]},t[32855]={textureFormat:6408,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,2,4],type:[5121,32820,33640]},t[32854]={textureFormat:6408,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,2],type:[5121,32819]},t[32857]={textureFormat:6408,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[33640]},t[34842]={textureFormat:6408,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[16,8],type:[5126,5131]},t[34836]={textureFormat:6408,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[16],type:[5126]},t[36220]={textureFormat:36249,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[5121]},t[36238]={textureFormat:36249,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[5120]},t[36975]={textureFormat:36249,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[33640]},t[36214]={textureFormat:36249,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[5123]},t[36232]={textureFormat:36249,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[5122]},t[36226]={textureFormat:36249,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[16],type:[5124]},t[36208]={textureFormat:36249,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[16],type:[5125]},t[33189]={textureFormat:6402,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2,4],type:[5123,5125]},t[33190]={textureFormat:6402,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[5125]},t[36012]={textureFormat:6402,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[5126]},t[35056]={textureFormat:34041,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[34042]},t[36013]={textureFormat:34041,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[36269]},Object.keys(t).forEach((function(e){const n=t[e];n.bytesPerElementMap={},n.bytesPerElement.forEach((function(t,e){const r=n.type[e];n.bytesPerElementMap[r]=t}))})),re=t}return re[t]}function oe(t){const e=ie(t);if(!e)throw"unknown internal format";return{format:e.textureFormat,type:e.type[0]}}function se(t){return 0==(t&t-1)}function ue(t,e,n){return Jt(e)?It(e):n||5121}function ae(t,e,n,r,i){if(i%1!=0)throw"can't guess dimensions";if(n||r){if(r){if(!n&&(n=i/r)%1)throw"can't guess dimensions"}else if((r=i/n)%1)throw"can't guess dimensions"}else{const t=Math.sqrt(i/(34067===e?6:1));t%1==0?(n=t,r=t):(n=i,r=1)}return{width:n,height:r}}const le={};function ce(t,e){void 0!==e.colorspaceConversion&&(le.colorspaceConversion=t.getParameter(37443),t.pixelStorei(37443,e.colorspaceConversion)),void 0!==e.premultiplyAlpha&&(le.premultiplyAlpha=t.getParameter(37441),t.pixelStorei(37441,e.premultiplyAlpha)),void 0!==e.flipY&&(le.flipY=t.getParameter(37440),t.pixelStorei(37440,e.flipY))}function fe(t,e){void 0!==e.colorspaceConversion&&t.pixelStorei(37443,le.colorspaceConversion),void 0!==e.premultiplyAlpha&&t.pixelStorei(37441,le.premultiplyAlpha),void 0!==e.flipY&&t.pixelStorei(37440,le.flipY)}function he(t){le.unpackAlignment=t.getParameter(3317),Xt(t)&&(le.unpackRowLength=t.getParameter(3314),le.unpackImageHeight=t.getParameter(32878),le.unpackSkipPixels=t.getParameter(3316),le.unpackSkipRows=t.getParameter(3315),le.unpackSkipImages=t.getParameter(32877))}function ye(t){t.pixelStorei(3317,le.unpackAlignment),Xt(t)&&(t.pixelStorei(3314,le.unpackRowLength),t.pixelStorei(32878,le.unpackImageHeight),t.pixelStorei(3316,le.unpackSkipPixels),t.pixelStorei(3315,le.unpackSkipRows),t.pixelStorei(32877,le.unpackSkipImages))}function de(t,e,n,r){var i;r.minMag&&(n.call(t,e,10241,r.minMag),n.call(t,e,10240,r.minMag)),r.min&&n.call(t,e,10241,r.min),r.mag&&n.call(t,e,10240,r.mag),r.wrap&&(n.call(t,e,10242,r.wrap),n.call(t,e,10243,r.wrap),(32879===e||(i=e,"undefined"!=typeof WebGLSampler&&i instanceof WebGLSampler))&&n.call(t,e,32882,r.wrap)),r.wrapR&&n.call(t,e,32882,r.wrapR),r.wrapS&&n.call(t,e,10242,r.wrapS),r.wrapT&&n.call(t,e,10243,r.wrapT),r.minLod&&n.call(t,e,33082,r.minLod),r.maxLod&&n.call(t,e,33083,r.maxLod),r.baseLevel&&n.call(t,e,33084,r.baseLevel),r.maxLevel&&n.call(t,e,33085,r.maxLevel)}function pe(t,e,n){const r=n.target||3553;t.bindTexture(r,e),de(t,r,t.texParameteri,n)}function ve(t,e,n,r,i,o){o=o||6408;const s=(n=n||Zt.textureOptions).target||3553;if(r=r||n.width,i=i||n.height,t.bindTexture(s,e),function(t,e,n,r){if(!Xt(t))return se(e)&&se(n);const i=ie(r);if(!i)throw"unknown internal format";return i.colorRenderable&&i.textureFilterable}(t,r,i,o))t.generateMipmap(s);else{const e=function(t){const e=ie(t);if(!e)throw"unknown internal format";return e.textureFilterable}(o)?9729:9728;t.texParameteri(s,10241,e),t.texParameteri(s,10240,e),t.texParameteri(s,10242,33071),t.texParameteri(s,10243,33071)}}function me(t){return!0===t.auto||void 0===t.auto&&void 0===t.level}function be(t,e){return(e=e||{}).cubeFaceOrder||[34069,34070,34071,34072,34073,34074]}function we(t,e){const n=be(0,e).map((function(t,e){return{face:t,ndx:e}}));return n.sort((function(t,e){return t.face-e.face})),n}function ge(t,e,n,r){const i=(r=r||Zt.textureOptions).target||3553,o=r.level||0;let s=n.width,u=n.height;const a=r.internalFormat||r.format||6408,l=oe(a),c=r.format||l.format,f=r.type||l.type;if(ce(t,r),t.bindTexture(i,e),34067===i){const l=n.width,h=n.height;let y,d;if(l/6===h)y=h,d=[0,0,1,0,2,0,3,0,4,0,5,0];else if(h/6===l)y=l,d=[0,0,0,1,0,2,0,3,0,4,0,5];else if(l/3==h/2)y=l/3,d=[0,0,1,0,2,0,0,1,1,1,2,1];else{if(l/2!=h/3)throw"can't figure out cube map from element: "+(n.src?n.src:n.nodeName);y=l/2,d=[0,0,1,0,0,1,1,1,0,2,1,2]}const p=te();p?(p.canvas.width=y,p.canvas.height=y,s=y,u=y,we(0,r).forEach((function(e){const r=d[2*e.ndx+0]*y,i=d[2*e.ndx+1]*y;p.drawImage(n,r,i,y,y,0,0,y,y),t.texImage2D(e.face,o,a,c,f,p.canvas)})),p.canvas.width=1,p.canvas.height=1):"undefined"!=typeof createImageBitmap&&(s=y,u=y,we(0,r).forEach((function(l){const h=d[2*l.ndx+0]*y,p=d[2*l.ndx+1]*y;t.texImage2D(l.face,o,a,y,y,0,c,f,null),createImageBitmap(n,h,p,y,y,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then((function(n){ce(t,r),t.bindTexture(i,e),t.texImage2D(l.face,o,a,c,f,n),fe(t,r),me(r)&&ve(t,e,r,s,u,a)}))})))}else if(32879===i||35866===i){const e=Math.min(n.width,n.height),r=Math.max(n.width,n.height),s=r/e;if(s%1!=0)throw"can not compute 3D dimensions of element";const u=n.width===r?1:0,l=n.height===r?1:0;he(t),t.pixelStorei(3317,1),t.pixelStorei(3314,n.width),t.pixelStorei(32878,0),t.pixelStorei(32877,0),t.texImage3D(i,o,a,e,e,e,0,c,f,null);for(let r=0;r<s;++r){const s=r*e*u,a=r*e*l;t.pixelStorei(3316,s),t.pixelStorei(3315,a),t.texSubImage3D(i,o,0,0,r,e,e,1,c,f,n)}ye(t)}else t.texImage2D(i,o,a,c,f,n);fe(t,r),me(r)&&ve(t,e,r,s,u,a),pe(t,e,r)}function Fe(){}function xe(t,e){return void 0!==e||function(t){if("undefined"!=typeof document){const e=document.createElement("a");return e.href=t,e.hostname===location.hostname&&e.port===location.port&&e.protocol===location.protocol}{const e=new URL(location.href).origin;return new URL(t,location.href).origin===e}}(t)?e:"anonymous"}function _e(t){return"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof ImageData&&t instanceof ImageData||"undefined"!=typeof HTMLElement&&t instanceof HTMLElement}function Ae(t,e,n){return _e(t)?(setTimeout((function(){n(null,t)})),t):function(t,e,n){let r;if(n=n||Fe,e=xe(t,e=void 0!==e?e:Zt.crossOrigin),"undefined"!=typeof Image){r=new Image,void 0!==e&&(r.crossOrigin=e);const i=function(){r.removeEventListener("error",o),r.removeEventListener("load",s),r=null},o=function(){const e="couldn't load image: "+t;Mt(e),n(e,r),i()},s=function(){n(null,r),i()};return r.addEventListener("error",o),r.addEventListener("load",s),r.src=t,r}if("undefined"!=typeof ImageBitmap){let i,o;const s=function(){n(i,o)},u={};e&&(u.mode="cors"),fetch(t,u).then((function(t){if(!t.ok)throw t;return t.blob()})).then((function(t){return createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"})})).then((function(t){o=t,setTimeout(s)})).catch((function(t){i=t,setTimeout(s)})),r=null}return r}(t,e,n)}function Pe(t,e,n){const r=(n=n||Zt.textureOptions).target||3553;if(t.bindTexture(r,e),!1===n.color)return;const i=function(t){return Jt(t=t||Zt.textureColor)?t:new Uint8Array([255*t[0],255*t[1],255*t[2],255*t[3]])}(n.color);if(34067===r)for(let e=0;e<6;++e)t.texImage2D(34069+e,0,6408,1,1,0,6408,5121,i);else 32879===r||35866===r?t.texImage3D(r,0,6408,1,1,1,0,6408,5121,i):t.texImage2D(r,0,6408,1,1,0,6408,5121,i)}function Ee(t,e,n,r){r=r||Fe;const i=n.src;if(6!==i.length)throw"there must be 6 urls for a cubemap";const o=n.level||0,s=n.internalFormat||n.format||6408,u=oe(s),a=n.format||u.format,l=n.type||5121,c=n.target||3553;if(34067!==c)throw"target must be TEXTURE_CUBE_MAP";Pe(t,e,n),n=Object.assign({},n);let f=6;const h=[],y=be(0,n);let d;d=i.map((function(i,u){return Ae(i,n.crossOrigin,(p=y[u],function(i,u){--f,i?h.push(i):u.width!==u.height?h.push("cubemap face img is not a square: "+u.src):(ce(t,n),t.bindTexture(c,e),5===f?be().forEach((function(e){t.texImage2D(e,o,s,a,l,u)})):t.texImage2D(p,o,s,a,l,u),fe(t,n),me(n)&&t.generateMipmap(c)),0===f&&r(h.length?h:void 0,e,d)}));var p}))}function ze(t,e,n,r){r=r||Fe;const i=n.src,o=n.internalFormat||n.format||6408,s=oe(o),u=n.format||s.format,a=n.type||5121,l=n.target||35866;if(32879!==l&&35866!==l)throw"target must be TEXTURE_3D or TEXTURE_2D_ARRAY";Pe(t,e,n),n=Object.assign({},n);let c=i.length;const f=[];let h;const y=n.level||0;let d=n.width,p=n.height;const v=i.length;let m=!0;h=i.map((function(i,s){return Ae(i,n.crossOrigin,(b=s,function(i,s){if(--c,i)f.push(i);else{if(ce(t,n),t.bindTexture(l,e),m){m=!1,d=n.width||s.width,p=n.height||s.height,t.texImage3D(l,y,o,d,p,v,0,u,a,null);for(let e=0;e<v;++e)t.texSubImage3D(l,y,0,0,e,d,p,1,u,a,s)}else{let e,n=s;s.width===d&&s.height===p||(e=te(),n=e.canvas,e.canvas.width=d,e.canvas.height=p,e.drawImage(s,0,0,d,p)),t.texSubImage3D(l,y,0,0,b,d,p,1,u,a,n),e&&n===e.canvas&&(e.canvas.width=0,e.canvas.height=0)}fe(t,n),me(n)&&t.generateMipmap(l)}0===c&&r(f.length?f:void 0,e,h)}));var b}))}function Re(t,e,n,r){const i=(r=r||Zt.textureOptions).target||3553;t.bindTexture(i,e);let o=r.width,s=r.height,u=r.depth;const a=r.level||0,l=r.internalFormat||r.format||6408,c=oe(l),f=r.format||c.format,h=r.type||ue(0,n,c.type);if(Jt(n))n instanceof Uint8ClampedArray&&(n=new Uint8Array(n.buffer));else{const t=function(t){const e=Tt[t];if(!e)throw new Error("unknown gl type");return e}(h);n=new t(n)}const y=function(t,e){const n=ie(t);if(!n)throw"unknown internal format";const r=n.bytesPerElementMap[e];if(void 0===r)throw"unknown internal format";return r}(l,h),d=n.byteLength/y;if(d%1)throw"length wrong size for format: "+qt(t,f);let p;if(32879===i||35866===i)if(o||s||u)!o||s&&u?!s||o&&u?(p=ae(0,i,o,s,d/u),o=p.width,s=p.height):(p=ae(0,i,o,u,d/s),o=p.width,u=p.height):(p=ae(0,i,s,u,d/o),s=p.width,u=p.height);else{const t=Math.cbrt(d);if(t%1!=0)throw"can't guess cube size of array of numElements: "+d;o=t,s=t,u=t}else p=ae(0,i,o,s,d),o=p.width,s=p.height;if(he(t),t.pixelStorei(3317,r.unpackAlignment||1),ce(t,r),34067===i){const e=d/6*(y/n.BYTES_PER_ELEMENT);we(0,r).forEach(r=>{const i=e*r.ndx,u=n.subarray(i,i+e);t.texImage2D(r.face,a,l,o,s,0,f,h,u)})}else 32879===i||35866===i?t.texImage3D(i,a,l,o,s,u,0,f,h,n):t.texImage2D(i,a,l,o,s,0,f,h,n);return fe(t,r),ye(t),{width:o,height:s,depth:u,type:h}}function Ue(t,e,n){n=n||Fe,e=e||Zt.textureOptions;const r=t.createTexture(),i=e.target||3553;let o=e.width||1,s=e.height||1;const u=e.internalFormat||6408;t.bindTexture(i,r),34067===i&&(t.texParameteri(i,10242,33071),t.texParameteri(i,10243,33071));let a=e.src;if(a)if("function"==typeof a&&(a=a(t,e)),"string"==typeof a)!function(t,e,n,r){r=r||Fe,Pe(t,e,n=n||Zt.textureOptions),Ae((n=Object.assign({},n)).src,n.crossOrigin,(function(i,o){i?r(i,e,o):(ge(t,e,o,n),r(null,e,o))}))}(t,r,e,n);else if(Jt(a)||Array.isArray(a)&&("number"==typeof a[0]||Array.isArray(a[0])||Jt(a[0]))){const n=Re(t,r,a,e);o=n.width,s=n.height}else Array.isArray(a)&&("string"==typeof a[0]||_e(a[0]))?34067===i?Ee(t,r,e,n):ze(t,r,e,n):(ge(t,r,a,e),o=a.width,s=a.height);else!function(t,e,n){const r=n.target||3553;t.bindTexture(r,e);const i=n.level||0,o=n.internalFormat||n.format||6408,s=oe(o),u=n.format||s.format,a=n.type||s.type;if(ce(t,n),34067===r)for(let e=0;e<6;++e)t.texImage2D(34069+e,i,o,n.width,n.height,0,u,a,null);else 32879===r||35866===r?t.texImage3D(r,i,o,n.width,n.height,n.depth,0,u,a,null):t.texImage2D(r,i,o,n.width,n.height,0,u,a,null);fe(t,n)}(t,r,e);return me(e)&&ve(t,r,e,o,s,u),pe(t,r,e),r}function Ce(t,e,n,r,i,o){r=r||n.width,i=i||n.height,o=o||n.depth;const s=n.target||3553;t.bindTexture(s,e);const u=n.level||0,a=n.internalFormat||n.format||6408,l=oe(a),c=n.format||l.format;let f;const h=n.src;if(f=h&&(Jt(h)||Array.isArray(h)&&"number"==typeof h[0])?n.type||ue(0,h,l.type):n.type||l.type,34067===s)for(let e=0;e<6;++e)t.texImage2D(34069+e,u,a,r,i,0,c,f,null);else 32879===s||35866===s?t.texImage3D(s,u,a,r,i,o,0,c,f,null):t.texImage2D(s,u,a,r,i,0,c,f,null)}const Se=Mt;function ke(t){return"undefined"!=typeof document&&document.getElementById?document.getElementById(t):null}const Te={};function Ie(t,e){return Te[e].bindPoint}function Be(t,e){return function(n){t.uniform1i(e,n)}}function Me(t,e){return function(n){t.uniform1iv(e,n)}}function Oe(t,e){return function(n){t.uniform2iv(e,n)}}function Le(t,e){return function(n){t.uniform3iv(e,n)}}function je(t,e){return function(n){t.uniform4iv(e,n)}}function De(t,e,n,r){const i=Ie(0,e);return Xt(t)?function(e){let o,s;Lt(0,e)?(o=e,s=null):(o=e.texture,s=e.sampler),t.uniform1i(r,n),t.activeTexture(33984+n),t.bindTexture(i,o),t.bindSampler(n,s)}:function(e){t.uniform1i(r,n),t.activeTexture(33984+n),t.bindTexture(i,e)}}function We(t,e,n,r,i){const o=Ie(0,e),s=new Int32Array(i);for(let t=0;t<i;++t)s[t]=n+t;return Xt(t)?function(e){t.uniform1iv(r,s),e.forEach((function(e,r){let i,u;t.activeTexture(33984+s[r]),Lt(0,e)?(i=e,u=null):(i=e.texture,u=e.sampler),t.bindSampler(n,u),t.bindTexture(o,i)}))}:function(e){t.uniform1iv(r,s),e.forEach((function(e,n){t.activeTexture(33984+s[n]),t.bindTexture(o,e)}))}}function Ge(t,e){return function(n){if(n.value)switch(t.disableVertexAttribArray(e),n.value.length){case 4:t.vertexAttrib4fv(e,n.value);break;case 3:t.vertexAttrib3fv(e,n.value);break;case 2:t.vertexAttrib2fv(e,n.value);break;case 1:t.vertexAttrib1fv(e,n.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,n.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,n.numComponents||n.size,n.type||5126,n.normalize||!1,n.stride||0,n.offset||0),void 0!==n.divisor&&t.vertexAttribDivisor(e,n.divisor)}}function $e(t,e){return function(n){if(n.value){if(t.disableVertexAttribArray(e),4!==n.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(e,n.value)}else t.bindBuffer(34962,n.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,n.numComponents||n.size,n.type||5124,n.stride||0,n.offset||0),void 0!==n.divisor&&t.vertexAttribDivisor(e,n.divisor)}}function Ne(t,e){return function(n){if(n.value){if(t.disableVertexAttribArray(e),4!==n.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(e,n.value)}else t.bindBuffer(34962,n.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,n.numComponents||n.size,n.type||5125,n.stride||0,n.offset||0),void 0!==n.divisor&&t.vertexAttribDivisor(e,n.divisor)}}function He(t,e,n){const r=n.size,i=n.count;return function(n){t.bindBuffer(34962,n.buffer);const o=n.size||n.numComponents||r,s=o/i,u=n.type||5126,a=Te[u].size*o,l=n.normalize||!1,c=n.offset||0,f=a/i;for(let r=0;r<i;++r)t.enableVertexAttribArray(e+r),t.vertexAttribPointer(e+r,s,u,l,a,c+f*r),void 0!==n.divisor&&t.vertexAttribDivisor(e+r,n.divisor)}}Te[5126]={Type:Float32Array,size:4,setter:function(t,e){return function(n){t.uniform1f(e,n)}},arraySetter:function(t,e){return function(n){t.uniform1fv(e,n)}}},Te[35664]={Type:Float32Array,size:8,setter:function(t,e){return function(n){t.uniform2fv(e,n)}}},Te[35665]={Type:Float32Array,size:12,setter:function(t,e){return function(n){t.uniform3fv(e,n)}}},Te[35666]={Type:Float32Array,size:16,setter:function(t,e){return function(n){t.uniform4fv(e,n)}}},Te[5124]={Type:Int32Array,size:4,setter:Be,arraySetter:Me},Te[35667]={Type:Int32Array,size:8,setter:Oe},Te[35668]={Type:Int32Array,size:12,setter:Le},Te[35669]={Type:Int32Array,size:16,setter:je},Te[5125]={Type:Uint32Array,size:4,setter:function(t,e){return function(n){t.uniform1ui(e,n)}},arraySetter:function(t,e){return function(n){t.uniform1uiv(e,n)}}},Te[36294]={Type:Uint32Array,size:8,setter:function(t,e){return function(n){t.uniform2uiv(e,n)}}},Te[36295]={Type:Uint32Array,size:12,setter:function(t,e){return function(n){t.uniform3uiv(e,n)}}},Te[36296]={Type:Uint32Array,size:16,setter:function(t,e){return function(n){t.uniform4uiv(e,n)}}},Te[35670]={Type:Uint32Array,size:4,setter:Be,arraySetter:Me},Te[35671]={Type:Uint32Array,size:8,setter:Oe},Te[35672]={Type:Uint32Array,size:12,setter:Le},Te[35673]={Type:Uint32Array,size:16,setter:je},Te[35674]={Type:Float32Array,size:16,setter:function(t,e){return function(n){t.uniformMatrix2fv(e,!1,n)}}},Te[35675]={Type:Float32Array,size:36,setter:function(t,e){return function(n){t.uniformMatrix3fv(e,!1,n)}}},Te[35676]={Type:Float32Array,size:64,setter:function(t,e){return function(n){t.uniformMatrix4fv(e,!1,n)}}},Te[35685]={Type:Float32Array,size:24,setter:function(t,e){return function(n){t.uniformMatrix2x3fv(e,!1,n)}}},Te[35686]={Type:Float32Array,size:32,setter:function(t,e){return function(n){t.uniformMatrix2x4fv(e,!1,n)}}},Te[35687]={Type:Float32Array,size:24,setter:function(t,e){return function(n){t.uniformMatrix3x2fv(e,!1,n)}}},Te[35688]={Type:Float32Array,size:48,setter:function(t,e){return function(n){t.uniformMatrix3x4fv(e,!1,n)}}},Te[35689]={Type:Float32Array,size:32,setter:function(t,e){return function(n){t.uniformMatrix4x2fv(e,!1,n)}}},Te[35690]={Type:Float32Array,size:48,setter:function(t,e){return function(n){t.uniformMatrix4x3fv(e,!1,n)}}},Te[35678]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:3553},Te[35680]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:34067},Te[35679]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:32879},Te[35682]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:3553},Te[36289]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:35866},Te[36292]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:35866},Te[36293]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:34067},Te[36298]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:3553},Te[36299]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:32879},Te[36300]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:34067},Te[36303]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:35866},Te[36306]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:3553},Te[36307]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:32879},Te[36308]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:34067},Te[36311]={Type:null,size:0,setter:De,arraySetter:We,bindPoint:35866};const Ye={};Ye[5126]={size:4,setter:Ge},Ye[35664]={size:8,setter:Ge},Ye[35665]={size:12,setter:Ge},Ye[35666]={size:16,setter:Ge},Ye[5124]={size:4,setter:$e},Ye[35667]={size:8,setter:$e},Ye[35668]={size:12,setter:$e},Ye[35669]={size:16,setter:$e},Ye[5125]={size:4,setter:Ne},Ye[36294]={size:8,setter:Ne},Ye[36295]={size:12,setter:Ne},Ye[36296]={size:16,setter:Ne},Ye[35670]={size:4,setter:$e},Ye[35671]={size:8,setter:$e},Ye[35672]={size:12,setter:$e},Ye[35673]={size:16,setter:$e},Ye[35674]={size:4,setter:He,count:2},Ye[35675]={size:9,setter:He,count:3},Ye[35676]={size:16,setter:He,count:4};const Ve=/^[ \t]*\n/;function Ke(t,e,n,r){const i=r||Se,o=t.createShader(n);let s=0;Ve.test(e)&&(s=1,e=e.replace(Ve,"")),t.shaderSource(o,e),t.compileShader(o);if(!t.getShaderParameter(o,35713)){const n=t.getShaderInfoLog(o);return i(function(t,e){return e=e||0,++e,t.split("\n").map((function(t,n){return n+e+": "+t})).join("\n")}(e,s)+"\n*** Error compiling shader: "+n),t.deleteShader(o),null}return o}function Xe(t,e,n){let r,i;if("function"==typeof e&&(n=e,e=void 0),"function"==typeof t)n=t,t=void 0;else if(t&&!Array.isArray(t)){if(t.errorCallback)return t;const e=t;n=e.errorCallback,t=e.attribLocations,r=e.transformFeedbackVaryings,i=e.transformFeedbackMode}const o={errorCallback:n||Se,transformFeedbackVaryings:r,transformFeedbackMode:i};if(t){let n={};Array.isArray(t)?t.forEach((function(t,r){n[t]=e?e[r]:r})):n=t,o.attribLocations=n}return o}const qe=["VERTEX_SHADER","FRAGMENT_SHADER"];function Ze(t,e){e.forEach((function(e){t.deleteShader(e)}))}function Je(t,e,n,r,i){const o=Xe(n,r,i),s=[];for(let n=0;n<e.length;++n){const r=Ke(t,e[n],t[qe[n]],o.errorCallback);if(!r)return null;s.push(r)}return function(t,e,n,r,i){const o=Xe(n,r,i),s=[],u=[];for(let n=0;n<e.length;++n){let r=e[n];if("string"==typeof r){const e=ke(r),i=e?e.text:r;let s=t[qe[n]];e&&e.type&&(s=((l=e.type).indexOf("frag")>=0?35632:l.indexOf("vert")>=0?35633:void 0)||s),r=Ke(t,i,s,o.errorCallback),u.push(r)}a=r,"undefined"!=typeof WebGLShader&&a instanceof WebGLShader&&s.push(r)}var a,l;if(s.length!==e.length)return o.errorCallback("not enough shaders for program"),Ze(t,u),null;const c=t.createProgram();s.forEach((function(e){t.attachShader(c,e)})),o.attribLocations&&Object.keys(o.attribLocations).forEach((function(e){t.bindAttribLocation(c,o.attribLocations[e],e)}));let f=o.transformFeedbackVaryings;if(f&&(f.attribs&&(f=f.attribs),Array.isArray(f)||(f=Object.keys(f)),t.transformFeedbackVaryings(c,f,o.transformFeedbackMode||35981)),t.linkProgram(c),!t.getProgramParameter(c,35714)){const e=t.getProgramInfoLog(c);return o.errorCallback("Error in program linking:"+e),t.deleteProgram(c),Ze(t,u),null}return c}(t,s,o)}function Qe(t){const e=t.name;return e.startsWith("gl_")||e.startsWith("webgl_")}function tn(t,e){const n=t.uniformSetters||t,r=arguments.length;for(let t=1;t<r;++t){const e=arguments[t];if(Array.isArray(e)){const t=e.length;for(let r=0;r<t;++r)tn(n,e[r])}else for(const t in e){const r=n[t];r&&r(e[t])}}}function en(t,e,n){n.vertexArrayObject?t.bindVertexArray(n.vertexArrayObject):(!function(t,e){for(const n in e){const r=t[n];r&&r(e[n])}}(e.attribSetters||e,n.attribs),n.indices&&t.bindBuffer(34963,n.indices))}function nn(t,e){const n={program:e,uniformSetters:function(t,e){let n=0;function r(e,r,i){const o=r.size>1&&"[0]"===r.name.substr(-3),s=r.type,u=Te[s];if(!u)throw new Error("unknown type: 0x"+s.toString(16));let a;if(u.bindPoint){const e=n;n+=r.size,a=o?u.arraySetter(t,s,e,i,r.size):u.setter(t,s,e,i,r.size)}else a=u.arraySetter&&o?u.arraySetter(t,i):u.setter(t,i);return a.location=i,a}const i={},o=t.getProgramParameter(e,35718);for(let n=0;n<o;++n){const o=t.getActiveUniform(e,n);if(Qe(o))continue;let s=o.name;"[0]"===s.substr(-3)&&(s=s.substr(0,s.length-3));const u=t.getUniformLocation(e,o.name);u&&(i[s]=r(0,o,u))}return i}(t,e),attribSetters:function(t,e){const n={},r=t.getProgramParameter(e,35721);for(let i=0;i<r;++i){const r=t.getActiveAttrib(e,i);if(Qe(r))continue;const o=t.getAttribLocation(e,r.name),s=Ye[r.type],u=s.setter(t,o,s);u.location=o,n[r.name]=u}return n}(t,e)};return Xt(t)&&(n.uniformBlockSpec=function(t,e){const n=t.getProgramParameter(e,35718),r=[],i=[];for(let o=0;o<n;++o){i.push(o),r.push({});const n=t.getActiveUniform(e,o);if(Qe(n))break;r[o].name=n.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(n){const o=n[0],s=n[1];t.getActiveUniforms(e,i,t[o]).forEach((function(t,e){r[e][s]=t}))}));const o={},s=t.getProgramParameter(e,35382);for(let n=0;n<s;++n){const r=t.getActiveUniformBlockName(e,n),i={index:t.getUniformBlockIndex(e,r),usedByVertexShader:t.getActiveUniformBlockParameter(e,n,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(e,n,35398),size:t.getActiveUniformBlockParameter(e,n,35392),uniformIndices:t.getActiveUniformBlockParameter(e,n,35395)};i.used=i.usedByVertexShader||i.usedByFragmentShader,o[r]=i}return{blockSpecs:o,uniformData:r}}(t,e),n.transformFeedbackInfo=function(t,e){const n={},r=t.getProgramParameter(e,35971);for(let i=0;i<r;++i){const r=t.getTransformFeedbackVarying(e,i);n[r.name]={index:i,type:r.type,size:r.size}}return n}(t,e)),n}function rn(t,e,n,r,i,o){n=void 0===n?4:n;const s=e.indices,u=e.elementType,a=void 0===r?e.numElements:r;i=void 0===i?0:i,u||s?void 0!==o?t.drawElementsInstanced(n,a,void 0===u?5123:e.elementType,i,o):t.drawElements(n,a,void 0===u?5123:e.elementType,i):void 0!==o?t.drawArraysInstanced(n,i,a,o):t.drawArrays(n,i,a)}const on=[{format:6408,type:5121,min:9729,wrap:33071},{format:34041}],sn={};sn[34041]=33306,sn[6401]=36128,sn[36168]=36128,sn[6402]=36096,sn[33189]=36096;const un={};
/**
     * Creates a framebuffer and attachments.
     *
     * This returns a {@link module:twgl.FramebufferInfo} because it needs to return the attachments as well as the framebuffer.
     *
     * The simplest usage
     *
     *     // create an RGBA/UNSIGNED_BYTE texture and DEPTH_STENCIL renderbuffer
     *     const fbi = twgl.createFramebufferInfo(gl);
     *
     * More complex usage
     *
     *     // create an RGB565 renderbuffer and a STENCIL_INDEX8 renderbuffer
     *     const attachments = [
     *       { format: RGB565, mag: NEAREST },
     *       { format: STENCIL_INDEX8 },
     *     ]
     *     const fbi = twgl.createFramebufferInfo(gl, attachments);
     *
     * Passing in a specific size
     *
     *     const width = 256;
     *     const height = 256;
     *     const fbi = twgl.createFramebufferInfo(gl, attachments, width, height);
     *
     * **Note!!** It is up to you to check if the framebuffer is renderable by calling `gl.checkFramebufferStatus`.
     * [WebGL1 only guarantees 3 combinations of attachments work](https://www.khronos.org/registry/webgl/specs/latest/1.0/#6.6).
     *
     * @param {WebGLRenderingContext} gl the WebGLRenderingContext
     * @param {module:twgl.AttachmentOptions[]} [attachments] which attachments to create. If not provided the default is a framebuffer with an
     *    `RGBA`, `UNSIGNED_BYTE` texture `COLOR_ATTACHMENT0` and a `DEPTH_STENCIL` renderbuffer `DEPTH_STENCIL_ATTACHMENT`.
     * @param {number} [width] the width for the attachments. Default = size of drawingBuffer
     * @param {number} [height] the height for the attachments. Default = size of drawingBuffer
     * @return {module:twgl.FramebufferInfo} the framebuffer and attachments.
     * @memberOf module:twgl/framebuffers
     */
function an(t,e,n,r){const i=t.createFramebuffer();t.bindFramebuffer(36160,i),n=n||t.drawingBufferWidth,r=r||t.drawingBufferHeight;let o=0;const s={framebuffer:i,attachments:[],width:n,height:r};return(e=e||on).forEach((function(e){let i=e.attachment;const u=e.format;let a=function(t){return sn[t]}(u);if(a||(a=36064+o++),!i)if(function(t){return un[t]}(u))i=t.createRenderbuffer(),t.bindRenderbuffer(36161,i),t.renderbufferStorage(36161,u,n,r);else{const o=Object.assign({},e);o.width=n,o.height=r,void 0===o.auto&&(o.auto=!1,o.min=o.min||o.minMag||9729,o.mag=o.mag||o.minMag||9729,o.wrapS=o.wrapS||o.wrap||33071,o.wrapT=o.wrapT||o.wrap||33071),i=Ue(t,o)}if(Ot(0,i))t.framebufferRenderbuffer(36160,a,36161,i);else{if(!Lt(0,i))throw new Error("unknown attachment type");void 0!==e.layer?t.framebufferTextureLayer(36160,a,i,e.level||0,e.layer):t.framebufferTexture2D(36160,a,e.target||3553,i,e.level||0)}s.attachments.push(i)})),s}un[32854]=!0,un[32855]=!0,un[36194]=!0,un[34041]=!0,un[33189]=!0,un[6401]=!0,un[36168]=!0;var ln="#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){gl_Position=position*vec4(1,u_flipY ?-1 : 1,1,1);v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);}",cn=function(){function t(t,e,n){void 0===e&&(e=640),void 0===n&&(n=480),this.refs={programs:[],shaders:[],textures:[],buffers:[]};var r=t.getContext("webgl",{antialias:!1,alpha:!0});this.el=t,this.gl=r,this.layerDrawProgram=this.createProgram(ln,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_bitmap;uniform vec2 u_textureSize;uniform vec4 u_color1;uniform vec4 u_color2;uniform bool u_debugWireframe;const vec4 transparentColor=vec4(0,0,0,0);const vec4 wireframeColor=vec4(1,.2,0,1);void main(){float index=texture2D(u_bitmap,v_uv).a*255.;gl_FragColor=wireframeColor;if(u_debugWireframe){gl_FragColor=wireframeColor;}else if(index==1.){gl_FragColor=u_color1;}else if(index==2.){gl_FragColor=u_color2;}else{gl_FragColor=transparentColor;}}"),this.postProcessProgram=this.createProgram(ln,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;uniform bool u_debugWireframe;const vec4 wireframeColor=vec4(.2,0,1,.75);void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.setCanvasSize(e,n),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,8,8),en(r,this.layerDrawProgram,this.quadBuffer),en(r,this.postProcessProgram,this.quadBuffer),this.layerTexture=this.createTexture(),this.frameTexture=this.createFrameTexture(),this.frameBuffer=this.createFrameBuffer(this.frameTexture),this.initBlendMode()}return t.prototype.initBlendMode=function(){var t=this.gl;t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)},t.prototype.setProgram=function(t){this.gl.useProgram(t.program)},t.prototype.createProgram=function(t,e){var n=function(t,e,n,r,i){const o=Xe(n,r,i);let s=!0;if(e=e.map((function(t){if(t.indexOf("\n")<0){const e=ke(t);e?t=e.text:(o.errorCallback("no element with id: "+t),s=!1)}return t})),!s)return null;const u=Je(t,e,o);return u?nn(t,u):null}(this.gl,[t,e],(function(t){throw new Error(t)})),r=n.program;return this.refs.programs.push(r),n},t.prototype.createScreenQuad=function(t,e,n,r,i,o,s){for(var u=(i+1)*(o+1),a=i+1,l=new Float32Array(2*u),c=new Float32Array(2*u),f=0,h=0,y=0;y<=o;y++)for(var d=0;d<=i;d++){var p=d/i,v=y/o;l[f++]=t+n*p,l[f++]=e+r*v,c[h++]=p,c[h++]=v}var m=new Uint16Array(i*o*2*3),b=0;for(y=0;y<o;y++)for(d=0;d<i;d++)m[b++]=(y+0)*a+d,m[b++]=(y+1)*a+d,m[b++]=(y+0)*a+d+1,m[b++]=(y+0)*a+d+1,m[b++]=(y+1)*a+d,m[b++]=(y+1)*a+d+1;return Kt(this.gl,{position:{numComponents:2,data:l},texcoord:{numComponents:2,data:c},indices:m})},t.prototype.createTexture=function(){var t=this.gl;return Ue(t,{auto:!1,minMag:t.NEAREST,wrap:t.CLAMP_TO_EDGE})},t.prototype.createFrameTexture=function(){var t=this.gl;return Ue(t,{auto:!1,src:null,width:1,height:1,minMag:t.LINEAR,wrap:t.CLAMP_TO_EDGE})},t.prototype.createFrameBuffer=function(t){var e=this.gl;return an(e,[{format:e.RGBA,attach:e.COLOR_ATTACHMENT0,attachment:t}],this.textureWidth,this.textureHeight)},t.prototype.bindScreenBuffer=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.width,this.height)},t.prototype.bindFrameBuffer=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer.framebuffer),t.viewport(0,0,this.textureWidth,this.textureHeight)},t.prototype.clearFrameBuffer=function(t){var e=this.gl,n=t[0],r=t[1],i=t[2],o=t[3];this.bindFrameBuffer(),e.clearColor(n/255,r/255,i/255,o/255),e.clear(e.COLOR_BUFFER_BIT)},t.prototype.setTextureSize=function(t,e){var n=this.gl;this.textureWidth=t,this.textureHeight=e,Ce(n,this.frameTexture,{width:t,height:e}),function(t,e,n,r,i){r=r||t.drawingBufferWidth,i=i||t.drawingBufferHeight,e.width=r,e.height=i,(n=n||on).forEach((function(n,o){const s=e.attachments[o],u=n.format;if(Ot(0,s))t.bindRenderbuffer(36161,s),t.renderbufferStorage(36161,u,r,i);else{if(!Lt(0,s))throw new Error("unknown attachment type");Ce(t,s,n,r,i)}}))}(n,this.frameBuffer,[],t,e)},t.prototype.setCanvasSize=function(t,e){var n=window.devicePixelRatio||1,r=t*n,i=e*n;this.el.width=r,this.el.height=i,this.width=r,this.height=i,this.el.style.width=t+"px",this.el.style.height=e+"px"},t.prototype.drawPixels=function(t,e,n){var r=this.gl,i=this.layerDrawProgram,o=this.textureWidth,s=this.textureHeight,u=e[0],a=e[1],l=e[2],c=e[3],f=n[0],h=n[1],y=n[2],d=n[3];this.bindFrameBuffer(),r.useProgram(i.program),tn(i,{u_debugWireframe:!1,u_bitmap:this.layerTexture,u_screenSize:[this.width,this.height],u_textureSize:[o,s],u_color1:[u/255,a/255,l/255,c/255],u_color2:[f/255,h/255,y/255,d/255]}),r.activeTexture(r.TEXTURE0),r.texImage2D(r.TEXTURE_2D,0,r.ALPHA,o,s,0,r.ALPHA,r.UNSIGNED_BYTE,t),rn(r,this.quadBuffer)},t.prototype.postProcess=function(){var t=this.gl;t.useProgram(this.postProcessProgram.program),this.bindScreenBuffer(),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT),tn(this.postProcessProgram,{u_debugWireframe:!1,u_flipY:!0,u_screenSize:[this.width,this.height],u_tex:this.frameTexture,u_textureSize:[this.textureWidth,this.textureHeight]}),rn(t,this.quadBuffer)},t.prototype.resize=function(t,e){void 0===t&&(t=640),void 0===e&&(e=480),this.setCanvasSize(t,e)},t.prototype.destroy=function(){var t=this.refs,e=this.gl;t.shaders.forEach((function(t){e.deleteShader(t)})),t.shaders=[],t.textures.forEach((function(t){e.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){e.deleteBuffer(t)})),t.buffers=[],t.programs.forEach((function(t){e.deleteProgram(t)})),t.programs=[],e.canvas.width=1,e.canvas.height=1},t}(),fn=window.AudioContext||window.webkitAudioContext,hn=function(){function t(){this.useEq=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this.t=1,this.ctx=new fn}return Object.defineProperty(t.prototype,"volume",{get:function(){return this.t},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),t.prototype.setSamples=function(t,e){var n=t.length,r=this.ctx.createBuffer(1,n,e),i=r.getChannelData(0);if(t instanceof Float32Array)i.set(t,0);else if(t instanceof Int16Array)for(var o=0;o<n;o++)i[o]=t[o]/32767;this.buffer=r,this.sampleRate=e},t.prototype.connectEqNodesTo=function(t){var e=this.ctx,n=this.eqSettings,r=t;return n.forEach((function(t,i){var o=t[0],s=t[1],u=e.createBiquadFilter();u.frequency.value=o,u.gain.value=s,0===i?u.type="lowshelf":i===n.length-1?u.type="highshelf":u.type="peaking",r.connect(u),r=u})),r},t.prototype.initNodes=function(){var t=this.ctx,e=t.createBufferSource();e.buffer=this.buffer;var n=t.createGain();this.useEq?this.connectEqNodesTo(e).connect(n):e.connect(n);e.connect(n),n.connect(t.destination),this.source=e,this.gainNode=n,this.setVolume(this.t)},t.prototype.setVolume=function(t){this.t=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))},t.prototype.stop=function(){this.source.stop(0)},t.prototype.playFrom=function(t){this.initNodes(),this.source.start(0,t)},t}(),yn=function(){var t=document.createElement("a");return function(e,n){var r=window.URL.createObjectURL(e);t.href=r,t.download=n,t.click(),window.URL.revokeObjectURL(r)}}(),dn=function(){function t(e,n,r){this.loop=!1,this.paused=!0,this.duration=0,this.isOpen=!1,this.events={},this.s=-1,this.u=-1,this.h=-1,this.hasPlaybackStarted=!1,this.wasPlaying=!1,this.isSeeking=!1,e="string"==typeof e?document.querySelector(e):e,this.canvas=new cn(e,n,r),this.audio=new hn,this.el=this.canvas.el,this.customPalette=null,this.state=W({},t.defaultState)}return Object.defineProperty(t.prototype,"currentFrame",{get:function(){return this.u},set:function(t){this.setFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return this.isOpen?this.h:null},set:function(t){this.isOpen&&t<=this.duration&&t>=0&&(this.setFrame(Math.round(t/(1/this.framerate))),this.h=t,this.emit("progress",this.progress))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"progress",{get:function(){return this.isOpen?this.h/this.duration*100:0},set:function(t){this.currentTime=this.duration*(t/100)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this.audio.volume},set:function(t){this.audio.volume=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"muted",{get:function(){return!1},set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),t.prototype.setState=function(t){t=W(W({},this.state),t);this.state;this.emit("state:change")},t.prototype.open=function(t){return G(this,void 0,void 0,(function(){var e=this;return $(this,(function(n){return this.isOpen&&this.close(),[2,Rt(t).then((function(t){return e.load(t)})).catch((function(t){throw e.emit("error",t),console.error("Error loading Flipnote:",t),"Error loading Flipnote"}))]}))}))},t.prototype.close=function(){this.pause(),this.note=null,this.isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.u=null,this.h=null,this.duration=null,this.loop=null,this.hasPlaybackStarted=null},t.prototype.load=function(t){this.note=t,this.meta=t.meta,this.type=t.type,this.loop=t.meta.loop,this.duration=this.note.frameCount*(1/this.note.framerate),this.paused=!0,this.isOpen=!0,this.hasPlaybackStarted=!1,this.layerVisibility={1:!0,2:!0,3:!0};var e=this.note.sampleRate,n=t.getAudioMasterPcm();this.audio.setSamples(n,e),this.canvas.setTextureSize(t.width,t.height),this.setFrame(this.note.thumbFrameIndex),this.h=0,this.emit("load")},t.prototype.playAudio=function(){this.audio.playFrom(this.currentTime)},t.prototype.stopAudio=function(){this.audio.stop()},t.prototype.toggleEq=function(){this.stopAudio(),this.audio.useEq=!this.audio.useEq,this.playAudio()},t.prototype.playbackLoop=function(t){if(this.paused)return this.stopAudio(),null;var e=t/1e3,n=e-this.s;n>this.duration?this.loop?(this.currentTime=0,this.playAudio(),this.s=e,this.emit("playback:loop")):(this.pause(),this.emit("playback:end")):this.currentTime=n,requestAnimationFrame(this.playbackLoop.bind(this))},t.prototype.play=function(){if(window.__activeFlipnotePlayer=this,!this.isOpen||!this.paused)return null;this.hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.h=0),this.paused=!1,this.hasPlaybackStarted=!0,this.s=performance.now()/1e3-this.currentTime,this.playAudio(),requestAnimationFrame(this.playbackLoop.bind(this)),this.emit("playback:start")},t.prototype.pause=function(){if(!this.isOpen||this.paused)return null;this.paused=!0,this.stopAudio(),this.emit("playback:stop")},t.prototype.togglePlay=function(){this.paused?this.play():this.pause()},t.prototype.setFrame=function(t){this.isOpen&&t!==this.currentFrame&&(t=Math.max(0,Math.min(Math.floor(t),this.frameCount-1)),this.drawFrame(t),this.u=t,this.paused&&(this.h=t*(1/this.framerate),this.emit("progress",this.progress)),this.emit("frame:update",this.currentFrame))},t.prototype.nextFrame=function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1},t.prototype.prevFrame=function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1},t.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1},t.prototype.firstFrame=function(){this.currentFrame=0},t.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},t.prototype.startSeek=function(){this.isSeeking||(this.wasPlaying=!this.paused,this.pause(),this.isSeeking=!0)},t.prototype.seek=function(t){this.isSeeking&&(this.progress=t)},t.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},t.prototype.getMasterWav=function(){return kt.fromFlipnote(this.note)},t.prototype.saveMasterWav=function(){var t=this.getMasterWav();yn(t.getBlob(),this.meta.current.filename+".wav")},t.prototype.getFrameGif=function(t,e){return void 0===e&&(e={}),St.fromFlipnoteFrame(this.note,t,e)},t.prototype.saveFrameGif=function(t,e){void 0===e&&(e={});var n=this.getFrameGif(t,e);yn(n.getBlob(),this.meta.current.filename+"_"+t.toString().padStart(3,"0")+".gif")},t.prototype.getAnimatedGif=function(t){return void 0===t&&(t={}),St.fromFlipnote(this.note,t)},t.prototype.saveAnimatedGif=function(t){void 0===t&&(t={});var e=this.getAnimatedGif(t);yn(e.getBlob(),this.meta.current.filename+".gif")},t.prototype.drawFrame=function(t){var e=this,n=this.note.getFramePalette(t),r=this.note.decodeFrame(t);this.canvas.clearFrameBuffer(n[0]),"PPM"===this.note.type?(this.layerVisibility[2]&&this.canvas.drawPixels(r[1],n[2],[0,0,0,0]),this.layerVisibility[1]&&this.canvas.drawPixels(r[0],n[1],[0,0,0,0])):"KWZ"===this.note.type&&this.note.getLayerOrder(t).forEach((function(t){e.layerVisibility[t+1]&&e.canvas.drawPixels(r[t],n[2*t+1],n[2*t+2])})),this.canvas.postProcess()},t.prototype.forceUpdate=function(){this.isOpen&&this.drawFrame(this.currentFrame)},t.prototype.resize=function(t,e){this.canvas.resize(t,e),this.forceUpdate()},t.prototype.setLayerVisibility=function(t,e){this.layerVisibility[t]=e,this.forceUpdate()},t.prototype.toggleLayerVisibility=function(t){this.setLayerVisibility(t,!this.layerVisibility[t])},t.prototype.on=function(t,e){var n=this.events;(n[t]||(n[t]=[])).push(e)},t.prototype.off=function(t,e){var n=this.events[t];n&&n.splice(n.indexOf(e),1)},t.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=this.events[t]||[],i=0;i<r.length;i++)r[i].apply(null,e)},t.prototype.clearEvents=function(){this.events={}},t.prototype.destroy=function(){this.close(),this.canvas.destroy()},t.defaultState={noteType:null,isNoteOpen:!1,paused:!1,hasPlaybackStarted:!1,frame:-1,time:-1,loop:!1,volume:1,muted:!1,layerVisibility:{1:!0,2:!0,3:!0},isSeeking:!1,wasPlaying:!1},t}();function pn(t,e){return t.toString().padStart(e,"0")}function vn(t){return Math.floor(t%3600/60)+":"+pn(Math.round(t%60),2)}function mn(t,e){return t.replace(/<svg ([^>]*)>/,(function(t,n){return"<svg "+n+' style="'+e+'">'}))}function bn(t){let n,r,s,f,p,m,b;return{c(){n=c("div"),r=c("div"),s=c("div"),f=h(),p=c("div"),this.c=e,d(s,"class","PlayerSlider__level"),v(s,"width",100*t[0]+"%"),d(p,"class","PlayerSlider__handle"),v(p,"left",100*t[0]+"%"),d(r,"class","PlayerSlider__track"),d(n,"class","PlayerSlider")},m(e,i){a(e,n,i),u(n,r),u(r,s),u(r,f),u(r,p),t[6](r),m||(b=[y(window,"mousemove",(function(){o(t[2]?t[5]:null)&&(t[2]?t[5]:null).apply(this,arguments)})),y(window,"mouseup",(function(){o(t[2]?t[4]:null)&&(t[2]?t[4]:null).apply(this,arguments)})),y(n,"mousedown",t[3])],m=!0)},p(e,[n]){t=e,1&n&&v(s,"width",100*t[0]+"%"),1&n&&v(p,"left",100*t[0]+"%")},i:e,o:e,d(e){e&&l(n),t[6](null),m=!1,i(b)}}}function wn(t,e,n){let r,{value:i=0}=e,o=!1;const s=(u=w(),a=g(),function(t,e){a(t,e),u.dispatchEvent&&u.dispatchEvent(new CustomEvent(t,{detail:e}))});var u,a;function l(t){t.preventDefault();const e=r.getBoundingClientRect(),n=e.height/2,o=e.width-2*n,u=t.pageX-e.left-n,a=Math.max(0,Math.min(1,u/o));i!==a&&s("change",{value:a})}return t.$set=t=>{"value"in t&&n(0,i=t.value)},[i,r,o,function(t){t.preventDefault(),n(2,o=!0),l(t),s("inputstart")},function(t){t.preventDefault(),n(2,o=!1),l(t),s("inputend")},l,function(t){x[t?"unshift":"push"](()=>{r=t,n(1,r)})}]}customElements.define("flipnote-player-slider-bar",class extends I{constructor(t){super(),this.shadowRoot.innerHTML="<style>.PlayerSlider{padding:4px 0;cursor:pointer}.PlayerSlider__track{position:relative;flex:1;height:4px;border-radius:3px;margin:6px 0;background:var(--flipnote-player-slider-track, #FFD3A6)}.PlayerSlider__level{position:absolute;width:100%;height:6px;margin:-1px;border-radius:8px;background:var(--flipnote-player-slider-level, #F36A2D)}.PlayerSlider__handle{display:none;position:absolute;top:0;height:10px;width:6px;margin-left:-3px;margin-top:-3px;border-radius:2px;background:var(--flipnote-player-slider-handle, #F36A2D)}.PlayerSlider:hover .PlayerSlider__handle{display:block}</style>",L(this,{target:this.shadowRoot},wn,bn,s,{value:0}),t&&(t.target&&a(t.target,this,t.anchor),t.props&&(this.$set(t.props),C()))}static get observedAttributes(){return["value"]}get value(){return this.$$.ctx[0]}set value(t){this.$set({value:t}),C()}});function gn(t){let n,r=t[1][t[0]]+"";return{c(){n=c("div"),this.c=e,d(n,"class","PlayerIcon")},m(t,e){a(t,n,e),n.innerHTML=r},p(t,[e]){1&e&&r!==(r=t[1][t[0]]+"")&&(n.innerHTML=r)},i:e,o:e,d(t){t&&l(n)}}}const Fn="fill:currentColor";function xn(t,e,n){let{icon:r="play"}=e;const i={play:mn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 241 240"><path fill-rule="evenodd" d="M74.137 48h8.985a4 4 0 012.129.614l91.994 57.84c7.48 4.704 9.732 14.582 5.028 22.062a16 16 0 01-5.028 5.03l-91.994 57.84a4 4 0 01-2.13.614h-8.984C68.54 192 64 187.461 64 181.863V58.137C64 52.54 68.539 48 74.137 48z"/></svg>',Fn),pause:mn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M64 48h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16H64c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16zm88 0h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16h-24c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16z"/></svg>',Fn),loader:mn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M120 176c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16zm48.497-28c4.419-7.653 14.204-10.275 21.857-5.856 7.653 4.418 10.275 14.203 5.856 21.856-4.418 7.653-14.203 10.275-21.856 5.856-7.653-4.418-10.275-14.203-5.857-21.856zm-118.85-5.856c7.652-4.419 17.437-1.797 21.856 5.856 4.418 7.653 1.796 17.438-5.857 21.856-7.653 4.419-17.438 1.797-21.856-5.856-4.419-7.653-1.797-17.438 5.856-21.856zm124.707-72c7.653-4.419 17.438-1.797 21.856 5.856 4.419 7.653 1.797 17.438-5.856 21.856-7.653 4.419-17.438 1.797-21.857-5.856-4.418-7.653-1.796-17.438 5.857-21.856zM43.79 76c4.418-7.653 14.203-10.275 21.856-5.856C73.3 74.562 75.921 84.347 71.503 92c-4.419 7.653-14.204 10.275-21.857 5.856C41.993 93.438 39.371 83.653 43.79 76zM120 32c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16z"/></svg>',Fn),volumeOn:mn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M113.3 42.022a10 10 0 0110-1.2 10 10 0 015.7 9v140a10 10 0 01-5.7 9 9.116 9.116 0 01-4.3 1.001 10.009 10.009 0 01-6.2-2.2l-47.3-37.8H29c-5.523 0-10-4.478-10-10v-60c0-5.524 4.477-10 10-10h36.5zm82.986 17.298c17.008 16.234 25.715 36.022 25.715 58.68 0 22.37-8.465 43.147-24.992 61.928-4.378 4.975-11.96 5.459-16.936 1.08-4.975-4.378-5.46-11.96-1.08-16.936C191.798 149.52 198 134.297 198 118c0-16.009-5.96-29.554-18.286-41.32-4.794-4.576-4.97-12.172-.395-16.966 4.577-4.794 12.172-4.97 16.966-.394zM165.201 87.4c10.904 8.178 16.8 18.987 16.8 31.6 0 12.433-5.712 23.38-16.318 32.219-5.091 4.242-12.658 3.555-16.9-1.537-4.174-5.008-3.577-12.41 1.289-16.69l.246-.21c5.395-4.496 7.683-8.881 7.683-13.782 0-4.613-2.01-8.403-6.857-12.14l-.343-.26c-5.302-3.976-6.377-11.498-2.4-16.8 3.976-5.302 11.498-6.376 16.8-2.4z"/></svg>',Fn),volumeOff:mn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M123.3 40.822a10 10 0 00-10 1.2l-47.8 37.8H29c-5.523 0-10 4.477-10 10v60c0 5.523 4.477 10 10 10h36.5l47.3 37.8a10.009 10.009 0 006.2 2.201 9.116 9.116 0 004.3-1 10 10 0 005.7-9v-140a10 10 0 00-5.7-9zm70.451 50.462c4.702-4.454 12.126-4.377 16.734.23 4.608 4.609 4.685 12.033.23 16.735l-.23.236L198.971 120l11.514 11.515c4.687 4.686 4.687 12.284 0 16.97-4.608 4.608-12.032 4.685-16.734.23l-.236-.23L182 136.971l-11.515 11.514-.236.23c-4.702 4.455-12.126 4.378-16.734-.23-4.608-4.608-4.685-12.032-.23-16.734l.23-.236L165.029 120l-11.514-11.515c-4.687-4.686-4.687-12.284 0-16.97 4.608-4.608 12.032-4.685 16.734-.23l.236.23L182 103.029l11.515-11.514.236-.23z"/></svg>',Fn)};return t.$set=t=>{"icon"in t&&n(0,r=t.icon)},[r,i]}function _n(t){let e;return{c(){e=c("div"),e.textContent="Error",d(e,"class","FlipnotePlayer__overlay")},m(t,n){a(t,e,n)},d(t){t&&l(e)}}}function An(t){return{c:e,m:e,d:e}}function Pn(t){let e;return{c(){e=c("div"),e.innerHTML='<flipnote-player-icon icon="loader" class="FlipnotePlayer__loaderIcon"></flipnote-player-icon>',d(e,"class","FlipnotePlayer__overlay")},m(t,n){a(t,e,n)},d(t){t&&l(e)}}}function En(t){let n;return{c(){n=c("div"),n.textContent="todo :)",d(n,"class","FlipnotePlayerControls FlipnotePlayerControls--full")},m(t,e){a(t,n,e)},p:e,d(t){t&&l(n)}}}function zn(t){let e,n,r,o,s,v,m,b,w,g,F,x,_,A,P,E,z,R,U,C,S;return{c(){e=c("div"),n=c("flipnote-player-slider-bar"),o=h(),s=c("div"),v=c("div"),m=c("button"),b=c("flipnote-player-icon"),g=h(),F=c("span"),x=f(t[6]),_=h(),A=c("div"),P=c("flipnote-player-icon"),z=h(),R=c("flipnote-player-slider-bar"),p(n,"class","FlipnotePlayerControls__progressBar"),p(n,"value",r=t[3]/100),p(b,"icon",w=t[4]?"pause":"play"),d(m,"class","Button FlipnotePlayerControls__playButton"),d(F,"class","FlipnotePlayerControls__frameCounter"),d(v,"class","FlipnotePlayerControls__groupLeft"),p(P,"class","FlipnotePlayerControls__muteIcon"),p(P,"icon",E=t[0]||0===t[5]?"volumeOff":"volumeOn"),p(R,"class","FlipnotePlayerControls__volumeBar"),p(R,"value",U=t[0]?0:t[5]),d(A,"class","FlipnotePlayerControls__groupRight"),d(s,"class","FlipnotePlayerControls__row"),d(e,"class","FlipnotePlayerControls FlipnotePlayerControls--default")},m(r,i){a(r,e,i),u(e,n),u(e,o),u(e,s),u(s,v),u(v,m),u(m,b),u(v,g),u(v,F),u(F,x),u(s,_),u(s,A),u(A,P),u(A,z),u(A,R),C||(S=[y(n,"change",t[9]),y(n,"inputstart",t[8]),y(n,"inputend",t[10]),y(m,"click",t[12]),y(P,"click",t[13]),y(R,"change",t[11])],C=!0)},p(t,e){8&e&&r!==(r=t[3]/100)&&p(n,"value",r),16&e&&w!==(w=t[4]?"pause":"play")&&p(b,"icon",w),64&e&&function(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}(x,t[6]),33&e&&E!==(E=t[0]||0===t[5]?"volumeOff":"volumeOn")&&p(P,"icon",E),33&e&&U!==(U=t[0]?0:t[5])&&p(R,"value",U)},d(t){t&&l(e),C=!1,i(S)}}}function Rn(t){let e,n,r,o,s,f,v,m,b;return{c(){e=c("div"),n=c("button"),r=c("flipnote-player-icon"),s=h(),f=c("flipnote-player-slider-bar"),p(r,"icon",o=t[4]?"pause":"play"),d(n,"class","Button FlipnotePlayerControls__playButton"),p(f,"class","FlipnotePlayerControls__progressBar"),p(f,"value",v=t[3]/100),d(e,"class","FlipnotePlayerControls FlipnotePlayerControls--compact FlipnotePlayerControls__row")},m(i,o){a(i,e,o),u(e,n),u(n,r),u(e,s),u(e,f),m||(b=[y(n,"click",t[12]),y(f,"change",t[9]),y(f,"inputstart",t[8]),y(f,"inputend",t[10])],m=!0)},p(t,e){16&e&&o!==(o=t[4]?"pause":"play")&&p(r,"icon",o),8&e&&v!==(v=t[3]/100)&&p(f,"value",v)},d(t){t&&l(e),m=!1,i(b)}}}function Un(t){let n,r,i,o,s,f,p,v,m={ctx:t,current:null,token:null,pending:Pn,then:An,catch:_n,error:23};function b(t,e){return"compact"===t[1]?Rn:"default"===t[1]?zn:"full"===t[1]?En:void 0}M(s=t[7],m);let w=b(t),g=w&&w(t);return{c(){n=c("div"),r=c("div"),i=c("canvas"),o=h(),m.block.c(),f=h(),g&&g.c(),this.c=e,d(i,"class","FlipnotePlayer__canvas"),d(r,"class","FlipnotePlayer__canvasArea"),d(n,"class","FlipnotePlayer")},m(e,s){a(e,n,s),u(n,r),u(r,i),t[16](i),u(r,o),m.block.m(r,m.anchor=null),m.mount=()=>r,m.anchor=null,u(n,f),g&&g.m(n,null),p||(v=y(i,"click",t[12]),p=!0)},p(e,[r]){t=e,m.ctx=t,128&r&&s!==(s=t[7])&&M(s,m),w===(w=b(t))&&g?g.p(t,r):(g&&g.d(1),g=w&&w(t),g&&(g.c(),g.m(n,null)))},i:e,o:e,d(e){e&&l(n),t[16](null),m.block.d(),m.token=null,m=null,g&&g.d(),p=!1,v()}}}function Cn(t,e,n){let r,i,{src:o=null}=e,{controls:s="default"}=e,{timeformat:u="frames"}=e,{muted:a=!1}=e,l=0,c=0,f=0,h=0,y=0,d=!1,p=1,v="";var m;m=()=>{n(17,r=new dn(i,256,192)),r.on("load",()=>{n(19,f=r.frameCount),n(21,y=r.duration),n(5,p=r.volume),n(17,r.muted=a,r),r.resize(r.note.width,r.note.height)}),r.on("progress",t=>{n(3,l=t),n(20,h=r.currentTime)}),r.on("playback:start",()=>{n(4,d=!0)}),r.on("playback:stop",()=>{n(4,d=!1)}),r.on("frame:update",()=>{n(18,c=r.currentFrame+1)})},w().$$.on_mount.push(m);let b=new Promise((t,e)=>e());return t.$set=t=>{"src"in t&&n(14,o=t.src),"controls"in t&&n(1,s=t.controls),"timeformat"in t&&n(15,u=t.timeformat),"muted"in t&&n(0,a=t.muted)},t.$$.update=()=>{16384&t.$$.dirty&&o&&n(7,b=async function(t){await r.open(t)}(o)),131073&t.$$.dirty&&r&&n(17,r.muted=a,r),3964928&t.$$.dirty&&n(6,v="time"===u?`${vn(h)} / ${vn(y)}`:`${pn(c,3)} / ${pn(f,3)}`)},[a,s,i,l,d,p,v,b,function(t){r&&r.startSeek()},function(t){const{value:e}=t.detail;r&&r.seek(100*e)},function(t){r&&r.endSeek()},function(t){const{value:e}=t.detail;r&&(n(17,r.volume=e,r),n(5,p=e),p>0&&a&&n(0,a=!1))},function(){r&&r.togglePlay()},function(){n(0,a=!a)},o,u,function(t){x[t?"unshift":"push"](()=>{i=t,n(2,i)})}]}customElements.define("flipnote-player-icon",class extends I{constructor(t){super(),this.shadowRoot.innerHTML="<style>.PlayerIcon{width:100%;height:100%;color:var(--flipnote-player-icon-color, #F36A2D)}</style>",L(this,{target:this.shadowRoot},xn,gn,s,{icon:0}),t&&(t.target&&a(t.target,this,t.anchor),t.props&&(this.$set(t.props),C()))}static get observedAttributes(){return["icon"]}get icon(){return this.$$.ctx[0]}set icon(t){this.$set({icon:t}),C()}});class Sn extends I{constructor(t){super(),this.shadowRoot.innerHTML="<style>.Button{border:0;padding:0;outline:0;-webkit-appearance:none;display:block;font-family:inherit;font-size:inherit;text-align:center;cursor:pointer;background:var(--flipnote-player-button-background, #FFD3A6);color:var(--flipnote-player-button-color, #F36A2D);border-radius:4px}.Button flipnote-player-icon{display:block}.FlipnotePlayer{display:inline-block;position:relative;font-family:var(--flipnote-player-font-family, sans-serif)}.FlipnotePlayer__canvasArea{position:relative}.FlipnotePlayer__canvas{position:relative;display:block}.FlipnotePlayer__overlay{position:absolute;top:0;left:0;background:#e5e5e9;color:#4b4c53;width:100%;height:100%;display:flex;justify-content:center;align-items:center}@keyframes spin{from{transform:rotateZ(0)}to{transform:rotateZ(360deg)}}.FlipnotePlayer__loaderIcon{animation:spin infinite 1.2s linear}.FlipnotePlayerControls{background:var(--flipnote-player-controls-background, none)}.FlipnotePlayerControls__muteIcon{width:28px;height:28px}.FlipnotePlayerControls__row,.FlipnotePlayerControls__groupLeft,.FlipnotePlayerControls__groupRight{display:flex;align-items:center}.FlipnotePlayerControls__groupLeft{margin-right:auto}.FlipnotePlayerControls__groupRight{margin-left:auto}.FlipnotePlayerControls__playButton{height:32px;width:32px;padding:2px}.FlipnotePlayerControls__frameCounter{font-variant-numeric:tabular-nums}.FlipnotePlayerControls--compact .FlipnotePlayerControls__playButton{margin-right:12px}.FlipnotePlayerControls--compact .FlipnotePlayerControls__progressBar{flex:1}.FlipnotePlayerControls--default .FlipnotePlayerControls__playButton{margin-right:8px}.FlipnotePlayerControls--default .FlipnotePlayerControls__volumeBar{width:70px;margin-left:8px}</style>",L(this,{target:this.shadowRoot},Cn,Un,s,{src:14,controls:1,timeformat:15,muted:0}),t&&(t.target&&a(t.target,this,t.anchor),t.props&&(this.$set(t.props),C()))}static get observedAttributes(){return["src","controls","timeformat","muted"]}get src(){return this.$$.ctx[14]}set src(t){this.$set({src:t}),C()}get controls(){return this.$$.ctx[1]}set controls(t){this.$set({controls:t}),C()}get timeformat(){return this.$$.ctx[15]}set timeformat(t){this.$set({timeformat:t}),C()}get muted(){return this.$$.ctx[0]}set muted(t){this.$set({muted:t}),C()}}var kn;!function(t){t.version="4.1.0",t.player=dn,t.parseSource=Rt,t.kwzParser=zt,t.ppmParser=lt,t.gifEncoder=St,t.wavEncoder=kt}(kn||(kn={}));var Tn=dn,In=Rt,Bn=zt,Mn=lt,On=St,Ln=kt;customElements.define("flipnote-player",Sn);var jn=Sn;t.gifEncoder=On,t.kwzParser=Bn,t.parseSource=In,t.player=Tn,t.playerComponent=jn,t.ppmParser=Mn,t.version="4.1.0",t.wavEncoder=Ln,Object.defineProperty(t,"v",{value:!0})}));
