/*!!
 * flipnote.js v5.12.0
 * https://flipnote.js.org
 * A JavaScript library for Flipnote Studio animation files
 * 2018 - 2024 James Daniel
 * Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).flipnote={})}(this,(function(t){class ByteArray{constructor(){this.pageSize=4096,this.allocSize=0,this.realSize=0,this.pages=[],this.numPages=0,this.pageIdx=0,this.pagePtr=0,this.realPtr=0,this.newPage()}set pointer(t){this.setPointer(t)}get pointer(){return this.realPtr}newPage(){this.pages[this.numPages]=new Uint8Array(this.pageSize),this.numPages=this.pages.length,this.allocSize=this.numPages*this.pageSize}setPointer(t){for(;t>=this.allocSize;)this.newPage();t>this.realSize&&(this.realSize=t),this.pageIdx=Math.floor(t/this.pageSize),this.pagePtr=t%this.pageSize,this.realPtr=t}writeByte(t){this.pages[this.pageIdx][this.pagePtr]=t,this.setPointer(this.realPtr+1)}writeBytes(t,i,s){for(let e=s||t.length,r=i||0;r<e;r++)this.writeByte(t[r])}writeChars(t){for(let i=0;i<t.length;i++)this.writeByte(t.charCodeAt(i))}writeU8(t){this.writeByte(255&t)}writeU16(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255)}writeU32(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255),this.writeByte(t>>>16&255),this.writeByte(t>>>24&255)}getBytes(){const t=new Uint8Array(this.realSize),i=this.numPages;for(let s=0;s<i;s++){const e=this.pages[s];s===i-1?t.set(e.slice(0,this.realSize%this.pageSize),s*this.pageSize):t.set(e,s*this.pageSize)}return t}getBuffer(){return this.getBytes().buffer}}class DataStream{constructor(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}get bytes(){return new Uint8Array(this.buffer)}get byteLength(){return this.data.byteLength}seek(t,i){switch(i){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;default:this.pointer=t}}readUint8(){const t=this.data.getUint8(this.pointer);return this.pointer+=1,t}writeUint8(t){this.data.setUint8(this.pointer,t),this.pointer+=1}readInt8(){const t=this.data.getInt8(this.pointer);return this.pointer+=1,t}writeInt8(t){this.data.setInt8(this.pointer,t),this.pointer+=1}readUint16(t=!0){const i=this.data.getUint16(this.pointer,t);return this.pointer+=2,i}writeUint16(t,i=!0){this.data.setUint16(this.pointer,t,i),this.pointer+=2}readInt16(t=!0){const i=this.data.getInt16(this.pointer,t);return this.pointer+=2,i}writeInt16(t,i=!0){this.data.setInt16(this.pointer,t,i),this.pointer+=2}readUint32(t=!0){const i=this.data.getUint32(this.pointer,t);return this.pointer+=4,i}writeUint32(t,i=!0){this.data.setUint32(this.pointer,t,i),this.pointer+=4}readInt32(t=!0){const i=this.data.getInt32(this.pointer,t);return this.pointer+=4,i}writeInt32(t,i=!0){this.data.setInt32(this.pointer,t,i),this.pointer+=4}readBytes(t){const i=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=i.byteLength,i}writeBytes(t){t.forEach((t=>this.writeUint8(t)))}readHex(t,i=!1){const s=this.readBytes(t);let e=[];for(let t=0;t<s.length;t++)e.push(s[t].toString(16).padStart(2,"0"));return i&&e.reverse(),e.join("").toUpperCase()}readChars(t){const i=this.readBytes(t);let s="";for(let t=0;t<i.length;t++){const e=i[t];if(0===e)break;s+=String.fromCharCode(e)}return s}writeChars(t){for(let i=0;i<t.length;i++){const s=t.charCodeAt(i);this.writeUint8(s)}}readWideChars(t){const i=new Uint16Array(this.data.buffer,this.pointer,t);let s="";for(let t=0;t<i.length;t++){const e=i[t];if(0==e)break;s+=String.fromCharCode(e)}return this.pointer+=i.byteLength,s}}const i=new Int8Array([-1,2,-1,2]),s=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),e=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function r(t,i,s){return t<i?i:t>s?s:t}function n(t,i,s){return s<0||s>=i?0:t[s]}function h(t){const i=t.length;let s=0;for(let e=0;e<i;e++){const i=t[e];(i<=-32768||i>=32767)&&(s+=1)}return s/i}function o(t){const i=t.length;let s=0;for(let e=0;e<i;e++)s+=Math.pow(t[e],2);return Math.sqrt(s/i)}function a(t,i="Assert failed"){if(!t)throw new Error(i)}function l(t,i,s,e=""){a(t>=i&&t<=s,`${e||"value"} ${t} should be between ${i} and ${s}`)}function c(t,i){try{return t.require(i)}catch{throw new Error(`Could not require(${i})`)}}function u(){return p?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{}}const d="undefined"!=typeof window&&void 0!==window.document;function f(){return a(d,"This feature is only available in browser environments")}const p="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;function m(){return a(p,"This feature is only available in NodeJS environments")}const y="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,w=d&&(window.requestAnimationFrame||window.webkitRequestAnimationFrame),g=(()=>{if(d||y){const t=u();return(t.crypto||t.msCrypto).subtle}if(p)return c(module,"crypto").webcrypto.subtle})(),v="RSASSA-PKCS1-v1_5";async function b(t,i){const s=t.split("\n").filter((t=>!t.startsWith("-----")&&!t.endsWith("-----"))).join(""),e=atob(s),r=new Uint8Array(e.length).map(((t,i)=>e.charCodeAt(i)));return await g.importKey("spki",r.buffer,{name:v,hash:i},!1,["verify"])}async function P(t,i,s){return await g.verify(v,t,i,s)}function A(t){return new Date(1e3*(t+946684800))}function C(t,i){return 100*t*(1/i)/100}var S;t.FlipnoteRegion=void 0,(S=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",S.USA="USA",S.JPN="JPN",S.UNKNOWN="UNKNOWN";const x=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,_=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,F=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/,z=["01FACA7A4367FC5F","03D6E959E2F9A42D","03F80445160587FA","04068426E1008915","092A3EC8199FD5D5","0B8D56BA1BD441B8","0E61C75C9B5AD90B","14E494E35A443235"],U=z.map((t=>k(t)));function E(t){return x.test(t)||z.includes(t)}function M(t){return _.test(t)}function T(t){if(F.test(t))return!0;for(let i of U)if(t.endsWith(i))return!0;return!1}function I(i){switch(i.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function L(i){if(T(i))switch(i.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}switch(i.slice(0,2)){case"00":return t.FlipnoteRegion.JPN;case"02":return t.FlipnoteRegion.USA;case"04":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function B(t){return F.test(t)?(t.slice(19,21)+t.slice(17,19)+t.slice(15,17)+t.slice(12,14)+t.slice(10,12)+t.slice(7,9)+t.slice(5,7)+t.slice(2,4)).toUpperCase():null}function k(t){return x.test(t)?(t.slice(14,16)+t.slice(12,14)+"-"+t.slice(10,12)+t.slice(8,10)+"-"+t.slice(6,8)+t.slice(4,6)+"-"+t.slice(2,4)+t.slice(0,2)).toLowerCase():null}var $,N,K,O,D,R,W,j=Object.freeze({__proto__:null,get FlipnoteRegion(){return t.FlipnoteRegion},convertKwzFsidToPpmFsid:B,convertPpmFsidToKwzFsidSuffix:k,convertPpmFsidToPossibleKwzFsids(t){const i=k(t);return i?["00"+i,"10"+i,"12"+i,"14"+i]:null},getFsidRegion:i=>E(i)?I(i):M(i)?L(i):t.FlipnoteRegion.UNKNOWN,getKwzFsidRegion:L,getPpmFsidRegion:I,isFsid:t=>E(t)||M(t),isKwzDsiLibraryFsid:T,isKwzFsid:M,isPpmFsid:E,testKwzFsidMatchesPpmFsid:(t,i)=>B(t)==i});!function(){if(!d)return function(){};document.createElement("a")}(),t.FlipnoteFormat=void 0,(N=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",N.KWZ="KWZ",function(t){t[t.Jpeg=0]="Jpeg",t[t.Rgba=1]="Rgba"}(K||(K={})),function(t){t[t.Left=0]="Left",t[t.Right=1]="Right"}(O||(O={})),t.FlipnoteAudioTrack=void 0,(D=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[D.BGM=0]="BGM",D[D.SE1=1]="SE1",D[D.SE2=2]="SE2",D[D.SE3=3]="SE3",D[D.SE4=4]="SE4",t.FlipnoteSoundEffectTrack=void 0,(R=t.FlipnoteSoundEffectTrack||(t.FlipnoteSoundEffectTrack={}))[R.SE1=1]="SE1",R[R.SE2=2]="SE2",R[R.SE3=3]="SE3",R[R.SE4=4]="SE4";class FlipnoteParserBase extends DataStream{constructor(){super(...arguments),this[$]="Flipnote",this.titleFormats={COMMENT:"Comment by $USERNAME",FLIPNOTE:"Flipnote by $USERNAME",ICON:"Folder icon"},this.soundMeta=new Map,this.layerVisibility={1:!0,2:!0,3:!0},this.isFolderIcon=!1,this.isComment=!1,this.isDsiLibraryNote=!1}getTitle(t=this.titleFormats){return this.isFolderIcon?t.ICON:(this.isComment?t.COMMENT:t.FLIPNOTE).replace("$USERNAME",this.meta.current.username)}toString(){return this.getTitle()}*[($=Symbol.toStringTag,Symbol.iterator)](){for(let t=0;t<this.frameCount;t++)yield t}getLayerPixels(t,i,s=new Uint8Array(this.imageWidth*this.imageHeight),e=0,r=O.Left){l(t,0,this.frameCount-1,"Frame index"),l(i,0,this.numLayers-1,"Layer index");const n=this.getFramePaletteIndices(t),h=i*this.numLayerColors,o=this.decodeFrame(t)[i],a=Math.floor(this.getFrameLayerDepths(t)[i]*e),c=r==O.Left?-a:a,u=this.srcWidth,d=this.imageWidth,f=this.imageWidth,p=this.imageHeight,m=this.imageOffsetX,y=this.imageOffsetY;if(s.fill(0),!this.layerVisibility[i+1])return s;for(let t=y,i=0;i<p;t++,i++)for(let e=m,r=0;r<f;e++,r++){const a=i*d+r+c;let l=o[t*u+e];0!==l&&(s[a]=n[h+l])}return s}getLayerPixelsRgba(t,i,s=new Uint32Array(this.imageWidth*this.imageHeight),e=new Uint32Array(16),r=0,n=O.Left){l(t,0,this.frameCount-1,"Frame index"),l(i,0,this.numLayers-1,"Layer index"),this.getFramePaletteUint32(t,e);const h=i*this.numLayerColors,o=this.decodeFrame(t)[i],a=Math.floor(this.getFrameLayerDepths(t)[i]*r),c=n==O.Left?-a:a,u=this.srcWidth,d=this.imageWidth,f=this.imageWidth-a,p=this.imageHeight,m=this.imageOffsetX,y=this.imageOffsetY;if(s.fill(0),!this.layerVisibility[i+1])return s;for(let t=y,i=0;i<p;t++,i++)for(let r=m,n=0;n<f;r++,n++){const a=i*d+n+c;let l=o[t*u+r];0!==l&&(s[a]=e[h+l])}return s}getFramePixels(t,i=new Uint8Array(this.imageWidth*this.imageHeight),s=0,e=O.Left){const r=this.srcWidth;this.imageWidth;const n=this.imageWidth,h=this.imageHeight,o=this.imageOffsetX,a=this.imageOffsetY,l=this.getFramePaletteIndices(t);i.fill(l[0]);const c=this.getFrameLayerOrder(t),u=this.getFrameLayerDepths(t),d=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const f=c[t],p=d[f],m=f*this.numLayerColors,y=Math.floor(u[f]*s),w=e==O.Left?-y:y;if(this.layerVisibility[f+1])for(let t=a,s=0;s<h;t++,s++)for(let e=o,h=0;h<n;e++,h++){const o=s*n+h+w;let a=p[t*r+e];0!==a&&(i[o]=l[m+a])}}return i}getFramePixelsRgba(t,i=new Uint32Array(this.imageWidth*this.imageHeight),s=new Uint32Array(16),e=0,r=O.Left){l(t,0,this.frameCount-1,"Frame index");const n=this.srcWidth,h=this.imageWidth,o=this.imageWidth,a=this.imageHeight,c=this.imageOffsetX,u=this.imageOffsetY;this.getFramePaletteUint32(t,s),i.fill(s[0]);const d=this.getFrameLayerOrder(t),f=this.getFrameLayerDepths(t),p=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const l=d[t];if(!this.layerVisibility[l+1])continue;const m=p[l],y=l*this.numLayerColors,w=Math.floor(f[l]*e),g=r==O.Left?-w:w;for(let t=u,e=0;t<a;t++,e++)for(let r=c,a=0;r<o;r++,a++){const o=e*h+a+g;let l=m[t*n+r];0!==l&&(i[o]=s[y+l])}}return i}getFramePaletteUint32(t,i=new Uint32Array(16)){l(t,0,this.frameCount-1,"Frame index");const s=this.getFramePalette(t);return i.fill(0),s.forEach((([t,s,e,r],n)=>i[n]=r<<24|e<<16|s<<8|t)),i}getSoundEffectFlagsForTrack(t){return this.getSoundEffectFlags().map((i=>i[t]))}isSoundEffectUsedOnFrame(t,i){return l(i,0,this.frameCount-1,"Frame index"),!!this.soundEffectTracks.includes(t)&&this.getFrameSoundEffectFlags(i)[t]}hasAudioTrack(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0}}const H=[.5,.5,1,2,4,6,12,20,30],G={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},V=[4294967295,4283585106,4294967295,4288453788,4282665215,4283388360,4289506815,4278255360,4294918216,4290269009,4294945709,4278255360,4290205622,4278255360,4278255360,4278255360],q="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCPLwTL6oSflv+gjywi/sM0TUB\n90xqOvuCpjduETjPoN2FwMebxNjdKIqHUyDu4AvrQ6BDJc6gKUbZ1E27BGZoCPH4\n9zQRb+zAM6M9EjHwQ6BABr0u2TcF7xGg2uQ9MBWz9AfbVQ91NjfrNWo0f7UPmffv\n1VvixmTk1BCtavZxBwIDAQAB\n-----END PUBLIC KEY-----";class PpmParser extends FlipnoteParserBase{constructor(i,s={}){super(i),this.format=t.FlipnoteFormat.PPM,this[W]="Flipnote Studio PPM animation file",this.imageWidth=PpmParser.width,this.imageHeight=PpmParser.height,this.aspect=PpmParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=PpmParser.numLayers,this.numLayerColors=PpmParser.numLayerColors,this.publicKey=PpmParser.publicKey,this.srcWidth=PpmParser.width,this.audioTracks=PpmParser.audioTracks,this.soundEffectTracks=PpmParser.soundEffectTracks,this.rawSampleRate=PpmParser.rawSampleRate,this.sampleRate=PpmParser.sampleRate,this.globalPalette=PpmParser.globalPalette,this.prevDecodedFrame=null,this.decodeHeader(),this.decodeAnimationHeader(),this.decodeSoundHeader(),this.version>>4&15&&this.decodeMeta(),this.layerBuffers=[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],this.prevLayerBuffers=[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],this.lineEncodingBuffers=[new Uint8Array(PpmParser.height),new Uint8Array(PpmParser.height)],this.prevDecodedFrame=null}decodeHeader(){a(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16();let t=1696+this.frameDataLength+this.frameCount;t%4!=0&&(t+=4-t%4),a(t<this.byteLength),this.soundDataOffset=t}readFilename(){return`${this.readHex(3)}_${this.readChars(13)}_${this.readUint16().toString().padStart(3,"0")}`}decodeMeta(){a(1704<this.byteLength),this.seek(16);const t=this.readUint16(),i=this.readInt16(),s=this.readWideChars(11),e=this.readWideChars(11),r=this.readWideChars(11),n=this.readHex(8,!0),h=this.readHex(8,!0),o=this.readFilename(),l=this.readFilename(),c=this.readHex(8,!0);this.seek(154);const u=A(this.readInt32());this.seek(1702);const d=this.readUint16();this.thumbFrameIndex=i,this.layerVisibility={1:!(16&d),2:!(32&d),3:!1},this.isSpinoff=h!==n||h!==c,this.meta={lock:1===t,loop:1==(d>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:i,timestamp:u,root:{username:s,fsid:c,region:I(c),filename:null},parent:{username:e,fsid:n,region:I(n),filename:o},current:{username:r,fsid:h,region:I(h),filename:l}}}decodeAnimationHeader(){this.seek(1696);const t=this.readUint16(),i=t/4;a(i<=this.frameCount),this.seek(1704);const s=new Uint32Array(i);for(let e=0;e<i;e++){const i=1704+t+this.readUint32();a(i<this.byteLength,`Frame ${e} pointer is out of bounds`),s[e]=i}this.frameOffsets=s}decodeSoundHeader(){let i=this.soundDataOffset;this.seek(i);const s=this.readUint32(),e=this.readUint32(),r=this.readUint32(),n=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),a(this.frameSpeed<=8&&this.bgmSpeed<=8),i+=32,this.framerate=H[this.frameSpeed],this.duration=C(this.frameCount,this.framerate),this.bgmrate=H[this.bgmSpeed];const h=new Map;h.set(t.FlipnoteAudioTrack.BGM,{ptr:i,length:s}),h.set(t.FlipnoteAudioTrack.SE1,{ptr:i+=s,length:e}),h.set(t.FlipnoteAudioTrack.SE2,{ptr:i+=e,length:r}),h.set(t.FlipnoteAudioTrack.SE3,{ptr:i+=r,length:n}),this.soundMeta=h}isKeyFrame(t){return l(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]),this.readUint8()>>7&1}getThumbnailImage(){this.seek(160);const t=this.readBytes(1536),i=new Uint32Array(3072);for(let s=0;s<48;s+=8)for(let e=0;e<64;e+=8)for(let r=0;r<8;r+=1)for(let n=0;n<8;n+=2){const h=e+n,o=s+r;i[64*o+h]=V[15&t[0]],i[64*o+h+1]=V[t[0]<<4&15]}return{format:K.Rgba,width:64,height:48,data:i.buffer}}decodeFrame(t){if(l(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame===t-1||this.isKeyFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);const i=this.readUint8(),s=i>>7&1,e=i>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);let r=0,n=0;e&&(r=this.readInt8(),n=this.readInt8());for(let t=0;t<2;t++){const i=this.lineEncodingBuffers[t];i.fill(0);for(let t=0;t<i.length;){let s=this.readUint8();0!==s?(i[t++]=3&s,i[t++]=s>>2&3,i[t++]=s>>4&3,i[t++]=s>>6&3):t+=4}}for(let t=0;t<2;t++){const i=this.layerBuffers[t],s=this.lineEncodingBuffers[t];for(let t=0;t<PpmParser.height;t++){let e=t*PpmParser.width;switch(s[t]){case 0:break;case 1:for(var h=this.readUint32(!1);0!==h;h<<=1,e+=8)if(2147483648&h){let t=this.readUint8();for(let s=0;0!==t;s++,t>>=1)i[e+s]=1&t}break;case 2:for(i.fill(1,e,e+PpmParser.width),h=this.readUint32(!1);0!==h;h<<=1,e+=8)if(2147483648&h){let t=this.readUint8();for(let s=0;s<8;s++,t>>=1)i[e+s]=1&t}break;case 3:for(let t=0,s=0;s<PpmParser.width;s++)s%8==0&&(t=this.readUint8()),i[e++]=1&t,t>>=1}}}const o=this.layerBuffers[0],a=this.layerBuffers[1],c=this.prevLayerBuffers[0],u=this.prevLayerBuffers[1];if(s||0!==r||0!==n){if(!s){const t=PpmParser.width,i=PpmParser.height,s=Math.max(r,0),e=Math.max(n,0),h=Math.min(t+r,t),l=Math.min(i+n,i),d=n*t+r;let f,p;for(let i=e;i<l;i++)for(let e=s;e<h;e++)f=i*t+e,p=f-d,o[f]^=c[p],a[f]^=u[p]}}else{const t=PpmParser.height*PpmParser.width;for(let i=0;i<t;i++)o[i]^=c[i],a[i]^=u[i]}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers}getFramePaletteIndices(t){l(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]);const i=this.readUint8(),s=!!(1&~i),e=[s?0:1,s?0:1,2,3];return[s?1:0,e[i>>1&3],e[i>>3&3]]}getFramePalette(t){return l(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((t=>this.globalPalette[t]))}getIsKeyFrame(t){const i=1===this.isKeyFrame(t);return[i,i]}getFrameLayerDepths(t){return[0,0]}getFrameAuthor(t){return this.meta.current.fsid}getFrameCameraFlags(t){return[!1,!1]}getFrameLayerOrder(t){return[1,0]}decodeSoundFlags(){if(void 0!==this.soundFlags)return this.soundFlags;a(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);const t=this.frameCount,i=this.readBytes(t);this.soundFlags=new Array(t);for(let s=0;s<t;s++){const t=i[s];this.soundFlags[s]=[!!(1&t),!!(2&t),!!(4&t)]}return this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map((i=>({[t.FlipnoteSoundEffectTrack.SE1]:i[0],[t.FlipnoteSoundEffectTrack.SE2]:i[1],[t.FlipnoteSoundEffectTrack.SE3]:i[2],[t.FlipnoteSoundEffectTrack.SE4]:!1})))}getFrameSoundEffectFlags(i){l(i,0,this.frameCount-1,"Frame index"),this.seek(1696+this.frameDataLength+i);const s=this.readUint8();return{[t.FlipnoteSoundEffectTrack.SE1]:!!(1&s),[t.FlipnoteSoundEffectTrack.SE2]:!!(2&s),[t.FlipnoteSoundEffectTrack.SE3]:!!(4&s),[t.FlipnoteSoundEffectTrack.SE4]:!1}}getAudioTrackRaw(t){const i=this.soundMeta.get(t);return a(i.ptr+i.length<this.byteLength),this.seek(i.ptr),this.readBytes(i.length)}decodeAudioTrack(t){const i=this.getAudioTrackRaw(t),n=i.length,h=new Int16Array(2*n);let o=0,a=0,l=0,c=0,u=0,d=!0;for(;o<n;){l=d?15&i[o]:i[o++]>>4,d=!d;const t=e[c];let n=t>>3;1&l&&(n+=t>>2),2&l&&(n+=t>>1),4&l&&(n+=t),8&l&&(n=-n),u+=n,u=r(u,-32768,32767),c+=s[l],c=r(c,0,88),h[a++]=u}return h}getAudioTrackPcm(i,s=this.sampleRate){const e=this.decodeAudioTrack(i);let r=this.rawSampleRate;if(i===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==s?function(t,i,s){const e=t.length,r=e/i*s,h=new Int16Array(r),o=i/s;for(let i=0;i<r;i++)h[i]=n(t,e,Math.floor(i*o));return h}(e,r,s):e}pcmAudioMix(t,i,s=0){const e=t.length,n=i.length;for(let h=0;h<e&&!(s+h>n);h++){const e=i[s+h]+t[h]/2;i[s+h]=r(e,-32768,32767)}}getAudioMasterPcm(i=this.sampleRate){const s=Math.ceil(this.duration*i),e=new Int16Array(s),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(r){const s=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,i);this.pcmAudioMix(s,e,0)}if(n||o||a){const s=i/this.framerate,r=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,i):null,h=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,i):null,l=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,i):null,c=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const i=Math.ceil(t*s),u=c[t];n&&u[0]&&this.pcmAudioMix(r,e,i),o&&u[1]&&this.pcmAudioMix(h,e,i),a&&u[2]&&this.pcmAudioMix(l,e,i)}}return this.audioClipRatio=h(e),e}getBody(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(0,t)}getSignature(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(t,t+128)}async verify(){const t=await b(q,"SHA-1");return await P(t,this.getSignature(),this.getBody())}}var Q;W=Symbol.toStringTag,PpmParser.defaultSettings={},PpmParser.format=t.FlipnoteFormat.PPM,PpmParser.width=256,PpmParser.height=192,PpmParser.aspect=3/4,PpmParser.numLayers=2,PpmParser.numLayerColors=1,PpmParser.rawSampleRate=8192,PpmParser.sampleRate=32768,PpmParser.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3],PpmParser.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3],PpmParser.globalPalette=[G.WHITE,G.BLACK,G.RED,G.BLUE],PpmParser.publicKey=q;const Z=[.2,.5,1,2,4,6,8,12,20,24,30],Y={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},J="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuv+zHAXXvbbtRqxADDeJ\nArX2b9RMxj3T+qpRg3FnIE/jeU3tj7eoDzsMduY+D/UT9CSnP+QHYY/vf0n5lqX9\ns6ljoZAmyUuruyj1e5Bg+fkDEu/yPEPQjqhbyywCyYL4TEAOJveopUBx9fdQxUJ6\nJ4J5oCE/Im1kFrlGW+puARiHmt3mmUyNzO8bI/Jx3cGSfoOHJG1foEaQsI5aaKqA\npBqxtzvwqMhudcZtAWSyRMBMlndvkRnVTDNTfTXLOYdHShCIgnKULCTH87uLBIP/\nnsmr4/bnQz8q2rp/HyVO+0yjR6mVr0NX5APJQ+6riJmGg3t3VOldhKP7aTHDUW+h\nkQIDAQAB\n-----END PUBLIC KEY-----",X=new Uint16Array(16);for(let t=0;t<16;t++)X[t]=(1<<t)-1;const tt=new Uint8Array(52488),it=new Uint8Array(52488);var st=0;for(let t=0;t<3;t++)for(let i=0;i<3;i++)for(let s=0;s<3;s++)for(let e=0;e<3;e++)for(let r=0;r<3;r++)for(let n=0;n<3;n++)for(let h=0;h<3;h++)for(let o=0;o<3;o++)tt.set([i,t,e,s,n,r,o,h],st),it.set([t,e,s,n,r,o,h,i],st),st+=8;const et=new Uint8Array(256),rt=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach(((t,i)=>{const s=8*t,e=tt.subarray(s,s+8),r=it.subarray(s,s+8);et.set(e,8*i),rt.set(r,8*i)}));class KwzParser extends FlipnoteParserBase{constructor(i,s={}){super(i),this.format=t.FlipnoteFormat.KWZ,this[Q]="Flipnote Studio 3D KWZ animation file",this.imageWidth=KwzParser.width,this.imageHeight=KwzParser.height,this.aspect=KwzParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=KwzParser.numLayers,this.numLayerColors=KwzParser.numLayerColors,this.publicKey=KwzParser.publicKey,this.srcWidth=KwzParser.width,this.audioTracks=KwzParser.audioTracks,this.soundEffectTracks=KwzParser.soundEffectTracks,this.rawSampleRate=KwzParser.rawSampleRate,this.sampleRate=KwzParser.sampleRate,this.globalPalette=KwzParser.globalPalette,this.prevDecodedFrame=null,this.bitIndex=0,this.bitValue=0,this.settings={...KwzParser.defaultSettings,...s},this.layerBuffers=[new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height)],this.buildSectionMap(),this.sectionMap.has("KIC")?(this.isFolderIcon=!0,this.imageWidth=24,this.imageHeight=24,this.frameCount=1,this.frameSpeed=0,this.framerate=Z[0],this.thumbFrameIndex=0,this.getFrameOffsets()):this.sectionMap.has("KSN")?(this.decodeMeta(),this.getFrameOffsets(),this.decodeSoundHeader()):(this.isComment=!0,this.decodeMeta(),this.getFrameOffsets()),this.settings.dsiLibraryNote&&(this.isDsiLibraryNote=!0),this.settings.borderCrop&&(this.isDsiLibraryNote?(this.imageOffsetX=32,this.imageOffsetY=24,this.imageWidth=256,this.imageHeight=192):this.isFolderIcon||(this.imageOffsetX=5,this.imageOffsetY=5,this.imageWidth=310,this.imageHeight=230))}buildSectionMap(){const t=this.byteLength-256,i=new Map;let s=0,e=0;for(;e<t&&s<6;){this.seek(e);const t=this.readChars(4).substring(0,3),r=this.readUint32();i.set(t,{ptr:e,length:r}),e+=r+8,s+=1}this.bodyEndOffset=e,this.sectionMap=i,a(i.has("KMC")&&i.has("KMI"))}readBits(t){if(this.bitIndex+t>16){const t=this.readUint16();this.bitValue|=t<<16-this.bitIndex,this.bitIndex-=16}const i=this.bitValue&X[t];return this.bitValue>>=t,this.bitIndex+=t,i}readFsid(){if(this.settings.dsiLibraryNote)return this.readHex(10,!0).slice(2,18);const t=this.readHex(10);return`${t.slice(0,4)}-${t.slice(4,8)}-${t.slice(8,12)}-${t.slice(12,18)}`.toLowerCase()}readFilename(){const t=this.pointer,i=this.readChars(28);if(28===i.length)return i;this.seek(t);const s=this.readHex(3),e=this.readChars(13),r=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),`${s}_${e}_${r}`}decodeMeta(){if(this.settings.quickMeta)return this.decodeMetaQuick();a(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);const t=A(this.readUint32()),i=A(this.readUint32());this.readUint32();const s=this.readFsid(),e=this.readFsid(),r=this.readFsid(),n=this.readWideChars(11),h=this.readWideChars(11),o=this.readWideChars(11),l=this.readFilename(),c=this.readFilename(),u=this.readFilename(),d=this.readUint16(),f=this.readUint16(),p=this.readUint16(),m=this.readUint8(),y=this.readUint8();this.isSpinoff=r!==e||r!==s,this.frameCount=d,this.frameSpeed=m,this.framerate=Z[m],this.duration=C(this.frameCount,this.framerate),this.thumbFrameIndex=f,this.layerVisibility={1:!(1&y),2:!(2&y),3:!(3&y)},this.meta={lock:!!(1&p),loop:!!(2&p),isSpinoff:this.isSpinoff,frameCount:d,frameSpeed:m,duration:this.duration,thumbIndex:f,timestamp:i,creationTimestamp:t,root:{username:n,fsid:s,region:L(s),filename:l,isDsiFilename:28!==l.length},parent:{username:h,fsid:e,region:L(e),filename:c,isDsiFilename:28!==c.length},current:{username:o,fsid:r,region:L(r),filename:u,isDsiFilename:28!==u.length}}}decodeMetaQuick(){a(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);const t=this.readUint16(),i=this.readUint16();this.readUint16();const s=this.readUint8(),e=this.readUint8();this.frameCount=t,this.thumbFrameIndex=i,this.frameSpeed=s,this.framerate=Z[s],this.duration=C(this.frameCount,this.framerate),this.layerVisibility={1:!(1&e),2:!(2&e),3:!(3&e)}}getFrameOffsets(){a(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));const t=this.frameCount,i=this.sectionMap.get("KMI"),s=this.sectionMap.get("KMC");a(i.length/28>=t);const e=new Uint32Array(t),r=new Uint32Array(t),n=[];let h=i.ptr+8,o=s.ptr+12;for(let i=0;i<t;i++){this.seek(h+4);const t=this.readUint16(),s=this.readUint16(),l=this.readUint16();e[i]=h,r[i]=o,h+=28,o+=t+s+l,a(h<this.byteLength,`frame${i} meta pointer out of bounds`),a(o<this.byteLength,`frame${i} data pointer out of bounds`),n.push([t,s,l])}this.frameMetaOffsets=e,this.frameDataOffsets=r,this.frameLayerSizes=n}decodeSoundHeader(){a(this.sectionMap.has("KSN"));let i=this.sectionMap.get("KSN").ptr+8;this.seek(i),this.bgmSpeed=this.readUint32(),a(this.bgmSpeed<=10),this.bgmrate=Z[this.bgmSpeed];const s=new Uint32Array(this.buffer,i+4,20),e=new Map;e.set(t.FlipnoteAudioTrack.BGM,{ptr:i+=28,length:s[0]}),e.set(t.FlipnoteAudioTrack.SE1,{ptr:i+=s[0],length:s[1]}),e.set(t.FlipnoteAudioTrack.SE2,{ptr:i+=s[1],length:s[2]}),e.set(t.FlipnoteAudioTrack.SE3,{ptr:i+=s[2],length:s[3]}),e.set(t.FlipnoteAudioTrack.SE4,{ptr:i+=s[3],length:s[4]}),this.soundMeta=e}getThumbnailImage(){a(this.sectionMap.has("KTN"),"KTN section missing - Note that folder icons and comments do not contain thumbnail data");const t=this.sectionMap.get("KTN");this.seek(t.ptr+12);const i=this.readBytes(t.length-12);return{format:K.Jpeg,width:80,height:64,data:i.buffer}}getFramePaletteIndices(t){l(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]);const i=this.readUint32();return[15&i,i>>8&15,i>>12&15,i>>16&15,i>>20&15,i>>24&15,i>>28&15]}getFramePalette(t){return l(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((t=>this.globalPalette[t]))}getFrameDiffingFlag(t){return l(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]),this.readUint32()>>4&7}getIsKeyFrame(t){const i=this.getFrameDiffingFlag(t);return[!(1&i),!(2&i),!(4&i)]}getFrameLayerDepths(t){return l(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]}getFrameAuthor(t){return l(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+10),this.readFsid()}getFrameCameraFlags(t){this.seek(this.frameMetaOffsets[t]+26);const i=this.readUint8();return[!!(1&i),!!(2&i),!!(4&i)]}getFrameLayerOrder(t){l(t,0,this.frameCount-1,"Frame index");const i=this.getFrameLayerDepths(t);return[2,1,0].sort(((t,s)=>i[s]-i[t]))}decodeFrame(t,i=7,s=!1){if(l(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame!==t-1&&0!==t&&(s&&(i&=~this.getFrameDiffingFlag(t+1)),0!==i&&this.decodeFrame(t-1,i,!0));let e=this.frameDataOffsets[t];const r=this.frameLayerSizes[t];for(let t=0;t<3&&(!this.settings.dsiLibraryNote||3!==t);t++){this.seek(e);let s=r[t];e+=s;const n=this.layerBuffers[t];if(38===s)continue;if(!(i>>t&1))continue;this.bitIndex=16,this.bitValue=0;let h=0;for(let t=0;t<240;t+=128)for(let i=0;i<320;i+=128)for(let s=0;s<128;s+=8){const e=t+s;if(e>=240)break;for(let t=0;t<128;t+=8){const s=i+t;if(s>=320)break;if(h>0){h-=1;continue}let r=e*KwzParser.width+s;const o=this.readBits(3);if(0===o){const t=8*this.readBits(5),i=et.subarray(t,t+8);n.set(i,r),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320)}else if(1===o){const t=8*this.readBits(13),i=tt.subarray(t,t+8);n.set(i,r),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320),n.set(i,r+=320)}else if(2===o){const t=8*this.readBits(5),i=et.subarray(t,t+8),s=rt.subarray(t,t+8);n.set(i,r),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320)}else if(3===o){const t=8*this.readBits(13),i=tt.subarray(t,t+8),s=it.subarray(t,t+8);n.set(i,r),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320)}else if(4===o){const t=this.readBits(8);for(let i=1;i<255;i<<=1){if(t&i){const t=8*this.readBits(5),i=et.subarray(t,t+8);n.set(i,r)}else{const t=8*this.readBits(13),i=tt.subarray(t,t+8);n.set(i,r)}r+=320}}else{if(5===o){h=this.readBits(5);continue}if(7===o){let t,i,s=this.readBits(2);if(0!==this.readBits(1)){const e=8*this.readBits(5),r=8*this.readBits(5);t=et.subarray(e,e+8),i=et.subarray(r,r+8),s+=1}else{const s=8*this.readBits(13),e=8*this.readBits(13);t=tt.subarray(s,s+8),i=tt.subarray(e,e+8)}switch(s%4){case 0:n.set(t,r),n.set(i,r+=320),n.set(t,r+=320),n.set(i,r+=320),n.set(t,r+=320),n.set(i,r+=320),n.set(t,r+=320),n.set(i,r+=320);break;case 1:n.set(t,r),n.set(t,r+=320),n.set(i,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(i,r+=320),n.set(t,r+=320),n.set(t,r+=320);break;case 2:n.set(t,r),n.set(i,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(i,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(i,r+=320);break;case 3:n.set(t,r),n.set(i,r+=320),n.set(i,r+=320),n.set(t,r+=320),n.set(i,r+=320),n.set(i,r+=320),n.set(t,r+=320),n.set(i,r+=320)}}}}}}return this.prevDecodedFrame=t,this.layerBuffers}decodeFrameSoundFlags(t){l(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+23);const i=this.readUint8();return[!!(1&i),!!(2&i),!!(4&i),!!(8&i)]}decodeSoundFlags(){return void 0!==this.soundFlags||(this.soundFlags=new Array(this.frameCount).fill(!1).map(((t,i)=>this.decodeFrameSoundFlags(i)))),this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map((i=>({[t.FlipnoteSoundEffectTrack.SE1]:i[0],[t.FlipnoteSoundEffectTrack.SE2]:i[1],[t.FlipnoteSoundEffectTrack.SE3]:i[2],[t.FlipnoteSoundEffectTrack.SE4]:i[3]})))}getFrameSoundEffectFlags(i){const s=this.decodeFrameSoundFlags(i);return{[t.FlipnoteSoundEffectTrack.SE1]:s[0],[t.FlipnoteSoundEffectTrack.SE2]:s[1],[t.FlipnoteSoundEffectTrack.SE3]:s[2],[t.FlipnoteSoundEffectTrack.SE4]:s[3]}}getAudioTrackRaw(t){const i=this.soundMeta.get(t);return a(i.ptr+i.length<this.byteLength),new Uint8Array(this.buffer,i.ptr,i.length)}decodeAdpcm(t,n,h=0,o=0){const a=t.length;let l=0,c=0,u=0,d=0;for(let f=0;f<a;f++){let a=t[f],p=0;for(;p<8;)o<18||p>4?(c=3&a,u=e[o],d=u>>3,1&c&&(d+=u),2&c&&(d=-d),h+=d,o+=i[c],a>>=2,p+=2):(c=15&a,u=e[o],d=u>>3,1&c&&(d+=u>>2),2&c&&(d+=u>>1),4&c&&(d+=u),8&c&&(d=-d),h+=d,o+=s[c],a>>=4,p+=4),o=r(o,0,79),h=r(h,-2048,2047),n[l]=16*h,l+=1}return l}decodeAudioTrack(i){const s=this.settings,e=this.getAudioTrackRaw(i),r=60*this.rawSampleRate,n=new Int16Array(r);let h=0,a=40;if(this.isDsiLibraryNote)if(i===t.FlipnoteAudioTrack.BGM){let t=!0;if(null!==s.initialBgmPredictor&&(h=s.initialBgmPredictor,t=!1),null!==s.initialBgmStepIndex&&(a=s.initialBgmStepIndex,t=!1),t&&s.guessInitialBgmState){let t=4294967295,i=0;for(a=0;a<=40;a++){const s=this.decodeAdpcm(e,n,h,a),r=o(n.subarray(0,s));r<t&&(t=r,i=a)}a=i}}else{const t=this.soundEffectTracks.indexOf(i);Array.isArray(s.initialSePredictors)&&void 0!==s.initialSePredictors[t]&&(h=s.initialSePredictors[t]),Array.isArray(s.initialSeStepIndices)&&void 0!==s.initialSeStepIndices[t]&&(a=s.initialSeStepIndices[t])}const l=this.decodeAdpcm(e,n,h,a);return n.slice(0,l)}getAudioTrackPcm(i,s=this.sampleRate){const e=this.decodeAudioTrack(i);let r=this.rawSampleRate;if(i===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==s?function(t,i,s){const e=t.length,r=e/i*s,h=new Int16Array(r),o=i/s;for(let i=0,s=0,l=0,c=0;i<r;i++)s=i*o,l=Math.floor(s),c=s%1,h[i]=(a=n(t,e,l))+c*(n(t,e,l+1)-a);var a;return h}(e,r,s):e}pcmAudioMix(t,i,s=0){const e=t.length,n=i.length;for(let h=0;h<e&&!(s+h>n);h++){const e=i[s+h]+t[h];i[s+h]=r(e,-32768,32767)}}getAudioMasterPcm(i=this.sampleRate){const s=Math.ceil(this.duration*i),e=new Int16Array(s),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),l=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(r){const s=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,i);this.pcmAudioMix(s,e,0)}if(n||o||a||l){const s=i/this.framerate,r=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,i):null,h=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,i):null,c=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,i):null,u=l?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,i):null,d=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const i=d[t],f=Math.ceil(t*s);n&&i[0]&&this.pcmAudioMix(r,e,f),o&&i[1]&&this.pcmAudioMix(h,e,f),a&&i[2]&&this.pcmAudioMix(c,e,f),l&&i[3]&&this.pcmAudioMix(u,e,f)}}return this.audioClipRatio=h(e),e}getBody(){const t=this.bodyEndOffset;return this.bytes.subarray(0,t)}getSignature(){const t=this.bodyEndOffset;return this.bytes.subarray(t,t+256)}async verify(){const t=await b(J,"SHA-256");return await P(t,this.getSignature(),this.getBody())}}Q=Symbol.toStringTag,KwzParser.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,guessInitialBgmState:!0,initialBgmPredictor:null,initialBgmStepIndex:null,initialSePredictors:null,initialSeStepIndices:null},KwzParser.format=t.FlipnoteFormat.KWZ,KwzParser.width=320,KwzParser.height=240,KwzParser.aspect=3/4,KwzParser.numLayers=3,KwzParser.numLayerColors=2,KwzParser.rawSampleRate=16364,KwzParser.sampleRate=32768,KwzParser.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3,t.FlipnoteAudioTrack.SE4],KwzParser.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3,t.FlipnoteSoundEffectTrack.SE4],KwzParser.globalPalette=[Y.WHITE,Y.BLACK,Y.RED,Y.YELLOW,Y.GREEN,Y.BLUE,Y.NONE],KwzParser.publicKey=J;const nt=[{matches:t=>d&&"string"==typeof t,load(t,i,s){const e=new XMLHttpRequest;e.open("GET",t,!0),e.responseType="arraybuffer",e.onreadystatechange=function(t){4===e.readyState&&(e.status>=200&&e.status<300?i(e.response):s({type:"httpError",status:e.status,statusText:e.statusText}))},e.send(null)}},{matches:t=>p&&"string"==typeof t,load(t,i,s){m(),c(module,"https").get(t,(t=>{const e=[];t.on("data",(t=>e.push(t))),t.on("end",(()=>{const t=Buffer.concat(e);i(t.buffer)})),t.on("error",(t=>s(t)))}))}},{matches:t=>d&&"undefined"!=typeof File&&"undefined"!=typeof FileReader&&t instanceof File,load(t,i,s){const e=new FileReader;e.onload=t=>{i(e.result)},e.onerror=t=>{s({type:"fileReadError"})},e.readAsArrayBuffer(t)}},{matches:t=>d&&"undefined"!=typeof Blob&&"undefined"!=typeof Response&&t instanceof Blob,load(t,i,s){new Response(t).arrayBuffer().then(i).catch(s)}},{matches:t=>p&&t instanceof Buffer,load(t,i,s){i(t.buffer)}},{matches:t=>t instanceof ArrayBuffer,load(t,i,s){i(t)}}];function ht(t,i=nt){return new Promise(((s,e)=>{for(let r=0;r<i.length;r++){const n=i[r];if(n.matches(t))return n.load(t,s,e)}e("No loader available for source type")}))}const ot=(t,i,s)=>ht(t,s).then((t=>new Promise(((s,e)=>{const r=new Uint8Array(t.slice(0,4)),n=r[0]<<24|r[1]<<16|r[2]<<8|r[3];1346458177===n?s(new PpmParser(t,i)):1262897152==(4294967040&n)||1263092480==(4294967040&n)?s(new KwzParser(t,i)):e("Could not identify source as a valid Flipnote file")}))));var at;t.PlayerEvent=void 0,(at=t.PlayerEvent||(t.PlayerEvent={})).t="any",at.Play="play",at.Pause="pause",at.CanPlay="canplay",at.CanPlayThrough="canplaythrough",at.SeekStart="seeking",at.SeekEnd="seeked",at.Duration="durationchange",at.Loop="loop",at.Ended="ended",at.VolumeChange="volumechange",at.Progress="progress",at.TimeUpdate="timeupdate",at.FrameUpdate="frameupdate",at.FrameNext="framenext",at.FramePrev="frameprev",at.FrameFirst="framefirst",at.FrameLast="framelast",at.Ready="ready",at.Load="load",at.LoadStart="loadstart",at.LoadedData="loadeddata",at.LoadedMeta="loadedmetadata",at.Emptied="emptied",at.Close="close",at.Error="error",at.Destroy="destroy";const lt=[t.PlayerEvent.Play,t.PlayerEvent.Pause,t.PlayerEvent.CanPlay,t.PlayerEvent.CanPlayThrough,t.PlayerEvent.SeekStart,t.PlayerEvent.SeekEnd,t.PlayerEvent.Duration,t.PlayerEvent.Loop,t.PlayerEvent.Ended,t.PlayerEvent.VolumeChange,t.PlayerEvent.Progress,t.PlayerEvent.TimeUpdate,t.PlayerEvent.FrameUpdate,t.PlayerEvent.FrameNext,t.PlayerEvent.FramePrev,t.PlayerEvent.FrameFirst,t.PlayerEvent.FrameLast,t.PlayerEvent.Ready,t.PlayerEvent.Load,t.PlayerEvent.LoadStart,t.PlayerEvent.LoadedData,t.PlayerEvent.LoadedMeta,t.PlayerEvent.Emptied,t.PlayerEvent.Close,t.PlayerEvent.Error];function ct(t){return{length:t.length,start:i=>t[i][0],end:i=>t[i][1]}}function ut(t,i){return t.toString().padStart(i,"0")}function dt(t){return`${Math.floor(t%3600/60)}:${ut(Math.floor(t%60),2)}`}var ft;!function(t){t[t.None=0]="None",t[t.Dual=1]="Dual",t[t.Anaglyph=2]="Anaglyph"}(ft||(ft={}));const pt=5120,mt=5121,yt=5122,wt=5123,gt=5124,vt=5125,bt=5126;{const t={};t[pt]=Int8Array,t[mt]=Uint8Array,t[yt]=Int16Array,t[wt]=Uint16Array,t[gt]=Int32Array,t[vt]=Uint32Array,t[bt]=Float32Array,t[32819]=Uint16Array,t[32820]=Uint16Array,t[33635]=Uint16Array,t[5131]=Uint16Array,t[33640]=Uint32Array,t[35899]=Uint32Array,t[35902]=Uint32Array,t[36269]=Uint32Array,t[34042]=Uint32Array}function Pt(t){if(t instanceof Int8Array)return pt;if(t instanceof Uint8Array)return mt;if(t instanceof Uint8ClampedArray)return mt;if(t instanceof Int16Array)return yt;if(t instanceof Uint16Array)return wt;if(t instanceof Int32Array)return gt;if(t instanceof Uint32Array)return vt;if(t instanceof Float32Array)return bt;throw new Error("unsupported typed array type")}const At="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function Ct(t,i){return"undefined"!=typeof WebGLTexture&&i instanceof WebGLTexture}const St=35044,xt=34962,_t="";function Ft(t,i,s,e){if("undefined"!=typeof WebGLBuffer&&i instanceof WebGLBuffer)return i;s=s||xt;const r=t.createBuffer();return function(t,i,s,e,r){t.bindBuffer(i,s),t.bufferData(i,e,r||St)}(t,s,r,i,e),r}function zt(t){return"indices"===t}const Ut=/coord|texture/i,Et=/color|colour/i;function Mt(t,i){let s;if(s=Ut.test(t)?2:Et.test(t)?4:3,i%s>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${s} but ${i} values is not evenly divisible by ${s}. You should specify it.`);return s}function Tt(t,i){if(At(t))return t;if(At(t.data))return t.data;Array.isArray(t)&&(t={data:t});let s=t.type;return s||(s=zt(i)?Uint16Array:Float32Array),new s(t.data)}const It=["position","positions","a_position"];function Lt(t){return!!t.texStorage2D}const Bt=33984,kt=34962,$t=3553,Nt=34067,Kt=32879,Ot=35866,Dt={};function Rt(t,i){return Dt[i].bindPoint}function Wt(t,i){return function(s){t.uniform1i(i,s)}}function jt(t,i){return function(s){t.uniform1iv(i,s)}}function Ht(t,i){return function(s){t.uniform2iv(i,s)}}function Gt(t,i){return function(s){t.uniform3iv(i,s)}}function Vt(t,i){return function(s){t.uniform4iv(i,s)}}function qt(t,i,s,e){const r=Rt(0,i);return Lt(t)?function(i){let n,h;Ct(0,i)?(n=i,h=null):(n=i.texture,h=i.sampler),t.uniform1i(e,s),t.activeTexture(Bt+s),t.bindTexture(r,n),t.bindSampler(s,h)}:function(i){t.uniform1i(e,s),t.activeTexture(Bt+s),t.bindTexture(r,i)}}function Qt(t,i,s,e,r){const n=Rt(0,i),h=new Int32Array(r);for(let t=0;t<r;++t)h[t]=s+t;return Lt(t)?function(i){t.uniform1iv(e,h),i.forEach((function(i,e){let r,o;t.activeTexture(Bt+h[e]),Ct(0,i)?(r=i,o=null):(r=i.texture,o=i.sampler),t.bindSampler(s,o),t.bindTexture(n,r)}))}:function(i){t.uniform1iv(e,h),i.forEach((function(i,s){t.activeTexture(Bt+h[s]),t.bindTexture(n,i)}))}}function Zt(t,i){return function(s){if(s.value)switch(t.disableVertexAttribArray(i),s.value.length){case 4:t.vertexAttrib4fv(i,s.value);break;case 3:t.vertexAttrib3fv(i,s.value);break;case 2:t.vertexAttrib2fv(i,s.value);break;case 1:t.vertexAttrib1fv(i,s.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(kt,s.buffer),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,s.numComponents||s.size,s.type||5126,s.normalize||!1,s.stride||0,s.offset||0),void 0!==s.divisor&&t.vertexAttribDivisor(i,s.divisor)}}function Yt(t,i){return function(s){if(s.value){if(t.disableVertexAttribArray(i),4!==s.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(i,s.value)}else t.bindBuffer(kt,s.buffer),t.enableVertexAttribArray(i),t.vertexAttribIPointer(i,s.numComponents||s.size,s.type||5124,s.stride||0,s.offset||0),void 0!==s.divisor&&t.vertexAttribDivisor(i,s.divisor)}}function Jt(t,i){return function(s){if(s.value){if(t.disableVertexAttribArray(i),4!==s.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(i,s.value)}else t.bindBuffer(kt,s.buffer),t.enableVertexAttribArray(i),t.vertexAttribIPointer(i,s.numComponents||s.size,s.type||5125,s.stride||0,s.offset||0),void 0!==s.divisor&&t.vertexAttribDivisor(i,s.divisor)}}function Xt(t,i,s){const e=s.size,r=s.count;return function(s){t.bindBuffer(kt,s.buffer);const n=s.size||s.numComponents||e,h=n/r,o=s.type||5126,a=Dt[o].size*n,l=s.normalize||!1,c=s.offset||0,u=a/r;for(let e=0;e<r;++e)t.enableVertexAttribArray(i+e),t.vertexAttribPointer(i+e,h,o,l,a,c+u*e),void 0!==s.divisor&&t.vertexAttribDivisor(i+e,s.divisor)}}Dt[5126]={Type:Float32Array,size:4,setter:(t,i)=>function(s){t.uniform1f(i,s)},arraySetter:(t,i)=>function(s){t.uniform1fv(i,s)}},Dt[35664]={Type:Float32Array,size:8,setter:(t,i)=>function(s){t.uniform2fv(i,s)},cols:2},Dt[35665]={Type:Float32Array,size:12,setter:(t,i)=>function(s){t.uniform3fv(i,s)},cols:3},Dt[35666]={Type:Float32Array,size:16,setter:(t,i)=>function(s){t.uniform4fv(i,s)},cols:4},Dt[5124]={Type:Int32Array,size:4,setter:Wt,arraySetter:jt},Dt[35667]={Type:Int32Array,size:8,setter:Ht,cols:2},Dt[35668]={Type:Int32Array,size:12,setter:Gt,cols:3},Dt[35669]={Type:Int32Array,size:16,setter:Vt,cols:4},Dt[5125]={Type:Uint32Array,size:4,setter:(t,i)=>function(s){t.uniform1ui(i,s)},arraySetter:(t,i)=>function(s){t.uniform1uiv(i,s)}},Dt[36294]={Type:Uint32Array,size:8,setter:(t,i)=>function(s){t.uniform2uiv(i,s)},cols:2},Dt[36295]={Type:Uint32Array,size:12,setter:(t,i)=>function(s){t.uniform3uiv(i,s)},cols:3},Dt[36296]={Type:Uint32Array,size:16,setter:(t,i)=>function(s){t.uniform4uiv(i,s)},cols:4},Dt[35670]={Type:Uint32Array,size:4,setter:Wt,arraySetter:jt},Dt[35671]={Type:Uint32Array,size:8,setter:Ht,cols:2},Dt[35672]={Type:Uint32Array,size:12,setter:Gt,cols:3},Dt[35673]={Type:Uint32Array,size:16,setter:Vt,cols:4},Dt[35674]={Type:Float32Array,size:32,setter:(t,i)=>function(s){t.uniformMatrix2fv(i,!1,s)},rows:2,cols:2},Dt[35675]={Type:Float32Array,size:48,setter:(t,i)=>function(s){t.uniformMatrix3fv(i,!1,s)},rows:3,cols:3},Dt[35676]={Type:Float32Array,size:64,setter:(t,i)=>function(s){t.uniformMatrix4fv(i,!1,s)},rows:4,cols:4},Dt[35685]={Type:Float32Array,size:32,setter:(t,i)=>function(s){t.uniformMatrix2x3fv(i,!1,s)},rows:2,cols:3},Dt[35686]={Type:Float32Array,size:32,setter:(t,i)=>function(s){t.uniformMatrix2x4fv(i,!1,s)},rows:2,cols:4},Dt[35687]={Type:Float32Array,size:48,setter:(t,i)=>function(s){t.uniformMatrix3x2fv(i,!1,s)},rows:3,cols:2},Dt[35688]={Type:Float32Array,size:48,setter:(t,i)=>function(s){t.uniformMatrix3x4fv(i,!1,s)},rows:3,cols:4},Dt[35689]={Type:Float32Array,size:64,setter:(t,i)=>function(s){t.uniformMatrix4x2fv(i,!1,s)},rows:4,cols:2},Dt[35690]={Type:Float32Array,size:64,setter:(t,i)=>function(s){t.uniformMatrix4x3fv(i,!1,s)},rows:4,cols:3},Dt[35678]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:$t},Dt[35680]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Nt},Dt[35679]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Kt},Dt[35682]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:$t},Dt[36289]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Ot},Dt[36292]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Ot},Dt[36293]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Nt},Dt[36298]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:$t},Dt[36299]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Kt},Dt[36300]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Nt},Dt[36303]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Ot},Dt[36306]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:$t},Dt[36307]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Kt},Dt[36308]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Nt},Dt[36311]={Type:null,size:0,setter:qt,arraySetter:Qt,bindPoint:Ot};const ti={};function ii(t){const i=t.name;return i.startsWith("gl_")||i.startsWith("webgl_")}ti[5126]={size:4,setter:Zt},ti[35664]={size:8,setter:Zt},ti[35665]={size:12,setter:Zt},ti[35666]={size:16,setter:Zt},ti[5124]={size:4,setter:Yt},ti[35667]={size:8,setter:Yt},ti[35668]={size:12,setter:Yt},ti[35669]={size:16,setter:Yt},ti[5125]={size:4,setter:Jt},ti[36294]={size:8,setter:Jt},ti[36295]={size:12,setter:Jt},ti[36296]={size:16,setter:Jt},ti[35670]={size:4,setter:Yt},ti[35671]={size:8,setter:Yt},ti[35672]={size:12,setter:Yt},ti[35673]={size:16,setter:Yt},ti[35674]={size:4,setter:Xt,count:2},ti[35675]={size:9,setter:Xt,count:3},ti[35676]={size:16,setter:Xt,count:4};const si=/(\.|\[|]|\w+)/g,ei=t=>t>="0"&&t<="9";function ri(t,i,s,e){const r=t.split(si).filter((t=>""!==t));let n=0,h="";for(;;){const t=r[n++];h+=t;const o=ei(t[0]),a=o?parseInt(t):t;if(o&&(h+=r[n++]),n===r.length){s[a]=i;break}{const t=r[n++],i="["===t,o=s[a]||(i?[]:{});s[a]=o,s=o,e[h]=e[h]||function(t){return function(i){ni(t,i)}}(o),h+=t}}}function ni(t,i){for(const s in i){const e=t[s];"function"==typeof e?e(i[s]):ni(t[s],i[s])}}function hi(t,...i){const s=t.uniformSetters||t,e=i.length;for(let t=0;t<e;++t){const e=i[t];if(Array.isArray(e)){const t=e.length;for(let i=0;i<t;++i)hi(s,e[i])}else for(const t in e){const i=s[t];i&&i(e[t])}}}class WebglCanvas{static isSupported(){if(!d)return!1;let t=document.createElement("canvas"),i=t.getContext("2d");const s=null!==i;return t=null,i=null,s}constructor(t,i=640,s=480,e={}){this.supportedStereoscopeModes=[ft.None,ft.Dual],this.stereoscopeMode=ft.None,this.stereoscopeStrength=0,this.paletteBuffer=new Uint32Array(16),this.textureTypes=new Map,this.textureSizes=new Map,this.frameBufferTextures=new Map,this.applyFirefoxFix=!1,this.refs={programs:[],shaders:[],textures:[],buffers:[],frameBuffers:[]},this.isCtxLost=!1,this.handleContextLoss=t=>{this.destroy(),t&&t.preventDefault(),this.isCtxLost||this.options.onlost(),this.isCtxLost=!0},this.handleContextRestored=t=>{this.isCtxLost=!1,this.init(),this.options.onrestored()},f(),this.options={...WebglCanvas.defaultOptions,...e},this.width=i,this.height=s,this.canvas=document.createElement("canvas"),this.canvas.addEventListener("webglcontextlost",this.handleContextLoss,!1),this.canvas.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--webgl",this.gl=this.canvas.getContext("webgl",{antialias:!1,alpha:!0}),t&&t.appendChild(this.canvas),this.init()}init(){this.setCanvasSize(this.width,this.height);const t=this.gl;if(this.checkContextLoss())return;this.layerProgram=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_uv;uniform bool u_flipY;uniform vec2 u_textureSize;uniform int u_3d_eye;uniform float u_3d_depth;uniform float u_3d_strength;void main(){vec4 pos=position;float depthDirection=u_3d_eye==0 ?-1.0 : 1.0;float depthShift=floor(u_3d_depth*u_3d_strength)/(u_textureSize.x/2.0)*depthDirection;pos.x+=depthShift;pos.y*=u_flipY ?-1.0 : 1.0;v_uv=texcoord;gl_Position=pos;}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;uniform int u_3d_mode;void main(){vec4 col=texture2D(u_tex,v_uv);if(col.a==0.0){discard;}gl_FragColor=col;}"),this.upscaleProgram=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,1,1),this.setBuffersAndAttribs(this.layerProgram,this.quadBuffer),this.layerTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameBuffer=this.createFramebuffer(this.frameTexture);const i=t.getExtension("WEBGL_debug_renderer_info"),s=t.getParameter(i.UNMASKED_RENDERER_WEBGL),e=navigator.userAgent,r=e.includes("Firefox")&&e.includes("Mac");this.applyFirefoxFix=r&&s.includes("Apple M")}createProgram(t,i){if(this.checkContextLoss())return;const s=this.gl,e=this.createShader(s.VERTEX_SHADER,t),r=this.createShader(s.FRAGMENT_SHADER,i),n=s.createProgram();if(s.attachShader(n,e),s.attachShader(n,r),s.linkProgram(n),!s.getProgramParameter(n,s.LINK_STATUS)){const t=s.getProgramInfoLog(n);throw s.deleteProgram(n),new Error(t)}const h=function(t,i){const s=function(t,i){let s=0;function e(i,e,r){const n=e.name.endsWith("[0]"),h=e.type,o=Dt[h];if(!o)throw new Error(`unknown type: 0x${h.toString(16)}`);let a;if(o.bindPoint){const i=s;s+=e.size,a=n?o.arraySetter(t,h,i,r,e.size):o.setter(t,h,i,r,e.size)}else a=o.arraySetter&&n?o.arraySetter(t,r):o.setter(t,r);return a.location=r,a}const r={},n={},h=t.getProgramParameter(i,35718);for(let s=0;s<h;++s){const h=t.getActiveUniform(i,s);if(ii(h))continue;let o=h.name;o.endsWith("[0]")&&(o=o.substr(0,o.length-3));const a=t.getUniformLocation(i,h.name);if(a){const t=e(0,h,a);r[o]=t,ri(o,t,n,r)}}return r}(t,i),e=function(t,i){const s={},e=t.getProgramParameter(i,35721);for(let r=0;r<e;++r){const e=t.getActiveAttrib(i,r);if(ii(e))continue;const n=t.getAttribLocation(i,e.name),h=ti[e.type],o=h.setter(t,n,h);o.location=n,s[e.name]=o}return s}(t,i),r={program:i,uniformSetters:s,attribSetters:e};return Lt(t)&&(r.uniformBlockSpec=function(t,i){const s=t.getProgramParameter(i,35718),e=[],r=[];for(let n=0;n<s;++n){r.push(n),e.push({});const s=t.getActiveUniform(i,n);e[n].name=s.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(s){const n=s[0],h=s[1];t.getActiveUniforms(i,r,t[n]).forEach((function(t,i){e[i][h]=t}))}));const n={},h=t.getProgramParameter(i,35382);for(let s=0;s<h;++s){const e=t.getActiveUniformBlockName(i,s),r={index:t.getUniformBlockIndex(i,e),usedByVertexShader:t.getActiveUniformBlockParameter(i,s,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(i,s,35398),size:t.getActiveUniformBlockParameter(i,s,35392),uniformIndices:t.getActiveUniformBlockParameter(i,s,35395)};r.used=r.usedByVertexShader||r.usedByFragmentShader,n[e]=r}return{blockSpecs:n,uniformData:e}}(t,i),r.transformFeedbackInfo=function(t,i){const s={},e=t.getProgramParameter(i,35971);for(let r=0;r<e;++r){const e=t.getTransformFeedbackVarying(i,r);s[e.name]={index:r,type:e.type,size:e.size}}return s}(t,i)),r}(s,n);return this.refs.programs.push(n),h}createShader(t,i){if(this.checkContextLoss())return;const s=this.gl,e=s.createShader(t);if(s.shaderSource(e,i),s.compileShader(e),!s.getShaderParameter(e,s.COMPILE_STATUS)){const t=s.getShaderInfoLog(e);throw s.deleteShader(e),new Error(t)}return this.refs.shaders.push(e),e}createScreenQuad(t,i,s,e,r,n){if(this.checkContextLoss())return;const h=(r+1)*(n+1),o=r+1,a=new Float32Array(2*h),l=new Float32Array(2*h);let c=0,u=0;for(let h=0;h<=n;h++)for(let o=0;o<=r;o++){const d=o/r,f=h/n;a[c++]=t+s*d,a[c++]=i+e*f,l[u++]=d,l[u++]=f}const d=new Uint16Array(r*n*2*3);let f=0;for(let t=0;t<n;t++)for(let i=0;i<r;i++)d[f++]=(t+0)*o+i,d[f++]=(t+1)*o+i,d[f++]=(t+0)*o+i+1,d[f++]=(t+0)*o+i+1,d[f++]=(t+1)*o+i,d[f++]=(t+1)*o+i+1;const p=function(t,i,s){const e=function(t,i){const s={};return Object.keys(i).forEach((function(e){if(!zt(e)){const n=i[e],h=n.attrib||n.name||n.attribName||_t+e;if(n.value){if(!Array.isArray(n.value)&&!At(n.value))throw new Error("array.value is not array or typedarray");s[h]={value:n.value}}else{let i,o,a,l;if(n.buffer&&n.buffer instanceof WebGLBuffer)i=n.buffer,l=n.numComponents||n.size,o=n.type,a=n.normalize;else if("number"==typeof n||"number"==typeof n.data){const s=n.data||n,h=n.type||Float32Array,c=s*h.BYTES_PER_ELEMENT;o=function(t){if(t===Int8Array)return pt;if(t===Uint8Array)return mt;if(t===Uint8ClampedArray)return mt;if(t===Int16Array)return yt;if(t===Uint16Array)return wt;if(t===Int32Array)return gt;if(t===Uint32Array)return vt;if(t===Float32Array)return bt;throw new Error("unsupported typed array type")}(h),a=void 0!==n.normalize?n.normalize:(r=h)===Int8Array||r===Uint8Array,l=n.numComponents||n.size||Mt(e,s),i=t.createBuffer(),t.bindBuffer(xt,i),t.bufferData(xt,c,n.drawType||St)}else{const s=Tt(n,e);i=Ft(t,s,void 0,n.drawType),o=Pt(s),a=void 0!==n.normalize?n.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(s),l=function(t,i){return t.numComponents||t.size||Mt(i,function(t){return t.length?t:t.data}(t).length)}(n,e)}s[h]={buffer:i,numComponents:l,type:o,normalize:a,stride:n.stride||0,offset:n.offset||0,divisor:void 0===n.divisor?void 0:n.divisor,drawType:n.drawType}}}var r})),t.bindBuffer(xt,null),s}(t,i),r=Object.assign({},{});r.attribs=Object.assign({},{},e);const n=i.indices;if(n){const i=Tt(n,"indices");r.indices=Ft(t,i,34963),r.numElements=i.length,r.elementType=Pt(i)}else r.numElements||(r.numElements=function(t,i){let s,e;for(e=0;e<It.length&&(s=It[e],!(s in i))&&(s=_t+s,!(s in i));++e);e===It.length&&(s=Object.keys(i)[0]);const r=i[s];if(!r.buffer)return 1;t.bindBuffer(xt,r.buffer);const n=t.getBufferParameter(xt,34660);var h;t.bindBuffer(xt,null);const o=n/(5120===(h=r.type)||5121===h?1:5122===h||5123===h?2:5124===h||5125===h||5126===h?4:0),a=r.numComponents||r.size,l=o/a;if(l%1!=0)throw new Error(`numComponents ${a} not correct for length ${length}`);return l}(t,r.attribs));return r}(this.gl,{position:{numComponents:2,data:a},texcoord:{numComponents:2,data:l},indices:d});for(let t in p.attribs)this.refs.buffers.push(p.attribs[t].buffer);return p}setBuffersAndAttribs(t,i){var s,e,r;this.checkContextLoss()||(s=this.gl,e=t.attribSetters,(r=i).vertexArrayObject?s.bindVertexArray(r.vertexArrayObject):(function(t,i){for(const s in i){const e=t[s];e&&e(i[s])}}(e.attribSetters||e,r.attribs),r.indices&&s.bindBuffer(34963,r.indices)))}createTexture(t,i,s,e=1,r=1){if(this.checkContextLoss())return;const n=this.gl,h=n.createTexture();return n.bindTexture(n.TEXTURE_2D,h),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,i),n.texImage2D(n.TEXTURE_2D,0,t,e,r,0,t,n.UNSIGNED_BYTE,null),this.refs.textures.push(h),this.textureTypes.set(h,t),this.textureSizes.set(h,{width:e,height:r}),h}resizeTexture(t,i,s){if(this.checkContextLoss())return;const e=this.gl,r=this.textureTypes.get(t);e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,r,i,s,0,r,e.UNSIGNED_BYTE,null),this.textureSizes.set(t,{width:i,height:s})}createFramebuffer(t){if(this.checkContextLoss())return;const i=this.gl,s=i.createFramebuffer();return i.bindFramebuffer(i.FRAMEBUFFER,s),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0),this.refs.frameBuffers.push(s),this.frameBufferTextures.set(s,t),s}useFramebuffer(t,i,s,e,r){if(this.checkContextLoss())return;const n=this.gl;if(null===t){if(n.bindFramebuffer(n.FRAMEBUFFER,null),this.applyFirefoxFix){const t=this.srcWidth,h=this.srcHeight,o=n.drawingBufferWidth/t,a=n.drawingBufferHeight/h,l=256===t?1:0;i=-((e=n.drawingBufferWidth*(o-l))-t*o),s=-((r=n.drawingBufferHeight*(a-l))-h*a)}n.viewport(i??0,s??0,e??n.drawingBufferWidth,r??n.drawingBufferHeight)}else{const h=this.frameBufferTextures.get(t),{width:o,height:a}=this.textureSizes.get(h);n.bindFramebuffer(n.FRAMEBUFFER,t),n.viewport(i??0,s??0,e??o,r??a)}}resizeFramebuffer(t,i,s){if(this.checkContextLoss())return;const e=this.frameBufferTextures.get(t);this.resizeTexture(e,i,s)}setCanvasSize(t,i){const s=this.options.useDpi&&window.devicePixelRatio||1,e=t*s,r=i*s;this.width=t,this.height=i,this.canvas.width=e,this.canvas.height=r,this.dstWidth=e,this.dstHeight=r,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${i}px`,this.checkContextLoss()}setNote(t){if(this.checkContextLoss())return;const i=t.imageWidth,s=t.imageHeight;this.note=t,this.srcWidth=i,this.srcHeight=s,this.resizeFramebuffer(this.frameBuffer,i,s),this.resizeTexture(this.layerTexture,i,s),this.layerTexturePixelBuffer=new Uint32Array(i*s),this.layerTexturePixels=new Uint8Array(this.layerTexturePixelBuffer.buffer),this.frameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(this.checkContextLoss())return;const i=this.gl,s=t??this.note.getFramePalette(this.frameIndex)[0],[e,r,n,h]=s;i.clearColor(e/255,r/255,n/255,h/255),i.clear(i.COLOR_BUFFER_BIT)}drawFrame(t){if(this.checkContextLoss())return;const i=this.gl,s=this.stereoscopeMode,e=this.stereoscopeStrength;this.frameIndex=t,s===ft.None?(this.drawLayers(t),this.useFramebuffer(null),this.upscale(i.drawingBufferWidth,i.drawingBufferHeight)):s===ft.Dual&&(this.drawLayers(t,e,O.Left),this.useFramebuffer(null,0,0,i.drawingBufferWidth/2,i.drawingBufferHeight),this.upscale(i.drawingBufferWidth/2,i.drawingBufferHeight),this.drawLayers(t,e,O.Right),this.useFramebuffer(null,i.drawingBufferWidth/2,0,i.drawingBufferWidth/2,i.drawingBufferHeight),this.upscale(i.drawingBufferWidth/2,i.drawingBufferHeight))}upscale(t,i){if(this.checkContextLoss())return;const s=this.gl;s.useProgram(this.upscaleProgram.program),hi(this.upscaleProgram,{u_tex:this.frameTexture,u_textureSize:[this.srcWidth,this.srcHeight],u_screenSize:[t,i]}),s.drawElements(s.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}requestStereoScopeMode(t){this.supportedStereoscopeModes.includes(t)?this.stereoscopeMode=t:this.stereoscopeMode=ft.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}isErrorState(){const t=this.gl;return null===t||t.getError()!==t.NO_ERROR}drawLayers(t,i=0,s=O.Left,e=!0){const r=this.gl,n=this.note,h=this.srcWidth,o=this.srcHeight,a=n.numLayers,l=n.getFrameLayerOrder(t),c=n.getFrameLayerDepths(t);this.useFramebuffer(this.frameBuffer),e&&this.clear(),r.useProgram(this.layerProgram.program);for(let e=0;e<a;e++){const a=l[e];n.getLayerPixelsRgba(t,a,this.layerTexturePixelBuffer,this.paletteBuffer),hi(this.layerProgram,{u_flipY:!0,u_tex:this.layerTexture,u_textureSize:[h,o],u_3d_mode:this.stereoscopeMode,u_3d_eye:s,u_3d_depth:c[a],u_3d_strength:i}),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,h,o,0,r.RGBA,r.UNSIGNED_BYTE,this.layerTexturePixels),r.drawElements(r.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}}checkContextLoss(){const t=this.isCtxLost||this.isErrorState();return t&&this.handleContextLoss(),t}getDataUrl(t,i){return this.canvas.toDataURL(t,i)}async getBlob(t,i){return new Promise(((s,e)=>this.canvas.toBlob(s,t,i)))}destroy(){const t=this.refs,i=this.gl,s=this.canvas;t.shaders.forEach((t=>{i.deleteShader(t)})),t.shaders=[],t.textures.forEach((t=>{i.deleteTexture(t)})),t.textures=[],t.buffers.forEach((t=>{i.deleteBuffer(t)})),t.buffers=[],t.frameBuffers.forEach((t=>{i.deleteFramebuffer(t)})),t.frameBuffers=[],t.programs.forEach((t=>{i.deleteProgram(t)})),t.programs=[],this.paletteBuffer=null,this.layerTexturePixelBuffer=null,this.layerTexturePixels=null,this.textureTypes.clear(),this.textureSizes.clear(),this.frameBufferTextures.clear(),s&&s.parentElement&&(s.width=1,s.height=1,s.parentNode.removeChild(s))}}WebglCanvas.defaultOptions={onlost(){},onrestored(){},useDpi:!0};class Html5Canvas{static isSupported(){if(!d)return!1;let t=document.createElement("canvas"),i=t.getContext("2d");const s=null!==i;return t=null,i=null,s}constructor(t,i,s,e={}){this.supportedStereoscopeModes=[ft.None],this.stereoscopeMode=ft.None,this.stereoscopeStrength=0,this.paletteBuffer=new Uint32Array(16),f(),this.options={...Html5Canvas.defaultOptions,...e},this.width=i,this.height=s,this.canvas=document.createElement("canvas"),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--html5",this.ctx=this.canvas.getContext("2d"),this.srcCanvas=document.createElement("canvas"),this.srcCtx=this.srcCanvas.getContext("2d"),a(null!==this.ctx&&null!==this.srcCtx,"Could not create HTML5 canvas"),t&&t.appendChild(this.canvas),this.setCanvasSize(i,s)}setCanvasSize(t,i){const s=this.canvas,e=this.options.useDpi&&window.devicePixelRatio||1,r=t*e,n=i*e;this.width=t,this.height=i,this.dstWidth=r,this.dstHeight=n,s.style.width=`${t}px`,s.style.height=`${i}px`,s.width=r,s.height=n}setNote(t){const i=t.imageWidth,s=t.imageHeight;this.note=t,this.srcWidth=i,this.srcHeight=s,this.srcCanvas.width=i,this.srcCanvas.height=s,this.frameImage=this.srcCtx.createImageData(i,s),this.frameBuffer=new Uint32Array(this.frameImage.data.buffer),this.frameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(this.frameBuffer.fill(0),this.ctx.clearRect(0,0,this.dstWidth,this.dstHeight),t){const[i,s,e,r]=t;this.ctx.fillStyle=`rgba(${i}, ${s}, ${e}, ${r})`,this.ctx.fillRect(0,0,this.dstWidth,this.dstHeight)}}drawFrame(t){this.clear(),this.options.useSmoothing||(this.ctx.imageSmoothingEnabled=!1),this.note.getFramePixelsRgba(t,this.frameBuffer,this.paletteBuffer),this.srcCtx.putImageData(this.frameImage,0,0),this.ctx.drawImage(this.srcCanvas,0,0,this.srcWidth,this.srcHeight,0,0,this.dstWidth,this.dstHeight),this.frameIndex=t}requestStereoScopeMode(t){this.supportedStereoscopeModes.includes(t)?this.stereoscopeMode=t:this.stereoscopeMode=ft.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}getDataUrl(t,i){return this.canvas.toDataURL(t,i)}async getBlob(t,i){return new Promise(((s,e)=>this.canvas.toBlob(s,t,i)))}destroy(){this.frameImage=null,this.paletteBuffer=null,this.frameBuffer=null,this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null,this.srcCanvas.width=1,this.srcCanvas.height=1,this.srcCanvas=null}}Html5Canvas.defaultOptions={useDpi:!0,useSmoothing:!0};class UniversalCanvas{constructor(t,i=640,s=480,e={}){this.isReady=!1,this.isHtml5=!1,this.supportedStereoscopeModes=[],this.stereoscopeMode=ft.None,this.stereoscopeStrength=1,this.rendererStack=[WebglCanvas,Html5Canvas],this.rendererStackIdx=0,this.options={},this.width=i,this.height=s,this.parent=t,this.options=e,this.setSubRenderer(this.rendererStack[0])}setSubRenderer(t){let i=!1;const s=new t(this.parent,this.width,this.height,{...this.options,onlost:()=>{i=!0,this.fallbackIfPossible()}});i||(this.note&&(s.setNote(this.note),s.frameIndex=this.renderer?.frameIndex,s.forceUpdate()),this.renderer&&this.renderer.destroy(),this.isHtml5=s instanceof Html5Canvas,this.isReady=!0,this.renderer=s,this.rendererStackIdx=this.rendererStack.indexOf(t),this.supportedStereoscopeModes=s.supportedStereoscopeModes,s.stereoscopeStrength=this.stereoscopeStrength,this.requestStereoScopeMode(this.stereoscopeMode))}fallbackIfPossible(){if(this.rendererStackIdx>=this.rendererStack.length)throw new Error("No renderer to fall back to");this.rendererStackIdx+=1,this.setSubRenderer(this.rendererStack[this.rendererStackIdx])}switchToHtml5(){this.setSubRenderer(Html5Canvas)}setCanvasSize(t,i){const s=this.renderer;s.setCanvasSize(t,i),this.width=t,this.width=i,this.dstWidth=s.dstWidth,this.dstHeight=s.dstHeight}setNote(t){this.note=t,this.renderer.setNote(t),this.frameIndex=void 0,this.srcWidth=this.renderer.srcWidth,this.srcHeight=this.renderer.srcHeight}clear(t){this.renderer.clear(t)}drawFrame(t){this.renderer.drawFrame(t),this.frameIndex=t}forceUpdate(){this.renderer.forceUpdate()}requestStereoScopeMode(t){this.renderer.requestStereoScopeMode(t),this.stereoscopeMode=this.renderer.stereoscopeMode}getDataUrl(t,i){return this.renderer.getDataUrl()}async getBlob(t,i){return this.renderer.getBlob()}destroy(){this.renderer.destroy(),this.note=null}}const oi=d?window.AudioContext||window.webkitAudioContext:null;class WebAudioPlayer{constructor(){this.useEq=!1,this.useAnalyser=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this.i=1,this.h=!1,this.o=0,this.l=0,this.nodeRefs=[],f()}set volume(t){this.setVolume(t)}get volume(){return this.i}set loop(t){this.h=t,this.source&&(this.source.loop=t)}get loop(){return this.h}getCtx(){return this.ctx||(this.ctx=new oi),this.ctx}setBuffer(t,i){const s=this.getCtx(),e=t.length,r=s.createBuffer(1,e,i),n=r.getChannelData(0);if(t instanceof Float32Array)n.set(t,0);else if(t instanceof Int16Array)for(let i=0;i<e;i++)n[i]=t[i]/32768;this.buffer=r,this.sampleRate=i}connectEqNodesTo(t){const i=this.getCtx(),s=this.eqSettings;let e=t;return s.forEach((([t,r],n)=>{const h=i.createBiquadFilter();this.nodeRefs.push(h),h.frequency.value=t,h.gain.value=r,0===n?h.type="lowshelf":n===s.length-1?h.type="highshelf":h.type="peaking",e.connect(h),e=h})),e}initNodes(){const t=this.getCtx();this.nodeRefs=[];const i=t.createBufferSource();this.nodeRefs.push(i),i.buffer=this.buffer;const s=t.createGain();if(this.nodeRefs.push(s),this.useEq?this.connectEqNodesTo(i).connect(s):i.connect(s),this.useAnalyser){const i=t.createAnalyser();this.nodeRefs.push(i),this.analyser=i,s.connect(i),i.connect(t.destination)}else this.analyser=void 0,s.connect(t.destination);this.source=i,this.gainNode=s,this.setVolume(this.i)}setAnalyserEnabled(t){this.useAnalyser=t,this.initNodes()}setVolume(t){this.i=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))}playFrom(t){this.initNodes(),this.o=t,this.l=this.ctx.currentTime,this.source.loop=this.h,this.source.start(0,t)}stop(){this.source&&this.source.stop(0)}getCurrentTime(){return this.o+(this.ctx.currentTime-this.l)}async destroy(){this.stop();const t=this.getCtx();this.nodeRefs.forEach((t=>t.disconnect())),this.nodeRefs=[],this.analyser=void 0,"closed"!==t.state&&"function"==typeof t.close&&await t.close(),this.buffer=null}}class Player{constructor(i,s,e,r={}){this.duration=0,this.autoplay=!1,this.supportedEvents=lt,this.u=null,this.h=!1,this.i=1,this.p=!1,this.m=null,this.v=!1,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.lastParser=void 0,this.lastLoaders=void 0,this.playbackLoop=i=>{if(!this.isPlaying)return;const s=i/1e3,e=this.duration,r=this.audio.getCurrentTime();let n=s-this.playbackStartTime;if(Math.abs(n%e-r%e)>.01&&(n=r),n>=e){if(!this.loop)return this.pause(),this.v=!0,void this.emit(t.PlayerEvent.Ended);this.playbackStartTime=s,this.emit(t.PlayerEvent.Loop)}this.setCurrentTime(n%e),this.playbackLoopId=requestAnimationFrame(this.playbackLoop)},f();const n="string"==typeof i?document.querySelector(i):i;this.parserSettings=r,this.renderer=new UniversalCanvas(n,s,e,{onlost:()=>this.emit(t.PlayerEvent.Error),onrestored:()=>this.reload()}),this.audio=new WebAudioPlayer,this.el=n}get src(){return this.u}set src(t){throw new Error("Setting a Player source has been deprecated, please use the load() method instead")}get paused(){return!this.isPlaying}set paused(t){t?this.pause():this.play()}get currentFrame(){return this.m}set currentFrame(t){this.setCurrentFrame(t)}get currentTime(){return this.isNoteLoaded?this.playbackTime:null}set currentTime(t){this.setCurrentTime(t)}get progress(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null}set progress(t){this.setProgress(t)}get volume(){return this.getVolume()}set volume(t){this.setVolume(t)}get muted(){return this.getMuted()}set muted(t){this.setMuted(t)}get loop(){return this.getLoop()}set loop(t){this.setLoop(t)}get framerate(){return this.note.framerate}get frameCount(){return this.note.frameCount}get frameSpeed(){return this.note.frameSpeed}get buffered(){return ct([[0,this.duration]])}get seekable(){return ct([[0,this.duration]])}get currentSrc(){return this.u}get videoWidth(){return this.isNoteLoaded?this.note.imageWidth:0}get videoHeight(){return this.isNoteLoaded?this.note.imageHeight:0}async load(i,s,e){if(this.isNoteLoaded&&this.closeNote(),this.u=i,!i)return this.openNote(this.note);this.emit(t.PlayerEvent.LoadStart);const[r,n]=await(async t=>{try{return[null,await t().catch((t=>{throw t}))]}catch(t){return[t,null]}})((()=>s(i,this.parserSettings,e)));if(r)throw this.emit(t.PlayerEvent.Error,r),new Error(`Error loading Flipnote: ${r.message}`);this.lastParser=s,this.lastLoaders=e,this.openNote(n)}async reload(){if(this.note&&this.lastParser)return await this.load(this.note.buffer,this.lastParser,this.lastLoaders)}async updateSettings(t){return this.parserSettings=t,await this.reload()}closeNote(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this.u=null,this.m=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clear()}openNote(i){this.isNoteLoaded&&this.closeNote(),this.note=i,this.meta=i.meta,this.emit(t.PlayerEvent.LoadedMeta),this.noteFormat=i.format,this.duration=i.duration,this.playbackTime=0,this.m=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=i.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(i.getAudioMasterPcm(),i.sampleRate),this.emit(t.PlayerEvent.CanPlay),this.emit(t.PlayerEvent.CanPlayThrough),this.setLoop(i.meta.loop),this.renderer.setNote(i),this.drawFrame(i.thumbFrameIndex),this.emit(t.PlayerEvent.LoadedData),this.emit(t.PlayerEvent.Load),this.emit(t.PlayerEvent.Ready),this.autoplay&&this.play()}setCurrentTime(i){this.assertNoteLoaded();const s=Math.floor(i/(1/this.framerate));this.setCurrentFrame(s),this.playbackTime=i,this.emit(t.PlayerEvent.Progress,this.progress)}getCurrentTime(){return this.currentTime}getTimeCounter(){return`${dt(Math.max(this.currentTime,0))} / ${dt(this.duration)}`}getFrameCounter(){return`${ut(this.currentFrame+1,3)} / ${ut(this.frameCount,3)}`}setProgress(t){this.assertNoteLoaded(),l(t,0,100,"progress"),this.currentTime=this.duration*(t/100)}getProgress(){return this.progress}async play(){if(this.assertNoteLoaded(),this.isPlaying)return;this.v&&(this.playbackTime=0,this.v=!1);const i=performance.now();this.playbackStartTime=i/1e3-this.playbackTime,this.isPlaying=!0,this.hasPlaybackStarted=!0,this.playAudio(),this.playbackLoop(i),this.emit(t.PlayerEvent.Play)}pause(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(t.PlayerEvent.Pause))}togglePlay(){this.isPlaying?this.pause():this.play()}getPaused(){return!this.isPlaying}getDuration(){return this.duration}getLoop(){return this.h}setLoop(t){this.h=t,this.audio.loop=t}toggleLoop(){this.setLoop(!this.h)}setCurrentFrame(i){this.assertNoteLoaded();const s=Math.max(0,Math.min(Math.floor(i),this.frameCount-1));(s!==this.currentFrame||this.showThumbnail)&&(this.m=s,this.drawFrame(s),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=s*(1/this.framerate),this.emit(t.PlayerEvent.SeekEnd)),this.emit(t.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(t.PlayerEvent.Progress,this.progress),this.emit(t.PlayerEvent.TimeUpdate,this.currentFrame))}nextFrame(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(t.PlayerEvent.FrameNext)}prevFrame(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(t.PlayerEvent.FramePrev)}lastFrame(){this.currentFrame=this.frameCount-1,this.emit(t.PlayerEvent.FrameLast)}firstFrame(){this.currentFrame=0,this.emit(t.PlayerEvent.FrameFirst)}thumbnailFrame(){this.currentFrame=this.note.thumbFrameIndex}startSeek(){this.isSeeking||(this.emit(t.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)}seek(t){this.isSeeking&&(this.progress=100*t)}endSeek(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1}drawFrame(t){this.renderer.drawFrame(t)}forceUpdate(){this.renderer.forceUpdate()}resize(t,i){i!==.75*t&&console.warn(`Canvas width to height ratio should be 3:4 for best results (got ${t}x${i})`),this.renderer.setCanvasSize(t,i),this.forceUpdate()}setLayerVisibility(t,i){this.note.layerVisibility[t]=i,this.layerVisibility[t]=i,this.forceUpdate()}getLayerVisibility(t){return this.layerVisibility[t]}toggleLayerVisibility(t){this.setLayerVisibility(t,!this.layerVisibility[t])}playAudio(){this.audio.playFrom(this.currentTime)}stopAudio(){this.audio.stop()}toggleAudioEq(){this.setAudioEq(!this.audio.useEq)}setAudioEq(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())}mute(){this.setMuted(!0)}unmute(){this.setMuted(!1)}setMuted(i){this.audio.volume=i?0:this.i,this.p=i,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getMuted(){return 0===this.volume||this.p}toggleMuted(){this.setMuted(!this.p)}setVolume(i){l(i,0,1,"volume"),this.i=i,this.audio.volume=i,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getVolume(){return this.p?0:this.i}seekToNextFrame(){this.nextFrame()}fastSeek(t){this.currentTime=t}canPlayType(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";default:return""}}getVideoPlaybackQuality(){return{creationTime:0,droppedVideoFrames:0,corruptedVideoFrames:0,totalVideoFrames:this.frameCount}}requestPictureInPicture(){throw new Error("Not implemented")}captureStream(){throw new Error("Not implemented")}on(t,i){const s=this.events;(Array.isArray(t)?t:[t]).forEach((t=>{s.has(t)?s.get(t).push(i):s.set(t,[i])}))}off(t,i){const s=this.events;(Array.isArray(t)?t:[t]).forEach((t=>{if(!s.has(t))return;const e=s.get(t);s.set(t,e.splice(e.indexOf(i),1))}))}emit(i,...s){const e=this.events;if(i!==t.PlayerEvent.t&&e.has(i)){e.get(i).forEach((t=>t.apply(null,s)));const t=`on${i}`,r=this;"function"==typeof r[t]&&r[t].apply(null,s)}e.has(t.PlayerEvent.t)&&e.get(t.PlayerEvent.t).forEach((t=>t.apply(null,[i,...s])))}clearEvents(){this.events.clear()}async destroy(){this.clearEvents(),this.emit(t.PlayerEvent.Destroy),this.closeNote(),await this.renderer.destroy(),await this.audio.destroy()}supports(t){const i=this.supportedEvents.includes(t),s="function"==typeof this[t];return i||s}assertNoteLoaded(){a(this.isNoteLoaded,"No Flipnote is currently loaded in this player")}}function ai(t){class PlayerMixinClass extends t{get renderer(){return this.player.renderer}get audio(){return this.player.audio}get canvasEl(){return this.player.canvasEl}get note(){return this.player.note}get noteFormat(){return this.player.noteFormat}get meta(){return this.player.meta}get duration(){return this.player.duration}get layerVisibility(){return this.player.layerVisibility}get autoplay(){return this.player.autoplay}set autoplay(t){this.player.autoplay=t}}for(let i of Reflect.ownKeys(Player.prototype)){let s=Object.getOwnPropertyDescriptor(Player.prototype,i);i in t.prototype||"constructor"===i||"name"===i||"prototype"===i||(s.value&&"function"==typeof s.value?Object.defineProperty(PlayerMixinClass.prototype,i,{...s,value(...t){return this.player[i](...t)}}):(s.get||s.set)&&Object.defineProperty(PlayerMixinClass.prototype,i,{...s,set(t){this.player[i]=t},get(){return this.player[i]}}))}return PlayerMixinClass}class EncoderBase{constructor(){this.dataUrl=null}getBuffer(){return m(),Buffer.from(this.getArrayBuffer())}getBlob(){return f(),new Blob([this.getArrayBuffer()],{type:this.mimeType})}getUrl(){return f(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())}revokeUrl(){f(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)}}const li=5003,ci=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];class LzwCompressor{constructor(t,i,s){this.accum=new Uint8Array(256),this.htab=new Int32Array(li),this.codetab=new Int32Array(li),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=i,this.colorDepth=s,this.reset()}reset(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}char_out(t,i){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(i)}cl_block(t){this.cl_hash(li),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)}cl_hash(t){for(var i=0;i<t;++i)this.htab[i]=-1}compress(t,i){var s,e,r,n,h,o,a;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,n=this.nextPixel(),a=0,s=li;s<65536;s*=2)++a;a=8-a,o=li,this.cl_hash(o),this.output(this.ClearCode,i);t:for(;-1!=(e=this.nextPixel());)if(s=(e<<12)+n,r=e<<a^n,this.htab[r]!==s){if(this.htab[r]>=0){h=o-r,0===r&&(h=1);do{if((r-=h)<0&&(r+=o),this.htab[r]===s){n=this.codetab[r];continue t}}while(this.htab[r]>=0)}this.output(n,i),n=e,this.free_ent<4096?(this.codetab[r]=this.free_ent++,this.htab[r]=s):this.cl_block(i)}else n=this.codetab[r];this.output(n,i),this.output(this.EOFCode,i)}encode(t,i){this.pixels=t,i.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,i),i.writeByte(0)}flush_char(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)}get_maxcode(t){return(1<<t)-1}nextPixel(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}output(t,i){for(this.cur_accum&=ci[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(i)}}}class GifImage extends EncoderBase{constructor(t,i,s={}){super(),this.mimeType="gif/image",this.frameCount=0,this.width=t,this.height=i,this.data=new ByteArray,this.settings={...GifImage.defaultSettings,...s},this.compressor=new LzwCompressor(t,i,s.colorDepth)}static fromFlipnote(t,i={}){const s=new GifImage(t.imageWidth,t.imageHeight,{delay:100/t.framerate,repeat:t.meta?.loop?-1:0,...i});s.palette=t.globalPalette;for(let i=0;i<t.frameCount;i++)s.writeFrame(t.getFramePixels(i));return s.finish(),s}static fromFlipnoteFrame(t,i,s={}){const e=new GifImage(t.imageWidth,t.imageHeight,{delay:0,repeat:0,...s});return e.palette=t.globalPalette,e.writeFrame(t.getFramePixels(i)),e.finish(),e}writeFrame(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1}finish(){this.data.writeByte(59)}writeFirstFrame(t){this.writeHeader(),this.writeLogicalScreenDescriptor(),this.writeColorTable(),this.writeNetscapeExt(),this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)}writeAdditionalFrame(t){this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)}writeHeader(){this.data.writeChars("GIF89a")}writeGraphicControlExt(){this.data.writeByte(33),this.data.writeByte(249),this.data.writeByte(4),this.data.writeByte(0),this.data.writeU16(this.settings.delay),this.data.writeByte(0),this.data.writeByte(0)}writeLogicalScreenDescriptor(){const t=this.palette,i=128|this.settings.colorDepth-1<<4|this.colorTableSize(t.length)-1;this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeBytes([i,0,0])}writeNetscapeExt(){this.data.writeByte(33),this.data.writeByte(255),this.data.writeByte(11),this.data.writeChars("NETSCAPE2.0"),this.data.writeByte(3),this.data.writeByte(1),this.data.writeU16(this.settings.repeat),this.data.writeByte(0)}writeColorTable(){const t=this.palette,i=1<<this.colorTableSize(t.length);for(let s=0;s<i;s++){let i=[0,0,0];s<t.length&&(i=t[s]),this.data.writeByte(i[0]),this.data.writeByte(i[1]),this.data.writeByte(i[2])}}writeImageDescriptor(){this.data.writeByte(44),this.data.writeU16(0),this.data.writeU16(0),this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeByte(0)}colorTableSize(t){return Math.max(Math.ceil(Math.log2(t)),1)}writePixels(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)}getArrayBuffer(){return this.data.getBuffer()}getImage(){f();const t=new Image(this.width,this.height);return t.src=this.getUrl(),t}}GifImage.defaultSettings={delay:100,repeat:-1,colorDepth:8};class WavAudio extends EncoderBase{constructor(t,i=1,s=16){super(),this.sampleRate=t,this.channels=i,this.bitsPerSample=s;const e=new ArrayBuffer(44),r=new DataStream(e);r.writeChars("RIFF"),r.writeUint32(0),r.writeChars("WAVE"),r.writeChars("fmt "),r.writeUint32(16),r.writeUint16(1),r.writeUint16(this.channels),r.writeUint32(this.sampleRate),r.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample),r.writeChars("data"),r.writeUint32(0),this.header=r,this.pcmData=null}static fromFlipnote(t){const i=t.sampleRate,s=new WavAudio(i,1,16),e=t.getAudioMasterPcm(i);return s.writeSamples(e),s}static fromFlipnoteTrack(t,i){const s=t.sampleRate,e=new WavAudio(s,1,16),r=t.getAudioTrackPcm(i,s);return e.writeSamples(r),e}writeSamples(t){let i=this.header;i.seek(4),i.writeUint32(i.byteLength+t.byteLength),i.seek(40),i.writeUint32(t.byteLength),this.pcmData=t}getArrayBuffer(){const t=this.header.bytes,i=new Uint8Array(this.pcmData.buffer),s=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return s.set(t),s.set(i,t.byteLength),s.buffer}}function ui(t,i,s,e){var r,n=arguments.length,h=n<3?i:null===e?e=Object.getOwnPropertyDescriptor(i,s):e;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)h=Reflect.decorate(t,i,s,e);else for(var o=t.length-1;o>=0;o--)(r=t[o])&&(h=(n<3?r(h):n>3?r(i,s,h):r(i,s))||h);return n>3&&h&&Object.defineProperty(i,s,h),h}"function"==typeof SuppressedError&&SuppressedError;const di="undefined"!=typeof window&&null!=window.customElements&&void 0!==window.customElements.polyfillWrapFlushCallback,fi=(t,i,s=null)=>{for(;i!==s;){const s=i.nextSibling;t.removeChild(i),i=s}},pi=`{{lit-${String(Math.random()).slice(2)}}}`,mi=`\x3c!--${pi}--\x3e`,yi=new RegExp(`${pi}|${mi}`),wi="$lit$";class Template{constructor(t,i){this.parts=[],this.element=i;const s=[],e=[],r=document.createTreeWalker(i.content,133,null,!1);let n=0,h=-1,o=0;const{strings:a,values:{length:l}}=t;for(;o<l;){const t=r.nextNode();if(null!==t){if(h++,1===t.nodeType){if(t.hasAttributes()){const i=t.attributes,{length:s}=i;let e=0;for(let t=0;t<s;t++)gi(i[t].name,wi)&&e++;for(;e-- >0;){const i=a[o],s=Pi.exec(i)[2],e=s.toLowerCase()+wi,r=t.getAttribute(e);t.removeAttribute(e);const n=r.split(yi);this.parts.push({type:"attribute",index:h,name:s,strings:n}),o+=n.length-1}}"TEMPLATE"===t.tagName&&(e.push(t),r.currentNode=t.content)}else if(3===t.nodeType){const i=t.data;if(i.indexOf(pi)>=0){const e=t.parentNode,r=i.split(yi),n=r.length-1;for(let i=0;i<n;i++){let s,n=r[i];if(""===n)s=bi();else{const t=Pi.exec(n);null!==t&&gi(t[2],wi)&&(n=n.slice(0,t.index)+t[1]+t[2].slice(0,-5)+t[3]),s=document.createTextNode(n)}e.insertBefore(s,t),this.parts.push({type:"node",index:++h})}""===r[n]?(e.insertBefore(bi(),t),s.push(t)):t.data=r[n],o+=n}}else if(8===t.nodeType)if(t.data===pi){const i=t.parentNode;null!==t.previousSibling&&h!==n||(h++,i.insertBefore(bi(),t)),n=h,this.parts.push({type:"node",index:h}),null===t.nextSibling?t.data="":(s.push(t),h--),o++}else{let i=-1;for(;-1!==(i=t.data.indexOf(pi,i+1));)this.parts.push({type:"node",index:-1}),o++}}else r.currentNode=e.pop()}for(const t of s)t.parentNode.removeChild(t)}}const gi=(t,i)=>{const s=t.length-i.length;return s>=0&&t.slice(s)===i},vi=t=>-1!==t.index,bi=()=>document.createComment(""),Pi=/([ \x09\x0a\x0c\x0d])([^\0-\x1F\x7F-\x9F "'>=/]+)([ \x09\x0a\x0c\x0d]*=[ \x09\x0a\x0c\x0d]*(?:[^ \x09\x0a\x0c\x0d"'`<>=]*|"[^"]*|'[^']*))$/;function Ai(t,i){const{element:{content:s},parts:e}=t,r=document.createTreeWalker(s,133,null,!1);let n=Si(e),h=e[n],o=-1,a=0;const l=[];let c=null;for(;r.nextNode();){o++;const t=r.currentNode;for(t.previousSibling===c&&(c=null),i.has(t)&&(l.push(t),null===c&&(c=t)),null!==c&&a++;void 0!==h&&h.index===o;)h.index=null!==c?-1:h.index-a,n=Si(e,n),h=e[n]}l.forEach((t=>t.parentNode.removeChild(t)))}const Ci=t=>{let i=11===t.nodeType?0:1;const s=document.createTreeWalker(t,133,null,!1);for(;s.nextNode();)i++;return i},Si=(t,i=-1)=>{for(let s=i+1;s<t.length;s++){const i=t[s];if(vi(i))return s}return-1},xi=new WeakMap,_i=t=>(...i)=>{const s=t(...i);return xi.set(s,!0),s},Fi=t=>"function"==typeof t&&xi.has(t),zi={},Ui={};class TemplateInstance{constructor(t,i,s){this.P=[],this.template=t,this.processor=i,this.options=s}update(t){let i=0;for(const s of this.P)void 0!==s&&s.setValue(t[i]),i++;for(const t of this.P)void 0!==t&&t.commit()}A(){const t=di?this.template.element.content.cloneNode(!0):document.importNode(this.template.element.content,!0),i=[],s=this.template.parts,e=document.createTreeWalker(t,133,null,!1);let r,n=0,h=0,o=e.nextNode();for(;n<s.length;)if(r=s[n],vi(r)){for(;h<r.index;)h++,"TEMPLATE"===o.nodeName&&(i.push(o),e.currentNode=o.content),null===(o=e.nextNode())&&(e.currentNode=i.pop(),o=e.nextNode());if("node"===r.type){const t=this.processor.handleTextExpression(this.options);t.insertAfterNode(o.previousSibling),this.P.push(t)}else this.P.push(...this.processor.handleAttributeExpressions(o,r.name,r.strings,this.options));n++}else this.P.push(void 0),n++;return di&&(document.adoptNode(t),customElements.upgrade(t)),t}}const Ei=window.trustedTypes&&trustedTypes.createPolicy("lit-html",{createHTML:t=>t}),Mi=` ${pi} `;class TemplateResult{constructor(t,i,s,e){this.strings=t,this.values=i,this.type=s,this.processor=e}getHTML(){const t=this.strings.length-1;let i="",s=!1;for(let e=0;e<t;e++){const t=this.strings[e],r=t.lastIndexOf("\x3c!--");s=(r>-1||s)&&-1===t.indexOf("--\x3e",r+1);const n=Pi.exec(t);i+=null===n?t+(s?Mi:mi):t.substr(0,n.index)+n[1]+n[2]+wi+n[3]+pi}return i+=this.strings[t],i}getTemplateElement(){const t=document.createElement("template");let i=this.getHTML();return void 0!==Ei&&(i=Ei.createHTML(i)),t.innerHTML=i,t}}const Ti=t=>null===t||!("object"==typeof t||"function"==typeof t),Ii=t=>Array.isArray(t)||!(!t||!t[Symbol.iterator]);class AttributeCommitter{constructor(t,i,s){this.dirty=!0,this.element=t,this.name=i,this.strings=s,this.parts=[];for(let t=0;t<s.length-1;t++)this.parts[t]=this.C()}C(){return new AttributePart(this)}S(){const t=this.strings,i=t.length-1,s=this.parts;if(1===i&&""===t[0]&&""===t[1]){const t=s[0].value;if("symbol"==typeof t)return String(t);if("string"==typeof t||!Ii(t))return t}let e="";for(let r=0;r<i;r++){e+=t[r];const i=s[r];if(void 0!==i){const t=i.value;if(Ti(t)||!Ii(t))e+="string"==typeof t?t:String(t);else for(const i of t)e+="string"==typeof i?i:String(i)}}return e+=t[i],e}commit(){this.dirty&&(this.dirty=!1,this.element.setAttribute(this.name,this.S()))}}class AttributePart{constructor(t){this.value=void 0,this.committer=t}setValue(t){t===zi||Ti(t)&&t===this.value||(this.value=t,Fi(t)||(this.committer.dirty=!0))}commit(){for(;Fi(this.value);){const t=this.value;this.value=zi,t(this)}this.value!==zi&&this.committer.commit()}}class NodePart{constructor(t){this.value=void 0,this._=void 0,this.options=t}appendInto(t){this.startNode=t.appendChild(bi()),this.endNode=t.appendChild(bi())}insertAfterNode(t){this.startNode=t,this.endNode=t.nextSibling}appendIntoPart(t){t.F(this.startNode=bi()),t.F(this.endNode=bi())}insertAfterPart(t){t.F(this.startNode=bi()),this.endNode=t.endNode,t.endNode=this.startNode}setValue(t){this._=t}commit(){if(null===this.startNode.parentNode)return;for(;Fi(this._);){const t=this._;this._=zi,t(this)}const t=this._;t!==zi&&(Ti(t)?t!==this.value&&this.U(t):t instanceof TemplateResult?this.M(t):t instanceof Node?this.T(t):Ii(t)?this.I(t):t===Ui?(this.value=Ui,this.clear()):this.U(t))}F(t){this.endNode.parentNode.insertBefore(t,this.endNode)}T(t){this.value!==t&&(this.clear(),this.F(t),this.value=t)}U(t){const i=this.startNode.nextSibling,s="string"==typeof(t=t??"")?t:String(t);i===this.endNode.previousSibling&&3===i.nodeType?i.data=s:this.T(document.createTextNode(s)),this.value=t}M(t){const i=this.options.templateFactory(t);if(this.value instanceof TemplateInstance&&this.value.template===i)this.value.update(t.values);else{const s=new TemplateInstance(i,t.processor,this.options),e=s.A();s.update(t.values),this.T(e),this.value=s}}I(t){Array.isArray(this.value)||(this.value=[],this.clear());const i=this.value;let s,e=0;for(const r of t)s=i[e],void 0===s&&(s=new NodePart(this.options),i.push(s),0===e?s.appendIntoPart(this):s.insertAfterPart(i[e-1])),s.setValue(r),s.commit(),e++;e<i.length&&(i.length=e,this.clear(s&&s.endNode))}clear(t=this.startNode){fi(this.startNode.parentNode,t.nextSibling,this.endNode)}}class BooleanAttributePart{constructor(t,i,s){if(this.value=void 0,this._=void 0,2!==s.length||""!==s[0]||""!==s[1])throw new Error("Boolean attributes can only contain a single expression");this.element=t,this.name=i,this.strings=s}setValue(t){this._=t}commit(){for(;Fi(this._);){const t=this._;this._=zi,t(this)}if(this._===zi)return;const t=!!this._;this.value!==t&&(t?this.element.setAttribute(this.name,""):this.element.removeAttribute(this.name),this.value=t),this._=zi}}class PropertyCommitter extends AttributeCommitter{constructor(t,i,s){super(t,i,s),this.single=2===s.length&&""===s[0]&&""===s[1]}C(){return new PropertyPart(this)}S(){return this.single?this.parts[0].value:super.S()}commit(){this.dirty&&(this.dirty=!1,this.element[this.name]=this.S())}}class PropertyPart extends AttributePart{}let Li=!1;(()=>{try{const t={get capture(){return Li=!0,!1}};window.addEventListener("test",t,t),window.removeEventListener("test",t,t)}catch(t){}})();class EventPart{constructor(t,i,s){this.value=void 0,this._=void 0,this.element=t,this.eventName=i,this.eventContext=s,this.L=t=>this.handleEvent(t)}setValue(t){this._=t}commit(){for(;Fi(this._);){const t=this._;this._=zi,t(this)}if(this._===zi)return;const t=this._,i=this.value,s=null==t||null!=i&&(t.capture!==i.capture||t.once!==i.once||t.passive!==i.passive),e=null!=t&&(null==i||s);s&&this.element.removeEventListener(this.eventName,this.L,this.B),e&&(this.B=Bi(t),this.element.addEventListener(this.eventName,this.L,this.B)),this.value=t,this._=zi}handleEvent(t){"function"==typeof this.value?this.value.call(this.eventContext||this.element,t):this.value.handleEvent(t)}}const Bi=t=>t&&(Li?{capture:t.capture,passive:t.passive,once:t.once}:t.capture);function ki(t){let i=$i.get(t.type);void 0===i&&(i={stringsArray:new WeakMap,keyString:new Map},$i.set(t.type,i));let s=i.stringsArray.get(t.strings);if(void 0!==s)return s;const e=t.strings.join(pi);return s=i.keyString.get(e),void 0===s&&(s=new Template(t,t.getTemplateElement()),i.keyString.set(e,s)),i.stringsArray.set(t.strings,s),s}const $i=new Map,Ni=new WeakMap,Ki=new class{handleAttributeExpressions(t,i,s,e){const r=i[0];return"."===r?new PropertyCommitter(t,i.slice(1),s).parts:"@"===r?[new EventPart(t,i.slice(1),e.eventContext)]:"?"===r?[new BooleanAttributePart(t,i.slice(1),s)]:new AttributeCommitter(t,i,s).parts}handleTextExpression(t){return new NodePart(t)}};"undefined"!=typeof window&&(window.litHtmlVersions||(window.litHtmlVersions=[])).push("1.4.1");const Oi=(t,...i)=>new TemplateResult(t,i,"html",Ki),Di=(t,i)=>`${t}--${i}`;let Ri=!0;void 0===window.ShadyCSS?Ri=!1:void 0===window.ShadyCSS.prepareTemplateDom&&(console.warn("Incompatible ShadyCSS version detected. Please update to at least @webcomponents/webcomponentsjs@2.0.2 and @webcomponents/shadycss@1.3.1."),Ri=!1);const Wi=t=>i=>{const s=Di(i.type,t);let e=$i.get(s);void 0===e&&(e={stringsArray:new WeakMap,keyString:new Map},$i.set(s,e));let r=e.stringsArray.get(i.strings);if(void 0!==r)return r;const n=i.strings.join(pi);if(r=e.keyString.get(n),void 0===r){const s=i.getTemplateElement();Ri&&window.ShadyCSS.prepareTemplateDom(s,t),r=new Template(i,s),e.keyString.set(n,r)}return e.stringsArray.set(i.strings,r),r},ji=["html","svg"],Hi=new Set;window.JSCompiler_renameProperty=(t,i)=>t;const Gi={toAttribute(t,i){switch(i){case Boolean:return t?"":null;case Object:case Array:return null==t?t:JSON.stringify(t)}return t},fromAttribute(t,i){switch(i){case Boolean:return null!==t;case Number:return null===t?null:Number(t);case Object:case Array:return JSON.parse(t)}return t}},Vi=(t,i)=>i!==t&&(i==i||t==t),qi={attribute:!0,type:String,converter:Gi,reflect:!1,hasChanged:Vi},Qi="finalized";class UpdatingElement extends HTMLElement{constructor(){super(),this.initialize()}static get observedAttributes(){this.finalize();const t=[];return this.k.forEach(((i,s)=>{const e=this.$(s,i);void 0!==e&&(this.N.set(e,s),t.push(e))})),t}static K(){if(!this.hasOwnProperty(JSCompiler_renameProperty("_classProperties",this))){this.k=new Map;const t=Object.getPrototypeOf(this).k;void 0!==t&&t.forEach(((t,i)=>this.k.set(i,t)))}}static createProperty(t,i=qi){if(this.K(),this.k.set(t,i),i.noAccessor||this.prototype.hasOwnProperty(t))return;const s="symbol"==typeof t?Symbol():`__${t}`,e=this.getPropertyDescriptor(t,s,i);void 0!==e&&Object.defineProperty(this.prototype,t,e)}static getPropertyDescriptor(t,i,s){return{get(){return this[i]},set(e){const r=this[t];this[i]=e,this.requestUpdateInternal(t,r,s)},configurable:!0,enumerable:!0}}static getPropertyOptions(t){return this.k&&this.k.get(t)||qi}static finalize(){const t=Object.getPrototypeOf(this);if(t.hasOwnProperty(Qi)||t.finalize(),this[Qi]=!0,this.K(),this.N=new Map,this.hasOwnProperty(JSCompiler_renameProperty("properties",this))){const t=this.properties,i=[...Object.getOwnPropertyNames(t),..."function"==typeof Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(t):[]];for(const s of i)this.createProperty(s,t[s])}}static $(t,i){const s=i.attribute;return!1===s?void 0:"string"==typeof s?s:"string"==typeof t?t.toLowerCase():void 0}static O(t,i,s=Vi){return s(t,i)}static D(t,i){const s=i.type,e=i.converter||Gi,r="function"==typeof e?e:e.fromAttribute;return r?r(t,s):t}static R(t,i){if(void 0===i.reflect)return;const s=i.type,e=i.converter;return(e&&e.toAttribute||Gi.toAttribute)(t,s)}initialize(){this.W=0,this.j=new Promise((t=>this.H=t)),this.G=new Map,this.V(),this.requestUpdateInternal()}V(){this.constructor.k.forEach(((t,i)=>{if(this.hasOwnProperty(i)){const t=this[i];delete this[i],this.q||(this.q=new Map),this.q.set(i,t)}}))}Z(){this.q.forEach(((t,i)=>this[i]=t)),this.q=void 0}connectedCallback(){this.enableUpdating()}enableUpdating(){void 0!==this.H&&(this.H(),this.H=void 0)}disconnectedCallback(){}attributeChangedCallback(t,i,s){i!==s&&this.Y(t,s)}J(t,i,s=qi){const e=this.constructor,r=e.$(t,s);if(void 0!==r){const t=e.R(i,s);if(void 0===t)return;this.W=8|this.W,null==t?this.removeAttribute(r):this.setAttribute(r,t),this.W=-9&this.W}}Y(t,i){if(8&this.W)return;const s=this.constructor,e=s.N.get(t);if(void 0!==e){const t=s.getPropertyOptions(e);this.W=16|this.W,this[e]=s.D(i,t),this.W=-17&this.W}}requestUpdateInternal(t,i,s){let e=!0;if(void 0!==t){const r=this.constructor;s=s||r.getPropertyOptions(t),r.O(this[t],i,s.hasChanged)?(this.G.has(t)||this.G.set(t,i),!0!==s.reflect||16&this.W||(void 0===this.X&&(this.X=new Map),this.X.set(t,s))):e=!1}!this.tt&&e&&(this.j=this.it())}requestUpdate(t,i){return this.requestUpdateInternal(t,i),this.updateComplete}async it(){this.W=4|this.W;try{await this.j}catch(t){}const t=this.performUpdate();return null!=t&&await t,!this.tt}get tt(){return 4&this.W}get hasUpdated(){return 1&this.W}performUpdate(){if(!this.tt)return;this.q&&this.Z();let t=!1;const i=this.G;try{t=this.shouldUpdate(i),t?this.update(i):this.st()}catch(i){throw t=!1,this.st(),i}t&&(1&this.W||(this.W=1|this.W,this.firstUpdated(i)),this.updated(i))}st(){this.G=new Map,this.W=-5&this.W}get updateComplete(){return this.et()}et(){return this.getUpdateComplete()}getUpdateComplete(){return this.j}shouldUpdate(t){return!0}update(t){void 0!==this.X&&this.X.size>0&&(this.X.forEach(((t,i)=>this.J(i,this[i],t))),this.X=void 0),this.st()}updated(t){}firstUpdated(t){}}UpdatingElement[Qi]=!0;const Zi=t=>i=>"function"==typeof i?((t,i)=>(window.customElements.define(t,i),i))(t,i):((t,i)=>{const{kind:s,elements:e}=i;return{kind:s,elements:e,finisher(i){window.customElements.define(t,i)}}})(t,i),Yi=(t,i)=>"method"===i.kind&&i.descriptor&&!("value"in i.descriptor)?Object.assign(Object.assign({},i),{finisher(s){s.createProperty(i.key,t)}}):{kind:"field",key:Symbol(),placement:"own",descriptor:{},initializer(){"function"==typeof i.initializer&&(this[i.key]=i.initializer.call(this))},finisher(s){s.createProperty(i.key,t)}},Ji=(t,i,s)=>{i.constructor.createProperty(s,t)};function Xi(t){return(i,s)=>void 0!==s?Ji(t,i,s):Yi(t,i)}function ts(t){return Xi({attribute:!1,hasChanged:void 0})}function is(t,i){return(i,s)=>{const e={get(){return this.renderRoot.querySelector(t)},enumerable:!0,configurable:!0};return void 0!==s?ss(e,i,s):es(e,i)}}const ss=(t,i,s)=>{Object.defineProperty(i,s,t)},es=(t,i)=>({kind:"method",placement:"prototype",key:i.key,descriptor:t}),rs=window.ShadowRoot&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,ns=Symbol();class CSSResult{constructor(t,i){if(i!==ns)throw new Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=t}get styleSheet(){return void 0===this.rt&&(rs?(this.rt=new CSSStyleSheet,this.rt.replaceSync(this.cssText)):this.rt=null),this.rt}toString(){return this.cssText}}const hs=(t,...i)=>{const s=i.reduce(((i,s,e)=>i+(t=>{if(t instanceof CSSResult)return t.cssText;if("number"==typeof t)return t;throw new Error(`Value passed to 'css' function must be a 'css' function result: ${t}. Use 'unsafeCSS' to pass non-literal values, but\n            take care to ensure page security.`)})(s)+t[e+1]),t[0]);return new CSSResult(s,ns)};(window.litElementVersions||(window.litElementVersions=[])).push("2.5.1");const os={};class LitElement extends UpdatingElement{static getStyles(){return this.styles}static nt(){if(this.hasOwnProperty(JSCompiler_renameProperty("_styles",this)))return;const t=this.getStyles();if(Array.isArray(t)){const i=(t,s)=>t.reduceRight(((t,s)=>Array.isArray(s)?i(s,t):(t.add(s),t)),s),s=i(t,new Set),e=[];s.forEach((t=>e.unshift(t))),this.ht=e}else this.ht=void 0===t?[]:[t];this.ht=this.ht.map((t=>{if(t instanceof CSSStyleSheet&&!rs){const i=Array.prototype.slice.call(t.cssRules).reduce(((t,i)=>t+i.cssText),"");return new CSSResult(String(i),ns)}return t}))}initialize(){super.initialize(),this.constructor.nt(),this.renderRoot=this.createRenderRoot(),window.ShadowRoot&&this.renderRoot instanceof window.ShadowRoot&&this.adoptStyles()}createRenderRoot(){return this.attachShadow(this.constructor.shadowRootOptions)}adoptStyles(){const t=this.constructor.ht;0!==t.length&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow?rs?this.renderRoot.adoptedStyleSheets=t.map((t=>t instanceof CSSStyleSheet?t:t.styleSheet)):this.ot=!0:window.ShadyCSS.ScopingShim.prepareAdoptedCssText(t.map((t=>t.cssText)),this.localName))}connectedCallback(){super.connectedCallback(),this.hasUpdated&&void 0!==window.ShadyCSS&&window.ShadyCSS.styleElement(this)}update(t){const i=this.render();super.update(t),i!==os&&this.constructor.render(i,this.renderRoot,{scopeName:this.localName,eventContext:this}),this.ot&&(this.ot=!1,this.constructor.ht.forEach((t=>{const i=document.createElement("style");i.textContent=t.cssText,this.renderRoot.appendChild(i)})))}render(){return os}}LitElement.finalized=!0,LitElement.render=(t,i,s)=>{if(!s||"object"!=typeof s||!s.scopeName)throw new Error("The `scopeName` option is required.");const e=s.scopeName,r=Ni.has(i),n=Ri&&11===i.nodeType&&!!i.host,h=n&&!Hi.has(e),o=h?document.createDocumentFragment():i;if(((t,i,s)=>{let e=Ni.get(i);void 0===e&&(fi(i,i.firstChild),Ni.set(i,e=new NodePart(Object.assign({templateFactory:ki},s))),e.appendInto(i)),e.setValue(t),e.commit()})(t,o,Object.assign({templateFactory:Wi(e)},s)),h){const t=Ni.get(o);Ni.delete(o);((t,i,s)=>{Hi.add(t);const e=s?s.element:document.createElement("template"),r=i.querySelectorAll("style"),{length:n}=r;if(0===n)return void window.ShadyCSS.prepareTemplateStyles(e,t);const h=document.createElement("style");for(let t=0;t<n;t++){const i=r[t];i.parentNode.removeChild(i),h.textContent+=i.textContent}(t=>{ji.forEach((i=>{const s=$i.get(Di(i,t));void 0!==s&&s.keyString.forEach((t=>{const{element:{content:i}}=t,s=new Set;Array.from(i.querySelectorAll("style")).forEach((t=>{s.add(t)})),Ai(t,s)}))}))})(t);const o=e.content;s?function(t,i,s=null){const{element:{content:e},parts:r}=t;if(null==s)return void e.appendChild(i);const n=document.createTreeWalker(e,133,null,!1);let h=Si(r),o=0,a=-1;for(;n.nextNode();)for(a++,n.currentNode===s&&(o=Ci(i),s.parentNode.insertBefore(i,s));-1!==h&&r[h].index===a;){if(o>0){for(;-1!==h;)r[h].index+=o,h=Si(r,h);return}h=Si(r,h)}}(s,h,o.firstChild):o.insertBefore(h,o.firstChild),window.ShadyCSS.prepareTemplateStyles(e,t);const a=o.querySelector("style");if(window.ShadyCSS.nativeShadow&&null!==a)i.insertBefore(a.cloneNode(!0),i.firstChild);else if(s){o.insertBefore(h,o.firstChild);const t=new Set;t.add(h),Ai(s,t)}})(e,o,t.value instanceof TemplateInstance?t.value.template:void 0),fi(i,i.firstChild),i.appendChild(o),Ni.set(i,t)}!r&&n&&window.ShadyCSS.styleElement(i.host)},LitElement.shadowRootOptions={mode:"open"};let as=class extends(ai(LitElement)){static get styles(){return hs`:host{display:inline-block}.Player{display:inline-block;position:relative;font-family:var(--flipnote-player-font-family,sans-serif)}.CanvasArea{position:relative}.PlayerCanvas{position:relative;display:block}.Overlay{position:absolute;top:0;left:0;background:#ebf0f3;color:#4b4c53;width:100%;height:100%;display:flex;justify-content:center;align-items:center}.Overlay--error{background:#ff8b8b;color:#ca2a32}@keyframes spin{from{transform:rotateZ(0)}to{transform:rotateZ(360deg)}}.LoaderIcon{animation:spin infinite 1.2s linear}.Controls{background:var(--flipnote-player-controls-background,none)}.MuteIcon{width:28px;height:28px}.Controls__groupLeft,.Controls__groupRight,.Controls__row{display:flex;align-items:center}.Controls__groupLeft{margin-right:auto}.Controls__groupRight{margin-left:auto}.Controls__playButton{height:32px;width:32px;padding:2px}.MuteIcon{width:28px;height:28px}.LoaderIcon{width:40px;height:40px}.Controls.Controls--compact{margin:6px 0}.Controls__frameCounter{min-width:90px;font-variant-numeric:tabular-nums}.Controls__progressBar{flex:1}.Controls--compact .Controls__playButton{margin-right:8px}.Controls--compact .Controls__progressBar{flex:1}.Controls--default .Controls__playButton{margin-right:8px}.Controls--default .Controls__volumeBar{width:70px;margin-left:8px}.Button{border:0;padding:0;outline:0;-webkit-appearance:none;display:block;font-family:inherit;font-size:inherit;text-align:center;cursor:pointer;background:var(--flipnote-player-button-background,#ffd3a6);color:var(--flipnote-player-button-color,#f36a2d);border-radius:4px}.Button flipnote-player-icon{display:block}`}get width(){return this.lt}set width(t){const i=this.lt;var s;this.lt=t,this.ct=isNaN(+t)?t:`${t}px`,s=()=>this.updateCanvasSize(),d?w((()=>w((()=>s())))):s(),this.requestUpdate("width",i)}get src(){return this.ut}set src(t){const i=this.ut;this.dt&&this.player.load(t,ot),this.ut=t,this.requestUpdate("src",i)}get autoplay(){return this.player.autoplay}set autoplay(t){const i=this.player.autoplay;this.player.autoplay=t,this.requestUpdate("autoplay",i)}constructor(){super(),this.lt="auto",this.ct="auto",this.ft=0,this.yt="",this.wt=!1,this.gt=!1,this.vt=!1,this.bt=!1,this.Pt=0,this.dt=!1,this.handleResize=t=>{this.updateCanvasSize()},this.handleKeyInput=t=>{switch(t.preventDefault(),t.key.toLowerCase()){case" ":this.togglePlay();break;case"a":case"arrowleft":t.shiftKey?this.firstFrame():this.prevFrame();break;case"d":case"arrowright":t.shiftKey?this.lastFrame():this.nextFrame()}},this.handlePlayToggle=t=>{this.focus(),this.togglePlay()},this.handleMuteToggle=t=>{this.focus(),this.toggleMuted()},this.handleProgressSliderChange=t=>{this.focus(),this.seek(t.detail.value)},this.handleProgressSliderInputStart=()=>{this.focus(),this.startSeek()},this.handleProgressSliderInputEnd=()=>{this.focus(),this.endSeek()},this.handleVolumeBarChange=t=>{this.focus(),this.setVolume(t.detail.value)},this.At=new ResizeObserver(this.handleResize)}render(){return Oi`<style>:host{width:${this.ct}}</style><div class="Player" @keydown="${this.handleKeyInput}"><div class="CanvasArea" @click="${this.handlePlayToggle}"><div class="PlayerCanvas" id="canvasWrapper"></div>${this.wt?Oi`<div class="Overlay"><flipnote-player-icon icon="loader" class="LoaderIcon"></flipnote-player-icon></div>`:""} ${this.gt?Oi`<div class="Overlay Overlay--error">Error</div>`:""}</div>${this.renderControls()}</div>`}renderControls(){return"compact"===this.controls?Oi`<div class="Controls Controls--compact Controls__row"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this.vt?"pause":"play"}"></flipnote-player-icon></button><flipnote-player-slider class="Controls__progressBar" value="${this.ft}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></div>`:Oi`<div class="Controls Controls--default"><flipnote-player-slider class="Controls__progressBar" value="${this.ft}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></flipnote-player-slider><div class="Controls__row"><div class="Controls__groupLeft"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this.vt?"pause":"play"}"></flipnote-player-icon></button> <span class="Controls__frameCounter">${this.yt}</span></div><div class="Controls__groupRight"><flipnote-player-icon class="MuteIcon" @click="${this.handleMuteToggle}" icon="${this.bt?"volumeOff":"volumeOn"}"></flipnote-player-icon><flipnote-player-slider class="Controls__volumeBar" value="${this.Pt}" @change="${this.handleVolumeBarChange}"></flipnote-player-slider></div></div></div>`}firstUpdated(i){this.updateSettingsFromProps();const s=new Player(this.playerCanvasWrapper,256,192,this.parserSettings);this.At.observe(this),this.player=s,s.on(t.PlayerEvent.LoadStart,(()=>{this.wt=!0})),s.on(t.PlayerEvent.Load,(()=>{this.updateCanvasSize()})),s.on(t.PlayerEvent.Error,(()=>{this.wt=!1,this.gt=!0})),s.on([t.PlayerEvent.Load,t.PlayerEvent.Close,t.PlayerEvent.Progress],(()=>{this.wt=!1,this.gt=!1,this.ft=s.getProgress()/100,this.yt=s.getFrameCounter()})),s.on(t.PlayerEvent.Play,(()=>{this.vt=!0})),s.on(t.PlayerEvent.Pause,(()=>{this.vt=!1})),s.on([t.PlayerEvent.Load,t.PlayerEvent.VolumeChange],(()=>{this.Pt=s.volume,this.bt=s.muted})),s.on(t.PlayerEvent.t,((t,i)=>{this.dispatchEvent(new Event(t))})),this.ut&&s.load(this.ut,ot),this.dt=!0}disconnectedCallback(){this.At.disconnect(),this.destroy()}updateSettingsFromProps(){this.parserSettings={dsiLibraryNote:this.dsiLibrary,borderCrop:this.cropBorder,initialBgmPredictor:this.bgmPredictor,initialBgmStepIndex:this.bgmStepIndex,initialSePredictors:this.parseListProp(this?.sePredictors),initialSeStepIndices:this.parseListProp(this?.seStepIndices)}}parseListProp(t){if(t)return t.split(",").map((t=>/^\s*$/.test(t)?void 0:parseInt(t)))}updateCanvasSize(){const t=this.dt,i=this.player.note;let s=256;"auto"===this.lt&&t&&this.player.isNoteLoaded?s=i.imageWidth:"auto"!==this.lt&&(s=this.getBoundingClientRect().width),t&&i&&this.player.resize(s,s*i.aspect)}};ui([Xi({type:String})],as.prototype,"controls",void 0),ui([Xi({type:Boolean})],as.prototype,"dsiLibrary",void 0),ui([Xi({type:Boolean})],as.prototype,"cropBorder",void 0),ui([Xi({type:Number})],as.prototype,"bgmPredictor",void 0),ui([Xi({type:Number})],as.prototype,"bgmStepIndex",void 0),ui([Xi({type:String})],as.prototype,"sePredictors",void 0),ui([Xi({type:String})],as.prototype,"seStepIndices",void 0),ui([Xi({type:String})],as.prototype,"width",null),ui([Xi({type:String})],as.prototype,"src",null),ui([Xi({type:Boolean})],as.prototype,"autoplay",null),ui([ts()],as.prototype,"_width",void 0),ui([ts()],as.prototype,"_cssWidth",void 0),ui([ts()],as.prototype,"_progress",void 0),ui([ts()],as.prototype,"_counter",void 0),ui([ts()],as.prototype,"_isLoading",void 0),ui([ts()],as.prototype,"_isError",void 0),ui([ts()],as.prototype,"_isPlaying",void 0),ui([ts()],as.prototype,"_isMuted",void 0),ui([ts()],as.prototype,"_volumeLevel",void 0),ui([is("#canvasWrapper")],as.prototype,"playerCanvasWrapper",void 0),as=ui([Zi("flipnote-player")],as);class ClassList{constructor(t){this.classes=new Set,this.changed=!1,this.element=t;const i=(t.getAttribute("class")||"").split(/\s+/);for(const t of i)this.classes.add(t)}add(t){this.classes.add(t),this.changed=!0}remove(t){this.classes.delete(t),this.changed=!0}commit(){if(this.changed){let t="";this.classes.forEach((i=>t+=i+" ")),this.element.setAttribute("class",t)}}}const ls=new WeakMap,cs=_i((t=>i=>{if(!(i instanceof AttributePart)||i instanceof PropertyPart||"class"!==i.committer.name||i.committer.parts.length>1)throw new Error("The `classMap` directive must be used in the `class` attribute and must be the only part in the attribute.");const{committer:s}=i,{element:e}=s;let r=ls.get(i);void 0===r&&(e.setAttribute("class",s.strings.join(" ")),ls.set(i,r=new Set));const n=e.classList||new ClassList(e);r.forEach((i=>{i in t||(n.remove(i),r.delete(i))}));for(const i in t){const s=t[i];s!=r.has(i)&&(s?(n.add(i),r.add(i)):(n.remove(i),r.delete(i)))}"function"==typeof n.commit&&n.commit()})),us=new WeakMap,ds=_i((t=>i=>{if(!(i instanceof AttributePart)||i instanceof PropertyPart||"style"!==i.committer.name||i.committer.parts.length>1)throw new Error("The `styleMap` directive must be used in the style attribute and must be the only part in the attribute.");const{committer:s}=i,{style:e}=s.element;let r=us.get(i);void 0===r&&(e.cssText=s.strings.join(" "),us.set(i,r=new Set)),r.forEach((i=>{i in t||(r.delete(i),-1===i.indexOf("-")?e[i]=null:e.removeProperty(i))}));for(const i in t)r.add(i),-1===i.indexOf("-")?e[i]=t[i]:e.setProperty(i,t[i])}));let fs=class extends LitElement{constructor(){super(...arguments),this.value=0,this.orientation="horizontal",this.isActive=!1,this.onSliderMouseStart=t=>{t.preventDefault(),this.isActive=!0,document.addEventListener("mousemove",this.onSliderMouseMove),document.addEventListener("mouseup",this.onSliderMouseEnd),this.dispatch("inputstart"),this.onSliderInput(t.clientX,t.clientY)},this.onSliderMouseEnd=t=>{t.preventDefault(),document.removeEventListener("mousemove",this.onSliderMouseMove),document.removeEventListener("mouseup",this.onSliderMouseEnd),this.dispatch("inputend"),this.onSliderInput(t.clientX,t.clientY),this.isActive=!1},this.onSliderMouseMove=t=>{t.preventDefault(),this.onSliderInput(t.clientX,t.clientY)},this.onSliderTouchStart=t=>{const i=t.changedTouches[0];t.preventDefault(),this.isActive=!0,document.addEventListener("touchmove",this.onSliderTouchMove),document.addEventListener("touchend",this.onSliderTouchEnd),this.dispatch("inputstart"),this.onSliderInput(i.clientX,i.clientY)},this.onSliderTouchEnd=t=>{const i=t.changedTouches[0];t.preventDefault(),document.removeEventListener("touchmove",this.onSliderTouchMove),document.removeEventListener("touchend",this.onSliderTouchEnd),this.dispatch("inputend"),this.onSliderInput(i.clientX,i.clientY),this.isActive=!1},this.onSliderTouchMove=t=>{const i=t.changedTouches[0];t.preventDefault(),this.onSliderInput(i.clientX,i.clientY)},this.onSliderInput=(t,i)=>{const s=this.sliderElement.getBoundingClientRect();let e;if("horizontal"===this.orientation){const i=s.height/2,r=s.width-2*i,n=(t-s.left-i)/r;e=Math.max(0,Math.min(n,1))}else if("vertical"===this.orientation){const t=s.width/2,r=s.height-2*t,n=1-(i-s.top-t)/r;e=Math.max(0,Math.min(n,1))}this.value!==e&&this.dispatch("change",{value:e})}}static get styles(){return hs`.Slider{touch-action:none;padding:4px 0;cursor:pointer}.Slider--vertical{height:100px;width:14px}.Slider__track{position:relative;border-radius:3px;background:var(--flipnote-player-slider-track,#ffd3a6)}.Slider--horizontal .Slider__track{height:4px;margin:6px 0}.Slider--vertical .Slider__track{width:4px;height:100%;margin:0 6px}.Slider__levelWrapper{position:absolute;left:0;right:0;height:6px;margin:-1px}.Slider__level{position:absolute;width:100%;left:0;height:8px;border-radius:8px;background:var(--flipnote-player-slider-level,#f36a2d)}.Slider--horizontal .Slider__level{width:100%;height:6px}.Slider--vertical .Slider__level{width:6px;height:100%;bottom:0}.Slider__handle{display:none;position:absolute;height:10px;width:10px;border-radius:5px;box-sizing:border-box;border:3px solid var(--flipnote-player-slider-handle,#f36a2d);background:var(--flipnote-player-slider-handle-fill,#fff)}.Slider--isActive .Slider__handle,.Slider:hover .Slider__handle{display:block}.Slider--horizontal .Slider__handle{top:0;margin-top:-3px;margin-left:-6px}.Slider--vertical .Slider__handle{left:0;margin-bottom:-6px;margin-left:-3px}`}render(){const t=100*this.value+"%",i="horizontal"===this.orientation?"width":"height",s="horizontal"===this.orientation?"left":"bottom",e={Slider:!0,"Slider--horizontal":"horizontal"===this.orientation,"Slider--vertical":"vertical"===this.orientation,"Slider--isActive":this.isActive};return Oi`<div class="${cs(e)}" @touchstart="${this.onSliderTouchStart}" @mousedown="${this.onSliderMouseStart}"><div class="Slider__track"><div class="Slider__levelWrapper"><div class="Slider__level" style="${ds({[i]:t})}"></div></div><div class="Slider__handle" style="${ds({[s]:t})}"></div></div></div>`}dispatch(t,i){const s=new CustomEvent(t,{detail:i});this.dispatchEvent(s)}};ui([Xi({type:Number})],fs.prototype,"value",void 0),ui([Xi({type:String})],fs.prototype,"orientation",void 0),ui([ts()],fs.prototype,"isActive",void 0),ui([is(".Slider__track")],fs.prototype,"sliderElement",void 0),fs=ui([Zi("flipnote-player-slider")],fs);const ps=new WeakMap,ms=window.navigator.userAgent.indexOf("Trident/")>0,ys=_i((t=>i=>{if(!(i instanceof NodePart))throw new Error("unsafeSVG can only be used in text bindings");const s=ps.get(i);if(void 0!==s&&Ti(t)&&t===s.value&&i.value===s.fragment)return;const e=document.createElement("template"),r=e.content;let n;ms?(e.innerHTML=`<svg>${t}</svg>`,n=r.firstChild):(n=document.createElementNS("http://www.w3.org/2000/svg","svg"),r.appendChild(n),n.innerHTML=t),r.removeChild(n),((t,i,s=null,e=null)=>{for(;i!==s;){const s=i.nextSibling;t.insertBefore(i,e),i=s}})(r,n.firstChild);const h=document.importNode(r,!0);i.setValue(h),ps.set(i,{value:t,fragment:h})}));function ws(t){return t.replace(/<svg ([^>]*)>/,((t,i)=>`<svg ${i} class="Icon" style="fill:currentColor">`))}const gs={play:ws('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M74.1374132,48 L83.1218112,48 C83.8751514,48 84.6131784,48.2127391 85.2509322,48.6137272 L177.244774,106.454909 C184.725521,111.158433 186.976905,121.035737 182.273381,128.516484 C180.99563,130.548691 179.27698,132.26734 177.244774,133.545091 L85.2509322,191.386273 C84.6131784,191.787261 83.8751514,192 83.1218112,192 L74.1374132,192 C68.5386745,192 64,187.461326 64,181.862587 L64,58.1374132 C64,52.5386745 68.5386745,48 74.1374132,48 Z"/></svg>'),pause:ws('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M64,48 L88,48 C96.836556,48 104,55.163444 104,64 L104,176 C104,184.836556 96.836556,192 88,192 L64,192 C55.163444,192 48,184.836556 48,176 L48,64 C48,55.163444 55.163444,48 64,48 Z M152,48 L176,48 C184.836556,48 192,55.163444 192,64 L192,176 C192,184.836556 184.836556,192 176,192 L152,192 C143.163444,192 136,184.836556 136,176 L136,64 C136,55.163444 143.163444,48 152,48 Z"/></svg>'),loader:ws('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M120,176 C128.836556,176 136,183.163444 136,192 C136,200.836556 128.836556,208 120,208 C111.163444,208 104,200.836556 104,192 C104,183.163444 111.163444,176 120,176 Z M168.497423,148 C172.915701,140.347318 182.701147,137.725316 190.353829,142.143594 C198.006511,146.561872 200.628514,156.347318 196.210236,164 C191.791958,171.652682 182.006511,174.274684 174.353829,169.856406 C166.701147,165.438128 164.079145,155.652682 168.497423,148 Z M49.6461709,142.143594 C57.2988529,137.725316 67.0842994,140.347318 71.5025774,148 C75.9208554,155.652682 73.2988529,165.438128 65.6461709,169.856406 C57.993489,174.274684 48.2080425,171.652682 43.7897645,164 C39.3714865,156.347318 41.993489,146.561872 49.6461709,142.143594 Z M174.353829,70.1435935 C182.006511,65.7253155 191.791958,68.347318 196.210236,76 C200.628514,83.652682 198.006511,93.4381285 190.353829,97.8564065 C182.701147,102.274684 172.915701,99.652682 168.497423,92 C164.079145,84.347318 166.701147,74.5618715 174.353829,70.1435935 Z M43.7897645,76 C48.2080425,68.347318 57.993489,65.7253155 65.6461709,70.1435935 C73.2988529,74.5618715 75.9208554,84.347318 71.5025774,92 C67.0842994,99.652682 57.2988529,102.274684 49.6461709,97.8564065 C41.993489,93.4381285 39.3714865,83.652682 43.7897645,76 Z M120,32 C128.836556,32 136,39.163444 136,48 C136,56.836556 128.836556,64 120,64 C111.163444,64 104,56.836556 104,48 C104,39.163444 111.163444,32 120,32 Z"/></svg>'),volumeOn:ws('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M113.3,42.0221751 C116.173884,39.8502203 119.99384,39.3918256 123.3,40.8221751 C126.772838,42.476202 128.989111,45.9755807 129,49.8221751 L129,49.8221751 L129,189.822175 C128.989111,193.66877 126.772838,197.168148 123.3,198.822175 C121.970477,199.503408 120.493687,199.846847 119,199.823416 C116.744358,199.809091 114.559393,199.033781 112.8,197.622175 L112.8,197.622175 L65.5,159.822175 L29,159.822175 C23.4771525,159.822175 19,155.345023 19,149.822175 L19,149.822175 L19,89.8221751 C19,84.2993276 23.4771525,79.8221751 29,79.8221751 L29,79.8221751 L65.5,79.8221751 Z M196.286415,59.3197538 C213.294099,75.5543608 222.000706,95.3421052 222.000706,118.00002 C222.000706,140.370063 213.535918,161.147272 197.009268,179.927555 C192.631012,184.902847 185.048463,185.386839 180.073171,181.008583 C175.09788,176.630326 174.613887,169.047777 178.992144,164.072486 C191.798828,149.519435 198.000706,134.296644 198.000706,118.00002 C198.000706,101.991269 192.040647,88.4456799 179.714997,76.6802869 C174.921018,72.1042162 174.744369,64.5082902 179.32044,59.7143114 C183.89651,54.9203325 191.492436,54.7436831 196.286415,59.3197538 Z M165.200706,87.4000203 C176.105233,95.5784156 182.000706,106.386783 182.000706,119.00002 C182.000706,131.432529 176.288715,142.380513 165.682919,151.218676 C160.591596,155.461445 153.02482,154.773556 148.782051,149.682233 C144.608835,144.674375 145.205942,137.27156 150.071653,132.99268 L150.318493,132.781365 C155.712698,128.286195 158.000706,123.900845 158.000706,119.00002 C158.000706,114.387199 155.990753,110.597447 151.143501,106.860651 L150.800706,106.60002 C145.498773,102.62357 144.424256,95.1019539 148.400706,89.8000203 C152.377156,84.4980867 159.898773,83.4235701 165.200706,87.4000203 Z"/></svg>'),volumeOff:ws('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M123.3,40.8221751 C119.99384,39.3918256 116.173884,39.8502203 113.3,42.0221751 L65.5,79.8221751 L29,79.8221751 C23.4771525,79.8221751 19,84.2993276 19,89.8221751 L19,149.822175 C19,155.345023 23.4771525,159.822175 29,159.822175 L65.5,159.822175 L112.8,197.622175 C114.559393,199.033781 116.744358,199.809091 119,199.823416 C120.493687,199.846847 121.970477,199.503408 123.3,198.822175 C126.772838,197.168148 128.989111,193.66877 129,189.822175 L129,49.8221751 C128.989111,45.9755807 126.772838,42.476202 123.3,40.8221751 Z M193.751433,91.2843093 C198.453467,86.8297289 205.877095,86.906532 210.485281,91.5147186 C215.093468,96.1229053 215.170271,103.546533 210.715691,108.248567 L210.485281,108.485281 L198.971,120 L210.485281,131.514719 C215.171573,136.20101 215.171573,143.79899 210.485281,148.485281 C205.877095,153.093468 198.453467,153.170271 193.751433,148.715691 L193.514719,148.485281 L182,136.971 L170.485281,148.485281 L170.248567,148.715691 C165.546533,153.170271 158.122905,153.093468 153.514719,148.485281 C148.906532,143.877095 148.829729,136.453467 153.284309,131.751433 L153.514719,131.514719 L165.029,120 L153.514719,108.485281 C148.828427,103.79899 148.828427,96.2010101 153.514719,91.5147186 C158.122905,86.906532 165.546533,86.8297289 170.248567,91.2843093 L170.485281,91.5147186 L182,103.029 L193.514719,91.5147186 L193.751433,91.2843093 Z"/></svg>')};let vs=class extends LitElement{constructor(){super(...arguments),this.icon="loader"}static get styles(){return hs`.Icon{width:100%;height:100%;color:var(--flipnote-player-icon-color,#f36a2d)}`}render(){return Oi`${ys(gs[this.icon])}`}};ui([Xi({type:String})],vs.prototype,"icon",void 0),vs=ui([Zi("flipnote-player-icon")],vs);let bs=class extends LitElement{constructor(){super(...arguments),this.u="",this.m="0",this.cropped=!1,this.gifUrl="",this.imgTitle=""}static get styles(){return hs`.Image{width:inherit;height:inherit;image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges;-ms-interpolation-mode:nearest-neighbor}`}set src(t){this.load(t)}get src(){return this.u}set frame(t){this.m=t,this.note&&this.loadNote(this.note)}get frame(){return this.m}render(){return Oi`<img class="Image" src="${this.gifUrl}" alt="${this.imgTitle}" title="${this.imgTitle}">`}revokeUrl(){this.gif&&this.gif.dataUrl&&(this.gif.revokeUrl(),this.gifUrl="")}loadNote(t){this.note=t,this.revokeUrl();const i=this.m;if("all"===i)this.gif=GifImage.fromFlipnote(t),this.gifUrl=this.gif.getUrl();else if("thumb"===i)this.gif=GifImage.fromFlipnoteFrame(t,t.thumbFrameIndex),this.gifUrl=this.gif.getUrl();else if(!isNaN(+i)){const s=parseInt(i);this.gif=GifImage.fromFlipnoteFrame(t,s),this.gifUrl=this.gif.getUrl()}this.gifUrl?(this.dispatchLoad(),this.imgTitle=t.getTitle()):this.dispatchError("Invalid frame attribute")}load(t){this.u=t,this.note=void 0;const i="true"===this.getAttribute("cropped");ot(t,{borderCrop:i}).then((t=>this.loadNote(t))).catch((t=>this.dispatchError(t)))}disconnectedCallback(){this.revokeUrl()}dispatchLoad(){this.dispatchEvent(new Event("load"))}dispatchError(t){throw this.dispatchEvent(new ErrorEvent("error",{error:t})),new Error(t)}};ui([Xi()],bs.prototype,"src",null),ui([Xi()],bs.prototype,"frame",null),ui([Xi({type:Boolean})],bs.prototype,"cropped",void 0),ui([ts()],bs.prototype,"gifUrl",void 0),ui([ts()],bs.prototype,"imgTitle",void 0),bs=ui([Zi("flipnote-image")],bs);const Ps=as,As=bs;t.CanvasInterface=class{constructor(t,i,s,e){}},t.GifImage=GifImage,t.Html5Canvas=Html5Canvas,t.ImageComponent=As,t.KwzParser=KwzParser,t.Player=Player,t.PlayerComponent=Ps,t.PlayerMixin=ai,t.PpmParser=PpmParser,t.UniversalCanvas=UniversalCanvas,t.WavAudio=WavAudio,t.WebAudioPlayer=WebAudioPlayer,t.WebglCanvas=WebglCanvas,t.loadSource=ht,t.parseSource=ot,t.utils=j,t.version="5.12.0"}));
//# sourceMappingURL=flipnote.webcomponent.min.js.map
