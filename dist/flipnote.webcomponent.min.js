/*!!
 * flipnote.js v6.0.1
 * https://flipnote.js.org
 * A JavaScript library for Flipnote Studio animation files
 * 2018 - 2024 James Daniel
 * Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
*/
!function(i){var r,n,h,o,a,l;i.FlipnoteRegion=void 0,(r=i.FlipnoteRegion||(i.FlipnoteRegion={})).EUR="EUR",r.USA="USA",r.JPN="JPN",r.UNKNOWN="UNKNOWN",i.FlipnoteFormat=void 0,(n=i.FlipnoteFormat||(i.FlipnoteFormat={})).PPM="PPM",n.KWZ="KWZ",function(i){i[i.Jpeg=0]="Jpeg",i[i.Rgba=1]="Rgba"}(h||(h={})),function(i){i[i.Left=0]="Left",i[i.Right=1]="Right"}(o||(o={})),i.FlipnoteAudioTrack=void 0,(a=i.FlipnoteAudioTrack||(i.FlipnoteAudioTrack={}))[a.BGM=0]="BGM",a[a.SE1=1]="SE1",a[a.SE2=2]="SE2",a[a.SE3=3]="SE3",a[a.SE4=4]="SE4",i.FlipnoteSoundEffectTrack=void 0,(l=i.FlipnoteSoundEffectTrack||(i.FlipnoteSoundEffectTrack={}))[l.SE1=1]="SE1",l[l.SE2=2]="SE2",l[l.SE3=3]="SE3",l[l.SE4=4]="SE4";class ByteArray{constructor(){this.pageSize=4096,this.allocSize=0,this.realSize=0,this.pages=[],this.numPages=0,this.pageIdx=0,this.pagePtr=0,this.realPtr=0,this.newPage()}set pointer(i){this.setPointer(i)}get pointer(){return this.realPtr}newPage(){this.pages[this.numPages]=new Uint8Array(this.pageSize),this.numPages=this.pages.length,this.allocSize=this.numPages*this.pageSize}setPointer(i){for(;i>=this.allocSize;)this.newPage();i>this.realSize&&(this.realSize=i),this.pageIdx=Math.floor(i/this.pageSize),this.pagePtr=i%this.pageSize,this.realPtr=i}writeByte(i){this.pages[this.pageIdx][this.pagePtr]=i,this.setPointer(this.realPtr+1)}writeBytes(i,r,n){for(let h=n||i.length,o=r||0;o<h;o++)this.writeByte(i[o])}writeChars(i){for(let r=0;r<i.length;r++)this.writeByte(i.charCodeAt(r))}writeU8(i){this.writeByte(255&i)}writeU16(i){this.writeByte(i>>>0&255),this.writeByte(i>>>8&255)}writeU32(i){this.writeByte(i>>>0&255),this.writeByte(i>>>8&255),this.writeByte(i>>>16&255),this.writeByte(i>>>24&255)}getBytes(){const i=new Uint8Array(this.realSize),r=this.numPages;for(let n=0;n<r;n++){const h=this.pages[n];n===r-1?i.set(h.slice(0,this.realSize%this.pageSize),n*this.pageSize):i.set(h,n*this.pageSize)}return i}getBuffer(){return this.getBytes().buffer}}class DataStream{constructor(i){this.buffer=i,this.data=new DataView(i),this.pointer=0}get bytes(){return new Uint8Array(this.buffer)}get byteLength(){return this.data.byteLength}seek(i,r){switch(r){case 2:this.pointer=this.data.byteLength+i;break;case 1:this.pointer+=i;break;default:this.pointer=i}}readUint8(){const i=this.data.getUint8(this.pointer);return this.pointer+=1,i}writeUint8(i){this.data.setUint8(this.pointer,i),this.pointer+=1}readInt8(){const i=this.data.getInt8(this.pointer);return this.pointer+=1,i}writeInt8(i){this.data.setInt8(this.pointer,i),this.pointer+=1}readUint16(i=!0){const r=this.data.getUint16(this.pointer,i);return this.pointer+=2,r}writeUint16(i,r=!0){this.data.setUint16(this.pointer,i,r),this.pointer+=2}readInt16(i=!0){const r=this.data.getInt16(this.pointer,i);return this.pointer+=2,r}writeInt16(i,r=!0){this.data.setInt16(this.pointer,i,r),this.pointer+=2}readUint32(i=!0){const r=this.data.getUint32(this.pointer,i);return this.pointer+=4,r}writeUint32(i,r=!0){this.data.setUint32(this.pointer,i,r),this.pointer+=4}readInt32(i=!0){const r=this.data.getInt32(this.pointer,i);return this.pointer+=4,r}writeInt32(i,r=!0){this.data.setInt32(this.pointer,i,r),this.pointer+=4}readBytes(i){const r=new Uint8Array(this.data.buffer,this.pointer,i);return this.pointer+=r.byteLength,r}writeBytes(i){i.forEach((i=>this.writeUint8(i)))}readHex(i,r=!1){const n=this.readBytes(i);let h=[];for(let i=0;i<n.length;i++)h.push(n[i].toString(16).padStart(2,"0"));return r&&h.reverse(),h.join("").toUpperCase()}readChars(i){const r=this.readBytes(i);let n="";for(let i=0;i<r.length;i++){const h=r[i];if(0===h)break;n+=String.fromCharCode(h)}return n}writeChars(i){for(let r=0;r<i.length;r++){const n=i.charCodeAt(r);this.writeUint8(n)}}readWideChars(i){const r=new Uint16Array(this.data.buffer,this.pointer,i);let n="";for(let i=0;i<r.length;i++){const h=r[i];if(0==h)break;n+=String.fromCharCode(h)}return this.pointer+=r.byteLength,n}}const c=(i,r,n)=>i<r?r:i>n?n:i,u=(i,r,n)=>i+n*(r-i);function d(i,r="Assert failed"){i||p(r)}const f=(i,r,n,h="")=>d(i>=r&&i<=n,`flipnote.js error: ${h||"value"} ${i} should be between ${r} and ${n}`),p=(i="Assert failed")=>{throw new Error("flipnote.js error: "+i)},y=()=>v?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},m="undefined"!=typeof window&&void 0!==window.document,g=()=>d(m,"This feature is only available in browser environments"),v="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,w="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,A=m&&(window.requestAnimationFrame||window.webkitRequestAnimationFrame);var P;!function(){if(!m)return function(){};document.createElement("a")}();class BaseParser extends DataStream{constructor(){super(...arguments),this[P]="Flipnote",this.titleFormats={COMMENT:"Comment by $USERNAME",FLIPNOTE:"Flipnote by $USERNAME",ICON:"Folder icon"},this.soundMeta=new Map,this.layerVisibility={1:!0,2:!0,3:!0},this.isFolderIcon=!1,this.isComment=!1,this.isDsiLibraryNote=!1}getTitle(i=this.titleFormats){return this.isFolderIcon?i.ICON:(this.isComment?i.COMMENT:i.FLIPNOTE).replace("$USERNAME",this.meta.current.username)}toString(){return this.getTitle()}*[(P=Symbol.toStringTag,Symbol.iterator)](){for(let i=0;i<this.frameCount;i++)yield i}getLayerPixels(i,r,n=new Uint8Array(this.imageWidth*this.imageHeight),h=0,a=o.Left){f(i,0,this.frameCount-1,"Frame index"),f(r,0,this.numLayers-1,"Layer index");const l=this.getFramePaletteIndices(i),c=r*this.numLayerColors,u=this.decodeFrame(i)[r],d=Math.floor(this.getFrameLayerDepths(i)[r]*h),p=a==o.Left?-d:d,y=this.srcWidth,m=this.imageWidth,g=this.imageWidth,v=this.imageHeight,w=this.imageOffsetX,A=this.imageOffsetY;if(n.fill(0),!this.layerVisibility[r+1])return n;for(let i=A,r=0;r<v;i++,r++)for(let h=w,o=0;o<g;h++,o++){const a=r*m+o+p;let d=u[i*y+h];0!==d&&(n[a]=l[c+d])}return n}getLayerPixelsRgba(i,r,n=new Uint32Array(this.imageWidth*this.imageHeight),h=new Uint32Array(16),a=0,l=o.Left){f(i,0,this.frameCount-1,"Frame index"),f(r,0,this.numLayers-1,"Layer index"),this.getFramePaletteUint32(i,h);const c=r*this.numLayerColors,u=this.decodeFrame(i)[r],d=Math.floor(this.getFrameLayerDepths(i)[r]*a),p=l==o.Left?-d:d,y=this.srcWidth,m=this.imageWidth,g=this.imageWidth-d,v=this.imageHeight,w=this.imageOffsetX,A=this.imageOffsetY;if(n.fill(0),!this.layerVisibility[r+1])return n;for(let i=A,r=0;r<v;i++,r++)for(let o=w,a=0;a<g;o++,a++){const l=r*m+a+p;let d=u[i*y+o];0!==d&&(n[l]=h[c+d])}return n}getFramePixels(i,r=new Uint8Array(this.imageWidth*this.imageHeight),n=0,h=o.Left){const a=this.srcWidth;this.imageWidth;const l=this.imageWidth,c=this.imageHeight,u=this.imageOffsetX,d=this.imageOffsetY,f=this.getFramePaletteIndices(i);r.fill(f[0]);const p=this.getFrameLayerOrder(i),y=this.getFrameLayerDepths(i),m=this.decodeFrame(i);for(let i=0;i<this.numLayers;i++){const g=p[i],v=m[g],w=g*this.numLayerColors,A=Math.floor(y[g]*n),P=h==o.Left?-A:A;if(this.layerVisibility[g+1])for(let i=d,n=0;n<c;i++,n++)for(let h=u,o=0;o<l;h++,o++){const c=n*l+o+P;let u=v[i*a+h];0!==u&&(r[c]=f[w+u])}}return r}getFramePixelsRgba(i,r=new Uint32Array(this.imageWidth*this.imageHeight),n=new Uint32Array(16),h=0,a=o.Left){f(i,0,this.frameCount-1,"Frame index");const l=this.srcWidth,c=this.imageWidth,u=this.imageWidth,d=this.imageHeight,p=this.imageOffsetX,y=this.imageOffsetY;this.getFramePaletteUint32(i,n),r.fill(n[0]);const m=this.getFrameLayerOrder(i),g=this.getFrameLayerDepths(i),v=this.decodeFrame(i);for(let i=0;i<this.numLayers;i++){const f=m[i];if(!this.layerVisibility[f+1])continue;const w=v[f],A=f*this.numLayerColors,P=Math.floor(g[f]*h),C=a==o.Left?-P:P;for(let i=y,h=0;i<d;i++,h++)for(let o=p,a=0;o<u;o++,a++){const u=h*c+a+C;let d=w[i*l+o];0!==d&&(r[u]=n[A+d])}}return r}getFramePaletteUint32(i,r=new Uint32Array(16)){f(i,0,this.frameCount-1,"Frame index");const n=this.getFramePalette(i);return r.fill(0),n.forEach((([i,n,h,o],a)=>r[a]=o<<24|h<<16|n<<8|i)),r}getSoundEffectFlagsForTrack(i){return this.getSoundEffectFlags().map((r=>r[i]))}isSoundEffectUsedOnFrame(i,r){return f(r,0,this.frameCount-1,"Frame index"),!!this.soundEffectTracks.includes(i)&&this.getFrameSoundEffectFlags(r)[i]}hasAudioTrack(i){return this.soundMeta.has(i)&&this.soundMeta.get(i).length>0}}const C=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,_=["01FACA7A4367FC5F","03D6E959E2F9A42D","03F80445160587FA","04068426E1008915","092A3EC8199FD5D5","0B8D56BA1BD441B8","0E61C75C9B5AD90B","14E494E35A443235"],x=i=>C.test(i)||_.includes(i),F=r=>{switch(r.charAt(0)){case"0":case"1":return i.FlipnoteRegion.JPN;case"5":return i.FlipnoteRegion.USA;case"9":return i.FlipnoteRegion.EUR;default:return i.FlipnoteRegion.UNKNOWN}},z=new Int8Array([-1,2,-1,2]),$=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),U=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),E=(i,r,n)=>n<0||n>=r?0:i[n],T=i=>{const r=i.length;let n=0;for(let h=0;h<r;h++){const r=i[h];(r<=-32768||r>=32767)&&(n+=1)}return n/r},B=i=>{const r=i.length;let n=0;for(let h=0;h<r;h++)n+=Math.pow(i[h],2);return Math.sqrt(n/r)},K=i=>new Date(1e3*(i+946684800)),N=(i,r)=>100*i*(1/r)/100,D=(()=>{if(m||w){const i=y();return(i.crypto||i.msCrypto).subtle}if(v)return((i,r)=>{try{return i.require(r)}catch{throw new Error(`Could not require(${r})`)}})(module,"crypto").webcrypto.subtle})(),O="RSASSA-PKCS1-v1_5",j=async(i,r)=>{const n=i.split("\n").filter((i=>!i.startsWith("-----")&&!i.endsWith("-----"))).join(""),h=atob(n),o=new Uint8Array(h.length).map(((i,r)=>h.charCodeAt(r)));return await D.importKey("spki",o.buffer,{name:O,hash:r},!1,["verify"])},W=async(i,r,n)=>await D.verify(O,i,r,n);var G;const Z=[.5,.5,1,2,4,6,12,20,30],Q={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},q=[4294967295,4283585106,4294967295,4288453788,4282665215,4283388360,4289506815,4278255360,4294918216,4290269009,4294945709,4278255360,4290205622,4278255360,4278255360,4278255360],Y="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCPLwTL6oSflv+gjywi/sM0TUB\n90xqOvuCpjduETjPoN2FwMebxNjdKIqHUyDu4AvrQ6BDJc6gKUbZ1E27BGZoCPH4\n9zQRb+zAM6M9EjHwQ6BABr0u2TcF7xGg2uQ9MBWz9AfbVQ91NjfrNWo0f7UPmffv\n1VvixmTk1BCtavZxBwIDAQAB\n-----END PUBLIC KEY-----";class PpmParser extends BaseParser{static matchBuffer(i){const r=new Uint8Array(i.slice(0,4));return 1346458177==(r[0]<<24|r[1]<<16|r[2]<<8|r[3])}constructor(r,n={}){super(r),this.format=i.FlipnoteFormat.PPM,this[G]="Flipnote Studio PPM animation file",this.imageWidth=PpmParser.width,this.imageHeight=PpmParser.height,this.aspect=PpmParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=PpmParser.numLayers,this.numLayerColors=PpmParser.numLayerColors,this.publicKey=PpmParser.publicKey,this.srcWidth=PpmParser.width,this.audioTracks=PpmParser.audioTracks,this.soundEffectTracks=PpmParser.soundEffectTracks,this.rawSampleRate=PpmParser.rawSampleRate,this.sampleRate=PpmParser.sampleRate,this.globalPalette=PpmParser.globalPalette,this.prevDecodedFrame=null,this.decodeHeader(),this.decodeAnimationHeader(),this.decodeSoundHeader(),this.version>>4&15&&this.decodeMeta(),this.layerBuffers=[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],this.prevLayerBuffers=[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],this.lineEncodingBuffers=[new Uint8Array(PpmParser.height),new Uint8Array(PpmParser.height)],this.prevDecodedFrame=null}decodeHeader(){d(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16();let i=1696+this.frameDataLength+this.frameCount;i%4!=0&&(i+=4-i%4),d(i<this.byteLength),this.soundDataOffset=i}readFilename(){return`${this.readHex(3)}_${this.readChars(13)}_${this.readUint16().toString().padStart(3,"0")}`}decodeMeta(){d(1704<this.byteLength),this.seek(16);const i=this.readUint16(),r=this.readInt16(),n=this.readWideChars(11),h=this.readWideChars(11),o=this.readWideChars(11),a=this.readHex(8,!0),l=this.readHex(8,!0),c=this.readFilename(),u=this.readFilename(),f=this.readHex(8,!0);this.seek(154);const p=K(this.readInt32());this.seek(1702);const y=this.readUint16();this.thumbFrameIndex=r,this.layerVisibility={1:!(16&y),2:!(32&y),3:!1},this.isSpinoff=l!==a||l!==f,this.meta={lock:1===i,loop:1==(y>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:r,timestamp:p,root:{username:n,fsid:f,region:F(f),filename:null},parent:{username:h,fsid:a,region:F(a),filename:c},current:{username:o,fsid:l,region:F(l),filename:u}}}decodeAnimationHeader(){this.seek(1696);const i=this.readUint16(),r=i/4;d(r<=this.frameCount),this.seek(1704);const n=new Uint32Array(r);for(let h=0;h<r;h++){const r=1704+i+this.readUint32();d(r<this.byteLength,`Frame ${h} pointer is out of bounds`),n[h]=r}this.frameOffsets=n}decodeSoundHeader(){let r=this.soundDataOffset;this.seek(r);const n=this.readUint32(),h=this.readUint32(),o=this.readUint32(),a=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),d(this.frameSpeed<=8&&this.bgmSpeed<=8),r+=32,this.framerate=Z[this.frameSpeed],this.duration=N(this.frameCount,this.framerate),this.bgmrate=Z[this.bgmSpeed];const l=new Map;l.set(i.FlipnoteAudioTrack.BGM,{ptr:r,length:n}),l.set(i.FlipnoteAudioTrack.SE1,{ptr:r+=n,length:h}),l.set(i.FlipnoteAudioTrack.SE2,{ptr:r+=h,length:o}),l.set(i.FlipnoteAudioTrack.SE3,{ptr:r+=o,length:a}),this.soundMeta=l}isKeyFrame(i){return f(i,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[i]),this.readUint8()>>7&1}getThumbnailImage(){this.seek(160);const i=this.readBytes(1536),r=new Uint32Array(3072);for(let n=0;n<48;n+=8)for(let h=0;h<64;h+=8)for(let o=0;o<8;o+=1)for(let a=0;a<8;a+=2){const l=h+a,c=n+o;r[64*c+l]=q[15&i[0]],r[64*c+l+1]=q[i[0]<<4&15]}return{format:h.Rgba,width:64,height:48,data:r.buffer}}decodeFrame(i){if(f(i,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===i)return this.layerBuffers;this.prevDecodedFrame===i-1||this.isKeyFrame(i)||0===i||this.decodeFrame(i-1),this.prevDecodedFrame=i,this.seek(this.frameOffsets[i]);const r=this.readUint8(),n=r>>7&1,h=r>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);let o=0,a=0;h&&(o=this.readInt8(),a=this.readInt8());for(let i=0;i<2;i++){const r=this.lineEncodingBuffers[i];r.fill(0);for(let i=0;i<r.length;){let n=this.readUint8();0!==n?(r[i++]=3&n,r[i++]=n>>2&3,r[i++]=n>>4&3,r[i++]=n>>6&3):i+=4}}for(let i=0;i<2;i++){const r=this.layerBuffers[i],n=this.lineEncodingBuffers[i];for(let i=0;i<PpmParser.height;i++){let h=i*PpmParser.width;switch(n[i]){case 0:break;case 1:for(var l=this.readUint32(!1);0!==l;l<<=1,h+=8)if(2147483648&l){let i=this.readUint8();for(let n=0;0!==i;n++,i>>=1)r[h+n]=1&i}break;case 2:for(r.fill(1,h,h+PpmParser.width),l=this.readUint32(!1);0!==l;l<<=1,h+=8)if(2147483648&l){let i=this.readUint8();for(let n=0;n<8;n++,i>>=1)r[h+n]=1&i}break;case 3:for(let i=0,n=0;n<PpmParser.width;n++)n%8==0&&(i=this.readUint8()),r[h++]=1&i,i>>=1}}}const c=this.layerBuffers[0],u=this.layerBuffers[1],d=this.prevLayerBuffers[0],p=this.prevLayerBuffers[1];if(n||0!==o||0!==a){if(!n){const i=PpmParser.width,r=PpmParser.height,n=Math.max(o,0),h=Math.max(a,0),l=Math.min(i+o,i),f=Math.min(r+a,r),y=a*i+o;let m,g;for(let r=h;r<f;r++)for(let h=n;h<l;h++)m=r*i+h,g=m-y,c[m]^=d[g],u[m]^=p[g]}}else{const i=PpmParser.height*PpmParser.width;for(let r=0;r<i;r++)c[r]^=d[r],u[r]^=p[r]}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers}getFramePaletteIndices(i){f(i,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[i]);const r=this.readUint8(),n=!!(1&~r),h=[n?0:1,n?0:1,2,3];return[n?1:0,h[r>>1&3],h[r>>3&3]]}getFramePalette(i){return f(i,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(i).map((i=>this.globalPalette[i]))}getIsKeyFrame(i){const r=1===this.isKeyFrame(i);return[r,r]}getFrameLayerDepths(i){return[0,0]}getFrameAuthor(i){return this.meta.current.fsid}getFrameCameraFlags(i){return[!1,!1]}getFrameLayerOrder(i){return[1,0]}decodeSoundFlags(){if(void 0!==this.soundFlags)return this.soundFlags;d(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);const i=this.frameCount,r=this.readBytes(i);this.soundFlags=new Array(i);for(let n=0;n<i;n++){const i=r[n];this.soundFlags[n]=[!!(1&i),!!(2&i),!!(4&i)]}return this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map((r=>({[i.FlipnoteSoundEffectTrack.SE1]:r[0],[i.FlipnoteSoundEffectTrack.SE2]:r[1],[i.FlipnoteSoundEffectTrack.SE3]:r[2],[i.FlipnoteSoundEffectTrack.SE4]:!1})))}getFrameSoundEffectFlags(r){f(r,0,this.frameCount-1,"Frame index"),this.seek(1696+this.frameDataLength+r);const n=this.readUint8();return{[i.FlipnoteSoundEffectTrack.SE1]:!!(1&n),[i.FlipnoteSoundEffectTrack.SE2]:!!(2&n),[i.FlipnoteSoundEffectTrack.SE3]:!!(4&n),[i.FlipnoteSoundEffectTrack.SE4]:!1}}getAudioTrackRaw(i){const r=this.soundMeta.get(i);return d(r.ptr+r.length<this.byteLength),this.seek(r.ptr),this.readBytes(r.length)}decodeAudioTrack(i){const r=this.getAudioTrackRaw(i),n=r.length,h=new Int16Array(2*n);let o=0,a=0,l=0,u=0,d=0,f=!0;for(;o<n;){l=f?15&r[o]:r[o++]>>4,f=!f;const i=U[u];let n=i>>3;1&l&&(n+=i>>2),2&l&&(n+=i>>1),4&l&&(n+=i),8&l&&(n=-n),d+=n,d=c(d,-32768,32767),u+=$[l],u=c(u,0,88),h[a++]=d}return h}getAudioTrackPcm(r,n=this.sampleRate){const h=this.decodeAudioTrack(r);let o=this.rawSampleRate;if(r===i.FlipnoteAudioTrack.BGM){const i=1/this.bgmrate/(1/this.framerate);o=this.rawSampleRate*i}return o!==n?((i,r,n)=>{const h=i.length,o=h/r*n,a=new Int16Array(o),l=r/n;for(let r=0;r<o;r++)a[r]=E(i,h,Math.floor(r*l));return a})(h,o,n):h}pcmAudioMix(i,r,n=0){const h=i.length,o=r.length;for(let a=0;a<h&&!(n+a>o);a++){const h=r[n+a]+i[a]/2;r[n+a]=c(h,-32768,32767)}}getAudioMasterPcm(r=this.sampleRate){const n=Math.ceil(this.duration*r),h=new Int16Array(n),o=this.hasAudioTrack(i.FlipnoteAudioTrack.BGM),a=this.hasAudioTrack(i.FlipnoteAudioTrack.SE1),l=this.hasAudioTrack(i.FlipnoteAudioTrack.SE2),c=this.hasAudioTrack(i.FlipnoteAudioTrack.SE3);if(o){const n=this.getAudioTrackPcm(i.FlipnoteAudioTrack.BGM,r);this.pcmAudioMix(n,h,0)}if(a||l||c){const n=r/this.framerate,o=a?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE1,r):null,u=l?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE2,r):null,d=c?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE3,r):null,f=this.decodeSoundFlags();for(let i=0;i<this.frameCount;i++){const r=Math.ceil(i*n),p=f[i];a&&p[0]&&this.pcmAudioMix(o,h,r),l&&p[1]&&this.pcmAudioMix(u,h,r),c&&p[2]&&this.pcmAudioMix(d,h,r)}}return this.audioClipRatio=T(h),h}getBody(){const i=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(0,i)}getSignature(){const i=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(i,i+128)}async verify(){const i=await j(Y,"SHA-1");return await W(i,this.getSignature(),this.getBody())}}G=Symbol.toStringTag,PpmParser.defaultSettings={},PpmParser.format=i.FlipnoteFormat.PPM,PpmParser.width=256,PpmParser.height=192,PpmParser.aspect=3/4,PpmParser.numLayers=2,PpmParser.numLayerColors=1,PpmParser.rawSampleRate=8192,PpmParser.sampleRate=32768,PpmParser.audioTracks=[i.FlipnoteAudioTrack.BGM,i.FlipnoteAudioTrack.SE1,i.FlipnoteAudioTrack.SE2,i.FlipnoteAudioTrack.SE3],PpmParser.soundEffectTracks=[i.FlipnoteSoundEffectTrack.SE1,i.FlipnoteSoundEffectTrack.SE2,i.FlipnoteSoundEffectTrack.SE3],PpmParser.globalPalette=[Q.WHITE,Q.BLACK,Q.RED,Q.BLUE],PpmParser.publicKey=Y;const J=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,X=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/,tt=["5f-fc67-437a-cafa01","2d-a4f9-e259-e9d603","fa-8705-1645-04f803","15-8900-e126-840604","d5-d59f-19c8-3e2a09","b8-41d4-1bba-568d0b","0b-d95a-9b5c-c7610e","35-3244-5ae3-94e414"],it=i=>J.test(i),st=i=>{if(X.test(i))return!0;for(let r of tt)if(i.endsWith(r))return!0;return!1},et=r=>{if(st(r))switch(r.charAt(19)){case"0":case"1":return i.FlipnoteRegion.JPN;case"5":return i.FlipnoteRegion.USA;case"9":return i.FlipnoteRegion.EUR;default:return i.FlipnoteRegion.UNKNOWN}return i.FlipnoteRegion.UNKNOWN};var rt;const nt=[.2,.5,1,2,4,6,8,12,20,24,30],ht={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},ot="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuv+zHAXXvbbtRqxADDeJ\nArX2b9RMxj3T+qpRg3FnIE/jeU3tj7eoDzsMduY+D/UT9CSnP+QHYY/vf0n5lqX9\ns6ljoZAmyUuruyj1e5Bg+fkDEu/yPEPQjqhbyywCyYL4TEAOJveopUBx9fdQxUJ6\nJ4J5oCE/Im1kFrlGW+puARiHmt3mmUyNzO8bI/Jx3cGSfoOHJG1foEaQsI5aaKqA\npBqxtzvwqMhudcZtAWSyRMBMlndvkRnVTDNTfTXLOYdHShCIgnKULCTH87uLBIP/\nnsmr4/bnQz8q2rp/HyVO+0yjR6mVr0NX5APJQ+6riJmGg3t3VOldhKP7aTHDUW+h\nkQIDAQAB\n-----END PUBLIC KEY-----",at=new Uint16Array(16);for(let i=0;i<16;i++)at[i]=(1<<i)-1;const lt=new Uint8Array(52488),ct=new Uint8Array(52488);var ut=0;for(let i=0;i<3;i++)for(let r=0;r<3;r++)for(let n=0;n<3;n++)for(let h=0;h<3;h++)for(let o=0;o<3;o++)for(let a=0;a<3;a++)for(let l=0;l<3;l++)for(let c=0;c<3;c++)lt.set([r,i,h,n,a,o,c,l],ut),ct.set([i,h,n,a,o,c,l,r],ut),ut+=8;const dt=new Uint8Array(256),ft=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach(((i,r)=>{const n=8*i,h=lt.subarray(n,n+8),o=ct.subarray(n,n+8);dt.set(h,8*r),ft.set(o,8*r)}));class KwzParser extends BaseParser{static matchBuffer(i){const r=new Uint8Array(i.slice(0,4)),n=r[0]<<24|r[1]<<16|r[2]<<8;return 1262897152===n||1263092480===n}constructor(r,n={}){super(r),this.format=i.FlipnoteFormat.KWZ,this[rt]="Flipnote Studio 3D KWZ animation file",this.imageWidth=KwzParser.width,this.imageHeight=KwzParser.height,this.aspect=KwzParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=KwzParser.numLayers,this.numLayerColors=KwzParser.numLayerColors,this.publicKey=KwzParser.publicKey,this.srcWidth=KwzParser.width,this.audioTracks=KwzParser.audioTracks,this.soundEffectTracks=KwzParser.soundEffectTracks,this.rawSampleRate=KwzParser.rawSampleRate,this.sampleRate=KwzParser.sampleRate,this.globalPalette=KwzParser.globalPalette,this.prevDecodedFrame=null,this.bitIndex=0,this.bitValue=0,this.settings={...KwzParser.defaultSettings,...n},this.layerBuffers=[new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height)],this.buildSectionMap(),this.sectionMap.has("KIC")?(this.isFolderIcon=!0,this.imageWidth=24,this.imageHeight=24,this.frameCount=1,this.frameSpeed=0,this.framerate=nt[0],this.thumbFrameIndex=0,this.getFrameOffsets()):this.sectionMap.has("KSN")?(this.decodeMeta(),this.getFrameOffsets(),this.decodeSoundHeader()):(this.isComment=!0,this.decodeMeta(),this.getFrameOffsets()),this.settings.dsiLibraryNote&&(this.isDsiLibraryNote=!0),this.settings.borderCrop&&(this.isDsiLibraryNote?(this.imageOffsetX=32,this.imageOffsetY=24,this.imageWidth=256,this.imageHeight=192):this.isFolderIcon||(this.imageOffsetX=5,this.imageOffsetY=5,this.imageWidth=310,this.imageHeight=230))}buildSectionMap(){const i=this.byteLength-256,r=new Map;let n=0,h=0;for(;h<i&&n<6;){this.seek(h);const i=this.readChars(4).substring(0,3),o=this.readUint32();r.set(i,{ptr:h,length:o}),h+=o+8,n+=1}this.bodyEndOffset=h,this.sectionMap=r,d(r.has("KMC")&&r.has("KMI"))}readBits(i){if(this.bitIndex+i>16){const i=this.readUint16();this.bitValue|=i<<16-this.bitIndex,this.bitIndex-=16}const r=this.bitValue&at[i];return this.bitValue>>=i,this.bitIndex+=i,r}readFsid(){if(this.settings.dsiLibraryNote)return this.readHex(10,!0).slice(2,18);const i=this.readHex(10);return`${i.slice(0,4)}-${i.slice(4,8)}-${i.slice(8,12)}-${i.slice(12,18)}`.toLowerCase()}readFilename(){const i=this.pointer,r=this.readChars(28);if(28===r.length)return r;this.seek(i);const n=this.readHex(3),h=this.readChars(13),o=this.readUint16().toString().padStart(3,"0");return this.seek(i+28),`${n}_${h}_${o}`}decodeMeta(){if(this.settings.quickMeta)return this.decodeMetaQuick();d(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);const i=K(this.readUint32()),r=K(this.readUint32());this.readUint32();const n=this.readFsid(),h=this.readFsid(),o=this.readFsid(),a=this.readWideChars(11),l=this.readWideChars(11),c=this.readWideChars(11),u=this.readFilename(),f=this.readFilename(),p=this.readFilename(),y=this.readUint16(),m=this.readUint16(),g=this.readUint16(),v=this.readUint8(),w=this.readUint8();this.isSpinoff=o!==h||o!==n,this.frameCount=y,this.frameSpeed=v,this.framerate=nt[v],this.duration=N(this.frameCount,this.framerate),this.thumbFrameIndex=m,this.layerVisibility={1:!(1&w),2:!(2&w),3:!(3&w)},this.meta={lock:!!(1&g),loop:!!(2&g),isSpinoff:this.isSpinoff,frameCount:y,frameSpeed:v,duration:this.duration,thumbIndex:m,timestamp:r,creationTimestamp:i,root:{username:a,fsid:n,region:et(n),filename:u,isDsiFilename:28!==u.length},parent:{username:l,fsid:h,region:et(h),filename:f,isDsiFilename:28!==f.length},current:{username:c,fsid:o,region:et(o),filename:p,isDsiFilename:28!==p.length}}}decodeMetaQuick(){d(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);const i=this.readUint16(),r=this.readUint16();this.readUint16();const n=this.readUint8(),h=this.readUint8();this.frameCount=i,this.thumbFrameIndex=r,this.frameSpeed=n,this.framerate=nt[n],this.duration=N(this.frameCount,this.framerate),this.layerVisibility={1:!(1&h),2:!(2&h),3:!(3&h)}}getFrameOffsets(){d(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));const i=this.frameCount,r=this.sectionMap.get("KMI"),n=this.sectionMap.get("KMC");d(r.length/28>=i);const h=new Uint32Array(i),o=new Uint32Array(i),a=[];let l=r.ptr+8,c=n.ptr+12;for(let r=0;r<i;r++){this.seek(l+4);const i=this.readUint16(),n=this.readUint16(),u=this.readUint16();h[r]=l,o[r]=c,l+=28,c+=i+n+u,d(l<this.byteLength,`frame${r} meta pointer out of bounds`),d(c<this.byteLength,`frame${r} data pointer out of bounds`),a.push([i,n,u])}this.frameMetaOffsets=h,this.frameDataOffsets=o,this.frameLayerSizes=a}decodeSoundHeader(){d(this.sectionMap.has("KSN"));let r=this.sectionMap.get("KSN").ptr+8;this.seek(r),this.bgmSpeed=this.readUint32(),d(this.bgmSpeed<=10),this.bgmrate=nt[this.bgmSpeed];const n=new Uint32Array(this.buffer,r+4,20),h=new Map;h.set(i.FlipnoteAudioTrack.BGM,{ptr:r+=28,length:n[0]}),h.set(i.FlipnoteAudioTrack.SE1,{ptr:r+=n[0],length:n[1]}),h.set(i.FlipnoteAudioTrack.SE2,{ptr:r+=n[1],length:n[2]}),h.set(i.FlipnoteAudioTrack.SE3,{ptr:r+=n[2],length:n[3]}),h.set(i.FlipnoteAudioTrack.SE4,{ptr:r+=n[3],length:n[4]}),this.soundMeta=h}getThumbnailImage(){d(this.sectionMap.has("KTN"),"KTN section missing - Note that folder icons and comments do not contain thumbnail data");const i=this.sectionMap.get("KTN");this.seek(i.ptr+12);const r=this.readBytes(i.length-12);return{format:h.Jpeg,width:80,height:64,data:r.buffer}}getFramePaletteIndices(i){f(i,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[i]);const r=this.readUint32();return[15&r,r>>8&15,r>>12&15,r>>16&15,r>>20&15,r>>24&15,r>>28&15]}getFramePalette(i){return f(i,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(i).map((i=>this.globalPalette[i]))}getFrameDiffingFlag(i){return f(i,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[i]),this.readUint32()>>4&7}getIsKeyFrame(i){const r=this.getFrameDiffingFlag(i);return[!(1&r),!(2&r),!(4&r)]}getFrameLayerDepths(i){return f(i,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[i]+20),[this.readUint8(),this.readUint8(),this.readUint8()]}getFrameAuthor(i){return f(i,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[i]+10),this.readFsid()}getFrameCameraFlags(i){this.seek(this.frameMetaOffsets[i]+26);const r=this.readUint8();return[!!(1&r),!!(2&r),!!(4&r)]}getFrameLayerOrder(i){f(i,0,this.frameCount-1,"Frame index");const r=this.getFrameLayerDepths(i);return[2,1,0].sort(((i,n)=>r[n]-r[i]))}decodeFrame(i,r=7,n=!1){if(f(i,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===i)return this.layerBuffers;this.prevDecodedFrame!==i-1&&0!==i&&(n&&(r&=~this.getFrameDiffingFlag(i+1)),0!==r&&this.decodeFrame(i-1,r,!0));let h=this.frameDataOffsets[i];const o=this.frameLayerSizes[i];for(let i=0;i<3&&(!this.settings.dsiLibraryNote||3!==i);i++){this.seek(h);let n=o[i];h+=n;const a=this.layerBuffers[i];if(38===n)continue;if(!(r>>i&1))continue;this.bitIndex=16,this.bitValue=0;let l=0;for(let i=0;i<240;i+=128)for(let r=0;r<320;r+=128)for(let n=0;n<128;n+=8){const h=i+n;if(h>=240)break;for(let i=0;i<128;i+=8){const n=r+i;if(n>=320)break;if(l>0){l-=1;continue}let o=h*KwzParser.width+n;const c=this.readBits(3);if(0===c){const i=8*this.readBits(5),r=dt.subarray(i,i+8);a.set(r,o),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320)}else if(1===c){const i=8*this.readBits(13),r=lt.subarray(i,i+8);a.set(r,o),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320)}else if(2===c){const i=8*this.readBits(5),r=dt.subarray(i,i+8),n=ft.subarray(i,i+8);a.set(r,o),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320)}else if(3===c){const i=8*this.readBits(13),r=lt.subarray(i,i+8),n=ct.subarray(i,i+8);a.set(r,o),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320)}else if(4===c){const i=this.readBits(8);for(let r=1;r<255;r<<=1){if(i&r){const i=8*this.readBits(5),r=dt.subarray(i,i+8);a.set(r,o)}else{const i=8*this.readBits(13),r=lt.subarray(i,i+8);a.set(r,o)}o+=320}}else{if(5===c){l=this.readBits(5);continue}if(7===c){let i,r,n=this.readBits(2);if(0!==this.readBits(1)){const h=8*this.readBits(5),o=8*this.readBits(5);i=dt.subarray(h,h+8),r=dt.subarray(o,o+8),n+=1}else{const n=8*this.readBits(13),h=8*this.readBits(13);i=lt.subarray(n,n+8),r=lt.subarray(h,h+8)}switch(n%4){case 0:a.set(i,o),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320);break;case 1:a.set(i,o),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(i,o+=320);break;case 2:a.set(i,o),a.set(r,o+=320),a.set(i,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(i,o+=320),a.set(r,o+=320);break;case 3:a.set(i,o),a.set(r,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320)}}}}}}return this.prevDecodedFrame=i,this.layerBuffers}decodeFrameSoundFlags(i){f(i,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[i]+23);const r=this.readUint8();return[!!(1&r),!!(2&r),!!(4&r),!!(8&r)]}decodeSoundFlags(){return void 0!==this.soundFlags||(this.soundFlags=new Array(this.frameCount).fill(!1).map(((i,r)=>this.decodeFrameSoundFlags(r)))),this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map((r=>({[i.FlipnoteSoundEffectTrack.SE1]:r[0],[i.FlipnoteSoundEffectTrack.SE2]:r[1],[i.FlipnoteSoundEffectTrack.SE3]:r[2],[i.FlipnoteSoundEffectTrack.SE4]:r[3]})))}getFrameSoundEffectFlags(r){const n=this.decodeFrameSoundFlags(r);return{[i.FlipnoteSoundEffectTrack.SE1]:n[0],[i.FlipnoteSoundEffectTrack.SE2]:n[1],[i.FlipnoteSoundEffectTrack.SE3]:n[2],[i.FlipnoteSoundEffectTrack.SE4]:n[3]}}getAudioTrackRaw(i){const r=this.soundMeta.get(i);return d(r.ptr+r.length<this.byteLength),new Uint8Array(this.buffer,r.ptr,r.length)}decodeAdpcm(i,r,n=0,h=0){const o=i.length;let a=0,l=0,u=0,d=0;for(let f=0;f<o;f++){let o=i[f],p=0;for(;p<8;)h<18||p>4?(l=3&o,u=U[h],d=u>>3,1&l&&(d+=u),2&l&&(d=-d),n+=d,h+=z[l],o>>=2,p+=2):(l=15&o,u=U[h],d=u>>3,1&l&&(d+=u>>2),2&l&&(d+=u>>1),4&l&&(d+=u),8&l&&(d=-d),n+=d,h+=$[l],o>>=4,p+=4),h=c(h,0,79),n=c(n,-2048,2047),r[a]=16*n,a+=1}return a}decodeAudioTrack(r){const n=this.settings,h=this.getAudioTrackRaw(r),o=60*this.rawSampleRate,a=new Int16Array(o);let l=0,c=40;if(this.isDsiLibraryNote)if(r===i.FlipnoteAudioTrack.BGM){let i=!0;if(null!==n.initialBgmPredictor&&(l=n.initialBgmPredictor,i=!1),null!==n.initialBgmStepIndex&&(c=n.initialBgmStepIndex,i=!1),i&&n.guessInitialBgmState){let i=4294967295,r=0;for(c=0;c<=40;c++){const n=this.decodeAdpcm(h,a,l,c),o=B(a.subarray(0,n));o<i&&(i=o,r=c)}c=r}}else{const i=this.soundEffectTracks.indexOf(r);Array.isArray(n.initialSePredictors)&&void 0!==n.initialSePredictors[i]&&(l=n.initialSePredictors[i]),Array.isArray(n.initialSeStepIndices)&&void 0!==n.initialSeStepIndices[i]&&(c=n.initialSeStepIndices[i])}const u=this.decodeAdpcm(h,a,l,c);return a.slice(0,u)}getAudioTrackPcm(r,n=this.sampleRate){const h=this.decodeAudioTrack(r);let o=this.rawSampleRate;if(r===i.FlipnoteAudioTrack.BGM){const i=1/this.bgmrate/(1/this.framerate);o=this.rawSampleRate*i}return o!==n?((i,r,n)=>{const h=i.length,o=h/r*n,a=new Int16Array(o),l=r/n;for(let r=0,n=0,c=0,d=0;r<o;r++)n=r*l,c=Math.floor(n),d=n%1,a[r]=u(E(i,h,c),E(i,h,c+1),d);return a})(h,o,n):h}pcmAudioMix(i,r,n=0){const h=i.length,o=r.length;for(let a=0;a<h&&!(n+a>o);a++){const h=r[n+a]+i[a];r[n+a]=c(h,-32768,32767)}}getAudioMasterPcm(r=this.sampleRate){const n=Math.ceil(this.duration*r),h=new Int16Array(n),o=this.hasAudioTrack(i.FlipnoteAudioTrack.BGM),a=this.hasAudioTrack(i.FlipnoteAudioTrack.SE1),l=this.hasAudioTrack(i.FlipnoteAudioTrack.SE2),c=this.hasAudioTrack(i.FlipnoteAudioTrack.SE3),u=this.hasAudioTrack(i.FlipnoteAudioTrack.SE4);if(o){const n=this.getAudioTrackPcm(i.FlipnoteAudioTrack.BGM,r);this.pcmAudioMix(n,h,0)}if(a||l||c||u){const n=r/this.framerate,o=a?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE1,r):null,d=l?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE2,r):null,f=c?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE3,r):null,p=u?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE4,r):null,y=this.decodeSoundFlags();for(let i=0;i<this.frameCount;i++){const r=y[i],m=Math.ceil(i*n);a&&r[0]&&this.pcmAudioMix(o,h,m),l&&r[1]&&this.pcmAudioMix(d,h,m),c&&r[2]&&this.pcmAudioMix(f,h,m),u&&r[3]&&this.pcmAudioMix(p,h,m)}}return this.audioClipRatio=T(h),h}getBody(){const i=this.bodyEndOffset;return this.bytes.subarray(0,i)}getSignature(){const i=this.bodyEndOffset;return this.bytes.subarray(i,i+256)}async verify(){const i=await j(ot,"SHA-256");return await W(i,this.getSignature(),this.getBody())}}rt=Symbol.toStringTag,KwzParser.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,guessInitialBgmState:!0,initialBgmPredictor:null,initialBgmStepIndex:null,initialSePredictors:null,initialSeStepIndices:null},KwzParser.format=i.FlipnoteFormat.KWZ,KwzParser.width=320,KwzParser.height=240,KwzParser.aspect=3/4,KwzParser.numLayers=3,KwzParser.numLayerColors=2,KwzParser.rawSampleRate=16364,KwzParser.sampleRate=32768,KwzParser.audioTracks=[i.FlipnoteAudioTrack.BGM,i.FlipnoteAudioTrack.SE1,i.FlipnoteAudioTrack.SE2,i.FlipnoteAudioTrack.SE3,i.FlipnoteAudioTrack.SE4],KwzParser.soundEffectTracks=[i.FlipnoteSoundEffectTrack.SE1,i.FlipnoteSoundEffectTrack.SE2,i.FlipnoteSoundEffectTrack.SE3,i.FlipnoteSoundEffectTrack.SE4],KwzParser.globalPalette=[ht.WHITE,ht.BLACK,ht.RED,ht.YELLOW,ht.GREEN,ht.BLUE,ht.NONE],KwzParser.publicKey=ot;const pt={name:"url",matches(i){return"string"==typeof i},async load(i){const r=await fetch(i);return d(r.status>=200&&r.status<300,`Failed to load Flipnote from URL, response failed with status ${r.status}`),await r.arrayBuffer()}},yt={name:"file",matches(i){return m&&"undefined"!=typeof File&&"undefined"!=typeof FileReader&&i instanceof File},async load(i){return i.arrayBuffer()}},mt={name:"blob",matches(i){return m&&"undefined"!=typeof Blob&&"undefined"!=typeof Response&&i instanceof Blob},async load(i){return i.arrayBuffer()}},gt={name:"node-buffer",matches(i){return v&&i instanceof Buffer},async load(i){return i.buffer}},vt={name:"array-buffer",matches(i){return i instanceof ArrayBuffer},async load(i){return i}},wt=new Map,bt=i=>{for(let[r,n]of wt)if(n.matches(i))try{return n.load(i)}catch(i){p(`Failed to load Flipnote from source, loader "${r}" failed with error ${p}`)}p("No loader available for source type")},At=i=>{wt.set(i.name,i)};At(pt),At(yt),At(mt),At(gt),At(vt);var Pt=Object.freeze({__proto__:null,loadSource:bt,registerLoader:At});const Ct=async(i,r)=>{const n=await bt(i);return PpmParser.matchBuffer(n)?new PpmParser(n,r):KwzParser.matchBuffer(n)?new KwzParser(n,r):void p("Could not identify source as a valid Flipnote file")},St=Ct;var _t;i.PlayerEvent=void 0,(_t=i.PlayerEvent||(i.PlayerEvent={})).i="any",_t.Play="play",_t.Pause="pause",_t.CanPlay="canplay",_t.CanPlayThrough="canplaythrough",_t.SeekStart="seeking",_t.SeekEnd="seeked",_t.Duration="durationchange",_t.Loop="loop",_t.Ended="ended",_t.VolumeChange="volumechange",_t.Progress="progress",_t.TimeUpdate="timeupdate",_t.FrameUpdate="frameupdate",_t.FrameNext="framenext",_t.FramePrev="frameprev",_t.FrameFirst="framefirst",_t.FrameLast="framelast",_t.Ready="ready",_t.Load="load",_t.LoadStart="loadstart",_t.LoadedData="loadeddata",_t.LoadedMeta="loadedmetadata",_t.Emptied="emptied",_t.Close="close",_t.Error="error",_t.Destroy="destroy";const xt=[i.PlayerEvent.Play,i.PlayerEvent.Pause,i.PlayerEvent.CanPlay,i.PlayerEvent.CanPlayThrough,i.PlayerEvent.SeekStart,i.PlayerEvent.SeekEnd,i.PlayerEvent.Duration,i.PlayerEvent.Loop,i.PlayerEvent.Ended,i.PlayerEvent.VolumeChange,i.PlayerEvent.Progress,i.PlayerEvent.TimeUpdate,i.PlayerEvent.FrameUpdate,i.PlayerEvent.FrameNext,i.PlayerEvent.FramePrev,i.PlayerEvent.FrameFirst,i.PlayerEvent.FrameLast,i.PlayerEvent.Ready,i.PlayerEvent.Load,i.PlayerEvent.LoadStart,i.PlayerEvent.LoadedData,i.PlayerEvent.LoadedMeta,i.PlayerEvent.Emptied,i.PlayerEvent.Close,i.PlayerEvent.Error],Ft=i=>({length:i.length,start:r=>i[r][0],end:r=>i[r][1]}),zt=(i,r)=>i.toString().padStart(r,"0"),$t=i=>{const r=Math.floor(i%3600/60),n=Math.floor(i%60);return`${r}:${zt(n,2)}`};var Ut;!function(i){i[i.None=0]="None",i[i.Dual=1]="Dual",i[i.Anaglyph=2]="Anaglyph"}(Ut||(Ut={}));const Et=5120,Mt=5121,It=5122,Lt=5123,Tt=5124,kt=5125,Bt=5126,Kt={};{const i=Kt;i[Et]=Int8Array,i[Mt]=Uint8Array,i[It]=Int16Array,i[Lt]=Uint16Array,i[Tt]=Int32Array,i[kt]=Uint32Array,i[Bt]=Float32Array,i[32819]=Uint16Array,i[32820]=Uint16Array,i[33635]=Uint16Array,i[5131]=Uint16Array,i[33640]=Uint32Array,i[35899]=Uint32Array,i[35902]=Uint32Array,i[36269]=Uint32Array,i[34042]=Uint32Array}function Nt(i){if(i instanceof Int8Array)return Et;if(i instanceof Uint8Array)return Mt;if(i instanceof Uint8ClampedArray)return Mt;if(i instanceof Int16Array)return It;if(i instanceof Uint16Array)return Lt;if(i instanceof Int32Array)return Tt;if(i instanceof Uint32Array)return kt;if(i instanceof Float32Array)return Bt;throw new Error("unsupported typed array type")}function Rt(i){if(i===Int8Array)return Et;if(i===Uint8Array)return Mt;if(i===Uint8ClampedArray)return Mt;if(i===Int16Array)return It;if(i===Uint16Array)return Lt;if(i===Int32Array)return Tt;if(i===Uint32Array)return kt;if(i===Float32Array)return Bt;throw new Error("unsupported typed array type")}const Dt="undefined"!=typeof SharedArrayBuffer?function(i){return i&&i.buffer&&(i.buffer instanceof ArrayBuffer||i.buffer instanceof SharedArrayBuffer)}:function(i){return i&&i.buffer&&i.buffer instanceof ArrayBuffer},Ot=new Map;function jt(i,r){if(!i||"object"!=typeof i)return!1;let n=Ot.get(r);n||(n=new WeakMap,Ot.set(r,n));let h=n.get(i);if(void 0===h){const o=Object.prototype.toString.call(i);h=o.substring(8,o.length-1)===r,n.set(i,h)}return h}function Wt(i,r){return"undefined"!=typeof WebGLTexture&&jt(r,"WebGLTexture")}const Ht=35044,Gt=34962,Vt=5126,Zt="";function Qt(i,r,n,h){if(function(i,r){return"undefined"!=typeof WebGLBuffer&&jt(r,"WebGLBuffer")}(0,r))return r;n=n||Gt;const o=i.createBuffer();return function(i,r,n,h,o){i.bindBuffer(r,n),i.bufferData(r,h,o||Ht)}(i,n,o,r,h),o}function qt(i){return"indices"===i}const Yt=/coord|texture/i,Jt=/color|colour/i;function Xt(i,r){if(Dt(i))return i;if(Dt(i.data))return i.data;Array.isArray(i)&&(i={data:i});let n=i.type?ti(i.type):void 0;return n||(n=qt(r)?Uint16Array:Float32Array),new n(i.data)}function ti(i){return"number"==typeof i?function(i){const r=Kt[i];if(!r)throw new Error("unknown gl type");return r}(i):i||Float32Array}function ii(i,r){return{buffer:r.buffer,numValues:24,type:(n=r.type,"number"==typeof n?n:n?Rt(n):Vt),arrayType:ti(r.type)};var n}function si(i,r){const n=r.data||r,h=ti(r.type),o=n*h.BYTES_PER_ELEMENT,a=i.createBuffer();return i.bindBuffer(Gt,a),i.bufferData(Gt,o,r.drawType||Ht),{buffer:a,numValues:n,type:Rt(h),arrayType:h}}function ei(i,r,n){const h=Xt(r,n);return{arrayType:h.constructor,buffer:Qt(i,h,void 0,r.drawType),type:Nt(h),numValues:0}}function ri(i,r){const n={};return Object.keys(r).forEach((function(h){if(!qt(h)){const a=r[h],l=a.attrib||a.name||a.attribName||Zt+h;if(a.value){if(!Array.isArray(a.value)&&!Dt(a.value))throw new Error("array.value is not array or typedarray");n[l]={value:a.value}}else{let r;r=a.buffer&&a.buffer instanceof WebGLBuffer?ii:"number"==typeof a||"number"==typeof a.data?si:ei;const{buffer:c,type:u,numValues:d,arrayType:f}=r(i,a,h),p=void 0!==a.normalize?a.normalize:(o=f)===Int8Array||o===Uint8Array,y=function(i,r,n){return i.numComponents||i.size||function(i,r){let n;if(n=Yt.test(i)?2:Jt.test(i)?4:3,r%n>0)throw new Error(`Can not guess numComponents for attribute '${i}'. Tried ${n} but ${r} values is not evenly divisible by ${n}. You should specify it.`);return n}(r,n||function(i){return i.length?i:i.data}(i).length)}(a,h,d);n[l]={buffer:c,numComponents:y,type:u,normalize:p,stride:a.stride||0,offset:a.offset||0,divisor:void 0===a.divisor?void 0:a.divisor,drawType:a.drawType}}}var o})),i.bindBuffer(Gt,null),n}const ni=["position","positions","a_position"];function hi(i){return!!i.texStorage2D}const oi=33984,ai=34962,li=5124,ci=3553,ui=34067,di=32879,fi=35866,pi={};function yi(i,r){return pi[r].bindPoint}function mi(i,r){return function(n){i.uniform1i(r,n)}}function gi(i,r){return function(n){i.uniform1iv(r,n)}}function vi(i,r){return function(n){i.uniform2iv(r,n)}}function wi(i,r){return function(n){i.uniform3iv(r,n)}}function bi(i,r){return function(n){i.uniform4iv(r,n)}}function Ai(i,r,n,h){const o=yi(0,r);return hi(i)?function(r){let a,l;!r||Wt(0,r)?(a=r,l=null):(a=r.texture,l=r.sampler),i.uniform1i(h,n),i.activeTexture(oi+n),i.bindTexture(o,a),i.bindSampler(n,l)}:function(r){i.uniform1i(h,n),i.activeTexture(oi+n),i.bindTexture(o,r)}}function Pi(i,r,n,h,o){const a=yi(0,r),l=new Int32Array(o);for(let i=0;i<o;++i)l[i]=n+i;return hi(i)?function(r){i.uniform1iv(h,l),r.forEach((function(r,h){let o,c;i.activeTexture(oi+l[h]),!r||Wt(0,r)?(o=r,c=null):(o=r.texture,c=r.sampler),i.bindSampler(n,c),i.bindTexture(a,o)}))}:function(r){i.uniform1iv(h,l),r.forEach((function(r,n){i.activeTexture(oi+l[n]),i.bindTexture(a,r)}))}}function Ci(i,r){return function(n){if(n.value)switch(i.disableVertexAttribArray(r),n.value.length){case 4:i.vertexAttrib4fv(r,n.value);break;case 3:i.vertexAttrib3fv(r,n.value);break;case 2:i.vertexAttrib2fv(r,n.value);break;case 1:i.vertexAttrib1fv(r,n.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else i.bindBuffer(ai,n.buffer),i.enableVertexAttribArray(r),i.vertexAttribPointer(r,n.numComponents||n.size,n.type||5126,n.normalize||!1,n.stride||0,n.offset||0),i.vertexAttribDivisor&&i.vertexAttribDivisor(r,n.divisor||0)}}function Si(i,r){return function(n){if(n.value){if(i.disableVertexAttribArray(r),4!==n.value.length)throw new Error("The length of an integer constant value must be 4!");i.vertexAttrib4iv(r,n.value)}else i.bindBuffer(ai,n.buffer),i.enableVertexAttribArray(r),i.vertexAttribIPointer(r,n.numComponents||n.size,n.type||li,n.stride||0,n.offset||0),i.vertexAttribDivisor&&i.vertexAttribDivisor(r,n.divisor||0)}}function _i(i,r){return function(n){if(n.value){if(i.disableVertexAttribArray(r),4!==n.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");i.vertexAttrib4uiv(r,n.value)}else i.bindBuffer(ai,n.buffer),i.enableVertexAttribArray(r),i.vertexAttribIPointer(r,n.numComponents||n.size,n.type||5125,n.stride||0,n.offset||0),i.vertexAttribDivisor&&i.vertexAttribDivisor(r,n.divisor||0)}}function xi(i,r,n){const h=n.size,o=n.count;return function(n){i.bindBuffer(ai,n.buffer);const a=n.size||n.numComponents||h,l=a/o,c=n.type||5126,u=pi[c].size*a,d=n.normalize||!1,f=n.offset||0,p=u/o;for(let h=0;h<o;++h)i.enableVertexAttribArray(r+h),i.vertexAttribPointer(r+h,l,c,d,u,f+p*h),i.vertexAttribDivisor&&i.vertexAttribDivisor(r+h,n.divisor||0)}}pi[5126]={Type:Float32Array,size:4,setter:(i,r)=>function(n){i.uniform1f(r,n)},arraySetter:(i,r)=>function(n){i.uniform1fv(r,n)}},pi[35664]={Type:Float32Array,size:8,setter:(i,r)=>function(n){i.uniform2fv(r,n)},cols:2},pi[35665]={Type:Float32Array,size:12,setter:(i,r)=>function(n){i.uniform3fv(r,n)},cols:3},pi[35666]={Type:Float32Array,size:16,setter:(i,r)=>function(n){i.uniform4fv(r,n)},cols:4},pi[li]={Type:Int32Array,size:4,setter:mi,arraySetter:gi},pi[35667]={Type:Int32Array,size:8,setter:vi,cols:2},pi[35668]={Type:Int32Array,size:12,setter:wi,cols:3},pi[35669]={Type:Int32Array,size:16,setter:bi,cols:4},pi[5125]={Type:Uint32Array,size:4,setter:(i,r)=>function(n){i.uniform1ui(r,n)},arraySetter:(i,r)=>function(n){i.uniform1uiv(r,n)}},pi[36294]={Type:Uint32Array,size:8,setter:(i,r)=>function(n){i.uniform2uiv(r,n)},cols:2},pi[36295]={Type:Uint32Array,size:12,setter:(i,r)=>function(n){i.uniform3uiv(r,n)},cols:3},pi[36296]={Type:Uint32Array,size:16,setter:(i,r)=>function(n){i.uniform4uiv(r,n)},cols:4},pi[35670]={Type:Uint32Array,size:4,setter:mi,arraySetter:gi},pi[35671]={Type:Uint32Array,size:8,setter:vi,cols:2},pi[35672]={Type:Uint32Array,size:12,setter:wi,cols:3},pi[35673]={Type:Uint32Array,size:16,setter:bi,cols:4},pi[35674]={Type:Float32Array,size:32,setter:(i,r)=>function(n){i.uniformMatrix2fv(r,!1,n)},rows:2,cols:2},pi[35675]={Type:Float32Array,size:48,setter:(i,r)=>function(n){i.uniformMatrix3fv(r,!1,n)},rows:3,cols:3},pi[35676]={Type:Float32Array,size:64,setter:(i,r)=>function(n){i.uniformMatrix4fv(r,!1,n)},rows:4,cols:4},pi[35685]={Type:Float32Array,size:32,setter:(i,r)=>function(n){i.uniformMatrix2x3fv(r,!1,n)},rows:2,cols:3},pi[35686]={Type:Float32Array,size:32,setter:(i,r)=>function(n){i.uniformMatrix2x4fv(r,!1,n)},rows:2,cols:4},pi[35687]={Type:Float32Array,size:48,setter:(i,r)=>function(n){i.uniformMatrix3x2fv(r,!1,n)},rows:3,cols:2},pi[35688]={Type:Float32Array,size:48,setter:(i,r)=>function(n){i.uniformMatrix3x4fv(r,!1,n)},rows:3,cols:4},pi[35689]={Type:Float32Array,size:64,setter:(i,r)=>function(n){i.uniformMatrix4x2fv(r,!1,n)},rows:4,cols:2},pi[35690]={Type:Float32Array,size:64,setter:(i,r)=>function(n){i.uniformMatrix4x3fv(r,!1,n)},rows:4,cols:3},pi[35678]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:ci},pi[35680]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:ui},pi[35679]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:di},pi[35682]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:ci},pi[36289]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:fi},pi[36292]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:fi},pi[36293]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:ui},pi[36298]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:ci},pi[36299]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:di},pi[36300]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:ui},pi[36303]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:fi},pi[36306]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:ci},pi[36307]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:di},pi[36308]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:ui},pi[36311]={Type:null,size:0,setter:Ai,arraySetter:Pi,bindPoint:fi};const Fi={};function zi(i){const r=i.name;return r.startsWith("gl_")||r.startsWith("webgl_")}Fi[5126]={size:4,setter:Ci},Fi[35664]={size:8,setter:Ci},Fi[35665]={size:12,setter:Ci},Fi[35666]={size:16,setter:Ci},Fi[li]={size:4,setter:Si},Fi[35667]={size:8,setter:Si},Fi[35668]={size:12,setter:Si},Fi[35669]={size:16,setter:Si},Fi[5125]={size:4,setter:_i},Fi[36294]={size:8,setter:_i},Fi[36295]={size:12,setter:_i},Fi[36296]={size:16,setter:_i},Fi[35670]={size:4,setter:Si},Fi[35671]={size:8,setter:Si},Fi[35672]={size:12,setter:Si},Fi[35673]={size:16,setter:Si},Fi[35674]={size:4,setter:xi,count:2},Fi[35675]={size:9,setter:xi,count:3},Fi[35676]={size:16,setter:xi,count:4};const $i=/(\.|\[|]|\w+)/g,Ui=i=>i>="0"&&i<="9";function Ei(i,r,n,h){const o=i.split($i).filter((i=>""!==i));let a=0,l="";for(;;){const i=o[a++];l+=i;const c=Ui(i[0]),u=c?parseInt(i):i;if(c&&(l+=o[a++]),a===o.length){n[u]=r;break}{const i=o[a++],r="["===i,c=n[u]||(r?[]:{});n[u]=c,n=c,h[l]=h[l]||function(i){return function(r){Mi(i,r)}}(c),l+=i}}}function Mi(i,r){for(const n in r){const h=i[n];"function"==typeof h?h(r[n]):Mi(i[n],r[n])}}function Ii(i,...r){const n=i.uniformSetters||i,h=r.length;for(let i=0;i<h;++i){const h=r[i];if(Array.isArray(h)){const i=h.length;for(let r=0;r<i;++r)Ii(n,h[r])}else for(const i in h){const r=n[i];r&&r(h[i])}}}class WebglCanvas{static isSupported(){if(!m)return!1;let i=document.createElement("canvas"),r=i.getContext("2d");const n=null!==r;return i=null,r=null,n}constructor(i,r=640,n=480,h={}){this.supportedStereoscopeModes=[Ut.None,Ut.Dual],this.stereoscopeMode=Ut.None,this.stereoscopeStrength=0,this.paletteBuffer=new Uint32Array(16),this.textureTypes=new Map,this.textureSizes=new Map,this.frameBufferTextures=new Map,this.applyFirefoxFix=!1,this.refs={programs:[],shaders:[],textures:[],buffers:[],frameBuffers:[]},this.isCtxLost=!1,this.handleContextLoss=i=>{this.destroy(),i&&i.preventDefault(),this.isCtxLost||this.options.onlost(),this.isCtxLost=!0},this.handleContextRestored=i=>{this.isCtxLost=!1,this.init(),this.options.onrestored()},g(),this.options={...WebglCanvas.defaultOptions,...h},this.width=r,this.height=n,this.canvas=document.createElement("canvas"),this.canvas.addEventListener("webglcontextlost",this.handleContextLoss,!1),this.canvas.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--webgl",this.gl=this.canvas.getContext("webgl",{antialias:!1,alpha:!0}),i&&i.appendChild(this.canvas),this.init()}init(){this.setCanvasSize(this.width,this.height);const i=this.gl;if(this.checkContextLoss())return;this.layerProgram=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_uv;uniform bool u_flipY;uniform vec2 u_textureSize;uniform int u_3d_eye;uniform float u_3d_depth;uniform float u_3d_strength;void main(){vec4 pos=position;float depthDirection=u_3d_eye==0 ?-1.0 : 1.0;float depthShift=floor(u_3d_depth*u_3d_strength)/(u_textureSize.x/2.0)*depthDirection;pos.x+=depthShift;pos.y*=u_flipY ?-1.0 : 1.0;v_uv=texcoord;gl_Position=pos;}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;uniform int u_3d_mode;void main(){vec4 col=texture2D(u_tex,v_uv);if(col.a==0.0){discard;}gl_FragColor=col;}"),this.upscaleProgram=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,1,1),this.setBuffersAndAttribs(this.layerProgram,this.quadBuffer),this.layerTexture=this.createTexture(i.RGBA,i.LINEAR,i.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(i.RGBA,i.LINEAR,i.CLAMP_TO_EDGE),this.frameBuffer=this.createFramebuffer(this.frameTexture);const r=i.getExtension("WEBGL_debug_renderer_info"),n=i.getParameter(r.UNMASKED_RENDERER_WEBGL),h=navigator.userAgent,o=h.includes("Firefox")&&h.includes("Mac");this.applyFirefoxFix=o&&n.includes("Apple M")}createProgram(i,r){if(this.checkContextLoss())return;const n=this.gl,h=this.createShader(n.VERTEX_SHADER,i),o=this.createShader(n.FRAGMENT_SHADER,r),a=n.createProgram();if(n.attachShader(a,h),n.attachShader(a,o),n.linkProgram(a),!n.getProgramParameter(a,n.LINK_STATUS)){const i=n.getProgramInfoLog(a);throw n.deleteProgram(a),new Error(i)}const l=function(i,r){const n=function(i,r){let n=0;function h(r,h,o){const a=h.name.endsWith("[0]"),l=h.type,c=pi[l];if(!c)throw new Error(`unknown type: 0x${l.toString(16)}`);let u;if(c.bindPoint){const r=n;n+=h.size,u=a?c.arraySetter(i,l,r,o,h.size):c.setter(i,l,r,o,h.size)}else u=c.arraySetter&&a?c.arraySetter(i,o):c.setter(i,o);return u.location=o,u}const o={},a={},l=i.getProgramParameter(r,35718);for(let n=0;n<l;++n){const l=i.getActiveUniform(r,n);if(zi(l))continue;let c=l.name;c.endsWith("[0]")&&(c=c.substr(0,c.length-3));const u=i.getUniformLocation(r,l.name);if(u){const i=h(0,l,u);o[c]=i,Ei(c,i,a,o)}}return o}(i,r),h=function(i,r){const n={},h=i.getProgramParameter(r,35721);for(let o=0;o<h;++o){const h=i.getActiveAttrib(r,o);if(zi(h))continue;const a=i.getAttribLocation(r,h.name),l=Fi[h.type],c=l.setter(i,a,l);c.location=a,n[h.name]=c}return n}(i,r),o={program:r,uniformSetters:n,attribSetters:h};return hi(i)&&(o.uniformBlockSpec=function(i,r){const n=i.getProgramParameter(r,35718),h=[],o=[];for(let a=0;a<n;++a){o.push(a),h.push({});const n=i.getActiveUniform(r,a);h[a].name=n.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(n){const a=n[0],l=n[1];i.getActiveUniforms(r,o,i[a]).forEach((function(i,r){h[r][l]=i}))}));const a={},l=i.getProgramParameter(r,35382);for(let n=0;n<l;++n){const h=i.getActiveUniformBlockName(r,n),o={index:i.getUniformBlockIndex(r,h),usedByVertexShader:i.getActiveUniformBlockParameter(r,n,35396),usedByFragmentShader:i.getActiveUniformBlockParameter(r,n,35398),size:i.getActiveUniformBlockParameter(r,n,35392),uniformIndices:i.getActiveUniformBlockParameter(r,n,35395)};o.used=o.usedByVertexShader||o.usedByFragmentShader,a[h]=o}return{blockSpecs:a,uniformData:h}}(i,r),o.transformFeedbackInfo=function(i,r){const n={},h=i.getProgramParameter(r,35971);for(let o=0;o<h;++o){const h=i.getTransformFeedbackVarying(r,o);n[h.name]={index:o,type:h.type,size:h.size}}return n}(i,r)),o}(n,a);return this.refs.programs.push(a),l}createShader(i,r){if(this.checkContextLoss())return;const n=this.gl,h=n.createShader(i);if(n.shaderSource(h,r),n.compileShader(h),!n.getShaderParameter(h,n.COMPILE_STATUS)){const i=n.getShaderInfoLog(h);throw n.deleteShader(h),new Error(i)}return this.refs.shaders.push(h),h}createScreenQuad(i,r,n,h,o,a){if(this.checkContextLoss())return;const l=(o+1)*(a+1),c=o+1,u=new Float32Array(2*l),d=new Float32Array(2*l);let f=0,p=0;for(let l=0;l<=a;l++)for(let c=0;c<=o;c++){const y=c/o,m=l/a;u[f++]=i+n*y,u[f++]=r+h*m,d[p++]=y,d[p++]=m}const y=new Uint16Array(o*a*2*3);let m=0;for(let i=0;i<a;i++)for(let r=0;r<o;r++)y[m++]=(i+0)*c+r,y[m++]=(i+1)*c+r,y[m++]=(i+0)*c+r+1,y[m++]=(i+0)*c+r+1,y[m++]=(i+1)*c+r,y[m++]=(i+1)*c+r+1;const g=function(i,r,n){const h=ri(i,r),o=Object.assign({},{});o.attribs=Object.assign({},{},h);const a=r.indices;if(a){const r=Xt(a,"indices");o.indices=Qt(i,r,34963),o.numElements=r.length,o.elementType=Nt(r)}else o.numElements||(o.numElements=function(i,r){let n,h;for(h=0;h<ni.length&&(n=ni[h],!(n in r))&&(n=Zt+n,!(n in r));++h);h===ni.length&&(n=Object.keys(r)[0]);const o=r[n];if(!o.buffer)return 1;i.bindBuffer(Gt,o.buffer);const a=i.getBufferParameter(Gt,34660);var l;i.bindBuffer(Gt,null);const c=a/(5120===(l=o.type)||5121===l?1:5122===l||5123===l?2:5124===l||5125===l||l===Vt?4:0),u=o.numComponents||o.size,d=c/u;if(d%1!=0)throw new Error(`numComponents ${u} not correct for length ${length}`);return d}(i,o.attribs));return o}(this.gl,{position:{numComponents:2,data:u},texcoord:{numComponents:2,data:d},indices:y});for(let i in g.attribs)this.refs.buffers.push(g.attribs[i].buffer);return g}setBuffersAndAttribs(i,r){var n,h,o;this.checkContextLoss()||(n=this.gl,h=i.attribSetters,(o=r).vertexArrayObject?n.bindVertexArray(o.vertexArrayObject):(function(i,r){for(const n in r){const h=i[n];h&&h(r[n])}}(h.attribSetters||h,o.attribs),o.indices&&n.bindBuffer(34963,o.indices)))}createTexture(i,r,n,h=1,o=1){if(this.checkContextLoss())return;const a=this.gl,l=a.createTexture();return a.bindTexture(a.TEXTURE_2D,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,r),a.texImage2D(a.TEXTURE_2D,0,i,h,o,0,i,a.UNSIGNED_BYTE,null),this.refs.textures.push(l),this.textureTypes.set(l,i),this.textureSizes.set(l,{width:h,height:o}),l}resizeTexture(i,r,n){if(this.checkContextLoss())return;const h=this.gl,o=this.textureTypes.get(i);h.bindTexture(h.TEXTURE_2D,i),h.texImage2D(h.TEXTURE_2D,0,o,r,n,0,o,h.UNSIGNED_BYTE,null),this.textureSizes.set(i,{width:r,height:n})}createFramebuffer(i){if(this.checkContextLoss())return;const r=this.gl,n=r.createFramebuffer();return r.bindFramebuffer(r.FRAMEBUFFER,n),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,i,0),this.refs.frameBuffers.push(n),this.frameBufferTextures.set(n,i),n}useFramebuffer(i,r,n,h,o){if(this.checkContextLoss())return;const a=this.gl;if(null===i){if(a.bindFramebuffer(a.FRAMEBUFFER,null),this.applyFirefoxFix){const i=this.srcWidth,l=this.srcHeight,c=a.drawingBufferWidth/i,u=a.drawingBufferHeight/l,d=256===i?1:0;r=-((h=a.drawingBufferWidth*(c-d))-i*c),n=-((o=a.drawingBufferHeight*(u-d))-l*u)}a.viewport(r??0,n??0,h??a.drawingBufferWidth,o??a.drawingBufferHeight)}else{const l=this.frameBufferTextures.get(i),{width:c,height:u}=this.textureSizes.get(l);a.bindFramebuffer(a.FRAMEBUFFER,i),a.viewport(r??0,n??0,h??c,o??u)}}resizeFramebuffer(i,r,n){if(this.checkContextLoss())return;const h=this.frameBufferTextures.get(i);this.resizeTexture(h,r,n)}setCanvasSize(i,r){const n=this.options.useDpi&&window.devicePixelRatio||1,h=i*n,o=r*n;this.width=i,this.height=r,this.canvas.width=h,this.canvas.height=o,this.dstWidth=h,this.dstHeight=o,this.canvas.style.width=`${i}px`,this.canvas.style.height=`${r}px`,this.checkContextLoss()}setNote(i){if(this.checkContextLoss())return;const r=i.imageWidth,n=i.imageHeight;this.note=i,this.srcWidth=r,this.srcHeight=n,this.resizeFramebuffer(this.frameBuffer,r,n),this.resizeTexture(this.layerTexture,r,n),this.layerTexturePixelBuffer=new Uint32Array(r*n),this.layerTexturePixels=new Uint8Array(this.layerTexturePixelBuffer.buffer),this.frameIndex=void 0,this.canvas.title=i.getTitle()}clear(i){if(this.checkContextLoss())return;const r=this.gl,n=i??this.note.getFramePalette(this.frameIndex)[0],[h,o,a,l]=n;r.clearColor(h/255,o/255,a/255,l/255),r.clear(r.COLOR_BUFFER_BIT)}drawFrame(i){if(this.checkContextLoss())return;const r=this.gl,n=this.stereoscopeMode,h=this.stereoscopeStrength;this.frameIndex=i,n===Ut.None?(this.drawLayers(i),this.useFramebuffer(null),this.upscale(r.drawingBufferWidth,r.drawingBufferHeight)):n===Ut.Dual&&(this.drawLayers(i,h,o.Left),this.useFramebuffer(null,0,0,r.drawingBufferWidth/2,r.drawingBufferHeight),this.upscale(r.drawingBufferWidth/2,r.drawingBufferHeight),this.drawLayers(i,h,o.Right),this.useFramebuffer(null,r.drawingBufferWidth/2,0,r.drawingBufferWidth/2,r.drawingBufferHeight),this.upscale(r.drawingBufferWidth/2,r.drawingBufferHeight))}upscale(i,r){if(this.checkContextLoss())return;const n=this.gl;n.useProgram(this.upscaleProgram.program),Ii(this.upscaleProgram,{u_tex:this.frameTexture,u_textureSize:[this.srcWidth,this.srcHeight],u_screenSize:[i,r]}),n.drawElements(n.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}requestStereoScopeMode(i){this.supportedStereoscopeModes.includes(i)?this.stereoscopeMode=i:this.stereoscopeMode=Ut.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}isErrorState(){const i=this.gl;return null===i||i.getError()!==i.NO_ERROR}drawLayers(i,r=0,n=o.Left,h=!0){const a=this.gl,l=this.note,c=this.srcWidth,u=this.srcHeight,d=l.numLayers,f=l.getFrameLayerOrder(i),p=l.getFrameLayerDepths(i);this.useFramebuffer(this.frameBuffer),h&&this.clear(),a.useProgram(this.layerProgram.program);for(let h=0;h<d;h++){const o=f[h];l.getLayerPixelsRgba(i,o,this.layerTexturePixelBuffer,this.paletteBuffer),Ii(this.layerProgram,{u_flipY:!0,u_tex:this.layerTexture,u_textureSize:[c,u],u_3d_mode:this.stereoscopeMode,u_3d_eye:n,u_3d_depth:p[o],u_3d_strength:r}),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,c,u,0,a.RGBA,a.UNSIGNED_BYTE,this.layerTexturePixels),a.drawElements(a.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}}checkContextLoss(){const i=this.isCtxLost||this.isErrorState();return i&&this.handleContextLoss(),i}getDataUrl(i,r){return this.canvas.toDataURL(i,r)}async getBlob(i,r){return new Promise(((n,h)=>this.canvas.toBlob(n,i,r)))}destroy(){const i=this.refs,r=this.gl,n=this.canvas;i.shaders.forEach((i=>{r.deleteShader(i)})),i.shaders=[],i.textures.forEach((i=>{r.deleteTexture(i)})),i.textures=[],i.buffers.forEach((i=>{r.deleteBuffer(i)})),i.buffers=[],i.frameBuffers.forEach((i=>{r.deleteFramebuffer(i)})),i.frameBuffers=[],i.programs.forEach((i=>{r.deleteProgram(i)})),i.programs=[],this.paletteBuffer=null,this.layerTexturePixelBuffer=null,this.layerTexturePixels=null,this.textureTypes.clear(),this.textureSizes.clear(),this.frameBufferTextures.clear(),n&&n.parentElement&&(n.width=1,n.height=1,n.parentNode.removeChild(n))}}WebglCanvas.defaultOptions={onlost(){},onrestored(){},useDpi:!0};class Html5Canvas{static isSupported(){if(!m)return!1;let i=document.createElement("canvas"),r=i.getContext("2d");const n=null!==r;return i=null,r=null,n}constructor(i,r,n,h={}){this.supportedStereoscopeModes=[Ut.None],this.stereoscopeMode=Ut.None,this.stereoscopeStrength=0,this.paletteBuffer=new Uint32Array(16),g(),this.options={...Html5Canvas.defaultOptions,...h},this.width=r,this.height=n,this.canvas=document.createElement("canvas"),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--html5",this.ctx=this.canvas.getContext("2d"),this.srcCanvas=document.createElement("canvas"),this.srcCtx=this.srcCanvas.getContext("2d"),d(null!==this.ctx&&null!==this.srcCtx,"Could not create HTML5 canvas"),i&&i.appendChild(this.canvas),this.setCanvasSize(r,n)}setCanvasSize(i,r){const n=this.canvas,h=this.options.useDpi&&window.devicePixelRatio||1,o=i*h,a=r*h;this.width=i,this.height=r,this.dstWidth=o,this.dstHeight=a,n.style.width=`${i}px`,n.style.height=`${r}px`,n.width=o,n.height=a}setNote(i){const r=i.imageWidth,n=i.imageHeight;this.note=i,this.srcWidth=r,this.srcHeight=n,this.srcCanvas.width=r,this.srcCanvas.height=n,this.frameImage=this.srcCtx.createImageData(r,n),this.frameBuffer=new Uint32Array(this.frameImage.data.buffer),this.frameIndex=void 0,this.canvas.title=i.getTitle()}clear(i){if(this.frameBuffer.fill(0),this.ctx.clearRect(0,0,this.dstWidth,this.dstHeight),i){const[r,n,h,o]=i;this.ctx.fillStyle=`rgba(${r}, ${n}, ${h}, ${o})`,this.ctx.fillRect(0,0,this.dstWidth,this.dstHeight)}}drawFrame(i){this.clear(),this.options.useSmoothing||(this.ctx.imageSmoothingEnabled=!1),this.note.getFramePixelsRgba(i,this.frameBuffer,this.paletteBuffer),this.srcCtx.putImageData(this.frameImage,0,0),this.ctx.drawImage(this.srcCanvas,0,0,this.srcWidth,this.srcHeight,0,0,this.dstWidth,this.dstHeight),this.frameIndex=i}requestStereoScopeMode(i){this.supportedStereoscopeModes.includes(i)?this.stereoscopeMode=i:this.stereoscopeMode=Ut.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}getDataUrl(i,r){return this.canvas.toDataURL(i,r)}async getBlob(i,r){return new Promise(((n,h)=>this.canvas.toBlob(n,i,r)))}destroy(){this.frameImage=null,this.paletteBuffer=null,this.frameBuffer=null,this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null,this.srcCanvas.width=1,this.srcCanvas.height=1,this.srcCanvas=null}}Html5Canvas.defaultOptions={useDpi:!0,useSmoothing:!0};class UniversalCanvas{constructor(i,r=640,n=480,h={}){this.isReady=!1,this.isHtml5=!1,this.supportedStereoscopeModes=[],this.stereoscopeMode=Ut.None,this.stereoscopeStrength=1,this.rendererStack=[WebglCanvas,Html5Canvas],this.rendererStackIdx=0,this.options={},this.width=r,this.height=n,this.parent=i,this.options=h,this.setSubRenderer(this.rendererStack[0])}setSubRenderer(i){let r=!1;const n=new i(this.parent,this.width,this.height,{...this.options,onlost:()=>{r=!0,this.fallbackIfPossible()}});r||(this.note&&(n.setNote(this.note),n.frameIndex=this.renderer?.frameIndex,n.forceUpdate()),this.renderer&&this.renderer.destroy(),this.isHtml5=n instanceof Html5Canvas,this.isReady=!0,this.renderer=n,this.rendererStackIdx=this.rendererStack.indexOf(i),this.supportedStereoscopeModes=n.supportedStereoscopeModes,n.stereoscopeStrength=this.stereoscopeStrength,this.requestStereoScopeMode(this.stereoscopeMode))}fallbackIfPossible(){if(this.rendererStackIdx>=this.rendererStack.length)throw new Error("No renderer to fall back to");this.rendererStackIdx+=1,this.setSubRenderer(this.rendererStack[this.rendererStackIdx])}switchToHtml5(){this.setSubRenderer(Html5Canvas)}setCanvasSize(i,r){const n=this.renderer;n.setCanvasSize(i,r),this.width=i,this.width=r,this.dstWidth=n.dstWidth,this.dstHeight=n.dstHeight}setNote(i){this.note=i,this.renderer.setNote(i),this.frameIndex=void 0,this.srcWidth=this.renderer.srcWidth,this.srcHeight=this.renderer.srcHeight}clear(i){this.renderer.clear(i)}drawFrame(i){this.renderer.drawFrame(i),this.frameIndex=i}forceUpdate(){this.renderer.forceUpdate()}requestStereoScopeMode(i){this.renderer.requestStereoScopeMode(i),this.stereoscopeMode=this.renderer.stereoscopeMode}getDataUrl(i,r){return this.renderer.getDataUrl()}async getBlob(i,r){return this.renderer.getBlob()}destroy(){this.renderer.destroy(),this.note=null}}const Li=m?window.AudioContext||window.webkitAudioContext:null;class WebAudioPlayer{constructor(){this.useEq=!1,this.useAnalyser=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this.m=1,this.v=!1,this.A=0,this.C=0,this.nodeRefs=[],g()}set volume(i){this.setVolume(i)}get volume(){return this.m}set loop(i){this.v=i,this.source&&(this.source.loop=i)}get loop(){return this.v}getCtx(){return this.ctx||(this.ctx=new Li),this.ctx}setBuffer(i,r){const n=this.getCtx(),h=i.length,o=n.createBuffer(1,h,r),a=o.getChannelData(0);if(i instanceof Float32Array)a.set(i,0);else if(i instanceof Int16Array)for(let r=0;r<h;r++)a[r]=i[r]/32768;this.buffer=o,this.sampleRate=r}connectEqNodesTo(i){const r=this.getCtx(),n=this.eqSettings;let h=i;return n.forEach((([i,o],a)=>{const l=r.createBiquadFilter();this.nodeRefs.push(l),l.frequency.value=i,l.gain.value=o,0===a?l.type="lowshelf":a===n.length-1?l.type="highshelf":l.type="peaking",h.connect(l),h=l})),h}initNodes(){const i=this.getCtx();this.nodeRefs=[];const r=i.createBufferSource();this.nodeRefs.push(r),r.buffer=this.buffer;const n=i.createGain();if(this.nodeRefs.push(n),this.useEq?this.connectEqNodesTo(r).connect(n):r.connect(n),this.useAnalyser){const r=i.createAnalyser();this.nodeRefs.push(r),this.analyser=r,n.connect(r),r.connect(i.destination)}else this.analyser=void 0,n.connect(i.destination);this.source=r,this.gainNode=n,this.setVolume(this.m)}setAnalyserEnabled(i){this.useAnalyser=i,this.initNodes()}setVolume(i){this.m=i,this.gainNode&&(this.gainNode.gain.value=Math.pow(i,2))}playFrom(i){this.initNodes(),this.A=i,this.C=this.ctx.currentTime,this.source.loop=this.v,this.source.start(0,i)}stop(){this.source&&this.source.stop(0)}getCurrentTime(){return this.A+(this.ctx.currentTime-this.C)}async destroy(){this.stop();const i=this.getCtx();this.nodeRefs.forEach((i=>i.disconnect())),this.nodeRefs=[],this.analyser=void 0,"closed"!==i.state&&"function"==typeof i.close&&await i.close(),this.buffer=null}}class Player{constructor(r,n,h,o={}){this.duration=0,this.autoplay=!1,this.supportedEvents=xt,this._=null,this.v=!1,this.m=1,this.F=!1,this.U=null,this.M=!1,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=r=>{if(!this.isPlaying)return;const n=r/1e3,h=this.duration,o=this.audio.getCurrentTime();let a=n-this.playbackStartTime;if(Math.abs(a%h-o%h)>.01&&(a=o),a>=h){if(!this.loop)return this.pause(),this.M=!0,void this.emit(i.PlayerEvent.Ended);this.playbackStartTime=n,this.emit(i.PlayerEvent.Loop)}this.setCurrentTime(a%h),this.playbackLoopId=requestAnimationFrame(this.playbackLoop)},g();const a="string"==typeof r?document.querySelector(r):r;this.parserSettings=o,this.renderer=new UniversalCanvas(a,n,h,{onlost:()=>this.emit(i.PlayerEvent.Error),onrestored:()=>this.reload()}),this.audio=new WebAudioPlayer,this.el=a}get src(){return this._}set src(i){throw new Error("Setting a Player source has been deprecated, please use the load() method instead")}get paused(){return!this.isPlaying}set paused(i){i?this.pause():this.play()}get currentFrame(){return this.U}set currentFrame(i){this.setCurrentFrame(i)}get currentTime(){return this.isNoteLoaded?this.playbackTime:null}set currentTime(i){this.setCurrentTime(i)}get progress(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null}set progress(i){this.setProgress(i)}get volume(){return this.getVolume()}set volume(i){this.setVolume(i)}get muted(){return this.getMuted()}set muted(i){this.setMuted(i)}get loop(){return this.getLoop()}set loop(i){this.setLoop(i)}get framerate(){return this.note.framerate}get frameCount(){return this.note.frameCount}get frameSpeed(){return this.note.frameSpeed}get buffered(){return Ft([[0,this.duration]])}get seekable(){return Ft([[0,this.duration]])}get currentSrc(){return this._}get videoWidth(){return this.isNoteLoaded?this.note.imageWidth:0}get videoHeight(){return this.isNoteLoaded?this.note.imageHeight:0}async load(r){if(this.isNoteLoaded&&this.closeNote(),this._=r,!r)return this.openNote(this.note);this.emit(i.PlayerEvent.LoadStart);const[n,h]=await(async i=>{try{return[null,await i().catch((i=>{throw i}))]}catch(i){return[i,null]}})((()=>St(r,this.parserSettings)));if(n)throw this.emit(i.PlayerEvent.Error,n),new Error(`Error loading Flipnote: ${n.message}`);this.openNote(h)}async reload(){if(this.note)return await this.load(this.note.buffer)}async updateSettings(i){return this.parserSettings=i,await this.reload()}closeNote(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this._=null,this.U=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clear()}openNote(r){this.isNoteLoaded&&this.closeNote(),this.note=r,this.meta=r.meta,this.emit(i.PlayerEvent.LoadedMeta),this.noteFormat=r.format,this.duration=r.duration,this.playbackTime=0,this.U=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=r.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(r.getAudioMasterPcm(),r.sampleRate),this.emit(i.PlayerEvent.CanPlay),this.emit(i.PlayerEvent.CanPlayThrough),this.setLoop(r.meta.loop),this.renderer.setNote(r),this.drawFrame(r.thumbFrameIndex),this.emit(i.PlayerEvent.LoadedData),this.emit(i.PlayerEvent.Load),this.emit(i.PlayerEvent.Ready),this.autoplay&&this.play()}setCurrentTime(r){this.assertNoteLoaded();const n=Math.floor(r/(1/this.framerate));this.setCurrentFrame(n),this.playbackTime=r,this.emit(i.PlayerEvent.Progress,this.progress)}getCurrentTime(){return this.currentTime}getTimeCounter(){return`${$t(Math.max(this.currentTime,0))} / ${$t(this.duration)}`}getFrameCounter(){return`${zt(this.currentFrame+1,3)} / ${zt(this.frameCount,3)}`}setProgress(i){this.assertNoteLoaded(),f(i,0,100,"progress"),this.currentTime=this.duration*(i/100)}getProgress(){return this.progress}async play(){if(this.assertNoteLoaded(),this.isPlaying)return;this.M&&(this.playbackTime=0,this.M=!1);const r=performance.now();this.playbackStartTime=r/1e3-this.playbackTime,this.isPlaying=!0,this.hasPlaybackStarted=!0,this.playAudio(),this.playbackLoop(r),this.emit(i.PlayerEvent.Play)}pause(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(i.PlayerEvent.Pause))}togglePlay(){this.isPlaying?this.pause():this.play()}getPaused(){return!this.isPlaying}getDuration(){return this.duration}getLoop(){return this.v}setLoop(i){this.v=i,this.audio.loop=i}toggleLoop(){this.setLoop(!this.v)}setCurrentFrame(r){this.assertNoteLoaded();const n=Math.max(0,Math.min(Math.floor(r),this.frameCount-1));(n!==this.currentFrame||this.showThumbnail)&&(this.U=n,this.drawFrame(n),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=n*(1/this.framerate),this.emit(i.PlayerEvent.SeekEnd)),this.emit(i.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(i.PlayerEvent.Progress,this.progress),this.emit(i.PlayerEvent.TimeUpdate,this.currentFrame))}nextFrame(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(i.PlayerEvent.FrameNext)}prevFrame(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(i.PlayerEvent.FramePrev)}lastFrame(){this.currentFrame=this.frameCount-1,this.emit(i.PlayerEvent.FrameLast)}firstFrame(){this.currentFrame=0,this.emit(i.PlayerEvent.FrameFirst)}thumbnailFrame(){this.currentFrame=this.note.thumbFrameIndex}startSeek(){this.isSeeking||(this.emit(i.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)}seek(i){this.isSeeking&&(this.progress=100*i)}endSeek(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1}drawFrame(i){this.renderer.drawFrame(i)}forceUpdate(){this.renderer.forceUpdate()}resize(i,r){r!==.75*i&&console.warn(`Canvas width to height ratio should be 3:4 for best results (got ${i}x${r})`),this.renderer.setCanvasSize(i,r),this.forceUpdate()}setLayerVisibility(i,r){this.note.layerVisibility[i]=r,this.layerVisibility[i]=r,this.forceUpdate()}getLayerVisibility(i){return this.layerVisibility[i]}toggleLayerVisibility(i){this.setLayerVisibility(i,!this.layerVisibility[i])}playAudio(){this.audio.playFrom(this.currentTime)}stopAudio(){this.audio.stop()}toggleAudioEq(){this.setAudioEq(!this.audio.useEq)}setAudioEq(i){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=i,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())}mute(){this.setMuted(!0)}unmute(){this.setMuted(!1)}setMuted(r){this.audio.volume=r?0:this.m,this.F=r,this.emit(i.PlayerEvent.VolumeChange,this.audio.volume)}getMuted(){return 0===this.volume||this.F}toggleMuted(){this.setMuted(!this.F)}setVolume(r){f(r,0,1,"volume"),this.m=r,this.audio.volume=r,this.emit(i.PlayerEvent.VolumeChange,this.audio.volume)}getVolume(){return this.F?0:this.m}seekToNextFrame(){this.nextFrame()}fastSeek(i){this.currentTime=i}canPlayType(i){switch(i){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";default:return""}}getVideoPlaybackQuality(){return{creationTime:0,droppedVideoFrames:0,corruptedVideoFrames:0,totalVideoFrames:this.frameCount}}requestPictureInPicture(){throw new Error("Not implemented")}captureStream(){throw new Error("Not implemented")}on(i,r){const n=this.events;(Array.isArray(i)?i:[i]).forEach((i=>{n.has(i)?n.get(i).push(r):n.set(i,[r])}))}off(i,r){const n=this.events;(Array.isArray(i)?i:[i]).forEach((i=>{if(!n.has(i))return;const h=n.get(i);n.set(i,h.splice(h.indexOf(r),1))}))}emit(r,...n){const h=this.events;if(r!==i.PlayerEvent.i&&h.has(r)){h.get(r).forEach((i=>i.apply(null,n)));const i=`on${r}`,o=this;"function"==typeof o[i]&&o[i].apply(null,n)}h.has(i.PlayerEvent.i)&&h.get(i.PlayerEvent.i).forEach((i=>i.apply(null,[r,...n])))}clearEvents(){this.events.clear()}async destroy(){this.clearEvents(),this.emit(i.PlayerEvent.Destroy),this.closeNote(),await this.renderer.destroy(),await this.audio.destroy()}supports(i){const r=this.supportedEvents.includes(i),n="function"==typeof this[i];return r||n}assertNoteLoaded(){d(this.isNoteLoaded,"No Flipnote is currently loaded in this player")}}function Ti(i){class PlayerMixinClass extends i{get renderer(){return this.player.renderer}get audio(){return this.player.audio}get canvasEl(){return this.player.canvasEl}get note(){return this.player.note}get noteFormat(){return this.player.noteFormat}get meta(){return this.player.meta}get duration(){return this.player.duration}get layerVisibility(){return this.player.layerVisibility}get autoplay(){return this.player.autoplay}set autoplay(i){this.player.autoplay=i}}for(let r of Reflect.ownKeys(Player.prototype)){let n=Object.getOwnPropertyDescriptor(Player.prototype,r);r in i.prototype||"constructor"===r||"name"===r||"prototype"===r||(n.value&&"function"==typeof n.value?Object.defineProperty(PlayerMixinClass.prototype,r,{...n,value(...i){return this.player[r](...i)}}):(n.get||n.set)&&Object.defineProperty(PlayerMixinClass.prototype,r,{...n,set(i){this.player[r]=i},get(){return this.player[r]}}))}return PlayerMixinClass}class EncoderBase{constructor(){this.dataUrl=null}getBuffer(){return d(v,"This feature is only available in NodeJS environments"),Buffer.from(this.getArrayBuffer())}getBlob(){return g(),new Blob([this.getArrayBuffer()],{type:this.mimeType})}getUrl(){return g(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())}revokeUrl(){g(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)}}const ki=5003,Bi=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];class LzwCompressor{constructor(i,r,n){this.accum=new Uint8Array(256),this.htab=new Int32Array(ki),this.codetab=new Int32Array(ki),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=i,this.height=r,this.colorDepth=n,this.reset()}reset(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}char_out(i,r){this.accum[this.a_count++]=i,this.a_count>=254&&this.flush_char(r)}cl_block(i){this.cl_hash(ki),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,i)}cl_hash(i){for(var r=0;r<i;++r)this.htab[r]=-1}compress(i,r){var n,h,o,a,l,c,u;for(this.g_init_bits=i,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<i-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,a=this.nextPixel(),u=0,n=ki;n<65536;n*=2)++u;u=8-u,c=ki,this.cl_hash(c),this.output(this.ClearCode,r);t:for(;-1!=(h=this.nextPixel());)if(n=(h<<12)+a,o=h<<u^a,this.htab[o]!==n){if(this.htab[o]>=0){l=c-o,0===o&&(l=1);do{if((o-=l)<0&&(o+=c),this.htab[o]===n){a=this.codetab[o];continue t}}while(this.htab[o]>=0)}this.output(a,r),a=h,this.free_ent<4096?(this.codetab[o]=this.free_ent++,this.htab[o]=n):this.cl_block(r)}else a=this.codetab[o];this.output(a,r),this.output(this.EOFCode,r)}encode(i,r){this.pixels=i,r.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,r),r.writeByte(0)}flush_char(i){this.a_count>0&&(i.writeByte(this.a_count),i.writeBytes(this.accum,0,this.a_count),this.a_count=0)}get_maxcode(i){return(1<<i)-1}nextPixel(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}output(i,r){for(this.cur_accum&=Bi[this.cur_bits],this.cur_bits>0?this.cur_accum|=i<<this.cur_bits:this.cur_accum=i,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,r),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),i==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,r),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(r)}}}class GifImage extends EncoderBase{constructor(i,r,n={}){super(),this.mimeType="gif/image",this.frameCount=0,this.width=i,this.height=r,this.data=new ByteArray,this.settings={...GifImage.defaultSettings,...n},this.compressor=new LzwCompressor(i,r,n.colorDepth)}static fromFlipnote(i,r={}){const n=new GifImage(i.imageWidth,i.imageHeight,{delay:100/i.framerate,repeat:i.meta?.loop?-1:0,...r});n.palette=i.globalPalette;for(let r=0;r<i.frameCount;r++)n.writeFrame(i.getFramePixels(r));return n.finish(),n}static fromFlipnoteFrame(i,r,n={}){const h=new GifImage(i.imageWidth,i.imageHeight,{delay:0,repeat:0,...n});return h.palette=i.globalPalette,h.writeFrame(i.getFramePixels(r)),h.finish(),h}writeFrame(i){0===this.frameCount?this.writeFirstFrame(i):this.writeAdditionalFrame(i),this.frameCount+=1}finish(){this.data.writeByte(59)}writeFirstFrame(i){this.writeHeader(),this.writeLogicalScreenDescriptor(),this.writeColorTable(),this.writeNetscapeExt(),this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(i)}writeAdditionalFrame(i){this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(i)}writeHeader(){this.data.writeChars("GIF89a")}writeGraphicControlExt(){this.data.writeByte(33),this.data.writeByte(249),this.data.writeByte(4),this.data.writeByte(0),this.data.writeU16(this.settings.delay),this.data.writeByte(0),this.data.writeByte(0)}writeLogicalScreenDescriptor(){const i=this.palette,r=128|this.settings.colorDepth-1<<4|this.colorTableSize(i.length)-1;this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeBytes([r,0,0])}writeNetscapeExt(){this.data.writeByte(33),this.data.writeByte(255),this.data.writeByte(11),this.data.writeChars("NETSCAPE2.0"),this.data.writeByte(3),this.data.writeByte(1),this.data.writeU16(this.settings.repeat),this.data.writeByte(0)}writeColorTable(){const i=this.palette,r=1<<this.colorTableSize(i.length);for(let n=0;n<r;n++){let r=[0,0,0];n<i.length&&(r=i[n]),this.data.writeByte(r[0]),this.data.writeByte(r[1]),this.data.writeByte(r[2])}}writeImageDescriptor(){this.data.writeByte(44),this.data.writeU16(0),this.data.writeU16(0),this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeByte(0)}colorTableSize(i){return Math.max(Math.ceil(Math.log2(i)),1)}writePixels(i){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(i,this.data)}getArrayBuffer(){return this.data.getBuffer()}getImage(){g();const i=new Image(this.width,this.height);return i.src=this.getUrl(),i}}GifImage.defaultSettings={delay:100,repeat:-1,colorDepth:8};class WavAudio extends EncoderBase{constructor(i,r=1,n=16){super(),this.sampleRate=i,this.channels=r,this.bitsPerSample=n;const h=new ArrayBuffer(44),o=new DataStream(h);o.writeChars("RIFF"),o.writeUint32(0),o.writeChars("WAVE"),o.writeChars("fmt "),o.writeUint32(16),o.writeUint16(1),o.writeUint16(this.channels),o.writeUint32(this.sampleRate),o.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),o.writeUint16(this.bitsPerSample*this.channels/8),o.writeUint16(this.bitsPerSample),o.writeChars("data"),o.writeUint32(0),this.header=o,this.pcmData=null}static fromFlipnote(i){const r=i.sampleRate,n=new WavAudio(r,1,16),h=i.getAudioMasterPcm(r);return n.writeSamples(h),n}static fromFlipnoteTrack(i,r){const n=i.sampleRate,h=new WavAudio(n,1,16),o=i.getAudioTrackPcm(r,n);return h.writeSamples(o),h}writeSamples(i){let r=this.header;r.seek(4),r.writeUint32(r.byteLength+i.byteLength),r.seek(40),r.writeUint32(i.byteLength),this.pcmData=i}getArrayBuffer(){const i=this.header.bytes,r=new Uint8Array(this.pcmData.buffer),n=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return n.set(i),n.set(r,i.byteLength),n.buffer}}const Ki=i=>x(i)?`${i.slice(14,16)}-${i.slice(12,14)}${i.slice(10,12)}-${i.slice(8,10)}${i.slice(6,8)}-${i.slice(4,6)}${i.slice(2,4)}${i.slice(0,2)}`.toLocaleLowerCase():null,Ni=i=>st(i)?`${i.slice(19,21)}${i.slice(17,19)}${i.slice(15,17)}${i.slice(12,14)}${i.slice(10,12)}${i.slice(7,9)}${i.slice(5,7)}${i.slice(2,4)}`.toUpperCase():null;var Ri=Object.freeze({__proto__:null,getFsidRegion:r=>x(r)?F(r):it(r)?et(r):i.FlipnoteRegion.UNKNOWN,getKwzFsidRegion:et,getPpmFsidRegion:F,isFsid:i=>x(i)||it(i),isKwzDsiLibraryFsid:st,isKwzFsid:it,isPpmFsid:x,kwzFsidMatchesPpmFsid:(i,r)=>Ni(i)===r,kwzFsidToPpmFsid:Ni,ppmFsidToKwzFsidSuffix:Ki,ppmFsidToPossibleKwzFsids(i){const r=Ki(i);return r?["00"+r,"10"+r,"12"+r,"14"+r]:null}});function Di(i,r,n,h){var o,a=arguments.length,l=a<3?r:null===h?h=Object.getOwnPropertyDescriptor(r,n):h;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(i,r,n,h);else for(var c=i.length-1;c>=0;c--)(o=i[c])&&(l=(a<3?o(l):a>3?o(r,n,l):o(r,n))||l);return a>3&&l&&Object.defineProperty(r,n,l),l}"function"==typeof SuppressedError&&SuppressedError;const Oi=globalThis,ji=Oi.ShadowRoot&&(void 0===Oi.ShadyCSS||Oi.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,Wi=Symbol(),Hi=new WeakMap;let Gi=class{constructor(i,r,n){if(this.I=!0,n!==Wi)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=i,this.t=r}get styleSheet(){let i=this.o;const r=this.t;if(ji&&void 0===i){const n=void 0!==r&&1===r.length;n&&(i=Hi.get(r)),void 0===i&&((this.o=i=new CSSStyleSheet).replaceSync(this.cssText),n&&Hi.set(r,i))}return i}toString(){return this.cssText}};const Vi=(i,...r)=>{const n=1===i.length?i[0]:r.reduce(((r,n,h)=>r+(i=>{if(!0===i.I)return i.cssText;if("number"==typeof i)return i;throw Error("Value passed to 'css' function must be a 'css' function result: "+i+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(n)+i[h+1]),i[0]);return new Gi(n,i,Wi)},Zi=ji?i=>i:i=>i instanceof CSSStyleSheet?(i=>{let r="";for(const n of i.cssRules)r+=n.cssText;return(i=>new Gi("string"==typeof i?i:i+"",void 0,Wi))(r)})(i):i,{is:Qi,defineProperty:qi,getOwnPropertyDescriptor:Yi,getOwnPropertyNames:Ji,getOwnPropertySymbols:Xi,getPrototypeOf:ts}=Object,is=globalThis,ss=is.trustedTypes,es=ss?ss.emptyScript:"",rs=is.reactiveElementPolyfillSupport,ns=(i,r)=>i,hs={toAttribute(i,r){switch(r){case Boolean:i=i?es:null;break;case Object:case Array:i=null==i?i:JSON.stringify(i)}return i},fromAttribute(i,r){let n=i;switch(r){case Boolean:n=null!==i;break;case Number:n=null===i?null:Number(i);break;case Object:case Array:try{n=JSON.parse(i)}catch(i){n=null}}return n}},os=(i,r)=>!Qi(i,r),as={attribute:!0,type:String,converter:hs,reflect:!1,hasChanged:os};Symbol.metadata??=Symbol("metadata"),is.litPropertyMetadata??=new WeakMap;class b extends HTMLElement{static addInitializer(i){this.L(),(this.l??=[]).push(i)}static get observedAttributes(){return this.finalize(),this.B&&[...this.B.keys()]}static createProperty(i,r=as){if(r.state&&(r.attribute=!1),this.L(),this.elementProperties.set(i,r),!r.noAccessor){const n=Symbol(),h=this.getPropertyDescriptor(i,n,r);void 0!==h&&qi(this.prototype,i,h)}}static getPropertyDescriptor(i,r,n){const{get:h,set:o}=Yi(this.prototype,i)??{get(){return this[r]},set(i){this[r]=i}};return{get(){return h?.call(this)},set(r){const a=h?.call(this);o.call(this,r),this.requestUpdate(i,a,n)},configurable:!0,enumerable:!0}}static getPropertyOptions(i){return this.elementProperties.get(i)??as}static L(){if(this.hasOwnProperty(ns("elementProperties")))return;const i=ts(this);i.finalize(),void 0!==i.l&&(this.l=[...i.l]),this.elementProperties=new Map(i.elementProperties)}static finalize(){if(this.hasOwnProperty(ns("finalized")))return;if(this.finalized=!0,this.L(),this.hasOwnProperty(ns("properties"))){const i=this.properties,r=[...Ji(i),...Xi(i)];for(const n of r)this.createProperty(n,i[n])}const i=this[Symbol.metadata];if(null!==i){const r=litPropertyMetadata.get(i);if(void 0!==r)for(const[i,n]of r)this.elementProperties.set(i,n)}this.B=new Map;for(const[i,r]of this.elementProperties){const n=this.K(i,r);void 0!==n&&this.B.set(n,i)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(i){const r=[];if(Array.isArray(i)){const n=new Set(i.flat(1/0).reverse());for(const i of n)r.unshift(Zi(i))}else void 0!==i&&r.push(Zi(i));return r}static K(i,r){const n=r.attribute;return!1===n?void 0:"string"==typeof n?n:"string"==typeof i?i.toLowerCase():void 0}constructor(){super(),this.N=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this.R=null,this.D()}D(){this.O=new Promise((i=>this.enableUpdating=i)),this.W=new Map,this.H(),this.requestUpdate(),this.constructor.l?.forEach((i=>i(this)))}addController(i){(this.G??=new Set).add(i),void 0!==this.renderRoot&&this.isConnected&&i.hostConnected?.()}removeController(i){this.G?.delete(i)}H(){const i=new Map,r=this.constructor.elementProperties;for(const n of r.keys())this.hasOwnProperty(n)&&(i.set(n,this[n]),delete this[n]);i.size>0&&(this.N=i)}createRenderRoot(){const i=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return((i,r)=>{if(ji)i.adoptedStyleSheets=r.map((i=>i instanceof CSSStyleSheet?i:i.styleSheet));else for(const n of r){const r=document.createElement("style"),h=Oi.litNonce;void 0!==h&&r.setAttribute("nonce",h),r.textContent=n.cssText,i.appendChild(r)}})(i,this.constructor.elementStyles),i}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this.G?.forEach((i=>i.hostConnected?.()))}enableUpdating(i){}disconnectedCallback(){this.G?.forEach((i=>i.hostDisconnected?.()))}attributeChangedCallback(i,r,n){this.V(i,n)}Z(i,r){const n=this.constructor.elementProperties.get(i),h=this.constructor.K(i,n);if(void 0!==h&&!0===n.reflect){const o=(void 0!==n.converter?.toAttribute?n.converter:hs).toAttribute(r,n.type);this.R=i,null==o?this.removeAttribute(h):this.setAttribute(h,o),this.R=null}}V(i,r){const n=this.constructor,h=n.B.get(i);if(void 0!==h&&this.R!==h){const i=n.getPropertyOptions(h),o="function"==typeof i.converter?{fromAttribute:i.converter}:void 0!==i.converter?.fromAttribute?i.converter:hs;this.R=h,this[h]=o.fromAttribute(r,i.type),this.R=null}}requestUpdate(i,r,n){if(void 0!==i){if(n??=this.constructor.getPropertyOptions(i),!(n.hasChanged??os)(this[i],r))return;this.P(i,r,n)}!1===this.isUpdatePending&&(this.O=this.q())}P(i,r,n){this.W.has(i)||this.W.set(i,r),!0===n.reflect&&this.R!==i&&(this.Y??=new Set).add(i)}async q(){this.isUpdatePending=!0;try{await this.O}catch(i){Promise.reject(i)}const i=this.scheduleUpdate();return null!=i&&await i,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this.N){for(const[i,r]of this.N)this[i]=r;this.N=void 0}const i=this.constructor.elementProperties;if(i.size>0)for(const[r,n]of i)!0!==n.wrapped||this.W.has(r)||void 0===this[r]||this.P(r,this[r],n)}let i=!1;const r=this.W;try{i=this.shouldUpdate(r),i?(this.willUpdate(r),this.G?.forEach((i=>i.hostUpdate?.())),this.update(r)):this.J()}catch(r){throw i=!1,this.J(),r}i&&this.X(r)}willUpdate(i){}X(i){this.G?.forEach((i=>i.hostUpdated?.())),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(i)),this.updated(i)}J(){this.W=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this.O}shouldUpdate(i){return!0}update(i){this.Y&&=this.Y.forEach((i=>this.Z(i,this[i]))),this.J()}updated(i){}firstUpdated(i){}}b.elementStyles=[],b.shadowRootOptions={mode:"open"},b[ns("elementProperties")]=new Map,b[ns("finalized")]=new Map,rs?.({ReactiveElement:b}),(is.reactiveElementVersions??=[]).push("2.0.4");const ls=globalThis,cs=ls.trustedTypes,us=cs?cs.createPolicy("lit-html",{createHTML:i=>i}):void 0,ds="$lit$",fs=`lit$${Math.random().toFixed(9).slice(2)}$`,ps="?"+fs,ys=`<${ps}>`,ms=document,gs=()=>ms.createComment(""),vs=i=>null===i||"object"!=typeof i&&"function"!=typeof i,ws=Array.isArray,bs="[ \t\n\f\r]",As=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,Ps=/-->/g,Cs=/>/g,Ss=RegExp(`>|${bs}(?:([^\\s"'>=/]+)(${bs}*=${bs}*(?:[^ \t\n\f\r"'\`<>=]|("|')|))|$)`,"g"),_s=/'/g,xs=/"/g,Fs=/^(?:script|style|textarea|title)$/i,zs=(i,...r)=>({tt:1,strings:i,values:r}),$s=Symbol.for("lit-noChange"),Us=Symbol.for("lit-nothing"),Es=new WeakMap,Ms=ms.createTreeWalker(ms,129);function Is(i,r){if(!Array.isArray(i)||!i.hasOwnProperty("raw"))throw Error("invalid template strings array");return void 0!==us?us.createHTML(r):r}const Ls=(i,r)=>{const n=i.length-1,h=[];let o,a=2===r?"<svg>":"",l=As;for(let r=0;r<n;r++){const n=i[r];let c,u,d=-1,f=0;for(;f<n.length&&(l.lastIndex=f,u=l.exec(n),null!==u);)f=l.lastIndex,l===As?"!--"===u[1]?l=Ps:void 0!==u[1]?l=Cs:void 0!==u[2]?(Fs.test(u[2])&&(o=RegExp("</"+u[2],"g")),l=Ss):void 0!==u[3]&&(l=Ss):l===Ss?">"===u[0]?(l=o??As,d=-1):void 0===u[1]?d=-2:(d=l.lastIndex-u[2].length,c=u[1],l=void 0===u[3]?Ss:'"'===u[3]?xs:_s):l===xs||l===_s?l=Ss:l===Ps||l===Cs?l=As:(l=Ss,o=void 0);const p=l===Ss&&i[r+1].startsWith("/>")?" ":"";a+=l===As?n+ys:d>=0?(h.push(c),n.slice(0,d)+ds+n.slice(d)+fs+p):n+fs+(-2===d?r:p)}return[Is(i,a+(i[n]||"<?>")+(2===r?"</svg>":"")),h]};class V{constructor({strings:i,tt:r},n){let h;this.parts=[];let o=0,a=0;const l=i.length-1,c=this.parts,[u,d]=Ls(i,r);if(this.el=V.createElement(u,n),Ms.currentNode=this.el.content,2===r){const i=this.el.content.firstChild;i.replaceWith(...i.childNodes)}for(;null!==(h=Ms.nextNode())&&c.length<l;){if(1===h.nodeType){if(h.hasAttributes())for(const i of h.getAttributeNames())if(i.endsWith(ds)){const r=d[a++],n=h.getAttribute(i).split(fs),l=/([.?@])?(.*)/.exec(r);c.push({type:1,index:o,name:l[2],strings:n,ctor:"."===l[1]?k:"?"===l[1]?H:"@"===l[1]?I:R}),h.removeAttribute(i)}else i.startsWith(fs)&&(c.push({type:6,index:o}),h.removeAttribute(i));if(Fs.test(h.tagName)){const i=h.textContent.split(fs),r=i.length-1;if(r>0){h.textContent=cs?cs.emptyScript:"";for(let n=0;n<r;n++)h.append(i[n],gs()),Ms.nextNode(),c.push({type:2,index:++o});h.append(i[r],gs())}}}else if(8===h.nodeType)if(h.data===ps)c.push({type:2,index:o});else{let i=-1;for(;-1!==(i=h.data.indexOf(fs,i+1));)c.push({type:7,index:o}),i+=fs.length-1}o++}}static createElement(i,r){const n=ms.createElement("template");return n.innerHTML=i,n}}function Ts(i,r,n=i,h){if(r===$s)return r;let o=void 0!==h?n.et?.[h]:n.rt;const a=vs(r)?void 0:r.ht;return o?.constructor!==a&&(o?.ot?.(!1),void 0===a?o=void 0:(o=new a(i),o.lt(i,n,h)),void 0!==h?(n.et??=[])[h]=o:n.rt=o),void 0!==o&&(r=Ts(i,o.ct(i,r.values),o,h)),r}class S{constructor(i,r){this.ut=[],this.dt=void 0,this.yt=i,this.gt=r}get parentNode(){return this.gt.parentNode}get vt(){return this.gt.vt}u(i){const{el:{content:r},parts:n}=this.yt,h=(i?.creationScope??ms).importNode(r,!0);Ms.currentNode=h;let o=Ms.nextNode(),a=0,l=0,c=n[0];for(;void 0!==c;){if(a===c.index){let r;2===c.type?r=new M(o,o.nextSibling,this,i):1===c.type?r=new c.ctor(o,c.name,c.strings,this,i):6===c.type&&(r=new L(o,this,i)),this.ut.push(r),c=n[++l]}a!==c?.index&&(o=Ms.nextNode(),a++)}return Ms.currentNode=ms,h}p(i){let r=0;for(const n of this.ut)void 0!==n&&(void 0!==n.strings?(n.wt(i,n,r),r+=n.strings.length-2):n.wt(i[r])),r++}}class M{get vt(){return this.gt?.vt??this.bt}constructor(i,r,n,h){this.type=2,this.At=Us,this.dt=void 0,this.Pt=i,this.Ct=r,this.gt=n,this.options=h,this.bt=h?.isConnected??!0}get parentNode(){let i=this.Pt.parentNode;const r=this.gt;return void 0!==r&&11===i?.nodeType&&(i=r.parentNode),i}get startNode(){return this.Pt}get endNode(){return this.Ct}wt(i,r=this){i=Ts(this,i,r),vs(i)?i===Us||null==i||""===i?(this.At!==Us&&this.St(),this.At=Us):i!==this.At&&i!==$s&&this._t(i):void 0!==i.tt?this.$(i):void 0!==i.nodeType?this.T(i):(i=>ws(i)||"function"==typeof i?.[Symbol.iterator])(i)?this.k(i):this._t(i)}S(i){return this.Pt.parentNode.insertBefore(i,this.Ct)}T(i){this.At!==i&&(this.St(),this.At=this.S(i))}_t(i){this.At!==Us&&vs(this.At)?this.Pt.nextSibling.data=i:this.T(ms.createTextNode(i)),this.At=i}$(i){const{values:r,tt:n}=i,h="number"==typeof n?this.xt(i):(void 0===n.el&&(n.el=V.createElement(Is(n.h,n.h[0]),this.options)),n);if(this.At?.yt===h)this.At.p(r);else{const i=new S(h,this),n=i.u(this.options);i.p(r),this.T(n),this.At=i}}xt(i){let r=Es.get(i.strings);return void 0===r&&Es.set(i.strings,r=new V(i)),r}k(i){ws(this.At)||(this.At=[],this.St());const r=this.At;let n,h=0;for(const o of i)h===r.length?r.push(n=new M(this.S(gs()),this.S(gs()),this,this.options)):n=r[h],n.wt(o),h++;h<r.length&&(this.St(n&&n.Ct.nextSibling,h),r.length=h)}St(i=this.Pt.nextSibling,r){for(this.Ft?.(!1,!0,r);i&&i!==this.Ct;){const r=i.nextSibling;i.remove(),i=r}}setConnected(i){void 0===this.gt&&(this.bt=i,this.Ft?.(i))}}class R{get tagName(){return this.element.tagName}get vt(){return this.gt.vt}constructor(i,r,n,h,o){this.type=1,this.At=Us,this.dt=void 0,this.element=i,this.name=r,this.gt=h,this.options=o,n.length>2||""!==n[0]||""!==n[1]?(this.At=Array(n.length-1).fill(new String),this.strings=n):this.At=Us}wt(i,r=this,n,h){const o=this.strings;let a=!1;if(void 0===o)i=Ts(this,i,r,0),a=!vs(i)||i!==this.At&&i!==$s,a&&(this.At=i);else{const h=i;let l,c;for(i=o[0],l=0;l<o.length-1;l++)c=Ts(this,h[n+l],r,l),c===$s&&(c=this.At[l]),a||=!vs(c)||c!==this.At[l],c===Us?i=Us:i!==Us&&(i+=(c??"")+o[l+1]),this.At[l]=c}a&&!h&&this.j(i)}j(i){i===Us?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,i??"")}}class k extends R{constructor(){super(...arguments),this.type=3}j(i){this.element[this.name]=i===Us?void 0:i}}class H extends R{constructor(){super(...arguments),this.type=4}j(i){this.element.toggleAttribute(this.name,!!i&&i!==Us)}}class I extends R{constructor(i,r,n,h,o){super(i,r,n,h,o),this.type=5}wt(i,r=this){if((i=Ts(this,i,r,0)??Us)===$s)return;const n=this.At,h=i===Us&&n!==Us||i.capture!==n.capture||i.once!==n.once||i.passive!==n.passive,o=i!==Us&&(n===Us||h);h&&this.element.removeEventListener(this.name,this,n),o&&this.element.addEventListener(this.name,this,i),this.At=i}handleEvent(i){"function"==typeof this.At?this.At.call(this.options?.host??this.element,i):this.At.handleEvent(i)}}class L{constructor(i,r,n){this.element=i,this.type=6,this.dt=void 0,this.gt=r,this.options=n}get vt(){return this.gt.vt}wt(i){Ts(this,i)}}const ks=ls.litHtmlPolyfillSupport;ks?.(V,M),(ls.litHtmlVersions??=[]).push("3.1.3");class s extends b{constructor(){super(...arguments),this.renderOptions={host:this},this.zt=void 0}createRenderRoot(){const i=super.createRenderRoot();return this.renderOptions.renderBefore??=i.firstChild,i}update(i){const r=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(i),this.zt=((i,r,n)=>{const h=n?.renderBefore??r;let o=h.$t;if(void 0===o){const i=n?.renderBefore??null;h.$t=o=new M(r.insertBefore(gs(),i),i,void 0,n??{})}return o.wt(i),o})(r,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this.zt?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this.zt?.setConnected(!1)}render(){return $s}}s.Ut=!0,s.finalized=!0,globalThis.litElementHydrateSupport?.({LitElement:s});const Bs=globalThis.litElementPolyfillSupport;Bs?.({LitElement:s}),(globalThis.litElementVersions??=[]).push("4.0.5");const Ks=i=>(r,n)=>{void 0!==n?n.addInitializer((()=>{customElements.define(i,r)})):customElements.define(i,r)},Ns={attribute:!0,type:String,converter:hs,reflect:!1,hasChanged:os},Rs=(i=Ns,r,n)=>{const{kind:h,metadata:o}=n;let a=globalThis.litPropertyMetadata.get(o);if(void 0===a&&globalThis.litPropertyMetadata.set(o,a=new Map),a.set(n.name,i),"accessor"===h){const{name:h}=n;return{set(n){const o=r.get.call(this);r.set.call(this,n),this.requestUpdate(h,o,i)},init(r){return void 0!==r&&this.P(h,void 0,i),r}}}if("setter"===h){const{name:h}=n;return function(n){const o=this[h];r.call(this,n),this.requestUpdate(h,o,i)}}throw Error("Unsupported decorator location: "+h)};function Ds(i){return(r,n)=>"object"==typeof n?Rs(i,r,n):((i,r,n)=>{const h=r.hasOwnProperty(n);return r.constructor.createProperty(n,h?{...i,wrapped:!0}:i),h?Object.getOwnPropertyDescriptor(r,n):void 0})(i,r,n)}function Os(i){return Ds({...i,state:!0,attribute:!1})}function js(i,r){return(r,n,h)=>((i,r,n)=>(n.configurable=!0,n.enumerable=!0,Reflect.decorate&&"object"!=typeof r&&Object.defineProperty(i,r,n),n))(r,n,{get(){return(r=>r.renderRoot?.querySelector(i)??null)(this)}})}const Ws={" ":"Enter",Enter:"Enter",a:"ArrowLeft",s:"ArrowLeft",ArrowLeft:"ArrowLeft",ArrowDown:"ArrowLeft",d:"ArrowRight",w:"ArrowRight",ArrowRight:"ArrowRight",ArrowUp:"ArrowRight"};i.PlayerComponent=class extends(Ti(s)){static get styles(){return Vi`:host{display:inline-block}.Player{display:inline-block;position:relative;font-family:var(--flipnote-player-font-family,sans-serif)}.CanvasArea{position:relative}.CanvasArea:focus{outline:var(--flipnote-player-focus-outline,3px solid #ffd3a6);outline-offset:2px}.PlayerCanvas{position:relative;display:block}.PlayerCanvas canvas{display:block}.Overlay{position:absolute;top:0;left:0;background:#ebf0f3;color:#4b4c53;width:100%;height:100%;display:flex;justify-content:center;align-items:center}.Overlay--error{background:#ff8b8b;color:#ca2a32}@keyframes spin{from{transform:rotateZ(0)}to{transform:rotateZ(360deg)}}.LoaderIcon{animation:spin infinite 1.2s linear}.Controls{background:var(--flipnote-player-controls-background,none)}.MuteIcon{width:28px;height:28px}.Controls__groupLeft,.Controls__groupRight,.Controls__row{display:flex;align-items:center}.Controls__groupLeft{margin-right:auto}.Controls__groupRight{margin-left:auto}.Controls__playButton{height:32px;width:32px;padding:2px}.MuteIcon{width:28px;height:28px}.LoaderIcon{width:40px;height:40px}.Controls.Controls--compact{margin:6px 0}.Controls__frameCounter{min-width:90px;font-variant-numeric:tabular-nums}.Controls__progressBar{flex:1}.Controls--compact .Controls__playButton{margin-right:8px}.Controls--compact .Controls__progressBar{flex:1}.Controls--default .Controls__playButton{margin-right:8px}.Controls--default .Controls__progressBar{margin-top:2px;margin-bottom:2px;display:block}.Controls--default .Controls__volumeBar{width:70px;margin-left:8px}.Button{border:0;padding:0;outline:0;-webkit-appearance:none;display:block;font-family:inherit;font-size:inherit;text-align:center;cursor:pointer;background:var(--flipnote-player-button-background,#ffd3a6);color:var(--flipnote-player-button-color,#f36a2d);border-radius:4px}.Button:focus{outline:3px solid var(--flipnote-player-button-background,#ffd3a6);outline-offset:2px}.Button flipnote-player-icon{display:block}`}get width(){return this.Et}set width(i){const r=this.Et;var n;this.Et=i,this.Mt=isNaN(+i)?i:`${i}px`,n=()=>this.updateCanvasSize(),m?A((()=>A((()=>n())))):n(),this.requestUpdate("width",r)}get src(){return this.It}set src(i){const r=this.It;this.Lt&&this.player.load(i),this.It=i,this.requestUpdate("src",r)}get autoplay(){return this.player?.autoplay}set autoplay(i){if(this.player){const r=this.player.autoplay;this.player.autoplay=i,this.requestUpdate("autoplay",r)}}constructor(){super(),this.Et="auto",this.Mt="auto",this.Tt=0,this.kt="",this.Bt=0,this.Kt=!1,this.Nt=!1,this.Rt=!1,this.Dt=!1,this.Ot=0,this.Lt=!1,this.handleResize=i=>{this.updateCanvasSize()},this.handleKeyInput=i=>{const r=Ws[i.key];if(r){switch(r){case"Enter":this.togglePlay();break;case"ArrowLeft":i.shiftKey?this.firstFrame():this.prevFrame();break;case"ArrowRight":i.shiftKey?this.lastFrame():this.nextFrame()}i.preventDefault()}},this.handlePlayToggle=i=>{this.focus(),this.togglePlay()},this.handleMuteToggle=i=>{this.focus(),this.toggleMuted()},this.handleProgressSliderChange=i=>{this.focus(),this.seek(i.detail.value)},this.handleProgressSliderInputStart=()=>{this.focus(),this.startSeek()},this.handleProgressSliderInputEnd=()=>{this.focus(),this.endSeek()},this.handleVolumeBarChange=i=>{this.focus(),this.setVolume(i.detail.value)},this.jt=new ResizeObserver(this.handleResize)}render(){return zs`<style>:host{width:${this.Mt}}</style><div class="Player"><div class="CanvasArea" tabIndex="0" role="widget" aria-description="Flipnote animation player. Press the space key to play or pause the animation. Use the left and right arrow keys to navigate frames" @click="${this.handlePlayToggle}" @keydown="${this.handleKeyInput}"><div class="PlayerCanvas" id="canvasWrapper"></div>${this.Kt?zs`<div class="Overlay"><flipnote-player-icon icon="loader" class="LoaderIcon"></flipnote-player-icon></div>`:""} ${this.Nt?zs`<div class="Overlay Overlay--error">Error</div>`:""}</div>${this.renderControls()}</div>`}renderControls(){return"compact"===this.controls?zs`<div class="Controls Controls--compact Controls__row"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this.Rt?"pause":"play"}"></flipnote-player-icon></button><flipnote-player-slider class="Controls__progressBar" value="${this.Tt}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></div>`:zs`<div class="Controls Controls--default"><flipnote-player-slider class="Controls__progressBar" value="${this.Tt}" label="Playback progress" step="${1/(this.Bt-1)}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></flipnote-player-slider><div class="Controls__row"><div class="Controls__groupLeft"><button class="Button Controls__playButton" tabIndex="0" @click="${this.handlePlayToggle}"><flipnote-player-icon icon="${this.Rt?"pause":"play"}"></flipnote-player-icon></button> <span class="Controls__frameCounter">${this.kt}</span></div><div class="Controls__groupRight"><flipnote-player-icon class="MuteIcon" @click="${this.handleMuteToggle}" icon="${this.Dt?"volumeOff":"volumeOn"}"></flipnote-player-icon><flipnote-player-slider class="Controls__volumeBar" value="${this.Ot}" label="Volume" @change="${this.handleVolumeBarChange}"></flipnote-player-slider></div></div></div>`}firstUpdated(r){this.updateSettingsFromProps();const n=new Player(this.playerCanvasWrapper,256,192,this.parserSettings);this.jt.observe(this),this.player=n,n.on(i.PlayerEvent.LoadStart,(()=>{this.Kt=!0})),n.on(i.PlayerEvent.Load,(()=>{this.updateCanvasSize()})),n.on(i.PlayerEvent.Error,(()=>{this.Kt=!1,this.Nt=!0})),n.on([i.PlayerEvent.Load,i.PlayerEvent.Close,i.PlayerEvent.Progress],(()=>{this.Kt=!1,this.Nt=!1,this.Tt=n.getProgress()/100,this.kt=n.getFrameCounter(),this.Bt=n.frameCount})),n.on(i.PlayerEvent.Play,(()=>{this.Rt=!0})),n.on(i.PlayerEvent.Pause,(()=>{this.Rt=!1})),n.on([i.PlayerEvent.Load,i.PlayerEvent.VolumeChange],(()=>{this.Ot=n.volume,this.Dt=n.muted})),n.on(i.PlayerEvent.i,((i,r)=>{this.dispatchEvent(new Event(i))})),this.It&&n.load(this.It),this.Lt=!0}disconnectedCallback(){this.jt.disconnect(),this.destroy()}updateSettingsFromProps(){this.parserSettings={dsiLibraryNote:this.dsiLibrary,borderCrop:this.cropBorder,initialBgmPredictor:this.bgmPredictor,initialBgmStepIndex:this.bgmStepIndex,initialSePredictors:this.parseListProp(this?.sePredictors),initialSeStepIndices:this.parseListProp(this?.seStepIndices)}}parseListProp(i){if(i)return i.split(",").map((i=>/^\s*$/.test(i)?void 0:parseInt(i)))}updateCanvasSize(){const i=this.Lt,r=this.player.note;let n=256;"auto"===this.Et&&i&&this.player.isNoteLoaded?n=r.imageWidth:"auto"!==this.Et&&(n=this.getBoundingClientRect().width),i&&r&&this.player.resize(n,n*r.aspect)}},Di([Ds({type:String})],i.PlayerComponent.prototype,"controls",void 0),Di([Ds({type:Boolean})],i.PlayerComponent.prototype,"dsiLibrary",void 0),Di([Ds({type:Boolean})],i.PlayerComponent.prototype,"cropBorder",void 0),Di([Ds({type:Number})],i.PlayerComponent.prototype,"bgmPredictor",void 0),Di([Ds({type:Number})],i.PlayerComponent.prototype,"bgmStepIndex",void 0),Di([Ds({type:String})],i.PlayerComponent.prototype,"sePredictors",void 0),Di([Ds({type:String})],i.PlayerComponent.prototype,"seStepIndices",void 0),Di([Ds({type:String})],i.PlayerComponent.prototype,"width",null),Di([Ds({type:String})],i.PlayerComponent.prototype,"src",null),Di([Ds({type:Boolean})],i.PlayerComponent.prototype,"autoplay",null),Di([Os()],i.PlayerComponent.prototype,"_width",void 0),Di([Os()],i.PlayerComponent.prototype,"_cssWidth",void 0),Di([Os()],i.PlayerComponent.prototype,"_progress",void 0),Di([Os()],i.PlayerComponent.prototype,"_counter",void 0),Di([Os()],i.PlayerComponent.prototype,"_frameCount",void 0),Di([Os()],i.PlayerComponent.prototype,"_isLoading",void 0),Di([Os()],i.PlayerComponent.prototype,"_isError",void 0),Di([Os()],i.PlayerComponent.prototype,"_isPlaying",void 0),Di([Os()],i.PlayerComponent.prototype,"_isMuted",void 0),Di([Os()],i.PlayerComponent.prototype,"_volumeLevel",void 0),Di([js("#canvasWrapper")],i.PlayerComponent.prototype,"playerCanvasWrapper",void 0),i.PlayerComponent=Di([Ks("flipnote-player")],i.PlayerComponent);const Hs=i=>(...r)=>({ht:i,values:r});let Gs=class{constructor(i){}get vt(){return this.gt.vt}lt(i,r,n){this.Wt=i,this.gt=r,this.Ht=n}ct(i,r){return this.update(i,r)}update(i,r){return this.render(...r)}};const Vs=Hs(class extends Gs{constructor(i){if(super(i),1!==i.type||"class"!==i.name||i.strings?.length>2)throw Error("`classMap()` can only be used in the `class` attribute and must be the only part in the attribute.")}render(i){return" "+Object.keys(i).filter((r=>i[r])).join(" ")+" "}update(i,[r]){if(void 0===this.st){this.st=new Set,void 0!==i.strings&&(this.nt=new Set(i.strings.join(" ").split(/\s/).filter((i=>""!==i))));for(const i in r)r[i]&&!this.nt?.has(i)&&this.st.add(i);return this.render(r)}const n=i.element.classList;for(const i of this.st)i in r||(n.remove(i),this.st.delete(i));for(const i in r){const h=!!r[i];h===this.st.has(i)||this.nt?.has(i)||(h?(n.add(i),this.st.add(i)):(n.remove(i),this.st.delete(i)))}return $s}}),Zs="important",Qs=" !"+Zs,qs=Hs(class extends Gs{constructor(i){if(super(i),1!==i.type||"style"!==i.name||i.strings?.length>2)throw Error("The `styleMap` directive must be used in the `style` attribute and must be the only part in the attribute.")}render(i){return Object.keys(i).reduce(((r,n)=>{const h=i[n];return null==h?r:r+`${n=n.includes("-")?n:n.replace(/(?:^(webkit|moz|ms|o)|)(?=[A-Z])/g,"-$&").toLowerCase()}:${h};`}),"")}update(i,[r]){const{style:n}=i.element;if(void 0===this.ft)return this.ft=new Set(Object.keys(r)),this.render(r);for(const i of this.ft)null==r[i]&&(this.ft.delete(i),i.includes("-")?n.removeProperty(i):n[i]=null);for(const i in r){const h=r[i];if(null!=h){this.ft.add(i);const r="string"==typeof h&&h.endsWith(Qs);i.includes("-")||r?n.setProperty(i,r?h.slice(0,-11):h,r?Zs:""):n[i]=h}}return $s}});let Ys=class extends s{constructor(){super(...arguments),this.value=0,this.step=.1,this.label="",this.orientation="horizontal",this.isActive=!1,this.onSliderMouseStart=i=>{i.preventDefault(),this.isActive=!0,document.addEventListener("mousemove",this.onSliderMouseMove),document.addEventListener("mouseup",this.onSliderMouseEnd),this.dispatch("inputstart"),this.onSliderInput(i.clientX,i.clientY)},this.onSliderMouseEnd=i=>{i.preventDefault(),document.removeEventListener("mousemove",this.onSliderMouseMove),document.removeEventListener("mouseup",this.onSliderMouseEnd),this.dispatch("inputend"),this.onSliderInput(i.clientX,i.clientY),this.isActive=!1},this.onSliderMouseMove=i=>{i.preventDefault(),this.onSliderInput(i.clientX,i.clientY)},this.onSliderTouchStart=i=>{const r=i.changedTouches[0];i.preventDefault(),this.isActive=!0,document.addEventListener("touchmove",this.onSliderTouchMove),document.addEventListener("touchend",this.onSliderTouchEnd),this.dispatch("inputstart"),this.onSliderInput(r.clientX,r.clientY)},this.onSliderTouchEnd=i=>{const r=i.changedTouches[0];i.preventDefault(),document.removeEventListener("touchmove",this.onSliderTouchMove),document.removeEventListener("touchend",this.onSliderTouchEnd),this.dispatch("inputend"),this.onSliderInput(r.clientX,r.clientY),this.isActive=!1},this.onSliderTouchMove=i=>{const r=i.changedTouches[0];i.preventDefault(),this.onSliderInput(r.clientX,r.clientY)},this.onSliderInput=(i,r)=>{const n=this.sliderElement.getBoundingClientRect();let h;if("horizontal"===this.orientation){const r=n.height/2,o=n.width-2*r,a=(i-n.left-r)/o;h=Math.max(0,Math.min(a,1))}else if("vertical"===this.orientation){const i=n.width/2,o=n.height-2*i,a=1-(r-n.top-i)/o;h=Math.max(0,Math.min(a,1))}this.updateValue(h)},this.onKeyInput=i=>{const r=Ws[i.key];if(r){switch(this.dispatch("inputstart"),r){case"ArrowLeft":i.shiftKey?this.updateValue(0):this.updateValue(this.value-this.step);break;case"ArrowRight":i.shiftKey?this.updateValue(1):this.updateValue(this.value+this.step)}this.dispatch("inputend"),i.preventDefault()}},this.updateValue=i=>{i=c(i,0,1),this.value!==i&&(this.value=i,this.dispatch("change",{value:i}))}}static get styles(){return Vi`.Slider{touch-action:none;padding:4px 0;cursor:pointer}.Slider:focus{position:relative;z-index:1;outline:var(--flipnote-player-focus-outline,3px solid #ffd3a6);outline-offset:2px}.Slider--vertical{height:100px;width:14px}.Slider__track{position:relative;border-radius:3px;background:var(--flipnote-player-slider-track,#ffd3a6)}.Slider--horizontal .Slider__track{height:4px;margin:6px 0}.Slider--vertical .Slider__track{width:4px;height:100%;margin:0 6px}.Slider__levelWrapper{position:absolute;left:0;right:0;height:6px;margin:-1px}.Slider__level{position:absolute;width:100%;left:0;height:8px;border-radius:8px;background:var(--flipnote-player-slider-level,#f36a2d)}.Slider--horizontal .Slider__level{width:100%;height:6px}.Slider--vertical .Slider__level{width:6px;height:100%;bottom:0}.Slider__handle{display:none;position:absolute;height:10px;width:10px;border-radius:5px;box-sizing:border-box;border:3px solid var(--flipnote-player-slider-handle,#f36a2d);background:var(--flipnote-player-slider-handle-fill,#fff)}.Slider--isActive .Slider__handle,.Slider:hover .Slider__handle{display:block}.Slider--horizontal .Slider__handle{top:0;margin-top:-3px;margin-left:-6px}.Slider--vertical .Slider__handle{left:0;margin-bottom:-6px;margin-left:-3px}`}render(){const i=100*this.value+"%",r="horizontal"===this.orientation?"width":"height",n="horizontal"===this.orientation?"left":"bottom",h={Slider:!0,"Slider--horizontal":"horizontal"===this.orientation,"Slider--vertical":"vertical"===this.orientation,"Slider--isActive":this.isActive};return zs`<div class="${Vs(h)}" tabIndex="0" role="slider" aria-label="${this.label}" aria-valuemin="0" aria-valuemax="1" aria-valuenow="${this.value}" @touchstart="${this.onSliderTouchStart}" @mousedown="${this.onSliderMouseStart}" @keydown="${this.onKeyInput}"><div class="Slider__track"><div class="Slider__levelWrapper"><div class="Slider__level" style="${qs({[r]:i})}"></div></div><div class="Slider__handle" style="${qs({[n]:i})}"></div></div></div>`}dispatch(i,r){const n=new CustomEvent(i,{detail:r});this.dispatchEvent(n)}};Di([Ds({type:Number})],Ys.prototype,"value",void 0),Di([Ds({type:Number})],Ys.prototype,"step",void 0),Di([Ds({type:String})],Ys.prototype,"label",void 0),Di([Ds({type:String})],Ys.prototype,"orientation",void 0),Di([Os()],Ys.prototype,"isActive",void 0),Di([js(".Slider__track")],Ys.prototype,"sliderElement",void 0),Ys=Di([Ks("flipnote-player-slider")],Ys);class e extends Gs{constructor(i){if(super(i),this.it=Us,2!==i.type)throw Error(this.constructor.directiveName+"() can only be used in child bindings")}render(i){if(i===Us||null==i)return this.Gt=void 0,this.it=i;if(i===$s)return i;if("string"!=typeof i)throw Error(this.constructor.directiveName+"() called with a non-string value");if(i===this.it)return this.Gt;this.it=i;const r=[i];return r.raw=r,this.Gt={tt:this.constructor.resultType,strings:r,values:[]}}}e.directiveName="unsafeHTML",e.resultType=1;class t extends e{}t.directiveName="unsafeSVG",t.resultType=2;const Js=Hs(t),Xs=i=>i.replace(/<svg ([^>]*)>/,((i,r)=>`<svg ${r} class="Icon" style="fill:currentColor">`)),te={play:Xs('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M74.1374132,48 L83.1218112,48 C83.8751514,48 84.6131784,48.2127391 85.2509322,48.6137272 L177.244774,106.454909 C184.725521,111.158433 186.976905,121.035737 182.273381,128.516484 C180.99563,130.548691 179.27698,132.26734 177.244774,133.545091 L85.2509322,191.386273 C84.6131784,191.787261 83.8751514,192 83.1218112,192 L74.1374132,192 C68.5386745,192 64,187.461326 64,181.862587 L64,58.1374132 C64,52.5386745 68.5386745,48 74.1374132,48 Z"/></svg>'),pause:Xs('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M64,48 L88,48 C96.836556,48 104,55.163444 104,64 L104,176 C104,184.836556 96.836556,192 88,192 L64,192 C55.163444,192 48,184.836556 48,176 L48,64 C48,55.163444 55.163444,48 64,48 Z M152,48 L176,48 C184.836556,48 192,55.163444 192,64 L192,176 C192,184.836556 184.836556,192 176,192 L152,192 C143.163444,192 136,184.836556 136,176 L136,64 C136,55.163444 143.163444,48 152,48 Z"/></svg>'),loader:Xs('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M120,176 C128.836556,176 136,183.163444 136,192 C136,200.836556 128.836556,208 120,208 C111.163444,208 104,200.836556 104,192 C104,183.163444 111.163444,176 120,176 Z M168.497423,148 C172.915701,140.347318 182.701147,137.725316 190.353829,142.143594 C198.006511,146.561872 200.628514,156.347318 196.210236,164 C191.791958,171.652682 182.006511,174.274684 174.353829,169.856406 C166.701147,165.438128 164.079145,155.652682 168.497423,148 Z M49.6461709,142.143594 C57.2988529,137.725316 67.0842994,140.347318 71.5025774,148 C75.9208554,155.652682 73.2988529,165.438128 65.6461709,169.856406 C57.993489,174.274684 48.2080425,171.652682 43.7897645,164 C39.3714865,156.347318 41.993489,146.561872 49.6461709,142.143594 Z M174.353829,70.1435935 C182.006511,65.7253155 191.791958,68.347318 196.210236,76 C200.628514,83.652682 198.006511,93.4381285 190.353829,97.8564065 C182.701147,102.274684 172.915701,99.652682 168.497423,92 C164.079145,84.347318 166.701147,74.5618715 174.353829,70.1435935 Z M43.7897645,76 C48.2080425,68.347318 57.993489,65.7253155 65.6461709,70.1435935 C73.2988529,74.5618715 75.9208554,84.347318 71.5025774,92 C67.0842994,99.652682 57.2988529,102.274684 49.6461709,97.8564065 C41.993489,93.4381285 39.3714865,83.652682 43.7897645,76 Z M120,32 C128.836556,32 136,39.163444 136,48 C136,56.836556 128.836556,64 120,64 C111.163444,64 104,56.836556 104,48 C104,39.163444 111.163444,32 120,32 Z"/></svg>'),volumeOn:Xs('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M113.3,42.0221751 C116.173884,39.8502203 119.99384,39.3918256 123.3,40.8221751 C126.772838,42.476202 128.989111,45.9755807 129,49.8221751 L129,49.8221751 L129,189.822175 C128.989111,193.66877 126.772838,197.168148 123.3,198.822175 C121.970477,199.503408 120.493687,199.846847 119,199.823416 C116.744358,199.809091 114.559393,199.033781 112.8,197.622175 L112.8,197.622175 L65.5,159.822175 L29,159.822175 C23.4771525,159.822175 19,155.345023 19,149.822175 L19,149.822175 L19,89.8221751 C19,84.2993276 23.4771525,79.8221751 29,79.8221751 L29,79.8221751 L65.5,79.8221751 Z M196.286415,59.3197538 C213.294099,75.5543608 222.000706,95.3421052 222.000706,118.00002 C222.000706,140.370063 213.535918,161.147272 197.009268,179.927555 C192.631012,184.902847 185.048463,185.386839 180.073171,181.008583 C175.09788,176.630326 174.613887,169.047777 178.992144,164.072486 C191.798828,149.519435 198.000706,134.296644 198.000706,118.00002 C198.000706,101.991269 192.040647,88.4456799 179.714997,76.6802869 C174.921018,72.1042162 174.744369,64.5082902 179.32044,59.7143114 C183.89651,54.9203325 191.492436,54.7436831 196.286415,59.3197538 Z M165.200706,87.4000203 C176.105233,95.5784156 182.000706,106.386783 182.000706,119.00002 C182.000706,131.432529 176.288715,142.380513 165.682919,151.218676 C160.591596,155.461445 153.02482,154.773556 148.782051,149.682233 C144.608835,144.674375 145.205942,137.27156 150.071653,132.99268 L150.318493,132.781365 C155.712698,128.286195 158.000706,123.900845 158.000706,119.00002 C158.000706,114.387199 155.990753,110.597447 151.143501,106.860651 L150.800706,106.60002 C145.498773,102.62357 144.424256,95.1019539 148.400706,89.8000203 C152.377156,84.4980867 159.898773,83.4235701 165.200706,87.4000203 Z"/></svg>'),volumeOff:Xs('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M123.3,40.8221751 C119.99384,39.3918256 116.173884,39.8502203 113.3,42.0221751 L65.5,79.8221751 L29,79.8221751 C23.4771525,79.8221751 19,84.2993276 19,89.8221751 L19,149.822175 C19,155.345023 23.4771525,159.822175 29,159.822175 L65.5,159.822175 L112.8,197.622175 C114.559393,199.033781 116.744358,199.809091 119,199.823416 C120.493687,199.846847 121.970477,199.503408 123.3,198.822175 C126.772838,197.168148 128.989111,193.66877 129,189.822175 L129,49.8221751 C128.989111,45.9755807 126.772838,42.476202 123.3,40.8221751 Z M193.751433,91.2843093 C198.453467,86.8297289 205.877095,86.906532 210.485281,91.5147186 C215.093468,96.1229053 215.170271,103.546533 210.715691,108.248567 L210.485281,108.485281 L198.971,120 L210.485281,131.514719 C215.171573,136.20101 215.171573,143.79899 210.485281,148.485281 C205.877095,153.093468 198.453467,153.170271 193.751433,148.715691 L193.514719,148.485281 L182,136.971 L170.485281,148.485281 L170.248567,148.715691 C165.546533,153.170271 158.122905,153.093468 153.514719,148.485281 C148.906532,143.877095 148.829729,136.453467 153.284309,131.751433 L153.514719,131.514719 L165.029,120 L153.514719,108.485281 C148.828427,103.79899 148.828427,96.2010101 153.514719,91.5147186 C158.122905,86.906532 165.546533,86.8297289 170.248567,91.2843093 L170.485281,91.5147186 L182,103.029 L193.514719,91.5147186 L193.751433,91.2843093 Z"/></svg>')};let ie=class extends s{constructor(){super(...arguments),this.icon="loader"}static get styles(){return Vi`.Icon{width:100%;height:100%;color:var(--flipnote-player-icon-color,#f36a2d)}`}render(){return zs`${Js(te[this.icon])}`}};Di([Ds({type:String})],ie.prototype,"icon",void 0),ie=Di([Ks("flipnote-player-icon")],ie),i.ImageComponent=class extends s{constructor(){super(...arguments),this._="",this.U="0",this.cropped=!1,this.gifUrl="",this.imgTitle=""}static get styles(){return Vi`.Image{width:inherit;height:inherit;image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges;-ms-interpolation-mode:nearest-neighbor}`}set src(i){this.load(i)}get src(){return this._}set frame(i){this.U=i,this.note&&this.loadNote(this.note)}get frame(){return this.U}render(){return zs`<img class="Image" src="${this.gifUrl}" alt="${this.imgTitle}" title="${this.imgTitle}">`}revokeUrl(){this.gif&&this.gif.dataUrl&&(this.gif.revokeUrl(),this.gifUrl="")}loadNote(i){this.note=i,this.revokeUrl();const r=this.U;if("all"===r)this.gif=GifImage.fromFlipnote(i),this.gifUrl=this.gif.getUrl();else if("thumb"===r)this.gif=GifImage.fromFlipnoteFrame(i,i.thumbFrameIndex),this.gifUrl=this.gif.getUrl();else if(!isNaN(+r)){const n=parseInt(r);this.gif=GifImage.fromFlipnoteFrame(i,n),this.gifUrl=this.gif.getUrl()}this.gifUrl?(this.dispatchLoad(),this.imgTitle=i.getTitle()):this.dispatchError("Invalid frame attribute")}load(i){this._=i,this.note=void 0;const r="true"===this.getAttribute("cropped");St(i,{borderCrop:r}).then((i=>this.loadNote(i))).catch((i=>this.dispatchError(i)))}disconnectedCallback(){this.revokeUrl()}dispatchLoad(){this.dispatchEvent(new Event("load"))}dispatchError(i){throw this.dispatchEvent(new ErrorEvent("error",{error:i})),new Error(i)}},Di([Ds()],i.ImageComponent.prototype,"src",null),Di([Ds()],i.ImageComponent.prototype,"frame",null),Di([Ds({type:Boolean})],i.ImageComponent.prototype,"cropped",void 0),Di([Os()],i.ImageComponent.prototype,"gifUrl",void 0),Di([Os()],i.ImageComponent.prototype,"imgTitle",void 0),i.ImageComponent=Di([Ks("flipnote-image")],i.ImageComponent),i.CanvasInterface=class{constructor(i,r,n,h){}},i.GifImage=GifImage,i.Html5Canvas=Html5Canvas,i.KwzParser=KwzParser,i.Player=Player,i.PlayerMixin=Ti,i.PpmParser=PpmParser,i.UniversalCanvas=UniversalCanvas,i.WavAudio=WavAudio,i.WebAudioPlayer=WebAudioPlayer,i.WebglCanvas=WebglCanvas,i.id=Ri,i.loaders=Pt,i.parse=Ct,i.parseSource=St,i.version="6.0.1"}({});
//# sourceMappingURL=flipnote.webcomponent.min.js.map
