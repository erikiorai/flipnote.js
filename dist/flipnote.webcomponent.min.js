/*!!
flipnote.js v5.2.1 (webcomponent build)
https://flipnote.js.org
A JavaScript library for parsing, converting, and in-browser playback of the proprietary animation formats used by Nintendo's Flipnote Studio and Flipnote Studio 3D apps.
2018 - 2021 James Daniel
Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
Keep on Flipnoting!
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).flipnote={})}(this,(function(t){"use strict";class e{constructor(){this.pageSize=e.pageSize,this.currPageIndex=-1,this.pages=[],this.pointer=0,this.newPage()}newPage(){this.pages[++this.currPageIndex]=new Uint8Array(this.pageSize),this.currPage=this.pages[this.currPageIndex],this.pointer=0}getData(){const t=new Uint8Array(this.currPageIndex*this.pageSize+this.pointer);for(let e=0;e<this.pages.length;e++){const i=this.pages[e];e===this.currPageIndex?t.set(i.slice(0,this.pointer),e*this.pageSize):t.set(i,e*this.pageSize)}return t}getBuffer(){return this.getData().buffer}writeByte(t){this.pointer>=this.pageSize&&this.newPage(),this.currPage[this.pointer++]=t}writeBytes(t,e,i){for(let r=i||t.length,s=e||0;s<r;s++)this.writeByte(t[s])}}e.pageSize=2048;class i{constructor(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}get bytes(){return new Uint8Array(this.buffer)}get byteLength(){return this.data.byteLength}seek(t,e){switch(e){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;case 0:default:this.pointer=t}}readUint8(){const t=this.data.getUint8(this.pointer);return this.pointer+=1,t}writeUint8(t){this.data.setUint8(this.pointer,t),this.pointer+=1}readInt8(){const t=this.data.getInt8(this.pointer);return this.pointer+=1,t}writeInt8(t){this.data.setInt8(this.pointer,t),this.pointer+=1}readUint16(t=!0){const e=this.data.getUint16(this.pointer,t);return this.pointer+=2,e}writeUint16(t,e=!0){this.data.setUint16(this.pointer,t,e),this.pointer+=2}readInt16(t=!0){const e=this.data.getInt16(this.pointer,t);return this.pointer+=2,e}writeInt16(t,e=!0){this.data.setInt16(this.pointer,t,e),this.pointer+=2}readUint32(t=!0){const e=this.data.getUint32(this.pointer,t);return this.pointer+=4,e}writeUint32(t,e=!0){this.data.setUint32(this.pointer,t,e),this.pointer+=4}readInt32(t=!0){const e=this.data.getInt32(this.pointer,t);return this.pointer+=4,e}writeInt32(t,e=!0){this.data.setInt32(this.pointer,t,e),this.pointer+=4}readBytes(t){const e=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=e.byteLength,e}writeBytes(t){t.forEach(t=>this.writeUint8(t))}readHex(t,e=!1){const i=this.readBytes(t);let r=[];for(let t=0;t<i.length;t++)r.push(i[t].toString(16).padStart(2,"0"));return e&&r.reverse(),r.join("").toUpperCase()}readChars(t){const e=this.readBytes(t);let i="";for(let t=0;t<e.length;t++){const r=e[t];if(0===r)break;i+=String.fromCharCode(r)}return i}writeChars(t){for(let e=0;e<t.length;e++){const i=t.charCodeAt(e);this.writeUint8(i)}}readWideChars(t){const e=new Uint16Array(this.data.buffer,this.pointer,t);let i="";for(let t=0;t<e.length;t++){const r=e[t];if(0==r)break;i+=String.fromCharCode(r)}return this.pointer+=e.byteLength,i}}const r=new Int8Array([-1,2,-1,2]),s=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),n=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function a(t,e,i){return t<e?e:t>i?i:t}function o(t,e,i){return i<0||i>=e?0:t[i]}function h(t){const e=t.length;let i=0;for(let r=0;r<e;r++){const e=t[r];(e<=-32768||e>=32767)&&(i+=1)}return i/e}const l=window.requestAnimationFrame||window.webkitRequestAnimationFrame;function u(t,e="Assert failed"){if(!t)throw console.trace(e),new Error(e)}function d(t,e,i,r=""){u(t>=e&&t<=i,`Value ${r} should be between ${e} and ${i}`)}const c="undefined"!=typeof window&&void 0!==window.document;function p(){return u(c,"This feature is only available in browser environments")}const f="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;function m(t){return new Date(1e3*(t+946684800))}function g(t,e){return 100*t*(1/e)/100}var y;(y=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",y.USA="USA",y.JPN="JPN",y.UNKNOWN="UNKNOWN";const v=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/;function _(t){return v.test(t)}function b(e){switch(e.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function w(e){if(_(e))switch(e.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}switch(e.slice(0,2)){case"00":return t.FlipnoteRegion.JPN;case"02":return t.FlipnoteRegion.USA;case"04":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}!function(){if(!c)return function(){};var t=document.createElement("a")}();var S,x;(S=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",S.KWZ="KWZ",(x=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[x.BGM=0]="BGM",x[x.SE1=1]="SE1",x[x.SE2=2]="SE2",x[x.SE3=3]="SE3",x[x.SE4=4]="SE4";class A extends i{constructor(){super(...arguments),this.isFolderIcon=!1,this.isComment=!1,this.isDsiLibraryNote=!1}hasAudioTrack(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0}}const P=[.5,.5,1,2,4,6,12,20,30],F={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]};class T extends A{constructor(e,i={}){super(e),this.format=t.FlipnoteFormat.PPM,this.imageWidth=T.width,this.imageHeight=T.height,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=T.numLayers,this.rawSampleRate=T.rawSampleRate,this.sampleRate=T.sampleRate,this.globalPalette=T.globalPalette,this.prevDecodedFrame=null,this.decodeHeader(),this.decodeAnimationHeader(),this.decodeSoundHeader(),0!=(this.version>>4&15)&&this.decodeMeta(),this.layerBuffers=[new Uint8Array(T.width*T.height),new Uint8Array(T.width*T.height)],this.prevLayerBuffers=[new Uint8Array(T.width*T.height),new Uint8Array(T.width*T.height)],this.lineEncodingBuffers=[new Uint8Array(T.height),new Uint8Array(T.height)],this.prevDecodedFrame=null}static validateFSID(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)}static validateFilename(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)}decodeHeader(){u(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()}readFilename(){return`${this.readHex(3)}_${this.readChars(13)}_${this.readUint16().toString().padStart(3,"0")}`}decodeMeta(){u(1704<this.byteLength),this.seek(16);const t=this.readUint16(),e=this.readInt16(),i=this.readWideChars(11),r=this.readWideChars(11),s=this.readWideChars(11),n=this.readHex(8,!0),a=this.readHex(8,!0),o=this.readFilename(),h=this.readFilename(),l=this.readHex(8,!0);this.seek(154);const d=m(this.readInt32());this.seek(1702);const c=this.readUint16();this.thumbFrameIndex=e,this.layerVisibility={1:0==(16&c),2:0==(32&c),3:!1},this.isSpinoff=a!==n||a!==l,this.meta={lock:1===t,loop:1==(c>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:e,timestamp:d,root:{username:i,fsid:l,region:b(l),filename:null},parent:{username:r,fsid:n,region:b(n),filename:o},current:{username:s,fsid:a,region:b(a),filename:h}}}decodeAnimationHeader(){this.seek(1696);const t=this.readUint16(),e=t/4;u(e<=this.frameCount),this.seek(1704);const i=new Uint32Array(e);for(let r=0;r<e;r++){const e=1704+t+this.readUint32();u(e<this.byteLength,`Frame ${r} pointer is out of bounds`),i[r]=e}this.frameOffsets=i}decodeSoundHeader(){let e=1696+this.frameDataLength+this.frameCount;u(e<this.byteLength),e%4!=0&&(e+=4-e%4),this.seek(e);const i=this.readUint32(),r=this.readUint32(),s=this.readUint32(),n=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),u(this.frameSpeed<=8&&this.bgmSpeed<=8),e+=32,this.framerate=P[this.frameSpeed],this.duration=g(this.frameCount,this.framerate),this.bgmrate=P[this.bgmSpeed];const a=new Map;a.set(t.FlipnoteAudioTrack.BGM,{ptr:e,length:i}),a.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=i,length:r}),a.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=r,length:s}),a.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=s,length:n}),this.soundMeta=a}isNewFrame(t){this.seek(this.frameOffsets[t]);return this.readUint8()>>7&1}decodeFrame(t){u(t>-1&&t<this.frameCount,`Frame index ${t} out of bounds`),this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);const e=this.readUint8(),i=e>>7&1,r=e>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);let s=0,n=0;r&&(s=this.readInt8(),n=this.readInt8());for(let t=0;t<2;t++){const e=this.lineEncodingBuffers[t];e.fill(0);for(let t=0;t<e.length;){let i=this.readUint8();0!==i?(e[t++]=3&i,e[t++]=i>>2&3,e[t++]=i>>4&3,e[t++]=i>>6&3):t+=4}}for(let t=0;t<2;t++){const e=this.layerBuffers[t],i=this.lineEncodingBuffers[t];for(let t=0;t<T.height;t++){let r=t*T.width;switch(i[t]){case 0:break;case 1:for(var a=this.readUint32(!1);0!==a;a<<=1,r+=8)if(2147483648&a){let t=this.readUint8();for(let i=0;0!==t;i++,t>>=1)e[r+i]=1&t}break;case 2:e.fill(1,r,r+T.width);for(a=this.readUint32(!1);0!==a;a<<=1,r+=8)if(2147483648&a){let t=this.readUint8();for(let i=0;i<8;i++,t>>=1)e[r+i]=1&t}break;case 3:for(let t=0,i=0;i<T.width;i++)i%8==0&&(t=this.readUint8()),e[r++]=1&t,t>>=1}}}const o=this.layerBuffers[0],h=this.layerBuffers[1],l=this.prevLayerBuffers[0],d=this.prevLayerBuffers[1];if(!i){let t,e;for(let i=0;i<T.height;i++)if(!(i-n<0)){if(i-n>=T.height)break;for(let r=0;r<T.width;r++)if(!(r-s<0)){if(r-s>=T.width)break;t=r+i*T.width,e=t-(s+n*T.width),o[t]^=l[e],h[t]^=d[e]}}}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers}getFrameLayerOrder(t){return[0,1]}getFramePaletteIndices(t){this.seek(this.frameOffsets[t]);const e=this.readUint8(),i=1!=(1&e),r=[i?0:1,i?0:1,2,3];return[i?1:0,r[e>>1&3],r[e>>3&3]]}getFramePalette(t){return this.getFramePaletteIndices(t).map(t=>this.globalPalette[t])}getLayerPixels(t,e){this.prevDecodedFrame!==t&&this.decodeFrame(t);const i=this.getFramePaletteIndices(t),r=this.layerBuffers[e],s=new Uint8Array(T.width*T.height),n=i[e+1];for(let t=0;t<s.length;t++)1===r[t]&&(s[t]=n);return s}getFramePixels(t){const e=this.getFramePaletteIndices(t),i=this.decodeFrame(t),r=new Uint8Array(T.width*T.height),s=i[0],n=i[1],a=e[0],o=e[1],h=e[2];r.fill(a);for(let t=0;t<r.length;t++){const e=s[t],i=n[t];1===e?r[t]=o:1===i&&(r[t]=h)}return r}decodeSoundFlags(){u(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);const t=this.frameCount,e=this.readBytes(t),i=new Array(t);for(let r=0;r<t;r++){const t=e[r];i[r]=[0!=(1&t),0!=(2&t),0!=(4&t)]}return i}getAudioTrackRaw(t){const e=this.soundMeta.get(t);return u(e.ptr+e.length<this.byteLength),this.seek(e.ptr),this.readBytes(e.length)}decodeAudioTrack(t){const e=this.getAudioTrackRaw(t),i=e.length,r=new Int16Array(2*i);let o=0,h=0,l=0,u=0,d=0,c=!0;for(;o<i;){l=c?15&e[o]:e[o++]>>4,c=!c;const t=n[u];let i=t>>3;1&l&&(i+=t>>2),2&l&&(i+=t>>1),4&l&&(i+=t),8&l&&(i=-i),d+=i,d=a(d,-32768,32767),u+=s[l],u=a(u,0,88),r[h++]=d}return r}getAudioTrackPcm(e,i=this.sampleRate){const r=this.decodeAudioTrack(e);let s=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);s=this.rawSampleRate*t}return s!==i?function(t,e,i){const r=t.length,s=r/e*i,n=new Int16Array(s),a=e/i;for(let e=0;e<s;e++)n[e]=o(t,r,Math.floor(e*a));return n}(r,s,i):r}pcmAudioMix(t,e,i=0){const r=t.length,s=e.length;for(let n=0;n<r&&!(i+n>s);n++){const r=e[i+n]+t[n]/2;e[i+n]=a(r,-32768,32767)}}getAudioMasterPcm(e=this.sampleRate){const i=Math.ceil(this.duration*e),r=new Int16Array(i),s=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(s){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(i,r,0)}if(n||a||o){const i=e/this.framerate,s=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,h=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,l=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,u=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const e=Math.ceil(t*i),d=u[t];n&&d[0]&&this.pcmAudioMix(s,r,e),a&&d[1]&&this.pcmAudioMix(h,r,e),o&&d[2]&&this.pcmAudioMix(l,r,e)}}return this.audioClipRatio=h(r),r}}T.defaultSettings={},T.format=t.FlipnoteFormat.PPM,T.width=256,T.height=192,T.numLayers=2,T.rawSampleRate=8192,T.sampleRate=32768,T.globalPalette=[F.WHITE,F.BLACK,F.RED,F.BLUE];const E=[.2,.5,1,2,4,6,8,12,20,24,30],C={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},U=new Uint16Array(16);for(let t=0;t<16;t++)U[t]=(1<<t)-1;const k=new Uint8Array(52488),L=new Uint8Array(52488);var B=0;for(let t=0;t<3;t++)for(let e=0;e<3;e++)for(let i=0;i<3;i++)for(let r=0;r<3;r++)for(let s=0;s<3;s++)for(let n=0;n<3;n++)for(let a=0;a<3;a++)for(let o=0;o<3;o++)k.set([e,t,r,i,n,s,o,a],B),L.set([t,r,i,n,s,o,a,e],B),B+=8;const N=new Uint8Array(256),M=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((t,e)=>{const i=8*t,r=k.subarray(i,i+8),s=L.subarray(i,i+8);N.set(r,8*e),M.set(s,8*e)});class R extends A{constructor(e,i={}){super(e),this.format=t.FlipnoteFormat.KWZ,this.imageWidth=R.width,this.imageHeight=R.height,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=R.numLayers,this.rawSampleRate=R.rawSampleRate,this.sampleRate=R.sampleRate,this.globalPalette=R.globalPalette,this.prevFrameIndex=null,this.bitIndex=0,this.bitValue=0,this.settings=Object.assign(Object.assign({},R.defaultSettings),i),this.layers=[new Uint8Array(R.width*R.height),new Uint8Array(R.width*R.height),new Uint8Array(R.width*R.height)],this.buildSectionMap(),this.sectionMap.has("KIC")?(this.isFolderIcon=!0,this.imageWidth=24,this.imageHeight=24,this.frameCount=1,this.frameSpeed=0,this.framerate=E[0],this.thumbFrameIndex=0,this.getFrameOffsets()):this.sectionMap.has("KSN")?(this.decodeMeta(),this.getFrameOffsets(),this.decodeSoundHeader()):(this.isComment=!0,this.decodeMeta(),this.getFrameOffsets())}buildSectionMap(){this.seek(0);const t=this.byteLength-256,e=new Map;let i=0,r=0;for(;r<t&&i<6;){this.seek(r);const t=this.readChars(4).substring(0,3),s=this.readUint32();e.set(t,{ptr:r,length:s}),r+=s+8,i+=1}this.sectionMap=e,u(e.has("KMC")&&e.has("KMI"))}readBits(t){if(this.bitIndex+t>16){const t=this.readUint16();this.bitValue|=t<<16-this.bitIndex,this.bitIndex-=16}const e=this.bitValue&U[t];return this.bitValue>>=t,this.bitIndex+=t,e}readFsid(){if(this.settings.dsiLibraryNote){return this.readHex(10,!0).slice(2,18)}const t=this.readHex(10);return`${t.slice(0,4)}-${t.slice(4,8)}-${t.slice(8,12)}-${t.slice(12,18)}`.toLowerCase()}readFilename(){const t=this.pointer,e=this.readChars(28);if(28===e.length)return e;this.seek(t);const i=this.readHex(3),r=this.readChars(13),s=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),`${i}_${r}_${s}`}decodeMeta(){if(this.settings.quickMeta)return this.decodeMetaQuick();u(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);const t=m(this.readUint32()),e=m(this.readUint32()),i=(this.readUint32(),this.readFsid()),r=this.readFsid(),s=this.readFsid(),n=this.readWideChars(11),a=this.readWideChars(11),o=this.readWideChars(11),h=this.readFilename(),l=this.readFilename(),d=this.readFilename(),c=this.readUint16(),p=this.readUint16(),f=this.readUint16(),y=this.readUint8(),v=this.readUint8();this.isSpinoff=s!==r||s!==i,this.frameCount=c,this.frameSpeed=y,this.framerate=E[y],this.duration=g(this.frameCount,this.framerate),this.thumbFrameIndex=p,this.layerVisibility={1:0==(1&v),2:0==(2&v),3:0==(3&v)},(_(s)||this.settings.dsiLibraryNote)&&(this.isDsiLibraryNote=!0),this.meta={lock:0!=(1&f),loop:0!=(2&f),isSpinoff:this.isSpinoff,frameCount:c,frameSpeed:y,duration:this.duration,thumbIndex:p,timestamp:e,creationTimestamp:t,root:{username:n,fsid:i,region:w(i),filename:h,isDsiFilename:28!==h.length},parent:{username:a,fsid:r,region:w(r),filename:l,isDsiFilename:28!==l.length},current:{username:o,fsid:s,region:w(s),filename:d,isDsiFilename:28!==d.length}}}decodeMetaQuick(){u(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);const t=this.readUint16(),e=this.readUint16(),i=(this.readUint16(),this.readUint8()),r=this.readUint8();this.frameCount=t,this.thumbFrameIndex=e,this.frameSpeed=i,this.framerate=E[i],this.duration=g(this.frameCount,this.framerate),this.layerVisibility={1:0==(1&r),2:0==(2&r),3:0==(3&r)}}getFrameOffsets(){u(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));const t=this.frameCount,e=this.sectionMap.get("KMI"),i=this.sectionMap.get("KMC");u(e.length/28>=t);const r=new Uint32Array(t),s=new Uint32Array(t),n=[];let a=e.ptr+8,o=i.ptr+12;for(let e=0;e<t;e++){this.seek(a+4);const t=this.readUint16(),i=this.readUint16(),h=this.readUint16();r[e]=a,s[e]=o,a+=28,o+=t+i+h,u(a<this.byteLength,`frame${e} meta pointer out of bounds`),u(o<this.byteLength,`frame${e} data pointer out of bounds`),n.push([t,i,h])}this.frameMetaOffsets=r,this.frameDataOffsets=s,this.frameLayerSizes=n}decodeSoundHeader(){u(this.sectionMap.has("KSN"));let e=this.sectionMap.get("KSN").ptr+8;this.seek(e),this.bgmSpeed=this.readUint32(),u(this.bgmSpeed<=10),this.bgmrate=E[this.bgmSpeed];const i=new Uint32Array(this.buffer,e+4,20),r=new Map;r.set(t.FlipnoteAudioTrack.BGM,{ptr:e+=28,length:i[0]}),r.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=i[0],length:i[1]}),r.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=i[1],length:i[2]}),r.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=i[2],length:i[3]}),r.set(t.FlipnoteAudioTrack.SE4,{ptr:e+=i[3],length:i[4]}),this.soundMeta=r}getFramePaletteIndices(t){this.seek(this.frameMetaOffsets[t]);const e=this.readUint32();return[15&e,e>>8&15,e>>12&15,e>>16&15,e>>20&15,e>>24&15,e>>28&15]}getFramePalette(t){return this.getFramePaletteIndices(t).map(t=>this.globalPalette[t])}getFrameDiffingFlag(t){this.seek(this.frameMetaOffsets[t]);return this.readUint32()>>4&7}getFrameLayerSizes(t){return this.seek(this.frameMetaOffsets[t]+4),[this.readUint16(),this.readUint16(),this.readUint16()]}getFrameLayerDepths(t){return this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]}getFrameAuthor(t){return this.seek(this.frameMetaOffsets[t]+10),this.readHex(10)}getFrameSoundFlags(t){this.seek(this.frameMetaOffsets[t]+23);const e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e),0!=(8&e)]}getFrameCameraFlags(t){this.seek(this.frameMetaOffsets[t]+26);const e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e)]}getFrameLayerOrder(t){const e=this.getFrameLayerDepths(t);return[2,1,0].sort((t,i)=>e[i]-e[t])}decodeFrame(t,e=7,i=!1){u(t>-1&&t<this.frameCount,`Frame index ${t} out of bounds`),this.prevFrameIndex!==t-1&&0!==t&&(i&&(e&=~this.getFrameDiffingFlag(t+1)),0!==e&&this.decodeFrame(t-1,e,!0));let r=this.frameDataOffsets[t];const s=this.frameLayerSizes[t];for(let t=0;t<3&&(!this.settings.dsiLibraryNote||3!==t);t++){this.seek(r);let i=s[t];r+=i;const n=this.layers[t];if(38===i)continue;if(0==(e>>t&1))continue;this.bitIndex=16,this.bitValue=0;let a=0;for(let t=0;t<240;t+=128)for(let e=0;e<320;e+=128)for(let i=0;i<128;i+=8){const r=t+i;if(r>=240)break;for(let t=0;t<128;t+=8){const i=e+t;if(i>=320)break;if(a>0){a-=1;continue}let s=r*R.width+i;const o=this.readBits(3);if(0===o){const t=8*this.readBits(5),e=N.subarray(t,t+8);n.set(e,s),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320)}else if(1===o){const t=8*this.readBits(13),e=k.subarray(t,t+8);n.set(e,s),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320)}else if(2===o){const t=8*this.readBits(5),e=N.subarray(t,t+8),i=M.subarray(t,t+8);n.set(e,s),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320)}else if(3===o){const t=8*this.readBits(13),e=k.subarray(t,t+8),i=L.subarray(t,t+8);n.set(e,s),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320)}else if(4===o){const t=this.readBits(8);for(let e=1;e<255;e<<=1){if(t&e){const t=8*this.readBits(5),e=N.subarray(t,t+8);n.set(e,s)}else{const t=8*this.readBits(13),e=k.subarray(t,t+8);n.set(e,s)}s+=320}}else{if(5===o){a=this.readBits(5);continue}if(7===o){let t,e,i=this.readBits(2);if(0!==this.readBits(1)){const r=8*this.readBits(5),s=8*this.readBits(5);t=N.subarray(r,r+8),e=N.subarray(s,s+8),i=(i+1)%4}else{const i=8*this.readBits(13),r=8*this.readBits(13);t=k.subarray(i,i+8),e=k.subarray(r,r+8)}0===i?(n.set(t,s),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320)):1===i?(n.set(t,s),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(t,s+=320)):2===i?(n.set(t,s),n.set(e,s+=320),n.set(t,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(t,s+=320),n.set(e,s+=320)):3===i&&(n.set(t,s),n.set(e,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320))}}}}}return this.prevFrameIndex=t,this.layers}getLayerPixels(t,e){this.prevFrameIndex!==t&&this.decodeFrame(t);const i=this.layers[e],r=this.getFramePaletteIndices(t),s=2*e+1,n=this.imageWidth,a=this.imageHeight,o=this.imageOffsetX,h=this.imageOffsetY,l=new Uint8Array(n*a);for(let t=h,e=0;e<a;t++,e++)for(let a=o,h=0;h<n;a++,h++){const o=e*n+h;let u=i[t*R.width+a];1===u?l[o]=r[s]:2===u&&(l[o]=r[s+1])}return l}getFramePixels(t){this.prevFrameIndex!==t&&this.decodeFrame(t);const e=this.getFrameLayerOrder(t),i=this.layers[e[2]],r=this.layers[e[1]],s=this.layers[e[0]],n=this.getFramePaletteIndices(t),a=2*e[2],o=2*e[1],h=2*e[0],l=this.imageWidth,u=this.imageHeight,d=this.imageOffsetX,c=this.imageOffsetY,p=new Uint8Array(l*u);p.fill(n[0]);for(let t=c,e=0;e<u;t++,e++)for(let u=d,c=0;c<l;u++,c++){const d=t*R.width+u,f=e*l+c,m=i[d],g=r[d],y=s[d];0!==m?p[f]=n[a+m]:0!==g?p[f]=n[o+g]:0!==y&&(p[f]=n[h+y])}return p}decodeSoundFlags(){const t=[];for(let e=0;e<this.frameCount;e++)t.push(this.getFrameSoundFlags(e));return t}getAudioTrackRaw(t){const e=this.soundMeta.get(t);return u(e.ptr+e.length<this.byteLength),new Uint8Array(this.buffer,e.ptr,e.length)}decodeAudioTrack(t){const e=this.getAudioTrackRaw(t),i=new Int16Array(981840);let o=0,h=0,l=0,u=0,d=0,c=0;(this.settings.originalAudio||this.isDsiLibraryNote)&&(l=40);for(let t=0;t<e.length;t++){let p=e[t],f=0;for(;f<8;)l<18||f>4?(u=3&p,d=n[l],c=d>>3,1&u&&(c+=d),2&u&&(c=-c),h+=c,l+=r[u],p>>=2,f+=2):(u=15&p,d=n[l],c=d>>3,1&u&&(c+=d>>2),2&u&&(c+=d>>1),4&u&&(c+=d),8&u&&(c=-c),h+=c,l+=s[u],p>>=4,f+=4),l=a(l,0,79),h=a(h,-2048,2047),i[o]=16*h,o+=1}return i.slice(0,o)}getAudioTrackPcm(e,i=this.sampleRate){const r=this.decodeAudioTrack(e);let s=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);s=this.rawSampleRate*t}return s!==i?function(t,e,i){const r=t.length,s=r/e*i,n=new Int16Array(s),a=e/i;for(let e=0,i=0,h=0,l=0;e<s;e++)i=e*a,h=Math.floor(i),l=i%1,n[e]=(1-l)*o(t,r,h)+l*o(t,r,h+1);return n}(r,s,i):r}pcmAudioMix(t,e,i=0){const r=t.length,s=e.length;for(let n=0;n<r&&!(i+n>s);n++){const r=e[i+n]+t[n];e[i+n]=a(r,-32768,32767)}}getAudioMasterPcm(e=this.sampleRate){const i=Math.ceil(this.duration*e),r=new Int16Array(i),s=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),l=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(s){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(i,r,0)}if(n||a||o||l){const i=e/this.framerate,s=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,h=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,u=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,d=l?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,e):null;for(let t=0;t<this.frameCount;t++){const e=this.getFrameSoundFlags(t),c=Math.ceil(t*i);n&&e[0]&&this.pcmAudioMix(s,r,c),a&&e[1]&&this.pcmAudioMix(h,r,c),o&&e[2]&&this.pcmAudioMix(u,r,c),l&&e[3]&&this.pcmAudioMix(d,r,c)}}return this.audioClipRatio=h(r),r}}R.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,originalAudio:!1},R.format=t.FlipnoteFormat.KWZ,R.width=320,R.height=240,R.numLayers=3,R.rawSampleRate=16364,R.sampleRate=32768,R.globalPalette=[C.WHITE,C.BLACK,C.RED,C.YELLOW,C.GREEN,C.BLUE,C.NONE];const I=[{matches:function(t){return c&&"string"==typeof t},load:function(t,e,i){const r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(t){4===r.readyState&&(r.status>=200&&r.status<300?e(r.response):i({type:"httpError",status:r.status,statusText:r.statusText}))},r.send(null)}},{matches:function(t){return f&&"string"==typeof t},load:function(t,e,i){require("https").get(t,t=>{const r=[];t.on("data",t=>r.push(t)),t.on("end",()=>{const t=Buffer.concat(r);e(t.buffer)}),t.on("error",t=>i(t))})}},{matches:function(t){return c&&"undefined"!=typeof File&&t instanceof File},load:function(t,e,i){u("undefined"!=typeof FileReader);const r=new FileReader;r.onload=t=>{e(r.result)},r.onerror=t=>{i({type:"fileReadError"})},r.readAsArrayBuffer(t)}},{matches:function(t){return f&&t instanceof Buffer},load:function(t,e,i){e(t.buffer)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,i){e(t)}}];function z(t,e){return function(t){return new Promise((e,i)=>{for(let r=0;r<I.length;r++){const s=I[r];if(s.matches(t))return s.load(t,e,i)}i("No loader available for source type")})}(t).then(t=>new Promise((i,r)=>{const s=new Uint8Array(t.slice(0,4)),n=s[0]<<24|s[1]<<16|s[2]<<8|s[3];1346458177===n?i(new T(t,e)):1262897152==(4294967040&n)||1263092480==(4294967040&n)?i(new R(t,e)):r("Could not identify source as a valid Flipnote file")}))}var O;!function(t){t.__Any="any",t.Play="play",t.Pause="pause",t.CanPlay="canplay",t.CanPlayThrough="canplaythrough",t.SeekStart="seeking",t.SeekEnd="seeked",t.Duration="durationchange",t.Loop="loop",t.Ended="ended",t.VolumeChange="volumechange",t.Progress="progress",t.TimeUpdate="timeupdate",t.FrameUpdate="frameupdate",t.FrameNext="framenext",t.FramePrev="frameprev",t.FrameFirst="framefirst",t.FrameLast="framelast",t.Ready="ready",t.Load="load",t.LoadStart="loadstart",t.LoadedData="loadeddata",t.LoadedMeta="loadedmetadata",t.Emptied="emptied",t.Close="close",t.Error="error",t.Destroy="destroy"}(O||(O={}));const D=[O.Play,O.Pause,O.CanPlay,O.CanPlayThrough,O.SeekStart,O.SeekEnd,O.Duration,O.Loop,O.Ended,O.VolumeChange,O.Progress,O.TimeUpdate,O.FrameUpdate,O.FrameNext,O.FramePrev,O.FrameFirst,O.FrameLast,O.Ready,O.Load,O.LoadStart,O.LoadedData,O.LoadedMeta,O.Emptied,O.Close,O.Error];function V(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const $="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function H(t,e){return"undefined"!=typeof WebGLTexture&&e instanceof WebGLTexture}const W="";function q(t,e,i,r){if(s=e,"undefined"!=typeof WebGLBuffer&&s instanceof WebGLBuffer)return e;var s;i=i||34962;const n=t.createBuffer();return function(t,e,i,r,s){t.bindBuffer(e,i),t.bufferData(e,r,s||35044)}(t,i,n,e,r),n}function j(t){return"indices"===t}const G=/coord|texture/i,K=/color|colour/i;function X(t,e){let i;if(i=G.test(t)?2:K.test(t)?4:3,e%i>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${i} but ${e} values is not evenly divisible by ${i}. You should specify it.`);return i}function Y(t,e){if($(t))return t;if($(t.data))return t.data;Array.isArray(t)&&(t={data:t});let i=t.type;return i||(i=j(e)?Uint16Array:Float32Array),new i(t.data)}function J(t,e){const i={};return Object.keys(e).forEach((function(r){if(!j(r)){const n=e[r],a=n.attrib||n.name||n.attribName||W+r;if(n.value){if(!Array.isArray(n.value)&&!$(n.value))throw new Error("array.value is not array or typedarray");i[a]={value:n.value}}else{let e,o,h,l;if(n.buffer&&n.buffer instanceof WebGLBuffer)e=n.buffer,l=n.numComponents||n.size,o=n.type,h=n.normalize;else if("number"==typeof n||"number"==typeof n.data){const i=n.data||n,a=n.type||Float32Array,u=i*a.BYTES_PER_ELEMENT;o=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(a),h=void 0!==n.normalize?n.normalize:(s=a)===Int8Array||s===Uint8Array,l=n.numComponents||n.size||X(r,i),e=t.createBuffer(),t.bindBuffer(34962,e),t.bufferData(34962,u,n.drawType||35044)}else{const i=Y(n,r);e=q(t,i,void 0,n.drawType),o=V(i),h=void 0!==n.normalize?n.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(i),l=function(t,e){return t.numComponents||t.size||X(e,function(t){return t.length?t:t.data}(t).length)}(n,r)}i[a]={buffer:e,numComponents:l,type:o,normalize:h,stride:n.stride||0,offset:n.offset||0,divisor:void 0===n.divisor?void 0:n.divisor,drawType:n.drawType}}}var s})),t.bindBuffer(34962,null),i}const Z=["position","positions","a_position"];function Q(t,e,i){const r=J(t,e),s=Object.assign({},i||{});s.attribs=Object.assign({},i?i.attribs:{},r);const n=e.indices;if(n){const e=Y(n,"indices");s.indices=q(t,e,34963),s.numElements=e.length,s.elementType=V(e)}else s.numElements||(s.numElements=function(t,e){let i,r;for(r=0;r<Z.length&&(i=Z[r],!(i in e))&&(i=W+i,!(i in e));++r);r===Z.length&&(i=Object.keys(e)[0]);const s=e[i];t.bindBuffer(34962,s.buffer);const n=t.getBufferParameter(34962,34660);var a;t.bindBuffer(34962,null);const o=n/(5120===(a=s.type)||5121===a?1:5122===a||5123===a?2:5124===a||5125===a||5126===a?4:0),h=s.numComponents||s.size,l=o/h;if(l%1!=0)throw new Error(`numComponents ${h} not correct for length ${length}`);return l}(t,s.attribs));return s}function tt(t){return!!t.texStorage2D}const et={};function it(t,e){return et[e].bindPoint}function rt(t,e){return function(i){t.uniform1i(e,i)}}function st(t,e){return function(i){t.uniform1iv(e,i)}}function nt(t,e){return function(i){t.uniform2iv(e,i)}}function at(t,e){return function(i){t.uniform3iv(e,i)}}function ot(t,e){return function(i){t.uniform4iv(e,i)}}function ht(t,e,i,r){const s=it(0,e);return tt(t)?function(e){let n,a;H(0,e)?(n=e,a=null):(n=e.texture,a=e.sampler),t.uniform1i(r,i),t.activeTexture(33984+i),t.bindTexture(s,n),t.bindSampler(i,a)}:function(e){t.uniform1i(r,i),t.activeTexture(33984+i),t.bindTexture(s,e)}}function lt(t,e,i,r,s){const n=it(0,e),a=new Int32Array(s);for(let t=0;t<s;++t)a[t]=i+t;return tt(t)?function(e){t.uniform1iv(r,a),e.forEach((function(e,r){let s,o;t.activeTexture(33984+a[r]),H(0,e)?(s=e,o=null):(s=e.texture,o=e.sampler),t.bindSampler(i,o),t.bindTexture(n,s)}))}:function(e){t.uniform1iv(r,a),e.forEach((function(e,i){t.activeTexture(33984+a[i]),t.bindTexture(n,e)}))}}function ut(t,e){return function(i){if(i.value)switch(t.disableVertexAttribArray(e),i.value.length){case 4:t.vertexAttrib4fv(e,i.value);break;case 3:t.vertexAttrib3fv(e,i.value);break;case 2:t.vertexAttrib2fv(e,i.value);break;case 1:t.vertexAttrib1fv(e,i.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i.numComponents||i.size,i.type||5126,i.normalize||!1,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(e,i.divisor)}}function dt(t,e){return function(i){if(i.value){if(t.disableVertexAttribArray(e),4!==i.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(e,i.value)}else t.bindBuffer(34962,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,i.numComponents||i.size,i.type||5124,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(e,i.divisor)}}function ct(t,e){return function(i){if(i.value){if(t.disableVertexAttribArray(e),4!==i.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(e,i.value)}else t.bindBuffer(34962,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,i.numComponents||i.size,i.type||5125,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(e,i.divisor)}}function pt(t,e,i){const r=i.size,s=i.count;return function(i){t.bindBuffer(34962,i.buffer);const n=i.size||i.numComponents||r,a=n/s,o=i.type||5126,h=et[o].size*n,l=i.normalize||!1,u=i.offset||0,d=h/s;for(let r=0;r<s;++r)t.enableVertexAttribArray(e+r),t.vertexAttribPointer(e+r,a,o,l,h,u+d*r),void 0!==i.divisor&&t.vertexAttribDivisor(e+r,i.divisor)}}et[5126]={Type:Float32Array,size:4,setter:function(t,e){return function(i){t.uniform1f(e,i)}},arraySetter:function(t,e){return function(i){t.uniform1fv(e,i)}}},et[35664]={Type:Float32Array,size:8,setter:function(t,e){return function(i){t.uniform2fv(e,i)}}},et[35665]={Type:Float32Array,size:12,setter:function(t,e){return function(i){t.uniform3fv(e,i)}}},et[35666]={Type:Float32Array,size:16,setter:function(t,e){return function(i){t.uniform4fv(e,i)}}},et[5124]={Type:Int32Array,size:4,setter:rt,arraySetter:st},et[35667]={Type:Int32Array,size:8,setter:nt},et[35668]={Type:Int32Array,size:12,setter:at},et[35669]={Type:Int32Array,size:16,setter:ot},et[5125]={Type:Uint32Array,size:4,setter:function(t,e){return function(i){t.uniform1ui(e,i)}},arraySetter:function(t,e){return function(i){t.uniform1uiv(e,i)}}},et[36294]={Type:Uint32Array,size:8,setter:function(t,e){return function(i){t.uniform2uiv(e,i)}}},et[36295]={Type:Uint32Array,size:12,setter:function(t,e){return function(i){t.uniform3uiv(e,i)}}},et[36296]={Type:Uint32Array,size:16,setter:function(t,e){return function(i){t.uniform4uiv(e,i)}}},et[35670]={Type:Uint32Array,size:4,setter:rt,arraySetter:st},et[35671]={Type:Uint32Array,size:8,setter:nt},et[35672]={Type:Uint32Array,size:12,setter:at},et[35673]={Type:Uint32Array,size:16,setter:ot},et[35674]={Type:Float32Array,size:16,setter:function(t,e){return function(i){t.uniformMatrix2fv(e,!1,i)}}},et[35675]={Type:Float32Array,size:36,setter:function(t,e){return function(i){t.uniformMatrix3fv(e,!1,i)}}},et[35676]={Type:Float32Array,size:64,setter:function(t,e){return function(i){t.uniformMatrix4fv(e,!1,i)}}},et[35685]={Type:Float32Array,size:24,setter:function(t,e){return function(i){t.uniformMatrix2x3fv(e,!1,i)}}},et[35686]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix2x4fv(e,!1,i)}}},et[35687]={Type:Float32Array,size:24,setter:function(t,e){return function(i){t.uniformMatrix3x2fv(e,!1,i)}}},et[35688]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix3x4fv(e,!1,i)}}},et[35689]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix4x2fv(e,!1,i)}}},et[35690]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix4x3fv(e,!1,i)}}},et[35678]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:3553},et[35680]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:34067},et[35679]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:32879},et[35682]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:3553},et[36289]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:35866},et[36292]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:35866},et[36293]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:34067},et[36298]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:3553},et[36299]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:32879},et[36300]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:34067},et[36303]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:35866},et[36306]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:3553},et[36307]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:32879},et[36308]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:34067},et[36311]={Type:null,size:0,setter:ht,arraySetter:lt,bindPoint:35866};const ft={};function mt(t){const e=t.name;return e.startsWith("gl_")||e.startsWith("webgl_")}function gt(t,e){const i=t.uniformSetters||t,r=arguments.length;for(let t=1;t<r;++t){const e=arguments[t];if(Array.isArray(e)){const t=e.length;for(let r=0;r<t;++r)gt(i,e[r])}else for(const t in e){const r=i[t];r&&r(e[t])}}}function yt(t,e){const i={program:e,uniformSetters:function(t,e){let i=0;function r(e,r,s){const n=r.name.endsWith("[0]"),a=r.type,o=et[a];if(!o)throw new Error("unknown type: 0x"+a.toString(16));let h;if(o.bindPoint){const e=i;i+=r.size,h=n?o.arraySetter(t,a,e,s,r.size):o.setter(t,a,e,s,r.size)}else h=o.arraySetter&&n?o.arraySetter(t,s):o.setter(t,s);return h.location=s,h}const s={},n=t.getProgramParameter(e,35718);for(let i=0;i<n;++i){const n=t.getActiveUniform(e,i);if(mt(n))continue;let a=n.name;a.endsWith("[0]")&&(a=a.substr(0,a.length-3));const o=t.getUniformLocation(e,n.name);o&&(s[a]=r(0,n,o))}return s}(t,e),attribSetters:function(t,e){const i={},r=t.getProgramParameter(e,35721);for(let s=0;s<r;++s){const r=t.getActiveAttrib(e,s);if(mt(r))continue;const n=t.getAttribLocation(e,r.name),a=ft[r.type],o=a.setter(t,n,a);o.location=n,i[r.name]=o}return i}(t,e)};return tt(t)&&(i.uniformBlockSpec=function(t,e){const i=t.getProgramParameter(e,35718),r=[],s=[];for(let n=0;n<i;++n){s.push(n),r.push({});const i=t.getActiveUniform(e,n);if(mt(i))break;r[n].name=i.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(i){const n=i[0],a=i[1];t.getActiveUniforms(e,s,t[n]).forEach((function(t,e){r[e][a]=t}))}));const n={},a=t.getProgramParameter(e,35382);for(let i=0;i<a;++i){const r=t.getActiveUniformBlockName(e,i),s={index:t.getUniformBlockIndex(e,r),usedByVertexShader:t.getActiveUniformBlockParameter(e,i,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(e,i,35398),size:t.getActiveUniformBlockParameter(e,i,35392),uniformIndices:t.getActiveUniformBlockParameter(e,i,35395)};s.used=s.usedByVertexShader||s.usedByFragmentShader,n[r]=s}return{blockSpecs:n,uniformData:r}}(t,e),i.transformFeedbackInfo=function(t,e){const i={},r=t.getProgramParameter(e,35971);for(let s=0;s<r;++s){const r=t.getTransformFeedbackVarying(e,s);i[r.name]={index:s,type:r.type,size:r.size}}return i}(t,e)),i}ft[5126]={size:4,setter:ut},ft[35664]={size:8,setter:ut},ft[35665]={size:12,setter:ut},ft[35666]={size:16,setter:ut},ft[5124]={size:4,setter:dt},ft[35667]={size:8,setter:dt},ft[35668]={size:12,setter:dt},ft[35669]={size:16,setter:dt},ft[5125]={size:4,setter:ct},ft[36294]={size:8,setter:ct},ft[36295]={size:12,setter:ct},ft[36296]={size:16,setter:ct},ft[35670]={size:4,setter:dt},ft[35671]={size:8,setter:dt},ft[35672]={size:12,setter:dt},ft[35673]={size:16,setter:dt},ft[35674]={size:4,setter:pt,count:2},ft[35675]={size:9,setter:pt,count:3},ft[35676]={size:16,setter:pt,count:4};var vt="#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}";class _t{constructor(t,e=640,i=480,r={}){this.refs={programs:[],shaders:[],textures:[],buffers:[],framebuffers:[]},this.isCtxLost=!1,this.handleContextLoss=t=>{t.preventDefault(),this.destroy(),this.isCtxLost=!0,this.options.onlost()},this.handleContextRestored=t=>{this.isCtxLost=!1,this.init(),this.options.onrestored()},p(),this.el=t,this.width=e,this.height=i,this.options=Object.assign(Object.assign({},_t.defaultOptions),r),t.addEventListener("webglcontextlost",this.handleContextLoss,!1),t.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.gl=t.getContext("webgl",{antialias:!1,alpha:!0}),this.init()}init(){const t=this.gl;this.layerDrawProgram=this.createProgram(vt,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_palette;uniform sampler2D u_bitmap;uniform float u_paletteOffset;const vec4 transparent=vec4(0,0,0,0);void main(){float index=texture2D(u_bitmap,v_uv).a*255.;if(index>0.){gl_FragColor=texture2D(u_palette,vec2((u_paletteOffset+index)/8.,.5));}else{gl_FragColor=transparent;}}"),this.postProcessProgram=this.createProgram(vt,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,8,8),this.setBuffersAndAttribs(this.layerDrawProgram,this.quadBuffer),this.setBuffersAndAttribs(this.postProcessProgram,this.quadBuffer),this.paletteData=new Uint8Array(32),this.paletteTexture=this.createTexture(t.RGBA,t.NEAREST,t.CLAMP_TO_EDGE,8,1),this.layerTexture=this.createTexture(t.ALPHA,t.NEAREST,t.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameBuffer=this.createFrameBuffer(this.frameTexture),this.setCanvasSize(this.width,this.height)}createProgram(t,e){u(!this.isCtxLost);const i=this.gl,r=this.createShader(i.VERTEX_SHADER,t),s=this.createShader(i.FRAGMENT_SHADER,e),n=i.createProgram();if(i.attachShader(n,r),i.attachShader(n,s),i.linkProgram(n),!i.getProgramParameter(n,i.LINK_STATUS)){const t=i.getProgramInfoLog(n);throw i.deleteProgram(n),new Error(t)}const a=yt(i,n);return this.refs.programs.push(n),a}createShader(t,e){u(!this.isCtxLost);const i=this.gl,r=i.createShader(t);if(i.shaderSource(r,e),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){const t=i.getShaderInfoLog(r);throw i.deleteShader(r),new Error(t)}return this.refs.shaders.push(r),r}createScreenQuad(t,e,i,r,s,n){u(!this.isCtxLost);const a=(s+1)*(n+1),o=s+1,h=new Float32Array(2*a),l=new Float32Array(2*a);let d=0,c=0;for(let a=0;a<=n;a++)for(let o=0;o<=s;o++){const u=o/s,p=a/n;h[d++]=t+i*u,h[d++]=e+r*p,l[c++]=u,l[c++]=p}const p=new Uint16Array(s*n*2*3);let f=0;for(let t=0;t<n;t++)for(let e=0;e<s;e++)p[f++]=(t+0)*o+e,p[f++]=(t+1)*o+e,p[f++]=(t+0)*o+e+1,p[f++]=(t+0)*o+e+1,p[f++]=(t+1)*o+e,p[f++]=(t+1)*o+e+1;const m=Q(this.gl,{position:{numComponents:2,data:h},texcoord:{numComponents:2,data:l},indices:p});for(let t in m.attribs)this.refs.buffers.push(m.attribs[t].buffer);return m}setBuffersAndAttribs(t,e){const i=this.gl;!function(t,e){for(const i in e){const r=t[i];r&&r(e[i])}}(t.attribSetters,e.attribs),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.indices)}createTexture(t,e,i,r=1,s=1){u(!this.isCtxLost);const n=this.gl,a=n.createTexture();return n.bindTexture(n.TEXTURE_2D,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,e),n.texImage2D(n.TEXTURE_2D,0,t,r,s,0,t,n.UNSIGNED_BYTE,null),this.refs.textures.push(a),a}createFrameBuffer(t){u(!this.isCtxLost);const e=this.gl,i=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,i),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),this.refs.framebuffers.push(i),i}setCanvasSize(t,e){u(!this.isCtxLost);const i=window.devicePixelRatio||1,r=t*i,s=e*i;this.width=t,this.height=e,this.el.width=r,this.el.height=s,this.screenWidth=r,this.screenHeight=s,this.el.style.width=t+"px",this.el.style.height=e+"px"}setInputSize(t,e){const i=this.gl;this.textureWidth=t,this.textureHeight=e,i.bindTexture(i.TEXTURE_2D,this.frameTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.textureWidth,this.textureHeight,0,i.RGBA,i.UNSIGNED_BYTE,null)}clearFrameBuffer(t){u(!this.isCtxLost);const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),e.viewport(0,0,this.textureWidth,this.textureHeight);const[i,r,s,n]=t;e.clearColor(i/255,r/255,s/255,n/255),e.clear(e.COLOR_BUFFER_BIT)}setPalette(t){u(!this.isCtxLost),u(t.length<16);const e=this.gl,i=this.paletteData.fill(0);let r=0;for(let e=0;e<t.length;e++){const[s,n,a,o]=t[e];i[r++]=s,i[r++]=n,i[r++]=a,i[r++]=o}e.bindTexture(e.TEXTURE_2D,this.paletteTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,8,1,0,e.RGBA,e.UNSIGNED_BYTE,i)}drawPixels(t,e){const{gl:i,layerDrawProgram:r,layerTexture:s,textureWidth:n,textureHeight:a}=this;u(!this.isCtxLost),u(t.length===n*a),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.viewport(0,0,n,a),i.useProgram(r.program),i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,i.ALPHA,n,a,0,i.ALPHA,i.UNSIGNED_BYTE,t),gt(r,{u_palette:this.paletteTexture,u_paletteOffset:e,u_bitmap:s,u_textureSize:[n,a],u_screenSize:[i.drawingBufferWidth,i.drawingBufferHeight]}),i.drawElements(i.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}composite(){const t=this.gl;u(!this.isCtxLost),t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.useProgram(this.postProcessProgram.program),t.clear(t.COLOR_BUFFER_BIT),gt(this.postProcessProgram,{u_flipY:!0,u_tex:this.frameTexture,u_textureSize:[this.textureWidth,this.textureHeight],u_screenSize:[t.drawingBufferWidth,t.drawingBufferHeight]}),t.drawElements(t.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}isErrorState(){const t=this.gl,e=t.getError();return e!=t.NO_ERROR&&e!=t.CONTEXT_LOST_WEBGL}isLost(){return this.gl.isContextLost()}async destroy(){const t=this.refs,e=this.gl;t.shaders.forEach(t=>{e.deleteShader(t)}),t.shaders=[],t.framebuffers.forEach(t=>{e.deleteFramebuffer(t)}),t.framebuffers=[],t.textures.forEach(t=>{e.deleteTexture(t)}),t.textures=[],t.buffers.forEach(t=>{e.deleteBuffer(t)}),t.buffers=[],t.programs.forEach(t=>{e.deleteProgram(t)}),t.programs=[],this.paletteData=null,e.canvas.width=1,e.canvas.height=1}}_t.defaultOptions={onlost:()=>{},onrestored:()=>{}};const bt=c?window.AudioContext||window.webkitAudioContext:null;class wt{constructor(){this.useEq=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this._volume=1,this._loop=!1,this.nodeRefs=[],p()}set volume(t){this.setVolume(t)}get volume(){return this._volume}set loop(t){this._loop=t,this.source&&(this.source.loop=t)}get loop(){return this._loop}getCtx(){return this.ctx||(this.ctx=new bt),this.ctx}setBuffer(t,e){const i=this.getCtx(),r=t.length,s=i.createBuffer(1,r,e),n=s.getChannelData(0);if(t instanceof Float32Array)n.set(t,0);else if(t instanceof Int16Array)for(let e=0;e<r;e++)n[e]=t[e]/32768;this.buffer=s,this.sampleRate=e}connectEqNodesTo(t){const e=this.getCtx(),i=this.eqSettings;let r=t;return i.forEach(([t,s],n)=>{const a=e.createBiquadFilter();this.nodeRefs.push(a),a.frequency.value=t,a.gain.value=s,0===n?a.type="lowshelf":n===i.length-1?a.type="highshelf":a.type="peaking",r.connect(a),r=a}),r}initNodes(){const t=this.getCtx();this.nodeRefs=[];const e=t.createBufferSource();this.nodeRefs.push(e),e.buffer=this.buffer;const i=t.createGain();if(this.nodeRefs.push(i),this.useEq){this.connectEqNodesTo(e).connect(i)}else e.connect(i);e.connect(i),i.connect(t.destination),this.source=e,this.gainNode=i,this.setVolume(this._volume)}setVolume(t){this._volume=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))}playFrom(t){this.initNodes(),this.source.loop=this._loop,this.source.start(0,t)}stop(){this.source&&this.source.stop(0)}async destroy(){this.stop();const t=this.getCtx();this.nodeRefs.forEach(t=>t.disconnect()),this.nodeRefs=[],"closed"!==t.state&&"function"==typeof t.close&&await t.close(),this.buffer=null}}function St(t){return{length:t.length,start:e=>t[e][0],end:e=>t[e][1]}}function xt(t,e){return t.toString().padStart(e,"0")}function At(t){return`${Math.floor(t%3600/60)}:${xt(Math.floor(t%60),2)}`}class Pt{constructor(t,e,i){this.duration=0,this.autoplay=!1,this.supportedEvents=D,this._src=null,this._loop=!1,this._volume=1,this._muted=!1,this._frame=null,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=t=>{if(!this.isPlaying)return;const e=t/1e3,i=e-this.playbackStartTime;i>=this.duration&&(this.loop?(this.playbackStartTime=e,this.emit(O.Loop)):(this.pause(),this.emit(O.Ended))),this.setCurrentTime(i%this.duration),this.playbackLoopId=requestAnimationFrame(this.playbackLoop)},p(),t="string"==typeof t?document.querySelector(t):t,this.renderer=new _t(t,e,i,{onlost:()=>this.emit(O.Error),onrestored:()=>this.load()}),this.audio=new wt,this.canvasEl=this.renderer.el}get src(){return this._src}set src(t){this.load(t)}get paused(){return!this.isPlaying}set paused(t){t?this.pause():this.play()}get currentFrame(){return this._frame}set currentFrame(t){this.setCurrentFrame(t)}get currentTime(){return this.isNoteLoaded?this.playbackTime:null}set currentTime(t){this.setCurrentTime(t)}get progress(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null}set progress(t){this.setProgress(t)}get volume(){return this.getVolume()}set volume(t){this.setVolume(t)}get muted(){return this.getMuted()}set muted(t){this.setMuted(t)}get loop(){return this.getLoop()}set loop(t){this.setLoop(t)}get framerate(){return this.note.framerate}get frameCount(){return this.note.frameCount}get frameSpeed(){return this.note.frameSpeed}get buffered(){return St([[0,this.duration]])}get seekable(){return St([[0,this.duration]])}get currentSrc(){return this._src}get videoWidth(){return this.isNoteLoaded?this.note.imageWidth:0}get videoHeight(){return this.isNoteLoaded?this.note.imageHeight:0}async load(t=null){return this.isNoteLoaded&&this.closeNote(),t?(this.emit(O.LoadStart),z(t).then(e=>{this.openNote(e),this._src=t}).catch(t=>{throw this.emit(O.Error,t),new Error("Error loading Flipnote: "+t.message)})):this.openNote(this.note)}closeNote(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this._src=null,this._frame=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clearFrameBuffer([0,0,0,0])}openNote(t){this.isNoteLoaded&&this.closeNote(),this.note=t,this.meta=t.meta,this.emit(O.LoadedMeta),this.noteFormat=t.format,this.duration=t.duration,this.playbackTime=0,this._frame=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=t.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(t.getAudioMasterPcm(),t.sampleRate),this.emit(O.CanPlay),this.emit(O.CanPlayThrough),this.setLoop(t.meta.loop),this.renderer.setInputSize(t.imageWidth,t.imageHeight),this.drawFrame(t.thumbFrameIndex),this.emit(O.LoadedData),this.emit(O.Load),this.emit(O.Ready),this.autoplay&&this.play()}setCurrentTime(t){this.assertNoteLoaded();const e=Math.floor(t/(1/this.framerate));this.setCurrentFrame(e),this.playbackTime=t,this.emit(O.Progress,this.progress)}getCurrentTime(){return this.currentTime}getTimeCounter(){return`${At(Math.max(this.currentTime,0))} / ${At(this.duration)}`}getFrameCounter(){return`${xt(this.currentFrame+1,3)} / ${xt(this.frameCount,3)}`}setProgress(t){this.assertNoteLoaded(),d(t,0,100,"progress"),this.currentTime=this.duration*(t/100)}getProgress(){return this.progress}async play(){if(this.assertNoteLoaded(),this.isPlaying)return;this.isPlaying=!0,this.hasPlaybackStarted=!0;const t=performance.now();this.playbackStartTime=t/1e3-this.playbackTime,this.playAudio(),this.playbackLoop(t),this.emit(O.Play)}pause(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(O.Pause))}togglePlay(){this.isPlaying?this.pause():this.play()}getPaused(){return!this.isPlaying}getDuration(){return this.duration}getLoop(){return this._loop}setLoop(t){this._loop=t,this.audio.loop=t}toggleLoop(){this.setLoop(!this._loop)}setCurrentFrame(t){this.assertNoteLoaded();const e=Math.max(0,Math.min(Math.floor(t),this.frameCount-1));(e!==this.currentFrame||this.showThumbnail)&&(this._frame=e,this.drawFrame(e),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=e*(1/this.framerate),this.emit(O.SeekEnd)),this.emit(O.FrameUpdate,this.currentFrame),this.emit(O.Progress,this.progress),this.emit(O.TimeUpdate,this.currentFrame))}nextFrame(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(O.FrameNext)}prevFrame(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(O.FramePrev)}lastFrame(){this.currentFrame=this.frameCount-1,this.emit(O.FrameLast)}firstFrame(){this.currentFrame=0,this.emit(O.FrameFirst)}thumbnailFrame(){this.currentFrame=this.note.thumbFrameIndex}startSeek(){this.isSeeking||(this.emit(O.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)}seek(t){this.isSeeking&&(this.progress=100*t)}endSeek(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1}drawFrame(e){const i=this.note,r=this.renderer,s=i.getFramePalette(e),n=i.decodeFrame(e),a=this.layerVisibility;if(r.setPalette(s),r.clearFrameBuffer(s[0]),i.format===t.FlipnoteFormat.PPM)a[2]&&r.drawPixels(n[1],1),a[1]&&r.drawPixels(n[0],0);else if(i.format===t.FlipnoteFormat.KWZ){const t=i.getFrameLayerOrder(e),s=t[0],o=t[1],h=t[2];a[s+1]&&r.drawPixels(n[s],2*s),a[o+1]&&r.drawPixels(n[o],2*o),a[h+1]&&r.drawPixels(n[h],2*h)}r.composite()}forceUpdate(){this.isNoteLoaded&&this.drawFrame(this.currentFrame)}resize(t,e){e!==.75*t&&console.warn(`Canvas width to height ratio should be 3:4 for best results (got ${t}x${e})`),this.renderer.setCanvasSize(t,e),this.forceUpdate()}setLayerVisibility(t,e){this.layerVisibility[t]=e,this.forceUpdate()}getLayerVisibility(t){return this.layerVisibility[t]}toggleLayerVisibility(t){this.setLayerVisibility(t,!this.layerVisibility[t])}playAudio(){this.audio.playFrom(this.currentTime)}stopAudio(){this.audio.stop()}toggleAudioEq(){this.setAudioEq(!this.audio.useEq)}setAudioEq(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())}mute(){this.setMuted(!0)}unmute(){this.setMuted(!1)}setMuted(t){this.audio.volume=t?0:this._volume,this._muted=t,this.emit(O.VolumeChange,this.audio.volume)}getMuted(){return 0===this.volume||this._muted}toggleMuted(){this.setMuted(!this._muted)}setVolume(t){d(t,0,1,"volume"),this._volume=t,this.audio.volume=t,this.emit(O.VolumeChange,this.audio.volume)}getVolume(){return this._muted?0:this._volume}seekToNextFrame(){this.nextFrame()}fastSeek(t){this.currentTime=t}canPlayType(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";case"video/vnd.nintendo.ugomemo.fykt":default:return""}}getVideoPlaybackQuality(){return{creationTime:0,droppedVideoFrames:0,totalVideoFrames:this.frameCount}}requestPictureInPicture(){throw new Error("Not implemented")}captureStream(){throw new Error("Not implemented")}on(t,e){const i=this.events;(Array.isArray(t)?t:[t]).forEach(t=>{i.has(t)?i.get(t).push(e):i.set(t,[e])})}off(t,e){const i=this.events;(Array.isArray(t)?t:[t]).forEach(t=>{if(!i.has(t))return;const r=i.get(t);i.set(t,r.splice(r.indexOf(e),1))})}emit(t,...e){const i=this.events;if(t!==O.__Any&&i.has(t)){i.get(t).forEach(t=>t.apply(null,e));const r="on"+t,s=this;"function"==typeof s[r]&&s[r].apply(null,e)}if(i.has(O.__Any)){i.get(O.__Any).forEach(i=>i.apply(null,[t,...e]))}}clearEvents(){this.events.clear()}async destroy(){this.clearEvents(),this.emit(O.Destroy),this.closeNote(),await this.renderer.destroy(),await this.audio.destroy()}supports(t){const e=this.supportedEvents.includes(t),i="function"==typeof this[t];return e||i}assertNoteLoaded(){u(this.isNoteLoaded,"No Flipnote is currently loaded in this player")}}class Ft{constructor(){this.dataUrl=null}getBuffer(){return u(f,"This feature is only available in NodeJS environments"),Buffer.from(this.getArrayBuffer())}getBlob(){return p(),new Blob([this.getArrayBuffer()],{type:this.mimeType})}getUrl(){return p(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())}revokeUrl(){p(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)}}const Tt=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];class Et{constructor(t,e,i){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.colorDepth=i,this.reset()}reset(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}char_out(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)}cl_block(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)}cl_hash(t){for(var e=0;e<t;++e)this.htab[e]=-1}compress(t,e){var i,r,s,n,a,o;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,n=this.nextPixel(),o=0,i=5003;i<65536;i*=2)++o;o=8-o,this.cl_hash(5003),this.output(this.ClearCode,e);t:for(;-1!=(r=this.nextPixel());)if(i=(r<<12)+n,s=r<<o^n,this.htab[s]!==i){if(this.htab[s]>=0){a=5003-s,0===s&&(a=1);do{if((s-=a)<0&&(s+=5003),this.htab[s]===i){n=this.codetab[s];continue t}}while(this.htab[s]>=0)}this.output(n,e),n=r,this.free_ent<4096?(this.codetab[s]=this.free_ent++,this.htab[s]=i):this.cl_block(e)}else n=this.codetab[s];this.output(n,e),this.output(this.EOFCode,e)}encode(t,e){this.pixels=t,e.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,e),e.writeByte(0)}flush_char(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)}get_maxcode(t){return(1<<t)-1}nextPixel(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}output(t,e){for(this.cur_accum&=Tt[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}}}class Ct extends Ft{constructor(t,i,r={}){super(),this.mimeType="gif/image",this.frameCount=0,this.width=t,this.height=i,this.data=new e,this.settings=Object.assign(Object.assign({},Ct.defaultSettings),r),this.compressor=new Et(t,i,r.colorDepth)}static fromFlipnote(t,e={}){var i;const r=new Ct(t.imageWidth,t.imageHeight,Object.assign({delay:100/t.framerate,repeat:(null===(i=t.meta)||void 0===i?void 0:i.loop)?-1:0},e));r.palette=t.globalPalette;for(let e=0;e<t.frameCount;e++)r.writeFrame(t.getFramePixels(e));return r}static fromFlipnoteFrame(t,e,i={}){const r=new Ct(t.imageWidth,t.imageHeight,Object.assign({delay:100/t.framerate,repeat:-1},i));return r.palette=t.globalPalette,r.writeFrame(t.getFramePixels(e)),r}writeFrame(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1}writeFirstFrame(t){const e=this.palette.length;for(var i=1;1<<i<e;i+=1)continue;this.settings.colorDepth=i,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt(),this.writeFrameHeader(),this.writePixels(t)}writeAdditionalFrame(t){this.writeFrameHeader(),this.writePixels(t)}writeHeader(){const t=new i(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.settings.colorDepth-1),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))}writeColorTable(){const t=new Uint8Array(3*Math.pow(2,this.settings.colorDepth));let e=0;for(let i=0;i<this.palette.length;i+=1){const[r,s,n,a]=this.palette[i];t[e++]=r,t[e++]=s,t[e++]=n}this.data.writeBytes(t)}writeNetscapeExt(){const t=new i(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.settings.repeat),this.data.writeBytes(new Uint8Array(t.buffer))}writeFrameHeader(){const t=new i(new ArrayBuffer(18)),e=this.settings.transparentBg?1:0;t.writeBytes([33,249,4,0|e]),t.writeUint16(this.settings.delay),t.writeBytes([0,0]),t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))}writePixels(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)}getArrayBuffer(){return this.data.getBuffer()}getImage(){p();const t=new Image(this.width,this.height);return t.src=this.getUrl(),t}}Ct.defaultSettings={transparentBg:!1,delay:100,repeat:-1,colorDepth:8};class Ut extends Ft{constructor(t,e=1,r=16){super(),this.sampleRate=t,this.channels=e,this.bitsPerSample=r;const s=new ArrayBuffer(44),n=new i(s);n.writeChars("RIFF"),n.writeUint32(0),n.writeChars("WAVE"),n.writeChars("fmt "),n.writeUint32(16),n.writeUint16(1),n.writeUint16(this.channels),n.writeUint32(this.sampleRate),n.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample),n.writeChars("data"),n.writeUint32(0),this.header=n,this.pcmData=null}static fromFlipnote(t){const e=t.sampleRate,i=new Ut(e,1,16),r=t.getAudioMasterPcm(e);return i.writeSamples(r),i}static fromFlipnoteTrack(t,e){const i=t.sampleRate,r=new Ut(i,1,16),s=t.getAudioTrackPcm(e,i);return r.writeSamples(s),r}writeSamples(t){let e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t}getArrayBuffer(){const t=this.header.bytes,e=new Uint8Array(this.pcmData.buffer),i=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return i.set(t),i.set(e,t.byteLength),i.buffer}}function kt(t,e,i,r){for(var s,n=arguments.length,a=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r,o=t.length-1;o>=0;o--)(s=t[o])&&(a=(n<3?s(a):n>3?s(e,i,a):s(e,i))||a);return n>3&&a&&Object.defineProperty(e,i,a),a}const Lt="undefined"!=typeof window&&null!=window.customElements&&void 0!==window.customElements.polyfillWrapFlushCallback,Bt=(t,e,i=null)=>{for(;e!==i;){const i=e.nextSibling;t.removeChild(e),e=i}},Nt=`{{lit-${String(Math.random()).slice(2)}}}`,Mt=`\x3c!--${Nt}--\x3e`,Rt=new RegExp(`${Nt}|${Mt}`);class It{constructor(t,e){this.parts=[],this.element=e;const i=[],r=[],s=document.createTreeWalker(e.content,133,null,!1);let n=0,a=-1,o=0;const{strings:h,values:{length:l}}=t;for(;o<l;){const t=s.nextNode();if(null!==t){if(a++,1===t.nodeType){if(t.hasAttributes()){const e=t.attributes,{length:i}=e;let r=0;for(let t=0;t<i;t++)zt(e[t].name,"$lit$")&&r++;for(;r-- >0;){const e=h[o],i=Vt.exec(e)[2],r=i.toLowerCase()+"$lit$",s=t.getAttribute(r);t.removeAttribute(r);const n=s.split(Rt);this.parts.push({type:"attribute",index:a,name:i,strings:n}),o+=n.length-1}}"TEMPLATE"===t.tagName&&(r.push(t),s.currentNode=t.content)}else if(3===t.nodeType){const e=t.data;if(e.indexOf(Nt)>=0){const r=t.parentNode,s=e.split(Rt),n=s.length-1;for(let e=0;e<n;e++){let i,n=s[e];if(""===n)i=Dt();else{const t=Vt.exec(n);null!==t&&zt(t[2],"$lit$")&&(n=n.slice(0,t.index)+t[1]+t[2].slice(0,-"$lit$".length)+t[3]),i=document.createTextNode(n)}r.insertBefore(i,t),this.parts.push({type:"node",index:++a})}""===s[n]?(r.insertBefore(Dt(),t),i.push(t)):t.data=s[n],o+=n}}else if(8===t.nodeType)if(t.data===Nt){const e=t.parentNode;null!==t.previousSibling&&a!==n||(a++,e.insertBefore(Dt(),t)),n=a,this.parts.push({type:"node",index:a}),null===t.nextSibling?t.data="":(i.push(t),a--),o++}else{let e=-1;for(;-1!==(e=t.data.indexOf(Nt,e+1));)this.parts.push({type:"node",index:-1}),o++}}else s.currentNode=r.pop()}for(const t of i)t.parentNode.removeChild(t)}}const zt=(t,e)=>{const i=t.length-e.length;return i>=0&&t.slice(i)===e},Ot=t=>-1!==t.index,Dt=()=>document.createComment(""),Vt=/([ \x09\x0a\x0c\x0d])([^\0-\x1F\x7F-\x9F "'>=/]+)([ \x09\x0a\x0c\x0d]*=[ \x09\x0a\x0c\x0d]*(?:[^ \x09\x0a\x0c\x0d"'`<>=]*|"[^"]*|'[^']*))$/;function $t(t,e){const{element:{content:i},parts:r}=t,s=document.createTreeWalker(i,133,null,!1);let n=Wt(r),a=r[n],o=-1,h=0;const l=[];let u=null;for(;s.nextNode();){o++;const t=s.currentNode;for(t.previousSibling===u&&(u=null),e.has(t)&&(l.push(t),null===u&&(u=t)),null!==u&&h++;void 0!==a&&a.index===o;)a.index=null!==u?-1:a.index-h,n=Wt(r,n),a=r[n]}l.forEach(t=>t.parentNode.removeChild(t))}const Ht=t=>{let e=11===t.nodeType?0:1;const i=document.createTreeWalker(t,133,null,!1);for(;i.nextNode();)e++;return e},Wt=(t,e=-1)=>{for(let i=e+1;i<t.length;i++){const e=t[i];if(Ot(e))return i}return-1};const qt=new WeakMap,jt=t=>(...e)=>{const i=t(...e);return qt.set(i,!0),i},Gt=t=>"function"==typeof t&&qt.has(t),Kt={},Xt={};class Yt{constructor(t,e,i){this.__parts=[],this.template=t,this.processor=e,this.options=i}update(t){let e=0;for(const i of this.__parts)void 0!==i&&i.setValue(t[e]),e++;for(const t of this.__parts)void 0!==t&&t.commit()}_clone(){const t=Lt?this.template.element.content.cloneNode(!0):document.importNode(this.template.element.content,!0),e=[],i=this.template.parts,r=document.createTreeWalker(t,133,null,!1);let s,n=0,a=0,o=r.nextNode();for(;n<i.length;)if(s=i[n],Ot(s)){for(;a<s.index;)a++,"TEMPLATE"===o.nodeName&&(e.push(o),r.currentNode=o.content),null===(o=r.nextNode())&&(r.currentNode=e.pop(),o=r.nextNode());if("node"===s.type){const t=this.processor.handleTextExpression(this.options);t.insertAfterNode(o.previousSibling),this.__parts.push(t)}else this.__parts.push(...this.processor.handleAttributeExpressions(o,s.name,s.strings,this.options));n++}else this.__parts.push(void 0),n++;return Lt&&(document.adoptNode(t),customElements.upgrade(t)),t}}const Jt=window.trustedTypes&&trustedTypes.createPolicy("lit-html",{createHTML:t=>t}),Zt=` ${Nt} `;class Qt{constructor(t,e,i,r){this.strings=t,this.values=e,this.type=i,this.processor=r}getHTML(){const t=this.strings.length-1;let e="",i=!1;for(let r=0;r<t;r++){const t=this.strings[r],s=t.lastIndexOf("\x3c!--");i=(s>-1||i)&&-1===t.indexOf("--\x3e",s+1);const n=Vt.exec(t);e+=null===n?t+(i?Zt:Mt):t.substr(0,n.index)+n[1]+n[2]+"$lit$"+n[3]+Nt}return e+=this.strings[t],e}getTemplateElement(){const t=document.createElement("template");let e=this.getHTML();return void 0!==Jt&&(e=Jt.createHTML(e)),t.innerHTML=e,t}}const te=t=>null===t||!("object"==typeof t||"function"==typeof t),ee=t=>Array.isArray(t)||!(!t||!t[Symbol.iterator]);class ie{constructor(t,e,i){this.dirty=!0,this.element=t,this.name=e,this.strings=i,this.parts=[];for(let t=0;t<i.length-1;t++)this.parts[t]=this._createPart()}_createPart(){return new re(this)}_getValue(){const t=this.strings,e=t.length-1,i=this.parts;if(1===e&&""===t[0]&&""===t[1]){const t=i[0].value;if("symbol"==typeof t)return String(t);if("string"==typeof t||!ee(t))return t}let r="";for(let s=0;s<e;s++){r+=t[s];const e=i[s];if(void 0!==e){const t=e.value;if(te(t)||!ee(t))r+="string"==typeof t?t:String(t);else for(const e of t)r+="string"==typeof e?e:String(e)}}return r+=t[e],r}commit(){this.dirty&&(this.dirty=!1,this.element.setAttribute(this.name,this._getValue()))}}class re{constructor(t){this.value=void 0,this.committer=t}setValue(t){t===Kt||te(t)&&t===this.value||(this.value=t,Gt(t)||(this.committer.dirty=!0))}commit(){for(;Gt(this.value);){const t=this.value;this.value=Kt,t(this)}this.value!==Kt&&this.committer.commit()}}class se{constructor(t){this.value=void 0,this.__pendingValue=void 0,this.options=t}appendInto(t){this.startNode=t.appendChild(Dt()),this.endNode=t.appendChild(Dt())}insertAfterNode(t){this.startNode=t,this.endNode=t.nextSibling}appendIntoPart(t){t.__insert(this.startNode=Dt()),t.__insert(this.endNode=Dt())}insertAfterPart(t){t.__insert(this.startNode=Dt()),this.endNode=t.endNode,t.endNode=this.startNode}setValue(t){this.__pendingValue=t}commit(){if(null===this.startNode.parentNode)return;for(;Gt(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=Kt,t(this)}const t=this.__pendingValue;t!==Kt&&(te(t)?t!==this.value&&this.__commitText(t):t instanceof Qt?this.__commitTemplateResult(t):t instanceof Node?this.__commitNode(t):ee(t)?this.__commitIterable(t):t===Xt?(this.value=Xt,this.clear()):this.__commitText(t))}__insert(t){this.endNode.parentNode.insertBefore(t,this.endNode)}__commitNode(t){this.value!==t&&(this.clear(),this.__insert(t),this.value=t)}__commitText(t){const e=this.startNode.nextSibling,i="string"==typeof(t=null==t?"":t)?t:String(t);e===this.endNode.previousSibling&&3===e.nodeType?e.data=i:this.__commitNode(document.createTextNode(i)),this.value=t}__commitTemplateResult(t){const e=this.options.templateFactory(t);if(this.value instanceof Yt&&this.value.template===e)this.value.update(t.values);else{const i=new Yt(e,t.processor,this.options),r=i._clone();i.update(t.values),this.__commitNode(r),this.value=i}}__commitIterable(t){Array.isArray(this.value)||(this.value=[],this.clear());const e=this.value;let i,r=0;for(const s of t)i=e[r],void 0===i&&(i=new se(this.options),e.push(i),0===r?i.appendIntoPart(this):i.insertAfterPart(e[r-1])),i.setValue(s),i.commit(),r++;r<e.length&&(e.length=r,this.clear(i&&i.endNode))}clear(t=this.startNode){Bt(this.startNode.parentNode,t.nextSibling,this.endNode)}}class ne{constructor(t,e,i){if(this.value=void 0,this.__pendingValue=void 0,2!==i.length||""!==i[0]||""!==i[1])throw new Error("Boolean attributes can only contain a single expression");this.element=t,this.name=e,this.strings=i}setValue(t){this.__pendingValue=t}commit(){for(;Gt(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=Kt,t(this)}if(this.__pendingValue===Kt)return;const t=!!this.__pendingValue;this.value!==t&&(t?this.element.setAttribute(this.name,""):this.element.removeAttribute(this.name),this.value=t),this.__pendingValue=Kt}}class ae extends ie{constructor(t,e,i){super(t,e,i),this.single=2===i.length&&""===i[0]&&""===i[1]}_createPart(){return new oe(this)}_getValue(){return this.single?this.parts[0].value:super._getValue()}commit(){this.dirty&&(this.dirty=!1,this.element[this.name]=this._getValue())}}class oe extends re{}let he=!1;(()=>{try{const t={get capture(){return he=!0,!1}};window.addEventListener("test",t,t),window.removeEventListener("test",t,t)}catch(t){}})();class le{constructor(t,e,i){this.value=void 0,this.__pendingValue=void 0,this.element=t,this.eventName=e,this.eventContext=i,this.__boundHandleEvent=t=>this.handleEvent(t)}setValue(t){this.__pendingValue=t}commit(){for(;Gt(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=Kt,t(this)}if(this.__pendingValue===Kt)return;const t=this.__pendingValue,e=this.value,i=null==t||null!=e&&(t.capture!==e.capture||t.once!==e.once||t.passive!==e.passive),r=null!=t&&(null==e||i);i&&this.element.removeEventListener(this.eventName,this.__boundHandleEvent,this.__options),r&&(this.__options=ue(t),this.element.addEventListener(this.eventName,this.__boundHandleEvent,this.__options)),this.value=t,this.__pendingValue=Kt}handleEvent(t){"function"==typeof this.value?this.value.call(this.eventContext||this.element,t):this.value.handleEvent(t)}}const ue=t=>t&&(he?{capture:t.capture,passive:t.passive,once:t.once}:t.capture);function de(t){let e=ce.get(t.type);void 0===e&&(e={stringsArray:new WeakMap,keyString:new Map},ce.set(t.type,e));let i=e.stringsArray.get(t.strings);if(void 0!==i)return i;const r=t.strings.join(Nt);return i=e.keyString.get(r),void 0===i&&(i=new It(t,t.getTemplateElement()),e.keyString.set(r,i)),e.stringsArray.set(t.strings,i),i}const ce=new Map,pe=new WeakMap;const fe=new class{handleAttributeExpressions(t,e,i,r){const s=e[0];if("."===s){return new ae(t,e.slice(1),i).parts}if("@"===s)return[new le(t,e.slice(1),r.eventContext)];if("?"===s)return[new ne(t,e.slice(1),i)];return new ie(t,e,i).parts}handleTextExpression(t){return new se(t)}};"undefined"!=typeof window&&(window.litHtmlVersions||(window.litHtmlVersions=[])).push("1.3.0");const me=(t,...e)=>new Qt(t,e,"html",fe),ge=(t,e)=>`${t}--${e}`;let ye=!0;void 0===window.ShadyCSS?ye=!1:void 0===window.ShadyCSS.prepareTemplateDom&&(console.warn("Incompatible ShadyCSS version detected. Please update to at least @webcomponents/webcomponentsjs@2.0.2 and @webcomponents/shadycss@1.3.1."),ye=!1);const ve=t=>e=>{const i=ge(e.type,t);let r=ce.get(i);void 0===r&&(r={stringsArray:new WeakMap,keyString:new Map},ce.set(i,r));let s=r.stringsArray.get(e.strings);if(void 0!==s)return s;const n=e.strings.join(Nt);if(s=r.keyString.get(n),void 0===s){const i=e.getTemplateElement();ye&&window.ShadyCSS.prepareTemplateDom(i,t),s=new It(e,i),r.keyString.set(n,s)}return r.stringsArray.set(e.strings,s),s},_e=["html","svg"],be=new Set,we=(t,e,i)=>{be.add(t);const r=i?i.element:document.createElement("template"),s=e.querySelectorAll("style"),{length:n}=s;if(0===n)return void window.ShadyCSS.prepareTemplateStyles(r,t);const a=document.createElement("style");for(let t=0;t<n;t++){const e=s[t];e.parentNode.removeChild(e),a.textContent+=e.textContent}(t=>{_e.forEach(e=>{const i=ce.get(ge(e,t));void 0!==i&&i.keyString.forEach(t=>{const{element:{content:e}}=t,i=new Set;Array.from(e.querySelectorAll("style")).forEach(t=>{i.add(t)}),$t(t,i)})})})(t);const o=r.content;i?function(t,e,i=null){const{element:{content:r},parts:s}=t;if(null==i)return void r.appendChild(e);const n=document.createTreeWalker(r,133,null,!1);let a=Wt(s),o=0,h=-1;for(;n.nextNode();){h++;for(n.currentNode===i&&(o=Ht(e),i.parentNode.insertBefore(e,i));-1!==a&&s[a].index===h;){if(o>0){for(;-1!==a;)s[a].index+=o,a=Wt(s,a);return}a=Wt(s,a)}}}(i,a,o.firstChild):o.insertBefore(a,o.firstChild),window.ShadyCSS.prepareTemplateStyles(r,t);const h=o.querySelector("style");if(window.ShadyCSS.nativeShadow&&null!==h)e.insertBefore(h.cloneNode(!0),e.firstChild);else if(i){o.insertBefore(a,o.firstChild);const t=new Set;t.add(a),$t(i,t)}};window.JSCompiler_renameProperty=(t,e)=>t;const Se={toAttribute(t,e){switch(e){case Boolean:return t?"":null;case Object:case Array:return null==t?t:JSON.stringify(t)}return t},fromAttribute(t,e){switch(e){case Boolean:return null!==t;case Number:return null===t?null:Number(t);case Object:case Array:return JSON.parse(t)}return t}},xe=(t,e)=>e!==t&&(e==e||t==t),Ae={attribute:!0,type:String,converter:Se,reflect:!1,hasChanged:xe};class Pe extends HTMLElement{constructor(){super(),this.initialize()}static get observedAttributes(){this.finalize();const t=[];return this._classProperties.forEach((e,i)=>{const r=this._attributeNameForProperty(i,e);void 0!==r&&(this._attributeToPropertyMap.set(r,i),t.push(r))}),t}static _ensureClassProperties(){if(!this.hasOwnProperty(JSCompiler_renameProperty("_classProperties",this))){this._classProperties=new Map;const t=Object.getPrototypeOf(this)._classProperties;void 0!==t&&t.forEach((t,e)=>this._classProperties.set(e,t))}}static createProperty(t,e=Ae){if(this._ensureClassProperties(),this._classProperties.set(t,e),e.noAccessor||this.prototype.hasOwnProperty(t))return;const i="symbol"==typeof t?Symbol():"__"+t,r=this.getPropertyDescriptor(t,i,e);void 0!==r&&Object.defineProperty(this.prototype,t,r)}static getPropertyDescriptor(t,e,i){return{get(){return this[e]},set(r){const s=this[t];this[e]=r,this.requestUpdateInternal(t,s,i)},configurable:!0,enumerable:!0}}static getPropertyOptions(t){return this._classProperties&&this._classProperties.get(t)||Ae}static finalize(){const t=Object.getPrototypeOf(this);if(t.hasOwnProperty("finalized")||t.finalize(),this.finalized=!0,this._ensureClassProperties(),this._attributeToPropertyMap=new Map,this.hasOwnProperty(JSCompiler_renameProperty("properties",this))){const t=this.properties,e=[...Object.getOwnPropertyNames(t),..."function"==typeof Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(t):[]];for(const i of e)this.createProperty(i,t[i])}}static _attributeNameForProperty(t,e){const i=e.attribute;return!1===i?void 0:"string"==typeof i?i:"string"==typeof t?t.toLowerCase():void 0}static _valueHasChanged(t,e,i=xe){return i(t,e)}static _propertyValueFromAttribute(t,e){const i=e.type,r=e.converter||Se,s="function"==typeof r?r:r.fromAttribute;return s?s(t,i):t}static _propertyValueToAttribute(t,e){if(void 0===e.reflect)return;const i=e.type,r=e.converter;return(r&&r.toAttribute||Se.toAttribute)(t,i)}initialize(){this._updateState=0,this._updatePromise=new Promise(t=>this._enableUpdatingResolver=t),this._changedProperties=new Map,this._saveInstanceProperties(),this.requestUpdateInternal()}_saveInstanceProperties(){this.constructor._classProperties.forEach((t,e)=>{if(this.hasOwnProperty(e)){const t=this[e];delete this[e],this._instanceProperties||(this._instanceProperties=new Map),this._instanceProperties.set(e,t)}})}_applyInstanceProperties(){this._instanceProperties.forEach((t,e)=>this[e]=t),this._instanceProperties=void 0}connectedCallback(){this.enableUpdating()}enableUpdating(){void 0!==this._enableUpdatingResolver&&(this._enableUpdatingResolver(),this._enableUpdatingResolver=void 0)}disconnectedCallback(){}attributeChangedCallback(t,e,i){e!==i&&this._attributeToProperty(t,i)}_propertyToAttribute(t,e,i=Ae){const r=this.constructor,s=r._attributeNameForProperty(t,i);if(void 0!==s){const t=r._propertyValueToAttribute(e,i);if(void 0===t)return;this._updateState=8|this._updateState,null==t?this.removeAttribute(s):this.setAttribute(s,t),this._updateState=-9&this._updateState}}_attributeToProperty(t,e){if(8&this._updateState)return;const i=this.constructor,r=i._attributeToPropertyMap.get(t);if(void 0!==r){const t=i.getPropertyOptions(r);this._updateState=16|this._updateState,this[r]=i._propertyValueFromAttribute(e,t),this._updateState=-17&this._updateState}}requestUpdateInternal(t,e,i){let r=!0;if(void 0!==t){const s=this.constructor;i=i||s.getPropertyOptions(t),s._valueHasChanged(this[t],e,i.hasChanged)?(this._changedProperties.has(t)||this._changedProperties.set(t,e),!0!==i.reflect||16&this._updateState||(void 0===this._reflectingProperties&&(this._reflectingProperties=new Map),this._reflectingProperties.set(t,i))):r=!1}!this._hasRequestedUpdate&&r&&(this._updatePromise=this._enqueueUpdate())}requestUpdate(t,e){return this.requestUpdateInternal(t,e),this.updateComplete}async _enqueueUpdate(){this._updateState=4|this._updateState;try{await this._updatePromise}catch(t){}const t=this.performUpdate();return null!=t&&await t,!this._hasRequestedUpdate}get _hasRequestedUpdate(){return 4&this._updateState}get hasUpdated(){return 1&this._updateState}performUpdate(){if(!this._hasRequestedUpdate)return;this._instanceProperties&&this._applyInstanceProperties();let t=!1;const e=this._changedProperties;try{t=this.shouldUpdate(e),t?this.update(e):this._markUpdated()}catch(e){throw t=!1,this._markUpdated(),e}t&&(1&this._updateState||(this._updateState=1|this._updateState,this.firstUpdated(e)),this.updated(e))}_markUpdated(){this._changedProperties=new Map,this._updateState=-5&this._updateState}get updateComplete(){return this._getUpdateComplete()}_getUpdateComplete(){return this._updatePromise}shouldUpdate(t){return!0}update(t){void 0!==this._reflectingProperties&&this._reflectingProperties.size>0&&(this._reflectingProperties.forEach((t,e)=>this._propertyToAttribute(e,this[e],t)),this._reflectingProperties=void 0),this._markUpdated()}updated(t){}firstUpdated(t){}}Pe.finalized=!0;const Fe=t=>e=>"function"==typeof e?((t,e)=>(window.customElements.define(t,e),e))(t,e):((t,e)=>{const{kind:i,elements:r}=e;return{kind:i,elements:r,finisher(e){window.customElements.define(t,e)}}})(t,e),Te=(t,e)=>"method"===e.kind&&e.descriptor&&!("value"in e.descriptor)?Object.assign(Object.assign({},e),{finisher(i){i.createProperty(e.key,t)}}):{kind:"field",key:Symbol(),placement:"own",descriptor:{},initializer(){"function"==typeof e.initializer&&(this[e.key]=e.initializer.call(this))},finisher(i){i.createProperty(e.key,t)}};function Ee(t){return(e,i)=>void 0!==i?((t,e,i)=>{e.constructor.createProperty(i,t)})(t,e,i):Te(t,e)}function Ce(t){return Ee({attribute:!1,hasChanged:null==t?void 0:t.hasChanged})}function Ue(t,e){return(i,r)=>{const s={get(){return this.renderRoot.querySelector(t)},enumerable:!0,configurable:!0};if(e){const e="symbol"==typeof r?Symbol():"__"+r;s.get=function(){return void 0===this[e]&&(this[e]=this.renderRoot.querySelector(t)),this[e]}}return void 0!==r?ke(s,i,r):Le(s,i)}}const ke=(t,e,i)=>{Object.defineProperty(e,i,t)},Le=(t,e)=>({kind:"method",placement:"prototype",key:e.key,descriptor:t}),Be=window.ShadowRoot&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,Ne=Symbol();class Me{constructor(t,e){if(e!==Ne)throw new Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=t}get styleSheet(){return void 0===this._styleSheet&&(Be?(this._styleSheet=new CSSStyleSheet,this._styleSheet.replaceSync(this.cssText)):this._styleSheet=null),this._styleSheet}toString(){return this.cssText}}const Re=(t,...e)=>{const i=e.reduce((e,i,r)=>e+(t=>{if(t instanceof Me)return t.cssText;if("number"==typeof t)return t;throw new Error(`Value passed to 'css' function must be a 'css' function result: ${t}. Use 'unsafeCSS' to pass non-literal values, but\n            take care to ensure page security.`)})(i)+t[r+1],t[0]);return new Me(i,Ne)};(window.litElementVersions||(window.litElementVersions=[])).push("2.4.0");const Ie={};class ze extends Pe{static getStyles(){return this.styles}static _getUniqueStyles(){if(this.hasOwnProperty(JSCompiler_renameProperty("_styles",this)))return;const t=this.getStyles();if(Array.isArray(t)){const e=(t,i)=>t.reduceRight((t,i)=>Array.isArray(i)?e(i,t):(t.add(i),t),i),i=e(t,new Set),r=[];i.forEach(t=>r.unshift(t)),this._styles=r}else this._styles=void 0===t?[]:[t];this._styles=this._styles.map(t=>{if(t instanceof CSSStyleSheet&&!Be){const e=Array.prototype.slice.call(t.cssRules).reduce((t,e)=>t+e.cssText,"");return new Me(String(e),Ne)}return t})}initialize(){super.initialize(),this.constructor._getUniqueStyles(),this.renderRoot=this.createRenderRoot(),window.ShadowRoot&&this.renderRoot instanceof window.ShadowRoot&&this.adoptStyles()}createRenderRoot(){return this.attachShadow({mode:"open"})}adoptStyles(){const t=this.constructor._styles;0!==t.length&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow?Be?this.renderRoot.adoptedStyleSheets=t.map(t=>t instanceof CSSStyleSheet?t:t.styleSheet):this._needsShimAdoptedStyleSheets=!0:window.ShadyCSS.ScopingShim.prepareAdoptedCssText(t.map(t=>t.cssText),this.localName))}connectedCallback(){super.connectedCallback(),this.hasUpdated&&void 0!==window.ShadyCSS&&window.ShadyCSS.styleElement(this)}update(t){const e=this.render();super.update(t),e!==Ie&&this.constructor.render(e,this.renderRoot,{scopeName:this.localName,eventContext:this}),this._needsShimAdoptedStyleSheets&&(this._needsShimAdoptedStyleSheets=!1,this.constructor._styles.forEach(t=>{const e=document.createElement("style");e.textContent=t.cssText,this.renderRoot.appendChild(e)}))}render(){return Ie}}ze.finalized=!0,ze.render=(t,e,i)=>{if(!i||"object"!=typeof i||!i.scopeName)throw new Error("The `scopeName` option is required.");const r=i.scopeName,s=pe.has(e),n=ye&&11===e.nodeType&&!!e.host,a=n&&!be.has(r),o=a?document.createDocumentFragment():e;if(((t,e,i)=>{let r=pe.get(e);void 0===r&&(Bt(e,e.firstChild),pe.set(e,r=new se(Object.assign({templateFactory:de},i))),r.appendInto(e)),r.setValue(t),r.commit()})(t,o,Object.assign({templateFactory:ve(r)},i)),a){const t=pe.get(o);pe.delete(o);const i=t.value instanceof Yt?t.value.template:void 0;we(r,o,i),Bt(e,e.firstChild),e.appendChild(o),pe.set(e,t)}!s&&n&&window.ShadyCSS.styleElement(e.host)};let Oe=class extends(function(t){class e extends t{get renderer(){return this.player.renderer}get audio(){return this.player.audio}get canvasEl(){return this.player.canvasEl}get note(){return this.player.note}get noteFormat(){return this.player.noteFormat}get meta(){return this.player.meta}get duration(){return this.player.duration}get layerVisibility(){return this.player.layerVisibility}get autoplay(){return this.player.autoplay}set autoplay(t){this.player.autoplay=t}}for(let i of Reflect.ownKeys(Pt.prototype)){let r=Object.getOwnPropertyDescriptor(Pt.prototype,i);i in t.prototype||"constructor"===i||"name"===i||"prototype"===i||(r.value&&"function"==typeof r.value?Object.defineProperty(e.prototype,i,Object.assign(Object.assign({},r),{value:function(...t){return this.player[i](...t)}})):(r.get||r.set)&&Object.defineProperty(e.prototype,i,Object.assign(Object.assign({},r),{set:function(t){this.player[i]=t},get:function(){return this.player[i]}})))}return e}(ze)){constructor(){super(),this._width="auto",this._cssWidth="auto",this._progress=0,this._counter="",this._isLoading=!1,this._isError=!1,this._isPlaying=!1,this._isMuted=!1,this._volumeLevel=0,this._isPlayerAvailable=!1,this.handleResize=t=>{this.updateCanvasSize()},this.handleKeyInput=t=>{switch(t.preventDefault(),t.key.toLowerCase()){case" ":this.togglePlay();break;case"a":case"arrowleft":t.shiftKey?this.firstFrame():this.prevFrame();break;case"d":case"arrowright":t.shiftKey?this.lastFrame():this.nextFrame()}},this.handlePlayToggle=t=>{this.togglePlay(),this.focus()},this.handleMuteToggle=t=>{this.toggleMuted(),this.focus()},this.handleProgressSliderChange=t=>{this.seek(t.detail.value),this.focus()},this.handleProgressSliderInputStart=()=>{this.startSeek(),this.focus()},this.handleProgressSliderInputEnd=()=>{this.endSeek(),this.focus()},this.handleVolumeBarChange=t=>{this.setVolume(t.detail.value),this.focus()},this._resizeObserver=new ResizeObserver(this.handleResize)}static get styles(){return Re`:host{display:inline-block}.Player{display:inline-block;position:relative;font-family:var(--flipnote-player-font-family,sans-serif)}.CanvasArea{position:relative}.PlayerCanvas{position:relative;display:block}.Overlay{position:absolute;top:0;left:0;background:#ebf0f3;color:#4b4c53;width:100%;height:100%;display:flex;justify-content:center;align-items:center}.Overlay--error{background:#ff8b8b;color:#ca2a32}@keyframes spin{from{transform:rotateZ(0)}to{transform:rotateZ(360deg)}}.LoaderIcon{animation:spin infinite 1.2s linear}.Controls{background:var(--flipnote-player-controls-background,none)}.MuteIcon{width:28px;height:28px}.Controls__groupLeft,.Controls__groupRight,.Controls__row{display:flex;align-items:center}.Controls__groupLeft{margin-right:auto}.Controls__groupRight{margin-left:auto}.Controls__playButton{height:32px;width:32px;padding:2px}.MuteIcon{width:28px;height:28px}.LoaderIcon{width:40px;height:40px}.Controls.Controls--compact{margin:6px 0}.Controls__frameCounter{min-width:90px;font-variant-numeric:tabular-nums}.Controls__progressBar{flex:1}.Controls--compact .Controls__playButton{margin-right:8px}.Controls--compact .Controls__progressBar{flex:1}.Controls--default .Controls__playButton{margin-right:8px}.Controls--default .Controls__volumeBar{width:70px;margin-left:8px}.Button{border:0;padding:0;outline:0;-webkit-appearance:none;display:block;font-family:inherit;font-size:inherit;text-align:center;cursor:pointer;background:var(--flipnote-player-button-background,#ffd3a6);color:var(--flipnote-player-button-color,#f36a2d);border-radius:4px}.Button flipnote-player-icon{display:block}`}get width(){return this._width}set width(t){const e=this._width;var i;this._width=t,this._cssWidth=isNaN(+t)?t:t+"px",i=()=>this.updateCanvasSize(),l(()=>l(()=>i())),this.requestUpdate("width",e)}get src(){return this._playerSrc}set src(t){const e=this._playerSrc;this._isPlayerAvailable&&(this.player.src=t),this._playerSrc=t,this.requestUpdate("src",e)}get autoplay(){return this.player.autoplay}set autoplay(t){const e=this.player.autoplay;this.player.autoplay=t,this.requestUpdate("autoplay",e)}render(){return me`<style>:host{width:${this._cssWidth}}</style><div class="Player" @keydown="${this.handleKeyInput}"><div class="CanvasArea" @click="${this.handlePlayToggle}"><canvas class="PlayerCanvas" id="canvas"></canvas>${this._isLoading?me`<div class="Overlay"><flipnote-player-icon icon="loader" class="LoaderIcon"></flipnote-player-icon></div>`:""} ${this._isError?me`<div class="Overlay Overlay--error">Error</div>`:""}</div>${this.renderControls()}</div>`}renderControls(){return"compact"===this.controls?me`<div class="Controls Controls--compact Controls__row"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this._isPlaying?"pause":"play"}"></flipnote-player-icon></button><flipnote-player-slider class="Controls__progressBar" value="${this._progress}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></div>`:me`<div class="Controls Controls--default"><flipnote-player-slider class="Controls__progressBar" value="${this._progress}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"><div class="Controls__row"><div class="Controls__groupLeft"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this._isPlaying?"pause":"play"}"></flipnote-player-icon></button> <span class="Controls__frameCounter">${this._counter}</span></div><div class="Controls__groupRight"><flipnote-player-icon class="MuteIcon" @click="${this.handleMuteToggle}" icon="${this._isMuted?"volumeOff":"volumeOn"}"></flipnote-player-icon><flipnote-player-slider class="Controls__volumeBar" value="${this._volumeLevel}" @change="${this.handleVolumeBarChange}"></flipnote-player-slider></div></div></div>`}firstUpdated(t){const e=new Pt(this.playerCanvas,256,192);this._resizeObserver.observe(this),this.player=e,e.on(O.LoadStart,()=>{this._isLoading=!0}),e.on(O.Load,()=>{this.updateCanvasSize()}),e.on(O.Error,()=>{this._isLoading=!1,this._isError=!0}),e.on([O.Load,O.Close,O.Progress],()=>{this._isLoading=!1,this._isError=!1,this._progress=e.getProgress()/100,this._counter=e.getFrameCounter()}),e.on(O.Play,()=>{this._isPlaying=!0}),e.on(O.Pause,()=>{this._isPlaying=!1}),e.on([O.Load,O.VolumeChange],()=>{this._volumeLevel=e.volume,this._isMuted=e.muted}),e.on(O.__Any,(t,e)=>{this.dispatchEvent(new Event(t))}),this._playerSrc&&e.load(this._playerSrc),this._isPlayerAvailable=!0}disconnectedCallback(){this._resizeObserver.disconnect(),this.destroy()}updateCanvasSize(){const t=this._isPlayerAvailable;let e=256;"auto"===this._width&&t&&this.player.isNoteLoaded?e=this.player.note.imageWidth:"auto"!==this._width&&(e=this.getBoundingClientRect().width),t&&this.player.resize(e,.75*e)}};kt([Ee({type:String})],Oe.prototype,"controls",void 0),kt([Ee({type:String})],Oe.prototype,"width",null),kt([Ee({type:String})],Oe.prototype,"src",null),kt([Ee({type:Boolean})],Oe.prototype,"autoplay",null),kt([Ce()],Oe.prototype,"_width",void 0),kt([Ce()],Oe.prototype,"_cssWidth",void 0),kt([Ce()],Oe.prototype,"_progress",void 0),kt([Ce()],Oe.prototype,"_counter",void 0),kt([Ce()],Oe.prototype,"_isLoading",void 0),kt([Ce()],Oe.prototype,"_isError",void 0),kt([Ce()],Oe.prototype,"_isPlaying",void 0),kt([Ce()],Oe.prototype,"_isMuted",void 0),kt([Ce()],Oe.prototype,"_volumeLevel",void 0),kt([Ue("#canvas")],Oe.prototype,"playerCanvas",void 0),Oe=kt([Fe("flipnote-player")],Oe);class De{constructor(t){this.classes=new Set,this.changed=!1,this.element=t;const e=(t.getAttribute("class")||"").split(/\s+/);for(const t of e)this.classes.add(t)}add(t){this.classes.add(t),this.changed=!0}remove(t){this.classes.delete(t),this.changed=!0}commit(){if(this.changed){let t="";this.classes.forEach(e=>t+=e+" "),this.element.setAttribute("class",t)}}}const Ve=new WeakMap,$e=jt(t=>e=>{if(!(e instanceof re)||e instanceof oe||"class"!==e.committer.name||e.committer.parts.length>1)throw new Error("The `classMap` directive must be used in the `class` attribute and must be the only part in the attribute.");const{committer:i}=e,{element:r}=i;let s=Ve.get(e);void 0===s&&(r.setAttribute("class",i.strings.join(" ")),Ve.set(e,s=new Set));const n=r.classList||new De(r);s.forEach(e=>{e in t||(n.remove(e),s.delete(e))});for(const e in t){const i=t[e];i!=s.has(e)&&(i?(n.add(e),s.add(e)):(n.remove(e),s.delete(e)))}"function"==typeof n.commit&&n.commit()}),He=new WeakMap,We=jt(t=>e=>{if(!(e instanceof re)||e instanceof oe||"style"!==e.committer.name||e.committer.parts.length>1)throw new Error("The `styleMap` directive must be used in the style attribute and must be the only part in the attribute.");const{committer:i}=e,{style:r}=i.element;let s=He.get(e);void 0===s&&(r.cssText=i.strings.join(" "),He.set(e,s=new Set)),s.forEach(e=>{e in t||(s.delete(e),-1===e.indexOf("-")?r[e]=null:r.removeProperty(e))});for(const e in t)s.add(e),-1===e.indexOf("-")?r[e]=t[e]:r.setProperty(e,t[e])});let qe=class extends ze{constructor(){super(...arguments),this.value=0,this.orientation="horizontal",this.isActive=!1,this.onSliderInputStart=t=>{t.preventDefault(),this.isActive=!0,document.addEventListener("mousemove",this.onSliderInput),document.addEventListener("mouseup",this.onSliderInputEnd),this.dispatch("inputstart"),this.onSliderInput(t)},this.onSliderInputEnd=t=>{t.preventDefault(),document.removeEventListener("mousemove",this.onSliderInput),document.removeEventListener("mouseup",this.onSliderInputEnd),this.dispatch("inputend"),this.onSliderInput(t),this.isActive=!1},this.onSliderInput=t=>{t.preventDefault();const e=this.sliderElement.getBoundingClientRect();let i;if("horizontal"===this.orientation){const r=e.height/2,s=e.width-2*r,n=(t.clientX-e.left-r)/s;i=Math.max(0,Math.min(n,1))}else if("vertical"===this.orientation){const r=e.width/2,s=e.height-2*r,n=1-(t.clientY-e.top-r)/s;i=Math.max(0,Math.min(n,1))}this.value!==i&&this.dispatch("change",{value:i})}}static get styles(){return Re`.Slider{padding:4px 0;cursor:pointer}.Slider--vertical{height:100px;width:14px}.Slider__track{position:relative;border-radius:3px;background:var(--flipnote-player-slider-track,#ffd3a6)}.Slider--horizontal .Slider__track{height:4px;margin:6px 0}.Slider--vertical .Slider__track{width:4px;height:100%;margin:0 6px}.Slider__level{position:absolute;width:100%;height:6px;margin:-1px;border-radius:8px;background:var(--flipnote-player-slider-level,#f36a2d)}.Slider--horizontal .Slider__level{width:100%;height:6px}.Slider--vertical .Slider__level{width:6px;height:100%;bottom:0}.Slider__handle{display:none;position:absolute;height:10px;width:10px;border-radius:5px;box-sizing:border-box;border:3px solid var(--flipnote-player-slider-handle,#f36a2d);background:var(--flipnote-player-slider-handle-fill,#fff)}.Slider--isActive .Slider__handle,.Slider:hover .Slider__handle{display:block}.Slider--horizontal .Slider__handle{top:0;margin-top:-3px;margin-left:-6px}.Slider--vertical .Slider__handle{left:0;margin-bottom:-6px;margin-left:-3px}`}render(){const t=100*this.value+"%",e="horizontal"===this.orientation?"width":"height",i="horizontal"===this.orientation?"left":"bottom",r={Slider:!0,"Slider--horizontal":"horizontal"===this.orientation,"Slider--vertical":"vertical"===this.orientation,"Slider--isActive":this.isActive};return me`<div class="${$e(r)}" @mousedown="${this.onSliderInputStart}"><div class="Slider__track"><div class="Slider__level" style="${We({[e]:t})}"></div><div class="Slider__handle" style="${We({[i]:t})}"></div></div></div>`}dispatch(t,e){const i=new CustomEvent(t,{detail:e});this.dispatchEvent(i)}};kt([Ee({type:Number})],qe.prototype,"value",void 0),kt([Ee({type:String})],qe.prototype,"orientation",void 0),kt([Ce()],qe.prototype,"isActive",void 0),kt([Ue(".Slider__track")],qe.prototype,"sliderElement",void 0),qe=kt([Fe("flipnote-player-slider")],qe);const je=new WeakMap,Ge=window.navigator.userAgent.indexOf("Trident/")>0,Ke=jt(t=>e=>{if(!(e instanceof se))throw new Error("unsafeSVG can only be used in text bindings");const i=je.get(e);if(void 0!==i&&te(t)&&t===i.value&&e.value===i.fragment)return;const r=document.createElement("template"),s=r.content;let n;Ge?(r.innerHTML=`<svg>${t}</svg>`,n=s.firstChild):(n=document.createElementNS("http://www.w3.org/2000/svg","svg"),s.appendChild(n),n.innerHTML=t),s.removeChild(n),((t,e,i=null,r=null)=>{for(;e!==i;){const i=e.nextSibling;t.insertBefore(e,r),e=i}})(s,n.firstChild);const a=document.importNode(s,!0);e.setValue(a),je.set(e,{value:t,fragment:a})});function Xe(t){return t.replace(/<svg ([^>]*)>/,(t,e)=>`<svg ${e} class="Icon" style="fill:currentColor">`)}const Ye={play:Xe('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M74.137 48h8.985a4 4 0 012.129.614l91.994 57.84c7.48 4.704 9.732 14.582 5.028 22.062a16 16 0 01-5.028 5.03l-91.994 57.84a4 4 0 01-2.13.614h-8.984C68.54 192 64 187.461 64 181.863V58.137C64 52.54 68.539 48 74.137 48z"/></svg>'),pause:Xe('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M64 48h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16H64c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16zm88 0h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16h-24c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16z"/></svg>'),loader:Xe('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M120 176c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16zm48.497-28c4.419-7.653 14.204-10.275 21.857-5.856 7.653 4.418 10.275 14.203 5.856 21.856-4.418 7.653-14.203 10.275-21.856 5.856-7.653-4.418-10.275-14.203-5.857-21.856zm-118.85-5.856c7.652-4.419 17.437-1.797 21.856 5.856 4.418 7.653 1.796 17.438-5.857 21.856-7.653 4.419-17.438 1.797-21.856-5.856-4.419-7.653-1.797-17.438 5.856-21.856zm124.707-72c7.653-4.419 17.438-1.797 21.856 5.856 4.419 7.653 1.797 17.438-5.856 21.856-7.653 4.419-17.438 1.797-21.857-5.856-4.418-7.653-1.796-17.438 5.857-21.856zM43.79 76c4.418-7.653 14.203-10.275 21.856-5.856C73.3 74.562 75.921 84.347 71.503 92c-4.419 7.653-14.204 10.275-21.857 5.856C41.993 93.438 39.371 83.653 43.79 76zM120 32c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16z"/></svg>'),volumeOn:Xe('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M113.3 42.022a10 10 0 0110-1.2 10 10 0 015.7 9v140a10 10 0 01-5.7 9 9.116 9.116 0 01-4.3 1.001 10.009 10.009 0 01-6.2-2.2l-47.3-37.8H29c-5.523 0-10-4.478-10-10v-60c0-5.524 4.477-10 10-10h36.5zm82.986 17.298c17.008 16.234 25.715 36.022 25.715 58.68 0 22.37-8.465 43.147-24.992 61.928-4.378 4.975-11.96 5.459-16.936 1.08-4.975-4.378-5.46-11.96-1.08-16.936C191.798 149.52 198 134.297 198 118c0-16.009-5.96-29.554-18.286-41.32-4.794-4.576-4.97-12.172-.395-16.966 4.577-4.794 12.172-4.97 16.966-.394zM165.201 87.4c10.904 8.178 16.8 18.987 16.8 31.6 0 12.433-5.712 23.38-16.318 32.219-5.091 4.242-12.658 3.555-16.9-1.537-4.174-5.008-3.577-12.41 1.289-16.69l.246-.21c5.395-4.496 7.683-8.881 7.683-13.782 0-4.613-2.01-8.403-6.857-12.14l-.343-.26c-5.302-3.976-6.377-11.498-2.4-16.8 3.976-5.302 11.498-6.376 16.8-2.4z"/></svg>'),volumeOff:Xe('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M123.3 40.822a10 10 0 00-10 1.2l-47.8 37.8H29c-5.523 0-10 4.477-10 10v60c0 5.523 4.477 10 10 10h36.5l47.3 37.8a10.009 10.009 0 006.2 2.201 9.116 9.116 0 004.3-1 10 10 0 005.7-9v-140a10 10 0 00-5.7-9zm70.451 50.462c4.702-4.454 12.126-4.377 16.734.23 4.608 4.609 4.685 12.033.23 16.735l-.23.236L198.971 120l11.514 11.515c4.687 4.686 4.687 12.284 0 16.97-4.608 4.608-12.032 4.685-16.734.23l-.236-.23L182 136.971l-11.515 11.514-.236.23c-4.702 4.455-12.126 4.378-16.734-.23-4.608-4.608-4.685-12.032-.23-16.734l.23-.236L165.029 120l-11.514-11.515c-4.687-4.686-4.687-12.284 0-16.97 4.608-4.608 12.032-4.685 16.734-.23l.236.23L182 103.029l11.515-11.514.236-.23z"/></svg>')};let Je=class extends ze{constructor(){super(...arguments),this.icon="loader"}static get styles(){return Re`.Icon{width:100%;height:100%;color:var(--flipnote-player-icon-color,#f36a2d)}`}render(){return me`${Ke(Ye[this.icon])}`}};kt([Ee({type:String})],Je.prototype,"icon",void 0),Je=kt([Fe("flipnote-player-icon")],Je);let Ze=class extends ze{constructor(){super(...arguments),this._src="",this._frame="0",this.gifUrl="",this.imgTitle=""}static get styles(){return Re`.Image{width:inherit;height:inherit;image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges;-ms-interpolation-mode:nearest-neighbor}`}set src(t){this.load(t)}get src(){return this._src}set frame(t){this._frame=t,this.note&&this.loadNote(this.note)}get frame(){return this._frame}render(){return me`<img class="Image" src="${this.gifUrl}" alt="${this.imgTitle}" title="${this.imgTitle}">`}revokeUrl(){this.gif&&this.gif.dataUrl&&(this.gif.revokeUrl(),this.gifUrl="")}loadNote(t){this.note=t,this.revokeUrl();const e=this._frame;if("all"===e)this.gif=Ct.fromFlipnote(t),this.gifUrl=this.gif.getUrl();else if("thumb"===e)this.gif=Ct.fromFlipnoteFrame(t,t.thumbFrameIndex),this.gifUrl=this.gif.getUrl();else if(!isNaN(+e)){const i=parseInt(e);this.gif=Ct.fromFlipnoteFrame(t,i),this.gifUrl=this.gif.getUrl()}this.gifUrl?(this.dispatchLoad(),this.imgTitle=this.getTitle(t)):this.dispatchError("Invalid frame attribute")}load(t){this._src=t,this.note=void 0,z(t).then(t=>this.loadNote(t)).catch(t=>this.dispatchError(t))}disconnectedCallback(){this.revokeUrl()}getTitle(t){return t.isComment?"Comment by "+t.meta.current.username:t.isFolderIcon?"Folder icon":"Flipnote by "+t.meta.current.username}dispatchLoad(){this.dispatchEvent(new Event("load"))}dispatchError(t){throw this.dispatchEvent(new ErrorEvent("error",{error:t})),new Error(t)}};kt([Ee()],Ze.prototype,"src",null),kt([Ee()],Ze.prototype,"frame",null),kt([Ce()],Ze.prototype,"gifUrl",void 0),kt([Ce()],Ze.prototype,"imgTitle",void 0),Ze=kt([Fe("flipnote-image")],Ze);const Qe=Oe;t.GifImage=Ct,t.KwzParser=R,t.Player=Pt,t.PpmParser=T,t.WavAudio=Ut,t.parseSource=z,t.playerComponent=Qe,t.version="5.2.1",Object.defineProperty(t,"__esModule",{value:!0})}));
