/*!!
 flipnote.js v4.1.0 (webcomponent version)
 Browser-based playback of .ppm and .kwz animations from Flipnote Studio and Flipnote Studio 3D
 2018 - 2020 James Daniel
 github.com/jaames/flipnote.js
 Flipnote Studio is (c) Nintendo Co., Ltd.
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t=t||self).flipnote={})}(this,(function(t){"use strict";function i(){}function n(t){return t()}function r(){return Object.create(null)}function s(t){t.forEach(n)}function e(t){return"function"==typeof t}function o(t,i){return t!=t?i==i:t!==i||t&&"object"==typeof t||"function"==typeof t}function h(t,i){t.appendChild(i)}function a(t,i,n){t.insertBefore(i,n||null)}function u(t){t.parentNode.removeChild(t)}function l(t){return document.createElement(t)}function c(t){return document.createTextNode(t)}function f(){return c(" ")}function v(t,i,n,r){return t.addEventListener(i,n,r),()=>t.removeEventListener(i,n,r)}function p(t,i,n){null==n?t.removeAttribute(i):t.getAttribute(i)!==n&&t.setAttribute(i,n)}function d(t,i,n){i in t?t[i]=n:p(t,i,n)}function y(t,i,n,r){t.style.setProperty(i,n,r?"important":"")}let m;function w(t){m=t}function g(){if(!m)throw new Error("Function called outside component initialization");return m}function _(){const t=g();return(i,n)=>{const r=t.$$.callbacks[i];if(r){const s=function(t,i){const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,!1,!1,i),n}(i,n);r.slice().forEach(i=>{i.call(t,s)})}}}const b=[],A=[],F=[],x=[],P=Promise.resolve();let C=!1;function k(t){F.push(t)}let U=!1;const M=new Set;function B(){if(!U){U=!0;do{for(let t=0;t<b.length;t+=1){const i=b[t];w(i),S(i.$$)}for(b.length=0;A.length;)A.pop()();for(let t=0;t<F.length;t+=1){const i=F[t];M.has(i)||(M.add(i),i())}F.length=0}while(b.length);for(;x.length;)x.pop()();C=!1,U=!1,M.clear()}}function S(t){if(null!==t.fragment){t.update(),s(t.before_update);const i=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,i),t.after_update.forEach(k)}}const E=new Set;let I,z;function L(t,i){t&&t.i&&(E.delete(t),t.i(i))}function O(t,i){const n=i.token={};function r(t,r,e,o){if(i.token!==n)return;i.resolved=o;let h=i.ctx;void 0!==e&&(h=h.slice(),h[e]=o);const a=t&&(i.current=t)(h);let u=!1;i.block&&(i.blocks?i.blocks.forEach((t,n)=>{n!==r&&t&&(I={r:0,c:[],p:I},function(t,i,n,r){if(t&&t.o){if(E.has(t))return;E.add(t),I.c.push(()=>{E.delete(t),r&&(n&&t.d(1),r())}),t.o(i)}}(t,1,1,()=>{i.blocks[n]=null}),I.r||s(I.c),I=I.p)}):i.block.d(1),a.c(),L(a,1),a.m(i.mount(),i.anchor),u=!0),i.block=a,i.blocks&&(i.blocks[r]=a),u&&B()}if((e=t)&&"object"==typeof e&&"function"==typeof e.then){const n=g();if(t.then(t=>{w(n),r(i.then,1,i.value,t),w(null)},t=>{w(n),r(i.catch,2,i.error,t),w(null)}),i.current!==i.pending)return r(i.pending,0),!0}else{if(i.current!==i.then)return r(i.then,1,i.value,t),!0;i.resolved=t}var e}function j(t,i){-1===t.$$.dirty[0]&&(b.push(t),C||(C=!0,P.then(B)),t.$$.dirty.fill(0)),t.$$.dirty[i/31|0]|=1<<i%31}function D(t,o,h,a,l,c,f=[-1]){const v=m;w(t);const p=o.props||{},d=t.$$={fragment:null,ctx:null,props:c,update:i,not_equal:l,bound:r(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(v?v.$$.context:[]),callbacks:r(),dirty:f};let y=!1;if(d.ctx=h?h(t,p,(i,n,...r)=>{const s=r.length?r[0]:n;return d.ctx&&l(d.ctx[i],d.ctx[i]=s)&&(d.bound[i]&&d.bound[i](s),y&&j(t,i)),n}):[],d.update(),y=!0,s(d.before_update),d.fragment=!!a&&a(d.ctx),o.target){if(o.hydrate){const t=function(t){return Array.from(t.childNodes)}(o.target);d.fragment&&d.fragment.l(t),t.forEach(u)}else d.fragment&&d.fragment.c();o.intro&&L(t.$$.fragment),function(t,i,r){const{fragment:o,on_mount:h,on_destroy:a,after_update:u}=t.$$;o&&o.m(i,r),k(()=>{const i=h.map(n).filter(e);a?a.push(...i):s(i),t.$$.on_mount=[]}),u.forEach(k)}(t,o.target,o.anchor),B()}w(v)}"function"==typeof HTMLElement&&(z=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){for(const t in this.$$.slotted)this.appendChild(this.$$.slotted[t])}attributeChangedCallback(t,i,n){this[t]=n}$destroy(){!function(t,i){const n=t.$$;null!==n.fragment&&(s(n.on_destroy),n.fragment&&n.fragment.d(i),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=i}$on(t,i){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(i),()=>{const t=n.indexOf(i);-1!==t&&n.splice(t,1)}}$set(){}});var R=function(t,i){return(R=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])})(t,i)};function W(t,i){function n(){this.constructor=t}R(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}function T(t,i,n,r){return new(n||(n=Promise))((function(s,e){function o(t){try{a(r.next(t))}catch(t){e(t)}}function h(t){try{a(r.throw(t))}catch(t){e(t)}}function a(t){var i;t.done?s(t.value):(i=t.value,i instanceof n?i:new n((function(t){t(i)}))).then(o,h)}a((r=r.apply(t,i||[])).next())}))}function G(t,i){var n,r,s,e,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function h(e){return function(h){return function(e){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(s=2&e[0]?r.return:e[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,e[1])).done)return s;switch(r=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return o.label++,{value:e[1],done:!1};case 5:o.label++,r=e[1],e=[0];continue;case 7:e=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==e[0]&&2!==e[0])){o=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){o.label=e[1];break}if(6===e[0]&&o.label<s[1]){o.label=s[1],s=e;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(e);break}s[2]&&o.ops.pop(),o.trys.pop();continue}e=i.call(t,o)}catch(t){e=[6,t],r=0}finally{n=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,h])}}}var H=[{matches:function(t){return"string"==typeof t},load:function(t,i,n){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(t){4===r.readyState&&(r.status>=200&&r.status<300?i(r.response):n({type:"httpError",status:r.status,statusText:r.statusText}))},r.send(null)}},{matches:function(t){return"undefined"!=typeof File&&t instanceof File},load:function(t,i,n){if("undefined"!=typeof FileReader){var r=new FileReader;r.onload=function(t){i(r.result)},r.onerror=function(t){n({type:"fileReadError"})},r.readAsArrayBuffer(t)}else n()}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,i,n){i(t)}}];var $=function(){function t(){this.page=-1,this.pages=[],this.cursor=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(t.pageSize),this.cursor=0},t.prototype.getData=function(){var i=this,n=new Uint8Array(this.page*t.pageSize+this.cursor);return this.pages.map((function(r,s){s===i.page?n.set(r.slice(0,i.cursor),s*t.pageSize):n.set(r,s*t.pageSize)})),n},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(i){this.cursor>=t.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=i},t.prototype.writeBytes=function(t,i,n){for(var r=n||t.length,s=i||0;s<r;s++)this.writeByte(t[s])},t.pageSize=4096,t}(),K=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.cursor=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,i){switch(i){case 2:this.cursor=this.data.byteLength+t;break;case 1:this.cursor+=t;break;case 0:default:this.cursor=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.cursor);return this.cursor+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.cursor,t),this.cursor+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.cursor);return this.cursor+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.cursor,t),this.cursor+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var i=this.data.getUint16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeUint16=function(t,i){void 0===i&&(i=!0),this.data.setUint16(this.cursor,t,i),this.cursor+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var i=this.data.getInt16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeInt16=function(t,i){void 0===i&&(i=!0),this.data.setInt16(this.cursor,t,i),this.cursor+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var i=this.data.getUint32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeUint32=function(t,i){void 0===i&&(i=!0),this.data.setUint32(this.cursor,t,i),this.cursor+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var i=this.data.getInt32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeInt32=function(t,i){void 0===i&&(i=!0),this.data.setInt32(this.cursor,t,i),this.cursor+=4},t.prototype.readBytes=function(t){var i=new Uint8Array(this.data.buffer,this.cursor,t);return this.cursor+=i.byteLength,i},t.prototype.writeBytes=function(t){var i=this;t.forEach((function(t){return i.writeUint8(t)}))},t.prototype.readHex=function(t,i){void 0===i&&(i=!1);for(var n=this.readBytes(t),r=[],s=0;s<n.length;s++)r.push(n[s].toString(16).padStart(2,"0"));return i&&r.reverse(),r.join("").toUpperCase()},t.prototype.readChars=function(t){for(var i=this.readBytes(t),n="",r=0;r<i.length;r++){var s=i[r];if(0===s)break;n+=String.fromCharCode(s)}return n},t.prototype.writeChars=function(t){for(var i=0;i<t.length;i++){var n=t.charCodeAt(i);this.writeUint8(n)}},t.prototype.readWideChars=function(t){for(var i=new Uint16Array(this.data.buffer,this.cursor,t),n="",r=0;r<i.length;r++){var s=i[r];if(0==s)break;n+=String.fromCharCode(s)}return this.cursor+=i.byteLength,n},t}(),N=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return W(i,t),i.prototype.hasAudioTrack=function(t){return!!(this.soundMeta.hasOwnProperty(t)&&this.soundMeta[t].length>0)},i}(K);function V(t,i,n){return t<i?i:t>n?n:t}function q(t,i,n){for(var r=t.length/i,s=new Int16Array(r*n),e=(i<<8)/n,o=0;o<s.length;o++){var h=t[o*e>>8]/2;s[o]=V(h,-32768,32767)}return s}function Z(t,i,n){void 0===n&&(n=0);for(var r=t.length,s=i.length,e=0;e<r&&!(n+e>s);e++){var o=i[n+e]+t[e];i[n+e]=V(o,-32768,32767)}}for(var Y=new Int8Array([-1,2,-1,2]),X=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),J=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),Q=new Int16Array(360),tt=0;tt<4;tt++)for(var it=0;it<90;it++){var nt=(st=J[it])>>3;1&tt&&(nt+=st),2&tt&&(nt=-nt),Q[tt+4*it]=nt}var rt=new Int16Array(1440);for(tt=0;tt<16;tt++)for(it=0;it<90;it++){var st;nt=(st=J[it])>>3;4&tt&&(nt+=st),2&tt&&(nt+=st>>1),1&tt&&(nt+=st>>2),8&tt&&(nt=-nt),rt[tt+16*it]=nt}for(var et=[.5,.5,1,2,4,6,12,20,30],ot={WHITE:[255,255,255],BLACK:[14,14,14],RED:[255,42,42],BLUE:[10,57,255]},ht=function(t){function i(n){var r=t.call(this,n)||this;return r.type=i.type,r.width=i.width,r.height=i.height,r.globalPalette=i.globalPalette,r.sampleRate=i.sampleRate,r.prevDecodedFrame=null,r.decodeHeader(),r.decodeAnimationHeader(),r.decodeSoundHeader(),0!=(r.version>>4&15)&&r.decodeMeta(),r.layers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],r.prevLayers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],r.prevDecodedFrame=null,r}return W(i,t),i.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},i.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},i.prototype.decodeHeader=function(){this.seek(0);this.readUint32();this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},i.prototype.readFilename=function(){return[this.readHex(3),this.readChars(13),this.readUint16().toString().padStart(3,"0")].join("_")},i.prototype.decodeMeta=function(){this.seek(16);var t=this.readUint16(),i=this.readInt16(),n=this.readWideChars(11),r=this.readWideChars(11),s=this.readWideChars(11),e=this.readHex(8,!0),o=this.readHex(8,!0),h=this.readFilename(),a=this.readFilename(),u=this.readHex(8,!0);this.seek(154);var l=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=i,this.meta={lock:1===t,loop:1==(c>>1&1),frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:i,timestamp:l,spinoff:o!==e||o!==u,root:{filename:null,username:n,fsid:u},parent:{username:r,fsid:e,filename:h},current:{username:s,fsid:o,filename:a}}},i.prototype.decodeAnimationHeader=function(){this.seek(1696);var t=this.readUint16(),i=t/4;this.seek(1704);for(var n=new Uint32Array(i),r=0;r<i;r++)n[r]=1704+t+this.readUint32();this.frameOffsets=n},i.prototype.decodeSoundHeader=function(){var t,i=1696+this.frameDataLength+this.frameCount;i%4!=0&&(i+=4-i%4),this.seek(i);var n=this.readUint32(),r=this.readUint32(),s=this.readUint32(),e=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),i+=32,this.framerate=et[this.frameSpeed],this.bgmrate=et[this.bgmSpeed],this.soundMeta=((t={})[0]={offset:i,length:n},t[1]={offset:i+=n,length:r},t[2]={offset:i+=r,length:s},t[3]={offset:i+=s,length:e},t)},i.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},i.prototype.getLayerOrder=function(t){return[0,1]},i.prototype.readLineEncoding=function(){for(var t=new Uint8Array(i.height),n=0,r=0;r<48;r++)for(var s=this.readUint8(),e=0;e<8;e+=2)t[n++]=s>>e&3;return t},i.prototype.decodeFrame=function(t){this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.seek(this.frameOffsets[t]);var n=this.readUint8(),r=n>>7&1,s=n>>5&3,e=0,o=0;this.prevLayers[0].set(this.layers[0]),this.prevLayers[1].set(this.layers[1]),this.prevDecodedFrame=t,this.layers[0].fill(0),this.layers[1].fill(0),s&&(e=this.readInt8(),o=this.readInt8());for(var h=[this.readLineEncoding(),this.readLineEncoding()],a=0;a<2;a++)for(var u=this.layers[a],l=0;l<i.height;l++){var c=h[a][l],f=l*i.width;switch(c){case 0:break;case 1:case 2:var v=this.readUint32(!1);for(2==c&&u.fill(255,f,f+i.width);4294967295&v;){if(2147483648&v)for(var p=this.readUint8(),d=0;d<8;d++)u[f+d]=p>>d&1?255:0;f+=8,v<<=1}break;case 3:for(;f<(l+1)*i.width;){for(p=this.readUint8(),d=0;d<8;d++)u[f+d]=p>>d&1?255:0;f+=8}}}var y=this.layers[0],m=this.layers[1],w=this.prevLayers[0],g=this.prevLayers[1];if(!r)for(var _=void 0,b=void 0,A=0;A<i.height;A++)if(!(A-o<0)){if(A-o>=i.height)break;for(var F=0;F<i.width;F++)if(!(F-e<0)){if(F-e>=i.width)break;b=(_=F+A*i.width)-(e+o*i.width),y[_]^=w[b],m[_]^=g[b]}}return this.layers},i.prototype.getFramePaletteIndices=function(t){this.seek(this.frameOffsets[t]);var i=this.readUint8(),n=1!=(1&i),r=[n?0:1,n?0:1,2,3];return[n?1:0,r[i>>1&3],r[i>>3&3]]},i.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,n){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),s=this.layers[n],e=new Uint8Array(i.width*i.height),o=r[n+1],h=0;h<e.length;h++)0!==s[h]&&(e[h]=o);return e},i.prototype.getFramePixels=function(t){var n=this.getFramePaletteIndices(t),r=this.decodeFrame(t),s=new Uint8Array(i.width*i.height),e=r[0],o=r[1],h=n[0],a=n[1],u=n[2];s.fill(h);for(var l=0;l<s.length;l++){var c=e[l],f=o[l];0!==c?s[l]=a:0!==f&&(s[l]=u)}return s},i.prototype.decodeSoundFlags=function(){this.seek(1696+this.frameDataLength);for(var t=this.frameCount,i=this.readBytes(t),n=new Array(t),r=0;r<t;r++){var s=i[r];n[r]=[0!=(1&s),0!=(2&s),0!=(4&s)]}return n},i.prototype.getAudioTrackRaw=function(t){var i=this.soundMeta[t];return new Uint8Array(this.buffer,i.offset,i.length)},i.prototype.decodeAudioTrack=function(t){for(var i=this.getAudioTrackRaw(t),n=i.length,r=new Int16Array(2*n),s=0,e=0,o=0,h=0,a=0,u=!0;s<n;){o=u?15&i[s]:i[s++]>>4,u=!u;var l=J[h],c=l>>3;1&o&&(c+=l>>2),2&o&&(c+=l>>1),4&o&&(c+=l),8&o&&(c=-c),a=V(a+=c,-32768,32767),h=V(h+=X[o],0,88),r[e++]=a}return r},i.prototype.getAudioTrackPcm=function(t,i){void 0===i&&(i=32768);var n=this.decodeAudioTrack(t),r=this.sampleRate;if(0===t){var s=1/this.bgmrate/(1/this.framerate);r=this.sampleRate*s}return r!==i?q(n,r,i):n},i.prototype.getAudioMasterPcm=function(t){void 0===t&&(t=32768);var i=this.frameCount*(1/this.framerate),n=Math.floor(i*t),r=new Int16Array(n),s=this.hasAudioTrack(0),e=this.hasAudioTrack(1),o=this.hasAudioTrack(2),h=this.hasAudioTrack(3);s&&Z(this.getAudioTrackPcm(0,t),r,0);if(e||o||h)for(var a=Math.floor(t/this.framerate),u=this.decodeSoundFlags(),l=e?this.getAudioTrackPcm(1,t):null,c=o?this.getAudioTrackPcm(2,t):null,f=h?this.getAudioTrackPcm(3,t):null,v=0;v<this.frameCount;v++){var p=a*v,d=u[v];e&&d[0]&&Z(l,r,p),o&&d[1]&&Z(c,r,p),h&&d[2]&&Z(f,r,p)}return r},i.type="PPM",i.width=256,i.height=192,i.sampleRate=8192,i.outputSampleRate=32768,i.globalPalette=[ot.WHITE,ot.BLACK,ot.RED,ot.BLUE],i}(N),at=new Uint16Array(52488),ut=[0,65280,255],lt=0,ct=0;ct<3;ct++)for(var ft=0;ft<3;ft++)for(var vt=0;vt<3;vt++)for(var pt=0;pt<3;pt++)for(var dt=0;dt<3;dt++)for(var yt=0;yt<3;yt++)for(var mt=0;mt<3;mt++)for(var wt=0;wt<3;wt++)at.set([ut[ft],ut[ct],ut[pt],ut[vt],ut[yt],ut[dt],ut[wt],ut[mt]],lt),lt+=8;var gt=new Uint16Array(52488);for(lt=0,ct=0;ct<2187;ct+=729)for(ft=0;ft<729;ft+=243)for(vt=0;vt<243;vt+=81)for(pt=0;pt<81;pt+=27)for(dt=0;dt<27;dt+=9)for(yt=0;yt<9;yt+=3)for(mt=0;mt<3;mt+=1)for(wt=0;wt<6561;wt+=2187){var _t=ct+ft+vt+pt+dt+yt+mt+wt,bt=at.subarray(8*_t,8*_t+8);gt.set(bt,lt),lt+=8}var At=new Uint16Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,i){var n=at.subarray(8*t,8*t+8);At.set(n,8*i)}));var Ft=new Uint16Array(256);[0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100].forEach((function(t,i){var n=at.subarray(8*t,8*t+8);Ft.set(n,8*i)}));var xt=[.2,.5,1,2,4,6,8,12,20,24,30],Pt={WHITE:[255,255,255],BLACK:[16,16,16],RED:[255,16,16],YELLOW:[255,231,0],GREEN:[0,134,49],BLUE:[0,56,206],NONE:[255,255,255]},Ct=function(t){function i(n){var r=t.call(this,n)||this;return r.type=i.type,r.width=i.width,r.height=i.height,r.globalPalette=i.globalPalette,r.sampleRate=i.sampleRate,r.prevDecodedFrame=null,r.bitIndex=0,r.bitValue=0,r.layers=[new Uint16Array(i.width*i.height),new Uint16Array(i.width*i.height),new Uint16Array(i.width*i.height)],r.bitIndex=0,r.bitValue=0,r.load(),r}return W(i,t),i.prototype.load=function(){this.seek(0),this.sections={},this.frameMeta=[];for(var t=this.byteLength-256,i=0,n=0;i<t&&n<6;){this.seek(i);var r=this.readChars(4).substring(0,3),s=this.readUint32();this.sections[r]={offset:i,length:s},i+=s+8,n+=1}this.decodeMeta(),this.decodeFrameMeta(),this.decodeSoundHeader()},i.prototype.readBits=function(t){if(this.bitIndex+t>16){var i=this.readUint16();this.bitValue|=i<<16-this.bitIndex,this.bitIndex-=16}var n=(1<<t)-1,r=this.bitValue&n;return this.bitValue>>=t,this.bitIndex+=t,r},i.prototype.decodeMeta=function(){this.seek(this.sections.KFH.offset+12);var t=new Date(1e3*(this.readUint32()+946684800)),i=new Date(1e3*(this.readUint32()+946684800)),n=(this.readUint32(),this.readHex(10)),r=this.readHex(10),s=this.readHex(10),e=this.readWideChars(11),o=this.readWideChars(11),h=this.readWideChars(11),a=this.readChars(28),u=this.readChars(28),l=this.readChars(28),c=this.readUint16(),f=this.readUint16(),v=this.readUint16(),p=this.readUint8();this.readUint8();this.frameCount=c,this.thumbFrameIndex=f,this.frameSpeed=p,this.framerate=xt[p],this.meta={lock:1==(1&v),loop:1==(v>>1&1),frame_count:c,frame_speed:p,thumb_index:f,timestamp:i,creation_timestamp:t,root:{username:e,fsid:n,filename:a},parent:{username:o,fsid:r,filename:u},current:{username:h,fsid:s,filename:l}}},i.prototype.decodeFrameMeta=function(){this.frameOffsets=new Uint32Array(this.frameCount),this.seek(this.sections.KMI.offset+8);for(var t=this.sections.KMC.offset+12,i=0;i<this.frameCount;i++){var n={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readHex(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(n),this.frameOffsets[i]=t,t+=n.layerSize[0]+n.layerSize[1]+n.layerSize[2]}},i.prototype.decodeSoundHeader=function(){var t;if(this.sections.hasOwnProperty("KSN")){var i=this.sections.KSN.offset+8;this.seek(i);var n=this.readUint32();this.bgmSpeed=n,this.bgmrate=xt[n];var r=new Uint32Array(this.buffer,i+4,20);this.soundMeta=((t={})[0]={offset:i+=28,length:r[0]},t[1]={offset:i+=r[0],length:r[1]},t[2]={offset:i+=r[1],length:r[2]},t[3]={offset:i+=r[2],length:r[3]},t[4]={offset:i+=r[3],length:r[4]},t)}},i.prototype.getDiffingFlag=function(t){return 7&~(this.frameMeta[t].flags>>4)},i.prototype.getLayerDepths=function(t){return this.frameMeta[t].layerDepth},i.prototype.getLayerOrder=function(t){var i=this.getLayerDepths(t);return[2,1,0].sort((function(t,n){return i[n]-i[t]}))},i.prototype.decodeFrame=function(t,n,r){void 0===n&&(n=7),void 0===r&&(r=!1),r&&(n&=this.getDiffingFlag(t+1)),this.prevDecodedFrame!==t-1&&n&&0!==t&&this.decodeFrame(t-1,n=n,r=!0);for(var s=this.frameMeta[t],e=this.frameOffsets[t],o=0;o<3;o++){this.seek(e);var h=s.layerSize[o];if(e+=h,38!==h&&0!=(n>>o&1)){this.bitIndex=16,this.bitValue=0;for(var a=0,u=0;u<i.height;u+=128)for(var l=0;l<i.width;l+=128)for(var c=0;c<128;c+=8){var f=u+c;if(f>=i.height)break;for(var v=0;v<128;v+=8){var p=l+v;if(p>=i.width)break;if(a)a-=1;else{var d=f*i.width+p,y=this.layers[o],m=this.readBits(3);if(0==m){var w=this.readBits(5),g=At.subarray(8*w,8*w+8);y.set(g,d),y.set(g,d+320),y.set(g,d+640),y.set(g,d+960),y.set(g,d+1280),y.set(g,d+1600),y.set(g,d+1920),y.set(g,d+2240)}else if(1==m){w=this.readBits(13),g=at.subarray(8*w,8*w+8);y.set(g,d),y.set(g,d+320),y.set(g,d+640),y.set(g,d+960),y.set(g,d+1280),y.set(g,d+1600),y.set(g,d+1920),y.set(g,d+2240)}else if(2==m){var _=this.readBits(5),b=At.subarray(8*_,8*_+8),A=Ft.subarray(8*_,8*_+8);y.set(b,d),y.set(A,d+320),y.set(b,d+640),y.set(A,d+960),y.set(b,d+1280),y.set(A,d+1600),y.set(b,d+1920),y.set(A,d+2240)}else if(3==m){_=this.readBits(13),b=at.subarray(8*_,8*_+8),A=gt.subarray(8*_,8*_+8);y.set(b,d),y.set(A,d+320),y.set(b,d+640),y.set(A,d+960),y.set(b,d+1280),y.set(A,d+1600),y.set(b,d+1920),y.set(A,d+2240)}else if(4==m)for(var F=this.readBits(8),x=0;x<8;x++)if(F&1<<x){w=this.readBits(5),g=At.subarray(8*w,8*w+8);y.set(g,d+320*x)}else{w=this.readBits(13),g=at.subarray(8*w,8*w+8);y.set(g,d+320*x)}else{if(5==m){a=this.readBits(5);continue}if(7==m){var P=this.readBits(2);b=void 0,A=void 0;if(this.readBits(1)){var C=this.readBits(5),k=this.readBits(5);b=At.subarray(8*C,8*C+8),A=At.subarray(8*k,8*k+8),P=(P+1)%4}else{C=this.readBits(13),k=this.readBits(13);b=at.subarray(8*C,8*C+8),A=at.subarray(8*k,8*k+8)}0==P?(y.set(b,d),y.set(A,d+320),y.set(b,d+640),y.set(A,d+960),y.set(b,d+1280),y.set(A,d+1600),y.set(b,d+1920),y.set(A,d+2240)):1==P?(y.set(b,d),y.set(b,d+320),y.set(A,d+640),y.set(b,d+960),y.set(b,d+1280),y.set(A,d+1600),y.set(b,d+1920),y.set(b,d+2240)):2==P?(y.set(b,d),y.set(A,d+320),y.set(b,d+640),y.set(b,d+960),y.set(A,d+1280),y.set(b,d+1600),y.set(b,d+1920),y.set(A,d+2240)):3==P&&(y.set(b,d),y.set(A,d+320),y.set(A,d+640),y.set(b,d+960),y.set(A,d+1280),y.set(A,d+1600),y.set(b,d+1920),y.set(A,d+2240))}}}}}}}return this.prevDecodedFrame=t,[new Uint8Array(this.layers[0].buffer),new Uint8Array(this.layers[1].buffer),new Uint8Array(this.layers[2].buffer)]},i.prototype.getFramePaletteIndices=function(t){var i=this.frameMeta[t].flags;return[15&i,i>>8&15,i>>12&15,i>>16&15,i>>20&15,i>>24&15,i>>28&15]},i.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,n){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),s=this.layers[n],e=new Uint8Array(i.width*i.height),o=2*n+1,h=0;h<s.length;h++){var a=s[h];65280&a?e[h]=r[o]:255&a&&(e[h]=r[o+1])}return e},i.prototype.getFramePixels=function(t){var n=this,r=this.getFramePaletteIndices(t),s=new Uint8Array(i.width*i.height);return s.fill(r[0]),this.getLayerOrder(t).forEach((function(i){for(var r=n.getLayerPixels(t,i),e=0;e<r.length;e++){var o=r[e];0!==o&&(s[e]=o)}})),s},i.prototype.decodeSoundFlags=function(){return this.frameMeta.map((function(t){var i=t.soundFlags;return[0!=(1&i),0!=(2&i),0!=(4&i),0!=(8&i)]}))},i.prototype.getAudioTrackRaw=function(t){var i=this.soundMeta[t];return new Uint8Array(this.buffer,i.offset,i.length)},i.prototype.decodeAudioTrack=function(t){for(var i,n,r,s=this.getAudioTrackRaw(t),e=new Int16Array(981840),o=0,h=0,a=40,u=0;u<s.length;u++)for(var l=s[u],c=0;c<8;)a<18||6==c?(n=h+Q[(i=l>>c&3)+4*a],r=a+Y[i],c+=2):(n=h+rt[(i=l>>c&15)+16*a],r=a+X[i],c+=4),r=Math.max(0,Math.min(r,79)),n=Math.max(-2047,Math.min(n,2047)),e[o]=16*n,o+=1,a=r,h=n;return e.slice(0,o)},i.prototype.getAudioTrackPcm=function(t,i){void 0===i&&(i=32768);var n=this.decodeAudioTrack(t),r=this.sampleRate;if(0===t){var s=1/this.bgmrate/(1/this.framerate);r=this.sampleRate*s}return r!==i?q(n,r,i):n},i.prototype.getAudioMasterPcm=function(t){void 0===t&&(t=32768);var i=this.frameCount*(1/this.framerate),n=Math.floor(i*t),r=new Int16Array(n),s=this.hasAudioTrack(0),e=this.hasAudioTrack(1),o=this.hasAudioTrack(2),h=this.hasAudioTrack(3),a=this.hasAudioTrack(4);s&&Z(this.getAudioTrackPcm(0,t),r,0);if(e||o||h)for(var u=Math.floor(t/this.framerate),l=this.decodeSoundFlags(),c=e?this.getAudioTrackPcm(1,t):null,f=o?this.getAudioTrackPcm(2,t):null,v=h?this.getAudioTrackPcm(3,t):null,p=a?this.getAudioTrackPcm(4,t):null,d=0;d<this.frameCount;d++){var y=u*d,m=l[d];e&&m[0]&&Z(c,r,y),o&&m[1]&&Z(f,r,y),h&&m[2]&&Z(v,r,y),a&&m[3]&&Z(p,r,y)}return r},i.type="KWZ",i.width=320,i.height=240,i.sampleRate=16364,i.globalPalette=[Pt.WHITE,Pt.BLACK,Pt.RED,Pt.YELLOW,Pt.GREEN,Pt.BLUE,Pt.NONE],i}(N);function kt(t){return function(t){return new Promise((function(i,n){H.forEach((function(r){r.matches(t)&&r.load(t,i,n)}))}))}(t).then((function(t){return new Promise((function(i,n){var r=new Uint8Array(t.slice(0,4)),s=r[0]<<24|r[1]<<16|r[2]<<8|r[3];1346458177===s?i(new ht(t)):1262897152==(4294967040&s)?i(new Ct(t)):n()}))}))}var Ut;!function(t){t[t.Alpha=WebGLRenderingContext.ALPHA]="Alpha",t[t.LuminanceAlpha=WebGLRenderingContext.LUMINANCE_ALPHA]="LuminanceAlpha"}(Ut||(Ut={}));var Mt=function(){function t(t,i,n,r){void 0===i&&(i=640),void 0===n&&(n=480),void 0===r&&(r={antialias:!1,alpha:!1}),this.uniforms={},this.refs={shaders:[],textures:[],buffers:[]};var s=t.getContext("webgl",r);this.el=t,this.gl=s,this.createProgram(),this.setCanvasSize(i,n),this.createScreenQuad(),this.createBitmapTexture(),s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA)}return t.prototype.createProgram=function(){var t=this.gl,i=t.createProgram();if(t.attachShader(i,this.createShader(t.VERTEX_SHADER,"#define GLSLIFY 1\nattribute vec4 a_position;varying vec2 v_texel;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){gl_Position=a_position;vec2 uv=a_position.xy*vec2(0.5,-0.5)+0.5;v_texel=uv*u_textureSize;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);}")),t.attachShader(i,this.createShader(t.FRAGMENT_SHADER,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_texel;varying float v_scale;uniform vec4 u_color1;uniform vec4 u_color2;uniform sampler2D u_bitmap;uniform bool u_isSmooth;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;vec2 colorWeights=texture2D(u_bitmap,coord).ra;gl_FragColor=vec4(u_color1.rgb,1.0)*colorWeights.y+vec4(u_color2.rgb,1.0)*colorWeights.x;}")),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){var n=t.getProgramInfoLog(i);throw t.deleteProgram(i),new Error(n)}t.useProgram(i);for(var r=t.getProgramParameter(i,t.ACTIVE_UNIFORMS),s=0;s<r;s++){var e=t.getActiveUniform(i,s).name;this.uniforms[e]=t.getUniformLocation(i,e)}this.program=i},t.prototype.createScreenQuad=function(){var t=this.gl,i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0),this.refs.buffers.push(i)},t.prototype.createBitmapTexture=function(){var t=this.gl;t.activeTexture(t.TEXTURE0);var i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.uniform1i(this.uniforms.u_bitmap,0),this.refs.textures.push(i)},t.prototype.createShader=function(t,i){var n=this.gl,r=n.createShader(t);if(n.shaderSource(r,i),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){var s=n.getShaderInfoLog(r);throw n.deleteShader(r),new Error(s)}return this.refs.shaders.push(r),r},t.prototype.setInputSize=function(t,i){this.gl.uniform2f(this.uniforms.u_textureSize,t,i)},t.prototype.setCanvasSize=function(t,i){var n=window.devicePixelRatio||1,r=t*n,s=i*n;this.el.width=r,this.el.height=s,this.width=r,this.height=s,this.gl.viewport(0,0,r,s),this.gl.uniform2f(this.uniforms.u_screenSize,r,s),this.el.style.width=t+"px",this.el.style.height=i+"px"},t.prototype.setLayerType=function(t){this.textureType=t},t.prototype.toImage=function(t){return this.el.toDataURL(t)},t.prototype.setColor=function(t,i){this.gl.uniform4f(this.uniforms[t],i[0]/255,i[1]/255,i[2]/255,1)},t.prototype.setPaperColor=function(t){this.gl.clearColor(t[0]/255,t[1]/255,t[2]/255,1)},t.prototype.drawLayer=function(t,i,n,r,s){var e=this.gl;e.texImage2D(e.TEXTURE_2D,0,this.textureType,i,n,0,this.textureType,e.UNSIGNED_BYTE,t),this.setColor("u_color1",r),this.setColor("u_color2",s),e.drawArrays(e.TRIANGLES,0,6)},t.prototype.resize=function(t,i){void 0===t&&(t=640),void 0===i&&(i=480),this.setCanvasSize(t,i)},t.prototype.clear=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)},t.prototype.destroy=function(){var t=this.refs,i=this.gl;t.shaders.forEach((function(t){i.deleteShader(t)})),t.shaders=[],t.textures.forEach((function(t){i.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){i.deleteBuffer(t)})),t.buffers=[],i.deleteProgram(this.program),i.canvas.width=1,i.canvas.height=1},t}(),Bt=window.AudioContext||window.webkitAudioContext,St=function(){function t(t,i){this.ctx=new Bt,this.setSamples(t,i)}return t.prototype.setSamples=function(t,i){var n=t.length,r=this.ctx.createBuffer(1,n,i),s=r.getChannelData(0);if(t instanceof Float32Array)s.set(t,0);else if(t instanceof Int16Array)for(var e=0;e<n;e++)s[e]=t[e]/32767;this.buffer=r,this.sampleRate=i},t.prototype.stop=function(){this.source.stop(0)},t.prototype.playFrom=function(t){var i=this.ctx.createBufferSource();i.buffer=this.buffer,i.connect(this.ctx.destination,0,0),this.source=i,this.source.start(0,t)},t}(),Et=function(){function t(t,i,n){this.loop=!1,this.paused=!0,this.duration=0,this.isOpen=!1,this.events={},this.t=-1,this.s=0,this.hasPlaybackStarted=!1,this.wasPlaying=!1,this.isSeeking=!1,t="string"==typeof t?document.querySelector(t):t,this.canvas=new Mt(t,i,n),this.el=this.canvas.el,this.customPalette=null}return Object.defineProperty(t.prototype,"currentFrame",{get:function(){return this.t},set:function(t){this.setFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return this.isOpen?this.s:null},set:function(t){this.isOpen&&t<=this.duration&&t>=0&&(this.setFrame(Math.round(t/(1/this.framerate))),this.s=t,this.emit("progress",this.progress))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"progress",{get:function(){return this.isOpen?this.currentTime/this.duration*100:0},set:function(t){this.currentTime=this.duration*(t/100)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return 1},set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"muted",{get:function(){return!1},set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"audiorate",{get:function(){return 1/this.note.bgmrate/(1/this.note.framerate)},enumerable:!1,configurable:!0}),t.prototype.open=function(t){return T(this,void 0,void 0,(function(){var i=this;return G(this,(function(n){return this.isOpen&&this.close(),[2,kt(t).then((function(t){i.load(t)})).catch((function(t){throw i.emit("error",t),console.error("Error loading Flipnote:",t),"Error loading Flipnote"}))]}))}))},t.prototype.close=function(){this.pause(),this.note=null,this.isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.t=null,this.s=null,this.duration=null,this.loop=null,this.hasPlaybackStarted=null,this.canvas.clear()},t.prototype.load=function(t){this.note=t,this.meta=t.meta,this.type=t.type,this.loop=t.meta.loop,this.duration=this.note.frameCount*(1/this.note.framerate),this.paused=!0,this.isOpen=!0,this.hasPlaybackStarted=!1,this.layerVisibility={1:!0,2:!0,3:!0};var i=t.getAudioMasterPcm(32768);this.audioPlayer=new St(i,32768),this.canvas.setInputSize(t.width,t.height),this.canvas.setLayerType("PPM"===this.type?Ut.Alpha:Ut.LuminanceAlpha),this.setFrame(this.note.thumbFrameIndex),this.s=0,this.emit("load")},t.prototype.playAudio=function(){this.audioPlayer.playFrom(this.currentTime)},t.prototype.stopAudio=function(){this.audioPlayer.stop()},t.prototype.play=function(){var t=this;if(!this.isOpen||!this.paused)return null;this.hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.s=0),this.paused=!1,this.playAudio();var i=performance.now()/1e3-this.currentTime,n=function(r){if(t.paused)return t.stopAudio(),null;var s=r/1e3,e=s-i;e>t.duration?t.loop?(t.currentTime=0,t.playAudio(),i=s,t.emit("playback:loop")):(t.pause(),t.emit("playback:end")):t.currentTime=e,requestAnimationFrame(n)};requestAnimationFrame(n),this.hasPlaybackStarted=!0,this.emit("playback:start")},t.prototype.pause=function(){if(!this.isOpen||this.paused)return null;this.paused=!0,this.stopAudio(),this.emit("playback:stop")},t.prototype.togglePlay=function(){this.paused?this.play():this.pause()},t.prototype.setFrame=function(t){this.isOpen&&t!==this.currentFrame&&(t=Math.max(0,Math.min(Math.floor(t),this.frameCount-1)),this.drawFrame(t),this.t=t,this.paused&&(this.s=t*(1/this.framerate),this.emit("progress",this.progress)),this.emit("frame:update",this.currentFrame))},t.prototype.nextFrame=function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1},t.prototype.prevFrame=function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1},t.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1},t.prototype.firstFrame=function(){this.currentFrame=0},t.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},t.prototype.startSeek=function(){this.isSeeking||(this.wasPlaying=!this.paused,this.pause(),this.isSeeking=!0)},t.prototype.seek=function(t){this.isSeeking&&(this.progress=t)},t.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},t.prototype.drawFrame=function(t){var i=this,n=this.note.width,r=this.note.height,s=this.note.getFramePalette(t),e=this.note.decodeFrame(t);this.canvas.setPaperColor(s[0]),this.canvas.clear(),"PPM"===this.note.type?(this.layerVisibility[2]&&this.canvas.drawLayer(e[1],n,r,s[2],[0,0,0,0]),this.layerVisibility[1]&&this.canvas.drawLayer(e[0],n,r,s[1],[0,0,0,0])):"KWZ"===this.note.type&&this.note.getLayerOrder(t).forEach((function(t){i.layerVisibility[t+1]&&i.canvas.drawLayer(e[t],n,r,s[2*t+1],s[2*t+2])}))},t.prototype.forceUpdate=function(){this.isOpen&&this.drawFrame(this.currentFrame)},t.prototype.resize=function(t,i){this.canvas.resize(t,i),this.forceUpdate()},t.prototype.setLayerVisibility=function(t,i){this.layerVisibility[t]=i,this.forceUpdate()},t.prototype.toggleLayerVisibility=function(t){this.setLayerVisibility(t,!this.layerVisibility[t])},t.prototype.on=function(t,i){var n=this.events;(n[t]||(n[t]=[])).push(i)},t.prototype.off=function(t,i){var n=this.events[t];n&&n.splice(n.indexOf(i),1)},t.prototype.emit=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];for(var r=this.events[t]||[],s=0;s<r.length;s++)r[s].apply(null,i)},t.prototype.clearEvents=function(){this.events={}},t.prototype.destroy=function(){this.close(),this.canvas.destroy()},t}();function It(t,i){return t.toString().padStart(i,"0")}function zt(t){return Math.floor(t%3600/60)+":"+It(Math.round(t%60),2)}function Lt(t,i){return t.replace(/<svg ([^>]*)>/,(function(t,n){return"<svg "+n+' style="'+i+'">'}))}function Ot(t){let n,r,o,c,d,m,w;return{c(){n=l("div"),r=l("div"),o=l("div"),c=f(),d=l("div"),this.c=i,p(o,"class","PlayerSlider__level"),y(o,"width",100*t[0]+"%"),p(d,"class","PlayerSlider__handle"),y(d,"left",100*t[0]+"%"),p(r,"class","PlayerSlider__track"),p(n,"class","PlayerSlider")},m(i,s){a(i,n,s),h(n,r),h(r,o),h(r,c),h(r,d),t[6](r),m||(w=[v(window,"mousemove",(function(){e(t[2]?t[5]:null)&&(t[2]?t[5]:null).apply(this,arguments)})),v(window,"mouseup",(function(){e(t[2]?t[4]:null)&&(t[2]?t[4]:null).apply(this,arguments)})),v(n,"mousedown",t[3])],m=!0)},p(i,[n]){t=i,1&n&&y(o,"width",100*t[0]+"%"),1&n&&y(d,"left",100*t[0]+"%")},i:i,o:i,d(i){i&&u(n),t[6](null),m=!1,s(w)}}}function jt(t,i,n){let r,{value:s=0}=i,e=!1;const o=(h=g(),a=_(),function(t,i){a(t,i),h.dispatchEvent&&h.dispatchEvent(new CustomEvent(t,{detail:i}))});var h,a;function u(t){t.preventDefault();const i=r.getBoundingClientRect(),n=i.height/2,e=i.width-2*n,h=t.pageX-i.left-n,a=Math.max(0,Math.min(1,h/e));s!==a&&o("change",{value:a})}return t.$set=t=>{"value"in t&&n(0,s=t.value)},[s,r,e,function(t){t.preventDefault(),n(2,e=!0),u(t),o("inputstart")},function(t){t.preventDefault(),n(2,e=!1),u(t),o("inputend")},u,function(t){A[t?"unshift":"push"](()=>{r=t,n(1,r)})}]}customElements.define("flipnote-player-slider-bar",class extends z{constructor(t){super(),this.shadowRoot.innerHTML="<style>.PlayerSlider{padding:4px 0;cursor:pointer}.PlayerSlider__track{position:relative;flex:1;height:4px;border-radius:3px;margin:6px 0;background:var(--flipnote-player-slider-track, #FFD3A6)}.PlayerSlider__level{position:absolute;width:100%;height:6px;margin:-1px;border-radius:8px;background:var(--flipnote-player-slider-level, #F36A2D)}.PlayerSlider__handle{display:none;position:absolute;top:0;height:10px;width:6px;margin-left:-3px;margin-top:-3px;border-radius:2px;background:var(--flipnote-player-slider-handle, #F36A2D)}.PlayerSlider:hover .PlayerSlider__handle{display:block}</style>",D(this,{target:this.shadowRoot},jt,Ot,o,{value:0}),t&&(t.target&&a(t.target,this,t.anchor),t.props&&(this.$set(t.props),B()))}static get observedAttributes(){return["value"]}get value(){return this.$$.ctx[0]}set value(t){this.$set({value:t}),B()}});function Dt(t){let n,r=t[1][t[0]]+"";return{c(){n=l("div"),this.c=i,p(n,"class","PlayerIcon")},m(t,i){a(t,n,i),n.innerHTML=r},p(t,[i]){1&i&&r!==(r=t[1][t[0]]+"")&&(n.innerHTML=r)},i:i,o:i,d(t){t&&u(n)}}}const Rt="fill:currentColor";function Wt(t,i,n){let{icon:r="play"}=i;const s={play:Lt('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 241 240"><path fill-rule="evenodd" d="M74.137 48h8.985a4 4 0 012.129.614l91.994 57.84c7.48 4.704 9.732 14.582 5.028 22.062a16 16 0 01-5.028 5.03l-91.994 57.84a4 4 0 01-2.13.614h-8.984C68.54 192 64 187.461 64 181.863V58.137C64 52.54 68.539 48 74.137 48z"/></svg>',Rt),pause:Lt('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M64 48h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16H64c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16zm88 0h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16h-24c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16z"/></svg>',Rt),loader:Lt('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M120 176c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16zm48.497-28c4.419-7.653 14.204-10.275 21.857-5.856 7.653 4.418 10.275 14.203 5.856 21.856-4.418 7.653-14.203 10.275-21.856 5.856-7.653-4.418-10.275-14.203-5.857-21.856zm-118.85-5.856c7.652-4.419 17.437-1.797 21.856 5.856 4.418 7.653 1.796 17.438-5.857 21.856-7.653 4.419-17.438 1.797-21.856-5.856-4.419-7.653-1.797-17.438 5.856-21.856zm124.707-72c7.653-4.419 17.438-1.797 21.856 5.856 4.419 7.653 1.797 17.438-5.856 21.856-7.653 4.419-17.438 1.797-21.857-5.856-4.418-7.653-1.796-17.438 5.857-21.856zM43.79 76c4.418-7.653 14.203-10.275 21.856-5.856C73.3 74.562 75.921 84.347 71.503 92c-4.419 7.653-14.204 10.275-21.857 5.856C41.993 93.438 39.371 83.653 43.79 76zM120 32c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16z"/></svg>',Rt),volumeOn:Lt('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M113.3 42.022a10 10 0 0110-1.2 10 10 0 015.7 9v140a10 10 0 01-5.7 9 9.116 9.116 0 01-4.3 1.001 10.009 10.009 0 01-6.2-2.2l-47.3-37.8H29c-5.523 0-10-4.478-10-10v-60c0-5.524 4.477-10 10-10h36.5zm82.986 17.298c17.008 16.234 25.715 36.022 25.715 58.68 0 22.37-8.465 43.147-24.992 61.928-4.378 4.975-11.96 5.459-16.936 1.08-4.975-4.378-5.46-11.96-1.08-16.936C191.798 149.52 198 134.297 198 118c0-16.009-5.96-29.554-18.286-41.32-4.794-4.576-4.97-12.172-.395-16.966 4.577-4.794 12.172-4.97 16.966-.394zM165.201 87.4c10.904 8.178 16.8 18.987 16.8 31.6 0 12.433-5.712 23.38-16.318 32.219-5.091 4.242-12.658 3.555-16.9-1.537-4.174-5.008-3.577-12.41 1.289-16.69l.246-.21c5.395-4.496 7.683-8.881 7.683-13.782 0-4.613-2.01-8.403-6.857-12.14l-.343-.26c-5.302-3.976-6.377-11.498-2.4-16.8 3.976-5.302 11.498-6.376 16.8-2.4z"/></svg>',Rt),volumeOff:Lt('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M123.3 40.822a10 10 0 00-10 1.2l-47.8 37.8H29c-5.523 0-10 4.477-10 10v60c0 5.523 4.477 10 10 10h36.5l47.3 37.8a10.009 10.009 0 006.2 2.201 9.116 9.116 0 004.3-1 10 10 0 005.7-9v-140a10 10 0 00-5.7-9zm70.451 50.462c4.702-4.454 12.126-4.377 16.734.23 4.608 4.609 4.685 12.033.23 16.735l-.23.236L198.971 120l11.514 11.515c4.687 4.686 4.687 12.284 0 16.97-4.608 4.608-12.032 4.685-16.734.23l-.236-.23L182 136.971l-11.515 11.514-.236.23c-4.702 4.455-12.126 4.378-16.734-.23-4.608-4.608-4.685-12.032-.23-16.734l.23-.236L165.029 120l-11.514-11.515c-4.687-4.686-4.687-12.284 0-16.97 4.608-4.608 12.032-4.685 16.734-.23l.236.23L182 103.029l11.515-11.514.236-.23z"/></svg>',Rt)};return t.$set=t=>{"icon"in t&&n(0,r=t.icon)},[r,s]}function Tt(t){let i;return{c(){i=l("div"),i.textContent="Error",p(i,"class","FlipnotePlayer__overlay")},m(t,n){a(t,i,n)},d(t){t&&u(i)}}}function Gt(t){return{c:i,m:i,d:i}}function Ht(t){let i;return{c(){i=l("div"),i.innerHTML='<flipnote-player-icon icon="loader" class="FlipnotePlayer__loaderIcon"></flipnote-player-icon>',p(i,"class","FlipnotePlayer__overlay")},m(t,n){a(t,i,n)},d(t){t&&u(i)}}}function $t(t){let n;return{c(){n=l("div"),n.textContent="todo :)",p(n,"class","FlipnotePlayerControls FlipnotePlayerControls--full")},m(t,i){a(t,n,i)},p:i,d(t){t&&u(n)}}}function Kt(t){let i,n,r,e,o,y,m,w,g,_,b,A,F,x,P,C,k,U,M,B,S;return{c(){i=l("div"),n=l("flipnote-player-slider-bar"),e=f(),o=l("div"),y=l("div"),m=l("button"),w=l("flipnote-player-icon"),_=f(),b=l("span"),A=c(t[6]),F=f(),x=l("div"),P=l("flipnote-player-icon"),k=f(),U=l("flipnote-player-slider-bar"),d(n,"class","FlipnotePlayerControls__progressBar"),d(n,"value",r=t[3]/100),d(w,"icon",g=t[4]?"pause":"play"),p(m,"class","Button FlipnotePlayerControls__playButton"),p(b,"class","FlipnotePlayerControls__frameCounter"),p(y,"class","FlipnotePlayerControls__groupLeft"),d(P,"class","FlipnotePlayerControls__muteIcon"),d(P,"icon",C=t[0]||0===t[5]?"volumeOff":"volumeOn"),d(U,"class","FlipnotePlayerControls__volumeBar"),d(U,"value",M=t[0]?0:t[5]),p(x,"class","FlipnotePlayerControls__groupRight"),p(o,"class","FlipnotePlayerControls__row"),p(i,"class","FlipnotePlayerControls FlipnotePlayerControls--default")},m(r,s){a(r,i,s),h(i,n),h(i,e),h(i,o),h(o,y),h(y,m),h(m,w),h(y,_),h(y,b),h(b,A),h(o,F),h(o,x),h(x,P),h(x,k),h(x,U),B||(S=[v(n,"change",t[9]),v(n,"inputstart",t[8]),v(n,"inputend",t[10]),v(m,"click",t[12]),v(P,"click",t[13]),v(U,"change",t[11])],B=!0)},p(t,i){8&i&&r!==(r=t[3]/100)&&d(n,"value",r),16&i&&g!==(g=t[4]?"pause":"play")&&d(w,"icon",g),64&i&&function(t,i){i=""+i,t.wholeText!==i&&(t.data=i)}(A,t[6]),33&i&&C!==(C=t[0]||0===t[5]?"volumeOff":"volumeOn")&&d(P,"icon",C),33&i&&M!==(M=t[0]?0:t[5])&&d(U,"value",M)},d(t){t&&u(i),B=!1,s(S)}}}function Nt(t){let i,n,r,e,o,c,y,m,w;return{c(){i=l("div"),n=l("button"),r=l("flipnote-player-icon"),o=f(),c=l("flipnote-player-slider-bar"),d(r,"icon",e=t[4]?"pause":"play"),p(n,"class","Button FlipnotePlayerControls__playButton"),d(c,"class","FlipnotePlayerControls__progressBar"),d(c,"value",y=t[3]/100),p(i,"class","FlipnotePlayerControls FlipnotePlayerControls--compact FlipnotePlayerControls__row")},m(s,e){a(s,i,e),h(i,n),h(n,r),h(i,o),h(i,c),m||(w=[v(n,"click",t[12]),v(c,"change",t[9]),v(c,"inputstart",t[8]),v(c,"inputend",t[10])],m=!0)},p(t,i){16&i&&e!==(e=t[4]?"pause":"play")&&d(r,"icon",e),8&i&&y!==(y=t[3]/100)&&d(c,"value",y)},d(t){t&&u(i),m=!1,s(w)}}}function Vt(t){let n,r,s,e,o,c,d,y,m={ctx:t,current:null,token:null,pending:Ht,then:Gt,catch:Tt,error:23};function w(t,i){return"compact"===t[1]?Nt:"default"===t[1]?Kt:"full"===t[1]?$t:void 0}O(o=t[7],m);let g=w(t),_=g&&g(t);return{c(){n=l("div"),r=l("div"),s=l("canvas"),e=f(),m.block.c(),c=f(),_&&_.c(),this.c=i,p(s,"class","FlipnotePlayer__canvas"),p(r,"class","FlipnotePlayer__canvasArea"),p(n,"class","FlipnotePlayer")},m(i,o){a(i,n,o),h(n,r),h(r,s),t[16](s),h(r,e),m.block.m(r,m.anchor=null),m.mount=()=>r,m.anchor=null,h(n,c),_&&_.m(n,null),d||(y=v(s,"click",t[12]),d=!0)},p(i,[r]){t=i,m.ctx=t,128&r&&o!==(o=t[7])&&O(o,m),g===(g=w(t))&&_?_.p(t,r):(_&&_.d(1),_=g&&g(t),_&&(_.c(),_.m(n,null)))},i:i,o:i,d(i){i&&u(n),t[16](null),m.block.d(),m.token=null,m=null,_&&_.d(),d=!1,y()}}}function qt(t,i,n){let r,s,{src:e=null}=i,{controls:o="default"}=i,{timeformat:h="frames"}=i,{muted:a=!1}=i,u=0,l=0,c=0,f=0,v=0,p=!1,d=1,y="";var m;m=()=>{n(17,r=new Et(s,256,192)),r.on("load",()=>{n(19,c=r.frameCount),n(21,v=r.duration),n(5,d=r.volume),n(17,r.muted=a,r),r.resize(r.note.width,r.note.height)}),r.on("progress",t=>{n(3,u=t),n(20,f=r.currentTime)}),r.on("playback:start",()=>{n(4,p=!0)}),r.on("playback:stop",()=>{n(4,p=!1)}),r.on("frame:update",()=>{n(18,l=r.currentFrame+1)})},g().$$.on_mount.push(m);let w=new Promise((t,i)=>i());return t.$set=t=>{"src"in t&&n(14,e=t.src),"controls"in t&&n(1,o=t.controls),"timeformat"in t&&n(15,h=t.timeformat),"muted"in t&&n(0,a=t.muted)},t.$$.update=()=>{16384&t.$$.dirty&&e&&n(7,w=async function(t){await r.open(t)}(e)),131073&t.$$.dirty&&r&&n(17,r.muted=a,r),3964928&t.$$.dirty&&n(6,y="time"===h?`${zt(f)} / ${zt(v)}`:`${It(l,3)} / ${It(c,3)}`)},[a,o,s,u,p,d,y,w,function(t){r&&r.startSeek()},function(t){const{value:i}=t.detail;r&&r.seek(100*i)},function(t){r&&r.endSeek()},function(t){const{value:i}=t.detail;r&&(n(17,r.volume=i,r),n(5,d=i),d>0&&a&&n(0,a=!1))},function(){r&&r.togglePlay()},function(){n(0,a=!a)},e,h,function(t){A[t?"unshift":"push"](()=>{s=t,n(2,s)})}]}customElements.define("flipnote-player-icon",class extends z{constructor(t){super(),this.shadowRoot.innerHTML="<style>.PlayerIcon{width:100%;height:100%;color:var(--flipnote-player-icon-color, #F36A2D)}</style>",D(this,{target:this.shadowRoot},Wt,Dt,o,{icon:0}),t&&(t.target&&a(t.target,this,t.anchor),t.props&&(this.$set(t.props),B()))}static get observedAttributes(){return["icon"]}get icon(){return this.$$.ctx[0]}set icon(t){this.$set({icon:t}),B()}});class Zt extends z{constructor(t){super(),this.shadowRoot.innerHTML="<style>.Button{border:0;padding:0;outline:0;-webkit-appearance:none;display:block;font-family:inherit;font-size:inherit;text-align:center;cursor:pointer;background:var(--flipnote-player-button-background, #FFD3A6);color:var(--flipnote-player-button-color, #F36A2D);border-radius:4px}.Button flipnote-player-icon{display:block}.FlipnotePlayer{display:inline-block;position:relative;font-family:var(--flipnote-player-font-family, sans-serif)}.FlipnotePlayer__canvasArea{position:relative}.FlipnotePlayer__canvas{position:relative;display:block}.FlipnotePlayer__overlay{position:absolute;top:0;left:0;background:#e5e5e9;color:#4b4c53;width:100%;height:100%;display:flex;justify-content:center;align-items:center}@keyframes spin{from{transform:rotateZ(0)}to{transform:rotateZ(360deg)}}.FlipnotePlayer__loaderIcon{animation:spin infinite 1.2s linear}.FlipnotePlayerControls{background:var(--flipnote-player-controls-background, none)}.FlipnotePlayerControls__muteIcon{width:28px;height:28px}.FlipnotePlayerControls__row,.FlipnotePlayerControls__groupLeft,.FlipnotePlayerControls__groupRight{display:flex;align-items:center}.FlipnotePlayerControls__groupLeft{margin-right:auto}.FlipnotePlayerControls__groupRight{margin-left:auto}.FlipnotePlayerControls__playButton{height:32px;width:32px;padding:2px}.FlipnotePlayerControls__frameCounter{font-variant-numeric:tabular-nums}.FlipnotePlayerControls--compact .FlipnotePlayerControls__playButton{margin-right:12px}.FlipnotePlayerControls--compact .FlipnotePlayerControls__progressBar{flex:1}.FlipnotePlayerControls--default .FlipnotePlayerControls__playButton{margin-right:8px}.FlipnotePlayerControls--default .FlipnotePlayerControls__volumeBar{width:70px;margin-left:8px}</style>",D(this,{target:this.shadowRoot},qt,Vt,o,{src:14,controls:1,timeformat:15,muted:0}),t&&(t.target&&a(t.target,this,t.anchor),t.props&&(this.$set(t.props),B()))}static get observedAttributes(){return["src","controls","timeformat","muted"]}get src(){return this.$$.ctx[14]}set src(t){this.$set({src:t}),B()}get controls(){return this.$$.ctx[1]}set controls(t){this.$set({controls:t}),B()}get timeformat(){return this.$$.ctx[15]}set timeformat(t){this.$set({timeformat:t}),B()}get muted(){return this.$$.ctx[0]}set muted(t){this.$set({muted:t}),B()}}var Yt,Xt=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],Jt=function(){function t(t,i,n,r){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=i,this.pixels=n,this.colorDepth=r,this.initCodeSize=Math.max(2,this.colorDepth),this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.a_count,this.remaining,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}return t.prototype.char_out=function(t,i){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(i)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var i=0;i<t;++i)this.htab[i]=-1},t.prototype.compress=function(t,i){var n,r,s,e,o,h;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,e=this.nextPixel(),h=0,n=5003;n<65536;n*=2)++h;h=8-h,this.cl_hash(5003),this.output(this.ClearCode,i);t:for(;-1!=(r=this.nextPixel());)if(n=(r<<12)+e,s=r<<h^e,this.htab[s]!==n){if(this.htab[s]>=0){o=5003-s,0===s&&(o=1);do{if((s-=o)<0&&(s+=5003),this.htab[s]===n){e=this.codetab[s];continue t}}while(this.htab[s]>=0)}this.output(e,i),e=r,this.free_ent<4096?(this.codetab[s]=this.free_ent++,this.htab[s]=n):this.cl_block(i)}else e=this.codetab[s];this.output(e,i),this.output(this.EOFCode,i)},t.prototype.encode=function(t){t.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,t),t.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,i){for(this.cur_accum&=Xt[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(i)}},t}(),Qt=function(){function t(t,i){this.delay=100,this.repeat=-1,this.colorDepth=8,this.palette=[],this.width=t,this.height=i,this.data=new $}return t.fromFlipnote=function(i){var n=new t(i.width,i.height);n.palette=i.globalPalette,n.delay=100/i.framerate,n.repeat=i.meta.loop?-1:0,n.init();for(var r=0;r<i.frameCount;r++)n.writeFrame(i.getFramePixels(r));return n},t.fromFlipnoteFrame=function(i,n){var r=new t(i.width,i.height);return r.palette=i.globalPalette,r.delay=100/i.framerate,r.repeat=i.meta.loop?-1:0,r.init(),r.writeFrame(i.getFramePixels(n)),r},t.prototype.init=function(){for(var t=this.palette.length,i=1;1<<i<t;i+=1)continue;this.colorDepth=i,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt()},t.prototype.writeHeader=function(){var t=new K(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.colorDepth-1),t.writeUint8(0),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.colorDepth)),i=0,n=0;i<this.palette.length;i+=1,n+=3)t.set(this.palette[i],n);this.data.writeBytes(t)},t.prototype.writeGraphicsControlExt=function(){var t=new K(new ArrayBuffer(8));t.writeBytes([33,249,4,0]),t.writeUint16(this.delay),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeNetscapeExt=function(){var t=new K(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeImageDesc=function(){var t=new K(new ArrayBuffer(10));t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writePixels=function(t){new Jt(this.width,this.height,t,this.colorDepth).encode(this.data)},t.prototype.writeFrame=function(t){this.writeGraphicsControlExt(),this.writeImageDesc(),this.writePixels(t)},t.prototype.getBuffer=function(){return this.data.getBuffer()},t.prototype.getBlob=function(){return new Blob([this.getBuffer()],{type:"image/gif"})},t.prototype.getUrl=function(){return window.URL.createObjectURL(this.getBlob())},t.prototype.getImage=function(){var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},t}(),ti=function(){function t(t,i,n){void 0===i&&(i=1),void 0===n&&(n=16),this.sampleRate=t,this.channels=i,this.bitsPerSample=n;var r=new ArrayBuffer(44),s=new K(r);s.writeChars("RIFF"),s.writeUint32(0),s.writeChars("WAVE"),s.writeChars("fmt "),s.writeUint32(16),s.writeUint16(1),s.writeUint16(this.channels),s.writeUint32(this.sampleRate),s.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),s.writeUint16(this.bitsPerSample*this.channels/8),s.writeUint16(this.bitsPerSample),s.writeChars("data"),s.writeUint32(0),this.header=s,this.pcmData=null}return t.fromFlipnote=function(i){var n=new t(44100,1,16),r=i.getAudioMasterPcm(44100);return n.writeFrames(r),n},t.fromFlipnoteTrack=function(i,n){var r=new t(44100,1,16),s=i.getAudioTrackPcm(n,44100);return r.writeFrames(s),r},t.prototype.writeFrames=function(t){var i=this.header;i.seek(4),i.writeUint32(i.byteLength+t.byteLength),i.seek(40),i.writeUint32(t.byteLength),this.pcmData=t},t.prototype.getBlob=function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})},t}();!function(t){t.version="4.1.0",t.player=Et,t.parseSource=kt,t.kwzParser=Ct,t.ppmParser=ht,t.gifEncoder=Qt,t.wavEncoder=ti}(Yt||(Yt={}));var ii=Et,ni=kt,ri=Ct,si=ht,ei=Qt,oi=ti;customElements.define("flipnote-player",Zt);var hi=Zt;t.gifEncoder=ei,t.kwzParser=ri,t.parseSource=ni,t.player=ii,t.playerComponent=hi,t.ppmParser=si,t.version="4.1.0",t.wavEncoder=oi,Object.defineProperty(t,"h",{value:!0})}));
