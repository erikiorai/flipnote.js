/*!!
 * flipnote.js v6.0.1
 * https://flipnote.js.org
 * A JavaScript library for Flipnote Studio animation files
 * 2018 - 2024 James Daniel
 * Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
*/
!function(i){var r,n,h,o,a,l;function c(i,r,n,h){var o,a=arguments.length,l=a<3?r:null===h?h=Object.getOwnPropertyDescriptor(r,n):h;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(i,r,n,h);else for(var c=i.length-1;c>=0;c--)(o=i[c])&&(l=(a<3?o(l):a>3?o(r,n,l):o(r,n))||l);return a>3&&l&&Object.defineProperty(r,n,l),l}function f(i,r,n,h){if("a"===n&&!h)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof r?i!==r||!h:!r.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?h:"a"===n?h.call(i):h?h.value:r.get(i)}function u(i,r,n,h,o){if("m"===h)throw new TypeError("Private method is not writable");if("a"===h&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof r?i!==r||!o:!r.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===h?o.call(i,n):o?o.value=n:r.set(i,n),n}i.FlipnoteRegion=void 0,(r=i.FlipnoteRegion||(i.FlipnoteRegion={})).EUR="EUR",r.USA="USA",r.JPN="JPN",r.UNKNOWN="UNKNOWN",i.FlipnoteFormat=void 0,(n=i.FlipnoteFormat||(i.FlipnoteFormat={})).PPM="PPM",n.KWZ="KWZ",i.FlipnoteThumbImageFormat=void 0,(h=i.FlipnoteThumbImageFormat||(i.FlipnoteThumbImageFormat={}))[h.Jpeg=0]="Jpeg",h[h.Rgba=1]="Rgba",i.FlipnoteStereoscopicEye=void 0,(o=i.FlipnoteStereoscopicEye||(i.FlipnoteStereoscopicEye={}))[o.Left=0]="Left",o[o.Right=1]="Right",i.FlipnoteAudioTrack=void 0,(a=i.FlipnoteAudioTrack||(i.FlipnoteAudioTrack={}))[a.BGM=0]="BGM",a[a.SE1=1]="SE1",a[a.SE2=2]="SE2",a[a.SE3=3]="SE3",a[a.SE4=4]="SE4",i.FlipnoteSoundEffectTrack=void 0,(l=i.FlipnoteSoundEffectTrack||(i.FlipnoteSoundEffectTrack={}))[l.SE1=1]="SE1",l[l.SE2=2]="SE2",l[l.SE3=3]="SE3",l[l.SE4=4]="SE4","function"==typeof SuppressedError&&SuppressedError;class ByteArray{constructor(){this.pageSize=4096,this.allocSize=0,this.realSize=0,this.pages=[],this.numPages=0,this.pageIdx=0,this.pagePtr=0,this.realPtr=0,this.newPage()}set pointer(i){this.setPointer(i)}get pointer(){return this.realPtr}newPage(){this.pages[this.numPages]=new Uint8Array(this.pageSize),this.numPages=this.pages.length,this.allocSize=this.numPages*this.pageSize}setPointer(i){for(;i>=this.allocSize;)this.newPage();i>this.realSize&&(this.realSize=i),this.pageIdx=Math.floor(i/this.pageSize),this.pagePtr=i%this.pageSize,this.realPtr=i}writeByte(i){this.pages[this.pageIdx][this.pagePtr]=i,this.setPointer(this.realPtr+1)}writeBytes(i,r,n){for(let h=n||i.length,o=r||0;o<h;o++)this.writeByte(i[o])}writeChars(i){for(let r=0;r<i.length;r++)this.writeByte(i.charCodeAt(r))}writeU8(i){this.writeByte(255&i)}writeU16(i){this.writeByte(i>>>0&255),this.writeByte(i>>>8&255)}writeU32(i){this.writeByte(i>>>0&255),this.writeByte(i>>>8&255),this.writeByte(i>>>16&255),this.writeByte(i>>>24&255)}getBytes(){const i=new Uint8Array(this.realSize),r=this.numPages;for(let n=0;n<r;n++){const h=this.pages[n];n===r-1?i.set(h.slice(0,this.realSize%this.pageSize),n*this.pageSize):i.set(h,n*this.pageSize)}return i}getBuffer(){return this.getBytes().buffer}}const d=(i,r=!1)=>{let n=[];for(let r=0;r<i.length;r++)n.push(i[r].toString(16).padStart(2,"0"));return r&&n.reverse(),n.join("")};class DataStream{constructor(i){this.buffer=i,this.data=new DataView(i),this.pointer=0}get bytes(){return new Uint8Array(this.buffer)}get numBytes(){return this.data.byteLength}seek(i,r){switch(r){case 2:this.pointer=this.data.byteLength+i;break;case 1:this.pointer+=i;break;default:this.pointer=i}}readUint8(){const i=this.data.getUint8(this.pointer);return this.pointer+=1,i}writeUint8(i){this.data.setUint8(this.pointer,i),this.pointer+=1}readInt8(){const i=this.data.getInt8(this.pointer);return this.pointer+=1,i}writeInt8(i){this.data.setInt8(this.pointer,i),this.pointer+=1}readUint16(i=!0){const r=this.data.getUint16(this.pointer,i);return this.pointer+=2,r}writeUint16(i,r=!0){this.data.setUint16(this.pointer,i,r),this.pointer+=2}readInt16(i=!0){const r=this.data.getInt16(this.pointer,i);return this.pointer+=2,r}writeInt16(i,r=!0){this.data.setInt16(this.pointer,i,r),this.pointer+=2}readUint32(i=!0){const r=this.data.getUint32(this.pointer,i);return this.pointer+=4,r}writeUint32(i,r=!0){this.data.setUint32(this.pointer,i,r),this.pointer+=4}readInt32(i=!0){const r=this.data.getInt32(this.pointer,i);return this.pointer+=4,r}writeInt32(i,r=!0){this.data.setInt32(this.pointer,i,r),this.pointer+=4}readBytes(i){const r=new Uint8Array(this.data.buffer,this.pointer,i);return this.pointer+=r.byteLength,r}writeBytes(i){i.forEach((i=>this.writeUint8(i)))}readHex(i,r=!1){const n=this.readBytes(i);return d(n,r)}readChar(){const i=this.readUint8();return String.fromCharCode(i)}readWideChar(){const i=this.readUint16();return String.fromCharCode(i)}readChars(i){const r=this.readBytes(i);let n="";for(let i=0;i<r.length;i++){const h=r[i];if(0===h)break;n+=String.fromCharCode(h)}return n}writeChars(i){for(let r=0;r<i.length;r++){const n=i.charCodeAt(r);this.writeUint8(n)}}readWideChars(i){const r=new Uint16Array(this.data.buffer,this.pointer,i);let n="";for(let i=0;i<r.length;i++){const h=r[i];if(0==h)break;n+=String.fromCharCode(h)}return this.pointer+=r.byteLength,n}end(){return this.pointer>=this.data.byteLength}}const p=(i,r,n)=>i<r?r:i>n?n:i,m=(i,r,n)=>i+n*(r-i);function y(i,r="Assert failed"){i||v(r)}const w=(i,r,n,h="")=>y(i>=r&&i<=n,`flipnote.js error: ${h||"value"} ${i} should be between ${r} and ${n}`),v=(i="Assert failed")=>{throw new Error("flipnote.js error: "+i)},g=()=>C?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},A="undefined"!=typeof window&&void 0!==window.document,P=()=>y(A,"This feature is only available in browser environments"),C="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,_="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,x=A&&(window.requestAnimationFrame||window.webkitRequestAnimationFrame);var F;!function(){if(!A)return function(){};document.createElement("a")}();class BaseParser extends DataStream{constructor(){super(...arguments),this[F]="Flipnote",this.titleFormats={COMMENT:"Comment by $USERNAME",FLIPNOTE:"Flipnote by $USERNAME",ICON:"Folder icon"},this.soundMeta=new Map,this.layerVisibility={1:!0,2:!0,3:!0},this.isFolderIcon=!1,this.isComment=!1,this.isDsiLibraryNote=!1}getTitle(i=this.titleFormats){return this.isFolderIcon?i.ICON:(this.isComment?i.COMMENT:i.FLIPNOTE).replace("$USERNAME",this.meta.current.username)}toString(){return this.getTitle()}*[(F=Symbol.toStringTag,Symbol.iterator)](){for(let i=0;i<this.frameCount;i++)yield i}getLayerPixels(r,n,h=new Uint8Array(this.imageWidth*this.imageHeight),o=0,a=i.FlipnoteStereoscopicEye.Left){w(r,0,this.frameCount-1,"Frame index"),w(n,0,this.numLayers-1,"Layer index");const l=this.getFramePaletteIndices(r),c=n*this.numLayerColors,f=this.decodeFrame(r)[n],u=Math.floor(this.getFrameLayerDepths(r)[n]*o),d=a==i.FlipnoteStereoscopicEye.Left?-u:u,p=this.srcWidth,m=this.imageWidth,y=this.imageWidth,v=this.imageHeight,g=this.imageOffsetX,A=this.imageOffsetY;if(h.fill(0),!this.layerVisibility[n+1])return h;for(let i=A,r=0;r<v;i++,r++)for(let n=g,o=0;o<y;n++,o++){const a=r*m+o+d;let u=f[i*p+n];0!==u&&(h[a]=l[c+u])}return h}getLayerPixelsRgba(r,n,h=new Uint32Array(this.imageWidth*this.imageHeight),o=new Uint32Array(16),a=0,l=i.FlipnoteStereoscopicEye.Left){w(r,0,this.frameCount-1,"Frame index"),w(n,0,this.numLayers-1,"Layer index"),this.getFramePaletteUint32(r,o);const c=n*this.numLayerColors,f=this.decodeFrame(r)[n],u=Math.floor(this.getFrameLayerDepths(r)[n]*a),d=l==i.FlipnoteStereoscopicEye.Left?-u:u,p=this.srcWidth,m=this.imageWidth,y=this.imageWidth-u,v=this.imageHeight,g=this.imageOffsetX,A=this.imageOffsetY;if(h.fill(0),!this.layerVisibility[n+1])return h;for(let i=A,r=0;r<v;i++,r++)for(let n=g,a=0;a<y;n++,a++){const l=r*m+a+d;let u=f[i*p+n];0!==u&&(h[l]=o[c+u])}return h}getFramePixels(r,n=new Uint8Array(this.imageWidth*this.imageHeight),h=0,o=i.FlipnoteStereoscopicEye.Left){const a=this.srcWidth;this.imageWidth;const l=this.imageWidth,c=this.imageHeight,f=this.imageOffsetX,u=this.imageOffsetY,d=this.getFramePaletteIndices(r);n.fill(d[0]);const p=this.getFrameLayerOrder(r),m=this.getFrameLayerDepths(r),y=this.decodeFrame(r);for(let r=0;r<this.numLayers;r++){const w=p[r],v=y[w],g=w*this.numLayerColors,A=Math.floor(m[w]*h),P=o==i.FlipnoteStereoscopicEye.Left?-A:A;if(this.layerVisibility[w+1])for(let i=u,r=0;r<c;i++,r++)for(let h=f,o=0;o<l;h++,o++){const c=r*l+o+P;let f=v[i*a+h];0!==f&&(n[c]=d[g+f])}}return n}getFramePixelsRgba(r,n=new Uint32Array(this.imageWidth*this.imageHeight),h=new Uint32Array(16),o=0,a=i.FlipnoteStereoscopicEye.Left){w(r,0,this.frameCount-1,"Frame index");const l=this.srcWidth,c=this.imageWidth,f=this.imageWidth,u=this.imageHeight,d=this.imageOffsetX,p=this.imageOffsetY;this.getFramePaletteUint32(r,h),n.fill(h[0]);const m=this.getFrameLayerOrder(r),y=this.getFrameLayerDepths(r),v=this.decodeFrame(r);for(let r=0;r<this.numLayers;r++){const w=m[r];if(!this.layerVisibility[w+1])continue;const g=v[w],A=w*this.numLayerColors,P=Math.floor(y[w]*o),C=a==i.FlipnoteStereoscopicEye.Left?-P:P;for(let i=p,r=0;i<u;i++,r++)for(let o=d,a=0;o<f;o++,a++){const f=r*c+a+C;let u=g[i*l+o];0!==u&&(n[f]=h[A+u])}}return n}getFramePaletteUint32(i,r=new Uint32Array(16)){w(i,0,this.frameCount-1,"Frame index");const n=this.getFramePalette(i);return r.fill(0),n.forEach((([i,n,h,o],a)=>r[a]=o<<24|h<<16|n<<8|i)),r}getSoundEffectFlagsForTrack(i){return this.getSoundEffectFlags().map((r=>r[i]))}isSoundEffectUsedOnFrame(i,r){return w(r,0,this.frameCount-1,"Frame index"),!!this.soundEffectTracks.includes(i)&&this.getFrameSoundEffectFlags(r)[i]}hasAudioTrack(i){return this.soundMeta.has(i)&&this.soundMeta.get(i).length>0}}const z=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,$=["01FACA7A4367FC5F","03D6E959E2F9A42D","03F80445160587FA","04068426E1008915","092A3EC8199FD5D5","0B8D56BA1BD441B8","0E61C75C9B5AD90B","14E494E35A443235"],U=i=>z.test(i)||$.includes(i),E=r=>{switch(r.charAt(0)){case"0":case"1":return i.FlipnoteRegion.JPN;case"5":return i.FlipnoteRegion.USA;case"9":return i.FlipnoteRegion.EUR;default:return i.FlipnoteRegion.UNKNOWN}},T=new Int8Array([-1,2,-1,2]),B=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),W=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),K=(i,r,n)=>n<0||n>=r?0:i[n],N=i=>{const r=i.length;let n=0;for(let h=0;h<r;h++){const r=i[h];(r<=-32768||r>=32767)&&(n+=1)}return n/r},D=i=>{const r=i.length;let n=0;for(let h=0;h<r;h++)n+=Math.pow(i[h],2);return Math.sqrt(n/r)},O=946684800,j=i=>new Date(1e3*(i+O)),G=i=>Math.floor(i.getTime()/1e3-O),Z=(i,r)=>100*i*(1/r)/100,q=(()=>{if(A||_){const i=g();return(i.crypto||i.msCrypto).subtle}if(C)return((i,r)=>{try{return i.require(r)}catch{throw new Error(`Could not require(${r})`)}})(module,"crypto").webcrypto.subtle})(),Q="RSASSA-PKCS1-v1_5",Y=async(i,r)=>{const n=i.split("\n").filter((i=>!i.startsWith("-----")&&!i.endsWith("-----"))).join(""),h=atob(n),o=new Uint8Array(h.length).map(((i,r)=>h.charCodeAt(r)));return await q.importKey("spki",o.buffer,{name:Q,hash:r},!1,["verify"])},J=async(i,r,n)=>await q.verify(Q,i,r,n);var X,tt,it,st,et,rt,nt,ht,ot,at,lt,ct,ft,ut,dt,pt,mt,yt;const wt=[.5,.5,1,2,4,6,12,20,30],vt={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},gt=[4294967295,4283585106,4294967295,4288453788,4282665215,4283388360,4289506815,4278255360,4294918216,4290269009,4294945709,4278255360,4290205622,4278255360,4278255360,4278255360],bt="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCPLwTL6oSflv+gjywi/sM0TUB\n90xqOvuCpjduETjPoN2FwMebxNjdKIqHUyDu4AvrQ6BDJc6gKUbZ1E27BGZoCPH4\n9zQRb+zAM6M9EjHwQ6BABr0u2TcF7xGg2uQ9MBWz9AfbVQ91NjfrNWo0f7UPmffv\n1VvixmTk1BCtavZxBwIDAQAB\n-----END PUBLIC KEY-----";class PpmParser extends BaseParser{static matchBuffer(i){const r=new Uint8Array(i.slice(0,4));return 1346458177==(r[0]<<24|r[1]<<16|r[2]<<8|r[3])}constructor(r,n={}){super(r),X.add(this),this.format=i.FlipnoteFormat.PPM,this[yt]="Flipnote Studio PPM animation file",this.imageWidth=PpmParser.width,this.imageHeight=PpmParser.height,this.aspect=PpmParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=PpmParser.numLayers,this.numLayerColors=PpmParser.numLayerColors,this.publicKey=PpmParser.publicKey,this.srcWidth=PpmParser.width,this.audioTracks=PpmParser.audioTracks,this.soundEffectTracks=PpmParser.soundEffectTracks,this.rawSampleRate=PpmParser.rawSampleRate,this.sampleRate=PpmParser.sampleRate,this.globalPalette=PpmParser.globalPalette,tt.set(this,void 0),it.set(this,void 0),st.set(this,void 0),et.set(this,void 0),rt.set(this,null),nt.set(this,void 0),ht.set(this,void 0),ot.set(this,void 0),at.set(this,void 0),f(this,X,"m",lt).call(this),f(this,X,"m",ut).call(this),f(this,X,"m",dt).call(this),this.version>>4&15&&f(this,X,"m",ft).call(this),u(this,tt,[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],"f"),u(this,st,[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],"f"),u(this,et,[new Uint8Array(PpmParser.height),new Uint8Array(PpmParser.height)],"f"),u(this,rt,null,"f")}getThumbnailImage(){this.seek(160);const r=this.readBytes(1536),n=new Uint32Array(3072);for(let i=0;i<48;i+=8)for(let h=0;h<64;h+=8)for(let o=0;o<8;o+=1)for(let a=0;a<8;a+=2){const l=h+a,c=i+o;n[64*c+l]=gt[15&r[0]],n[64*c+l+1]=gt[r[0]<<4&15]}return{format:i.FlipnoteThumbImageFormat.Rgba,width:64,height:48,data:n.buffer}}decodeFrame(i){if(w(i,0,this.frameCount-1,"Frame index"),f(this,rt,"f")===i)return f(this,tt,"f");f(this,rt,"f")===i-1||f(this,X,"m",pt).call(this,i)||0===i||this.decodeFrame(i-1),u(this,rt,i,"f"),this.seek(f(this,at,"f")[i]);const r=this.readUint8(),n=r>>7&1,h=r>>5&3;f(this,tt,"f")[0].fill(0),f(this,tt,"f")[1].fill(0);let o=0,a=0;h&&(o=this.readInt8(),a=this.readInt8());for(let i=0;i<2;i++){const r=f(this,et,"f")[i];r.fill(0);for(let i=0;i<r.length;){let n=this.readUint8();0!==n?(r[i++]=3&n,r[i++]=n>>2&3,r[i++]=n>>4&3,r[i++]=n>>6&3):i+=4}}for(let i=0;i<2;i++){const r=f(this,tt,"f")[i],n=f(this,et,"f")[i];for(let i=0;i<PpmParser.height;i++){let h=i*PpmParser.width;switch(n[i]){case 0:break;case 1:for(var l=this.readUint32(!1);0!==l;l<<=1,h+=8)if(2147483648&l){let i=this.readUint8();for(let n=0;0!==i;n++,i>>=1)r[h+n]=1&i}break;case 2:for(r.fill(1,h,h+PpmParser.width),l=this.readUint32(!1);0!==l;l<<=1,h+=8)if(2147483648&l){let i=this.readUint8();for(let n=0;n<8;n++,i>>=1)r[h+n]=1&i}break;case 3:for(let i=0,n=0;n<PpmParser.width;n++)n%8==0&&(i=this.readUint8()),r[h++]=1&i,i>>=1}}}const c=f(this,tt,"f")[0],d=f(this,tt,"f")[1],p=f(this,st,"f")[0],m=f(this,st,"f")[1];if(n||0!==o||0!==a){if(!n){const i=PpmParser.width,r=PpmParser.height,n=Math.max(o,0),h=Math.max(a,0),l=Math.min(i+o,i),f=Math.min(r+a,r),u=a*i+o;let y,w;for(let r=h;r<f;r++)for(let h=n;h<l;h++)y=r*i+h,w=y-u,c[y]^=p[w],d[y]^=m[w]}}else{const i=PpmParser.height*PpmParser.width;for(let r=0;r<i;r++)c[r]^=p[r],d[r]^=m[r]}return f(this,st,"f")[0].set(f(this,tt,"f")[0]),f(this,st,"f")[1].set(f(this,tt,"f")[1]),f(this,tt,"f")}getFramePaletteIndices(i){w(i,0,this.frameCount-1,"Frame index"),this.seek(f(this,at,"f")[i]);const r=this.readUint8(),n=!!(1&~r),h=[n?0:1,n?0:1,2,3];return[n?1:0,h[r>>1&3],h[r>>3&3]]}getFramePalette(i){return w(i,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(i).map((i=>this.globalPalette[i]))}getIsKeyFrame(i){const r=1===f(this,X,"m",pt).call(this,i);return[r,r]}getFrameLayerDepths(i){return[0,0]}getFrameAuthor(i){return this.meta.current.fsid}getFrameCameraFlags(i){return[!1,!1]}getFrameLayerOrder(i){return[1,0]}decodeSoundFlags(){if(void 0!==f(this,it,"f"))return f(this,it,"f");y(1696+f(this,nt,"f")<this.numBytes),this.seek(1696+f(this,nt,"f"));const i=this.frameCount,r=this.readBytes(i);u(this,it,new Array(i),"f");for(let n=0;n<i;n++){const i=r[n];f(this,it,"f")[n]=[!!(1&i),!!(2&i),!!(4&i)]}return f(this,it,"f")}getSoundEffectFlags(){return this.decodeSoundFlags().map((r=>({[i.FlipnoteSoundEffectTrack.SE1]:r[0],[i.FlipnoteSoundEffectTrack.SE2]:r[1],[i.FlipnoteSoundEffectTrack.SE3]:r[2],[i.FlipnoteSoundEffectTrack.SE4]:!1})))}getFrameSoundEffectFlags(r){w(r,0,this.frameCount-1,"Frame index"),this.seek(1696+f(this,nt,"f")+r);const n=this.readUint8();return{[i.FlipnoteSoundEffectTrack.SE1]:!!(1&n),[i.FlipnoteSoundEffectTrack.SE2]:!!(2&n),[i.FlipnoteSoundEffectTrack.SE3]:!!(4&n),[i.FlipnoteSoundEffectTrack.SE4]:!1}}getAudioTrackRaw(i){const r=this.soundMeta.get(i);return y(r.ptr+r.length<this.numBytes),this.seek(r.ptr),this.readBytes(r.length)}decodeAudioTrack(i){const r=this.getAudioTrackRaw(i),n=r.length,h=new Int16Array(2*n);let o=0,a=0,l=0,c=0,f=0,u=!0;for(;o<n;){l=u?15&r[o]:r[o++]>>4,u=!u;const i=W[c];let n=i>>3;1&l&&(n+=i>>2),2&l&&(n+=i>>1),4&l&&(n+=i),8&l&&(n=-n),f+=n,f=p(f,-32768,32767),c+=B[l],c=p(c,0,88),h[a++]=f}return h}getAudioTrackPcm(r,n=this.sampleRate){const h=this.decodeAudioTrack(r);let o=this.rawSampleRate;if(r===i.FlipnoteAudioTrack.BGM){const i=1/this.bgmrate/(1/this.framerate);o=this.rawSampleRate*i}return o!==n?((i,r,n)=>{const h=i.length,o=h/r*n,a=new Int16Array(o),l=r/n;for(let r=0;r<o;r++)a[r]=K(i,h,Math.floor(r*l));return a})(h,o,n):h}getAudioMasterPcm(r=this.sampleRate){const n=Math.ceil(this.duration*r),h=new Int16Array(n),o=this.hasAudioTrack(i.FlipnoteAudioTrack.BGM),a=this.hasAudioTrack(i.FlipnoteAudioTrack.SE1),l=this.hasAudioTrack(i.FlipnoteAudioTrack.SE2),c=this.hasAudioTrack(i.FlipnoteAudioTrack.SE3);if(o){const n=this.getAudioTrackPcm(i.FlipnoteAudioTrack.BGM,r);f(this,X,"m",mt).call(this,n,h,0)}if(a||l||c){const n=r/this.framerate,o=a?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE1,r):null,u=l?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE2,r):null,d=c?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE3,r):null,p=this.decodeSoundFlags();for(let i=0;i<this.frameCount;i++){const r=Math.ceil(i*n),m=p[i];a&&m[0]&&f(this,X,"m",mt).call(this,o,h,r),l&&m[1]&&f(this,X,"m",mt).call(this,u,h,r),c&&m[2]&&f(this,X,"m",mt).call(this,d,h,r)}}return this.audioClipRatio=N(h),h}getBody(){const i=f(this,ot,"f")+f(this,ht,"f")+32;return this.bytes.subarray(0,i)}getSignature(){const i=f(this,ot,"f")+f(this,ht,"f")+32;return this.bytes.subarray(i,i+128)}async verify(){const i=await Y(bt,"SHA-1");return await J(i,this.getSignature(),this.getBody())}}tt=new WeakMap,it=new WeakMap,st=new WeakMap,et=new WeakMap,rt=new WeakMap,nt=new WeakMap,ht=new WeakMap,ot=new WeakMap,at=new WeakMap,X=new WeakSet,yt=Symbol.toStringTag,lt=function(){y(16<this.numBytes),this.seek(4),u(this,nt,this.readUint32(),"f"),u(this,ht,this.readUint32(),"f"),this.frameCount=this.readUint16()+1,this.version=this.readUint16();let i=1696+f(this,nt,"f")+this.frameCount;i%4!=0&&(i+=4-i%4),y(i<this.numBytes),u(this,ot,i,"f")},ct=function(){return`${this.readHex(3)}_${this.readChars(13)}_${this.readUint16().toString().padStart(3,"0")}`},ft=function(){y(1704<this.numBytes),this.seek(16);const i=this.readUint16(),r=this.readInt16(),n=this.readWideChars(11),h=this.readWideChars(11),o=this.readWideChars(11),a=this.readHex(8,!0),l=this.readHex(8,!0),c=f(this,X,"m",ct).call(this),u=f(this,X,"m",ct).call(this),d=this.readHex(8,!0);this.seek(154);const p=j(this.readInt32());this.seek(1702);const m=this.readUint16();this.thumbFrameIndex=r,this.layerVisibility={1:!(16&m),2:!(32&m),3:!1},this.isSpinoff=l!==a||l!==d,this.meta={lock:1===i,loop:1==(m>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:r,timestamp:p,root:{username:n,fsid:d,region:E(d),filename:null},parent:{username:h,fsid:a,region:E(a),filename:c},current:{username:o,fsid:l,region:E(l),filename:u}}},ut=function(){this.seek(1696);const i=this.readUint16(),r=i/4;y(r<=this.frameCount),this.seek(1704);const n=new Uint32Array(r);for(let h=0;h<r;h++){const r=1704+i+this.readUint32();y(r<this.numBytes,`Frame ${h} pointer is out of bounds`),n[h]=r}u(this,at,n,"f")},dt=function(){let r=f(this,ot,"f");this.seek(r);const n=this.readUint32(),h=this.readUint32(),o=this.readUint32(),a=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),y(this.frameSpeed<=8&&this.bgmSpeed<=8),r+=32,this.framerate=wt[this.frameSpeed],this.duration=Z(this.frameCount,this.framerate),this.bgmrate=wt[this.bgmSpeed];const l=new Map;l.set(i.FlipnoteAudioTrack.BGM,{ptr:r,length:n}),l.set(i.FlipnoteAudioTrack.SE1,{ptr:r+=n,length:h}),l.set(i.FlipnoteAudioTrack.SE2,{ptr:r+=h,length:o}),l.set(i.FlipnoteAudioTrack.SE3,{ptr:r+=o,length:a}),this.soundMeta=l},pt=function(i){return w(i,0,this.frameCount-1,"Frame index"),this.seek(f(this,at,"f")[i]),this.readUint8()>>7&1},mt=function(i,r,n=0){const h=i.length,o=r.length;for(let a=0;a<h&&!(n+a>o);a++){const h=r[n+a]+i[a]/2;r[n+a]=p(h,-32768,32767)}},PpmParser.defaultSettings={},PpmParser.format=i.FlipnoteFormat.PPM,PpmParser.width=256,PpmParser.height=192,PpmParser.aspect=3/4,PpmParser.numLayers=2,PpmParser.numLayerColors=1,PpmParser.rawSampleRate=8192,PpmParser.sampleRate=32768,PpmParser.audioTracks=[i.FlipnoteAudioTrack.BGM,i.FlipnoteAudioTrack.SE1,i.FlipnoteAudioTrack.SE2,i.FlipnoteAudioTrack.SE3],PpmParser.soundEffectTracks=[i.FlipnoteSoundEffectTrack.SE1,i.FlipnoteSoundEffectTrack.SE2,i.FlipnoteSoundEffectTrack.SE3],PpmParser.globalPalette=[vt.WHITE,vt.BLACK,vt.RED,vt.BLUE],PpmParser.publicKey=bt;const At=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,Pt=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/,Ct=["5f-fc67-437a-cafa01","2d-a4f9-e259-e9d603","fa-8705-1645-04f803","15-8900-e126-840604","d5-d59f-19c8-3e2a09","b8-41d4-1bba-568d0b","0b-d95a-9b5c-c7610e","35-3244-5ae3-94e414"],St=i=>At.test(i),_t=i=>{if(Pt.test(i))return!0;for(let r of Ct)if(i.endsWith(r))return!0;return!1},xt=r=>{if(_t(r))switch(r.charAt(19)){case"0":case"1":return i.FlipnoteRegion.JPN;case"5":return i.FlipnoteRegion.USA;case"9":return i.FlipnoteRegion.EUR;default:return i.FlipnoteRegion.UNKNOWN}return i.FlipnoteRegion.UNKNOWN},Mt=i=>`${i.slice(0,4)}-${i.slice(4,8)}-${i.slice(8,12)}-${i.slice(12,18)}`.toLowerCase(),kt=i=>i.replace(/-/g,"").toUpperCase();var Ft,zt,$t,Ut,Et,It,Tt,Bt,Lt,Wt,Kt,Nt,Dt,Ot,Rt,jt,Gt,Ht,Vt,Zt,qt;const Qt=[.2,.5,1,2,4,6,8,12,20,24,30],Yt={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},Jt="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuv+zHAXXvbbtRqxADDeJ\nArX2b9RMxj3T+qpRg3FnIE/jeU3tj7eoDzsMduY+D/UT9CSnP+QHYY/vf0n5lqX9\ns6ljoZAmyUuruyj1e5Bg+fkDEu/yPEPQjqhbyywCyYL4TEAOJveopUBx9fdQxUJ6\nJ4J5oCE/Im1kFrlGW+puARiHmt3mmUyNzO8bI/Jx3cGSfoOHJG1foEaQsI5aaKqA\npBqxtzvwqMhudcZtAWSyRMBMlndvkRnVTDNTfTXLOYdHShCIgnKULCTH87uLBIP/\nnsmr4/bnQz8q2rp/HyVO+0yjR6mVr0NX5APJQ+6riJmGg3t3VOldhKP7aTHDUW+h\nkQIDAQAB\n-----END PUBLIC KEY-----",Xt=new Uint16Array(16);for(let i=0;i<16;i++)Xt[i]=(1<<i)-1;const ti=new Uint8Array(52488),ii=new Uint8Array(52488);var si=0;for(let i=0;i<3;i++)for(let r=0;r<3;r++)for(let n=0;n<3;n++)for(let h=0;h<3;h++)for(let o=0;o<3;o++)for(let a=0;a<3;a++)for(let l=0;l<3;l++)for(let c=0;c<3;c++)ti.set([r,i,h,n,a,o,c,l],si),ii.set([i,h,n,a,o,c,l,r],si),si+=8;const ei=new Uint8Array(256),ri=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach(((i,r)=>{const n=8*i,h=ti.subarray(n,n+8),o=ii.subarray(n,n+8);ei.set(h,8*r),ri.set(o,8*r)}));class KwzParser extends BaseParser{static matchBuffer(i){const r=new Uint8Array(i.slice(0,4)),n=r[0]<<24|r[1]<<16|r[2]<<8;return 1262897152===n||1263092480===n}constructor(r,n={}){super(r),Ft.add(this),this.format=i.FlipnoteFormat.KWZ,this[qt]="Flipnote Studio 3D KWZ animation file",this.imageWidth=KwzParser.width,this.imageHeight=KwzParser.height,this.aspect=KwzParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=KwzParser.numLayers,this.numLayerColors=KwzParser.numLayerColors,this.publicKey=KwzParser.publicKey,this.srcWidth=KwzParser.width,this.audioTracks=KwzParser.audioTracks,this.soundEffectTracks=KwzParser.soundEffectTracks,this.rawSampleRate=KwzParser.rawSampleRate,this.sampleRate=KwzParser.sampleRate,this.globalPalette=KwzParser.globalPalette,zt.set(this,void 0),$t.set(this,void 0),Ut.set(this,void 0),Et.set(this,void 0),It.set(this,void 0),Tt.set(this,null),Bt.set(this,void 0),Lt.set(this,void 0),Wt.set(this,void 0),Kt.set(this,0),Nt.set(this,0),u(this,zt,{...KwzParser.defaultSettings,...n},"f"),u(this,Et,[new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height)],"f"),f(this,Ft,"m",Dt).call(this),f(this,$t,"f").has("KIC")?(this.isFolderIcon=!0,this.imageWidth=24,this.imageHeight=24,this.frameCount=1,this.frameSpeed=0,this.framerate=Qt[0],this.thumbFrameIndex=0,f(this,Ft,"m",Vt).call(this)):f(this,$t,"f").has("KSN")?(f(this,Ft,"m",Gt).call(this),f(this,Ft,"m",Vt).call(this),f(this,Ft,"m",Zt).call(this)):(this.isComment=!0,f(this,Ft,"m",Gt).call(this),f(this,Ft,"m",Vt).call(this)),f(this,zt,"f").dsiLibraryNote&&(this.isDsiLibraryNote=!0),f(this,zt,"f").borderCrop&&(this.isDsiLibraryNote?(this.imageOffsetX=32,this.imageOffsetY=24,this.imageWidth=256,this.imageHeight=192):this.isFolderIcon||(this.imageOffsetX=5,this.imageOffsetY=5,this.imageWidth=310,this.imageHeight=230))}getThumbnailImage(){y(f(this,$t,"f").has("KTN"),"KTN section missing - Note that folder icons and comments do not contain thumbnail data");const r=f(this,$t,"f").get("KTN");this.seek(r.ptr+12);const n=this.readBytes(r.length-12);return{format:i.FlipnoteThumbImageFormat.Jpeg,width:80,height:64,data:n.buffer}}getFramePaletteIndices(i){w(i,0,this.frameCount-1,"Frame index"),this.seek(f(this,Bt,"f")[i]);const r=this.readUint32();return[15&r,r>>8&15,r>>12&15,r>>16&15,r>>20&15,r>>24&15,r>>28&15]}getFramePalette(i){return w(i,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(i).map((i=>this.globalPalette[i]))}getFrameDiffingFlag(i){return w(i,0,this.frameCount-1,"Frame index"),this.seek(f(this,Bt,"f")[i]),this.readUint32()>>4&7}getIsKeyFrame(i){const r=this.getFrameDiffingFlag(i);return[!(1&r),!(2&r),!(4&r)]}getFrameLayerDepths(i){return w(i,0,this.frameCount-1,"Frame index"),this.seek(f(this,Bt,"f")[i]+20),[this.readUint8(),this.readUint8(),this.readUint8()]}getFrameAuthor(i){return w(i,0,this.frameCount-1,"Frame index"),this.seek(f(this,Bt,"f")[i]+10),f(this,Ft,"m",Rt).call(this)}getFrameCameraFlags(i){this.seek(f(this,Bt,"f")[i]+26);const r=this.readUint8();return[!!(1&r),!!(2&r),!!(4&r)]}getFrameLayerOrder(i){w(i,0,this.frameCount-1,"Frame index");const r=this.getFrameLayerDepths(i);return[2,1,0].sort(((i,n)=>r[n]-r[i]))}decodeFrame(i,r=7,n=!1){if(w(i,0,this.frameCount-1,"Frame index"),f(this,Tt,"f")===i)return f(this,Et,"f");f(this,Tt,"f")!==i-1&&0!==i&&(n&&(r&=~this.getFrameDiffingFlag(i+1)),0!==r&&this.decodeFrame(i-1,r,!0));let h=f(this,Lt,"f")[i];const o=f(this,Wt,"f")[i];for(let i=0;i<3&&(!f(this,zt,"f").dsiLibraryNote||3!==i);i++){this.seek(h);let n=o[i];h+=n;const a=f(this,Et,"f")[i];if(38===n)continue;if(!(r>>i&1))continue;u(this,Kt,16,"f"),u(this,Nt,0,"f");let l=0;for(let i=0;i<240;i+=128)for(let r=0;r<320;r+=128)for(let n=0;n<128;n+=8){const h=i+n;if(h>=240)break;for(let i=0;i<128;i+=8){const n=r+i;if(n>=320)break;if(l>0){l-=1;continue}let o=h*KwzParser.width+n;const c=f(this,Ft,"m",Ot).call(this,3);if(0===c){const i=8*f(this,Ft,"m",Ot).call(this,5),r=ei.subarray(i,i+8);a.set(r,o),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320)}else if(1===c){const i=8*f(this,Ft,"m",Ot).call(this,13),r=ti.subarray(i,i+8);a.set(r,o),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(r,o+=320)}else if(2===c){const i=8*f(this,Ft,"m",Ot).call(this,5),r=ei.subarray(i,i+8),n=ri.subarray(i,i+8);a.set(r,o),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320)}else if(3===c){const i=8*f(this,Ft,"m",Ot).call(this,13),r=ti.subarray(i,i+8),n=ii.subarray(i,i+8);a.set(r,o),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320),a.set(r,o+=320),a.set(n,o+=320)}else if(4===c){const i=f(this,Ft,"m",Ot).call(this,8);for(let r=1;r<255;r<<=1){if(i&r){const i=8*f(this,Ft,"m",Ot).call(this,5),r=ei.subarray(i,i+8);a.set(r,o)}else{const i=8*f(this,Ft,"m",Ot).call(this,13),r=ti.subarray(i,i+8);a.set(r,o)}o+=320}}else{if(5===c){l=f(this,Ft,"m",Ot).call(this,5);continue}if(7===c){let i,r,n=f(this,Ft,"m",Ot).call(this,2);if(0!==f(this,Ft,"m",Ot).call(this,1)){const h=8*f(this,Ft,"m",Ot).call(this,5),o=8*f(this,Ft,"m",Ot).call(this,5);i=ei.subarray(h,h+8),r=ei.subarray(o,o+8),n+=1}else{const n=8*f(this,Ft,"m",Ot).call(this,13),h=8*f(this,Ft,"m",Ot).call(this,13);i=ti.subarray(n,n+8),r=ti.subarray(h,h+8)}switch(n%4){case 0:a.set(i,o),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320);break;case 1:a.set(i,o),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(i,o+=320);break;case 2:a.set(i,o),a.set(r,o+=320),a.set(i,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(i,o+=320),a.set(r,o+=320);break;case 3:a.set(i,o),a.set(r,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320),a.set(r,o+=320),a.set(i,o+=320),a.set(r,o+=320)}}}}}}return u(this,Tt,i,"f"),f(this,Et,"f")}decodeFrameSoundFlags(i){w(i,0,this.frameCount-1,"Frame index"),this.seek(f(this,Bt,"f")[i]+23);const r=this.readUint8();return[!!(1&r),!!(2&r),!!(4&r),!!(8&r)]}decodeSoundFlags(){return void 0!==f(this,It,"f")||u(this,It,new Array(this.frameCount).fill(!1).map(((i,r)=>this.decodeFrameSoundFlags(r))),"f"),f(this,It,"f")}getSoundEffectFlags(){return this.decodeSoundFlags().map((r=>({[i.FlipnoteSoundEffectTrack.SE1]:r[0],[i.FlipnoteSoundEffectTrack.SE2]:r[1],[i.FlipnoteSoundEffectTrack.SE3]:r[2],[i.FlipnoteSoundEffectTrack.SE4]:r[3]})))}getFrameSoundEffectFlags(r){const n=this.decodeFrameSoundFlags(r);return{[i.FlipnoteSoundEffectTrack.SE1]:n[0],[i.FlipnoteSoundEffectTrack.SE2]:n[1],[i.FlipnoteSoundEffectTrack.SE3]:n[2],[i.FlipnoteSoundEffectTrack.SE4]:n[3]}}getAudioTrackRaw(i){const r=this.soundMeta.get(i);return y(r.ptr+r.length<this.numBytes),new Uint8Array(this.buffer,r.ptr,r.length)}decodeAdpcm(i,r,n=0,h=0){const o=i.length;let a=0,l=0,c=0,f=0;for(let u=0;u<o;u++){let o=i[u],d=0;for(;d<8;)h<18||d>4?(l=3&o,c=W[h],f=c>>3,1&l&&(f+=c),2&l&&(f=-f),n+=f,h+=T[l],o>>=2,d+=2):(l=15&o,c=W[h],f=c>>3,1&l&&(f+=c>>2),2&l&&(f+=c>>1),4&l&&(f+=c),8&l&&(f=-f),n+=f,h+=B[l],o>>=4,d+=4),h=p(h,0,79),n=p(n,-2048,2047),r[a]=16*n,a+=1}return a}decodeAudioTrack(r){const n=f(this,zt,"f"),h=this.getAudioTrackRaw(r),o=60*this.rawSampleRate,a=new Int16Array(o);let l=0,c=40;if(this.isDsiLibraryNote)if(r===i.FlipnoteAudioTrack.BGM){let i=!0;if(null!==n.initialBgmPredictor&&(l=n.initialBgmPredictor,i=!1),null!==n.initialBgmStepIndex&&(c=n.initialBgmStepIndex,i=!1),i&&n.guessInitialBgmState){let i=4294967295,r=0;for(c=0;c<=40;c++){const n=this.decodeAdpcm(h,a,l,c),o=D(a.subarray(0,n));o<i&&(i=o,r=c)}c=r}}else{const i=this.soundEffectTracks.indexOf(r);Array.isArray(n.initialSePredictors)&&void 0!==n.initialSePredictors[i]&&(l=n.initialSePredictors[i]),Array.isArray(n.initialSeStepIndices)&&void 0!==n.initialSeStepIndices[i]&&(c=n.initialSeStepIndices[i])}const u=this.decodeAdpcm(h,a,l,c);return a.slice(0,u)}getAudioTrackPcm(r,n=this.sampleRate){const h=this.decodeAudioTrack(r);let o=this.rawSampleRate;if(r===i.FlipnoteAudioTrack.BGM){const i=1/this.bgmrate/(1/this.framerate);o=this.rawSampleRate*i}return o!==n?((i,r,n)=>{const h=i.length,o=h/r*n,a=new Int16Array(o),l=r/n;for(let r=0,n=0,c=0,f=0;r<o;r++)n=r*l,c=Math.floor(n),f=n%1,a[r]=m(K(i,h,c),K(i,h,c+1),f);return a})(h,o,n):h}pcmAudioMix(i,r,n=0){const h=i.length,o=r.length;for(let a=0;a<h&&!(n+a>o);a++){const h=r[n+a]+i[a];r[n+a]=p(h,-32768,32767)}}getAudioMasterPcm(r=this.sampleRate){const n=Math.ceil(this.duration*r),h=new Int16Array(n),o=this.hasAudioTrack(i.FlipnoteAudioTrack.BGM),a=this.hasAudioTrack(i.FlipnoteAudioTrack.SE1),l=this.hasAudioTrack(i.FlipnoteAudioTrack.SE2),c=this.hasAudioTrack(i.FlipnoteAudioTrack.SE3),f=this.hasAudioTrack(i.FlipnoteAudioTrack.SE4);if(o){const n=this.getAudioTrackPcm(i.FlipnoteAudioTrack.BGM,r);this.pcmAudioMix(n,h,0)}if(a||l||c||f){const n=r/this.framerate,o=a?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE1,r):null,u=l?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE2,r):null,d=c?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE3,r):null,p=f?this.getAudioTrackPcm(i.FlipnoteAudioTrack.SE4,r):null,m=this.decodeSoundFlags();for(let i=0;i<this.frameCount;i++){const r=m[i],y=Math.ceil(i*n);a&&r[0]&&this.pcmAudioMix(o,h,y),l&&r[1]&&this.pcmAudioMix(u,h,y),c&&r[2]&&this.pcmAudioMix(d,h,y),f&&r[3]&&this.pcmAudioMix(p,h,y)}}return this.audioClipRatio=N(h),h}getBody(){const i=f(this,Ut,"f");return this.bytes.subarray(0,i)}getSignature(){const i=f(this,Ut,"f");return this.bytes.subarray(i,i+256)}async verify(){const i=await Y(Jt,"SHA-256");return await J(i,this.getSignature(),this.getBody())}}zt=new WeakMap,$t=new WeakMap,Ut=new WeakMap,Et=new WeakMap,It=new WeakMap,Tt=new WeakMap,Bt=new WeakMap,Lt=new WeakMap,Wt=new WeakMap,Kt=new WeakMap,Nt=new WeakMap,Ft=new WeakSet,qt=Symbol.toStringTag,Dt=function(){const i=this.numBytes-256,r=new Map;let n=0,h=0;for(;h<i&&n<6;){this.seek(h);const i=this.readChars(4).substring(0,3),o=this.readUint32();r.set(i,{ptr:h,length:o}),h+=o+8,n+=1}u(this,Ut,h,"f"),u(this,$t,r,"f"),y(r.has("KMC")&&r.has("KMI"))},Ot=function(i){if(f(this,Kt,"f")+i>16){const i=this.readUint16();u(this,Nt,f(this,Nt,"f")|i<<16-f(this,Kt,"f"),"f"),u(this,Kt,f(this,Kt,"f")-16,"f")}const r=f(this,Nt,"f")&Xt[i];return u(this,Nt,f(this,Nt,"f")>>i,"f"),u(this,Kt,f(this,Kt,"f")+i,"f"),r},Rt=function(){return f(this,zt,"f").dsiLibraryNote?this.readHex(10,!0).slice(2,18):Mt(this.readHex(10))},jt=function(){const i=this.pointer,r=this.readChars(28);if(28===r.length)return r;this.seek(i);const n=this.readHex(3),h=this.readChars(13),o=this.readUint16().toString().padStart(3,"0");return this.seek(i+28),`${n}_${h}_${o}`},Gt=function(){if(f(this,zt,"f").quickMeta)return f(this,Ft,"m",Ht).call(this);y(f(this,$t,"f").has("KFH")),this.seek(f(this,$t,"f").get("KFH").ptr+12);const i=j(this.readUint32()),r=j(this.readUint32());this.readUint32();const n=f(this,Ft,"m",Rt).call(this),h=f(this,Ft,"m",Rt).call(this),o=f(this,Ft,"m",Rt).call(this),a=this.readWideChars(11),l=this.readWideChars(11),c=this.readWideChars(11),u=f(this,Ft,"m",jt).call(this),d=f(this,Ft,"m",jt).call(this),p=f(this,Ft,"m",jt).call(this),m=this.readUint16(),w=this.readUint16(),v=this.readUint16(),g=this.readUint8(),A=this.readUint8();this.isSpinoff=o!==h||o!==n,this.frameCount=m,this.frameSpeed=g,this.framerate=Qt[g],this.duration=Z(this.frameCount,this.framerate),this.thumbFrameIndex=w,this.layerVisibility={1:!(1&A),2:!(2&A),3:!(3&A)},this.meta={lock:!!(1&v),loop:!!(2&v),isSpinoff:this.isSpinoff,frameCount:m,frameSpeed:g,duration:this.duration,thumbIndex:w,timestamp:r,creationTimestamp:i,root:{username:a,fsid:n,region:xt(n),filename:u,isDsiFilename:28!==u.length},parent:{username:l,fsid:h,region:xt(h),filename:d,isDsiFilename:28!==d.length},current:{username:c,fsid:o,region:xt(o),filename:p,isDsiFilename:28!==p.length}}},Ht=function(){y(f(this,$t,"f").has("KFH")),this.seek(f(this,$t,"f").get("KFH").ptr+8+196);const i=this.readUint16(),r=this.readUint16();this.readUint16();const n=this.readUint8(),h=this.readUint8();this.frameCount=i,this.thumbFrameIndex=r,this.frameSpeed=n,this.framerate=Qt[n],this.duration=Z(this.frameCount,this.framerate),this.layerVisibility={1:!(1&h),2:!(2&h),3:!(3&h)}},Vt=function(){y(f(this,$t,"f").has("KMI")&&f(this,$t,"f").has("KMC"));const i=this.frameCount,r=f(this,$t,"f").get("KMI"),n=f(this,$t,"f").get("KMC");y(r.length/28>=i);const h=new Uint32Array(i),o=new Uint32Array(i),a=[];let l=r.ptr+8,c=n.ptr+12;for(let r=0;r<i;r++){this.seek(l+4);const i=this.readUint16(),n=this.readUint16(),f=this.readUint16();h[r]=l,o[r]=c,l+=28,c+=i+n+f,y(l<this.numBytes,`frame${r} meta pointer out of bounds`),y(c<this.numBytes,`frame${r} data pointer out of bounds`),a.push([i,n,f])}u(this,Bt,h,"f"),u(this,Lt,o,"f"),u(this,Wt,a,"f")},Zt=function(){y(f(this,$t,"f").has("KSN"));let r=f(this,$t,"f").get("KSN").ptr+8;this.seek(r),this.bgmSpeed=this.readUint32(),y(this.bgmSpeed<=10),this.bgmrate=Qt[this.bgmSpeed];const n=new Uint32Array(this.buffer,r+4,20),h=new Map;h.set(i.FlipnoteAudioTrack.BGM,{ptr:r+=28,length:n[0]}),h.set(i.FlipnoteAudioTrack.SE1,{ptr:r+=n[0],length:n[1]}),h.set(i.FlipnoteAudioTrack.SE2,{ptr:r+=n[1],length:n[2]}),h.set(i.FlipnoteAudioTrack.SE3,{ptr:r+=n[2],length:n[3]}),h.set(i.FlipnoteAudioTrack.SE4,{ptr:r+=n[3],length:n[4]}),this.soundMeta=h},KwzParser.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,guessInitialBgmState:!0,initialBgmPredictor:null,initialBgmStepIndex:null,initialSePredictors:null,initialSeStepIndices:null},KwzParser.format=i.FlipnoteFormat.KWZ,KwzParser.width=320,KwzParser.height=240,KwzParser.aspect=3/4,KwzParser.numLayers=3,KwzParser.numLayerColors=2,KwzParser.rawSampleRate=16364,KwzParser.sampleRate=32768,KwzParser.audioTracks=[i.FlipnoteAudioTrack.BGM,i.FlipnoteAudioTrack.SE1,i.FlipnoteAudioTrack.SE2,i.FlipnoteAudioTrack.SE3,i.FlipnoteAudioTrack.SE4],KwzParser.soundEffectTracks=[i.FlipnoteSoundEffectTrack.SE1,i.FlipnoteSoundEffectTrack.SE2,i.FlipnoteSoundEffectTrack.SE3,i.FlipnoteSoundEffectTrack.SE4],KwzParser.globalPalette=[Yt.WHITE,Yt.BLACK,Yt.RED,Yt.YELLOW,Yt.GREEN,Yt.BLUE,Yt.NONE],KwzParser.publicKey=Jt;const ni=i=>U(i)?`${i.slice(14,16)}-${i.slice(12,14)}${i.slice(10,12)}-${i.slice(8,10)}${i.slice(6,8)}-${i.slice(4,6)}${i.slice(2,4)}${i.slice(0,2)}`.toLocaleLowerCase():null;var hi=Object.freeze({__proto__:null,getFsidRegion:r=>U(r)?E(r):St(r)?xt(r):i.FlipnoteRegion.UNKNOWN,getKwzFsidRegion:xt,getPpmFsidRegion:E,isFsid:i=>U(i)||St(i),isKwzDsiLibraryFsid:_t,isKwzFsid:St,isPpmFsid:U,kwzFsidFormat:Mt,kwzFsidToPpmFsid:i=>_t(i)?`${i.slice(19,21)}${i.slice(17,19)}${i.slice(15,17)}${i.slice(12,14)}${i.slice(10,12)}${i.slice(7,9)}${i.slice(5,7)}${i.slice(2,4)}`.toUpperCase():null,kwzFsidUnformat:kt,ppmFsidToKwzFsidSuffix:ni,ppmFsidToPossibleKwzFsids(i){const r=ni(i);return r?["00"+r,"10"+r,"12"+r,"14"+r]:null}});const oi=/^[0-9A-Z]{1}[0-9A-F]{5}_[0-9A-F]{13}_[0-9]{3}$/,ai=/^[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}$/,li=/^[0-5a-z]{28}$/,ci="cwmfjordvegbalksnthpyxquiz012345";var fi=Object.freeze({__proto__:null,isKwzFilename:i=>li.test(i),isPpmBasicFilename:i=>ai.test(i),isPpmFilename:i=>oi.test(i),kwzFilenameDecode(i){const r=(i=>{const r=i.length;let n=0;const h=new Uint8Array(5*r/8);let o=0,a=0;for(let l=0;l<r;l++)a=a<<5|ci.indexOf(i[l]),n+=5,n>=8&&(h[o++]=a>>>n-8&255,n-=8);return h})(i),n=new DataView(r.buffer);return{fsid:Mt(d(r.slice(0,9))),created:j(n.getUint32(9,!0)),edited:j(n.getUint32(13,!0))}},kwzFilenameEncode(i){const r=new Uint8Array(17),n=new DataView(r.buffer),h=kt(i.fsid);return r.set(((i,r=!1)=>{const n=i.length,h=new Uint8Array(n/2);for(let r=0,o=0;r<n;r+=2)h[o++]=parseInt(i.slice(r,r+2),16);return r&&h.reverse(),h})(h)),n.setUint32(9,G(i.created),!0),n.setUint32(13,G(i.edited),!0),(i=>{const r=i.byteLength;let n=0,h="",o=0;for(let a=0;a<r;a++)for(o=o<<8|i[a],n+=8;n>=5;)h+=ci[o>>>n-5&31],n-=5;return n>0&&(h+=ci[o<<5-n&31]),h})(r)}});const ui=[247,76,106,58,251,130,166,55,110,17,56,207,160,221,133,192,199,155,196,216,221,40,138,135,83,32,238,224,11,235,67,160,219,85,15,117,54,55,235,53,106,52,127,181,15,153,247,239,67,37,206,160,41,70,217,212,77,187,4,102,104,8,241,248];class BasePlaylistParser extends DataStream{constructor(i){super(i),this.entries=[]}addEntry(i){const r=i.split("/"),n=r.at(-1),h=i.lastIndexOf(".");this.entries.push({full:i,name:n,base:i.slice(0,h),ext:i.slice(h+1),folder:r.at(-2),parentFolder:r.at(-3)})}}class PpmPlaylist extends BasePlaylistParser{constructor(r){super(r),this.format=i.FlipnoteFormat.PPM;const n=this.bytes,h=this.numBytes;for(let i=0;i<h;i++)n[i]=n[i]^ui[i%64];let o="";for(;!this.end();){const i=this.readChar();"\n"!==i?o+=i:(this.addEntry(o),o="")}}}class KwzPlaylist extends BasePlaylistParser{constructor(r){super(r),this.format=i.FlipnoteFormat.KWZ;const n=this.bytes,h=this.numBytes;for(let i=0;i<h;i++)n[i]=n[i]^ui[i%61];let o="";this.seek(4);const a=this.readWideChar();for(;!this.end();){const i=this.readWideChar();i!==a?o+=i:(this.addEntry(o),o="")}}}const di={name:"url",matches(i){return"string"==typeof i},async load(i){const r=await fetch(i);return y(r.status>=200&&r.status<300,`Failed to load Flipnote from URL, response failed with status ${r.status}`),await r.arrayBuffer()}},pi={name:"file",matches(i){return A&&"undefined"!=typeof File&&"undefined"!=typeof FileReader&&i instanceof File},async load(i){return i.arrayBuffer()}},mi={name:"blob",matches(i){return A&&"undefined"!=typeof Blob&&"undefined"!=typeof Response&&i instanceof Blob},async load(i){return i.arrayBuffer()}},yi={name:"node-buffer",matches(i){return C&&i instanceof Buffer},async load(i){return i.buffer}},wi={name:"array-buffer",matches(i){return i instanceof ArrayBuffer},async load(i){return i}},vi=new Map,gi=i=>{for(let[r,n]of vi)if(n.matches(i))try{return n.load(i)}catch(i){v(`Failed to load Flipnote from source, loader "${r}" failed with error ${v}`)}v("No loader available for source type")},bi=i=>{vi.set(i.name,i)};bi(wi),bi(yi),bi(mi),bi(pi),bi(di);var Ai=Object.freeze({__proto__:null,clear:()=>vi.clear(),list:()=>Object.fromEntries(vi.entries()),load:gi,register:bi}),Pi=Object.freeze({__proto__:null,KwzPlaylist,PpmPlaylist,async parse(r,n){const h=await gi(n);return r===i.FlipnoteFormat.PPM||"ppm"===r?new PpmPlaylist(h):r===i.FlipnoteFormat.KWZ||"kwz"===r?new KwzPlaylist(h):void 0}});const Ci=async(i,r)=>{const n=await gi(i);return PpmParser.matchBuffer(n)?new PpmParser(n,r):KwzParser.matchBuffer(n)?new KwzParser(n,r):void v("Could not identify source as a valid Flipnote file")},Si=Ci;var _i;i.PlayerEvent=void 0,(_i=i.PlayerEvent||(i.PlayerEvent={})).i="any",_i.Play="play",_i.Pause="pause",_i.CanPlay="canplay",_i.CanPlayThrough="canplaythrough",_i.SeekStart="seeking",_i.SeekEnd="seeked",_i.Duration="durationchange",_i.Loop="loop",_i.Ended="ended",_i.VolumeChange="volumechange",_i.Progress="progress",_i.TimeUpdate="timeupdate",_i.FrameUpdate="frameupdate",_i.FrameNext="framenext",_i.FramePrev="frameprev",_i.FrameFirst="framefirst",_i.FrameLast="framelast",_i.Ready="ready",_i.Load="load",_i.LoadStart="loadstart",_i.LoadedData="loadeddata",_i.LoadedMeta="loadedmetadata",_i.Emptied="emptied",_i.Close="close",_i.Error="error",_i.Destroy="destroy";const xi=[i.PlayerEvent.Play,i.PlayerEvent.Pause,i.PlayerEvent.CanPlay,i.PlayerEvent.CanPlayThrough,i.PlayerEvent.SeekStart,i.PlayerEvent.SeekEnd,i.PlayerEvent.Duration,i.PlayerEvent.Loop,i.PlayerEvent.Ended,i.PlayerEvent.VolumeChange,i.PlayerEvent.Progress,i.PlayerEvent.TimeUpdate,i.PlayerEvent.FrameUpdate,i.PlayerEvent.FrameNext,i.PlayerEvent.FramePrev,i.PlayerEvent.FrameFirst,i.PlayerEvent.FrameLast,i.PlayerEvent.Ready,i.PlayerEvent.Load,i.PlayerEvent.LoadStart,i.PlayerEvent.LoadedData,i.PlayerEvent.LoadedMeta,i.PlayerEvent.Emptied,i.PlayerEvent.Close,i.PlayerEvent.Error],Mi=i=>({length:i.length,start:r=>i[r][0],end:r=>i[r][1]}),ki=(i,r)=>i.toString().padStart(r,"0"),Fi=i=>{const r=Math.floor(i%3600/60),n=Math.floor(i%60);return`${r}:${ki(n,2)}`};var zi;i.CanvasStereoscopicMode=void 0,(zi=i.CanvasStereoscopicMode||(i.CanvasStereoscopicMode={}))[zi.None=0]="None",zi[zi.Dual=1]="Dual",zi[zi.Anaglyph=2]="Anaglyph";const $i=5120,Ui=5121,Ei=5122,Ii=5123,Ti=5124,Bi=5125,Li=5126,Wi={};{const i=Wi;i[$i]=Int8Array,i[Ui]=Uint8Array,i[Ei]=Int16Array,i[Ii]=Uint16Array,i[Ti]=Int32Array,i[Bi]=Uint32Array,i[Li]=Float32Array,i[32819]=Uint16Array,i[32820]=Uint16Array,i[33635]=Uint16Array,i[5131]=Uint16Array,i[33640]=Uint32Array,i[35899]=Uint32Array,i[35902]=Uint32Array,i[36269]=Uint32Array,i[34042]=Uint32Array}function Ki(i){if(i instanceof Int8Array)return $i;if(i instanceof Uint8Array)return Ui;if(i instanceof Uint8ClampedArray)return Ui;if(i instanceof Int16Array)return Ei;if(i instanceof Uint16Array)return Ii;if(i instanceof Int32Array)return Ti;if(i instanceof Uint32Array)return Bi;if(i instanceof Float32Array)return Li;throw new Error("unsupported typed array type")}function Ni(i){if(i===Int8Array)return $i;if(i===Uint8Array)return Ui;if(i===Uint8ClampedArray)return Ui;if(i===Int16Array)return Ei;if(i===Uint16Array)return Ii;if(i===Int32Array)return Ti;if(i===Uint32Array)return Bi;if(i===Float32Array)return Li;throw new Error("unsupported typed array type")}const Di="undefined"!=typeof SharedArrayBuffer?function(i){return i&&i.buffer&&(i.buffer instanceof ArrayBuffer||i.buffer instanceof SharedArrayBuffer)}:function(i){return i&&i.buffer&&i.buffer instanceof ArrayBuffer},Oi=new Map;function Ri(i,r){if(!i||"object"!=typeof i)return!1;let n=Oi.get(r);n||(n=new WeakMap,Oi.set(r,n));let h=n.get(i);if(void 0===h){const o=Object.prototype.toString.call(i);h=o.substring(8,o.length-1)===r,n.set(i,h)}return h}function ji(i,r){return"undefined"!=typeof WebGLTexture&&Ri(r,"WebGLTexture")}const Gi=35044,Hi=34962,Vi=5126,Zi="";function qi(i,r,n,h){if(function(i,r){return"undefined"!=typeof WebGLBuffer&&Ri(r,"WebGLBuffer")}(0,r))return r;n=n||Hi;const o=i.createBuffer();return function(i,r,n,h,o){i.bindBuffer(r,n),i.bufferData(r,h,o||Gi)}(i,n,o,r,h),o}function Qi(i){return"indices"===i}const Yi=/coord|texture/i,Ji=/color|colour/i;function Xi(i,r){if(Di(i))return i;if(Di(i.data))return i.data;Array.isArray(i)&&(i={data:i});let n=i.type?ts(i.type):void 0;return n||(n=Qi(r)?Uint16Array:Float32Array),new n(i.data)}function ts(i){return"number"==typeof i?function(i){const r=Wi[i];if(!r)throw new Error("unknown gl type");return r}(i):i||Float32Array}function is(i,r){return{buffer:r.buffer,numValues:24,type:(n=r.type,"number"==typeof n?n:n?Ni(n):Vi),arrayType:ts(r.type)};var n}function ss(i,r){const n=r.data||r,h=ts(r.type),o=n*h.BYTES_PER_ELEMENT,a=i.createBuffer();return i.bindBuffer(Hi,a),i.bufferData(Hi,o,r.drawType||Gi),{buffer:a,numValues:n,type:Ni(h),arrayType:h}}function es(i,r,n){const h=Xi(r,n);return{arrayType:h.constructor,buffer:qi(i,h,void 0,r.drawType),type:Ki(h),numValues:0}}function rs(i,r){const n={};return Object.keys(r).forEach((function(h){if(!Qi(h)){const a=r[h],l=a.attrib||a.name||a.attribName||Zi+h;if(a.value){if(!Array.isArray(a.value)&&!Di(a.value))throw new Error("array.value is not array or typedarray");n[l]={value:a.value}}else{let r;r=a.buffer&&a.buffer instanceof WebGLBuffer?is:"number"==typeof a||"number"==typeof a.data?ss:es;const{buffer:c,type:f,numValues:u,arrayType:d}=r(i,a,h),p=void 0!==a.normalize?a.normalize:(o=d)===Int8Array||o===Uint8Array,m=function(i,r,n){return i.numComponents||i.size||function(i,r){let n;if(n=Yi.test(i)?2:Ji.test(i)?4:3,r%n>0)throw new Error(`Can not guess numComponents for attribute '${i}'. Tried ${n} but ${r} values is not evenly divisible by ${n}. You should specify it.`);return n}(r,n||function(i){return i.length?i:i.data}(i).length)}(a,h,u);n[l]={buffer:c,numComponents:m,type:f,normalize:p,stride:a.stride||0,offset:a.offset||0,divisor:void 0===a.divisor?void 0:a.divisor,drawType:a.drawType}}}var o})),i.bindBuffer(Hi,null),n}const ns=["position","positions","a_position"];function hs(i){return!!i.texStorage2D}const os=33984,as=34962,ls=5124,cs=3553,fs=34067,us=32879,ds=35866,ps={};function ms(i,r){return ps[r].bindPoint}function ys(i,r){return function(n){i.uniform1i(r,n)}}function ws(i,r){return function(n){i.uniform1iv(r,n)}}function vs(i,r){return function(n){i.uniform2iv(r,n)}}function gs(i,r){return function(n){i.uniform3iv(r,n)}}function bs(i,r){return function(n){i.uniform4iv(r,n)}}function As(i,r,n,h){const o=ms(0,r);return hs(i)?function(r){let a,l;!r||ji(0,r)?(a=r,l=null):(a=r.texture,l=r.sampler),i.uniform1i(h,n),i.activeTexture(os+n),i.bindTexture(o,a),i.bindSampler(n,l)}:function(r){i.uniform1i(h,n),i.activeTexture(os+n),i.bindTexture(o,r)}}function Ps(i,r,n,h,o){const a=ms(0,r),l=new Int32Array(o);for(let i=0;i<o;++i)l[i]=n+i;return hs(i)?function(r){i.uniform1iv(h,l),r.forEach((function(r,h){let o,c;i.activeTexture(os+l[h]),!r||ji(0,r)?(o=r,c=null):(o=r.texture,c=r.sampler),i.bindSampler(n,c),i.bindTexture(a,o)}))}:function(r){i.uniform1iv(h,l),r.forEach((function(r,n){i.activeTexture(os+l[n]),i.bindTexture(a,r)}))}}function Cs(i,r){return function(n){if(n.value)switch(i.disableVertexAttribArray(r),n.value.length){case 4:i.vertexAttrib4fv(r,n.value);break;case 3:i.vertexAttrib3fv(r,n.value);break;case 2:i.vertexAttrib2fv(r,n.value);break;case 1:i.vertexAttrib1fv(r,n.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else i.bindBuffer(as,n.buffer),i.enableVertexAttribArray(r),i.vertexAttribPointer(r,n.numComponents||n.size,n.type||5126,n.normalize||!1,n.stride||0,n.offset||0),i.vertexAttribDivisor&&i.vertexAttribDivisor(r,n.divisor||0)}}function Ss(i,r){return function(n){if(n.value){if(i.disableVertexAttribArray(r),4!==n.value.length)throw new Error("The length of an integer constant value must be 4!");i.vertexAttrib4iv(r,n.value)}else i.bindBuffer(as,n.buffer),i.enableVertexAttribArray(r),i.vertexAttribIPointer(r,n.numComponents||n.size,n.type||ls,n.stride||0,n.offset||0),i.vertexAttribDivisor&&i.vertexAttribDivisor(r,n.divisor||0)}}function _s(i,r){return function(n){if(n.value){if(i.disableVertexAttribArray(r),4!==n.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");i.vertexAttrib4uiv(r,n.value)}else i.bindBuffer(as,n.buffer),i.enableVertexAttribArray(r),i.vertexAttribIPointer(r,n.numComponents||n.size,n.type||5125,n.stride||0,n.offset||0),i.vertexAttribDivisor&&i.vertexAttribDivisor(r,n.divisor||0)}}function xs(i,r,n){const h=n.size,o=n.count;return function(n){i.bindBuffer(as,n.buffer);const a=n.size||n.numComponents||h,l=a/o,c=n.type||5126,f=ps[c].size*a,u=n.normalize||!1,d=n.offset||0,p=f/o;for(let h=0;h<o;++h)i.enableVertexAttribArray(r+h),i.vertexAttribPointer(r+h,l,c,u,f,d+p*h),i.vertexAttribDivisor&&i.vertexAttribDivisor(r+h,n.divisor||0)}}ps[5126]={Type:Float32Array,size:4,setter:(i,r)=>function(n){i.uniform1f(r,n)},arraySetter:(i,r)=>function(n){i.uniform1fv(r,n)}},ps[35664]={Type:Float32Array,size:8,setter:(i,r)=>function(n){i.uniform2fv(r,n)},cols:2},ps[35665]={Type:Float32Array,size:12,setter:(i,r)=>function(n){i.uniform3fv(r,n)},cols:3},ps[35666]={Type:Float32Array,size:16,setter:(i,r)=>function(n){i.uniform4fv(r,n)},cols:4},ps[ls]={Type:Int32Array,size:4,setter:ys,arraySetter:ws},ps[35667]={Type:Int32Array,size:8,setter:vs,cols:2},ps[35668]={Type:Int32Array,size:12,setter:gs,cols:3},ps[35669]={Type:Int32Array,size:16,setter:bs,cols:4},ps[5125]={Type:Uint32Array,size:4,setter:(i,r)=>function(n){i.uniform1ui(r,n)},arraySetter:(i,r)=>function(n){i.uniform1uiv(r,n)}},ps[36294]={Type:Uint32Array,size:8,setter:(i,r)=>function(n){i.uniform2uiv(r,n)},cols:2},ps[36295]={Type:Uint32Array,size:12,setter:(i,r)=>function(n){i.uniform3uiv(r,n)},cols:3},ps[36296]={Type:Uint32Array,size:16,setter:(i,r)=>function(n){i.uniform4uiv(r,n)},cols:4},ps[35670]={Type:Uint32Array,size:4,setter:ys,arraySetter:ws},ps[35671]={Type:Uint32Array,size:8,setter:vs,cols:2},ps[35672]={Type:Uint32Array,size:12,setter:gs,cols:3},ps[35673]={Type:Uint32Array,size:16,setter:bs,cols:4},ps[35674]={Type:Float32Array,size:32,setter:(i,r)=>function(n){i.uniformMatrix2fv(r,!1,n)},rows:2,cols:2},ps[35675]={Type:Float32Array,size:48,setter:(i,r)=>function(n){i.uniformMatrix3fv(r,!1,n)},rows:3,cols:3},ps[35676]={Type:Float32Array,size:64,setter:(i,r)=>function(n){i.uniformMatrix4fv(r,!1,n)},rows:4,cols:4},ps[35685]={Type:Float32Array,size:32,setter:(i,r)=>function(n){i.uniformMatrix2x3fv(r,!1,n)},rows:2,cols:3},ps[35686]={Type:Float32Array,size:32,setter:(i,r)=>function(n){i.uniformMatrix2x4fv(r,!1,n)},rows:2,cols:4},ps[35687]={Type:Float32Array,size:48,setter:(i,r)=>function(n){i.uniformMatrix3x2fv(r,!1,n)},rows:3,cols:2},ps[35688]={Type:Float32Array,size:48,setter:(i,r)=>function(n){i.uniformMatrix3x4fv(r,!1,n)},rows:3,cols:4},ps[35689]={Type:Float32Array,size:64,setter:(i,r)=>function(n){i.uniformMatrix4x2fv(r,!1,n)},rows:4,cols:2},ps[35690]={Type:Float32Array,size:64,setter:(i,r)=>function(n){i.uniformMatrix4x3fv(r,!1,n)},rows:4,cols:3},ps[35678]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:cs},ps[35680]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:fs},ps[35679]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:us},ps[35682]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:cs},ps[36289]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:ds},ps[36292]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:ds},ps[36293]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:fs},ps[36298]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:cs},ps[36299]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:us},ps[36300]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:fs},ps[36303]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:ds},ps[36306]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:cs},ps[36307]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:us},ps[36308]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:fs},ps[36311]={Type:null,size:0,setter:As,arraySetter:Ps,bindPoint:ds};const Ms={};function ks(i){const r=i.name;return r.startsWith("gl_")||r.startsWith("webgl_")}Ms[5126]={size:4,setter:Cs},Ms[35664]={size:8,setter:Cs},Ms[35665]={size:12,setter:Cs},Ms[35666]={size:16,setter:Cs},Ms[ls]={size:4,setter:Ss},Ms[35667]={size:8,setter:Ss},Ms[35668]={size:12,setter:Ss},Ms[35669]={size:16,setter:Ss},Ms[5125]={size:4,setter:_s},Ms[36294]={size:8,setter:_s},Ms[36295]={size:12,setter:_s},Ms[36296]={size:16,setter:_s},Ms[35670]={size:4,setter:Ss},Ms[35671]={size:8,setter:Ss},Ms[35672]={size:12,setter:Ss},Ms[35673]={size:16,setter:Ss},Ms[35674]={size:4,setter:xs,count:2},Ms[35675]={size:9,setter:xs,count:3},Ms[35676]={size:16,setter:xs,count:4};const Fs=/(\.|\[|]|\w+)/g,zs=i=>i>="0"&&i<="9";function $s(i,r,n,h){const o=i.split(Fs).filter((i=>""!==i));let a=0,l="";for(;;){const i=o[a++];l+=i;const c=zs(i[0]),f=c?parseInt(i):i;if(c&&(l+=o[a++]),a===o.length){n[f]=r;break}{const i=o[a++],r="["===i,c=n[f]||(r?[]:{});n[f]=c,n=c,h[l]=h[l]||function(i){return function(r){Us(i,r)}}(c),l+=i}}}function Us(i,r){for(const n in r){const h=i[n];"function"==typeof h?h(r[n]):Us(i[n],r[n])}}function Es(i,...r){const n=i.uniformSetters||i,h=r.length;for(let i=0;i<h;++i){const h=r[i];if(Array.isArray(h)){const i=h.length;for(let r=0;r<i;++r)Es(n,h[r])}else for(const i in h){const r=n[i];r&&r(h[i])}}}var Is,Ts,Bs,Ls,Ws,Ks,Ns,Ds,Os,Rs,js,Gs,Hs,Vs,Zs,qs,Qs,Ys,Js,Xs,te,ie,se,ee,re,ne,he,oe,ae,le,ce,fe,ue,de,pe,me,ye,we,ve,ge,be,Ae,Pe,Ce,Se,_e,xe,Me,ke,Fe,ze,$e,Ue,Ee,Ie,Te;class WebglCanvas{static isSupported(){if(!A)return!1;let i=document.createElement("canvas"),r=i.getContext("2d");const n=null!==r;return i=null,r=null,n}constructor(r,n=640,h=480,o={}){Is.add(this),this.supportedStereoscopeModes=[i.CanvasStereoscopicMode.None,i.CanvasStereoscopicMode.Dual],this.stereoscopeMode=i.CanvasStereoscopicMode.None,this.stereoscopeStrength=0,Ts.set(this,void 0),Bs.set(this,void 0),Ls.set(this,void 0),Ws.set(this,void 0),Ks.set(this,new Uint32Array(16)),Ns.set(this,void 0),Ds.set(this,void 0),Os.set(this,void 0),Rs.set(this,void 0),js.set(this,void 0),Gs.set(this,new Map),Hs.set(this,new Map),Vs.set(this,new Map),Zs.set(this,!1),qs.set(this,{programs:[],shaders:[],textures:[],buffers:[],frameBuffers:[]}),Qs.set(this,!1),ce.set(this,(i=>{this.destroy(),i&&i.preventDefault(),f(this,Qs,"f")||f(this,Ts,"f").onlost(),u(this,Qs,!0,"f")})),fe.set(this,(i=>{u(this,Qs,!1,"f"),f(this,Is,"m",Ys).call(this),f(this,Ts,"f").onrestored()})),P(),u(this,Ts,{...WebglCanvas.defaultOptions,...o},"f"),this.width=n,this.height=h,this.canvas=document.createElement("canvas"),this.canvas.addEventListener("webglcontextlost",f(this,ce,"f"),!1),this.canvas.addEventListener("webglcontextrestored",f(this,fe,"f"),!1),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--webgl",this.gl=this.canvas.getContext("webgl",{antialias:!1,alpha:!0}),r&&r.appendChild(this.canvas),f(this,Is,"m",Ys).call(this)}setCanvasSize(i,r){const n=f(this,Ts,"f").useDpi&&window.devicePixelRatio||1,h=i*n,o=r*n;this.width=i,this.height=r,this.canvas.width=h,this.canvas.height=o,this.dstWidth=h,this.dstHeight=o,this.canvas.style.width=`${i}px`,this.canvas.style.height=`${r}px`,f(this,Is,"m",le).call(this)}setNote(i){if(f(this,Is,"m",le).call(this))return;const r=i.imageWidth,n=i.imageHeight;this.note=i,this.srcWidth=r,this.srcHeight=n,f(this,Is,"m",ae).call(this,f(this,js,"f"),r,n),f(this,Is,"m",ne).call(this,f(this,Ns,"f"),r,n),u(this,Ds,new Uint32Array(r*n),"f"),u(this,Os,new Uint8Array(f(this,Ds,"f").buffer),"f"),this.frameIndex=void 0,this.canvas.title=i.getTitle()}clear(i){if(f(this,Is,"m",le).call(this))return;const r=this.gl,n=i??this.note.getFramePalette(this.frameIndex)[0],[h,o,a,l]=n;r.clearColor(h/255,o/255,a/255,l/255),r.clear(r.COLOR_BUFFER_BIT)}drawFrame(r){if(f(this,Is,"m",le).call(this))return;const n=this.gl,h=this.stereoscopeMode,o=this.stereoscopeStrength;this.frameIndex=r,h===i.CanvasStereoscopicMode.None?(f(this,Is,"m",Js).call(this,r),f(this,Is,"m",oe).call(this,null),f(this,Is,"m",Xs).call(this,n.drawingBufferWidth,n.drawingBufferHeight)):h===i.CanvasStereoscopicMode.Dual&&(f(this,Is,"m",Js).call(this,r,o,i.FlipnoteStereoscopicEye.Left),f(this,Is,"m",oe).call(this,null,0,0,n.drawingBufferWidth/2,n.drawingBufferHeight),f(this,Is,"m",Xs).call(this,n.drawingBufferWidth/2,n.drawingBufferHeight),f(this,Is,"m",Js).call(this,r,o,i.FlipnoteStereoscopicEye.Right),f(this,Is,"m",oe).call(this,null,n.drawingBufferWidth/2,0,n.drawingBufferWidth/2,n.drawingBufferHeight),f(this,Is,"m",Xs).call(this,n.drawingBufferWidth/2,n.drawingBufferHeight))}requestStereoScopeMode(r){this.supportedStereoscopeModes.includes(r)?this.stereoscopeMode=r:this.stereoscopeMode=i.CanvasStereoscopicMode.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}isErrorState(){const i=this.gl;return null===i||i.getError()!==i.NO_ERROR}getDataUrl(i,r){return this.canvas.toDataURL(i,r)}async getBlob(i,r){return new Promise(((n,h)=>this.canvas.toBlob(n,i,r)))}destroy(){const i=f(this,qs,"f"),r=this.gl,n=this.canvas;i.shaders.forEach((i=>{r.deleteShader(i)})),i.shaders=[],i.textures.forEach((i=>{r.deleteTexture(i)})),i.textures=[],i.buffers.forEach((i=>{r.deleteBuffer(i)})),i.buffers=[],i.frameBuffers.forEach((i=>{r.deleteFramebuffer(i)})),i.frameBuffers=[],i.programs.forEach((i=>{r.deleteProgram(i)})),i.programs=[],u(this,Ks,null,"f"),u(this,Ds,null,"f"),u(this,Os,null,"f"),f(this,Gs,"f").clear(),f(this,Hs,"f").clear(),f(this,Vs,"f").clear(),n&&n.parentElement&&(n.width=1,n.height=1,n.parentNode.removeChild(n))}}Ts=new WeakMap,Bs=new WeakMap,Ls=new WeakMap,Ws=new WeakMap,Ks=new WeakMap,Ns=new WeakMap,Ds=new WeakMap,Os=new WeakMap,Rs=new WeakMap,js=new WeakMap,Gs=new WeakMap,Hs=new WeakMap,Vs=new WeakMap,Zs=new WeakMap,qs=new WeakMap,Qs=new WeakMap,ce=new WeakMap,fe=new WeakMap,Is=new WeakSet,Ys=function(){this.setCanvasSize(this.width,this.height);const i=this.gl;if(f(this,Is,"m",le).call(this))return;u(this,Bs,f(this,Is,"m",te).call(this,"#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_uv;uniform bool u_flipY;uniform vec2 u_textureSize;uniform int u_3d_eye;uniform float u_3d_depth;uniform float u_3d_strength;void main(){vec4 pos=position;float depthDirection=u_3d_eye==0 ?-1.0 : 1.0;float depthShift=floor(u_3d_depth*u_3d_strength)/(u_textureSize.x/2.0)*depthDirection;pos.x+=depthShift;pos.y*=u_flipY ?-1.0 : 1.0;v_uv=texcoord;gl_Position=pos;}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;uniform int u_3d_mode;void main(){vec4 col=texture2D(u_tex,v_uv);if(col.a==0.0){discard;}gl_FragColor=col;}"),"f"),u(this,Ls,f(this,Is,"m",te).call(this,"#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),"f"),u(this,Ws,f(this,Is,"m",se).call(this,-1,-1,2,2,1,1),"f"),f(this,Is,"m",ee).call(this,f(this,Bs,"f"),f(this,Ws,"f")),u(this,Ns,f(this,Is,"m",re).call(this,i.RGBA,i.LINEAR,i.CLAMP_TO_EDGE),"f"),u(this,Rs,f(this,Is,"m",re).call(this,i.RGBA,i.LINEAR,i.CLAMP_TO_EDGE),"f"),u(this,js,f(this,Is,"m",he).call(this,f(this,Rs,"f")),"f");const r=i.getExtension("WEBGL_debug_renderer_info"),n=i.getParameter(r.UNMASKED_RENDERER_WEBGL),h=navigator.userAgent,o=h.includes("Firefox")&&h.includes("Mac");u(this,Zs,o&&n.includes("Apple M"),"f")},Js=function(r,n=0,h=i.FlipnoteStereoscopicEye.Left,o=!0){const a=this.gl,l=this.note,c=this.srcWidth,u=this.srcHeight,d=l.numLayers,p=l.getFrameLayerOrder(r),m=l.getFrameLayerDepths(r);f(this,Is,"m",oe).call(this,f(this,js,"f")),o&&this.clear(),a.useProgram(f(this,Bs,"f").program);for(let i=0;i<d;i++){const o=p[i];l.getLayerPixelsRgba(r,o,f(this,Ds,"f"),f(this,Ks,"f")),Es(f(this,Bs,"f"),{u_flipY:!0,u_tex:f(this,Ns,"f"),u_textureSize:[c,u],u_3d_mode:this.stereoscopeMode,u_3d_eye:h,u_3d_depth:m[o],u_3d_strength:n}),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,c,u,0,a.RGBA,a.UNSIGNED_BYTE,f(this,Os,"f")),a.drawElements(a.TRIANGLES,f(this,Ws,"f").numElements,f(this,Ws,"f").elementType,0)}},Xs=function(i,r){if(f(this,Is,"m",le).call(this))return;const n=this.gl;n.useProgram(f(this,Ls,"f").program),Es(f(this,Ls,"f"),{u_tex:f(this,Rs,"f"),u_textureSize:[this.srcWidth,this.srcHeight],u_screenSize:[i,r]}),n.drawElements(n.TRIANGLES,f(this,Ws,"f").numElements,f(this,Ws,"f").elementType,0)},te=function(i,r){if(f(this,Is,"m",le).call(this))return;const n=this.gl,h=f(this,Is,"m",ie).call(this,n.VERTEX_SHADER,i),o=f(this,Is,"m",ie).call(this,n.FRAGMENT_SHADER,r),a=n.createProgram();if(n.attachShader(a,h),n.attachShader(a,o),n.linkProgram(a),!n.getProgramParameter(a,n.LINK_STATUS)){const i=n.getProgramInfoLog(a);throw n.deleteProgram(a),new Error(i)}const l=function(i,r){const n=function(i,r){let n=0;function h(r,h,o){const a=h.name.endsWith("[0]"),l=h.type,c=ps[l];if(!c)throw new Error(`unknown type: 0x${l.toString(16)}`);let f;if(c.bindPoint){const r=n;n+=h.size,f=a?c.arraySetter(i,l,r,o,h.size):c.setter(i,l,r,o,h.size)}else f=c.arraySetter&&a?c.arraySetter(i,o):c.setter(i,o);return f.location=o,f}const o={},a={},l=i.getProgramParameter(r,35718);for(let n=0;n<l;++n){const l=i.getActiveUniform(r,n);if(ks(l))continue;let c=l.name;c.endsWith("[0]")&&(c=c.substr(0,c.length-3));const f=i.getUniformLocation(r,l.name);if(f){const i=h(0,l,f);o[c]=i,$s(c,i,a,o)}}return o}(i,r),h=function(i,r){const n={},h=i.getProgramParameter(r,35721);for(let o=0;o<h;++o){const h=i.getActiveAttrib(r,o);if(ks(h))continue;const a=i.getAttribLocation(r,h.name),l=Ms[h.type],c=l.setter(i,a,l);c.location=a,n[h.name]=c}return n}(i,r),o={program:r,uniformSetters:n,attribSetters:h};return hs(i)&&(o.uniformBlockSpec=function(i,r){const n=i.getProgramParameter(r,35718),h=[],o=[];for(let a=0;a<n;++a){o.push(a),h.push({});const n=i.getActiveUniform(r,a);h[a].name=n.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(n){const a=n[0],l=n[1];i.getActiveUniforms(r,o,i[a]).forEach((function(i,r){h[r][l]=i}))}));const a={},l=i.getProgramParameter(r,35382);for(let n=0;n<l;++n){const h=i.getActiveUniformBlockName(r,n),o={index:i.getUniformBlockIndex(r,h),usedByVertexShader:i.getActiveUniformBlockParameter(r,n,35396),usedByFragmentShader:i.getActiveUniformBlockParameter(r,n,35398),size:i.getActiveUniformBlockParameter(r,n,35392),uniformIndices:i.getActiveUniformBlockParameter(r,n,35395)};o.used=o.usedByVertexShader||o.usedByFragmentShader,a[h]=o}return{blockSpecs:a,uniformData:h}}(i,r),o.transformFeedbackInfo=function(i,r){const n={},h=i.getProgramParameter(r,35971);for(let o=0;o<h;++o){const h=i.getTransformFeedbackVarying(r,o);n[h.name]={index:o,type:h.type,size:h.size}}return n}(i,r)),o}(n,a);return f(this,qs,"f").programs.push(a),l},ie=function(i,r){if(f(this,Is,"m",le).call(this))return;const n=this.gl,h=n.createShader(i);if(n.shaderSource(h,r),n.compileShader(h),!n.getShaderParameter(h,n.COMPILE_STATUS)){const i=n.getShaderInfoLog(h);throw n.deleteShader(h),new Error(i)}return f(this,qs,"f").shaders.push(h),h},se=function(i,r,n,h,o,a){if(f(this,Is,"m",le).call(this))return;const l=(o+1)*(a+1),c=o+1,u=new Float32Array(2*l),d=new Float32Array(2*l);let p=0,m=0;for(let l=0;l<=a;l++)for(let c=0;c<=o;c++){const f=c/o,y=l/a;u[p++]=i+n*f,u[p++]=r+h*y,d[m++]=f,d[m++]=y}const y=new Uint16Array(o*a*2*3);let w=0;for(let i=0;i<a;i++)for(let r=0;r<o;r++)y[w++]=(i+0)*c+r,y[w++]=(i+1)*c+r,y[w++]=(i+0)*c+r+1,y[w++]=(i+0)*c+r+1,y[w++]=(i+1)*c+r,y[w++]=(i+1)*c+r+1;const v=function(i,r,n){const h=rs(i,r),o=Object.assign({},{});o.attribs=Object.assign({},{},h);const a=r.indices;if(a){const r=Xi(a,"indices");o.indices=qi(i,r,34963),o.numElements=r.length,o.elementType=Ki(r)}else o.numElements||(o.numElements=function(i,r){let n,h;for(h=0;h<ns.length&&(n=ns[h],!(n in r))&&(n=Zi+n,!(n in r));++h);h===ns.length&&(n=Object.keys(r)[0]);const o=r[n];if(!o.buffer)return 1;i.bindBuffer(Hi,o.buffer);const a=i.getBufferParameter(Hi,34660);var l;i.bindBuffer(Hi,null);const c=a/(5120===(l=o.type)||5121===l?1:5122===l||5123===l?2:5124===l||5125===l||l===Vi?4:0),f=o.numComponents||o.size,u=c/f;if(u%1!=0)throw new Error(`numComponents ${f} not correct for length ${length}`);return u}(i,o.attribs));return o}(this.gl,{position:{numComponents:2,data:u},texcoord:{numComponents:2,data:d},indices:y});for(let i in v.attribs)f(this,qs,"f").buffers.push(v.attribs[i].buffer);return v},ee=function(i,r){var n,h,o;f(this,Is,"m",le).call(this)||(n=this.gl,h=i.attribSetters,(o=r).vertexArrayObject?n.bindVertexArray(o.vertexArrayObject):(function(i,r){for(const n in r){const h=i[n];h&&h(r[n])}}(h.attribSetters||h,o.attribs),o.indices&&n.bindBuffer(34963,o.indices)))},re=function(i,r,n,h=1,o=1){if(f(this,Is,"m",le).call(this))return;const a=this.gl,l=a.createTexture();return a.bindTexture(a.TEXTURE_2D,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,r),a.texImage2D(a.TEXTURE_2D,0,i,h,o,0,i,a.UNSIGNED_BYTE,null),f(this,qs,"f").textures.push(l),f(this,Gs,"f").set(l,i),f(this,Hs,"f").set(l,{width:h,height:o}),l},ne=function(i,r,n){if(f(this,Is,"m",le).call(this))return;const h=this.gl,o=f(this,Gs,"f").get(i);h.bindTexture(h.TEXTURE_2D,i),h.texImage2D(h.TEXTURE_2D,0,o,r,n,0,o,h.UNSIGNED_BYTE,null),f(this,Hs,"f").set(i,{width:r,height:n})},he=function(i){if(f(this,Is,"m",le).call(this))return;const r=this.gl,n=r.createFramebuffer();return r.bindFramebuffer(r.FRAMEBUFFER,n),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,i,0),f(this,qs,"f").frameBuffers.push(n),f(this,Vs,"f").set(n,i),n},oe=function(i,r,n,h,o){if(f(this,Is,"m",le).call(this))return;const a=this.gl;if(null===i){if(a.bindFramebuffer(a.FRAMEBUFFER,null),f(this,Zs,"f")){const i=this.srcWidth,l=this.srcHeight,c=a.drawingBufferWidth/i,f=a.drawingBufferHeight/l,u=256===i?1:0;r=-((h=a.drawingBufferWidth*(c-u))-i*c),n=-((o=a.drawingBufferHeight*(f-u))-l*f)}a.viewport(r??0,n??0,h??a.drawingBufferWidth,o??a.drawingBufferHeight)}else{const l=f(this,Vs,"f").get(i),{width:c,height:u}=f(this,Hs,"f").get(l);a.bindFramebuffer(a.FRAMEBUFFER,i),a.viewport(r??0,n??0,h??c,o??u)}},ae=function(i,r,n){if(f(this,Is,"m",le).call(this))return;const h=f(this,Vs,"f").get(i);f(this,Is,"m",ne).call(this,h,r,n)},le=function(){const i=f(this,Qs,"f")||this.isErrorState();return i&&f(this,ce,"f").call(this),i},WebglCanvas.defaultOptions={onlost(){},onrestored(){},useDpi:!0};class Html5Canvas{static isSupported(){if(!A)return!1;let i=document.createElement("canvas"),r=i.getContext("2d");const n=null!==r;return i=null,r=null,n}constructor(r,n,h,o={}){this.supportedStereoscopeModes=[i.CanvasStereoscopicMode.None],this.stereoscopeMode=i.CanvasStereoscopicMode.None,this.stereoscopeStrength=0,ue.set(this,void 0),de.set(this,void 0),pe.set(this,void 0),me.set(this,void 0),ye.set(this,new Uint32Array(16)),we.set(this,void 0),P(),u(this,ue,{...Html5Canvas.defaultOptions,...o},"f"),this.width=n,this.height=h,this.canvas=document.createElement("canvas"),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--html5",this.ctx=this.canvas.getContext("2d"),u(this,de,document.createElement("canvas"),"f"),u(this,pe,f(this,de,"f").getContext("2d"),"f"),y(null!==this.ctx&&null!==f(this,pe,"f"),"Could not create HTML5 canvas"),r&&r.appendChild(this.canvas),this.setCanvasSize(n,h)}setCanvasSize(i,r){const n=this.canvas,h=f(this,ue,"f").useDpi&&window.devicePixelRatio||1,o=i*h,a=r*h;this.width=i,this.height=r,this.dstWidth=o,this.dstHeight=a,n.style.width=`${i}px`,n.style.height=`${r}px`,n.width=o,n.height=a}setNote(i){const r=i.imageWidth,n=i.imageHeight;this.note=i,this.srcWidth=r,this.srcHeight=n,f(this,de,"f").width=r,f(this,de,"f").height=n,u(this,me,f(this,pe,"f").createImageData(r,n),"f"),u(this,we,new Uint32Array(f(this,me,"f").data.buffer),"f"),this.frameIndex=void 0,this.canvas.title=i.getTitle()}clear(i){if(f(this,we,"f").fill(0),this.ctx.clearRect(0,0,this.dstWidth,this.dstHeight),i){const[r,n,h,o]=i;this.ctx.fillStyle=`rgba(${r}, ${n}, ${h}, ${o})`,this.ctx.fillRect(0,0,this.dstWidth,this.dstHeight)}}drawFrame(i){this.clear(),f(this,ue,"f").useSmoothing||(this.ctx.imageSmoothingEnabled=!1),this.note.getFramePixelsRgba(i,f(this,we,"f"),f(this,ye,"f")),f(this,pe,"f").putImageData(f(this,me,"f"),0,0),this.ctx.drawImage(f(this,de,"f"),0,0,this.srcWidth,this.srcHeight,0,0,this.dstWidth,this.dstHeight),this.frameIndex=i}requestStereoScopeMode(r){this.supportedStereoscopeModes.includes(r)?this.stereoscopeMode=r:this.stereoscopeMode=i.CanvasStereoscopicMode.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}getDataUrl(i,r){return this.canvas.toDataURL(i,r)}async getBlob(i,r){return new Promise(((n,h)=>this.canvas.toBlob(n,i,r)))}destroy(){u(this,me,null,"f"),u(this,ye,null,"f"),u(this,we,null,"f"),this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null,f(this,de,"f").width=1,f(this,de,"f").height=1,u(this,de,null,"f")}}ue=new WeakMap,de=new WeakMap,pe=new WeakMap,me=new WeakMap,ye=new WeakMap,we=new WeakMap,Html5Canvas.defaultOptions={useDpi:!0,useSmoothing:!0};class UniversalCanvas{constructor(r,n=640,h=480,o={}){ve.add(this),this.isReady=!1,this.isHtml5=!1,this.supportedStereoscopeModes=[],this.stereoscopeMode=i.CanvasStereoscopicMode.None,this.stereoscopeStrength=1,ge.set(this,[WebglCanvas,Html5Canvas]),be.set(this,0),Ae.set(this,void 0),Pe.set(this,{}),this.width=n,this.height=h,u(this,Ae,r,"f"),u(this,Pe,o,"f"),f(this,ve,"m",Ce).call(this,f(this,ge,"f")[0])}fallbackIfPossible(){if(f(this,be,"f")>=f(this,ge,"f").length)throw new Error("No renderer to fall back to");u(this,be,f(this,be,"f")+1,"f"),f(this,ve,"m",Ce).call(this,f(this,ge,"f")[f(this,be,"f")])}switchToHtml5(){f(this,ve,"m",Ce).call(this,Html5Canvas)}setCanvasSize(i,r){const n=this.renderer;n.setCanvasSize(i,r),this.width=i,this.width=r,this.dstWidth=n.dstWidth,this.dstHeight=n.dstHeight}setNote(i){this.note=i,this.renderer.setNote(i),this.frameIndex=void 0,this.srcWidth=this.renderer.srcWidth,this.srcHeight=this.renderer.srcHeight}clear(i){this.renderer.clear(i)}drawFrame(i){this.renderer.drawFrame(i),this.frameIndex=i}forceUpdate(){this.renderer.forceUpdate()}requestStereoScopeMode(i){this.renderer.requestStereoScopeMode(i),this.stereoscopeMode=this.renderer.stereoscopeMode}getDataUrl(i,r){return this.renderer.getDataUrl()}async getBlob(i,r){return this.renderer.getBlob()}destroy(){this.renderer.destroy(),this.note=null}}ge=new WeakMap,be=new WeakMap,Ae=new WeakMap,Pe=new WeakMap,ve=new WeakSet,Ce=function(i){let r=!1;const n=new i(f(this,Ae,"f"),this.width,this.height,{...f(this,Pe,"f"),onlost:()=>{r=!0,this.fallbackIfPossible()}});r||(this.note&&(n.setNote(this.note),n.frameIndex=this.renderer?.frameIndex,n.forceUpdate()),this.renderer&&this.renderer.destroy(),this.isHtml5=n instanceof Html5Canvas,this.isReady=!0,this.renderer=n,u(this,be,f(this,ge,"f").indexOf(i),"f"),this.supportedStereoscopeModes=n.supportedStereoscopeModes,n.stereoscopeStrength=this.stereoscopeStrength,this.requestStereoScopeMode(this.stereoscopeMode))};const Be=A?window.AudioContext||window.webkitAudioContext:null;class WebAudioPlayer{constructor(){Se.add(this),this.useEq=!1,this.useAnalyser=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],_e.set(this,1),xe.set(this,!1),Me.set(this,0),ke.set(this,0),Fe.set(this,[]),ze.set(this,void 0),$e.set(this,void 0),Ue.set(this,void 0),P()}set volume(i){this.setVolume(i)}get volume(){return f(this,_e,"f")}set loop(i){u(this,xe,i,"f"),f(this,Ue,"f")&&(f(this,Ue,"f").loop=i)}get loop(){return f(this,xe,"f")}setBuffer(i,r){const n=f(this,Se,"m",Ee).call(this),h=i.length,o=n.createBuffer(1,h,r),a=o.getChannelData(0);if(i instanceof Float32Array)a.set(i,0);else if(i instanceof Int16Array)for(let r=0;r<h;r++)a[r]=i[r]/32768;u(this,ze,o,"f"),this.sampleRate=r}setAnalyserEnabled(i){this.useAnalyser=i,f(this,Se,"m",Te).call(this)}setVolume(i){u(this,_e,i,"f"),f(this,$e,"f")&&(f(this,$e,"f").gain.value=Math.pow(i,2))}playFrom(i){f(this,Se,"m",Te).call(this),u(this,Me,i,"f"),u(this,ke,this.ctx.currentTime,"f"),f(this,Ue,"f").loop=f(this,xe,"f"),f(this,Ue,"f").start(0,i)}stop(){f(this,Ue,"f")&&f(this,Ue,"f").stop(0)}getCurrentTime(){return f(this,Me,"f")+(this.ctx.currentTime-f(this,ke,"f"))}async destroy(){this.stop();const i=f(this,Se,"m",Ee).call(this);f(this,Fe,"f").forEach((i=>i.disconnect())),u(this,Fe,[],"f"),this.analyser=void 0,"closed"!==i.state&&"function"==typeof i.close&&await i.close(),u(this,ze,null,"f")}}var Le,We,Ke;_e=new WeakMap,xe=new WeakMap,Me=new WeakMap,ke=new WeakMap,Fe=new WeakMap,ze=new WeakMap,$e=new WeakMap,Ue=new WeakMap,Se=new WeakSet,Ee=function(){return this.ctx||(this.ctx=new Be),this.ctx},Ie=function(i){const r=f(this,Se,"m",Ee).call(this),n=this.eqSettings;let h=i;return n.forEach((([i,o],a)=>{const l=r.createBiquadFilter();f(this,Fe,"f").push(l),l.frequency.value=i,l.gain.value=o,0===a?l.type="lowshelf":a===n.length-1?l.type="highshelf":l.type="peaking",h.connect(l),h=l})),h},Te=function(){const i=f(this,Se,"m",Ee).call(this);u(this,Fe,[],"f");const r=i.createBufferSource();f(this,Fe,"f").push(r),r.buffer=f(this,ze,"f");const n=i.createGain();if(f(this,Fe,"f").push(n),this.useEq?f(this,Se,"m",Ie).call(this,r).connect(n):r.connect(n),this.useAnalyser){const r=i.createAnalyser();f(this,Fe,"f").push(r),this.analyser=r,n.connect(r),r.connect(i.destination)}else this.analyser=void 0,n.connect(i.destination);u(this,Ue,r,"f"),u(this,$e,n,"f"),this.setVolume(f(this,_e,"f"))};class Player{constructor(r,n,h,o={}){Le.add(this),this.duration=0,this.autoplay=!1,this.supportedEvents=xi,this.m=null,this.v=!1,this.A=1,this.C=!1,this._=null,this.M=!1,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=r=>{if(!this.isPlaying)return;const n=r/1e3,h=this.duration,o=this.audio.getCurrentTime();let a=n-this.playbackStartTime;if(Math.abs(a%h-o%h)>.01&&(a=o),a>=h){if(!this.loop)return this.pause(),this.M=!0,void this.emit(i.PlayerEvent.Ended);this.playbackStartTime=n,this.emit(i.PlayerEvent.Loop)}this.setCurrentTime(a%h),this.playbackLoopId=requestAnimationFrame(this.playbackLoop)},P();const a="string"==typeof r?document.querySelector(r):r;this.parserSettings=o,this.renderer=new UniversalCanvas(a,n,h,{onlost:()=>this.emit(i.PlayerEvent.Error),onrestored:()=>this.reload()}),this.audio=new WebAudioPlayer,this.el=a}get src(){return this.m}set src(i){throw new Error("Setting a Player source has been deprecated, please use the load() method instead")}get paused(){return!this.isPlaying}set paused(i){i?this.pause():this.play()}get currentFrame(){return this._}set currentFrame(i){this.setCurrentFrame(i)}get currentTime(){return this.isNoteLoaded?this.playbackTime:null}set currentTime(i){this.setCurrentTime(i)}get progress(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null}set progress(i){this.setProgress(i)}get volume(){return this.getVolume()}set volume(i){this.setVolume(i)}get muted(){return this.getMuted()}set muted(i){this.setMuted(i)}get loop(){return this.getLoop()}set loop(i){this.setLoop(i)}get framerate(){return this.note.framerate}get frameCount(){return this.note.frameCount}get frameSpeed(){return this.note.frameSpeed}get buffered(){return Mi([[0,this.duration]])}get seekable(){return Mi([[0,this.duration]])}get currentSrc(){return this.m}get videoWidth(){return this.isNoteLoaded?this.note.imageWidth:0}get videoHeight(){return this.isNoteLoaded?this.note.imageHeight:0}async load(r){if(this.isNoteLoaded&&this.closeNote(),this.m=r,!r)return this.openNote(this.note);this.emit(i.PlayerEvent.LoadStart);const[n,h]=await(async i=>{try{return[null,await i().catch((i=>{throw i}))]}catch(i){return[i,null]}})((()=>Ci(r,this.parserSettings)));if(n)throw this.emit(i.PlayerEvent.Error,n),new Error(`Error loading Flipnote: ${n.message}`);this.openNote(h)}async reload(){if(this.note)return await this.load(this.note.buffer)}async updateSettings(i){return this.parserSettings=i,await this.reload()}closeNote(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this.m=null,this._=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clear()}openNote(r){this.isNoteLoaded&&this.closeNote(),this.note=r,this.meta=r.meta,this.emit(i.PlayerEvent.LoadedMeta),this.noteFormat=r.format,this.duration=r.duration,this.playbackTime=0,this._=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=r.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(r.getAudioMasterPcm(),r.sampleRate),this.emit(i.PlayerEvent.CanPlay),this.emit(i.PlayerEvent.CanPlayThrough),this.setLoop(r.meta.loop),this.renderer.setNote(r),this.drawFrame(r.thumbFrameIndex),this.emit(i.PlayerEvent.LoadedData),this.emit(i.PlayerEvent.Load),this.emit(i.PlayerEvent.Ready),this.autoplay&&this.play()}setCurrentTime(r){this.assertNoteLoaded();const n=Math.floor(r/(1/this.framerate));this.setCurrentFrame(n),this.playbackTime=r,this.emit(i.PlayerEvent.Progress,this.progress)}getCurrentTime(){return this.currentTime}getTimeCounter(){return`${Fi(Math.max(this.currentTime,0))} / ${Fi(this.duration)}`}getFrameCounter(){return`${ki(this.currentFrame+1,3)} / ${ki(this.frameCount,3)}`}setProgress(i){this.assertNoteLoaded(),w(i,0,100,"progress"),this.currentTime=this.duration*(i/100)}getProgress(){return this.progress}async play(){if(this.assertNoteLoaded(),this.isPlaying)return;this.M&&(this.playbackTime=0,this.M=!1);const r=performance.now();this.playbackStartTime=r/1e3-this.playbackTime,this.isPlaying=!0,this.hasPlaybackStarted=!0,f(this,Le,"m",We).call(this),this.playbackLoop(r),this.emit(i.PlayerEvent.Play)}pause(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),f(this,Le,"m",Ke).call(this),this.emit(i.PlayerEvent.Pause))}togglePlay(){this.isPlaying?this.pause():this.play()}getPaused(){return!this.isPlaying}getDuration(){return this.duration}getLoop(){return this.v}setLoop(i){this.v=i,this.audio.loop=i}toggleLoop(){this.setLoop(!this.v)}setCurrentFrame(r){this.assertNoteLoaded();const n=Math.max(0,Math.min(Math.floor(r),this.frameCount-1));(n!==this.currentFrame||this.showThumbnail)&&(this._=n,this.drawFrame(n),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=n*(1/this.framerate),this.emit(i.PlayerEvent.SeekEnd)),this.emit(i.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(i.PlayerEvent.Progress,this.progress),this.emit(i.PlayerEvent.TimeUpdate,this.currentFrame))}nextFrame(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(i.PlayerEvent.FrameNext)}prevFrame(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(i.PlayerEvent.FramePrev)}lastFrame(){this.currentFrame=this.frameCount-1,this.emit(i.PlayerEvent.FrameLast)}firstFrame(){this.currentFrame=0,this.emit(i.PlayerEvent.FrameFirst)}thumbnailFrame(){this.currentFrame=this.note.thumbFrameIndex}startSeek(){this.isSeeking||(this.emit(i.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)}seek(i){this.isSeeking&&(this.progress=100*i)}endSeek(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1}drawFrame(i){this.renderer.drawFrame(i)}forceUpdate(){this.renderer.forceUpdate()}resize(i,r){r!==.75*i&&console.warn(`Canvas width to height ratio should be 3:4 for best results (got ${i}x${r})`),this.renderer.setCanvasSize(i,r),this.forceUpdate()}setLayerVisibility(i,r){this.note.layerVisibility[i]=r,this.layerVisibility[i]=r,this.forceUpdate()}getLayerVisibility(i){return this.layerVisibility[i]}toggleLayerVisibility(i){this.setLayerVisibility(i,!this.layerVisibility[i])}toggleAudioEq(){this.setAudioEq(!this.audio.useEq)}setAudioEq(i){this.isPlaying&&(this.wasPlaying=!0,f(this,Le,"m",Ke).call(this)),this.audio.useEq=i,this.wasPlaying&&(this.wasPlaying=!1,f(this,Le,"m",We).call(this))}mute(){this.setMuted(!0)}unmute(){this.setMuted(!1)}setMuted(r){this.audio.volume=r?0:this.A,this.C=r,this.emit(i.PlayerEvent.VolumeChange,this.audio.volume)}getMuted(){return 0===this.volume||this.C}toggleMuted(){this.setMuted(!this.C)}setVolume(r){w(r,0,1,"volume"),this.A=r,this.audio.volume=r,this.emit(i.PlayerEvent.VolumeChange,this.audio.volume)}getVolume(){return this.C?0:this.A}seekToNextFrame(){this.nextFrame()}fastSeek(i){this.currentTime=i}canPlayType(i){switch(i){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";default:return""}}getVideoPlaybackQuality(){return{creationTime:0,droppedVideoFrames:0,corruptedVideoFrames:0,totalVideoFrames:this.frameCount}}requestPictureInPicture(){throw new Error("Not implemented")}captureStream(){throw new Error("Not implemented")}on(i,r){const n=this.events;(Array.isArray(i)?i:[i]).forEach((i=>{n.has(i)?n.get(i).push(r):n.set(i,[r])}))}off(i,r){const n=this.events;(Array.isArray(i)?i:[i]).forEach((i=>{if(!n.has(i))return;const h=n.get(i);n.set(i,h.splice(h.indexOf(r),1))}))}emit(r,...n){const h=this.events;if(r!==i.PlayerEvent.i&&h.has(r)){h.get(r).forEach((i=>i.apply(null,n)));const i=`on${r}`,o=this;"function"==typeof o[i]&&o[i].apply(null,n)}h.has(i.PlayerEvent.i)&&h.get(i.PlayerEvent.i).forEach((i=>i.apply(null,[r,...n])))}clearEvents(){this.events.clear()}async destroy(){this.clearEvents(),this.emit(i.PlayerEvent.Destroy),this.closeNote(),await this.renderer.destroy(),await this.audio.destroy()}assertNoteLoaded(){y(this.isNoteLoaded,"No Flipnote is currently loaded in this player")}}function Ne(i){class PlayerMixinClass extends i{get renderer(){return this.player.renderer}get note(){return this.player.note}get noteFormat(){return this.player.noteFormat}get meta(){return this.player.meta}get duration(){return this.player.duration}get layerVisibility(){return this.player.layerVisibility}get autoplay(){return this.player.autoplay}set autoplay(i){this.player.autoplay=i}}for(let r of Reflect.ownKeys(Player.prototype)){let n=Object.getOwnPropertyDescriptor(Player.prototype,r);r in i.prototype||"constructor"===r||"name"===r||"prototype"===r||"string"==typeof r&&r.startsWith("#")||(n.value&&"function"==typeof n.value?Object.defineProperty(PlayerMixinClass.prototype,r,{...n,value(...i){return this.player[r](...i)}}):(n.get||n.set)&&Object.defineProperty(PlayerMixinClass.prototype,r,{...n,set(i){this.player[r]=i},get(){return this.player[r]}}))}return PlayerMixinClass}Le=new WeakSet,We=function(){this.audio.playFrom(this.currentTime)},Ke=function(){this.audio.stop()};class EncoderBase{constructor(){this.dataUrl=null}getBuffer(){return y(C,"This feature is only available in NodeJS environments"),Buffer.from(this.getArrayBuffer())}getBlob(){return P(),new Blob([this.getArrayBuffer()],{type:this.mimeType})}getUrl(){return P(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())}revokeUrl(){P(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)}}const De=5003,Oe=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];class LzwCompressor{constructor(i,r,n){this.accum=new Uint8Array(256),this.htab=new Int32Array(De),this.codetab=new Int32Array(De),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=i,this.height=r,this.colorDepth=n,this.reset()}reset(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}char_out(i,r){this.accum[this.a_count++]=i,this.a_count>=254&&this.flush_char(r)}cl_block(i){this.cl_hash(De),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,i)}cl_hash(i){for(var r=0;r<i;++r)this.htab[r]=-1}compress(i,r){var n,h,o,a,l,c,f;for(this.g_init_bits=i,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<i-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,a=this.nextPixel(),f=0,n=De;n<65536;n*=2)++f;f=8-f,c=De,this.cl_hash(c),this.output(this.ClearCode,r);t:for(;-1!=(h=this.nextPixel());)if(n=(h<<12)+a,o=h<<f^a,this.htab[o]!==n){if(this.htab[o]>=0){l=c-o,0===o&&(l=1);do{if((o-=l)<0&&(o+=c),this.htab[o]===n){a=this.codetab[o];continue t}}while(this.htab[o]>=0)}this.output(a,r),a=h,this.free_ent<4096?(this.codetab[o]=this.free_ent++,this.htab[o]=n):this.cl_block(r)}else a=this.codetab[o];this.output(a,r),this.output(this.EOFCode,r)}encode(i,r){this.pixels=i,r.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,r),r.writeByte(0)}flush_char(i){this.a_count>0&&(i.writeByte(this.a_count),i.writeBytes(this.accum,0,this.a_count),this.a_count=0)}get_maxcode(i){return(1<<i)-1}nextPixel(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}output(i,r){for(this.cur_accum&=Oe[this.cur_bits],this.cur_bits>0?this.cur_accum|=i<<this.cur_bits:this.cur_accum=i,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,r),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),i==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,r),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(r)}}}var Re,je,Ge,He,Ve,Ze,qe,Qe,Ye,Je,Xe,tr,ir,sr,er;class GifImage extends EncoderBase{constructor(i,r,n={}){super(),Re.add(this),this.mimeType="gif/image",this.frameCount=0,je.set(this,void 0),Ge.set(this,void 0),this.width=i,this.height=r,u(this,je,new ByteArray,"f"),this.settings={...GifImage.defaultSettings,...n},u(this,Ge,new LzwCompressor(i,r,n.colorDepth),"f")}static fromFlipnote(i,r={}){const n=new GifImage(i.imageWidth,i.imageHeight,{delay:100/i.framerate,repeat:i.meta?.loop?-1:0,...r});n.palette=i.globalPalette;for(let r=0;r<i.frameCount;r++)n.writeFrame(i.getFramePixels(r));return n.finish(),n}static fromFlipnoteFrame(i,r,n={}){const h=new GifImage(i.imageWidth,i.imageHeight,{delay:0,repeat:0,...n});return h.palette=i.globalPalette,h.writeFrame(i.getFramePixels(r)),h.finish(),h}writeFrame(i){0===this.frameCount?f(this,Re,"m",He).call(this,i):f(this,Re,"m",Ve).call(this,i),this.frameCount+=1}finish(){f(this,je,"f").writeByte(59)}getArrayBuffer(){return f(this,je,"f").getBuffer()}getImage(){P();const i=new Image(this.width,this.height);return i.src=this.getUrl(),i}}je=new WeakMap,Ge=new WeakMap,Re=new WeakSet,He=function(i){f(this,Re,"m",Ze).call(this),f(this,Re,"m",Qe).call(this),f(this,Re,"m",Je).call(this),f(this,Re,"m",Ye).call(this),f(this,Re,"m",qe).call(this),f(this,Re,"m",Xe).call(this),f(this,Re,"m",ir).call(this,i)},Ve=function(i){f(this,Re,"m",qe).call(this),f(this,Re,"m",Xe).call(this),f(this,Re,"m",ir).call(this,i)},Ze=function(){f(this,je,"f").writeChars("GIF89a")},qe=function(){f(this,je,"f").writeByte(33),f(this,je,"f").writeByte(249),f(this,je,"f").writeByte(4),f(this,je,"f").writeByte(0),f(this,je,"f").writeU16(this.settings.delay),f(this,je,"f").writeByte(0),f(this,je,"f").writeByte(0)},Qe=function(){const i=this.palette,r=128|this.settings.colorDepth-1<<4|f(this,Re,"m",tr).call(this,i.length)-1;f(this,je,"f").writeU16(this.width),f(this,je,"f").writeU16(this.height),f(this,je,"f").writeBytes([r,0,0])},Ye=function(){f(this,je,"f").writeByte(33),f(this,je,"f").writeByte(255),f(this,je,"f").writeByte(11),f(this,je,"f").writeChars("NETSCAPE2.0"),f(this,je,"f").writeByte(3),f(this,je,"f").writeByte(1),f(this,je,"f").writeU16(this.settings.repeat),f(this,je,"f").writeByte(0)},Je=function(){const i=this.palette,r=1<<f(this,Re,"m",tr).call(this,i.length);for(let n=0;n<r;n++){let r=[0,0,0];n<i.length&&(r=i[n]),f(this,je,"f").writeByte(r[0]),f(this,je,"f").writeByte(r[1]),f(this,je,"f").writeByte(r[2])}},Xe=function(){f(this,je,"f").writeByte(44),f(this,je,"f").writeU16(0),f(this,je,"f").writeU16(0),f(this,je,"f").writeU16(this.width),f(this,je,"f").writeU16(this.height),f(this,je,"f").writeByte(0)},tr=function(i){return Math.max(Math.ceil(Math.log2(i)),1)},ir=function(i){f(this,Ge,"f").colorDepth=this.settings.colorDepth,f(this,Ge,"f").reset(),f(this,Ge,"f").encode(i,f(this,je,"f"))},GifImage.defaultSettings={delay:100,repeat:-1,colorDepth:8};class WavAudio extends EncoderBase{constructor(i,r=1,n=16){super(),sr.set(this,void 0),er.set(this,void 0),this.sampleRate=i,this.channels=r,this.bitsPerSample=n;const h=new ArrayBuffer(44),o=new DataStream(h);o.writeChars("RIFF"),o.writeUint32(0),o.writeChars("WAVE"),o.writeChars("fmt "),o.writeUint32(16),o.writeUint16(1),o.writeUint16(this.channels),o.writeUint32(this.sampleRate),o.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),o.writeUint16(this.bitsPerSample*this.channels/8),o.writeUint16(this.bitsPerSample),o.writeChars("data"),o.writeUint32(0),u(this,sr,o,"f"),u(this,er,null,"f")}static fromFlipnote(i){const r=i.sampleRate,n=new WavAudio(r,1,16),h=i.getAudioMasterPcm(r);return n.writeSamples(h),n}static fromFlipnoteTrack(i,r){const n=i.sampleRate,h=new WavAudio(n,1,16),o=i.getAudioTrackPcm(r,n);return h.writeSamples(o),h}writeSamples(i){let r=f(this,sr,"f");r.seek(4),r.writeUint32(r.numBytes+i.byteLength),r.seek(40),r.writeUint32(i.byteLength),u(this,er,i,"f")}getArrayBuffer(){const i=f(this,sr,"f").bytes,r=new Uint8Array(f(this,er,"f").buffer),n=new Uint8Array(f(this,sr,"f").numBytes+f(this,er,"f").byteLength);return n.set(i),n.set(r,i.byteLength),n.buffer}}sr=new WeakMap,er=new WeakMap;const rr=globalThis,nr=rr.ShadowRoot&&(void 0===rr.ShadyCSS||rr.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,hr=Symbol(),or=new WeakMap;let ar=class{constructor(i,r,n){if(this.F=!0,n!==hr)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=i,this.t=r}get styleSheet(){let i=this.o;const r=this.t;if(nr&&void 0===i){const n=void 0!==r&&1===r.length;n&&(i=or.get(r)),void 0===i&&((this.o=i=new CSSStyleSheet).replaceSync(this.cssText),n&&or.set(r,i))}return i}toString(){return this.cssText}};const lr=(i,...r)=>{const n=1===i.length?i[0]:r.reduce(((r,n,h)=>r+(i=>{if(!0===i.F)return i.cssText;if("number"==typeof i)return i;throw Error("Value passed to 'css' function must be a 'css' function result: "+i+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(n)+i[h+1]),i[0]);return new ar(n,i,hr)},cr=nr?i=>i:i=>i instanceof CSSStyleSheet?(i=>{let r="";for(const n of i.cssRules)r+=n.cssText;return(i=>new ar("string"==typeof i?i:i+"",void 0,hr))(r)})(i):i,{is:fr,defineProperty:ur,getOwnPropertyDescriptor:dr,getOwnPropertyNames:pr,getOwnPropertySymbols:mr,getPrototypeOf:yr}=Object,wr=globalThis,vr=wr.trustedTypes,gr=vr?vr.emptyScript:"",br=wr.reactiveElementPolyfillSupport,Ar=(i,r)=>i,Pr={toAttribute(i,r){switch(r){case Boolean:i=i?gr:null;break;case Object:case Array:i=null==i?i:JSON.stringify(i)}return i},fromAttribute(i,r){let n=i;switch(r){case Boolean:n=null!==i;break;case Number:n=null===i?null:Number(i);break;case Object:case Array:try{n=JSON.parse(i)}catch(i){n=null}}return n}},Cr=(i,r)=>!fr(i,r),Sr={attribute:!0,type:String,converter:Pr,reflect:!1,hasChanged:Cr};Symbol.metadata??=Symbol("metadata"),wr.litPropertyMetadata??=new WeakMap;class b extends HTMLElement{static addInitializer(i){this.U(),(this.l??=[]).push(i)}static get observedAttributes(){return this.finalize(),this.I&&[...this.I.keys()]}static createProperty(i,r=Sr){if(r.state&&(r.attribute=!1),this.U(),this.elementProperties.set(i,r),!r.noAccessor){const n=Symbol(),h=this.getPropertyDescriptor(i,n,r);void 0!==h&&ur(this.prototype,i,h)}}static getPropertyDescriptor(i,r,n){const{get:h,set:o}=dr(this.prototype,i)??{get(){return this[r]},set(i){this[r]=i}};return{get(){return h?.call(this)},set(r){const a=h?.call(this);o.call(this,r),this.requestUpdate(i,a,n)},configurable:!0,enumerable:!0}}static getPropertyOptions(i){return this.elementProperties.get(i)??Sr}static U(){if(this.hasOwnProperty(Ar("elementProperties")))return;const i=yr(this);i.finalize(),void 0!==i.l&&(this.l=[...i.l]),this.elementProperties=new Map(i.elementProperties)}static finalize(){if(this.hasOwnProperty(Ar("finalized")))return;if(this.finalized=!0,this.U(),this.hasOwnProperty(Ar("properties"))){const i=this.properties,r=[...pr(i),...mr(i)];for(const n of r)this.createProperty(n,i[n])}const i=this[Symbol.metadata];if(null!==i){const r=litPropertyMetadata.get(i);if(void 0!==r)for(const[i,n]of r)this.elementProperties.set(i,n)}this.I=new Map;for(const[i,r]of this.elementProperties){const n=this.B(i,r);void 0!==n&&this.I.set(n,i)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(i){const r=[];if(Array.isArray(i)){const n=new Set(i.flat(1/0).reverse());for(const i of n)r.unshift(cr(i))}else void 0!==i&&r.push(cr(i));return r}static B(i,r){const n=r.attribute;return!1===n?void 0:"string"==typeof n?n:"string"==typeof i?i.toLowerCase():void 0}constructor(){super(),this.L=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this.W=null,this.K()}K(){this.N=new Promise((i=>this.enableUpdating=i)),this.D=new Map,this.O(),this.requestUpdate(),this.constructor.l?.forEach((i=>i(this)))}addController(i){(this.R??=new Set).add(i),void 0!==this.renderRoot&&this.isConnected&&i.hostConnected?.()}removeController(i){this.R?.delete(i)}O(){const i=new Map,r=this.constructor.elementProperties;for(const n of r.keys())this.hasOwnProperty(n)&&(i.set(n,this[n]),delete this[n]);i.size>0&&(this.L=i)}createRenderRoot(){const i=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return((i,r)=>{if(nr)i.adoptedStyleSheets=r.map((i=>i instanceof CSSStyleSheet?i:i.styleSheet));else for(const n of r){const r=document.createElement("style"),h=rr.litNonce;void 0!==h&&r.setAttribute("nonce",h),r.textContent=n.cssText,i.appendChild(r)}})(i,this.constructor.elementStyles),i}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this.R?.forEach((i=>i.hostConnected?.()))}enableUpdating(i){}disconnectedCallback(){this.R?.forEach((i=>i.hostDisconnected?.()))}attributeChangedCallback(i,r,n){this.G(i,n)}H(i,r){const n=this.constructor.elementProperties.get(i),h=this.constructor.B(i,n);if(void 0!==h&&!0===n.reflect){const o=(void 0!==n.converter?.toAttribute?n.converter:Pr).toAttribute(r,n.type);this.W=i,null==o?this.removeAttribute(h):this.setAttribute(h,o),this.W=null}}G(i,r){const n=this.constructor,h=n.I.get(i);if(void 0!==h&&this.W!==h){const i=n.getPropertyOptions(h),o="function"==typeof i.converter?{fromAttribute:i.converter}:void 0!==i.converter?.fromAttribute?i.converter:Pr;this.W=h,this[h]=o.fromAttribute(r,i.type),this.W=null}}requestUpdate(i,r,n){if(void 0!==i){if(n??=this.constructor.getPropertyOptions(i),!(n.hasChanged??Cr)(this[i],r))return;this.P(i,r,n)}!1===this.isUpdatePending&&(this.N=this.V())}P(i,r,n){this.D.has(i)||this.D.set(i,r),!0===n.reflect&&this.W!==i&&(this.Z??=new Set).add(i)}async V(){this.isUpdatePending=!0;try{await this.N}catch(i){Promise.reject(i)}const i=this.scheduleUpdate();return null!=i&&await i,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this.L){for(const[i,r]of this.L)this[i]=r;this.L=void 0}const i=this.constructor.elementProperties;if(i.size>0)for(const[r,n]of i)!0!==n.wrapped||this.D.has(r)||void 0===this[r]||this.P(r,this[r],n)}let i=!1;const r=this.D;try{i=this.shouldUpdate(r),i?(this.willUpdate(r),this.R?.forEach((i=>i.hostUpdate?.())),this.update(r)):this.q()}catch(r){throw i=!1,this.q(),r}i&&this.Y(r)}willUpdate(i){}Y(i){this.R?.forEach((i=>i.hostUpdated?.())),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(i)),this.updated(i)}q(){this.D=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this.N}shouldUpdate(i){return!0}update(i){this.Z&&=this.Z.forEach((i=>this.H(i,this[i]))),this.q()}updated(i){}firstUpdated(i){}}b.elementStyles=[],b.shadowRootOptions={mode:"open"},b[Ar("elementProperties")]=new Map,b[Ar("finalized")]=new Map,br?.({ReactiveElement:b}),(wr.reactiveElementVersions??=[]).push("2.0.4");const _r=globalThis,xr=_r.trustedTypes,Mr=xr?xr.createPolicy("lit-html",{createHTML:i=>i}):void 0,kr="$lit$",Fr=`lit$${Math.random().toFixed(9).slice(2)}$`,zr="?"+Fr,$r=`<${zr}>`,Ur=document,Er=()=>Ur.createComment(""),Ir=i=>null===i||"object"!=typeof i&&"function"!=typeof i,Tr=Array.isArray,Br="[ \t\n\f\r]",Lr=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,Wr=/-->/g,Kr=/>/g,Nr=RegExp(`>|${Br}(?:([^\\s"'>=/]+)(${Br}*=${Br}*(?:[^ \t\n\f\r"'\`<>=]|("|')|))|$)`,"g"),Dr=/'/g,Or=/"/g,Rr=/^(?:script|style|textarea|title)$/i,jr=(i,...r)=>({J:1,strings:i,values:r}),Gr=Symbol.for("lit-noChange"),Hr=Symbol.for("lit-nothing"),Vr=new WeakMap,Zr=Ur.createTreeWalker(Ur,129);function qr(i,r){if(!Array.isArray(i)||!i.hasOwnProperty("raw"))throw Error("invalid template strings array");return void 0!==Mr?Mr.createHTML(r):r}const Qr=(i,r)=>{const n=i.length-1,h=[];let o,a=2===r?"<svg>":"",l=Lr;for(let r=0;r<n;r++){const n=i[r];let c,f,u=-1,d=0;for(;d<n.length&&(l.lastIndex=d,f=l.exec(n),null!==f);)d=l.lastIndex,l===Lr?"!--"===f[1]?l=Wr:void 0!==f[1]?l=Kr:void 0!==f[2]?(Rr.test(f[2])&&(o=RegExp("</"+f[2],"g")),l=Nr):void 0!==f[3]&&(l=Nr):l===Nr?">"===f[0]?(l=o??Lr,u=-1):void 0===f[1]?u=-2:(u=l.lastIndex-f[2].length,c=f[1],l=void 0===f[3]?Nr:'"'===f[3]?Or:Dr):l===Or||l===Dr?l=Nr:l===Wr||l===Kr?l=Lr:(l=Nr,o=void 0);const p=l===Nr&&i[r+1].startsWith("/>")?" ":"";a+=l===Lr?n+$r:u>=0?(h.push(c),n.slice(0,u)+kr+n.slice(u)+Fr+p):n+Fr+(-2===u?r:p)}return[qr(i,a+(i[n]||"<?>")+(2===r?"</svg>":"")),h]};class V{constructor({strings:i,J:r},n){let h;this.parts=[];let o=0,a=0;const l=i.length-1,c=this.parts,[f,u]=Qr(i,r);if(this.el=V.createElement(f,n),Zr.currentNode=this.el.content,2===r){const i=this.el.content.firstChild;i.replaceWith(...i.childNodes)}for(;null!==(h=Zr.nextNode())&&c.length<l;){if(1===h.nodeType){if(h.hasAttributes())for(const i of h.getAttributeNames())if(i.endsWith(kr)){const r=u[a++],n=h.getAttribute(i).split(Fr),l=/([.?@])?(.*)/.exec(r);c.push({type:1,index:o,name:l[2],strings:n,ctor:"."===l[1]?k:"?"===l[1]?H:"@"===l[1]?I:R}),h.removeAttribute(i)}else i.startsWith(Fr)&&(c.push({type:6,index:o}),h.removeAttribute(i));if(Rr.test(h.tagName)){const i=h.textContent.split(Fr),r=i.length-1;if(r>0){h.textContent=xr?xr.emptyScript:"";for(let n=0;n<r;n++)h.append(i[n],Er()),Zr.nextNode(),c.push({type:2,index:++o});h.append(i[r],Er())}}}else if(8===h.nodeType)if(h.data===zr)c.push({type:2,index:o});else{let i=-1;for(;-1!==(i=h.data.indexOf(Fr,i+1));)c.push({type:7,index:o}),i+=Fr.length-1}o++}}static createElement(i,r){const n=Ur.createElement("template");return n.innerHTML=i,n}}function Yr(i,r,n=i,h){if(r===Gr)return r;let o=void 0!==h?n.X?.[h]:n.tt;const a=Ir(r)?void 0:r.et;return o?.constructor!==a&&(o?.rt?.(!1),void 0===a?o=void 0:(o=new a(i),o.ht(i,n,h)),void 0!==h?(n.X??=[])[h]=o:n.tt=o),void 0!==o&&(r=Yr(i,o.ot(i,r.values),o,h)),r}class S{constructor(i,r){this.lt=[],this.ct=void 0,this.ut=i,this.dt=r}get parentNode(){return this.dt.parentNode}get yt(){return this.dt.yt}u(i){const{el:{content:r},parts:n}=this.ut,h=(i?.creationScope??Ur).importNode(r,!0);Zr.currentNode=h;let o=Zr.nextNode(),a=0,l=0,c=n[0];for(;void 0!==c;){if(a===c.index){let r;2===c.type?r=new M(o,o.nextSibling,this,i):1===c.type?r=new c.ctor(o,c.name,c.strings,this,i):6===c.type&&(r=new L(o,this,i)),this.lt.push(r),c=n[++l]}a!==c?.index&&(o=Zr.nextNode(),a++)}return Zr.currentNode=Ur,h}p(i){let r=0;for(const n of this.lt)void 0!==n&&(void 0!==n.strings?(n.wt(i,n,r),r+=n.strings.length-2):n.wt(i[r])),r++}}class M{get yt(){return this.dt?.yt??this.vt}constructor(i,r,n,h){this.type=2,this.gt=Hr,this.ct=void 0,this.bt=i,this.At=r,this.dt=n,this.options=h,this.vt=h?.isConnected??!0}get parentNode(){let i=this.bt.parentNode;const r=this.dt;return void 0!==r&&11===i?.nodeType&&(i=r.parentNode),i}get startNode(){return this.bt}get endNode(){return this.At}wt(i,r=this){i=Yr(this,i,r),Ir(i)?i===Hr||null==i||""===i?(this.gt!==Hr&&this.Pt(),this.gt=Hr):i!==this.gt&&i!==Gr&&this.Ct(i):void 0!==i.J?this.$(i):void 0!==i.nodeType?this.T(i):(i=>Tr(i)||"function"==typeof i?.[Symbol.iterator])(i)?this.k(i):this.Ct(i)}S(i){return this.bt.parentNode.insertBefore(i,this.At)}T(i){this.gt!==i&&(this.Pt(),this.gt=this.S(i))}Ct(i){this.gt!==Hr&&Ir(this.gt)?this.bt.nextSibling.data=i:this.T(Ur.createTextNode(i)),this.gt=i}$(i){const{values:r,J:n}=i,h="number"==typeof n?this.St(i):(void 0===n.el&&(n.el=V.createElement(qr(n.h,n.h[0]),this.options)),n);if(this.gt?.ut===h)this.gt.p(r);else{const i=new S(h,this),n=i.u(this.options);i.p(r),this.T(n),this.gt=i}}St(i){let r=Vr.get(i.strings);return void 0===r&&Vr.set(i.strings,r=new V(i)),r}k(i){Tr(this.gt)||(this.gt=[],this.Pt());const r=this.gt;let n,h=0;for(const o of i)h===r.length?r.push(n=new M(this.S(Er()),this.S(Er()),this,this.options)):n=r[h],n.wt(o),h++;h<r.length&&(this.Pt(n&&n.At.nextSibling,h),r.length=h)}Pt(i=this.bt.nextSibling,r){for(this._t?.(!1,!0,r);i&&i!==this.At;){const r=i.nextSibling;i.remove(),i=r}}setConnected(i){void 0===this.dt&&(this.vt=i,this._t?.(i))}}class R{get tagName(){return this.element.tagName}get yt(){return this.dt.yt}constructor(i,r,n,h,o){this.type=1,this.gt=Hr,this.ct=void 0,this.element=i,this.name=r,this.dt=h,this.options=o,n.length>2||""!==n[0]||""!==n[1]?(this.gt=Array(n.length-1).fill(new String),this.strings=n):this.gt=Hr}wt(i,r=this,n,h){const o=this.strings;let a=!1;if(void 0===o)i=Yr(this,i,r,0),a=!Ir(i)||i!==this.gt&&i!==Gr,a&&(this.gt=i);else{const h=i;let l,c;for(i=o[0],l=0;l<o.length-1;l++)c=Yr(this,h[n+l],r,l),c===Gr&&(c=this.gt[l]),a||=!Ir(c)||c!==this.gt[l],c===Hr?i=Hr:i!==Hr&&(i+=(c??"")+o[l+1]),this.gt[l]=c}a&&!h&&this.j(i)}j(i){i===Hr?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,i??"")}}class k extends R{constructor(){super(...arguments),this.type=3}j(i){this.element[this.name]=i===Hr?void 0:i}}class H extends R{constructor(){super(...arguments),this.type=4}j(i){this.element.toggleAttribute(this.name,!!i&&i!==Hr)}}class I extends R{constructor(i,r,n,h,o){super(i,r,n,h,o),this.type=5}wt(i,r=this){if((i=Yr(this,i,r,0)??Hr)===Gr)return;const n=this.gt,h=i===Hr&&n!==Hr||i.capture!==n.capture||i.once!==n.once||i.passive!==n.passive,o=i!==Hr&&(n===Hr||h);h&&this.element.removeEventListener(this.name,this,n),o&&this.element.addEventListener(this.name,this,i),this.gt=i}handleEvent(i){"function"==typeof this.gt?this.gt.call(this.options?.host??this.element,i):this.gt.handleEvent(i)}}class L{constructor(i,r,n){this.element=i,this.type=6,this.ct=void 0,this.dt=r,this.options=n}get yt(){return this.dt.yt}wt(i){Yr(this,i)}}const Jr=_r.litHtmlPolyfillSupport;Jr?.(V,M),(_r.litHtmlVersions??=[]).push("3.1.3");class s extends b{constructor(){super(...arguments),this.renderOptions={host:this},this.xt=void 0}createRenderRoot(){const i=super.createRenderRoot();return this.renderOptions.renderBefore??=i.firstChild,i}update(i){const r=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(i),this.xt=((i,r,n)=>{const h=n?.renderBefore??r;let o=h.Mt;if(void 0===o){const i=n?.renderBefore??null;h.Mt=o=new M(r.insertBefore(Er(),i),i,void 0,n??{})}return o.wt(i),o})(r,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this.xt?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this.xt?.setConnected(!1)}render(){return Gr}}s.kt=!0,s.finalized=!0,globalThis.litElementHydrateSupport?.({LitElement:s});const Xr=globalThis.litElementPolyfillSupport;Xr?.({LitElement:s}),(globalThis.litElementVersions??=[]).push("4.0.5");const tn=i=>(r,n)=>{void 0!==n?n.addInitializer((()=>{customElements.define(i,r)})):customElements.define(i,r)},sn={attribute:!0,type:String,converter:Pr,reflect:!1,hasChanged:Cr},en=(i=sn,r,n)=>{const{kind:h,metadata:o}=n;let a=globalThis.litPropertyMetadata.get(o);if(void 0===a&&globalThis.litPropertyMetadata.set(o,a=new Map),a.set(n.name,i),"accessor"===h){const{name:h}=n;return{set(n){const o=r.get.call(this);r.set.call(this,n),this.requestUpdate(h,o,i)},init(r){return void 0!==r&&this.P(h,void 0,i),r}}}if("setter"===h){const{name:h}=n;return function(n){const o=this[h];r.call(this,n),this.requestUpdate(h,o,i)}}throw Error("Unsupported decorator location: "+h)};function rn(i){return(r,n)=>"object"==typeof n?en(i,r,n):((i,r,n)=>{const h=r.hasOwnProperty(n);return r.constructor.createProperty(n,h?{...i,wrapped:!0}:i),h?Object.getOwnPropertyDescriptor(r,n):void 0})(i,r,n)}function nn(i){return rn({...i,state:!0,attribute:!1})}function hn(i,r){return(r,n,h)=>((i,r,n)=>(n.configurable=!0,n.enumerable=!0,Reflect.decorate&&"object"!=typeof r&&Object.defineProperty(i,r,n),n))(r,n,{get(){return(r=>r.renderRoot?.querySelector(i)??null)(this)}})}const on={" ":"Enter",Enter:"Enter",a:"ArrowLeft",s:"ArrowLeft",ArrowLeft:"ArrowLeft",ArrowDown:"ArrowLeft",d:"ArrowRight",w:"ArrowRight",ArrowRight:"ArrowRight",ArrowUp:"ArrowRight"};i.PlayerComponent=class extends(Ne(s)){static get styles(){return lr`:host{display:inline-block}.Player{display:inline-block;position:relative;font-family:var(--flipnote-player-font-family,sans-serif)}.CanvasArea{position:relative}.CanvasArea:focus{outline:var(--flipnote-player-focus-outline,3px solid #ffd3a6);outline-offset:2px}.PlayerCanvas{position:relative;display:block}.PlayerCanvas canvas{display:block}.Overlay{position:absolute;top:0;left:0;background:#ebf0f3;color:#4b4c53;width:100%;height:100%;display:flex;justify-content:center;align-items:center}.Overlay--error{background:#ff8b8b;color:#ca2a32}@keyframes spin{from{transform:rotateZ(0)}to{transform:rotateZ(360deg)}}.LoaderIcon{animation:spin infinite 1.2s linear}.Controls{background:var(--flipnote-player-controls-background,none)}.MuteIcon{width:28px;height:28px}.Controls__groupLeft,.Controls__groupRight,.Controls__row{display:flex;align-items:center}.Controls__groupLeft{margin-right:auto}.Controls__groupRight{margin-left:auto}.Controls__playButton{height:32px;width:32px;padding:2px}.MuteIcon{width:28px;height:28px}.LoaderIcon{width:40px;height:40px}.Controls.Controls--compact{margin:6px 0}.Controls__frameCounter{min-width:90px;font-variant-numeric:tabular-nums}.Controls__progressBar{flex:1}.Controls--compact .Controls__playButton{margin-right:8px}.Controls--compact .Controls__progressBar{flex:1}.Controls--default .Controls__playButton{margin-right:8px}.Controls--default .Controls__progressBar{margin-top:2px;margin-bottom:2px;display:block}.Controls--default .Controls__volumeBar{width:70px;margin-left:8px}.Button{border:0;padding:0;outline:0;-webkit-appearance:none;display:block;font-family:inherit;font-size:inherit;text-align:center;cursor:pointer;background:var(--flipnote-player-button-background,#ffd3a6);color:var(--flipnote-player-button-color,#f36a2d);border-radius:4px}.Button:focus{outline:3px solid var(--flipnote-player-button-background,#ffd3a6);outline-offset:2px}.Button flipnote-player-icon{display:block}`}get width(){return this.Ft}set width(i){const r=this.Ft;var n;this.Ft=i,this.zt=isNaN(+i)?i:`${i}px`,n=()=>this.updateCanvasSize(),A?x((()=>x((()=>n())))):n(),this.requestUpdate("width",r)}get src(){return this.$t}set src(i){const r=this.$t;this.Ut&&this.player.load(i),this.$t=i,this.requestUpdate("src",r)}get autoplay(){return this.player?.autoplay}set autoplay(i){if(this.player){const r=this.player.autoplay;this.player.autoplay=i,this.requestUpdate("autoplay",r)}}constructor(){super(),this.Ft="auto",this.zt="auto",this.Et=0,this.It="",this.Tt=0,this.Bt=!1,this.Lt=!1,this.Wt=!1,this.Kt=!1,this.Nt=0,this.Ut=!1,this.handleResize=i=>{this.updateCanvasSize()},this.handleKeyInput=i=>{const r=on[i.key];if(r){switch(r){case"Enter":this.togglePlay();break;case"ArrowLeft":i.shiftKey?this.firstFrame():this.prevFrame();break;case"ArrowRight":i.shiftKey?this.lastFrame():this.nextFrame()}i.preventDefault()}},this.handlePlayToggle=i=>{this.focus(),this.togglePlay()},this.handleMuteToggle=i=>{this.focus(),this.toggleMuted()},this.handleProgressSliderChange=i=>{this.focus(),this.seek(i.detail.value)},this.handleProgressSliderInputStart=()=>{this.focus(),this.startSeek()},this.handleProgressSliderInputEnd=()=>{this.focus(),this.endSeek()},this.handleVolumeBarChange=i=>{this.focus(),this.setVolume(i.detail.value)},this.Dt=new ResizeObserver(this.handleResize)}render(){return jr`<style>:host{width:${this.zt}}</style><div class="Player"><div class="CanvasArea" tabIndex="0" role="widget" aria-description="Flipnote animation player. Press the space key to play or pause the animation. Use the left and right arrow keys to navigate frames" @click="${this.handlePlayToggle}" @keydown="${this.handleKeyInput}"><div class="PlayerCanvas" id="canvasWrapper"></div>${this.Bt?jr`<div class="Overlay"><flipnote-player-icon icon="loader" class="LoaderIcon"></flipnote-player-icon></div>`:""} ${this.Lt?jr`<div class="Overlay Overlay--error">Error</div>`:""}</div>${this.renderControls()}</div>`}renderControls(){return"compact"===this.controls?jr`<div class="Controls Controls--compact Controls__row"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this.Wt?"pause":"play"}"></flipnote-player-icon></button><flipnote-player-slider class="Controls__progressBar" value="${this.Et}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></div>`:jr`<div class="Controls Controls--default"><flipnote-player-slider class="Controls__progressBar" value="${this.Et}" label="Playback progress" step="${1/(this.Tt-1)}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></flipnote-player-slider><div class="Controls__row"><div class="Controls__groupLeft"><button class="Button Controls__playButton" tabIndex="0" @click="${this.handlePlayToggle}"><flipnote-player-icon icon="${this.Wt?"pause":"play"}"></flipnote-player-icon></button> <span class="Controls__frameCounter">${this.It}</span></div><div class="Controls__groupRight"><flipnote-player-icon class="MuteIcon" @click="${this.handleMuteToggle}" icon="${this.Kt?"volumeOff":"volumeOn"}"></flipnote-player-icon><flipnote-player-slider class="Controls__volumeBar" value="${this.Nt}" label="Volume" @change="${this.handleVolumeBarChange}"></flipnote-player-slider></div></div></div>`}firstUpdated(r){this.updateSettingsFromProps();const n=new Player(this.playerCanvasWrapper,256,192,this.parserSettings);this.Dt.observe(this),this.player=n,n.on(i.PlayerEvent.LoadStart,(()=>{this.Bt=!0})),n.on(i.PlayerEvent.Load,(()=>{this.updateCanvasSize()})),n.on(i.PlayerEvent.Error,(()=>{this.Bt=!1,this.Lt=!0})),n.on([i.PlayerEvent.Load,i.PlayerEvent.Close,i.PlayerEvent.Progress],(()=>{this.Bt=!1,this.Lt=!1,this.Et=n.getProgress()/100,this.It=n.getFrameCounter(),this.Tt=n.frameCount})),n.on(i.PlayerEvent.Play,(()=>{this.Wt=!0})),n.on(i.PlayerEvent.Pause,(()=>{this.Wt=!1})),n.on([i.PlayerEvent.Load,i.PlayerEvent.VolumeChange],(()=>{this.Nt=n.volume,this.Kt=n.muted})),n.on(i.PlayerEvent.i,((i,r)=>{this.dispatchEvent(new Event(i))})),this.$t&&n.load(this.$t),this.Ut=!0}disconnectedCallback(){this.Dt.disconnect(),this.destroy()}updateSettingsFromProps(){this.parserSettings={dsiLibraryNote:this.dsiLibrary,borderCrop:this.cropBorder,initialBgmPredictor:this.bgmPredictor,initialBgmStepIndex:this.bgmStepIndex,initialSePredictors:this.parseListProp(this?.sePredictors),initialSeStepIndices:this.parseListProp(this?.seStepIndices)}}parseListProp(i){if(i)return i.split(",").map((i=>/^\s*$/.test(i)?void 0:parseInt(i)))}updateCanvasSize(){const i=this.Ut,r=this.player.note;let n=256;"auto"===this.Ft&&i&&this.player.isNoteLoaded?n=r.imageWidth:"auto"!==this.Ft&&(n=this.getBoundingClientRect().width),i&&r&&this.player.resize(n,n*r.aspect)}},c([rn({type:String})],i.PlayerComponent.prototype,"controls",void 0),c([rn({type:Boolean})],i.PlayerComponent.prototype,"dsiLibrary",void 0),c([rn({type:Boolean})],i.PlayerComponent.prototype,"cropBorder",void 0),c([rn({type:Number})],i.PlayerComponent.prototype,"bgmPredictor",void 0),c([rn({type:Number})],i.PlayerComponent.prototype,"bgmStepIndex",void 0),c([rn({type:String})],i.PlayerComponent.prototype,"sePredictors",void 0),c([rn({type:String})],i.PlayerComponent.prototype,"seStepIndices",void 0),c([rn({type:String})],i.PlayerComponent.prototype,"width",null),c([rn({type:String})],i.PlayerComponent.prototype,"src",null),c([rn({type:Boolean})],i.PlayerComponent.prototype,"autoplay",null),c([nn()],i.PlayerComponent.prototype,"_width",void 0),c([nn()],i.PlayerComponent.prototype,"_cssWidth",void 0),c([nn()],i.PlayerComponent.prototype,"_progress",void 0),c([nn()],i.PlayerComponent.prototype,"_counter",void 0),c([nn()],i.PlayerComponent.prototype,"_frameCount",void 0),c([nn()],i.PlayerComponent.prototype,"_isLoading",void 0),c([nn()],i.PlayerComponent.prototype,"_isError",void 0),c([nn()],i.PlayerComponent.prototype,"_isPlaying",void 0),c([nn()],i.PlayerComponent.prototype,"_isMuted",void 0),c([nn()],i.PlayerComponent.prototype,"_volumeLevel",void 0),c([hn("#canvasWrapper")],i.PlayerComponent.prototype,"playerCanvasWrapper",void 0),i.PlayerComponent=c([tn("flipnote-player")],i.PlayerComponent);const an=i=>(...r)=>({et:i,values:r});let ln=class{constructor(i){}get yt(){return this.dt.yt}ht(i,r,n){this.Ot=i,this.dt=r,this.Rt=n}ot(i,r){return this.update(i,r)}update(i,r){return this.render(...r)}};const cn=an(class extends ln{constructor(i){if(super(i),1!==i.type||"class"!==i.name||i.strings?.length>2)throw Error("`classMap()` can only be used in the `class` attribute and must be the only part in the attribute.")}render(i){return" "+Object.keys(i).filter((r=>i[r])).join(" ")+" "}update(i,[r]){if(void 0===this.st){this.st=new Set,void 0!==i.strings&&(this.nt=new Set(i.strings.join(" ").split(/\s/).filter((i=>""!==i))));for(const i in r)r[i]&&!this.nt?.has(i)&&this.st.add(i);return this.render(r)}const n=i.element.classList;for(const i of this.st)i in r||(n.remove(i),this.st.delete(i));for(const i in r){const h=!!r[i];h===this.st.has(i)||this.nt?.has(i)||(h?(n.add(i),this.st.add(i)):(n.remove(i),this.st.delete(i)))}return Gr}}),fn="important",un=" !"+fn,dn=an(class extends ln{constructor(i){if(super(i),1!==i.type||"style"!==i.name||i.strings?.length>2)throw Error("The `styleMap` directive must be used in the `style` attribute and must be the only part in the attribute.")}render(i){return Object.keys(i).reduce(((r,n)=>{const h=i[n];return null==h?r:r+`${n=n.includes("-")?n:n.replace(/(?:^(webkit|moz|ms|o)|)(?=[A-Z])/g,"-$&").toLowerCase()}:${h};`}),"")}update(i,[r]){const{style:n}=i.element;if(void 0===this.ft)return this.ft=new Set(Object.keys(r)),this.render(r);for(const i of this.ft)null==r[i]&&(this.ft.delete(i),i.includes("-")?n.removeProperty(i):n[i]=null);for(const i in r){const h=r[i];if(null!=h){this.ft.add(i);const r="string"==typeof h&&h.endsWith(un);i.includes("-")||r?n.setProperty(i,r?h.slice(0,-11):h,r?fn:""):n[i]=h}}return Gr}});let pn=class extends s{constructor(){super(...arguments),this.value=0,this.step=.1,this.label="",this.orientation="horizontal",this.isActive=!1,this.onSliderMouseStart=i=>{i.preventDefault(),this.isActive=!0,document.addEventListener("mousemove",this.onSliderMouseMove),document.addEventListener("mouseup",this.onSliderMouseEnd),this.dispatch("inputstart"),this.onSliderInput(i.clientX,i.clientY)},this.onSliderMouseEnd=i=>{i.preventDefault(),document.removeEventListener("mousemove",this.onSliderMouseMove),document.removeEventListener("mouseup",this.onSliderMouseEnd),this.dispatch("inputend"),this.onSliderInput(i.clientX,i.clientY),this.isActive=!1},this.onSliderMouseMove=i=>{i.preventDefault(),this.onSliderInput(i.clientX,i.clientY)},this.onSliderTouchStart=i=>{const r=i.changedTouches[0];i.preventDefault(),this.isActive=!0,document.addEventListener("touchmove",this.onSliderTouchMove),document.addEventListener("touchend",this.onSliderTouchEnd),this.dispatch("inputstart"),this.onSliderInput(r.clientX,r.clientY)},this.onSliderTouchEnd=i=>{const r=i.changedTouches[0];i.preventDefault(),document.removeEventListener("touchmove",this.onSliderTouchMove),document.removeEventListener("touchend",this.onSliderTouchEnd),this.dispatch("inputend"),this.onSliderInput(r.clientX,r.clientY),this.isActive=!1},this.onSliderTouchMove=i=>{const r=i.changedTouches[0];i.preventDefault(),this.onSliderInput(r.clientX,r.clientY)},this.onSliderInput=(i,r)=>{const n=this.sliderElement.getBoundingClientRect();let h;if("horizontal"===this.orientation){const r=n.height/2,o=n.width-2*r,a=(i-n.left-r)/o;h=Math.max(0,Math.min(a,1))}else if("vertical"===this.orientation){const i=n.width/2,o=n.height-2*i,a=1-(r-n.top-i)/o;h=Math.max(0,Math.min(a,1))}this.updateValue(h)},this.onKeyInput=i=>{const r=on[i.key];if(r){switch(this.dispatch("inputstart"),r){case"ArrowLeft":i.shiftKey?this.updateValue(0):this.updateValue(this.value-this.step);break;case"ArrowRight":i.shiftKey?this.updateValue(1):this.updateValue(this.value+this.step)}this.dispatch("inputend"),i.preventDefault()}},this.updateValue=i=>{i=p(i,0,1),this.value!==i&&(this.value=i,this.dispatch("change",{value:i}))}}static get styles(){return lr`.Slider{touch-action:none;padding:4px 0;cursor:pointer}.Slider:focus{position:relative;z-index:1;outline:var(--flipnote-player-focus-outline,3px solid #ffd3a6);outline-offset:2px}.Slider--vertical{height:100px;width:14px}.Slider__track{position:relative;border-radius:3px;background:var(--flipnote-player-slider-track,#ffd3a6)}.Slider--horizontal .Slider__track{height:4px;margin:6px 0}.Slider--vertical .Slider__track{width:4px;height:100%;margin:0 6px}.Slider__levelWrapper{position:absolute;left:0;right:0;height:6px;margin:-1px}.Slider__level{position:absolute;width:100%;left:0;height:8px;border-radius:8px;background:var(--flipnote-player-slider-level,#f36a2d)}.Slider--horizontal .Slider__level{width:100%;height:6px}.Slider--vertical .Slider__level{width:6px;height:100%;bottom:0}.Slider__handle{display:none;position:absolute;height:10px;width:10px;border-radius:5px;box-sizing:border-box;border:3px solid var(--flipnote-player-slider-handle,#f36a2d);background:var(--flipnote-player-slider-handle-fill,#fff)}.Slider--isActive .Slider__handle,.Slider:hover .Slider__handle{display:block}.Slider--horizontal .Slider__handle{top:0;margin-top:-3px;margin-left:-6px}.Slider--vertical .Slider__handle{left:0;margin-bottom:-6px;margin-left:-3px}`}render(){const i=100*this.value+"%",r="horizontal"===this.orientation?"width":"height",n="horizontal"===this.orientation?"left":"bottom",h={Slider:!0,"Slider--horizontal":"horizontal"===this.orientation,"Slider--vertical":"vertical"===this.orientation,"Slider--isActive":this.isActive};return jr`<div class="${cn(h)}" tabIndex="0" role="slider" aria-label="${this.label}" aria-valuemin="0" aria-valuemax="1" aria-valuenow="${this.value}" @touchstart="${this.onSliderTouchStart}" @mousedown="${this.onSliderMouseStart}" @keydown="${this.onKeyInput}"><div class="Slider__track"><div class="Slider__levelWrapper"><div class="Slider__level" style="${dn({[r]:i})}"></div></div><div class="Slider__handle" style="${dn({[n]:i})}"></div></div></div>`}dispatch(i,r){const n=new CustomEvent(i,{detail:r});this.dispatchEvent(n)}};c([rn({type:Number})],pn.prototype,"value",void 0),c([rn({type:Number})],pn.prototype,"step",void 0),c([rn({type:String})],pn.prototype,"label",void 0),c([rn({type:String})],pn.prototype,"orientation",void 0),c([nn()],pn.prototype,"isActive",void 0),c([hn(".Slider__track")],pn.prototype,"sliderElement",void 0),pn=c([tn("flipnote-player-slider")],pn);class e extends ln{constructor(i){if(super(i),this.it=Hr,2!==i.type)throw Error(this.constructor.directiveName+"() can only be used in child bindings")}render(i){if(i===Hr||null==i)return this.jt=void 0,this.it=i;if(i===Gr)return i;if("string"!=typeof i)throw Error(this.constructor.directiveName+"() called with a non-string value");if(i===this.it)return this.jt;this.it=i;const r=[i];return r.raw=r,this.jt={J:this.constructor.resultType,strings:r,values:[]}}}e.directiveName="unsafeHTML",e.resultType=1;class t extends e{}t.directiveName="unsafeSVG",t.resultType=2;const mn=an(t),yn=i=>i.replace(/<svg ([^>]*)>/,((i,r)=>`<svg ${r} class="Icon" style="fill:currentColor">`)),wn={play:yn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M74.1374132,48 L83.1218112,48 C83.8751514,48 84.6131784,48.2127391 85.2509322,48.6137272 L177.244774,106.454909 C184.725521,111.158433 186.976905,121.035737 182.273381,128.516484 C180.99563,130.548691 179.27698,132.26734 177.244774,133.545091 L85.2509322,191.386273 C84.6131784,191.787261 83.8751514,192 83.1218112,192 L74.1374132,192 C68.5386745,192 64,187.461326 64,181.862587 L64,58.1374132 C64,52.5386745 68.5386745,48 74.1374132,48 Z"/></svg>'),pause:yn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M64,48 L88,48 C96.836556,48 104,55.163444 104,64 L104,176 C104,184.836556 96.836556,192 88,192 L64,192 C55.163444,192 48,184.836556 48,176 L48,64 C48,55.163444 55.163444,48 64,48 Z M152,48 L176,48 C184.836556,48 192,55.163444 192,64 L192,176 C192,184.836556 184.836556,192 176,192 L152,192 C143.163444,192 136,184.836556 136,176 L136,64 C136,55.163444 143.163444,48 152,48 Z"/></svg>'),loader:yn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M120,176 C128.836556,176 136,183.163444 136,192 C136,200.836556 128.836556,208 120,208 C111.163444,208 104,200.836556 104,192 C104,183.163444 111.163444,176 120,176 Z M168.497423,148 C172.915701,140.347318 182.701147,137.725316 190.353829,142.143594 C198.006511,146.561872 200.628514,156.347318 196.210236,164 C191.791958,171.652682 182.006511,174.274684 174.353829,169.856406 C166.701147,165.438128 164.079145,155.652682 168.497423,148 Z M49.6461709,142.143594 C57.2988529,137.725316 67.0842994,140.347318 71.5025774,148 C75.9208554,155.652682 73.2988529,165.438128 65.6461709,169.856406 C57.993489,174.274684 48.2080425,171.652682 43.7897645,164 C39.3714865,156.347318 41.993489,146.561872 49.6461709,142.143594 Z M174.353829,70.1435935 C182.006511,65.7253155 191.791958,68.347318 196.210236,76 C200.628514,83.652682 198.006511,93.4381285 190.353829,97.8564065 C182.701147,102.274684 172.915701,99.652682 168.497423,92 C164.079145,84.347318 166.701147,74.5618715 174.353829,70.1435935 Z M43.7897645,76 C48.2080425,68.347318 57.993489,65.7253155 65.6461709,70.1435935 C73.2988529,74.5618715 75.9208554,84.347318 71.5025774,92 C67.0842994,99.652682 57.2988529,102.274684 49.6461709,97.8564065 C41.993489,93.4381285 39.3714865,83.652682 43.7897645,76 Z M120,32 C128.836556,32 136,39.163444 136,48 C136,56.836556 128.836556,64 120,64 C111.163444,64 104,56.836556 104,48 C104,39.163444 111.163444,32 120,32 Z"/></svg>'),volumeOn:yn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M113.3,42.0221751 C116.173884,39.8502203 119.99384,39.3918256 123.3,40.8221751 C126.772838,42.476202 128.989111,45.9755807 129,49.8221751 L129,49.8221751 L129,189.822175 C128.989111,193.66877 126.772838,197.168148 123.3,198.822175 C121.970477,199.503408 120.493687,199.846847 119,199.823416 C116.744358,199.809091 114.559393,199.033781 112.8,197.622175 L112.8,197.622175 L65.5,159.822175 L29,159.822175 C23.4771525,159.822175 19,155.345023 19,149.822175 L19,149.822175 L19,89.8221751 C19,84.2993276 23.4771525,79.8221751 29,79.8221751 L29,79.8221751 L65.5,79.8221751 Z M196.286415,59.3197538 C213.294099,75.5543608 222.000706,95.3421052 222.000706,118.00002 C222.000706,140.370063 213.535918,161.147272 197.009268,179.927555 C192.631012,184.902847 185.048463,185.386839 180.073171,181.008583 C175.09788,176.630326 174.613887,169.047777 178.992144,164.072486 C191.798828,149.519435 198.000706,134.296644 198.000706,118.00002 C198.000706,101.991269 192.040647,88.4456799 179.714997,76.6802869 C174.921018,72.1042162 174.744369,64.5082902 179.32044,59.7143114 C183.89651,54.9203325 191.492436,54.7436831 196.286415,59.3197538 Z M165.200706,87.4000203 C176.105233,95.5784156 182.000706,106.386783 182.000706,119.00002 C182.000706,131.432529 176.288715,142.380513 165.682919,151.218676 C160.591596,155.461445 153.02482,154.773556 148.782051,149.682233 C144.608835,144.674375 145.205942,137.27156 150.071653,132.99268 L150.318493,132.781365 C155.712698,128.286195 158.000706,123.900845 158.000706,119.00002 C158.000706,114.387199 155.990753,110.597447 151.143501,106.860651 L150.800706,106.60002 C145.498773,102.62357 144.424256,95.1019539 148.400706,89.8000203 C152.377156,84.4980867 159.898773,83.4235701 165.200706,87.4000203 Z"/></svg>'),volumeOff:yn('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M123.3,40.8221751 C119.99384,39.3918256 116.173884,39.8502203 113.3,42.0221751 L65.5,79.8221751 L29,79.8221751 C23.4771525,79.8221751 19,84.2993276 19,89.8221751 L19,149.822175 C19,155.345023 23.4771525,159.822175 29,159.822175 L65.5,159.822175 L112.8,197.622175 C114.559393,199.033781 116.744358,199.809091 119,199.823416 C120.493687,199.846847 121.970477,199.503408 123.3,198.822175 C126.772838,197.168148 128.989111,193.66877 129,189.822175 L129,49.8221751 C128.989111,45.9755807 126.772838,42.476202 123.3,40.8221751 Z M193.751433,91.2843093 C198.453467,86.8297289 205.877095,86.906532 210.485281,91.5147186 C215.093468,96.1229053 215.170271,103.546533 210.715691,108.248567 L210.485281,108.485281 L198.971,120 L210.485281,131.514719 C215.171573,136.20101 215.171573,143.79899 210.485281,148.485281 C205.877095,153.093468 198.453467,153.170271 193.751433,148.715691 L193.514719,148.485281 L182,136.971 L170.485281,148.485281 L170.248567,148.715691 C165.546533,153.170271 158.122905,153.093468 153.514719,148.485281 C148.906532,143.877095 148.829729,136.453467 153.284309,131.751433 L153.514719,131.514719 L165.029,120 L153.514719,108.485281 C148.828427,103.79899 148.828427,96.2010101 153.514719,91.5147186 C158.122905,86.906532 165.546533,86.8297289 170.248567,91.2843093 L170.485281,91.5147186 L182,103.029 L193.514719,91.5147186 L193.751433,91.2843093 Z"/></svg>')};let vn=class extends s{constructor(){super(...arguments),this.icon="loader"}static get styles(){return lr`.Icon{width:100%;height:100%;color:var(--flipnote-player-icon-color,#f36a2d)}`}render(){return jr`${mn(wn[this.icon])}`}};var gn,bn,An,Pn,Cn,Sn;c([rn({type:String})],vn.prototype,"icon",void 0),vn=c([tn("flipnote-player-icon")],vn),i.ImageComponent=class extends s{constructor(){super(...arguments),gn.add(this),bn.set(this,""),An.set(this,"0"),this.cropped=!1,this.Gt="",this.Ht=""}static get styles(){return lr`.Image{width:inherit;height:inherit;image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges;-ms-interpolation-mode:nearest-neighbor}`}set src(i){this.load(i)}get src(){return f(this,bn,"f")}set frame(i){u(this,An,i,"f"),this.note&&this.loadNote(this.note)}get frame(){return f(this,An,"f")}render(){return jr`<img class="Image" src="${this.Gt}" alt="${this.Ht}" title="${this.Ht}">`}loadNote(i){this.note=i,f(this,gn,"m",Pn).call(this);const r=f(this,An,"f");if("all"===r)this.gif=GifImage.fromFlipnote(i),this.Gt=this.gif.getUrl();else if("thumb"===r)this.gif=GifImage.fromFlipnoteFrame(i,i.thumbFrameIndex),this.Gt=this.gif.getUrl();else if(!isNaN(+r)){const n=parseInt(r);this.gif=GifImage.fromFlipnoteFrame(i,n),this.Gt=this.gif.getUrl()}this.Gt?(f(this,gn,"m",Cn).call(this),this.Ht=i.getTitle()):f(this,gn,"m",Sn).call(this,"Invalid frame attribute")}load(i){u(this,bn,i,"f"),this.note=void 0;const r="true"===this.getAttribute("cropped");Ci(i,{borderCrop:r}).then((i=>this.loadNote(i))).catch((i=>f(this,gn,"m",Sn).call(this,i)))}disconnectedCallback(){f(this,gn,"m",Pn).call(this)}},bn=new WeakMap,An=new WeakMap,gn=new WeakSet,Pn=function(){this.gif&&this.gif.dataUrl&&(this.gif.revokeUrl(),this.Gt="")},Cn=function(){this.dispatchEvent(new Event("load"))},Sn=function(i){throw this.dispatchEvent(new ErrorEvent("error",{error:i})),new Error(i)},c([rn()],i.ImageComponent.prototype,"src",null),c([rn()],i.ImageComponent.prototype,"frame",null),c([rn({type:Boolean})],i.ImageComponent.prototype,"cropped",void 0),c([nn()],i.ImageComponent.prototype,"_gifUrl",void 0),c([nn()],i.ImageComponent.prototype,"_imgTitle",void 0),i.ImageComponent=c([tn("flipnote-image")],i.ImageComponent),i.CanvasInterface=class{constructor(i,r,n,h){}},i.GifImage=GifImage,i.Html5Canvas=Html5Canvas,i.KwzParser=KwzParser,i.Player=Player,i.PlayerMixin=Ne,i.PpmParser=PpmParser,i.UniversalCanvas=UniversalCanvas,i.WavAudio=WavAudio,i.WebAudioPlayer=WebAudioPlayer,i.WebglCanvas=WebglCanvas,i.filename=fi,i.id=hi,i.loaders=Ai,i.parse=Ci,i.parseSource=Si,i.playlist=Pi,i.supportedEvents=xi,i.version="6.0.1"}({});
//# sourceMappingURL=flipnote.webcomponent.min.js.map
