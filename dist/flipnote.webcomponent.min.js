/*!!
flipnote.js v5.5.1 (webcomponent build)
https://flipnote.js.org
A JavaScript library for parsing, converting, and in-browser playback of the proprietary animation formats used by Nintendo's Flipnote Studio and Flipnote Studio 3D apps.
2018 - 2021 James Daniel
Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
Keep on Flipnoting!
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).flipnote={})}(this,(function(t){"use strict";class e{constructor(){this.pageSize=e.pageSize,this.currPageIndex=-1,this.pages=[],this.pointer=0,this.newPage()}newPage(){this.pages[++this.currPageIndex]=new Uint8Array(this.pageSize),this.currPage=this.pages[this.currPageIndex],this.pointer=0}getData(){const t=new Uint8Array(this.currPageIndex*this.pageSize+this.pointer);for(let e=0;e<this.pages.length;e++){const i=this.pages[e];e===this.currPageIndex?t.set(i.slice(0,this.pointer),e*this.pageSize):t.set(i,e*this.pageSize)}return t}getBuffer(){return this.getData().buffer}writeByte(t){this.pointer>=this.pageSize&&this.newPage(),this.currPage[this.pointer++]=t}writeBytes(t,e,i){for(let r=i||t.length,s=e||0;s<r;s++)this.writeByte(t[s])}}e.pageSize=2048;class i{constructor(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}get bytes(){return new Uint8Array(this.buffer)}get byteLength(){return this.data.byteLength}seek(t,e){switch(e){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;case 0:default:this.pointer=t}}readUint8(){const t=this.data.getUint8(this.pointer);return this.pointer+=1,t}writeUint8(t){this.data.setUint8(this.pointer,t),this.pointer+=1}readInt8(){const t=this.data.getInt8(this.pointer);return this.pointer+=1,t}writeInt8(t){this.data.setInt8(this.pointer,t),this.pointer+=1}readUint16(t=!0){const e=this.data.getUint16(this.pointer,t);return this.pointer+=2,e}writeUint16(t,e=!0){this.data.setUint16(this.pointer,t,e),this.pointer+=2}readInt16(t=!0){const e=this.data.getInt16(this.pointer,t);return this.pointer+=2,e}writeInt16(t,e=!0){this.data.setInt16(this.pointer,t,e),this.pointer+=2}readUint32(t=!0){const e=this.data.getUint32(this.pointer,t);return this.pointer+=4,e}writeUint32(t,e=!0){this.data.setUint32(this.pointer,t,e),this.pointer+=4}readInt32(t=!0){const e=this.data.getInt32(this.pointer,t);return this.pointer+=4,e}writeInt32(t,e=!0){this.data.setInt32(this.pointer,t,e),this.pointer+=4}readBytes(t){const e=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=e.byteLength,e}writeBytes(t){t.forEach(t=>this.writeUint8(t))}readHex(t,e=!1){const i=this.readBytes(t);let r=[];for(let t=0;t<i.length;t++)r.push(i[t].toString(16).padStart(2,"0"));return e&&r.reverse(),r.join("").toUpperCase()}readChars(t){const e=this.readBytes(t);let i="";for(let t=0;t<e.length;t++){const r=e[t];if(0===r)break;i+=String.fromCharCode(r)}return i}writeChars(t){for(let e=0;e<t.length;e++){const i=t.charCodeAt(e);this.writeUint8(i)}}readWideChars(t){const e=new Uint16Array(this.data.buffer,this.pointer,t);let i="";for(let t=0;t<e.length;t++){const r=e[t];if(0==r)break;i+=String.fromCharCode(r)}return this.pointer+=e.byteLength,i}}const r=new Int8Array([-1,2,-1,2]),s=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),n=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function a(t,e,i){return t<e?e:t>i?i:t}function o(t,e,i){return i<0||i>=e?0:t[i]}function h(t){const e=t.length;let i=0;for(let r=0;r<e;r++){const e=t[r];(e<=-32768||e>=32767)&&(i+=1)}return i/e}function l(t){const e=t.length;let i=0;for(let r=0;r<e;r++)i+=Math.pow(t[r],2);return Math.sqrt(i/e)}function u(t,e="Assert failed"){if(!t)throw console.trace(e),new Error(e)}function d(t,e,i,r=""){u(t>=e&&t<=i,`Value ${r} should be between ${e} and ${i}`)}const c="undefined"!=typeof window&&void 0!==window.document;function p(){return u(c,"This feature is only available in browser environments")}const f="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;function m(){return u(f,"This feature is only available in NodeJS environments")}const g="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,y=c&&(window.requestAnimationFrame||window.webkitRequestAnimationFrame);const v=c||g?crypto.subtle:f?require("crypto").webcrypto.subtle:void 0;async function b(t,e){const i=t.split("\n").filter(t=>!t.startsWith("-----")&&!t.endsWith("-----")).join(""),r=atob(i),s=new Uint8Array(r.length).map((t,e)=>r.charCodeAt(e));return await v.importKey("spki",s.buffer,{name:"RSASSA-PKCS1-v1_5",hash:e},!1,["verify"])}async function w(t,e,i){return await v.verify("RSASSA-PKCS1-v1_5",t,e,i)}function _(t){return new Date(1e3*(t+946684800))}function S(t,e){return 100*t*(1/e)/100}var A;(A=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",A.USA="USA",A.JPN="JPN",A.UNKNOWN="UNKNOWN";const P=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,x=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,E=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/;function C(t){return"14E494E35A443235"===t||P.test(t)}function T(t){return x.test(t)}function F(t){return t.endsWith("3532445AE394E414")||E.test(t)}function U(e){switch(e.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function k(e){if(F(e))switch(e.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}switch(e.slice(0,2)){case"00":return t.FlipnoteRegion.JPN;case"02":return t.FlipnoteRegion.USA;case"04":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}var B=Object.freeze({__proto__:null,get FlipnoteRegion(){return t.FlipnoteRegion},isPpmFsid:C,isKwzFsid:T,isKwzDsiLibraryFsid:F,isFsid:function(t){return C(t)||T(t)},getPpmFsidRegion:U,getKwzFsidRegion:k,getFsidRegion:function(e){return C(e)?U(e):T(e)?k(e):t.FlipnoteRegion.UNKNOWN}});!function(){if(!c)return function(){};var t=document.createElement("a")}();var L,N;(L=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",L.KWZ="KWZ",(N=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[N.BGM=0]="BGM",N[N.SE1=1]="SE1",N[N.SE2=2]="SE2",N[N.SE3=3]="SE3",N[N.SE4=4]="SE4";class M extends i{constructor(){super(...arguments),this.layerVisibility={1:!0,2:!0,3:!0},this.isFolderIcon=!1,this.isComment=!1,this.isDsiLibraryNote=!1}getLayerPixels(t,e,i=new Uint8Array(this.imageWidth*this.imageHeight)){const r=this.getFramePaletteIndices(t),s=e*this.numLayerColors,n=this.decodeFrame(t)[e],a=this.srcWidth,o=this.imageWidth,h=this.imageHeight,l=this.imageOffsetX,u=this.imageOffsetY;if(i.fill(0),!this.layerVisibility[e+1])return i;for(let t=u,e=0;e<h;t++,e++)for(let h=l,u=0;u<o;h++,u++){const l=e*o+u;let d=n[t*a+h];0!==d&&(i[l]=r[s+d])}return i}getLayerPixelsRgba(t,e,i=new Uint32Array(this.imageWidth*this.imageHeight),r=new Uint32Array(16)){this.getFramePaletteUint32(t,r);const s=e*this.numLayerColors,n=this.decodeFrame(t)[e],a=this.srcWidth,o=this.imageWidth,h=this.imageHeight,l=this.imageOffsetX,u=this.imageOffsetY;if(i.fill(r[0]),!this.layerVisibility[e+1])return i;for(let t=u,e=0;e<h;t++,e++)for(let h=l,u=0;u<o;h++,u++){const l=e*o+u;let d=n[t*a+h];0!==d&&(i[l]=r[s+d])}return i}getFramePixels(t,e=new Uint8Array(this.imageWidth*this.imageHeight)){const i=this.srcWidth,r=this.imageWidth,s=this.imageHeight,n=this.imageOffsetX,a=this.imageOffsetY,o=this.getFramePaletteIndices(t);e.fill(o[0]);const h=this.getFrameLayerOrder(t),l=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const u=h[t],d=l[u],c=u*this.numLayerColors;if(this.layerVisibility[u+1])for(let t=a,h=0;h<s;t++,h++)for(let s=n,a=0;a<r;s++,a++){const n=h*r+a;let l=d[t*i+s];0!==l&&(e[n]=o[c+l])}}return e}getFramePixelsRgba(t,e=new Uint32Array(this.imageWidth*this.imageHeight),i=new Uint32Array(16)){const r=this.srcWidth,s=this.imageWidth,n=this.imageHeight,a=this.imageOffsetX,o=this.imageOffsetY;this.getFramePaletteUint32(t,i),e.fill(i[0]);const h=this.getFrameLayerOrder(t),l=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const u=h[t],d=l[u],c=u*this.numLayerColors;if(this.layerVisibility[u+1])for(let t=o,h=0;h<n;t++,h++)for(let n=a,o=0;o<s;n++,o++){const a=h*s+o;let l=d[t*r+n];0!==l&&(e[a]=i[c+l])}}return e}getFramePaletteUint32(t,e=new Uint32Array(16)){const i=this.getFramePalette(t);return e.fill(0),i.forEach(([t,i,r,s],n)=>e[n]=s<<24|r<<16|i<<8|t),e}hasAudioTrack(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0}}const I=[.5,.5,1,2,4,6,12,20,30],R={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]};class z extends M{constructor(e,i={}){super(e),this.format=t.FlipnoteFormat.PPM,this.imageWidth=z.width,this.imageHeight=z.height,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=z.numLayers,this.numLayerColors=z.numLayerColors,this.srcWidth=z.width,this.rawSampleRate=z.rawSampleRate,this.sampleRate=z.sampleRate,this.globalPalette=z.globalPalette,this.prevDecodedFrame=null,this.decodeHeader(),this.decodeAnimationHeader(),this.decodeSoundHeader(),0!=(this.version>>4&15)&&this.decodeMeta(),this.layerBuffers=[new Uint8Array(z.width*z.height),new Uint8Array(z.width*z.height)],this.prevLayerBuffers=[new Uint8Array(z.width*z.height),new Uint8Array(z.width*z.height)],this.lineEncodingBuffers=[new Uint8Array(z.height),new Uint8Array(z.height)],this.prevDecodedFrame=null}decodeHeader(){u(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16();let t=1696+this.frameDataLength+this.frameCount;t%4!=0&&(t+=4-t%4),u(t<this.byteLength),this.soundDataOffset=t}readFilename(){return`${this.readHex(3)}_${this.readChars(13)}_${this.readUint16().toString().padStart(3,"0")}`}decodeMeta(){u(1704<this.byteLength),this.seek(16);const t=this.readUint16(),e=this.readInt16(),i=this.readWideChars(11),r=this.readWideChars(11),s=this.readWideChars(11),n=this.readHex(8,!0),a=this.readHex(8,!0),o=this.readFilename(),h=this.readFilename(),l=this.readHex(8,!0);this.seek(154);const d=_(this.readInt32());this.seek(1702);const c=this.readUint16();this.thumbFrameIndex=e,this.layerVisibility={1:0==(16&c),2:0==(32&c),3:!1},this.isSpinoff=a!==n||a!==l,this.meta={lock:1===t,loop:1==(c>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:e,timestamp:d,root:{username:i,fsid:l,region:U(l),filename:null},parent:{username:r,fsid:n,region:U(n),filename:o},current:{username:s,fsid:a,region:U(a),filename:h}}}decodeAnimationHeader(){this.seek(1696);const t=this.readUint16(),e=t/4;u(e<=this.frameCount),this.seek(1704);const i=new Uint32Array(e);for(let r=0;r<e;r++){const e=1704+t+this.readUint32();u(e<this.byteLength,`Frame ${r} pointer is out of bounds`),i[r]=e}this.frameOffsets=i}decodeSoundHeader(){let e=this.soundDataOffset;this.seek(e);const i=this.readUint32(),r=this.readUint32(),s=this.readUint32(),n=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),u(this.frameSpeed<=8&&this.bgmSpeed<=8),e+=32,this.framerate=I[this.frameSpeed],this.duration=S(this.frameCount,this.framerate),this.bgmrate=I[this.bgmSpeed];const a=new Map;a.set(t.FlipnoteAudioTrack.BGM,{ptr:e,length:i}),a.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=i,length:r}),a.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=r,length:s}),a.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=s,length:n}),this.soundMeta=a}isNewFrame(t){this.seek(this.frameOffsets[t]);return this.readUint8()>>7&1}decodeFrame(t){if(u(t>-1&&t<this.frameCount,`Frame index ${t} out of bounds`),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);const e=this.readUint8(),i=e>>7&1,r=e>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);let s=0,n=0;r&&(s=this.readInt8(),n=this.readInt8());for(let t=0;t<2;t++){const e=this.lineEncodingBuffers[t];e.fill(0);for(let t=0;t<e.length;){let i=this.readUint8();0!==i?(e[t++]=3&i,e[t++]=i>>2&3,e[t++]=i>>4&3,e[t++]=i>>6&3):t+=4}}for(let t=0;t<2;t++){const e=this.layerBuffers[t],i=this.lineEncodingBuffers[t];for(let t=0;t<z.height;t++){let r=t*z.width;switch(i[t]){case 0:break;case 1:for(var a=this.readUint32(!1);0!==a;a<<=1,r+=8)if(2147483648&a){let t=this.readUint8();for(let i=0;0!==t;i++,t>>=1)e[r+i]=1&t}break;case 2:e.fill(1,r,r+z.width);for(a=this.readUint32(!1);0!==a;a<<=1,r+=8)if(2147483648&a){let t=this.readUint8();for(let i=0;i<8;i++,t>>=1)e[r+i]=1&t}break;case 3:for(let t=0,i=0;i<z.width;i++)i%8==0&&(t=this.readUint8()),e[r++]=1&t,t>>=1}}}const o=this.layerBuffers[0],h=this.layerBuffers[1],l=this.prevLayerBuffers[0],d=this.prevLayerBuffers[1];if(!i){let t,e;for(let i=0;i<z.height;i++)if(!(i-n<0)){if(i-n>=z.height)break;for(let r=0;r<z.width;r++)if(!(r-s<0)){if(r-s>=z.width)break;t=r+i*z.width,e=t-(s+n*z.width),o[t]^=l[e],h[t]^=d[e]}}}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers}getFrameLayerOrder(t){return[1,0]}getFramePaletteIndices(t){this.seek(this.frameOffsets[t]);const e=this.readUint8(),i=1!=(1&e),r=[i?0:1,i?0:1,2,3];return[i?1:0,r[e>>1&3],r[e>>3&3]]}getFramePalette(t){return this.getFramePaletteIndices(t).map(t=>this.globalPalette[t])}decodeSoundFlags(){u(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);const t=this.frameCount,e=this.readBytes(t),i=new Array(t);for(let r=0;r<t;r++){const t=e[r];i[r]=[0!=(1&t),0!=(2&t),0!=(4&t)]}return i}getAudioTrackRaw(t){const e=this.soundMeta.get(t);return u(e.ptr+e.length<this.byteLength),this.seek(e.ptr),this.readBytes(e.length)}decodeAudioTrack(t){const e=this.getAudioTrackRaw(t),i=e.length,r=new Int16Array(2*i);let o=0,h=0,l=0,u=0,d=0,c=!0;for(;o<i;){l=c?15&e[o]:e[o++]>>4,c=!c;const t=n[u];let i=t>>3;1&l&&(i+=t>>2),2&l&&(i+=t>>1),4&l&&(i+=t),8&l&&(i=-i),d+=i,d=a(d,-32768,32767),u+=s[l],u=a(u,0,88),r[h++]=d}return r}getAudioTrackPcm(e,i=this.sampleRate){const r=this.decodeAudioTrack(e);let s=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);s=this.rawSampleRate*t}return s!==i?function(t,e,i){const r=t.length,s=r/e*i,n=new Int16Array(s),a=e/i;for(let e=0;e<s;e++)n[e]=o(t,r,Math.floor(e*a));return n}(r,s,i):r}pcmAudioMix(t,e,i=0){const r=t.length,s=e.length;for(let n=0;n<r&&!(i+n>s);n++){const r=e[i+n]+t[n]/2;e[i+n]=a(r,-32768,32767)}}getAudioMasterPcm(e=this.sampleRate){const i=Math.ceil(this.duration*e),r=new Int16Array(i),s=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(s){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(i,r,0)}if(n||a||o){const i=e/this.framerate,s=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,h=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,l=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,u=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const e=Math.ceil(t*i),d=u[t];n&&d[0]&&this.pcmAudioMix(s,r,e),a&&d[1]&&this.pcmAudioMix(h,r,e),o&&d[2]&&this.pcmAudioMix(l,r,e)}}return this.audioClipRatio=h(r),r}getBody(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(0,t)}getSignature(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(t,t+128)}async verify(){const t=await b("-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCPLwTL6oSflv+gjywi/sM0TUB\n90xqOvuCpjduETjPoN2FwMebxNjdKIqHUyDu4AvrQ6BDJc6gKUbZ1E27BGZoCPH4\n9zQRb+zAM6M9EjHwQ6BABr0u2TcF7xGg2uQ9MBWz9AfbVQ91NjfrNWo0f7UPmffv\n1VvixmTk1BCtavZxBwIDAQAB\n-----END PUBLIC KEY-----","SHA-1");return await w(t,this.getSignature(),this.getBody())}}z.defaultSettings={},z.format=t.FlipnoteFormat.PPM,z.width=256,z.height=192,z.numLayers=2,z.numLayerColors=1,z.rawSampleRate=8192,z.sampleRate=32768,z.globalPalette=[R.WHITE,R.BLACK,R.RED,R.BLUE];const O=[.2,.5,1,2,4,6,8,12,20,24,30],D={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},V=new Uint16Array(16);for(let t=0;t<16;t++)V[t]=(1<<t)-1;const W=new Uint8Array(52488),H=new Uint8Array(52488);var $=0;for(let t=0;t<3;t++)for(let e=0;e<3;e++)for(let i=0;i<3;i++)for(let r=0;r<3;r++)for(let s=0;s<3;s++)for(let n=0;n<3;n++)for(let a=0;a<3;a++)for(let o=0;o<3;o++)W.set([e,t,r,i,n,s,o,a],$),H.set([t,r,i,n,s,o,a,e],$),$+=8;const j=new Uint8Array(256),q=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((t,e)=>{const i=8*t,r=W.subarray(i,i+8),s=H.subarray(i,i+8);j.set(r,8*e),q.set(s,8*e)});class K extends M{constructor(e,i={}){super(e),this.format=t.FlipnoteFormat.KWZ,this.imageWidth=K.width,this.imageHeight=K.height,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=K.numLayers,this.numLayerColors=K.numLayerColors,this.srcWidth=K.width,this.rawSampleRate=K.rawSampleRate,this.sampleRate=K.sampleRate,this.globalPalette=K.globalPalette,this.prevDecodedFrame=null,this.bitIndex=0,this.bitValue=0,this.settings=Object.assign(Object.assign({},K.defaultSettings),i),this.buildSectionMap(),this.layerBuffers=[new Uint8Array(K.width*K.height),new Uint8Array(K.width*K.height),new Uint8Array(K.width*K.height)],this.sectionMap.has("KIC")?(this.isFolderIcon=!0,this.imageWidth=24,this.imageHeight=24,this.frameCount=1,this.frameSpeed=0,this.framerate=O[0],this.thumbFrameIndex=0,this.getFrameOffsets()):this.sectionMap.has("KSN")?(this.decodeMeta(),this.getFrameOffsets(),this.decodeSoundHeader()):(this.isComment=!0,this.decodeMeta(),this.getFrameOffsets()),this.settings.dsiLibraryNote&&(this.isDsiLibraryNote=!0),this.settings.borderCrop&&(this.isDsiLibraryNote?(this.imageOffsetX=32,this.imageOffsetY=24,this.imageWidth=256,this.imageHeight=192):this.isFolderIcon||(this.imageOffsetX=5,this.imageOffsetY=5,this.imageWidth=310,this.imageHeight=230))}buildSectionMap(){this.seek(0);const t=this.byteLength-256,e=new Map;let i=0,r=0;for(;r<t&&i<6;){this.seek(r);const t=this.readChars(4).substring(0,3),s=this.readUint32();e.set(t,{ptr:r,length:s}),r+=s+8,i+=1}this.bodyEndOffset=r,this.sectionMap=e,u(e.has("KMC")&&e.has("KMI"))}readBits(t){if(this.bitIndex+t>16){const t=this.readUint16();this.bitValue|=t<<16-this.bitIndex,this.bitIndex-=16}const e=this.bitValue&V[t];return this.bitValue>>=t,this.bitIndex+=t,e}readFsid(){if(this.settings.dsiLibraryNote){return this.readHex(10,!0).slice(2,18)}const t=this.readHex(10);return`${t.slice(0,4)}-${t.slice(4,8)}-${t.slice(8,12)}-${t.slice(12,18)}`.toLowerCase()}readFilename(){const t=this.pointer,e=this.readChars(28);if(28===e.length)return e;this.seek(t);const i=this.readHex(3),r=this.readChars(13),s=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),`${i}_${r}_${s}`}decodeMeta(){if(this.settings.quickMeta)return this.decodeMetaQuick();u(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);const t=_(this.readUint32()),e=_(this.readUint32()),i=(this.readUint32(),this.readFsid()),r=this.readFsid(),s=this.readFsid(),n=this.readWideChars(11),a=this.readWideChars(11),o=this.readWideChars(11),h=this.readFilename(),l=this.readFilename(),d=this.readFilename(),c=this.readUint16(),p=this.readUint16(),f=this.readUint16(),m=this.readUint8(),g=this.readUint8();this.isSpinoff=s!==r||s!==i,this.frameCount=c,this.frameSpeed=m,this.framerate=O[m],this.duration=S(this.frameCount,this.framerate),this.thumbFrameIndex=p,this.layerVisibility={1:0==(1&g),2:0==(2&g),3:0==(3&g)},F(s)&&(this.isDsiLibraryNote=!0),this.meta={lock:0!=(1&f),loop:0!=(2&f),isSpinoff:this.isSpinoff,frameCount:c,frameSpeed:m,duration:this.duration,thumbIndex:p,timestamp:e,creationTimestamp:t,root:{username:n,fsid:i,region:k(i),filename:h,isDsiFilename:28!==h.length},parent:{username:a,fsid:r,region:k(r),filename:l,isDsiFilename:28!==l.length},current:{username:o,fsid:s,region:k(s),filename:d,isDsiFilename:28!==d.length}}}decodeMetaQuick(){u(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);const t=this.readUint16(),e=this.readUint16(),i=(this.readUint16(),this.readUint8()),r=this.readUint8();this.frameCount=t,this.thumbFrameIndex=e,this.frameSpeed=i,this.framerate=O[i],this.duration=S(this.frameCount,this.framerate),this.layerVisibility={1:0==(1&r),2:0==(2&r),3:0==(3&r)}}getFrameOffsets(){u(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));const t=this.frameCount,e=this.sectionMap.get("KMI"),i=this.sectionMap.get("KMC");u(e.length/28>=t);const r=new Uint32Array(t),s=new Uint32Array(t),n=[];let a=e.ptr+8,o=i.ptr+12;for(let e=0;e<t;e++){this.seek(a+4);const t=this.readUint16(),i=this.readUint16(),h=this.readUint16();r[e]=a,s[e]=o,a+=28,o+=t+i+h,u(a<this.byteLength,`frame${e} meta pointer out of bounds`),u(o<this.byteLength,`frame${e} data pointer out of bounds`),n.push([t,i,h])}this.frameMetaOffsets=r,this.frameDataOffsets=s,this.frameLayerSizes=n}decodeSoundHeader(){u(this.sectionMap.has("KSN"));let e=this.sectionMap.get("KSN").ptr+8;this.seek(e),this.bgmSpeed=this.readUint32(),u(this.bgmSpeed<=10),this.bgmrate=O[this.bgmSpeed];const i=new Uint32Array(this.buffer,e+4,20),r=new Map;r.set(t.FlipnoteAudioTrack.BGM,{ptr:e+=28,length:i[0]}),r.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=i[0],length:i[1]}),r.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=i[1],length:i[2]}),r.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=i[2],length:i[3]}),r.set(t.FlipnoteAudioTrack.SE4,{ptr:e+=i[3],length:i[4]}),this.soundMeta=r}getFramePaletteIndices(t){this.seek(this.frameMetaOffsets[t]);const e=this.readUint32();return[15&e,e>>8&15,e>>12&15,e>>16&15,e>>20&15,e>>24&15,e>>28&15]}getFramePalette(t){return this.getFramePaletteIndices(t).map(t=>this.globalPalette[t])}getFrameDiffingFlag(t){this.seek(this.frameMetaOffsets[t]);return this.readUint32()>>4&7}getFrameLayerSizes(t){return this.seek(this.frameMetaOffsets[t]+4),[this.readUint16(),this.readUint16(),this.readUint16()]}getFrameLayerDepths(t){this.seek(this.frameMetaOffsets[t]+20);return[this.readUint8(),this.readUint8(),this.readUint8()]}getFrameAuthor(t){return this.seek(this.frameMetaOffsets[t]+10),this.readHex(10)}getFrameSoundFlags(t){this.seek(this.frameMetaOffsets[t]+23);const e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e),0!=(8&e)]}getFrameCameraFlags(t){this.seek(this.frameMetaOffsets[t]+26);const e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e)]}getFrameLayerOrder(t){const e=this.getFrameLayerDepths(t);return[2,1,0].sort((t,i)=>e[i]-e[t])}decodeFrame(t,e=7,i=!1){if(u(t>-1&&t<this.frameCount,`Frame index ${t} out of bounds`),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame!==t-1&&0!==t&&(i&&(e&=~this.getFrameDiffingFlag(t+1)),0!==e&&this.decodeFrame(t-1,e,!0));let r=this.frameDataOffsets[t];const s=this.frameLayerSizes[t];for(let t=0;t<3&&(!this.settings.dsiLibraryNote||3!==t);t++){this.seek(r);let i=s[t];r+=i;const n=this.layerBuffers[t];if(38===i)continue;if(0==(e>>t&1))continue;this.bitIndex=16,this.bitValue=0;let a=0;for(let t=0;t<240;t+=128)for(let e=0;e<320;e+=128)for(let i=0;i<128;i+=8){const r=t+i;if(r>=240)break;for(let t=0;t<128;t+=8){const i=e+t;if(i>=320)break;if(a>0){a-=1;continue}let s=r*K.width+i;const o=this.readBits(3);if(0===o){const t=8*this.readBits(5),e=j.subarray(t,t+8);n.set(e,s),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320)}else if(1===o){const t=8*this.readBits(13),e=W.subarray(t,t+8);n.set(e,s),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(e,s+=320)}else if(2===o){const t=8*this.readBits(5),e=j.subarray(t,t+8),i=q.subarray(t,t+8);n.set(e,s),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320)}else if(3===o){const t=8*this.readBits(13),e=W.subarray(t,t+8),i=H.subarray(t,t+8);n.set(e,s),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320),n.set(e,s+=320),n.set(i,s+=320)}else if(4===o){const t=this.readBits(8);for(let e=1;e<255;e<<=1){if(t&e){const t=8*this.readBits(5),e=j.subarray(t,t+8);n.set(e,s)}else{const t=8*this.readBits(13),e=W.subarray(t,t+8);n.set(e,s)}s+=320}}else{if(5===o){a=this.readBits(5);continue}if(7===o){let t,e,i=this.readBits(2);if(0!==this.readBits(1)){const r=8*this.readBits(5),s=8*this.readBits(5);t=j.subarray(r,r+8),e=j.subarray(s,s+8),i+=1}else{const i=8*this.readBits(13),r=8*this.readBits(13);t=W.subarray(i,i+8),e=W.subarray(r,r+8)}switch(i%4){case 0:n.set(t,s),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320);break;case 1:n.set(t,s),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(t,s+=320);break;case 2:n.set(t,s),n.set(e,s+=320),n.set(t,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(t,s+=320),n.set(e,s+=320);break;case 3:n.set(t,s),n.set(e,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320),n.set(e,s+=320),n.set(t,s+=320),n.set(e,s+=320)}}}}}}return this.prevDecodedFrame=t,this.layerBuffers}decodeSoundFlags(){const t=[];for(let e=0;e<this.frameCount;e++)t.push(this.getFrameSoundFlags(e));return t}getAudioTrackRaw(t){const e=this.soundMeta.get(t);return u(e.ptr+e.length<this.byteLength),new Uint8Array(this.buffer,e.ptr,e.length)}decodeAdpcm(t,e,i=0,o=0){const h=t.length;let l=0,u=0,d=0,c=0;for(let p=0;p<h;p++){let h=t[p],f=0;for(;f<8;)o<18||f>4?(u=3&h,d=n[o],c=d>>3,1&u&&(c+=d),2&u&&(c=-c),i+=c,o+=r[u],h>>=2,f+=2):(u=15&h,d=n[o],c=d>>3,1&u&&(c+=d>>2),2&u&&(c+=d>>1),4&u&&(c+=d),8&u&&(c=-c),i+=c,o+=s[u],h>>=4,f+=4),o=a(o,0,79),i=a(i,-2048,2047),e[l]=16*i,l+=1}return l}decodeAudioTrack(e){const i=this.settings,r=this.getAudioTrackRaw(e),s=60*this.rawSampleRate,n=new Int16Array(s);let a=0,o=40;if(this.isDsiLibraryNote&&e===t.FlipnoteAudioTrack.BGM&&(null!==i.initialBgmPredictor&&(a=i.initialBgmPredictor),null!==i.initialBgmStepIndex&&(o=i.initialBgmStepIndex),i.guessInitialBgmState)){let t=4294967295,e=0;for(o=0;o<=40;o++){const i=this.decodeAdpcm(r,n,a,o),s=l(n.subarray(0,i));s<t&&(t=s,e=o)}o=e}const h=this.decodeAdpcm(r,n,a,o);return n.slice(0,h)}getAudioTrackPcm(e,i=this.sampleRate){const r=this.decodeAudioTrack(e);let s=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);s=this.rawSampleRate*t}return s!==i?function(t,e,i){const r=t.length,s=r/e*i,n=new Int16Array(s),a=e/i;for(let e=0,i=0,u=0,d=0;e<s;e++)i=e*a,u=Math.floor(i),d=i%1,n[e]=(h=o(t,r,u),l=o(t,r,u+1),h+d*(l-h));var h,l;return n}(r,s,i):r}pcmAudioMix(t,e,i=0){const r=t.length,s=e.length;for(let n=0;n<r&&!(i+n>s);n++){const r=e[i+n]+t[n];e[i+n]=a(r,-32768,32767)}}getAudioMasterPcm(e=this.sampleRate){const i=Math.ceil(this.duration*e),r=new Int16Array(i),s=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),l=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(s){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(i,r,0)}if(n||a||o||l){const i=e/this.framerate,s=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,h=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,u=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,d=l?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,e):null;for(let t=0;t<this.frameCount;t++){const e=this.getFrameSoundFlags(t),c=Math.ceil(t*i);n&&e[0]&&this.pcmAudioMix(s,r,c),a&&e[1]&&this.pcmAudioMix(h,r,c),o&&e[2]&&this.pcmAudioMix(u,r,c),l&&e[3]&&this.pcmAudioMix(d,r,c)}}return this.audioClipRatio=h(r),r}getBody(){const t=this.bodyEndOffset;return this.bytes.subarray(0,t)}getSignature(){const t=this.bodyEndOffset;return this.bytes.subarray(t,t+256)}async verify(){const t=await b("-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuv+zHAXXvbbtRqxADDeJ\nArX2b9RMxj3T+qpRg3FnIE/jeU3tj7eoDzsMduY+D/UT9CSnP+QHYY/vf0n5lqX9\ns6ljoZAmyUuruyj1e5Bg+fkDEu/yPEPQjqhbyywCyYL4TEAOJveopUBx9fdQxUJ6\nJ4J5oCE/Im1kFrlGW+puARiHmt3mmUyNzO8bI/Jx3cGSfoOHJG1foEaQsI5aaKqA\npBqxtzvwqMhudcZtAWSyRMBMlndvkRnVTDNTfTXLOYdHShCIgnKULCTH87uLBIP/\nnsmr4/bnQz8q2rp/HyVO+0yjR6mVr0NX5APJQ+6riJmGg3t3VOldhKP7aTHDUW+h\nkQIDAQAB\n-----END PUBLIC KEY-----","SHA-256");return await w(t,this.getSignature(),this.getBody())}}K.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,guessInitialBgmState:!0,initialBgmPredictor:null,initialBgmStepIndex:null},K.format=t.FlipnoteFormat.KWZ,K.width=320,K.height=240,K.numLayers=3,K.numLayerColors=2,K.rawSampleRate=16364,K.sampleRate=32768,K.globalPalette=[D.WHITE,D.BLACK,D.RED,D.YELLOW,D.GREEN,D.BLUE,D.NONE];const G=[{matches:function(t){return c&&"string"==typeof t},load:function(t,e,i){const r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(t){4===r.readyState&&(r.status>=200&&r.status<300?e(r.response):i({type:"httpError",status:r.status,statusText:r.statusText}))},r.send(null)}},{matches:function(t){return f&&"string"==typeof t},load:function(t,e,i){m();require("https").get(t,t=>{const r=[];t.on("data",t=>r.push(t)),t.on("end",()=>{const t=Buffer.concat(r);e(t.buffer)}),t.on("error",t=>i(t))})}},{matches:function(t){return c&&"undefined"!=typeof File&&"undefined"!=typeof FileReader&&t instanceof File},load:function(t,e,i){const r=new FileReader;r.onload=t=>{e(r.result)},r.onerror=t=>{i({type:"fileReadError"})},r.readAsArrayBuffer(t)}},{matches:function(t){return c&&"undefined"!=typeof Blob&&"undefined"!=typeof Response&&t instanceof Blob},load:function(t,e,i){new Response(t).arrayBuffer().then(e).catch(i)}},{matches:function(t){return f&&t instanceof Buffer},load:function(t,e,i){e(t.buffer)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,i){e(t)}}];function X(t,e){return function(t){return new Promise((e,i)=>{for(let r=0;r<G.length;r++){const s=G[r];if(s.matches(t))return s.load(t,e,i)}i("No loader available for source type")})}(t).then(t=>new Promise((i,r)=>{const s=new Uint8Array(t.slice(0,4)),n=s[0]<<24|s[1]<<16|s[2]<<8|s[3];1346458177===n?i(new z(t,e)):1262897152==(4294967040&n)||1263092480==(4294967040&n)?i(new K(t,e)):r("Could not identify source as a valid Flipnote file")}))}var Y;(Y=t.PlayerEvent||(t.PlayerEvent={})).__Any="any",Y.Play="play",Y.Pause="pause",Y.CanPlay="canplay",Y.CanPlayThrough="canplaythrough",Y.SeekStart="seeking",Y.SeekEnd="seeked",Y.Duration="durationchange",Y.Loop="loop",Y.Ended="ended",Y.VolumeChange="volumechange",Y.Progress="progress",Y.TimeUpdate="timeupdate",Y.FrameUpdate="frameupdate",Y.FrameNext="framenext",Y.FramePrev="frameprev",Y.FrameFirst="framefirst",Y.FrameLast="framelast",Y.Ready="ready",Y.Load="load",Y.LoadStart="loadstart",Y.LoadedData="loadeddata",Y.LoadedMeta="loadedmetadata",Y.Emptied="emptied",Y.Close="close",Y.Error="error",Y.Destroy="destroy";const Q=[t.PlayerEvent.Play,t.PlayerEvent.Pause,t.PlayerEvent.CanPlay,t.PlayerEvent.CanPlayThrough,t.PlayerEvent.SeekStart,t.PlayerEvent.SeekEnd,t.PlayerEvent.Duration,t.PlayerEvent.Loop,t.PlayerEvent.Ended,t.PlayerEvent.VolumeChange,t.PlayerEvent.Progress,t.PlayerEvent.TimeUpdate,t.PlayerEvent.FrameUpdate,t.PlayerEvent.FrameNext,t.PlayerEvent.FramePrev,t.PlayerEvent.FrameFirst,t.PlayerEvent.FrameLast,t.PlayerEvent.Ready,t.PlayerEvent.Load,t.PlayerEvent.LoadStart,t.PlayerEvent.LoadedData,t.PlayerEvent.LoadedMeta,t.PlayerEvent.Emptied,t.PlayerEvent.Close,t.PlayerEvent.Error];function J(t){return{length:t.length,start:e=>t[e][0],end:e=>t[e][1]}}function Z(t,e){return t.toString().padStart(e,"0")}function tt(t){return`${Math.floor(t%3600/60)}:${Z(Math.floor(t%60),2)}`}function et(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const it="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function rt(t,e){return"undefined"!=typeof WebGLTexture&&e instanceof WebGLTexture}const st="";function nt(t,e,i,r){if(s=e,"undefined"!=typeof WebGLBuffer&&s instanceof WebGLBuffer)return e;var s;i=i||34962;const n=t.createBuffer();return function(t,e,i,r,s){t.bindBuffer(e,i),t.bufferData(e,r,s||35044)}(t,i,n,e,r),n}function at(t){return"indices"===t}const ot=/coord|texture/i,ht=/color|colour/i;function lt(t,e){let i;if(i=ot.test(t)?2:ht.test(t)?4:3,e%i>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${i} but ${e} values is not evenly divisible by ${i}. You should specify it.`);return i}function ut(t,e){if(it(t))return t;if(it(t.data))return t.data;Array.isArray(t)&&(t={data:t});let i=t.type;return i||(i=at(e)?Uint16Array:Float32Array),new i(t.data)}function dt(t,e){const i={};return Object.keys(e).forEach((function(r){if(!at(r)){const n=e[r],a=n.attrib||n.name||n.attribName||st+r;if(n.value){if(!Array.isArray(n.value)&&!it(n.value))throw new Error("array.value is not array or typedarray");i[a]={value:n.value}}else{let e,o,h,l;if(n.buffer&&n.buffer instanceof WebGLBuffer)e=n.buffer,l=n.numComponents||n.size,o=n.type,h=n.normalize;else if("number"==typeof n||"number"==typeof n.data){const i=n.data||n,a=n.type||Float32Array,u=i*a.BYTES_PER_ELEMENT;o=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(a),h=void 0!==n.normalize?n.normalize:(s=a)===Int8Array||s===Uint8Array,l=n.numComponents||n.size||lt(r,i),e=t.createBuffer(),t.bindBuffer(34962,e),t.bufferData(34962,u,n.drawType||35044)}else{const i=ut(n,r);e=nt(t,i,void 0,n.drawType),o=et(i),h=void 0!==n.normalize?n.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(i),l=function(t,e){return t.numComponents||t.size||lt(e,function(t){return t.length?t:t.data}(t).length)}(n,r)}i[a]={buffer:e,numComponents:l,type:o,normalize:h,stride:n.stride||0,offset:n.offset||0,divisor:void 0===n.divisor?void 0:n.divisor,drawType:n.drawType}}}var s})),t.bindBuffer(34962,null),i}const ct=["position","positions","a_position"];function pt(t,e,i){const r=dt(t,e),s=Object.assign({},i||{});s.attribs=Object.assign({},i?i.attribs:{},r);const n=e.indices;if(n){const e=ut(n,"indices");s.indices=nt(t,e,34963),s.numElements=e.length,s.elementType=et(e)}else s.numElements||(s.numElements=function(t,e){let i,r;for(r=0;r<ct.length&&(i=ct[r],!(i in e))&&(i=st+i,!(i in e));++r);r===ct.length&&(i=Object.keys(e)[0]);const s=e[i];t.bindBuffer(34962,s.buffer);const n=t.getBufferParameter(34962,34660);var a;t.bindBuffer(34962,null);const o=n/(5120===(a=s.type)||5121===a?1:5122===a||5123===a?2:5124===a||5125===a||5126===a?4:0),h=s.numComponents||s.size,l=o/h;if(l%1!=0)throw new Error(`numComponents ${h} not correct for length ${length}`);return l}(t,s.attribs));return s}function ft(t){return!!t.texStorage2D}const mt={};function gt(t,e){return mt[e].bindPoint}function yt(t,e){return function(i){t.uniform1i(e,i)}}function vt(t,e){return function(i){t.uniform1iv(e,i)}}function bt(t,e){return function(i){t.uniform2iv(e,i)}}function wt(t,e){return function(i){t.uniform3iv(e,i)}}function _t(t,e){return function(i){t.uniform4iv(e,i)}}function St(t,e,i,r){const s=gt(0,e);return ft(t)?function(e){let n,a;rt(0,e)?(n=e,a=null):(n=e.texture,a=e.sampler),t.uniform1i(r,i),t.activeTexture(33984+i),t.bindTexture(s,n),t.bindSampler(i,a)}:function(e){t.uniform1i(r,i),t.activeTexture(33984+i),t.bindTexture(s,e)}}function At(t,e,i,r,s){const n=gt(0,e),a=new Int32Array(s);for(let t=0;t<s;++t)a[t]=i+t;return ft(t)?function(e){t.uniform1iv(r,a),e.forEach((function(e,r){let s,o;t.activeTexture(33984+a[r]),rt(0,e)?(s=e,o=null):(s=e.texture,o=e.sampler),t.bindSampler(i,o),t.bindTexture(n,s)}))}:function(e){t.uniform1iv(r,a),e.forEach((function(e,i){t.activeTexture(33984+a[i]),t.bindTexture(n,e)}))}}function Pt(t,e){return function(i){if(i.value)switch(t.disableVertexAttribArray(e),i.value.length){case 4:t.vertexAttrib4fv(e,i.value);break;case 3:t.vertexAttrib3fv(e,i.value);break;case 2:t.vertexAttrib2fv(e,i.value);break;case 1:t.vertexAttrib1fv(e,i.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i.numComponents||i.size,i.type||5126,i.normalize||!1,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(e,i.divisor)}}function xt(t,e){return function(i){if(i.value){if(t.disableVertexAttribArray(e),4!==i.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(e,i.value)}else t.bindBuffer(34962,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,i.numComponents||i.size,i.type||5124,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(e,i.divisor)}}function Et(t,e){return function(i){if(i.value){if(t.disableVertexAttribArray(e),4!==i.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(e,i.value)}else t.bindBuffer(34962,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,i.numComponents||i.size,i.type||5125,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(e,i.divisor)}}function Ct(t,e,i){const r=i.size,s=i.count;return function(i){t.bindBuffer(34962,i.buffer);const n=i.size||i.numComponents||r,a=n/s,o=i.type||5126,h=mt[o].size*n,l=i.normalize||!1,u=i.offset||0,d=h/s;for(let r=0;r<s;++r)t.enableVertexAttribArray(e+r),t.vertexAttribPointer(e+r,a,o,l,h,u+d*r),void 0!==i.divisor&&t.vertexAttribDivisor(e+r,i.divisor)}}mt[5126]={Type:Float32Array,size:4,setter:function(t,e){return function(i){t.uniform1f(e,i)}},arraySetter:function(t,e){return function(i){t.uniform1fv(e,i)}}},mt[35664]={Type:Float32Array,size:8,setter:function(t,e){return function(i){t.uniform2fv(e,i)}}},mt[35665]={Type:Float32Array,size:12,setter:function(t,e){return function(i){t.uniform3fv(e,i)}}},mt[35666]={Type:Float32Array,size:16,setter:function(t,e){return function(i){t.uniform4fv(e,i)}}},mt[5124]={Type:Int32Array,size:4,setter:yt,arraySetter:vt},mt[35667]={Type:Int32Array,size:8,setter:bt},mt[35668]={Type:Int32Array,size:12,setter:wt},mt[35669]={Type:Int32Array,size:16,setter:_t},mt[5125]={Type:Uint32Array,size:4,setter:function(t,e){return function(i){t.uniform1ui(e,i)}},arraySetter:function(t,e){return function(i){t.uniform1uiv(e,i)}}},mt[36294]={Type:Uint32Array,size:8,setter:function(t,e){return function(i){t.uniform2uiv(e,i)}}},mt[36295]={Type:Uint32Array,size:12,setter:function(t,e){return function(i){t.uniform3uiv(e,i)}}},mt[36296]={Type:Uint32Array,size:16,setter:function(t,e){return function(i){t.uniform4uiv(e,i)}}},mt[35670]={Type:Uint32Array,size:4,setter:yt,arraySetter:vt},mt[35671]={Type:Uint32Array,size:8,setter:bt},mt[35672]={Type:Uint32Array,size:12,setter:wt},mt[35673]={Type:Uint32Array,size:16,setter:_t},mt[35674]={Type:Float32Array,size:16,setter:function(t,e){return function(i){t.uniformMatrix2fv(e,!1,i)}}},mt[35675]={Type:Float32Array,size:36,setter:function(t,e){return function(i){t.uniformMatrix3fv(e,!1,i)}}},mt[35676]={Type:Float32Array,size:64,setter:function(t,e){return function(i){t.uniformMatrix4fv(e,!1,i)}}},mt[35685]={Type:Float32Array,size:24,setter:function(t,e){return function(i){t.uniformMatrix2x3fv(e,!1,i)}}},mt[35686]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix2x4fv(e,!1,i)}}},mt[35687]={Type:Float32Array,size:24,setter:function(t,e){return function(i){t.uniformMatrix3x2fv(e,!1,i)}}},mt[35688]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix3x4fv(e,!1,i)}}},mt[35689]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix4x2fv(e,!1,i)}}},mt[35690]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix4x3fv(e,!1,i)}}},mt[35678]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:3553},mt[35680]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:34067},mt[35679]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:32879},mt[35682]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:3553},mt[36289]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:35866},mt[36292]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:35866},mt[36293]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:34067},mt[36298]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:3553},mt[36299]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:32879},mt[36300]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:34067},mt[36303]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:35866},mt[36306]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:3553},mt[36307]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:32879},mt[36308]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:34067},mt[36311]={Type:null,size:0,setter:St,arraySetter:At,bindPoint:35866};const Tt={};function Ft(t){const e=t.name;return e.startsWith("gl_")||e.startsWith("webgl_")}function Ut(t,e){const i={program:e,uniformSetters:function(t,e){let i=0;function r(e,r,s){const n=r.name.endsWith("[0]"),a=r.type,o=mt[a];if(!o)throw new Error("unknown type: 0x"+a.toString(16));let h;if(o.bindPoint){const e=i;i+=r.size,h=n?o.arraySetter(t,a,e,s,r.size):o.setter(t,a,e,s,r.size)}else h=o.arraySetter&&n?o.arraySetter(t,s):o.setter(t,s);return h.location=s,h}const s={},n=t.getProgramParameter(e,35718);for(let i=0;i<n;++i){const n=t.getActiveUniform(e,i);if(Ft(n))continue;let a=n.name;a.endsWith("[0]")&&(a=a.substr(0,a.length-3));const o=t.getUniformLocation(e,n.name);o&&(s[a]=r(0,n,o))}return s}(t,e),attribSetters:function(t,e){const i={},r=t.getProgramParameter(e,35721);for(let s=0;s<r;++s){const r=t.getActiveAttrib(e,s);if(Ft(r))continue;const n=t.getAttribLocation(e,r.name),a=Tt[r.type],o=a.setter(t,n,a);o.location=n,i[r.name]=o}return i}(t,e)};return ft(t)&&(i.uniformBlockSpec=function(t,e){const i=t.getProgramParameter(e,35718),r=[],s=[];for(let n=0;n<i;++n){s.push(n),r.push({});const i=t.getActiveUniform(e,n);if(Ft(i))break;r[n].name=i.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(i){const n=i[0],a=i[1];t.getActiveUniforms(e,s,t[n]).forEach((function(t,e){r[e][a]=t}))}));const n={},a=t.getProgramParameter(e,35382);for(let i=0;i<a;++i){const r=t.getActiveUniformBlockName(e,i),s={index:t.getUniformBlockIndex(e,r),usedByVertexShader:t.getActiveUniformBlockParameter(e,i,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(e,i,35398),size:t.getActiveUniformBlockParameter(e,i,35392),uniformIndices:t.getActiveUniformBlockParameter(e,i,35395)};s.used=s.usedByVertexShader||s.usedByFragmentShader,n[r]=s}return{blockSpecs:n,uniformData:r}}(t,e),i.transformFeedbackInfo=function(t,e){const i={},r=t.getProgramParameter(e,35971);for(let s=0;s<r;++s){const r=t.getTransformFeedbackVarying(e,s);i[r.name]={index:s,type:r.type,size:r.size}}return i}(t,e)),i}Tt[5126]={size:4,setter:Pt},Tt[35664]={size:8,setter:Pt},Tt[35665]={size:12,setter:Pt},Tt[35666]={size:16,setter:Pt},Tt[5124]={size:4,setter:xt},Tt[35667]={size:8,setter:xt},Tt[35668]={size:12,setter:xt},Tt[35669]={size:16,setter:xt},Tt[5125]={size:4,setter:Et},Tt[36294]={size:8,setter:Et},Tt[36295]={size:12,setter:Et},Tt[36296]={size:16,setter:Et},Tt[35670]={size:4,setter:xt},Tt[35671]={size:8,setter:xt},Tt[35672]={size:12,setter:xt},Tt[35673]={size:16,setter:xt},Tt[35674]={size:4,setter:Ct,count:2},Tt[35675]={size:9,setter:Ct,count:3},Tt[35676]={size:16,setter:Ct,count:4};class kt{constructor(t,e=640,i=480,r={}){this.paletteBuffer=new Uint32Array(16),this.refs={programs:[],shaders:[],textures:[],buffers:[]},this.isCtxLost=!1,this.handleContextLoss=t=>{t.preventDefault(),this.destroy(),this.isCtxLost=!0,this.options.onlost()},this.handleContextRestored=t=>{this.isCtxLost=!1,this.init(),this.options.onrestored()},p(),this.el=document.createElement("canvas"),this.width=e,this.height=i,this.options=Object.assign(Object.assign({},kt.defaultOptions),r),this.el.addEventListener("webglcontextlost",this.handleContextLoss,!1),this.el.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.gl=this.el.getContext("webgl",{antialias:!1,alpha:!0}),t&&t.appendChild(this.el),this.init()}init(){const t=this.gl;this.program=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,8,8),this.setBuffersAndAttribs(this.program,this.quadBuffer),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.setCanvasSize(this.width,this.height),t.useProgram(this.program.program),t.bindTexture(t.TEXTURE_2D,this.frameTexture)}createProgram(t,e){u(!this.isCtxLost);const i=this.gl,r=this.createShader(i.VERTEX_SHADER,t),s=this.createShader(i.FRAGMENT_SHADER,e),n=i.createProgram();if(i.attachShader(n,r),i.attachShader(n,s),i.linkProgram(n),!i.getProgramParameter(n,i.LINK_STATUS)){const t=i.getProgramInfoLog(n);throw i.deleteProgram(n),new Error(t)}const a=Ut(i,n);return this.refs.programs.push(n),a}createShader(t,e){u(!this.isCtxLost);const i=this.gl,r=i.createShader(t);if(i.shaderSource(r,e),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){const t=i.getShaderInfoLog(r);throw i.deleteShader(r),new Error(t)}return this.refs.shaders.push(r),r}createScreenQuad(t,e,i,r,s,n){u(!this.isCtxLost);const a=(s+1)*(n+1),o=s+1,h=new Float32Array(2*a),l=new Float32Array(2*a);let d=0,c=0;for(let a=0;a<=n;a++)for(let o=0;o<=s;o++){const u=o/s,p=a/n;h[d++]=t+i*u,h[d++]=e+r*p,l[c++]=u,l[c++]=p}const p=new Uint16Array(s*n*2*3);let f=0;for(let t=0;t<n;t++)for(let e=0;e<s;e++)p[f++]=(t+0)*o+e,p[f++]=(t+1)*o+e,p[f++]=(t+0)*o+e+1,p[f++]=(t+0)*o+e+1,p[f++]=(t+1)*o+e,p[f++]=(t+1)*o+e+1;const m=pt(this.gl,{position:{numComponents:2,data:h},texcoord:{numComponents:2,data:l},indices:p});for(let t in m.attribs)this.refs.buffers.push(m.attribs[t].buffer);return m}setBuffersAndAttribs(t,e){const i=this.gl;!function(t,e){for(const i in e){const r=t[i];r&&r(e[i])}}(t.attribSetters,e.attribs),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.indices)}createTexture(t,e,i,r=1,s=1){u(!this.isCtxLost);const n=this.gl,a=n.createTexture();return n.bindTexture(n.TEXTURE_2D,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,e),n.texImage2D(n.TEXTURE_2D,0,t,r,s,0,t,n.UNSIGNED_BYTE,null),this.refs.textures.push(a),a}setCanvasSize(t,e){u(!this.isCtxLost);const i=this.options.useDpi&&window.devicePixelRatio||1,r=t*i,s=e*i;this.width=t,this.height=e,this.el.width=r,this.el.height=s,this.screenWidth=r,this.screenHeight=s,this.el.style.width=t+"px",this.el.style.height=e+"px";const n=this.gl;n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight)}setInputSize(t,e){const i=this.gl;this.textureWidth=t,this.textureHeight=e,i.bindTexture(i.TEXTURE_2D,this.frameTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.textureWidth,this.textureHeight,0,i.RGBA,i.UNSIGNED_BYTE,null),this.frameBuffer=new Uint32Array(t*e),this.frameBufferBytes=new Uint8Array(this.frameBuffer.buffer)}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}drawFrame(t,e){const{gl:i,textureWidth:r,textureHeight:s}=this;t.getFramePixelsRgba(e,this.frameBuffer,this.paletteBuffer),i.clear(i.COLOR_BUFFER_BIT),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,r,s,0,i.RGBA,i.UNSIGNED_BYTE,this.frameBufferBytes),function t(e,i){const r=e.uniformSetters||e,s=arguments.length;for(let e=1;e<s;++e){const i=arguments[e];if(Array.isArray(i)){const e=i.length;for(let s=0;s<e;++s)t(r,i[s])}else for(const t in i){const e=r[t];e&&e(i[t])}}}(this.program,{u_flipY:!0,u_tex:this.frameTexture,u_textureSize:[this.textureWidth,this.textureHeight],u_screenSize:[i.drawingBufferWidth,i.drawingBufferHeight]}),i.drawElements(i.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}isErrorState(){const t=this.gl,e=t.getError();return e!=t.NO_ERROR&&e!=t.CONTEXT_LOST_WEBGL}isLost(){return this.gl.isContextLost()}async destroy(){const t=this.refs,e=this.gl;t.shaders.forEach(t=>{e.deleteShader(t)}),t.shaders=[],t.textures.forEach(t=>{e.deleteTexture(t)}),t.textures=[],t.buffers.forEach(t=>{e.deleteBuffer(t)}),t.buffers=[],t.programs.forEach(t=>{e.deleteProgram(t)}),t.programs=[],this.paletteBuffer=null,this.frameBuffer=null,this.frameBufferBytes=null,e.canvas.width=1,e.canvas.height=1}}kt.defaultOptions={onlost:()=>{},onrestored:()=>{},useDpi:!0};const Bt=c?window.AudioContext||window.webkitAudioContext:null;class Lt{constructor(){this.useEq=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this._volume=1,this._loop=!1,this.nodeRefs=[],p()}set volume(t){this.setVolume(t)}get volume(){return this._volume}set loop(t){this._loop=t,this.source&&(this.source.loop=t)}get loop(){return this._loop}getCtx(){return this.ctx||(this.ctx=new Bt),this.ctx}setBuffer(t,e){const i=this.getCtx(),r=t.length,s=i.createBuffer(1,r,e),n=s.getChannelData(0);if(t instanceof Float32Array)n.set(t,0);else if(t instanceof Int16Array)for(let e=0;e<r;e++)n[e]=t[e]/32768;this.buffer=s,this.sampleRate=e}connectEqNodesTo(t){const e=this.getCtx(),i=this.eqSettings;let r=t;return i.forEach(([t,s],n)=>{const a=e.createBiquadFilter();this.nodeRefs.push(a),a.frequency.value=t,a.gain.value=s,0===n?a.type="lowshelf":n===i.length-1?a.type="highshelf":a.type="peaking",r.connect(a),r=a}),r}initNodes(){const t=this.getCtx();this.nodeRefs=[];const e=t.createBufferSource();this.nodeRefs.push(e),e.buffer=this.buffer;const i=t.createGain();if(this.nodeRefs.push(i),this.useEq){this.connectEqNodesTo(e).connect(i)}else e.connect(i);e.connect(i),i.connect(t.destination),this.source=e,this.gainNode=i,this.setVolume(this._volume)}setVolume(t){this._volume=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))}playFrom(t){this.initNodes(),this.source.loop=this._loop,this.source.start(0,t)}stop(){this.source&&this.source.stop(0)}async destroy(){this.stop();const t=this.getCtx();this.nodeRefs.forEach(t=>t.disconnect()),this.nodeRefs=[],"closed"!==t.state&&"function"==typeof t.close&&await t.close(),this.buffer=null}}class Nt{constructor(e,i,r){this.duration=0,this.autoplay=!1,this.supportedEvents=Q,this._src=null,this._loop=!1,this._volume=1,this._muted=!1,this._frame=null,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=e=>{if(!this.isPlaying)return;const i=e/1e3,r=i-this.playbackStartTime;r>=this.duration&&(this.loop?(this.playbackStartTime=i,this.emit(t.PlayerEvent.Loop)):(this.pause(),this.emit(t.PlayerEvent.Ended))),this.setCurrentTime(r%this.duration),this.playbackLoopId=requestAnimationFrame(this.playbackLoop)},p();const s="string"==typeof e?document.querySelector(e):e;this.renderer=new kt(s,i,r,{onlost:()=>this.emit(t.PlayerEvent.Error),onrestored:()=>this.load()}),this.audio=new Lt,this.canvasEl=this.renderer.el}get src(){return this._src}set src(t){this.load(t)}get paused(){return!this.isPlaying}set paused(t){t?this.pause():this.play()}get currentFrame(){return this._frame}set currentFrame(t){this.setCurrentFrame(t)}get currentTime(){return this.isNoteLoaded?this.playbackTime:null}set currentTime(t){this.setCurrentTime(t)}get progress(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null}set progress(t){this.setProgress(t)}get volume(){return this.getVolume()}set volume(t){this.setVolume(t)}get muted(){return this.getMuted()}set muted(t){this.setMuted(t)}get loop(){return this.getLoop()}set loop(t){this.setLoop(t)}get framerate(){return this.note.framerate}get frameCount(){return this.note.frameCount}get frameSpeed(){return this.note.frameSpeed}get buffered(){return J([[0,this.duration]])}get seekable(){return J([[0,this.duration]])}get currentSrc(){return this._src}get videoWidth(){return this.isNoteLoaded?this.note.imageWidth:0}get videoHeight(){return this.isNoteLoaded?this.note.imageHeight:0}async load(e=null){return this.isNoteLoaded&&this.closeNote(),e?(this.emit(t.PlayerEvent.LoadStart),X(e).then(t=>{this.openNote(t),this._src=e}).catch(e=>{throw this.emit(t.PlayerEvent.Error,e),new Error("Error loading Flipnote: "+e.message)})):this.openNote(this.note)}closeNote(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this._src=null,this._frame=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clear()}openNote(e){this.isNoteLoaded&&this.closeNote(),this.note=e,this.meta=e.meta,this.emit(t.PlayerEvent.LoadedMeta),this.noteFormat=e.format,this.duration=e.duration,this.playbackTime=0,this._frame=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=e.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(e.getAudioMasterPcm(),e.sampleRate),this.emit(t.PlayerEvent.CanPlay),this.emit(t.PlayerEvent.CanPlayThrough),this.setLoop(e.meta.loop),this.renderer.setInputSize(e.imageWidth,e.imageHeight),this.drawFrame(e.thumbFrameIndex),this.emit(t.PlayerEvent.LoadedData),this.emit(t.PlayerEvent.Load),this.emit(t.PlayerEvent.Ready),this.autoplay&&this.play()}setCurrentTime(e){this.assertNoteLoaded();const i=Math.floor(e/(1/this.framerate));this.setCurrentFrame(i),this.playbackTime=e,this.emit(t.PlayerEvent.Progress,this.progress)}getCurrentTime(){return this.currentTime}getTimeCounter(){return`${tt(Math.max(this.currentTime,0))} / ${tt(this.duration)}`}getFrameCounter(){return`${Z(this.currentFrame+1,3)} / ${Z(this.frameCount,3)}`}setProgress(t){this.assertNoteLoaded(),d(t,0,100,"progress"),this.currentTime=this.duration*(t/100)}getProgress(){return this.progress}async play(){if(this.assertNoteLoaded(),this.isPlaying)return;this.isPlaying=!0,this.hasPlaybackStarted=!0;const e=performance.now();this.playbackStartTime=e/1e3-this.playbackTime,this.playAudio(),this.playbackLoop(e),this.emit(t.PlayerEvent.Play)}pause(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(t.PlayerEvent.Pause))}togglePlay(){this.isPlaying?this.pause():this.play()}getPaused(){return!this.isPlaying}getDuration(){return this.duration}getLoop(){return this._loop}setLoop(t){this._loop=t,this.audio.loop=t}toggleLoop(){this.setLoop(!this._loop)}setCurrentFrame(e){this.assertNoteLoaded();const i=Math.max(0,Math.min(Math.floor(e),this.frameCount-1));(i!==this.currentFrame||this.showThumbnail)&&(this._frame=i,this.drawFrame(i),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=i*(1/this.framerate),this.emit(t.PlayerEvent.SeekEnd)),this.emit(t.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(t.PlayerEvent.Progress,this.progress),this.emit(t.PlayerEvent.TimeUpdate,this.currentFrame))}nextFrame(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(t.PlayerEvent.FrameNext)}prevFrame(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(t.PlayerEvent.FramePrev)}lastFrame(){this.currentFrame=this.frameCount-1,this.emit(t.PlayerEvent.FrameLast)}firstFrame(){this.currentFrame=0,this.emit(t.PlayerEvent.FrameFirst)}thumbnailFrame(){this.currentFrame=this.note.thumbFrameIndex}startSeek(){this.isSeeking||(this.emit(t.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)}seek(t){this.isSeeking&&(this.progress=100*t)}endSeek(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1}drawFrame(t){this.renderer.drawFrame(this.note,t)}forceUpdate(){this.isNoteLoaded&&this.drawFrame(this.currentFrame)}resize(t,e){e!==.75*t&&console.warn(`Canvas width to height ratio should be 3:4 for best results (got ${t}x${e})`),this.renderer.setCanvasSize(t,e),this.forceUpdate()}setLayerVisibility(t,e){this.note.layerVisibility[t]=e,this.layerVisibility[t]=e,this.forceUpdate()}getLayerVisibility(t){return this.layerVisibility[t]}toggleLayerVisibility(t){this.setLayerVisibility(t,!this.layerVisibility[t])}playAudio(){this.audio.playFrom(this.currentTime)}stopAudio(){this.audio.stop()}toggleAudioEq(){this.setAudioEq(!this.audio.useEq)}setAudioEq(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())}mute(){this.setMuted(!0)}unmute(){this.setMuted(!1)}setMuted(e){this.audio.volume=e?0:this._volume,this._muted=e,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getMuted(){return 0===this.volume||this._muted}toggleMuted(){this.setMuted(!this._muted)}setVolume(e){d(e,0,1,"volume"),this._volume=e,this.audio.volume=e,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getVolume(){return this._muted?0:this._volume}seekToNextFrame(){this.nextFrame()}fastSeek(t){this.currentTime=t}canPlayType(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";case"video/vnd.nintendo.ugomemo.fykt":default:return""}}getVideoPlaybackQuality(){return{creationTime:0,droppedVideoFrames:0,totalVideoFrames:this.frameCount}}requestPictureInPicture(){throw new Error("Not implemented")}captureStream(){throw new Error("Not implemented")}on(t,e){const i=this.events;(Array.isArray(t)?t:[t]).forEach(t=>{i.has(t)?i.get(t).push(e):i.set(t,[e])})}off(t,e){const i=this.events;(Array.isArray(t)?t:[t]).forEach(t=>{if(!i.has(t))return;const r=i.get(t);i.set(t,r.splice(r.indexOf(e),1))})}emit(e,...i){const r=this.events;if(e!==t.PlayerEvent.__Any&&r.has(e)){r.get(e).forEach(t=>t.apply(null,i));const t="on"+e,s=this;"function"==typeof s[t]&&s[t].apply(null,i)}if(r.has(t.PlayerEvent.__Any)){r.get(t.PlayerEvent.__Any).forEach(t=>t.apply(null,[e,...i]))}}clearEvents(){this.events.clear()}async destroy(){this.clearEvents(),this.emit(t.PlayerEvent.Destroy),this.closeNote(),await this.renderer.destroy(),await this.audio.destroy()}supports(t){const e=this.supportedEvents.includes(t),i="function"==typeof this[t];return e||i}assertNoteLoaded(){u(this.isNoteLoaded,"No Flipnote is currently loaded in this player")}}function Mt(t){class e extends t{get renderer(){return this.player.renderer}get audio(){return this.player.audio}get canvasEl(){return this.player.canvasEl}get note(){return this.player.note}get noteFormat(){return this.player.noteFormat}get meta(){return this.player.meta}get duration(){return this.player.duration}get layerVisibility(){return this.player.layerVisibility}get autoplay(){return this.player.autoplay}set autoplay(t){this.player.autoplay=t}}for(let i of Reflect.ownKeys(Nt.prototype)){let r=Object.getOwnPropertyDescriptor(Nt.prototype,i);i in t.prototype||"constructor"===i||"name"===i||"prototype"===i||(r.value&&"function"==typeof r.value?Object.defineProperty(e.prototype,i,Object.assign(Object.assign({},r),{value:function(...t){return this.player[i](...t)}})):(r.get||r.set)&&Object.defineProperty(e.prototype,i,Object.assign(Object.assign({},r),{set:function(t){this.player[i]=t},get:function(){return this.player[i]}})))}return e}class It{constructor(){this.dataUrl=null}getBuffer(){return m(),Buffer.from(this.getArrayBuffer())}getBlob(){return p(),new Blob([this.getArrayBuffer()],{type:this.mimeType})}getUrl(){return p(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())}revokeUrl(){p(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)}}const Rt=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];class zt{constructor(t,e,i){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.colorDepth=i,this.reset()}reset(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}char_out(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)}cl_block(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)}cl_hash(t){for(var e=0;e<t;++e)this.htab[e]=-1}compress(t,e){var i,r,s,n,a,o;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,n=this.nextPixel(),o=0,i=5003;i<65536;i*=2)++o;o=8-o,this.cl_hash(5003),this.output(this.ClearCode,e);t:for(;-1!=(r=this.nextPixel());)if(i=(r<<12)+n,s=r<<o^n,this.htab[s]!==i){if(this.htab[s]>=0){a=5003-s,0===s&&(a=1);do{if((s-=a)<0&&(s+=5003),this.htab[s]===i){n=this.codetab[s];continue t}}while(this.htab[s]>=0)}this.output(n,e),n=r,this.free_ent<4096?(this.codetab[s]=this.free_ent++,this.htab[s]=i):this.cl_block(e)}else n=this.codetab[s];this.output(n,e),this.output(this.EOFCode,e)}encode(t,e){this.pixels=t,e.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,e),e.writeByte(0)}flush_char(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)}get_maxcode(t){return(1<<t)-1}nextPixel(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}output(t,e){for(this.cur_accum&=Rt[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}}}class Ot extends It{constructor(t,i,r={}){super(),this.mimeType="gif/image",this.frameCount=0,this.width=t,this.height=i,this.data=new e,this.settings=Object.assign(Object.assign({},Ot.defaultSettings),r),this.compressor=new zt(t,i,r.colorDepth)}static fromFlipnote(t,e={}){var i;const r=new Ot(t.imageWidth,t.imageHeight,Object.assign({delay:100/t.framerate,repeat:(null===(i=t.meta)||void 0===i?void 0:i.loop)?-1:0},e));r.palette=t.globalPalette;for(let e=0;e<t.frameCount;e++)r.writeFrame(t.getFramePixels(e));return r}static fromFlipnoteFrame(t,e,i={}){const r=new Ot(t.imageWidth,t.imageHeight,Object.assign({delay:100/t.framerate,repeat:-1},i));return r.palette=t.globalPalette,r.writeFrame(t.getFramePixels(e)),r}writeFrame(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1}writeFirstFrame(t){const e=this.palette.length;for(var i=1;1<<i<e;i+=1)continue;this.settings.colorDepth=i,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt(),this.writeFrameHeader(),this.writePixels(t)}writeAdditionalFrame(t){this.writeFrameHeader(),this.writePixels(t)}writeHeader(){const t=new i(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.settings.colorDepth-1),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))}writeColorTable(){const t=new Uint8Array(3*Math.pow(2,this.settings.colorDepth));let e=0;for(let i=0;i<this.palette.length;i+=1){const[r,s,n,a]=this.palette[i];t[e++]=r,t[e++]=s,t[e++]=n}this.data.writeBytes(t)}writeNetscapeExt(){const t=new i(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.settings.repeat),this.data.writeBytes(new Uint8Array(t.buffer))}writeFrameHeader(){const t=new i(new ArrayBuffer(18)),e=this.settings.transparentBg?1:0;t.writeBytes([33,249,4,0|e]),t.writeUint16(this.settings.delay),t.writeBytes([0,0]),t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))}writePixels(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)}getArrayBuffer(){return this.data.getBuffer()}getImage(){p();const t=new Image(this.width,this.height);return t.src=this.getUrl(),t}}Ot.defaultSettings={transparentBg:!1,delay:100,repeat:-1,colorDepth:8};class Dt extends It{constructor(t,e=1,r=16){super(),this.sampleRate=t,this.channels=e,this.bitsPerSample=r;const s=new ArrayBuffer(44),n=new i(s);n.writeChars("RIFF"),n.writeUint32(0),n.writeChars("WAVE"),n.writeChars("fmt "),n.writeUint32(16),n.writeUint16(1),n.writeUint16(this.channels),n.writeUint32(this.sampleRate),n.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample),n.writeChars("data"),n.writeUint32(0),this.header=n,this.pcmData=null}static fromFlipnote(t){const e=t.sampleRate,i=new Dt(e,1,16),r=t.getAudioMasterPcm(e);return i.writeSamples(r),i}static fromFlipnoteTrack(t,e){const i=t.sampleRate,r=new Dt(i,1,16),s=t.getAudioTrackPcm(e,i);return r.writeSamples(s),r}writeSamples(t){let e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t}getArrayBuffer(){const t=this.header.bytes,e=new Uint8Array(this.pcmData.buffer),i=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return i.set(t),i.set(e,t.byteLength),i.buffer}}function Vt(t,e,i,r){for(var s,n=arguments.length,a=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r,o=t.length-1;o>=0;o--)(s=t[o])&&(a=(n<3?s(a):n>3?s(e,i,a):s(e,i))||a);return n>3&&a&&Object.defineProperty(e,i,a),a}const Wt="undefined"!=typeof window&&null!=window.customElements&&void 0!==window.customElements.polyfillWrapFlushCallback,Ht=(t,e,i=null)=>{for(;e!==i;){const i=e.nextSibling;t.removeChild(e),e=i}},$t=`{{lit-${String(Math.random()).slice(2)}}}`,jt=`\x3c!--${$t}--\x3e`,qt=new RegExp(`${$t}|${jt}`);class Kt{constructor(t,e){this.parts=[],this.element=e;const i=[],r=[],s=document.createTreeWalker(e.content,133,null,!1);let n=0,a=-1,o=0;const{strings:h,values:{length:l}}=t;for(;o<l;){const t=s.nextNode();if(null!==t){if(a++,1===t.nodeType){if(t.hasAttributes()){const e=t.attributes,{length:i}=e;let r=0;for(let t=0;t<i;t++)Gt(e[t].name,"$lit$")&&r++;for(;r-- >0;){const e=h[o],i=Qt.exec(e)[2],r=i.toLowerCase()+"$lit$",s=t.getAttribute(r);t.removeAttribute(r);const n=s.split(qt);this.parts.push({type:"attribute",index:a,name:i,strings:n}),o+=n.length-1}}"TEMPLATE"===t.tagName&&(r.push(t),s.currentNode=t.content)}else if(3===t.nodeType){const e=t.data;if(e.indexOf($t)>=0){const r=t.parentNode,s=e.split(qt),n=s.length-1;for(let e=0;e<n;e++){let i,n=s[e];if(""===n)i=Yt();else{const t=Qt.exec(n);null!==t&&Gt(t[2],"$lit$")&&(n=n.slice(0,t.index)+t[1]+t[2].slice(0,-"$lit$".length)+t[3]),i=document.createTextNode(n)}r.insertBefore(i,t),this.parts.push({type:"node",index:++a})}""===s[n]?(r.insertBefore(Yt(),t),i.push(t)):t.data=s[n],o+=n}}else if(8===t.nodeType)if(t.data===$t){const e=t.parentNode;null!==t.previousSibling&&a!==n||(a++,e.insertBefore(Yt(),t)),n=a,this.parts.push({type:"node",index:a}),null===t.nextSibling?t.data="":(i.push(t),a--),o++}else{let e=-1;for(;-1!==(e=t.data.indexOf($t,e+1));)this.parts.push({type:"node",index:-1}),o++}}else s.currentNode=r.pop()}for(const t of i)t.parentNode.removeChild(t)}}const Gt=(t,e)=>{const i=t.length-e.length;return i>=0&&t.slice(i)===e},Xt=t=>-1!==t.index,Yt=()=>document.createComment(""),Qt=/([ \x09\x0a\x0c\x0d])([^\0-\x1F\x7F-\x9F "'>=/]+)([ \x09\x0a\x0c\x0d]*=[ \x09\x0a\x0c\x0d]*(?:[^ \x09\x0a\x0c\x0d"'`<>=]*|"[^"]*|'[^']*))$/;function Jt(t,e){const{element:{content:i},parts:r}=t,s=document.createTreeWalker(i,133,null,!1);let n=te(r),a=r[n],o=-1,h=0;const l=[];let u=null;for(;s.nextNode();){o++;const t=s.currentNode;for(t.previousSibling===u&&(u=null),e.has(t)&&(l.push(t),null===u&&(u=t)),null!==u&&h++;void 0!==a&&a.index===o;)a.index=null!==u?-1:a.index-h,n=te(r,n),a=r[n]}l.forEach(t=>t.parentNode.removeChild(t))}const Zt=t=>{let e=11===t.nodeType?0:1;const i=document.createTreeWalker(t,133,null,!1);for(;i.nextNode();)e++;return e},te=(t,e=-1)=>{for(let i=e+1;i<t.length;i++){const e=t[i];if(Xt(e))return i}return-1};const ee=new WeakMap,ie=t=>(...e)=>{const i=t(...e);return ee.set(i,!0),i},re=t=>"function"==typeof t&&ee.has(t),se={},ne={};class ae{constructor(t,e,i){this.__parts=[],this.template=t,this.processor=e,this.options=i}update(t){let e=0;for(const i of this.__parts)void 0!==i&&i.setValue(t[e]),e++;for(const t of this.__parts)void 0!==t&&t.commit()}_clone(){const t=Wt?this.template.element.content.cloneNode(!0):document.importNode(this.template.element.content,!0),e=[],i=this.template.parts,r=document.createTreeWalker(t,133,null,!1);let s,n=0,a=0,o=r.nextNode();for(;n<i.length;)if(s=i[n],Xt(s)){for(;a<s.index;)a++,"TEMPLATE"===o.nodeName&&(e.push(o),r.currentNode=o.content),null===(o=r.nextNode())&&(r.currentNode=e.pop(),o=r.nextNode());if("node"===s.type){const t=this.processor.handleTextExpression(this.options);t.insertAfterNode(o.previousSibling),this.__parts.push(t)}else this.__parts.push(...this.processor.handleAttributeExpressions(o,s.name,s.strings,this.options));n++}else this.__parts.push(void 0),n++;return Wt&&(document.adoptNode(t),customElements.upgrade(t)),t}}const oe=window.trustedTypes&&trustedTypes.createPolicy("lit-html",{createHTML:t=>t}),he=` ${$t} `;class le{constructor(t,e,i,r){this.strings=t,this.values=e,this.type=i,this.processor=r}getHTML(){const t=this.strings.length-1;let e="",i=!1;for(let r=0;r<t;r++){const t=this.strings[r],s=t.lastIndexOf("\x3c!--");i=(s>-1||i)&&-1===t.indexOf("--\x3e",s+1);const n=Qt.exec(t);e+=null===n?t+(i?he:jt):t.substr(0,n.index)+n[1]+n[2]+"$lit$"+n[3]+$t}return e+=this.strings[t],e}getTemplateElement(){const t=document.createElement("template");let e=this.getHTML();return void 0!==oe&&(e=oe.createHTML(e)),t.innerHTML=e,t}}const ue=t=>null===t||!("object"==typeof t||"function"==typeof t),de=t=>Array.isArray(t)||!(!t||!t[Symbol.iterator]);class ce{constructor(t,e,i){this.dirty=!0,this.element=t,this.name=e,this.strings=i,this.parts=[];for(let t=0;t<i.length-1;t++)this.parts[t]=this._createPart()}_createPart(){return new pe(this)}_getValue(){const t=this.strings,e=t.length-1,i=this.parts;if(1===e&&""===t[0]&&""===t[1]){const t=i[0].value;if("symbol"==typeof t)return String(t);if("string"==typeof t||!de(t))return t}let r="";for(let s=0;s<e;s++){r+=t[s];const e=i[s];if(void 0!==e){const t=e.value;if(ue(t)||!de(t))r+="string"==typeof t?t:String(t);else for(const e of t)r+="string"==typeof e?e:String(e)}}return r+=t[e],r}commit(){this.dirty&&(this.dirty=!1,this.element.setAttribute(this.name,this._getValue()))}}class pe{constructor(t){this.value=void 0,this.committer=t}setValue(t){t===se||ue(t)&&t===this.value||(this.value=t,re(t)||(this.committer.dirty=!0))}commit(){for(;re(this.value);){const t=this.value;this.value=se,t(this)}this.value!==se&&this.committer.commit()}}class fe{constructor(t){this.value=void 0,this.__pendingValue=void 0,this.options=t}appendInto(t){this.startNode=t.appendChild(Yt()),this.endNode=t.appendChild(Yt())}insertAfterNode(t){this.startNode=t,this.endNode=t.nextSibling}appendIntoPart(t){t.__insert(this.startNode=Yt()),t.__insert(this.endNode=Yt())}insertAfterPart(t){t.__insert(this.startNode=Yt()),this.endNode=t.endNode,t.endNode=this.startNode}setValue(t){this.__pendingValue=t}commit(){if(null===this.startNode.parentNode)return;for(;re(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=se,t(this)}const t=this.__pendingValue;t!==se&&(ue(t)?t!==this.value&&this.__commitText(t):t instanceof le?this.__commitTemplateResult(t):t instanceof Node?this.__commitNode(t):de(t)?this.__commitIterable(t):t===ne?(this.value=ne,this.clear()):this.__commitText(t))}__insert(t){this.endNode.parentNode.insertBefore(t,this.endNode)}__commitNode(t){this.value!==t&&(this.clear(),this.__insert(t),this.value=t)}__commitText(t){const e=this.startNode.nextSibling,i="string"==typeof(t=null==t?"":t)?t:String(t);e===this.endNode.previousSibling&&3===e.nodeType?e.data=i:this.__commitNode(document.createTextNode(i)),this.value=t}__commitTemplateResult(t){const e=this.options.templateFactory(t);if(this.value instanceof ae&&this.value.template===e)this.value.update(t.values);else{const i=new ae(e,t.processor,this.options),r=i._clone();i.update(t.values),this.__commitNode(r),this.value=i}}__commitIterable(t){Array.isArray(this.value)||(this.value=[],this.clear());const e=this.value;let i,r=0;for(const s of t)i=e[r],void 0===i&&(i=new fe(this.options),e.push(i),0===r?i.appendIntoPart(this):i.insertAfterPart(e[r-1])),i.setValue(s),i.commit(),r++;r<e.length&&(e.length=r,this.clear(i&&i.endNode))}clear(t=this.startNode){Ht(this.startNode.parentNode,t.nextSibling,this.endNode)}}class me{constructor(t,e,i){if(this.value=void 0,this.__pendingValue=void 0,2!==i.length||""!==i[0]||""!==i[1])throw new Error("Boolean attributes can only contain a single expression");this.element=t,this.name=e,this.strings=i}setValue(t){this.__pendingValue=t}commit(){for(;re(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=se,t(this)}if(this.__pendingValue===se)return;const t=!!this.__pendingValue;this.value!==t&&(t?this.element.setAttribute(this.name,""):this.element.removeAttribute(this.name),this.value=t),this.__pendingValue=se}}class ge extends ce{constructor(t,e,i){super(t,e,i),this.single=2===i.length&&""===i[0]&&""===i[1]}_createPart(){return new ye(this)}_getValue(){return this.single?this.parts[0].value:super._getValue()}commit(){this.dirty&&(this.dirty=!1,this.element[this.name]=this._getValue())}}class ye extends pe{}let ve=!1;(()=>{try{const t={get capture(){return ve=!0,!1}};window.addEventListener("test",t,t),window.removeEventListener("test",t,t)}catch(t){}})();class be{constructor(t,e,i){this.value=void 0,this.__pendingValue=void 0,this.element=t,this.eventName=e,this.eventContext=i,this.__boundHandleEvent=t=>this.handleEvent(t)}setValue(t){this.__pendingValue=t}commit(){for(;re(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=se,t(this)}if(this.__pendingValue===se)return;const t=this.__pendingValue,e=this.value,i=null==t||null!=e&&(t.capture!==e.capture||t.once!==e.once||t.passive!==e.passive),r=null!=t&&(null==e||i);i&&this.element.removeEventListener(this.eventName,this.__boundHandleEvent,this.__options),r&&(this.__options=we(t),this.element.addEventListener(this.eventName,this.__boundHandleEvent,this.__options)),this.value=t,this.__pendingValue=se}handleEvent(t){"function"==typeof this.value?this.value.call(this.eventContext||this.element,t):this.value.handleEvent(t)}}const we=t=>t&&(ve?{capture:t.capture,passive:t.passive,once:t.once}:t.capture);function _e(t){let e=Se.get(t.type);void 0===e&&(e={stringsArray:new WeakMap,keyString:new Map},Se.set(t.type,e));let i=e.stringsArray.get(t.strings);if(void 0!==i)return i;const r=t.strings.join($t);return i=e.keyString.get(r),void 0===i&&(i=new Kt(t,t.getTemplateElement()),e.keyString.set(r,i)),e.stringsArray.set(t.strings,i),i}const Se=new Map,Ae=new WeakMap;const Pe=new class{handleAttributeExpressions(t,e,i,r){const s=e[0];if("."===s){return new ge(t,e.slice(1),i).parts}if("@"===s)return[new be(t,e.slice(1),r.eventContext)];if("?"===s)return[new me(t,e.slice(1),i)];return new ce(t,e,i).parts}handleTextExpression(t){return new fe(t)}};"undefined"!=typeof window&&(window.litHtmlVersions||(window.litHtmlVersions=[])).push("1.3.0");const xe=(t,...e)=>new le(t,e,"html",Pe),Ee=(t,e)=>`${t}--${e}`;let Ce=!0;void 0===window.ShadyCSS?Ce=!1:void 0===window.ShadyCSS.prepareTemplateDom&&(console.warn("Incompatible ShadyCSS version detected. Please update to at least @webcomponents/webcomponentsjs@2.0.2 and @webcomponents/shadycss@1.3.1."),Ce=!1);const Te=t=>e=>{const i=Ee(e.type,t);let r=Se.get(i);void 0===r&&(r={stringsArray:new WeakMap,keyString:new Map},Se.set(i,r));let s=r.stringsArray.get(e.strings);if(void 0!==s)return s;const n=e.strings.join($t);if(s=r.keyString.get(n),void 0===s){const i=e.getTemplateElement();Ce&&window.ShadyCSS.prepareTemplateDom(i,t),s=new Kt(e,i),r.keyString.set(n,s)}return r.stringsArray.set(e.strings,s),s},Fe=["html","svg"],Ue=new Set,ke=(t,e,i)=>{Ue.add(t);const r=i?i.element:document.createElement("template"),s=e.querySelectorAll("style"),{length:n}=s;if(0===n)return void window.ShadyCSS.prepareTemplateStyles(r,t);const a=document.createElement("style");for(let t=0;t<n;t++){const e=s[t];e.parentNode.removeChild(e),a.textContent+=e.textContent}(t=>{Fe.forEach(e=>{const i=Se.get(Ee(e,t));void 0!==i&&i.keyString.forEach(t=>{const{element:{content:e}}=t,i=new Set;Array.from(e.querySelectorAll("style")).forEach(t=>{i.add(t)}),Jt(t,i)})})})(t);const o=r.content;i?function(t,e,i=null){const{element:{content:r},parts:s}=t;if(null==i)return void r.appendChild(e);const n=document.createTreeWalker(r,133,null,!1);let a=te(s),o=0,h=-1;for(;n.nextNode();){h++;for(n.currentNode===i&&(o=Zt(e),i.parentNode.insertBefore(e,i));-1!==a&&s[a].index===h;){if(o>0){for(;-1!==a;)s[a].index+=o,a=te(s,a);return}a=te(s,a)}}}(i,a,o.firstChild):o.insertBefore(a,o.firstChild),window.ShadyCSS.prepareTemplateStyles(r,t);const h=o.querySelector("style");if(window.ShadyCSS.nativeShadow&&null!==h)e.insertBefore(h.cloneNode(!0),e.firstChild);else if(i){o.insertBefore(a,o.firstChild);const t=new Set;t.add(a),Jt(i,t)}};window.JSCompiler_renameProperty=(t,e)=>t;const Be={toAttribute(t,e){switch(e){case Boolean:return t?"":null;case Object:case Array:return null==t?t:JSON.stringify(t)}return t},fromAttribute(t,e){switch(e){case Boolean:return null!==t;case Number:return null===t?null:Number(t);case Object:case Array:return JSON.parse(t)}return t}},Le=(t,e)=>e!==t&&(e==e||t==t),Ne={attribute:!0,type:String,converter:Be,reflect:!1,hasChanged:Le};class Me extends HTMLElement{constructor(){super(),this.initialize()}static get observedAttributes(){this.finalize();const t=[];return this._classProperties.forEach((e,i)=>{const r=this._attributeNameForProperty(i,e);void 0!==r&&(this._attributeToPropertyMap.set(r,i),t.push(r))}),t}static _ensureClassProperties(){if(!this.hasOwnProperty(JSCompiler_renameProperty("_classProperties",this))){this._classProperties=new Map;const t=Object.getPrototypeOf(this)._classProperties;void 0!==t&&t.forEach((t,e)=>this._classProperties.set(e,t))}}static createProperty(t,e=Ne){if(this._ensureClassProperties(),this._classProperties.set(t,e),e.noAccessor||this.prototype.hasOwnProperty(t))return;const i="symbol"==typeof t?Symbol():"__"+t,r=this.getPropertyDescriptor(t,i,e);void 0!==r&&Object.defineProperty(this.prototype,t,r)}static getPropertyDescriptor(t,e,i){return{get(){return this[e]},set(r){const s=this[t];this[e]=r,this.requestUpdateInternal(t,s,i)},configurable:!0,enumerable:!0}}static getPropertyOptions(t){return this._classProperties&&this._classProperties.get(t)||Ne}static finalize(){const t=Object.getPrototypeOf(this);if(t.hasOwnProperty("finalized")||t.finalize(),this.finalized=!0,this._ensureClassProperties(),this._attributeToPropertyMap=new Map,this.hasOwnProperty(JSCompiler_renameProperty("properties",this))){const t=this.properties,e=[...Object.getOwnPropertyNames(t),..."function"==typeof Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(t):[]];for(const i of e)this.createProperty(i,t[i])}}static _attributeNameForProperty(t,e){const i=e.attribute;return!1===i?void 0:"string"==typeof i?i:"string"==typeof t?t.toLowerCase():void 0}static _valueHasChanged(t,e,i=Le){return i(t,e)}static _propertyValueFromAttribute(t,e){const i=e.type,r=e.converter||Be,s="function"==typeof r?r:r.fromAttribute;return s?s(t,i):t}static _propertyValueToAttribute(t,e){if(void 0===e.reflect)return;const i=e.type,r=e.converter;return(r&&r.toAttribute||Be.toAttribute)(t,i)}initialize(){this._updateState=0,this._updatePromise=new Promise(t=>this._enableUpdatingResolver=t),this._changedProperties=new Map,this._saveInstanceProperties(),this.requestUpdateInternal()}_saveInstanceProperties(){this.constructor._classProperties.forEach((t,e)=>{if(this.hasOwnProperty(e)){const t=this[e];delete this[e],this._instanceProperties||(this._instanceProperties=new Map),this._instanceProperties.set(e,t)}})}_applyInstanceProperties(){this._instanceProperties.forEach((t,e)=>this[e]=t),this._instanceProperties=void 0}connectedCallback(){this.enableUpdating()}enableUpdating(){void 0!==this._enableUpdatingResolver&&(this._enableUpdatingResolver(),this._enableUpdatingResolver=void 0)}disconnectedCallback(){}attributeChangedCallback(t,e,i){e!==i&&this._attributeToProperty(t,i)}_propertyToAttribute(t,e,i=Ne){const r=this.constructor,s=r._attributeNameForProperty(t,i);if(void 0!==s){const t=r._propertyValueToAttribute(e,i);if(void 0===t)return;this._updateState=8|this._updateState,null==t?this.removeAttribute(s):this.setAttribute(s,t),this._updateState=-9&this._updateState}}_attributeToProperty(t,e){if(8&this._updateState)return;const i=this.constructor,r=i._attributeToPropertyMap.get(t);if(void 0!==r){const t=i.getPropertyOptions(r);this._updateState=16|this._updateState,this[r]=i._propertyValueFromAttribute(e,t),this._updateState=-17&this._updateState}}requestUpdateInternal(t,e,i){let r=!0;if(void 0!==t){const s=this.constructor;i=i||s.getPropertyOptions(t),s._valueHasChanged(this[t],e,i.hasChanged)?(this._changedProperties.has(t)||this._changedProperties.set(t,e),!0!==i.reflect||16&this._updateState||(void 0===this._reflectingProperties&&(this._reflectingProperties=new Map),this._reflectingProperties.set(t,i))):r=!1}!this._hasRequestedUpdate&&r&&(this._updatePromise=this._enqueueUpdate())}requestUpdate(t,e){return this.requestUpdateInternal(t,e),this.updateComplete}async _enqueueUpdate(){this._updateState=4|this._updateState;try{await this._updatePromise}catch(t){}const t=this.performUpdate();return null!=t&&await t,!this._hasRequestedUpdate}get _hasRequestedUpdate(){return 4&this._updateState}get hasUpdated(){return 1&this._updateState}performUpdate(){if(!this._hasRequestedUpdate)return;this._instanceProperties&&this._applyInstanceProperties();let t=!1;const e=this._changedProperties;try{t=this.shouldUpdate(e),t?this.update(e):this._markUpdated()}catch(e){throw t=!1,this._markUpdated(),e}t&&(1&this._updateState||(this._updateState=1|this._updateState,this.firstUpdated(e)),this.updated(e))}_markUpdated(){this._changedProperties=new Map,this._updateState=-5&this._updateState}get updateComplete(){return this._getUpdateComplete()}_getUpdateComplete(){return this._updatePromise}shouldUpdate(t){return!0}update(t){void 0!==this._reflectingProperties&&this._reflectingProperties.size>0&&(this._reflectingProperties.forEach((t,e)=>this._propertyToAttribute(e,this[e],t)),this._reflectingProperties=void 0),this._markUpdated()}updated(t){}firstUpdated(t){}}Me.finalized=!0;const Ie=t=>e=>"function"==typeof e?((t,e)=>(window.customElements.define(t,e),e))(t,e):((t,e)=>{const{kind:i,elements:r}=e;return{kind:i,elements:r,finisher(e){window.customElements.define(t,e)}}})(t,e),Re=(t,e)=>"method"===e.kind&&e.descriptor&&!("value"in e.descriptor)?Object.assign(Object.assign({},e),{finisher(i){i.createProperty(e.key,t)}}):{kind:"field",key:Symbol(),placement:"own",descriptor:{},initializer(){"function"==typeof e.initializer&&(this[e.key]=e.initializer.call(this))},finisher(i){i.createProperty(e.key,t)}};function ze(t){return(e,i)=>void 0!==i?((t,e,i)=>{e.constructor.createProperty(i,t)})(t,e,i):Re(t,e)}function Oe(t){return ze({attribute:!1,hasChanged:null==t?void 0:t.hasChanged})}function De(t,e){return(i,r)=>{const s={get(){return this.renderRoot.querySelector(t)},enumerable:!0,configurable:!0};if(e){const e="symbol"==typeof r?Symbol():"__"+r;s.get=function(){return void 0===this[e]&&(this[e]=this.renderRoot.querySelector(t)),this[e]}}return void 0!==r?Ve(s,i,r):We(s,i)}}const Ve=(t,e,i)=>{Object.defineProperty(e,i,t)},We=(t,e)=>({kind:"method",placement:"prototype",key:e.key,descriptor:t}),He=window.ShadowRoot&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,$e=Symbol();class je{constructor(t,e){if(e!==$e)throw new Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=t}get styleSheet(){return void 0===this._styleSheet&&(He?(this._styleSheet=new CSSStyleSheet,this._styleSheet.replaceSync(this.cssText)):this._styleSheet=null),this._styleSheet}toString(){return this.cssText}}const qe=(t,...e)=>{const i=e.reduce((e,i,r)=>e+(t=>{if(t instanceof je)return t.cssText;if("number"==typeof t)return t;throw new Error(`Value passed to 'css' function must be a 'css' function result: ${t}. Use 'unsafeCSS' to pass non-literal values, but\n            take care to ensure page security.`)})(i)+t[r+1],t[0]);return new je(i,$e)};(window.litElementVersions||(window.litElementVersions=[])).push("2.4.0");const Ke={};class Ge extends Me{static getStyles(){return this.styles}static _getUniqueStyles(){if(this.hasOwnProperty(JSCompiler_renameProperty("_styles",this)))return;const t=this.getStyles();if(Array.isArray(t)){const e=(t,i)=>t.reduceRight((t,i)=>Array.isArray(i)?e(i,t):(t.add(i),t),i),i=e(t,new Set),r=[];i.forEach(t=>r.unshift(t)),this._styles=r}else this._styles=void 0===t?[]:[t];this._styles=this._styles.map(t=>{if(t instanceof CSSStyleSheet&&!He){const e=Array.prototype.slice.call(t.cssRules).reduce((t,e)=>t+e.cssText,"");return new je(String(e),$e)}return t})}initialize(){super.initialize(),this.constructor._getUniqueStyles(),this.renderRoot=this.createRenderRoot(),window.ShadowRoot&&this.renderRoot instanceof window.ShadowRoot&&this.adoptStyles()}createRenderRoot(){return this.attachShadow({mode:"open"})}adoptStyles(){const t=this.constructor._styles;0!==t.length&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow?He?this.renderRoot.adoptedStyleSheets=t.map(t=>t instanceof CSSStyleSheet?t:t.styleSheet):this._needsShimAdoptedStyleSheets=!0:window.ShadyCSS.ScopingShim.prepareAdoptedCssText(t.map(t=>t.cssText),this.localName))}connectedCallback(){super.connectedCallback(),this.hasUpdated&&void 0!==window.ShadyCSS&&window.ShadyCSS.styleElement(this)}update(t){const e=this.render();super.update(t),e!==Ke&&this.constructor.render(e,this.renderRoot,{scopeName:this.localName,eventContext:this}),this._needsShimAdoptedStyleSheets&&(this._needsShimAdoptedStyleSheets=!1,this.constructor._styles.forEach(t=>{const e=document.createElement("style");e.textContent=t.cssText,this.renderRoot.appendChild(e)}))}render(){return Ke}}Ge.finalized=!0,Ge.render=(t,e,i)=>{if(!i||"object"!=typeof i||!i.scopeName)throw new Error("The `scopeName` option is required.");const r=i.scopeName,s=Ae.has(e),n=Ce&&11===e.nodeType&&!!e.host,a=n&&!Ue.has(r),o=a?document.createDocumentFragment():e;if(((t,e,i)=>{let r=Ae.get(e);void 0===r&&(Ht(e,e.firstChild),Ae.set(e,r=new fe(Object.assign({templateFactory:_e},i))),r.appendInto(e)),r.setValue(t),r.commit()})(t,o,Object.assign({templateFactory:Te(r)},i)),a){const t=Ae.get(o);Ae.delete(o);const i=t.value instanceof ae?t.value.template:void 0;ke(r,o,i),Ht(e,e.firstChild),e.appendChild(o),Ae.set(e,t)}!s&&n&&window.ShadyCSS.styleElement(e.host)};let Xe=class extends(Mt(Ge)){constructor(){super(),this._width="auto",this._cssWidth="auto",this._progress=0,this._counter="",this._isLoading=!1,this._isError=!1,this._isPlaying=!1,this._isMuted=!1,this._volumeLevel=0,this._isPlayerAvailable=!1,this.handleResize=t=>{this.updateCanvasSize()},this.handleKeyInput=t=>{switch(t.preventDefault(),t.key.toLowerCase()){case" ":this.togglePlay();break;case"a":case"arrowleft":t.shiftKey?this.firstFrame():this.prevFrame();break;case"d":case"arrowright":t.shiftKey?this.lastFrame():this.nextFrame()}},this.handlePlayToggle=t=>{this.togglePlay(),this.focus()},this.handleMuteToggle=t=>{this.toggleMuted(),this.focus()},this.handleProgressSliderChange=t=>{this.seek(t.detail.value),this.focus()},this.handleProgressSliderInputStart=()=>{this.startSeek(),this.focus()},this.handleProgressSliderInputEnd=()=>{this.endSeek(),this.focus()},this.handleVolumeBarChange=t=>{this.setVolume(t.detail.value),this.focus()},this._resizeObserver=new ResizeObserver(this.handleResize)}static get styles(){return qe`:host{display:inline-block}.Player{display:inline-block;position:relative;font-family:var(--flipnote-player-font-family,sans-serif)}.CanvasArea{position:relative}.PlayerCanvas{position:relative;display:block}.Overlay{position:absolute;top:0;left:0;background:#ebf0f3;color:#4b4c53;width:100%;height:100%;display:flex;justify-content:center;align-items:center}.Overlay--error{background:#ff8b8b;color:#ca2a32}@keyframes spin{from{transform:rotateZ(0)}to{transform:rotateZ(360deg)}}.LoaderIcon{animation:spin infinite 1.2s linear}.Controls{background:var(--flipnote-player-controls-background,none)}.MuteIcon{width:28px;height:28px}.Controls__groupLeft,.Controls__groupRight,.Controls__row{display:flex;align-items:center}.Controls__groupLeft{margin-right:auto}.Controls__groupRight{margin-left:auto}.Controls__playButton{height:32px;width:32px;padding:2px}.MuteIcon{width:28px;height:28px}.LoaderIcon{width:40px;height:40px}.Controls.Controls--compact{margin:6px 0}.Controls__frameCounter{min-width:90px;font-variant-numeric:tabular-nums}.Controls__progressBar{flex:1}.Controls--compact .Controls__playButton{margin-right:8px}.Controls--compact .Controls__progressBar{flex:1}.Controls--default .Controls__playButton{margin-right:8px}.Controls--default .Controls__volumeBar{width:70px;margin-left:8px}.Button{border:0;padding:0;outline:0;-webkit-appearance:none;display:block;font-family:inherit;font-size:inherit;text-align:center;cursor:pointer;background:var(--flipnote-player-button-background,#ffd3a6);color:var(--flipnote-player-button-color,#f36a2d);border-radius:4px}.Button flipnote-player-icon{display:block}`}get width(){return this._width}set width(t){const e=this._width;var i;this._width=t,this._cssWidth=isNaN(+t)?t:t+"px",i=()=>this.updateCanvasSize(),c?y(()=>y(()=>i())):i(),this.requestUpdate("width",e)}get src(){return this._playerSrc}set src(t){const e=this._playerSrc;this._isPlayerAvailable&&(this.player.src=t),this._playerSrc=t,this.requestUpdate("src",e)}get autoplay(){return this.player.autoplay}set autoplay(t){const e=this.player.autoplay;this.player.autoplay=t,this.requestUpdate("autoplay",e)}render(){return xe`<style>:host{width:${this._cssWidth}}</style><div class="Player" @keydown="${this.handleKeyInput}"><div class="CanvasArea" @click="${this.handlePlayToggle}"><div class="PlayerCanvas" id="canvasWrapper"></div>${this._isLoading?xe`<div class="Overlay"><flipnote-player-icon icon="loader" class="LoaderIcon"></flipnote-player-icon></div>`:""} ${this._isError?xe`<div class="Overlay Overlay--error">Error</div>`:""}</div>${this.renderControls()}</div>`}renderControls(){return"compact"===this.controls?xe`<div class="Controls Controls--compact Controls__row"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this._isPlaying?"pause":"play"}"></flipnote-player-icon></button><flipnote-player-slider class="Controls__progressBar" value="${this._progress}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></div>`:xe`<div class="Controls Controls--default"><flipnote-player-slider class="Controls__progressBar" value="${this._progress}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></flipnote-player-slider><div class="Controls__row"><div class="Controls__groupLeft"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this._isPlaying?"pause":"play"}"></flipnote-player-icon></button> <span class="Controls__frameCounter">${this._counter}</span></div><div class="Controls__groupRight"><flipnote-player-icon class="MuteIcon" @click="${this.handleMuteToggle}" icon="${this._isMuted?"volumeOff":"volumeOn"}"></flipnote-player-icon><flipnote-player-slider class="Controls__volumeBar" value="${this._volumeLevel}" @change="${this.handleVolumeBarChange}"></flipnote-player-slider></div></div></div>`}firstUpdated(e){const i=new Nt(this.playerCanvasWrapper,256,192);this._resizeObserver.observe(this),this.player=i,i.on(t.PlayerEvent.LoadStart,()=>{this._isLoading=!0}),i.on(t.PlayerEvent.Load,()=>{this.updateCanvasSize()}),i.on(t.PlayerEvent.Error,()=>{this._isLoading=!1,this._isError=!0}),i.on([t.PlayerEvent.Load,t.PlayerEvent.Close,t.PlayerEvent.Progress],()=>{this._isLoading=!1,this._isError=!1,this._progress=i.getProgress()/100,this._counter=i.getFrameCounter()}),i.on(t.PlayerEvent.Play,()=>{this._isPlaying=!0}),i.on(t.PlayerEvent.Pause,()=>{this._isPlaying=!1}),i.on([t.PlayerEvent.Load,t.PlayerEvent.VolumeChange],()=>{this._volumeLevel=i.volume,this._isMuted=i.muted}),i.on(t.PlayerEvent.__Any,(t,e)=>{this.dispatchEvent(new Event(t))}),this._playerSrc&&i.load(this._playerSrc),this._isPlayerAvailable=!0}disconnectedCallback(){this._resizeObserver.disconnect(),this.destroy()}updateCanvasSize(){const t=this._isPlayerAvailable;let e=256;"auto"===this._width&&t&&this.player.isNoteLoaded?e=this.player.note.imageWidth:"auto"!==this._width&&(e=this.getBoundingClientRect().width),t&&this.player.resize(e,.75*e)}};Vt([ze({type:String})],Xe.prototype,"controls",void 0),Vt([ze({type:String})],Xe.prototype,"width",null),Vt([ze({type:String})],Xe.prototype,"src",null),Vt([ze({type:Boolean})],Xe.prototype,"autoplay",null),Vt([Oe()],Xe.prototype,"_width",void 0),Vt([Oe()],Xe.prototype,"_cssWidth",void 0),Vt([Oe()],Xe.prototype,"_progress",void 0),Vt([Oe()],Xe.prototype,"_counter",void 0),Vt([Oe()],Xe.prototype,"_isLoading",void 0),Vt([Oe()],Xe.prototype,"_isError",void 0),Vt([Oe()],Xe.prototype,"_isPlaying",void 0),Vt([Oe()],Xe.prototype,"_isMuted",void 0),Vt([Oe()],Xe.prototype,"_volumeLevel",void 0),Vt([De("#canvasWrapper")],Xe.prototype,"playerCanvasWrapper",void 0),Xe=Vt([Ie("flipnote-player")],Xe);class Ye{constructor(t){this.classes=new Set,this.changed=!1,this.element=t;const e=(t.getAttribute("class")||"").split(/\s+/);for(const t of e)this.classes.add(t)}add(t){this.classes.add(t),this.changed=!0}remove(t){this.classes.delete(t),this.changed=!0}commit(){if(this.changed){let t="";this.classes.forEach(e=>t+=e+" "),this.element.setAttribute("class",t)}}}const Qe=new WeakMap,Je=ie(t=>e=>{if(!(e instanceof pe)||e instanceof ye||"class"!==e.committer.name||e.committer.parts.length>1)throw new Error("The `classMap` directive must be used in the `class` attribute and must be the only part in the attribute.");const{committer:i}=e,{element:r}=i;let s=Qe.get(e);void 0===s&&(r.setAttribute("class",i.strings.join(" ")),Qe.set(e,s=new Set));const n=r.classList||new Ye(r);s.forEach(e=>{e in t||(n.remove(e),s.delete(e))});for(const e in t){const i=t[e];i!=s.has(e)&&(i?(n.add(e),s.add(e)):(n.remove(e),s.delete(e)))}"function"==typeof n.commit&&n.commit()}),Ze=new WeakMap,ti=ie(t=>e=>{if(!(e instanceof pe)||e instanceof ye||"style"!==e.committer.name||e.committer.parts.length>1)throw new Error("The `styleMap` directive must be used in the style attribute and must be the only part in the attribute.");const{committer:i}=e,{style:r}=i.element;let s=Ze.get(e);void 0===s&&(r.cssText=i.strings.join(" "),Ze.set(e,s=new Set)),s.forEach(e=>{e in t||(s.delete(e),-1===e.indexOf("-")?r[e]=null:r.removeProperty(e))});for(const e in t)s.add(e),-1===e.indexOf("-")?r[e]=t[e]:r.setProperty(e,t[e])});let ei=class extends Ge{constructor(){super(...arguments),this.value=0,this.orientation="horizontal",this.isActive=!1,this.onSliderInputStart=t=>{t.preventDefault(),this.isActive=!0,document.addEventListener("mousemove",this.onSliderInput),document.addEventListener("mouseup",this.onSliderInputEnd),this.dispatch("inputstart"),this.onSliderInput(t)},this.onSliderInputEnd=t=>{t.preventDefault(),document.removeEventListener("mousemove",this.onSliderInput),document.removeEventListener("mouseup",this.onSliderInputEnd),this.dispatch("inputend"),this.onSliderInput(t),this.isActive=!1},this.onSliderInput=t=>{t.preventDefault();const e=this.sliderElement.getBoundingClientRect();let i;if("horizontal"===this.orientation){const r=e.height/2,s=e.width-2*r,n=(t.clientX-e.left-r)/s;i=Math.max(0,Math.min(n,1))}else if("vertical"===this.orientation){const r=e.width/2,s=e.height-2*r,n=1-(t.clientY-e.top-r)/s;i=Math.max(0,Math.min(n,1))}this.value!==i&&this.dispatch("change",{value:i})}}static get styles(){return qe`.Slider{padding:4px 0;cursor:pointer}.Slider--vertical{height:100px;width:14px}.Slider__track{position:relative;border-radius:3px;background:var(--flipnote-player-slider-track,#ffd3a6)}.Slider--horizontal .Slider__track{height:4px;margin:6px 0}.Slider--vertical .Slider__track{width:4px;height:100%;margin:0 6px}.Slider__level{position:absolute;width:100%;height:6px;margin:-1px;border-radius:8px;background:var(--flipnote-player-slider-level,#f36a2d)}.Slider--horizontal .Slider__level{width:100%;height:6px}.Slider--vertical .Slider__level{width:6px;height:100%;bottom:0}.Slider__handle{display:none;position:absolute;height:10px;width:10px;border-radius:5px;box-sizing:border-box;border:3px solid var(--flipnote-player-slider-handle,#f36a2d);background:var(--flipnote-player-slider-handle-fill,#fff)}.Slider--isActive .Slider__handle,.Slider:hover .Slider__handle{display:block}.Slider--horizontal .Slider__handle{top:0;margin-top:-3px;margin-left:-6px}.Slider--vertical .Slider__handle{left:0;margin-bottom:-6px;margin-left:-3px}`}render(){const t=100*this.value+"%",e="horizontal"===this.orientation?"width":"height",i="horizontal"===this.orientation?"left":"bottom",r={Slider:!0,"Slider--horizontal":"horizontal"===this.orientation,"Slider--vertical":"vertical"===this.orientation,"Slider--isActive":this.isActive};return xe`<div class="${Je(r)}" @mousedown="${this.onSliderInputStart}"><div class="Slider__track"><div class="Slider__level" style="${ti({[e]:t})}"></div><div class="Slider__handle" style="${ti({[i]:t})}"></div></div></div>`}dispatch(t,e){const i=new CustomEvent(t,{detail:e});this.dispatchEvent(i)}};Vt([ze({type:Number})],ei.prototype,"value",void 0),Vt([ze({type:String})],ei.prototype,"orientation",void 0),Vt([Oe()],ei.prototype,"isActive",void 0),Vt([De(".Slider__track")],ei.prototype,"sliderElement",void 0),ei=Vt([Ie("flipnote-player-slider")],ei);const ii=new WeakMap,ri=window.navigator.userAgent.indexOf("Trident/")>0,si=ie(t=>e=>{if(!(e instanceof fe))throw new Error("unsafeSVG can only be used in text bindings");const i=ii.get(e);if(void 0!==i&&ue(t)&&t===i.value&&e.value===i.fragment)return;const r=document.createElement("template"),s=r.content;let n;ri?(r.innerHTML=`<svg>${t}</svg>`,n=s.firstChild):(n=document.createElementNS("http://www.w3.org/2000/svg","svg"),s.appendChild(n),n.innerHTML=t),s.removeChild(n),((t,e,i=null,r=null)=>{for(;e!==i;){const i=e.nextSibling;t.insertBefore(e,r),e=i}})(s,n.firstChild);const a=document.importNode(s,!0);e.setValue(a),ii.set(e,{value:t,fragment:a})});function ni(t){return t.replace(/<svg ([^>]*)>/,(t,e)=>`<svg ${e} class="Icon" style="fill:currentColor">`)}const ai={play:ni('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M74.137 48h8.985a4 4 0 012.129.614l91.994 57.84c7.48 4.704 9.732 14.582 5.028 22.062a16 16 0 01-5.028 5.03l-91.994 57.84a4 4 0 01-2.13.614h-8.984C68.54 192 64 187.461 64 181.863V58.137C64 52.54 68.539 48 74.137 48z"/></svg>'),pause:ni('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M64 48h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16H64c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16zm88 0h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16h-24c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16z"/></svg>'),loader:ni('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M120 176c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16zm48.497-28c4.419-7.653 14.204-10.275 21.857-5.856 7.653 4.418 10.275 14.203 5.856 21.856-4.418 7.653-14.203 10.275-21.856 5.856-7.653-4.418-10.275-14.203-5.857-21.856zm-118.85-5.856c7.652-4.419 17.437-1.797 21.856 5.856 4.418 7.653 1.796 17.438-5.857 21.856-7.653 4.419-17.438 1.797-21.856-5.856-4.419-7.653-1.797-17.438 5.856-21.856zm124.707-72c7.653-4.419 17.438-1.797 21.856 5.856 4.419 7.653 1.797 17.438-5.856 21.856-7.653 4.419-17.438 1.797-21.857-5.856-4.418-7.653-1.796-17.438 5.857-21.856zM43.79 76c4.418-7.653 14.203-10.275 21.856-5.856C73.3 74.562 75.921 84.347 71.503 92c-4.419 7.653-14.204 10.275-21.857 5.856C41.993 93.438 39.371 83.653 43.79 76zM120 32c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16z"/></svg>'),volumeOn:ni('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M113.3 42.022a10 10 0 0110-1.2 10 10 0 015.7 9v140a10 10 0 01-5.7 9 9.116 9.116 0 01-4.3 1.001 10.009 10.009 0 01-6.2-2.2l-47.3-37.8H29c-5.523 0-10-4.478-10-10v-60c0-5.524 4.477-10 10-10h36.5zm82.986 17.298c17.008 16.234 25.715 36.022 25.715 58.68 0 22.37-8.465 43.147-24.992 61.928-4.378 4.975-11.96 5.459-16.936 1.08-4.975-4.378-5.46-11.96-1.08-16.936C191.798 149.52 198 134.297 198 118c0-16.009-5.96-29.554-18.286-41.32-4.794-4.576-4.97-12.172-.395-16.966 4.577-4.794 12.172-4.97 16.966-.394zM165.201 87.4c10.904 8.178 16.8 18.987 16.8 31.6 0 12.433-5.712 23.38-16.318 32.219-5.091 4.242-12.658 3.555-16.9-1.537-4.174-5.008-3.577-12.41 1.289-16.69l.246-.21c5.395-4.496 7.683-8.881 7.683-13.782 0-4.613-2.01-8.403-6.857-12.14l-.343-.26c-5.302-3.976-6.377-11.498-2.4-16.8 3.976-5.302 11.498-6.376 16.8-2.4z"/></svg>'),volumeOff:ni('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M123.3 40.822a10 10 0 00-10 1.2l-47.8 37.8H29c-5.523 0-10 4.477-10 10v60c0 5.523 4.477 10 10 10h36.5l47.3 37.8a10.009 10.009 0 006.2 2.201 9.116 9.116 0 004.3-1 10 10 0 005.7-9v-140a10 10 0 00-5.7-9zm70.451 50.462c4.702-4.454 12.126-4.377 16.734.23 4.608 4.609 4.685 12.033.23 16.735l-.23.236L198.971 120l11.514 11.515c4.687 4.686 4.687 12.284 0 16.97-4.608 4.608-12.032 4.685-16.734.23l-.236-.23L182 136.971l-11.515 11.514-.236.23c-4.702 4.455-12.126 4.378-16.734-.23-4.608-4.608-4.685-12.032-.23-16.734l.23-.236L165.029 120l-11.514-11.515c-4.687-4.686-4.687-12.284 0-16.97 4.608-4.608 12.032-4.685 16.734-.23l.236.23L182 103.029l11.515-11.514.236-.23z"/></svg>')};let oi=class extends Ge{constructor(){super(...arguments),this.icon="loader"}static get styles(){return qe`.Icon{width:100%;height:100%;color:var(--flipnote-player-icon-color,#f36a2d)}`}render(){return xe`${si(ai[this.icon])}`}};Vt([ze({type:String})],oi.prototype,"icon",void 0),oi=Vt([Ie("flipnote-player-icon")],oi);let hi=class extends Ge{constructor(){super(...arguments),this._src="",this._frame="0",this.cropped=!1,this.gifUrl="",this.imgTitle=""}static get styles(){return qe`.Image{width:inherit;height:inherit;image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges;-ms-interpolation-mode:nearest-neighbor}`}set src(t){this.load(t)}get src(){return this._src}set frame(t){this._frame=t,this.note&&this.loadNote(this.note)}get frame(){return this._frame}render(){return xe`<img class="Image" src="${this.gifUrl}" alt="${this.imgTitle}" title="${this.imgTitle}">`}revokeUrl(){this.gif&&this.gif.dataUrl&&(this.gif.revokeUrl(),this.gifUrl="")}loadNote(t){this.note=t,this.revokeUrl();const e=this._frame;if("all"===e)this.gif=Ot.fromFlipnote(t),this.gifUrl=this.gif.getUrl();else if("thumb"===e)this.gif=Ot.fromFlipnoteFrame(t,t.thumbFrameIndex),this.gifUrl=this.gif.getUrl();else if(!isNaN(+e)){const i=parseInt(e);this.gif=Ot.fromFlipnoteFrame(t,i),this.gifUrl=this.gif.getUrl()}this.gifUrl?(this.dispatchLoad(),this.imgTitle=this.getTitle(t)):this.dispatchError("Invalid frame attribute")}load(t){this._src=t,this.note=void 0;X(t,{borderCrop:"true"===this.getAttribute("cropped")}).then(t=>this.loadNote(t)).catch(t=>this.dispatchError(t))}disconnectedCallback(){this.revokeUrl()}getTitle(t){return t.isComment?"Comment by "+t.meta.current.username:t.isFolderIcon?"Folder icon":"Flipnote by "+t.meta.current.username}dispatchLoad(){this.dispatchEvent(new Event("load"))}dispatchError(t){throw this.dispatchEvent(new ErrorEvent("error",{error:t})),new Error(t)}};Vt([ze()],hi.prototype,"src",null),Vt([ze()],hi.prototype,"frame",null),Vt([ze({type:Boolean})],hi.prototype,"cropped",void 0),Vt([Oe()],hi.prototype,"gifUrl",void 0),Vt([Oe()],hi.prototype,"imgTitle",void 0),hi=Vt([Ie("flipnote-image")],hi);const li=Xe,ui=hi;t.GifImage=Ot,t.ImageComponent=ui,t.KwzParser=K,t.Player=Nt,t.PlayerComponent=li,t.PlayerMixin=Mt,t.PpmParser=z,t.WavAudio=Dt,t.WebglCanvas=kt,t.parseSource=X,t.utils=B,t.version="5.5.1",Object.defineProperty(t,"__esModule",{value:!0})}));
