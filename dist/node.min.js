/*!
 * flipnote.js v3.2.0
 * Browser-based playback of .ppm and .kwz animations from Flipnote Studio and Flipnote Studio 3D
 * 2018 - 2019 James Daniel
 * github.com/jaames/flipnote.js
 * Flipnote Studio is (c) Nintendo Co., Ltd.
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.flipnote=e():t.flipnote=e()}("undefined"!=typeof self?self:this,function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)r.d(i,s,function(e){return t[e]}.bind(null,s));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=7)}([function(t,e,r){"use strict";r.r(e);var i=function(){function t(){this.page=-1,this.pages=[],this.cursor=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(t.pageSize),this.cursor=0},t.prototype.getData=function(){var e=this,r=new Uint8Array(this.page*t.pageSize+this.cursor);return this.pages.map(function(i,s){s===e.page?r.set(i.slice(0,e.cursor),s*t.pageSize):r.set(i,s*t.pageSize)}),r},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(e){this.cursor>=t.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=e},t.prototype.writeBytes=function(t,e,r){for(var i=r||t.length,s=e||0;s<i;s++)this.writeByte(t[s])},t.pageSize=4096,t}(),s=r(1);r.d(e,"ByteArray",function(){return i}),r.d(e,"SeekOrigin",function(){return s.b}),r.d(e,"DataStream",function(){return s.a})},function(t,e,r){"use strict";var i;r.d(e,"b",function(){return i}),r.d(e,"a",function(){return s}),function(t){t[t.Begin=0]="Begin",t[t.Current=1]="Current",t[t.End=2]="End"}(i||(i={}));var s=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.cursor=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!0,configurable:!0}),t.prototype.seek=function(t,e){switch(e){case i.End:this.cursor=this.data.byteLength+t;break;case i.Current:this.cursor+=t;break;case i.Begin:default:this.cursor=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.cursor);return this.cursor+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.cursor,t),this.cursor+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.cursor);return this.cursor+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.cursor,t),this.cursor+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var e=this.data.getUint16(this.cursor,t);return this.cursor+=2,e},t.prototype.writeUint16=function(t,e){void 0===e&&(e=!0),this.data.setUint16(this.cursor,t,e),this.cursor+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var e=this.data.getInt16(this.cursor,t);return this.cursor+=2,e},t.prototype.writeInt16=function(t,e){void 0===e&&(e=!0),this.data.setInt16(this.cursor,t,e),this.cursor+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var e=this.data.getUint32(this.cursor,t);return this.cursor+=4,e},t.prototype.writeUint32=function(t,e){void 0===e&&(e=!0),this.data.setUint32(this.cursor,t,e),this.cursor+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var e=this.data.getInt32(this.cursor,t);return this.cursor+=4,e},t.prototype.writeInt32=function(t,e){void 0===e&&(e=!0),this.data.setInt32(this.cursor,t,e),this.cursor+=4},t.prototype.readBytes=function(t){var e=new Uint8Array(this.data.buffer,this.cursor,t);return this.cursor+=e.byteLength,e},t.prototype.writeBytes=function(t){var e=this;t.forEach(function(t){return e.writeUint8(t)})},t.prototype.readHex=function(t,e){void 0===e&&(e=!1);for(var r=this.readBytes(t),i=[],s=0;s<r.length;s++)i.push(r[s].toString(16).padStart(2,"0"));return e&&i.reverse(),i.join("").toUpperCase()},t.prototype.readUtf8=function(t){for(var e=this.readBytes(t),r="",i=0;i<e.length;i++){var s=e[i];if(0===s)break;r+=String.fromCharCode(s)}return r},t.prototype.writeUtf8=function(t){for(var e=0;e<t.length;e++){var r=t.charCodeAt(e);this.writeUint8(r)}},t.prototype.readUtf16=function(t){for(var e=new Uint16Array(this.data.buffer,this.cursor,t),r="",i=0;i<e.length;i++){var s=e[i];if(0==s)break;r+=String.fromCharCode(s)}return this.cursor+=e.byteLength,r},t}()},function(t,e,r){"use strict";var i=[{matches:function(t){return"string"==typeof t},load:function(t,e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onreadystatechange=function(t){4===i.readyState&&(i.status>=200&&i.status<300?e(i.response):r({type:"httpError",status:i.status,statusText:i.statusText}))},i.send(null)}},{matches:function(t){return"undefined"!=typeof File&&t instanceof File},load:function(t,e,r){if("undefined"!=typeof FileReader){var i=new FileReader;i.onload=function(t){e(i.result)},i.onerror=function(t){r({type:"fileReadError"})},i.readAsArrayBuffer(t)}else r()}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,r){e(t)}}];for(var s=r(1),n=new Int8Array([-1,2,-1,2]),a=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),o=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),h=new Int16Array(360),f=0;f<4;f++)for(var u=0;u<90;u++){var c=(p=o[u])>>3;1&f&&(c+=p),2&f&&(c=-c),h[f+4*u]=c}var d=new Int16Array(1440);for(f=0;f<16;f++)for(u=0;u<90;u++){var p;c=(p=o[u])>>3;4&f&&(c+=p),2&f&&(c+=p>>1),1&f&&(c+=p>>2),8&f&&(c=-c),d[f+16*u]=c}for(var l=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),y=[null,.5,1,2,4,6,12,20,30],g={WHITE:[255,255,255],BLACK:[14,14,14],RED:[255,42,42],BLUE:[10,57,255]},m=function(t){function e(r){var i=t.call(this,r)||this;return i.type=e.type,i.width=e.width,i.height=e.height,i.palette=g,i.globalPalette=e.globalPalette,i.sampleRate=e.sampleRate,i.prevDecodedFrame=null,i.decodeHeader(),i.decodeAnimationHeader(),i.decodeSoundHeader(),i.decodeMeta(),i.layers=[new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height)],i.prevLayers=[new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height)],i.prevDecodedFrame=null,i}return l(e,t),e.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},e.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},e.prototype.readFilename=function(){return[this.readHex(3),this.readUtf8(13),this.readUint16().toString().padStart(3,"0")].join("_")},e.prototype.readLineEncoding=function(){for(var t=new Uint8Array(e.height),r=0;r<48;r++)for(var i=this.readUint8(),s=0;s<8;s+=2)t[4*r+s/2]=i>>s&3;return t},e.prototype.decodeHeader=function(){this.seek(0);this.readUint32();this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},e.prototype.decodeMeta=function(){this.seek(16);var t=this.readUint16(),e=this.readInt16(),r=this.readUtf16(11),i=this.readUtf16(11),s=this.readUtf16(11),n=this.readHex(8,!0),a=this.readHex(8,!0),o=this.readFilename(),h=this.readFilename(),f=this.readHex(8,!0);this.seek(154);var u=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=e,this.meta={lock:1===t,loop:1==(c>>1&1),frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:e,timestamp:u,spinoff:a!==n||a!==f,root:{filename:null,username:r,fsid:f},parent:{username:i,fsid:n,filename:o},current:{username:s,fsid:a,filename:h}}},e.prototype.decodeAnimationHeader=function(){var t=this;this.seek(1696);var e=this.readUint16();this.seek(1704),this.frameOffsets=new Uint32Array(e/4).map(function(r){return 1704+e+t.readUint32()})},e.prototype.decodeSoundHeader=function(){var t=1696+this.frameDataLength+this.frameCount;t%4!=0&&(t+=4-t%4),this.seek(t);var e=this.readUint32(),r=this.readUint32(),i=this.readUint32(),s=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),t+=32,this.framerate=y[this.frameSpeed],this.bgmrate=y[this.bgmSpeed],this.soundMeta={bgm:{offset:t,length:e},se1:{offset:t+=e,length:r},se2:{offset:t+=r,length:i},se3:{offset:t+=i,length:s}}},e.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},e.prototype.getFramePalette=function(t){this.seek(this.frameOffsets[t]);var e=this.palette,r=this.readUint8(),i=1&r,s=[e.BLACK,1==i?e.BLACK:e.WHITE,e.RED,e.BLUE];return[1==i?e.WHITE:e.BLACK,s[r>>1&3],s[r>>3&3]]},e.prototype.getLayerOrder=function(t){return[0,1]},e.prototype.decodeFrame=function(t){0===t||this.prevDecodedFrame===t-1||this.isNewFrame(t)||this.decodeFrame(t-1),this.seek(this.frameOffsets[t]);var r=this.readUint8(),i=r>>7&1,s=r>>5&3,n=0,a=0;this.prevLayers[0].set(this.layers[0]),this.prevLayers[1].set(this.layers[1]),this.prevDecodedFrame=t,this.layers[0].fill(0),this.layers[1].fill(0),s&&(n=this.readInt8(),a=this.readInt8());for(var o=[this.readLineEncoding(),this.readLineEncoding()],h=0;h<2;h++)for(var f=this.layers[h],u=0;u<e.height;u++){var c=o[h][u],d=u*e.width;switch(c){case 0:break;case 1:case 2:var p=this.readUint32(!1);for(2==c&&f.fill(255,d,d+e.width);4294967295&p;){if(2147483648&p)for(var l=this.readUint8(),y=0;y<8;y++)f[d+y]=l>>y&1?255:0;d+=8,p<<=1}break;case 3:for(;d<(u+1)*e.width;){for(l=this.readUint8(),y=0;y<8;y++)f[d+y]=l>>y&1?255:0;d+=8}}}if(!i)for(var g=void 0,m=void 0,w=0;w<e.height;w++)if(!(w-a<0)){if(w-a>=e.height)break;for(var v=0;v<e.width;v++)if(!(v-n<0)){if(v-n>=e.width)break;m=(g=v+w*e.width)-(n+a*e.width),this.layers[0][g]^=this.prevLayers[0][m],this.layers[1][g]^=this.prevLayers[1][m]}}return this.layers},e.prototype.getLayerPixels=function(t,r){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var i=this.layers[r],s=new Uint8Array(e.width*e.height),n=r+1,a=0;a<s.length;a++)0!==i[a]&&(s[a]=n);return s},e.prototype.getFramePixels=function(t,r){var i;(void 0===r&&(r=!1),r)?i=this.getFramePalette(t).map(function(t){return e.globalPalette.indexOf(t)}):i=[0,1,2];var s=this.decodeFrame(t),n=new Uint8Array(e.width*e.height);n.fill(i[0]);for(var a=0;a<n.length;a++){var o=s[0][a];s[1][a]&&(n[a]=i[2]),o&&(n[a]=i[1])}return n},e.prototype.hasAudioTrack=function(t){var e=["bgm","se1","se2","se3"][t];return this.soundMeta[e].length>0},e.prototype.decodeAudio=function(t){for(var e,r,i,s=this.soundMeta[t],n=new Uint8Array(this.buffer,s.offset,s.length),o=new Int16Array(2*n.length),h=0,f=0,u=0,c=0;c<n.length;c++)for(var p=n[c],l=0;l<8;)r=f+d[(e=p>>l&15)+16*u],i=u+a[e],i=Math.max(0,Math.min(i,79)),r=Math.max(-32767,Math.min(r,32767)),o[h]=r,h+=1,u=i,f=r,l+=4;return o},e.prototype.decodeSoundFlags=function(){var t=this;return this.seek(1696+this.frameDataLength),new Array(this.frameCount).fill([]).map(function(e){var r=t.readUint8();return[1&r,r>>1&1,r>>2&1]})},e.type="PPM",e.sampleRate=8192,e.width=256,e.height=192,e.globalPalette=[g.BLACK,g.WHITE,g.RED,g.BLUE],e}(s.a),w=new Uint16Array([0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740]),v=new Uint16Array([0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100]),b=new Uint16Array(6561),U=[0,3,7,1,4,8,2,5,6],_=0,A=0;A<9;A++)for(var x=0;x<9;x++)for(var B=0;B<9;B++)for(var F=0;F<9;F++)b[_]=9*(9*(9*U[A]+U[x])+U[B])+U[F],_++;var E=new Uint16Array(52488),P=[0,65280,255],S=0;for(A=0;A<3;A++)for(x=0;x<3;x++)for(B=0;B<3;B++)for(F=0;F<3;F++)for(var C=0;C<3;C++)for(var L=0;L<3;L++)for(var D=0;D<3;D++)for(var I=0;I<3;I++)E.set([P[x],P[A],P[F],P[B],P[L],P[C],P[I],P[D]],S),S+=8;var O=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),k=[.2,.5,1,2,4,6,8,12,20,24,30],M={WHITE:[255,255,255],BLACK:[16,16,16],RED:[255,16,16],YELLOW:[255,231,0],GREEN:[0,134,49],BLUE:[0,56,206],NONE:[255,255,255]},H=function(t){function e(r){var i=t.call(this,r)||this;return i.type=e.type,i.width=e.width,i.height=e.height,i.palette=M,i.globalPalette=e.globalPalette,i.sampleRate=e.sampleRate,i.prevDecodedFrame=null,i.bitIndex=0,i.bitValue=0,i.layers=[new Uint16Array(e.width*e.height),new Uint16Array(e.width*e.height),new Uint16Array(e.width*e.height)],i.bitIndex=0,i.bitValue=0,i.load(),i}return O(e,t),e.prototype.load=function(){this.seek(0),this.sections={},this.frameMeta=[];for(var t=this.byteLength-256,e=0,r=0;e<t&&r<6;){this.seek(e);var i=this.readUtf8(4).substring(0,3),s=this.readUint32();this.sections[i]={offset:e,length:s},e+=s+8,r+=1}this.decodeMeta(),this.decodeFrameMeta(),this.decodeSoundHeader()},e.prototype.readBits=function(t){if(this.bitIndex+t>16){var e=this.readUint16();this.bitValue|=e<<16-this.bitIndex,this.bitIndex-=16}var r=(1<<t)-1,i=this.bitValue&r;return this.bitValue>>=t,this.bitIndex+=t,i},e.prototype.decodeMeta=function(){this.seek(this.sections.KFH.offset+12);var t=new Date(1e3*(this.readUint32()+946684800)),e=new Date(1e3*(this.readUint32()+946684800)),r=(this.readUint32(),this.readHex(10)),i=this.readHex(10),s=this.readHex(10),n=this.readUtf16(11),a=this.readUtf16(11),o=this.readUtf16(11),h=this.readUtf8(28),f=this.readUtf8(28),u=this.readUtf8(28),c=this.readUint16(),d=this.readUint16(),p=this.readUint16(),l=this.readUint8();this.readUint8();this.frameCount=c,this.thumbFrameIndex=d,this.frameSpeed=l,this.framerate=k[l],this.meta={lock:1==(1&p),loop:1==(p>>1&1),frame_count:c,frame_speed:l,thumb_index:d,timestamp:e,creation_timestamp:t,root:{username:n,fsid:r,filename:h},parent:{username:a,fsid:i,filename:f},current:{username:o,fsid:s,filename:u}}},e.prototype.decodeFrameMeta=function(){this.frameOffsets=new Uint32Array(this.frameCount),this.seek(this.sections.KMI.offset+8);for(var t=this.sections.KMC.offset+12,e=0;e<this.frameCount;e++){var r={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readHex(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(r),this.frameOffsets[e]=t,t+=r.layerSize[0]+r.layerSize[1]+r.layerSize[2]}},e.prototype.decodeSoundHeader=function(){if(this.sections.hasOwnProperty("KSN")){var t=this.sections.KSN.offset+8;this.seek(t);var e=this.readUint32();this.bgmSpeed=e,this.bgmrate=k[e];var r=new Uint32Array(this.buffer,t+4,20);this.soundMeta={bgm:{offset:t+=28,length:r[0]},se1:{offset:t+=r[0],length:r[1]},se2:{offset:t+=r[1],length:r[2]},se3:{offset:t+=r[2],length:r[3]},se4:{offset:t+=r[3],length:r[4]}}}},e.prototype.getDiffingFlag=function(t){return 7&~(this.frameMeta[t].flags>>4)},e.prototype.getLayerDepths=function(t){return this.frameMeta[t].layerDepth},e.prototype.getLayerOrder=function(t){var e=this.getLayerDepths(t);return[2,1,0].sort(function(t,r){return e[r]-e[t]})},e.prototype.decodeFrame=function(t,r,i){void 0===r&&(r=7),void 0===i&&(i=!1),i&&(r&=this.getDiffingFlag(t+1)),0!==t&&this.prevDecodedFrame!==t-1&&r&&this.decodeFrame(t-1,r=r,i=!0);for(var s=this.frameMeta[t],n=this.frameOffsets[t],a=0;a<3;a++){this.seek(n);var o=s.layerSize[a];if(n+=o,38!==o&&0!=(r>>a&1)){this.bitIndex=16,this.bitValue=0;for(var h=0,f=0;f<e.height;f+=128)for(var u=0;u<e.width;u+=128)for(var c=0;c<128;c+=8){var d=f+c;if(d>=e.height)break;for(var p=0;p<128;p+=8){var l=u+p;if(l>=e.width)break;if(h)h-=1;else{var y=d*e.width+l,g=this.layers[a],m=this.readBits(3);if(0==m){var U=w[this.readBits(5)],_=E.subarray(8*U,8*U+8);g.set(_,y),g.set(_,y+320),g.set(_,y+640),g.set(_,y+960),g.set(_,y+1280),g.set(_,y+1600),g.set(_,y+1920),g.set(_,y+2240)}else if(1==m){U=this.readBits(13),_=E.subarray(8*U,8*U+8);g.set(_,y),g.set(_,y+320),g.set(_,y+640),g.set(_,y+960),g.set(_,y+1280),g.set(_,y+1600),g.set(_,y+1920),g.set(_,y+2240)}else if(2==m){var A=this.readBits(5),x=w[A],B=v[A],F=E.subarray(8*x,8*x+8),P=E.subarray(8*B,8*B+8);g.set(F,y),g.set(P,y+320),g.set(F,y+640),g.set(P,y+960),g.set(F,y+1280),g.set(P,y+1600),g.set(F,y+1920),g.set(P,y+2240)}else if(3==m){x=this.readBits(13),B=b[x],F=E.subarray(8*x,8*x+8),P=E.subarray(8*B,8*B+8);g.set(F,y),g.set(P,y+320),g.set(F,y+640),g.set(P,y+960),g.set(F,y+1280),g.set(P,y+1600),g.set(F,y+1920),g.set(P,y+2240)}else if(4==m)for(var S=this.readBits(8),C=0;C<8;C++){U=0;U=S&1<<C?w[this.readBits(5)]:this.readBits(13);_=E.subarray(8*U,8*U+8);g.set(_,y+320*C)}else{if(5==m){h=this.readBits(5);continue}if(7==m){var L=this.readBits(2);x=0,B=0;this.readBits(1)?(x=w[this.readBits(5)],B=w[this.readBits(5)],L=(L+1)%4):(x=this.readBits(13),B=this.readBits(13));F=E.subarray(8*x,8*x+8),P=E.subarray(8*B,8*B+8);0==L?(g.set(F,y),g.set(P,y+320),g.set(F,y+640),g.set(P,y+960),g.set(F,y+1280),g.set(P,y+1600),g.set(F,y+1920),g.set(P,y+2240)):1==L?(g.set(F,y),g.set(F,y+320),g.set(P,y+640),g.set(F,y+960),g.set(F,y+1280),g.set(P,y+1600),g.set(F,y+1920),g.set(F,y+2240)):2==L?(g.set(F,y),g.set(P,y+320),g.set(F,y+640),g.set(F,y+960),g.set(P,y+1280),g.set(F,y+1600),g.set(F,y+1920),g.set(P,y+2240)):3==L&&(g.set(F,y),g.set(P,y+320),g.set(P,y+640),g.set(F,y+960),g.set(P,y+1280),g.set(P,y+1600),g.set(F,y+1920),g.set(P,y+2240))}}}}}}}return this.prevDecodedFrame=t,[new Uint8Array(this.layers[0].buffer),new Uint8Array(this.layers[1].buffer),new Uint8Array(this.layers[2].buffer)]},e.prototype.getFramePalette=function(t){var e=this.frameMeta[t].flags,r=[this.palette.WHITE,this.palette.BLACK,this.palette.RED,this.palette.YELLOW,this.palette.GREEN,this.palette.BLUE,this.palette.NONE];return[r[15&e],r[e>>8&15],r[e>>12&15],r[e>>16&15],r[e>>20&15],r[e>>24&15],r[e>>28&15]]},e.prototype.getLayerPixels=function(t,r){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var i=this.layers[r],s=new Uint8Array(e.width*e.height),n=2*r+1,a=0;a<i.length;a++){var o=i[a];65280&o?s[a]=n:255&o&&(s[a]=n+1)}return s},e.prototype.getFramePixels=function(t,r){var i,s=this;if(void 0===r&&(r=!1),r){var n=this.getFramePalette(t);i=n.map(function(t){return e.globalPalette.indexOf(t)})}else i=[0,1,2,3,4,5,6];var a=new Uint8Array(e.width*e.height);return a.fill(i[0]),this.getLayerOrder(t).forEach(function(e){for(var r=s.getLayerPixels(t,e),n=0;n<r.length;n++){var o=r[n];0!==o&&(a[n]=i[o])}}),a},e.prototype.decodeSoundFlags=function(){return this.frameMeta.map(function(t){var e=t.soundFlags;return[1&e,e>>1&1,e>>2&1,e>>3&1]})},e.prototype.hasAudioTrack=function(t){var e=["bgm","se1","se2","se3","se4"][t];return this.soundMeta[e].length>0},e.prototype.decodeAudio=function(t){for(var e,r,i,s=this.soundMeta[t],o=new Uint8Array(this.buffer,s.offset,s.length),f=new Int16Array(981840),u=0,c=0,p=40,l=0;l<o.length;l++)for(var y=o[l],g=0;g<8;)p<18||6==g?(r=c+h[(e=y>>g&3)+4*p],i=p+n[e],g+=2):(r=c+d[(e=y>>g&15)+16*p],i=p+a[e],g+=4),i=Math.max(0,Math.min(i,79)),r=Math.max(-2048,Math.min(r,2048)),f[u]=16*r,u+=1,p=i,c=r;return f.slice(0,u)},e.type="KWZ",e.sampleRate=16364,e.width=320,e.height=240,e.globalPalette=[M.BLACK,M.WHITE,M.RED,M.YELLOW,M.GREEN,M.BLUE,M.NONE],e}(s.a);function R(t){return function(t){return new Promise(function(e,r){i.forEach(function(i){i.matches(t)&&i.load(t,e,r)})})}(t).then(function(t){return new Promise(function(e,r){var i=new DataView(t,0,4).getUint32(0);1346458177===i?e(new m(t)):1262897152==(4294967040&i)?e(new H(t)):r()})})}r.d(e,"c",function(){return R}),r.d(e,"b",function(){return m}),r.d(e,"a",function(){return H})},function(t,e,r){"use strict";r.d(e,"a",function(){return s});var i=r(0),s=function(){function t(t,e,r){void 0===e&&(e=1),void 0===r&&(r=16),this.sampleRate=t,this.channels=e,this.bitsPerSample=r;var s=new ArrayBuffer(44),n=new i.DataStream(s);n.writeUtf8("RIFF"),n.writeUint32(0),n.writeUtf8("WAVE"),n.writeUtf8("fmt "),n.writeUint32(16),n.writeUint16(1),n.writeUint16(this.channels),n.writeUint32(this.sampleRate),n.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample),n.writeUtf8("data"),n.writeUint32(0),this.header=n,this.pcmData=null}return t.prototype.writeFrames=function(t){var e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t},t.prototype.getBlob=function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})},t}()},function(t,e,r){"use strict";var i=r(0),s=5003,n=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],a=function(){function t(t,e,r,i){this.accum=new Uint8Array(256),this.htab=new Int32Array(s),this.codetab=new Int32Array(s),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.pixels=r,this.colorDepth=i,this.initCodeSize=Math.max(2,this.colorDepth),this.accum=new Uint8Array(256),this.htab=new Int32Array(s),this.codetab=new Int32Array(s),this.cur_accum=0,this.cur_bits=0,this.a_count,this.remaining,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}return t.prototype.char_out=function(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)},t.prototype.cl_block=function(t){this.cl_hash(s),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var e=0;e<t;++e)this.htab[e]=-1},t.prototype.compress=function(t,e){var r,i,n,a,o,h,f;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,a=this.nextPixel(),f=0,r=s;r<65536;r*=2)++f;f=8-f,h=s,this.cl_hash(h),this.output(this.ClearCode,e);t:for(;-1!=(i=this.nextPixel());)if(r=(i<<12)+a,n=i<<f^a,this.htab[n]!==r){if(this.htab[n]>=0){o=h-n,0===n&&(o=1);do{if((n-=o)<0&&(n+=h),this.htab[n]===r){a=this.codetab[n];continue t}}while(this.htab[n]>=0)}this.output(a,e),a=i,this.free_ent<4096?(this.codetab[n]=this.free_ent++,this.htab[n]=r):this.cl_block(e)}else a=this.codetab[n];this.output(a,e),this.output(this.EOFCode,e)},t.prototype.encode=function(t){t.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,t),t.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,e){for(this.cur_accum&=n[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}},t}(),o=function(){function t(t,e){this.delay=100,this.repeat=-1,this.colorDepth=8,this.palette=[],this.width=t,this.height=e,this.data=new i.ByteArray}return t.fromFlipnote=function(e){var r=new t(e.width,e.height);r.palette=e.globalPalette,r.delay=100/e.framerate,r.repeat=e.meta.loop?-1:0,r.init();for(var i=0;i<e.frameCount;i++)r.writeFrame(e.getFramePixels(i,!0));return r},t.fromFlipnoteFrame=function(e,r){var i=new t(e.width,e.height);return i.palette=e.globalPalette,i.delay=100/e.framerate,i.repeat=e.meta.loop?-1:0,i.init(),i.writeFrame(e.getFramePixels(r,!0)),i},t.prototype.init=function(){for(var t=this.palette.length,e=1;1<<e<t;e+=1);this.colorDepth=e,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt()},t.prototype.writeHeader=function(){var t=new i.DataStream(new ArrayBuffer(13));t.writeUtf8("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.colorDepth-1),t.writeUint8(0),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.colorDepth)),e=0,r=0;e<this.palette.length;e+=1,r+=3)t.set(this.palette[e],r);this.data.writeBytes(t)},t.prototype.writeGraphicsControlExt=function(){var t=new i.DataStream(new ArrayBuffer(8));t.writeBytes([33,249,4,0]),t.writeUint16(this.delay),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeNetscapeExt=function(){var t=new i.DataStream(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeUtf8("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeImageDesc=function(){var t=new i.DataStream(new ArrayBuffer(10));t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writePixels=function(t){new a(this.width,this.height,t,this.colorDepth).encode(this.data)},t.prototype.writeFrame=function(t){this.writeGraphicsControlExt(),this.writeImageDesc(),this.writePixels(t)},t.prototype.getBuffer=function(){return this.data.getBuffer()},t.prototype.getBlob=function(){return new Blob([this.getBuffer()],{type:"image/gif"})},t.prototype.getUrl=function(){return window.URL.createObjectURL(this.getBlob())},t.prototype.getImage=function(){var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},t}(),h=r(3);r.d(e,"a",function(){return o}),r.d(e,"b",function(){return h.a})},,,function(t,e,r){"use strict";r.r(e);var i=r(2),s=r(4);e.default={version:"3.2.0",parseSource:i.c,kwzParser:i.a,ppmParser:i.b,gifEncoder:s.a,wavEncoder:s.b}}]).default});
//# sourceMappingURL=node.min.js.map