/*!
 * ugomemo.js v1.0.0
 * Real-time, browser-based playback of Flipnote Studio's .ppm animation format
 * 2018 James Daniel
 * github.com/jaames/ugomemo.js
 * Flipnote Studio is (c) Nintendo Co., Ltd.
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ugomemo=t():e.ugomemo=t()}(this,function(){return function(e){function t(a){if(r[a])return r[a].exports;var i=r[a]={i:a,l:!1,exports:{}};return e[a].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,a){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:a})},t.n=function(e){var r=e&&e.e?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){"use strict";var a=r(1),i=function(e){return e&&e.e?e:{default:e}}(a);e.exports={version:"1.0.0",player:i.default}},function(e,t,r){"use strict";function a(e){return e&&e.e?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),s=r(2),o=a(s),u=r(5),l=a(u),h=r(8),f=a(h),c={1:.5,2:1,3:2,4:4,5:6,6:12,7:20,8:30},d=function(){function e(t,r,a){i(this,e),t="string"==typeof t?document.querySelector(t):t,this.canvas=new o.default(t,r,a),this.t=!1,this.loop=!1,this.currentFrame=0,this.paused=!0}return n(e,[{key:"open",value:function(e){this.t&&this.close();var t=e,r=new l.default(t),a=r.meta;this.ppm=r,this.meta=a,this.frameCount=r.frameCount,this.frameSpeed=r.frameSpeed,this.loop=1==a.loop,this.r=r.soundMeta.bgm.length>0?new f.default(this.ppm.decodeAudio("bgm")):null,this.r&&(this.r.playbackRate=this.a),this.u=[r.soundMeta.se1.length>0?new f.default(this.ppm.decodeAudio("se1")):null,r.soundMeta.se2.length>0?new f.default(this.ppm.decodeAudio("se2")):null,r.soundMeta.se3.length>0?new f.default(this.ppm.decodeAudio("se3")):null],this.h=this.ppm.decodeSoundFlags(),this.t=!0,this.paused=!0,this.f=0,this._=0,this.v={},this.y=!1,this.setFrame(this.ppm.thumbFrameIndex),this.emit("load")}},{key:"close",value:function(){this.ppm=null,this.t=!1,this.paused=!0,this.loop=null,this.meta=null,this.frameCount=null,this.frameSpeed=null,this.g=0,this.r=null,this.u=new Array(3),this.h=null,this.y=null,this.canvas.clear()}},{key:"_playFrameSe",value:function(e){for(var t=this.h[e],r=0;r<t.length;r++)t[r]&&this.u[r]&&this.u[r].start()}},{key:"_playBgm",value:function(){this.r&&this.r.start(this.currentTime)}},{key:"_playbackLoop",value:function(e){var t=(e-this._)/(1e3/60),r=this.currentFrame;this.f>=60/this.framerate&&(this.b(r),this.nextFrame(),this.f=0),r==this.frameCount-1&&(this.loop?(this.firstFrame(),this.k(),this.emit("playback:loop")):(this.pause(),this.emit("playback:end"))),this.f+=t,this._=e,this.paused||requestAnimationFrame(this.T.bind(this))}},{key:"play",value:function(){if(!this.t)return null;this.paused=!1,this.y&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.g=0),this._=performance.now(),this.k(),this.T(this._),this.y=!0,this.emit("playback:start")}},{key:"pause",value:function(){if(!this.t)return null;this.paused=!0,this.r&&this.r.stop(),this.emit("playback:stop")}},{key:"setFrame",value:function(e){if(!this.t)return null;e=Math.max(0,Math.min(e,this.frameCount-1)),this.g=e,this.f=0,this.canvas.setPalette(this.ppm.getFramePalette(e)),this.canvas.setBitmaps(this.ppm.decodeFrame(e)),this.canvas.refresh()}},{key:"nextFrame",value:function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1}},{key:"prevFrame",value:function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1}},{key:"lastFrame",value:function(){this.currentFrame=this.frameCount-1}},{key:"firstFrame",value:function(){this.currentFrame=0}},{key:"thumbnailFrame",value:function(){this.currentFrame=this.ppm.thumbFrameIndex}},{key:"resize",value:function(e,t){this.canvas.resize(e,t)}},{key:"on",value:function(e,t){var r=this.v;(r[e]||(r[e]=[])).push(t)}},{key:"off",value:function(e,t){var r=this.v[e];r&&r.splice(r.indexOf(t),1)}},{key:"emit",value:function(e){for(var t=this.v[e]||[],r=arguments.length,a=Array(r>1?r-1:0),i=1;i<r;i++)a[i-1]=arguments[i];for(var n=0;n<t.length;n++)t[n].apply(null,a)}},{key:"currentFrame",get:function(){return this.g},set:function(e){this.setFrame(e)}},{key:"currentTime",get:function(){return this.t?this.currentFrame*(1/this.framerate):null},set:function(e){this.t&&e<this.duration&&e>0&&(this.setFrame(Math.round(e/(1/this.framerate))),this.f=0)}},{key:"duration",get:function(){return this.t?this.frameCount*(1/this.framerate):null}},{key:"framerate",get:function(){return c[this.frameSpeed]}},{key:"_audiorate",get:function(){return 1/c[this.ppm.bgmSpeed]/(1/c[this.frameSpeed])}}]),e}();t.default=d},function(e,t,r){"use strict";function a(e){return e&&e.e?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),s=r(3),o=a(s),u=r(4),l=a(u),h=function(){function e(t,r,a){i(this,e),t.width=r||256,t.height=a||192;var n=t.getContext("webgl",{antialias:!1}),s=n.createProgram();this.program=s,this.el=t,this.gl=n,this.F(n.VERTEX_SHADER,o.default),this.F(n.FRAGMENT_SHADER,l.default),n.linkProgram(s),n.useProgram(s);var u=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,u),n.bufferData(n.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),n.STATIC_DRAW),n.enableVertexAttribArray(0),n.vertexAttribPointer(0,2,n.FLOAT,!1,0,0),this.U("u_layer1Bitmap",0,n.TEXTURE0),this.U("u_layer2Bitmap",1,n.TEXTURE1)}return n(e,[{key:"_createShader",value:function(e,t){var r=this.gl,a=r.createShader(e);r.shaderSource(a,t),r.compileShader(a),r.attachShader(this.program,a)}},{key:"_createTexture",value:function(e,t,r){var a=this.gl;a.uniform1i(a.getUniformLocation(this.program,e),t),a.activeTexture(r),a.bindTexture(a.TEXTURE_2D,a.createTexture()),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST)}},{key:"setColor",value:function(e,t){this.gl.uniform4f(this.gl.getUniformLocation(this.program,e),t[0]/255,t[1]/255,t[2]/255,t[3]/255)}},{key:"setPalette",value:function(e){this.setColor("u_paperColor",e[0]),this.setColor("u_layer1Color",e[1]),this.setColor("u_layer2Color",e[2])}},{key:"setBitmaps",value:function(e){var t=this.gl;t.activeTexture(t.TEXTURE0),t.texImage2D(t.TEXTURE_2D,0,t.ALPHA,256,192,0,t.ALPHA,t.UNSIGNED_BYTE,e[0]),t.activeTexture(t.TEXTURE1),t.texImage2D(t.TEXTURE_2D,0,t.ALPHA,256,192,0,t.ALPHA,t.UNSIGNED_BYTE,e[1])}},{key:"resize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:256,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:192;this.el.width=e,this.el.height=t,this.gl.viewport(0,0,e,t)}},{key:"refresh",value:function(){this.gl.drawArrays(this.gl.TRIANGLES,0,6)}},{key:"clear",value:function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}]),e}();t.default=h},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=["attribute vec4 a_position;","varying vec2 v_texcoord;","void main() {","gl_Position = a_position;","v_texcoord = a_position.xy * vec2(0.5, -0.5) + 0.5;","}"].join("\n")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=["precision lowp float;","varying vec2 v_texcoord;","uniform vec4 u_paperColor;","uniform vec4 u_layer1Color;","uniform vec4 u_layer2Color;","uniform sampler2D u_layer1Bitmap;","uniform sampler2D u_layer2Bitmap;","void main() {","float layer1 = texture2D(u_layer1Bitmap, v_texcoord).a;","float layer2 = texture2D(u_layer2Bitmap, v_texcoord).a;","gl_FragColor = (layer1 == 0.0) ? (layer2 == 0.0) ? u_paperColor : u_layer2Color : u_layer1Color;","}"].join("\n")},function(e,t,r){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),o=r(6),u=function(e){return e&&e.e?e:{default:e}}(o),l=r(7),h=256,f=192,c=[14,14,14,255],d=[255,255,255,255],_=[10,57,255,255],m=[255,42,42,255],p=function(e){function t(e){a(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));r.seek(4),r.A=r.readUint32(),r.x=r.readUint32(),r.frameCount=Math.min(r.readUint16()+1,999),r.seek(18),r.thumbFrameIndex=r.readUint16(),r.seek(1696);var n=r.readUint16();return r.seek(1704),r.w=new Uint32Array(n/4).map(function(e){return 1704+n+r.readUint32()}),r.meta=r.C(),r.P(),r.S=[new Uint8Array(h*f),new Uint8Array(h*f)],r.O=[new Uint8Array(h*f),new Uint8Array(h*f)],r.R=0,r}return n(t,e),s(t,[{key:"_seekToFrame",value:function(e){this.seek(this.w[e])}},{key:"_seekToAudio",value:function(e){this.seek(this.soundMeta[e].offset)}},{key:"_readUtf16",value:function(e){for(var t="",r=!1,a=0;a<e/2;a++){var i=this.readUint16();r||0==i?r=!0:t+=String.fromCharCode(i)}return t}},{key:"_readHex",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=[],a=0;a<e;a++)r.push(this.readUint8().toString(16).padStart(2,"0"));return t&&r.reverse(),r.join("").toUpperCase()}},{key:"_readFilename",value:function(){var e="";e+=this.L(3)+"_";for(var t=0;t<13;t++)e+=String.fromCharCode(this.readUint8());return e+="_",e+=this.readUint16().toString().padStart(3,"0")}},{key:"_readLineEncoding",value:function(){for(var e=new Uint8Array(f),t=0;t<48;t++)for(var r=this.readUint8(),a=0;a<8;a+=2)e[4*t+a/2]=r>>a&3;return e}},{key:"_decodeMeta",value:function(){this.seek(16);var e=this.readUint16(),t=this.readInt16(),r=this.M(22),a=this.M(22),i=this.M(22),n=this.L(8,!0),s=this.L(8,!0),o=this.D(),u=this.D(),l=this.L(8,!0);this.seek(154);var h=new Date(1e3*(this.readUint32()+946684800));return this.seek(27232),{lock:e,loop:this.readUint16()>>1&1,frame_count:this.frameCount,thumb_index:t,timestamp:h,spinoff:s!==n,root:{username:r,fsid:l},parent:{username:a,fsid:n,filename:o},current:{username:i,fsid:s,filename:u}}}},{key:"_decodeSoundHeader",value:function(){var e=1696+this.A+this.frameCount;e%4!=0&&(e+=4-e%4),this.seek(e);var t=this.readUint32(),r=this.readUint32(),a=this.readUint32(),i=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),e+=32,this.soundMeta={bgm:{offset:e,length:t},se1:{offset:e+=t,length:r},se2:{offset:e+=r,length:a},se3:{offset:e+=a,length:i}}}},{key:"_isFrameNew",value:function(e){return this.j(e),this.readUint8()>>7&1}},{key:"_decodePrevFrames",value:function(e){for(var t=0,r=0;!r;)t+=1,r=this.I(e-t);for(t=e-t;t<e;)this.decodeFrame(t,!1),t+=1;this.j(e),this.seek(1,1)}},{key:"getFramePalette",value:function(e){this.j(e);var t=this.readUint8(),r=1&t,a=[null,1==r?c:d,m,_];return[1==r?d:c,a[t>>1&3],a[t>>3&3]]}},{key:"decodeFrame",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.j(e);var r=this.readUint8(),a=r>>7&1,i=r>>5&3,n=0,s=0;t&&!a&&e!==this.R+1&&this.B(e),this.O[0].set(this.S[0]),this.O[1].set(this.S[1]),this.R=e,this.S[0].fill(0),this.S[1].fill(0),i&&(n=this.readInt8(),s=this.readInt8());for(var o=[this.X(),this.X()],u=0;u<2;u++)for(var l=this.S[u],c=0;c<f;c++){var d=c*h,_=o[u][c];switch(_){case 0:break;case 1:case 2:var m=this.readUint32(!1);for(2==_&&l.fill(1,d,d+h);4294967295&m;){if(2147483648&m)for(var p=this.readUint8(),v=0;v<8;v++)l[d+v]=p>>v&1;d+=8,m<<=1}break;case 3:for(;d<(c+1)*h;){for(var p=this.readUint8(),v=0;v<8;v++)l[d+v]=p>>v&1;d+=8}}}if(!a)for(var y,g,b,k=0;k<f;k++)for(var T=0;T<h;T++)y=T+k*h,g=y-(n+s*h),b=T-n>h||T-n<0,this.S[0][y]=b?this.S[0][y]:this.S[0][y]^this.O[0][g],this.S[1][y]=b?this.S[1][y]:this.S[1][y]^this.O[1][g];return this.S}},{key:"decodeAudio",value:function(e){var t=this;this.H(e);var r=new Uint8Array(this.soundMeta[e].length).map(function(e){return t.readUint8()});return(0,l.decodeAdpcm)(r)}},{key:"decodeSoundFlags",value:function(){var e=this;return this.seek(1696+this.A),new Array(this.frameCount).fill([]).map(function(t){var r=e.readUint8();return[1&r,r>>1&1,r>>2&1]})}}]),t}(u.default);t.default=p},function(e,t,r){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),n=function(){function e(t){a(this,e),this.N=new DataView(t),this.G=0}return i(e,[{key:"seek",value:function(e,t){switch(t){case 2:this.G=this.N.byteLength+e;break;case 1:this.G+=e;break;case 0:default:this.G=e}}},{key:"readUint8",value:function(){var e=this.N.getUint8(this.G);return this.G+=1,e}},{key:"readInt8",value:function(){var e=this.N.getInt8(this.G);return this.G+=1,e}},{key:"readUint16",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.N.getUint16(this.G,e);return this.G+=2,t}},{key:"readInt16",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.N.getInt16(this.G,e);return this.G+=2,t}},{key:"readUint32",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.N.getUint32(this.G,e);return this.G+=4,t}},{key:"readInt32",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.N.getInt32(this.G,e);return this.G+=4,t}},{key:"fileLength",get:function(){return this.N.byteLength}}]),e}();t.default=n},function(e,t,r){"use strict";function a(e){u=0,l=0;for(var t=new Float32Array(2*e.length),r=0,a=0;a<e.length;a++){var n=e[a];t[r]=i(15&n),t[r+1]=i(n>>4&15),r+=2}return t}function i(e){var t=u,r=l,a=o[r],i=a>>3;return 4&e&&(i+=a),2&e&&(i+=a>>1),1&e&&(i+=a>>2),t+=8&e?-i:i,r+=s[e],r=n(r,0,88),t=n(t,-32767,32767),u=t,l=r,t/32768}function n(e,t,r){return e<=t?t:e>=r?r:e}Object.defineProperty(t,"__esModule",{value:!0}),t.decodeAdpcm=a;var s=[-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8],o=[7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767],u=0,l=0},function(e,t,r){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),n=function(){function e(t){a(this,e);var r=new AudioContext,i=r.createBuffer(1,t.length,8192);i.copyToChannel(t,0);this.audioBuffer=i,this.source=null,this.paused=!0,this.ctx=r,this.playbackRate=1}return i(e,[{key:"start",value:function(e){var t=this;this.source=this.ctx.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.ctx.destination),this.source.onended=function(e){t.paused=!0},this.source.playbackRate.value=this.playbackRate,this.source.start(0,e),this.paused=!1}},{key:"stop",value:function(){this.source&&this.source.stop(),this.source=null,this.paused=!0}}]),e}();t.default=n}])});