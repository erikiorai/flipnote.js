/*!!
 * flipnote.js v6.0.1
 * https://flipnote.js.org
 * A JavaScript library for Flipnote Studio animation files
 * 2018 - 2024 James Daniel
 * Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
*/
!function(t){var s,i,e,r,n,h;function o(t,s,i,e){if("a"===i&&!e)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof s?t!==s||!e:!s.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?e:"a"===i?e.call(t):e?e.value:s.get(t)}function a(t,s,i,e,r){if("m"===e)throw new TypeError("Private method is not writable");if("a"===e&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof s?t!==s||!r:!s.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===e?r.call(t,i):r?r.value=i:s.set(t,i),i}t.FlipnoteRegion=void 0,(s=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",s.USA="USA",s.JPN="JPN",s.UNKNOWN="UNKNOWN",t.FlipnoteFormat=void 0,(i=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",i.KWZ="KWZ",t.FlipnoteThumbImageFormat=void 0,(e=t.FlipnoteThumbImageFormat||(t.FlipnoteThumbImageFormat={}))[e.Jpeg=0]="Jpeg",e[e.Rgba=1]="Rgba",t.FlipnoteStereoscopicEye=void 0,(r=t.FlipnoteStereoscopicEye||(t.FlipnoteStereoscopicEye={}))[r.Left=0]="Left",r[r.Right=1]="Right",t.FlipnoteAudioTrack=void 0,(n=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[n.BGM=0]="BGM",n[n.SE1=1]="SE1",n[n.SE2=2]="SE2",n[n.SE3=3]="SE3",n[n.SE4=4]="SE4",t.FlipnoteSoundEffectTrack=void 0,(h=t.FlipnoteSoundEffectTrack||(t.FlipnoteSoundEffectTrack={}))[h.SE1=1]="SE1",h[h.SE2=2]="SE2",h[h.SE3=3]="SE3",h[h.SE4=4]="SE4","function"==typeof SuppressedError&&SuppressedError;class ByteArray{constructor(){this.pageSize=4096,this.allocSize=0,this.realSize=0,this.pages=[],this.numPages=0,this.pageIdx=0,this.pagePtr=0,this.realPtr=0,this.newPage()}set pointer(t){this.setPointer(t)}get pointer(){return this.realPtr}newPage(){this.pages[this.numPages]=new Uint8Array(this.pageSize),this.numPages=this.pages.length,this.allocSize=this.numPages*this.pageSize}setPointer(t){for(;t>=this.allocSize;)this.newPage();t>this.realSize&&(this.realSize=t),this.pageIdx=Math.floor(t/this.pageSize),this.pagePtr=t%this.pageSize,this.realPtr=t}writeByte(t){this.pages[this.pageIdx][this.pagePtr]=t,this.setPointer(this.realPtr+1)}writeBytes(t,s,i){for(let e=i||t.length,r=s||0;r<e;r++)this.writeByte(t[r])}writeChars(t){for(let s=0;s<t.length;s++)this.writeByte(t.charCodeAt(s))}writeU8(t){this.writeByte(255&t)}writeU16(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255)}writeU32(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255),this.writeByte(t>>>16&255),this.writeByte(t>>>24&255)}getBytes(){const t=new Uint8Array(this.realSize),s=this.numPages;for(let i=0;i<s;i++){const e=this.pages[i];i===s-1?t.set(e.slice(0,this.realSize%this.pageSize),i*this.pageSize):t.set(e,i*this.pageSize)}return t}getBuffer(){return this.getBytes().buffer}}const f=(t,s=!1)=>{let i=[];for(let s=0;s<t.length;s++)i.push(t[s].toString(16).padStart(2,"0"));return s&&i.reverse(),i.join("")};class DataStream{constructor(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}get bytes(){return new Uint8Array(this.buffer)}get numBytes(){return this.data.byteLength}seek(t,s){switch(s){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;default:this.pointer=t}}readUint8(){const t=this.data.getUint8(this.pointer);return this.pointer+=1,t}writeUint8(t){this.data.setUint8(this.pointer,t),this.pointer+=1}readInt8(){const t=this.data.getInt8(this.pointer);return this.pointer+=1,t}writeInt8(t){this.data.setInt8(this.pointer,t),this.pointer+=1}readUint16(t=!0){const s=this.data.getUint16(this.pointer,t);return this.pointer+=2,s}writeUint16(t,s=!0){this.data.setUint16(this.pointer,t,s),this.pointer+=2}readInt16(t=!0){const s=this.data.getInt16(this.pointer,t);return this.pointer+=2,s}writeInt16(t,s=!0){this.data.setInt16(this.pointer,t,s),this.pointer+=2}readUint32(t=!0){const s=this.data.getUint32(this.pointer,t);return this.pointer+=4,s}writeUint32(t,s=!0){this.data.setUint32(this.pointer,t,s),this.pointer+=4}readInt32(t=!0){const s=this.data.getInt32(this.pointer,t);return this.pointer+=4,s}writeInt32(t,s=!0){this.data.setInt32(this.pointer,t,s),this.pointer+=4}readBytes(t){const s=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=s.byteLength,s}writeBytes(t){t.forEach((t=>this.writeUint8(t)))}readHex(t,s=!1){const i=this.readBytes(t);return f(i,s)}readChar(){const t=this.readUint8();return String.fromCharCode(t)}readWideChar(){const t=this.readUint16();return String.fromCharCode(t)}readChars(t){const s=this.readBytes(t);let i="";for(let t=0;t<s.length;t++){const e=s[t];if(0===e)break;i+=String.fromCharCode(e)}return i}writeChars(t){for(let s=0;s<t.length;s++){const i=t.charCodeAt(s);this.writeUint8(i)}}readWideChars(t){const s=new Uint16Array(this.data.buffer,this.pointer,t);let i="";for(let t=0;t<s.length;t++){const e=s[t];if(0==e)break;i+=String.fromCharCode(e)}return this.pointer+=s.byteLength,i}end(){return this.pointer>=this.data.byteLength}}const u=(t,s,i)=>t<s?s:t>i?i:t;function c(t,s="Assert failed"){t||d(s)}const l=(t,s,i,e="")=>c(t>=s&&t<=i,`flipnote.js error: ${e||"value"} ${t} should be between ${s} and ${i}`),d=(t="Assert failed")=>{throw new Error("flipnote.js error: "+t)},m=()=>w?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},p="undefined"!=typeof window&&void 0!==window.document,y=()=>c(p,"This feature is only available in browser environments"),w="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,g="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name;var v;!function(){if(!p)return function(){};document.createElement("a")}();class BaseParser extends DataStream{constructor(){super(...arguments),this[v]="Flipnote",this.titleFormats={COMMENT:"Comment by $USERNAME",FLIPNOTE:"Flipnote by $USERNAME",ICON:"Folder icon"},this.soundMeta=new Map,this.layerVisibility={1:!0,2:!0,3:!0},this.isFolderIcon=!1,this.isComment=!1,this.isDsiLibraryNote=!1}getTitle(t=this.titleFormats){return this.isFolderIcon?t.ICON:(this.isComment?t.COMMENT:t.FLIPNOTE).replace("$USERNAME",this.meta.current.username)}toString(){return this.getTitle()}*[(v=Symbol.toStringTag,Symbol.iterator)](){for(let t=0;t<this.frameCount;t++)yield t}getLayerPixels(s,i,e=new Uint8Array(this.imageWidth*this.imageHeight),r=0,n=t.FlipnoteStereoscopicEye.Left){l(s,0,this.frameCount-1,"Frame index"),l(i,0,this.numLayers-1,"Layer index");const h=this.getFramePaletteIndices(s),o=i*this.numLayerColors,a=this.decodeFrame(s)[i],f=Math.floor(this.getFrameLayerDepths(s)[i]*r),u=n==t.FlipnoteStereoscopicEye.Left?-f:f,c=this.srcWidth,d=this.imageWidth,m=this.imageWidth,p=this.imageHeight,y=this.imageOffsetX,w=this.imageOffsetY;if(e.fill(0),!this.layerVisibility[i+1])return e;for(let t=w,s=0;s<p;t++,s++)for(let i=y,r=0;r<m;i++,r++){const n=s*d+r+u;let f=a[t*c+i];0!==f&&(e[n]=h[o+f])}return e}getLayerPixelsRgba(s,i,e=new Uint32Array(this.imageWidth*this.imageHeight),r=new Uint32Array(16),n=0,h=t.FlipnoteStereoscopicEye.Left){l(s,0,this.frameCount-1,"Frame index"),l(i,0,this.numLayers-1,"Layer index"),this.getFramePaletteUint32(s,r);const o=i*this.numLayerColors,a=this.decodeFrame(s)[i],f=Math.floor(this.getFrameLayerDepths(s)[i]*n),u=h==t.FlipnoteStereoscopicEye.Left?-f:f,c=this.srcWidth,d=this.imageWidth,m=this.imageWidth-f,p=this.imageHeight,y=this.imageOffsetX,w=this.imageOffsetY;if(e.fill(0),!this.layerVisibility[i+1])return e;for(let t=w,s=0;s<p;t++,s++)for(let i=y,n=0;n<m;i++,n++){const h=s*d+n+u;let f=a[t*c+i];0!==f&&(e[h]=r[o+f])}return e}getFramePixels(s,i=new Uint8Array(this.imageWidth*this.imageHeight),e=0,r=t.FlipnoteStereoscopicEye.Left){const n=this.srcWidth;this.imageWidth;const h=this.imageWidth,o=this.imageHeight,a=this.imageOffsetX,f=this.imageOffsetY,u=this.getFramePaletteIndices(s);i.fill(u[0]);const c=this.getFrameLayerOrder(s),l=this.getFrameLayerDepths(s),d=this.decodeFrame(s);for(let s=0;s<this.numLayers;s++){const m=c[s],p=d[m],y=m*this.numLayerColors,w=Math.floor(l[m]*e),g=r==t.FlipnoteStereoscopicEye.Left?-w:w;if(this.layerVisibility[m+1])for(let t=f,s=0;s<o;t++,s++)for(let e=a,r=0;r<h;e++,r++){const o=s*h+r+g;let a=p[t*n+e];0!==a&&(i[o]=u[y+a])}}return i}getFramePixelsRgba(s,i=new Uint32Array(this.imageWidth*this.imageHeight),e=new Uint32Array(16),r=0,n=t.FlipnoteStereoscopicEye.Left){l(s,0,this.frameCount-1,"Frame index");const h=this.srcWidth,o=this.imageWidth,a=this.imageWidth,f=this.imageHeight,u=this.imageOffsetX,c=this.imageOffsetY;this.getFramePaletteUint32(s,e),i.fill(e[0]);const d=this.getFrameLayerOrder(s),m=this.getFrameLayerDepths(s),p=this.decodeFrame(s);for(let s=0;s<this.numLayers;s++){const l=d[s];if(!this.layerVisibility[l+1])continue;const y=p[l],w=l*this.numLayerColors,g=Math.floor(m[l]*r),v=n==t.FlipnoteStereoscopicEye.Left?-g:g;for(let t=c,s=0;t<f;t++,s++)for(let r=u,n=0;r<a;r++,n++){const a=s*o+n+v;let f=y[t*h+r];0!==f&&(i[a]=e[w+f])}}return i}getFramePaletteUint32(t,s=new Uint32Array(16)){l(t,0,this.frameCount-1,"Frame index");const i=this.getFramePalette(t);return s.fill(0),i.forEach((([t,i,e,r],n)=>s[n]=r<<24|e<<16|i<<8|t)),s}getSoundEffectFlagsForTrack(t){return this.getSoundEffectFlags().map((s=>s[t]))}isSoundEffectUsedOnFrame(t,s){return l(s,0,this.frameCount-1,"Frame index"),!!this.soundEffectTracks.includes(t)&&this.getFrameSoundEffectFlags(s)[t]}hasAudioTrack(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0}}const P=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,A=["01FACA7A4367FC5F","03D6E959E2F9A42D","03F80445160587FA","04068426E1008915","092A3EC8199FD5D5","0B8D56BA1BD441B8","0E61C75C9B5AD90B","14E494E35A443235"],F=t=>P.test(t)||A.includes(t),b=s=>{switch(s.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}},M=new Int8Array([-1,2,-1,2]),z=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),S=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),k=(t,s,i)=>i<0||i>=s?0:t[i],U=t=>{const s=t.length;let i=0;for(let e=0;e<s;e++){const s=t[e];(s<=-32768||s>=32767)&&(i+=1)}return i/s},_=t=>{const s=t.length;let i=0;for(let e=0;e<s;e++)i+=Math.pow(t[e],2);return Math.sqrt(i/s)},x=946684800,T=t=>new Date(1e3*(t+x)),E=t=>Math.floor(t.getTime()/1e3-x),W=(t,s)=>100*t*(1/s)/100,I=(()=>{if(p||g){const t=m();return(t.crypto||t.msCrypto).subtle}if(w)return((t,s)=>{try{return t.require(s)}catch{throw new Error(`Could not require(${s})`)}})(module,"crypto").webcrypto.subtle})(),C="RSASSA-PKCS1-v1_5",B=async(t,s)=>{const i=t.split("\n").filter((t=>!t.startsWith("-----")&&!t.endsWith("-----"))).join(""),e=atob(i),r=new Uint8Array(e.length).map(((t,s)=>e.charCodeAt(s)));return await I.importKey("spki",r.buffer,{name:C,hash:s},!1,["verify"])},K=async(t,s,i)=>await I.verify(C,t,s,i);var $,D,N,L,O,j,R,G,H,V,q,Q,Y,J,Z,X,tt,st;const it=[.5,.5,1,2,4,6,12,20,30],et={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},rt=[4294967295,4283585106,4294967295,4288453788,4282665215,4283388360,4289506815,4278255360,4294918216,4290269009,4294945709,4278255360,4290205622,4278255360,4278255360,4278255360],nt="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCPLwTL6oSflv+gjywi/sM0TUB\n90xqOvuCpjduETjPoN2FwMebxNjdKIqHUyDu4AvrQ6BDJc6gKUbZ1E27BGZoCPH4\n9zQRb+zAM6M9EjHwQ6BABr0u2TcF7xGg2uQ9MBWz9AfbVQ91NjfrNWo0f7UPmffv\n1VvixmTk1BCtavZxBwIDAQAB\n-----END PUBLIC KEY-----";class PpmParser extends BaseParser{static matchBuffer(t){const s=new Uint8Array(t.slice(0,4));return 1346458177==(s[0]<<24|s[1]<<16|s[2]<<8|s[3])}constructor(s,i={}){super(s),$.add(this),this.format=t.FlipnoteFormat.PPM,this[st]="Flipnote Studio PPM animation file",this.imageWidth=PpmParser.width,this.imageHeight=PpmParser.height,this.aspect=PpmParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=PpmParser.numLayers,this.numLayerColors=PpmParser.numLayerColors,this.publicKey=PpmParser.publicKey,this.srcWidth=PpmParser.width,this.audioTracks=PpmParser.audioTracks,this.soundEffectTracks=PpmParser.soundEffectTracks,this.rawSampleRate=PpmParser.rawSampleRate,this.sampleRate=PpmParser.sampleRate,this.globalPalette=PpmParser.globalPalette,D.set(this,void 0),N.set(this,void 0),L.set(this,void 0),O.set(this,void 0),j.set(this,null),R.set(this,void 0),G.set(this,void 0),H.set(this,void 0),V.set(this,void 0),o(this,$,"m",q).call(this),o(this,$,"m",J).call(this),o(this,$,"m",Z).call(this),this.version>>4&15&&o(this,$,"m",Y).call(this),a(this,D,[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],"f"),a(this,L,[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],"f"),a(this,O,[new Uint8Array(PpmParser.height),new Uint8Array(PpmParser.height)],"f"),a(this,j,null,"f")}getThumbnailImage(){this.seek(160);const s=this.readBytes(1536),i=new Uint32Array(3072);for(let t=0;t<48;t+=8)for(let e=0;e<64;e+=8)for(let r=0;r<8;r+=1)for(let n=0;n<8;n+=2){const h=e+n,o=t+r;i[64*o+h]=rt[15&s[0]],i[64*o+h+1]=rt[s[0]<<4&15]}return{format:t.FlipnoteThumbImageFormat.Rgba,width:64,height:48,data:i.buffer}}decodeFrame(t){if(l(t,0,this.frameCount-1,"Frame index"),o(this,j,"f")===t)return o(this,D,"f");o(this,j,"f")===t-1||o(this,$,"m",X).call(this,t)||0===t||this.decodeFrame(t-1),a(this,j,t,"f"),this.seek(o(this,V,"f")[t]);const s=this.readUint8(),i=s>>7&1,e=s>>5&3;o(this,D,"f")[0].fill(0),o(this,D,"f")[1].fill(0);let r=0,n=0;e&&(r=this.readInt8(),n=this.readInt8());for(let t=0;t<2;t++){const s=o(this,O,"f")[t];s.fill(0);for(let t=0;t<s.length;){let i=this.readUint8();0!==i?(s[t++]=3&i,s[t++]=i>>2&3,s[t++]=i>>4&3,s[t++]=i>>6&3):t+=4}}for(let t=0;t<2;t++){const s=o(this,D,"f")[t],i=o(this,O,"f")[t];for(let t=0;t<PpmParser.height;t++){let e=t*PpmParser.width;switch(i[t]){case 0:break;case 1:for(var h=this.readUint32(!1);0!==h;h<<=1,e+=8)if(2147483648&h){let t=this.readUint8();for(let i=0;0!==t;i++,t>>=1)s[e+i]=1&t}break;case 2:for(s.fill(1,e,e+PpmParser.width),h=this.readUint32(!1);0!==h;h<<=1,e+=8)if(2147483648&h){let t=this.readUint8();for(let i=0;i<8;i++,t>>=1)s[e+i]=1&t}break;case 3:for(let t=0,i=0;i<PpmParser.width;i++)i%8==0&&(t=this.readUint8()),s[e++]=1&t,t>>=1}}}const f=o(this,D,"f")[0],u=o(this,D,"f")[1],c=o(this,L,"f")[0],d=o(this,L,"f")[1];if(i||0!==r||0!==n){if(!i){const t=PpmParser.width,s=PpmParser.height,i=Math.max(r,0),e=Math.max(n,0),h=Math.min(t+r,t),o=Math.min(s+n,s),a=n*t+r;let l,m;for(let s=e;s<o;s++)for(let e=i;e<h;e++)l=s*t+e,m=l-a,f[l]^=c[m],u[l]^=d[m]}}else{const t=PpmParser.height*PpmParser.width;for(let s=0;s<t;s++)f[s]^=c[s],u[s]^=d[s]}return o(this,L,"f")[0].set(o(this,D,"f")[0]),o(this,L,"f")[1].set(o(this,D,"f")[1]),o(this,D,"f")}getFramePaletteIndices(t){l(t,0,this.frameCount-1,"Frame index"),this.seek(o(this,V,"f")[t]);const s=this.readUint8(),i=!!(1&~s),e=[i?0:1,i?0:1,2,3];return[i?1:0,e[s>>1&3],e[s>>3&3]]}getFramePalette(t){return l(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((t=>this.globalPalette[t]))}getIsKeyFrame(t){const s=1===o(this,$,"m",X).call(this,t);return[s,s]}getFrameLayerDepths(t){return[0,0]}getFrameAuthor(t){return this.meta.current.fsid}getFrameCameraFlags(t){return[!1,!1]}getFrameLayerOrder(t){return[1,0]}decodeSoundFlags(){if(void 0!==o(this,N,"f"))return o(this,N,"f");c(1696+o(this,R,"f")<this.numBytes),this.seek(1696+o(this,R,"f"));const t=this.frameCount,s=this.readBytes(t);a(this,N,new Array(t),"f");for(let i=0;i<t;i++){const t=s[i];o(this,N,"f")[i]=[!!(1&t),!!(2&t),!!(4&t)]}return o(this,N,"f")}getSoundEffectFlags(){return this.decodeSoundFlags().map((s=>({[t.FlipnoteSoundEffectTrack.SE1]:s[0],[t.FlipnoteSoundEffectTrack.SE2]:s[1],[t.FlipnoteSoundEffectTrack.SE3]:s[2],[t.FlipnoteSoundEffectTrack.SE4]:!1})))}getFrameSoundEffectFlags(s){l(s,0,this.frameCount-1,"Frame index"),this.seek(1696+o(this,R,"f")+s);const i=this.readUint8();return{[t.FlipnoteSoundEffectTrack.SE1]:!!(1&i),[t.FlipnoteSoundEffectTrack.SE2]:!!(2&i),[t.FlipnoteSoundEffectTrack.SE3]:!!(4&i),[t.FlipnoteSoundEffectTrack.SE4]:!1}}getAudioTrackRaw(t){const s=this.soundMeta.get(t);return c(s.ptr+s.length<this.numBytes),this.seek(s.ptr),this.readBytes(s.length)}decodeAudioTrack(t){const s=this.getAudioTrackRaw(t),i=s.length,e=new Int16Array(2*i);let r=0,n=0,h=0,o=0,a=0,f=!0;for(;r<i;){h=f?15&s[r]:s[r++]>>4,f=!f;const t=S[o];let i=t>>3;1&h&&(i+=t>>2),2&h&&(i+=t>>1),4&h&&(i+=t),8&h&&(i=-i),a+=i,a=u(a,-32768,32767),o+=z[h],o=u(o,0,88),e[n++]=a}return e}getAudioTrackPcm(s,i=this.sampleRate){const e=this.decodeAudioTrack(s);let r=this.rawSampleRate;if(s===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==i?((t,s,i)=>{const e=t.length,r=e/s*i,n=new Int16Array(r),h=s/i;for(let s=0;s<r;s++)n[s]=k(t,e,Math.floor(s*h));return n})(e,r,i):e}getAudioMasterPcm(s=this.sampleRate){const i=Math.ceil(this.duration*s),e=new Int16Array(i),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),h=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(r){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,s);o(this,$,"m",tt).call(this,i,e,0)}if(n||h||a){const i=s/this.framerate,r=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,s):null,f=h?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,s):null,u=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,s):null,c=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const s=Math.ceil(t*i),l=c[t];n&&l[0]&&o(this,$,"m",tt).call(this,r,e,s),h&&l[1]&&o(this,$,"m",tt).call(this,f,e,s),a&&l[2]&&o(this,$,"m",tt).call(this,u,e,s)}}return this.audioClipRatio=U(e),e}getBody(){const t=o(this,H,"f")+o(this,G,"f")+32;return this.bytes.subarray(0,t)}getSignature(){const t=o(this,H,"f")+o(this,G,"f")+32;return this.bytes.subarray(t,t+128)}async verify(){const t=await B(nt,"SHA-1");return await K(t,this.getSignature(),this.getBody())}}D=new WeakMap,N=new WeakMap,L=new WeakMap,O=new WeakMap,j=new WeakMap,R=new WeakMap,G=new WeakMap,H=new WeakMap,V=new WeakMap,$=new WeakSet,st=Symbol.toStringTag,q=function(){c(16<this.numBytes),this.seek(4),a(this,R,this.readUint32(),"f"),a(this,G,this.readUint32(),"f"),this.frameCount=this.readUint16()+1,this.version=this.readUint16();let t=1696+o(this,R,"f")+this.frameCount;t%4!=0&&(t+=4-t%4),c(t<this.numBytes),a(this,H,t,"f")},Q=function(){return`${this.readHex(3)}_${this.readChars(13)}_${this.readUint16().toString().padStart(3,"0")}`},Y=function(){c(1704<this.numBytes),this.seek(16);const t=this.readUint16(),s=this.readInt16(),i=this.readWideChars(11),e=this.readWideChars(11),r=this.readWideChars(11),n=this.readHex(8,!0),h=this.readHex(8,!0),a=o(this,$,"m",Q).call(this),f=o(this,$,"m",Q).call(this),u=this.readHex(8,!0);this.seek(154);const l=T(this.readInt32());this.seek(1702);const d=this.readUint16();this.thumbFrameIndex=s,this.layerVisibility={1:!(16&d),2:!(32&d),3:!1},this.isSpinoff=h!==n||h!==u,this.meta={lock:1===t,loop:1==(d>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:s,timestamp:l,root:{username:i,fsid:u,region:b(u),filename:null},parent:{username:e,fsid:n,region:b(n),filename:a},current:{username:r,fsid:h,region:b(h),filename:f}}},J=function(){this.seek(1696);const t=this.readUint16(),s=t/4;c(s<=this.frameCount),this.seek(1704);const i=new Uint32Array(s);for(let e=0;e<s;e++){const s=1704+t+this.readUint32();c(s<this.numBytes,`Frame ${e} pointer is out of bounds`),i[e]=s}a(this,V,i,"f")},Z=function(){let s=o(this,H,"f");this.seek(s);const i=this.readUint32(),e=this.readUint32(),r=this.readUint32(),n=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),c(this.frameSpeed<=8&&this.bgmSpeed<=8),s+=32,this.framerate=it[this.frameSpeed],this.duration=W(this.frameCount,this.framerate),this.bgmrate=it[this.bgmSpeed];const h=new Map;h.set(t.FlipnoteAudioTrack.BGM,{ptr:s,length:i}),h.set(t.FlipnoteAudioTrack.SE1,{ptr:s+=i,length:e}),h.set(t.FlipnoteAudioTrack.SE2,{ptr:s+=e,length:r}),h.set(t.FlipnoteAudioTrack.SE3,{ptr:s+=r,length:n}),this.soundMeta=h},X=function(t){return l(t,0,this.frameCount-1,"Frame index"),this.seek(o(this,V,"f")[t]),this.readUint8()>>7&1},tt=function(t,s,i=0){const e=t.length,r=s.length;for(let n=0;n<e&&!(i+n>r);n++){const e=s[i+n]+t[n]/2;s[i+n]=u(e,-32768,32767)}},PpmParser.defaultSettings={},PpmParser.format=t.FlipnoteFormat.PPM,PpmParser.width=256,PpmParser.height=192,PpmParser.aspect=3/4,PpmParser.numLayers=2,PpmParser.numLayerColors=1,PpmParser.rawSampleRate=8192,PpmParser.sampleRate=32768,PpmParser.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3],PpmParser.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3],PpmParser.globalPalette=[et.WHITE,et.BLACK,et.RED,et.BLUE],PpmParser.publicKey=nt;const ht=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,ot=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/,at=["5f-fc67-437a-cafa01","2d-a4f9-e259-e9d603","fa-8705-1645-04f803","15-8900-e126-840604","d5-d59f-19c8-3e2a09","b8-41d4-1bba-568d0b","0b-d95a-9b5c-c7610e","35-3244-5ae3-94e414"],ft=t=>ht.test(t),ut=t=>{if(ot.test(t))return!0;for(let s of at)if(t.endsWith(s))return!0;return!1},ct=s=>{if(ut(s))switch(s.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}return t.FlipnoteRegion.UNKNOWN},lt=t=>`${t.slice(0,4)}-${t.slice(4,8)}-${t.slice(8,12)}-${t.slice(12,18)}`.toLowerCase(),dt=t=>t.replace(/-/g,"").toUpperCase();var mt,pt,yt,wt,gt,vt,Pt,At,Ft,bt,Mt,zt,St,kt,Ut,_t,xt,Tt,Et,Wt,It;const Ct=[.2,.5,1,2,4,6,8,12,20,24,30],Bt={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},Kt="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuv+zHAXXvbbtRqxADDeJ\nArX2b9RMxj3T+qpRg3FnIE/jeU3tj7eoDzsMduY+D/UT9CSnP+QHYY/vf0n5lqX9\ns6ljoZAmyUuruyj1e5Bg+fkDEu/yPEPQjqhbyywCyYL4TEAOJveopUBx9fdQxUJ6\nJ4J5oCE/Im1kFrlGW+puARiHmt3mmUyNzO8bI/Jx3cGSfoOHJG1foEaQsI5aaKqA\npBqxtzvwqMhudcZtAWSyRMBMlndvkRnVTDNTfTXLOYdHShCIgnKULCTH87uLBIP/\nnsmr4/bnQz8q2rp/HyVO+0yjR6mVr0NX5APJQ+6riJmGg3t3VOldhKP7aTHDUW+h\nkQIDAQAB\n-----END PUBLIC KEY-----",$t=new Uint16Array(16);for(let t=0;t<16;t++)$t[t]=(1<<t)-1;const Dt=new Uint8Array(52488),Nt=new Uint8Array(52488);var Lt=0;for(let t=0;t<3;t++)for(let s=0;s<3;s++)for(let i=0;i<3;i++)for(let e=0;e<3;e++)for(let r=0;r<3;r++)for(let n=0;n<3;n++)for(let h=0;h<3;h++)for(let o=0;o<3;o++)Dt.set([s,t,e,i,n,r,o,h],Lt),Nt.set([t,e,i,n,r,o,h,s],Lt),Lt+=8;const Ot=new Uint8Array(256),jt=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach(((t,s)=>{const i=8*t,e=Dt.subarray(i,i+8),r=Nt.subarray(i,i+8);Ot.set(e,8*s),jt.set(r,8*s)}));class KwzParser extends BaseParser{static matchBuffer(t){const s=new Uint8Array(t.slice(0,4)),i=s[0]<<24|s[1]<<16|s[2]<<8;return 1262897152===i||1263092480===i}constructor(s,i={}){super(s),mt.add(this),this.format=t.FlipnoteFormat.KWZ,this[It]="Flipnote Studio 3D KWZ animation file",this.imageWidth=KwzParser.width,this.imageHeight=KwzParser.height,this.aspect=KwzParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=KwzParser.numLayers,this.numLayerColors=KwzParser.numLayerColors,this.publicKey=KwzParser.publicKey,this.srcWidth=KwzParser.width,this.audioTracks=KwzParser.audioTracks,this.soundEffectTracks=KwzParser.soundEffectTracks,this.rawSampleRate=KwzParser.rawSampleRate,this.sampleRate=KwzParser.sampleRate,this.globalPalette=KwzParser.globalPalette,pt.set(this,void 0),yt.set(this,void 0),wt.set(this,void 0),gt.set(this,void 0),vt.set(this,void 0),Pt.set(this,null),At.set(this,void 0),Ft.set(this,void 0),bt.set(this,void 0),Mt.set(this,0),zt.set(this,0),a(this,pt,{...KwzParser.defaultSettings,...i},"f"),a(this,gt,[new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height)],"f"),o(this,mt,"m",St).call(this),o(this,yt,"f").has("KIC")?(this.isFolderIcon=!0,this.imageWidth=24,this.imageHeight=24,this.frameCount=1,this.frameSpeed=0,this.framerate=Ct[0],this.thumbFrameIndex=0,o(this,mt,"m",Et).call(this)):o(this,yt,"f").has("KSN")?(o(this,mt,"m",xt).call(this),o(this,mt,"m",Et).call(this),o(this,mt,"m",Wt).call(this)):(this.isComment=!0,o(this,mt,"m",xt).call(this),o(this,mt,"m",Et).call(this)),o(this,pt,"f").dsiLibraryNote&&(this.isDsiLibraryNote=!0),o(this,pt,"f").borderCrop&&(this.isDsiLibraryNote?(this.imageOffsetX=32,this.imageOffsetY=24,this.imageWidth=256,this.imageHeight=192):this.isFolderIcon||(this.imageOffsetX=5,this.imageOffsetY=5,this.imageWidth=310,this.imageHeight=230))}getThumbnailImage(){c(o(this,yt,"f").has("KTN"),"KTN section missing - Note that folder icons and comments do not contain thumbnail data");const s=o(this,yt,"f").get("KTN");this.seek(s.ptr+12);const i=this.readBytes(s.length-12);return{format:t.FlipnoteThumbImageFormat.Jpeg,width:80,height:64,data:i.buffer}}getFramePaletteIndices(t){l(t,0,this.frameCount-1,"Frame index"),this.seek(o(this,At,"f")[t]);const s=this.readUint32();return[15&s,s>>8&15,s>>12&15,s>>16&15,s>>20&15,s>>24&15,s>>28&15]}getFramePalette(t){return l(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((t=>this.globalPalette[t]))}getFrameDiffingFlag(t){return l(t,0,this.frameCount-1,"Frame index"),this.seek(o(this,At,"f")[t]),this.readUint32()>>4&7}getIsKeyFrame(t){const s=this.getFrameDiffingFlag(t);return[!(1&s),!(2&s),!(4&s)]}getFrameLayerDepths(t){return l(t,0,this.frameCount-1,"Frame index"),this.seek(o(this,At,"f")[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]}getFrameAuthor(t){return l(t,0,this.frameCount-1,"Frame index"),this.seek(o(this,At,"f")[t]+10),o(this,mt,"m",Ut).call(this)}getFrameCameraFlags(t){this.seek(o(this,At,"f")[t]+26);const s=this.readUint8();return[!!(1&s),!!(2&s),!!(4&s)]}getFrameLayerOrder(t){l(t,0,this.frameCount-1,"Frame index");const s=this.getFrameLayerDepths(t);return[2,1,0].sort(((t,i)=>s[i]-s[t]))}decodeFrame(t,s=7,i=!1){if(l(t,0,this.frameCount-1,"Frame index"),o(this,Pt,"f")===t)return o(this,gt,"f");o(this,Pt,"f")!==t-1&&0!==t&&(i&&(s&=~this.getFrameDiffingFlag(t+1)),0!==s&&this.decodeFrame(t-1,s,!0));let e=o(this,Ft,"f")[t];const r=o(this,bt,"f")[t];for(let t=0;t<3&&(!o(this,pt,"f").dsiLibraryNote||3!==t);t++){this.seek(e);let i=r[t];e+=i;const n=o(this,gt,"f")[t];if(38===i)continue;if(!(s>>t&1))continue;a(this,Mt,16,"f"),a(this,zt,0,"f");let h=0;for(let t=0;t<240;t+=128)for(let s=0;s<320;s+=128)for(let i=0;i<128;i+=8){const e=t+i;if(e>=240)break;for(let t=0;t<128;t+=8){const i=s+t;if(i>=320)break;if(h>0){h-=1;continue}let r=e*KwzParser.width+i;const a=o(this,mt,"m",kt).call(this,3);if(0===a){const t=8*o(this,mt,"m",kt).call(this,5),s=Ot.subarray(t,t+8);n.set(s,r),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320)}else if(1===a){const t=8*o(this,mt,"m",kt).call(this,13),s=Dt.subarray(t,t+8);n.set(s,r),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320)}else if(2===a){const t=8*o(this,mt,"m",kt).call(this,5),s=Ot.subarray(t,t+8),i=jt.subarray(t,t+8);n.set(s,r),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320)}else if(3===a){const t=8*o(this,mt,"m",kt).call(this,13),s=Dt.subarray(t,t+8),i=Nt.subarray(t,t+8);n.set(s,r),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320)}else if(4===a){const t=o(this,mt,"m",kt).call(this,8);for(let s=1;s<255;s<<=1){if(t&s){const t=8*o(this,mt,"m",kt).call(this,5),s=Ot.subarray(t,t+8);n.set(s,r)}else{const t=8*o(this,mt,"m",kt).call(this,13),s=Dt.subarray(t,t+8);n.set(s,r)}r+=320}}else{if(5===a){h=o(this,mt,"m",kt).call(this,5);continue}if(7===a){let t,s,i=o(this,mt,"m",kt).call(this,2);if(0!==o(this,mt,"m",kt).call(this,1)){const e=8*o(this,mt,"m",kt).call(this,5),r=8*o(this,mt,"m",kt).call(this,5);t=Ot.subarray(e,e+8),s=Ot.subarray(r,r+8),i+=1}else{const i=8*o(this,mt,"m",kt).call(this,13),e=8*o(this,mt,"m",kt).call(this,13);t=Dt.subarray(i,i+8),s=Dt.subarray(e,e+8)}switch(i%4){case 0:n.set(t,r),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320);break;case 1:n.set(t,r),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(t,r+=320);break;case 2:n.set(t,r),n.set(s,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(s,r+=320);break;case 3:n.set(t,r),n.set(s,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320)}}}}}}return a(this,Pt,t,"f"),o(this,gt,"f")}decodeFrameSoundFlags(t){l(t,0,this.frameCount-1,"Frame index"),this.seek(o(this,At,"f")[t]+23);const s=this.readUint8();return[!!(1&s),!!(2&s),!!(4&s),!!(8&s)]}decodeSoundFlags(){return void 0!==o(this,vt,"f")||a(this,vt,new Array(this.frameCount).fill(!1).map(((t,s)=>this.decodeFrameSoundFlags(s))),"f"),o(this,vt,"f")}getSoundEffectFlags(){return this.decodeSoundFlags().map((s=>({[t.FlipnoteSoundEffectTrack.SE1]:s[0],[t.FlipnoteSoundEffectTrack.SE2]:s[1],[t.FlipnoteSoundEffectTrack.SE3]:s[2],[t.FlipnoteSoundEffectTrack.SE4]:s[3]})))}getFrameSoundEffectFlags(s){const i=this.decodeFrameSoundFlags(s);return{[t.FlipnoteSoundEffectTrack.SE1]:i[0],[t.FlipnoteSoundEffectTrack.SE2]:i[1],[t.FlipnoteSoundEffectTrack.SE3]:i[2],[t.FlipnoteSoundEffectTrack.SE4]:i[3]}}getAudioTrackRaw(t){const s=this.soundMeta.get(t);return c(s.ptr+s.length<this.numBytes),new Uint8Array(this.buffer,s.ptr,s.length)}decodeAdpcm(t,s,i=0,e=0){const r=t.length;let n=0,h=0,o=0,a=0;for(let f=0;f<r;f++){let r=t[f],c=0;for(;c<8;)e<18||c>4?(h=3&r,o=S[e],a=o>>3,1&h&&(a+=o),2&h&&(a=-a),i+=a,e+=M[h],r>>=2,c+=2):(h=15&r,o=S[e],a=o>>3,1&h&&(a+=o>>2),2&h&&(a+=o>>1),4&h&&(a+=o),8&h&&(a=-a),i+=a,e+=z[h],r>>=4,c+=4),e=u(e,0,79),i=u(i,-2048,2047),s[n]=16*i,n+=1}return n}decodeAudioTrack(s){const i=o(this,pt,"f"),e=this.getAudioTrackRaw(s),r=60*this.rawSampleRate,n=new Int16Array(r);let h=0,a=40;if(this.isDsiLibraryNote)if(s===t.FlipnoteAudioTrack.BGM){let t=!0;if(null!==i.initialBgmPredictor&&(h=i.initialBgmPredictor,t=!1),null!==i.initialBgmStepIndex&&(a=i.initialBgmStepIndex,t=!1),t&&i.guessInitialBgmState){let t=4294967295,s=0;for(a=0;a<=40;a++){const i=this.decodeAdpcm(e,n,h,a),r=_(n.subarray(0,i));r<t&&(t=r,s=a)}a=s}}else{const t=this.soundEffectTracks.indexOf(s);Array.isArray(i.initialSePredictors)&&void 0!==i.initialSePredictors[t]&&(h=i.initialSePredictors[t]),Array.isArray(i.initialSeStepIndices)&&void 0!==i.initialSeStepIndices[t]&&(a=i.initialSeStepIndices[t])}const f=this.decodeAdpcm(e,n,h,a);return n.slice(0,f)}getAudioTrackPcm(s,i=this.sampleRate){const e=this.decodeAudioTrack(s);let r=this.rawSampleRate;if(s===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==i?((t,s,i)=>{const e=t.length,r=e/s*i,n=new Int16Array(r),h=s/i;for(let s=0,i=0,a=0,f=0;s<r;s++)i=s*h,a=Math.floor(i),f=i%1,n[s]=(o=k(t,e,a))+f*(k(t,e,a+1)-o);var o;return n})(e,r,i):e}pcmAudioMix(t,s,i=0){const e=t.length,r=s.length;for(let n=0;n<e&&!(i+n>r);n++){const e=s[i+n]+t[n];s[i+n]=u(e,-32768,32767)}}getAudioMasterPcm(s=this.sampleRate){const i=Math.ceil(this.duration*s),e=new Int16Array(i),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),h=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(r){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,s);this.pcmAudioMix(i,e,0)}if(n||h||o||a){const i=s/this.framerate,r=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,s):null,f=h?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,s):null,u=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,s):null,c=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,s):null,l=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const s=l[t],d=Math.ceil(t*i);n&&s[0]&&this.pcmAudioMix(r,e,d),h&&s[1]&&this.pcmAudioMix(f,e,d),o&&s[2]&&this.pcmAudioMix(u,e,d),a&&s[3]&&this.pcmAudioMix(c,e,d)}}return this.audioClipRatio=U(e),e}getBody(){const t=o(this,wt,"f");return this.bytes.subarray(0,t)}getSignature(){const t=o(this,wt,"f");return this.bytes.subarray(t,t+256)}async verify(){const t=await B(Kt,"SHA-256");return await K(t,this.getSignature(),this.getBody())}}pt=new WeakMap,yt=new WeakMap,wt=new WeakMap,gt=new WeakMap,vt=new WeakMap,Pt=new WeakMap,At=new WeakMap,Ft=new WeakMap,bt=new WeakMap,Mt=new WeakMap,zt=new WeakMap,mt=new WeakSet,It=Symbol.toStringTag,St=function(){const t=this.numBytes-256,s=new Map;let i=0,e=0;for(;e<t&&i<6;){this.seek(e);const t=this.readChars(4).substring(0,3),r=this.readUint32();s.set(t,{ptr:e,length:r}),e+=r+8,i+=1}a(this,wt,e,"f"),a(this,yt,s,"f"),c(s.has("KMC")&&s.has("KMI"))},kt=function(t){if(o(this,Mt,"f")+t>16){const t=this.readUint16();a(this,zt,o(this,zt,"f")|t<<16-o(this,Mt,"f"),"f"),a(this,Mt,o(this,Mt,"f")-16,"f")}const s=o(this,zt,"f")&$t[t];return a(this,zt,o(this,zt,"f")>>t,"f"),a(this,Mt,o(this,Mt,"f")+t,"f"),s},Ut=function(){return o(this,pt,"f").dsiLibraryNote?this.readHex(10,!0).slice(2,18):lt(this.readHex(10))},_t=function(){const t=this.pointer,s=this.readChars(28);if(28===s.length)return s;this.seek(t);const i=this.readHex(3),e=this.readChars(13),r=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),`${i}_${e}_${r}`},xt=function(){if(o(this,pt,"f").quickMeta)return o(this,mt,"m",Tt).call(this);c(o(this,yt,"f").has("KFH")),this.seek(o(this,yt,"f").get("KFH").ptr+12);const t=T(this.readUint32()),s=T(this.readUint32());this.readUint32();const i=o(this,mt,"m",Ut).call(this),e=o(this,mt,"m",Ut).call(this),r=o(this,mt,"m",Ut).call(this),n=this.readWideChars(11),h=this.readWideChars(11),a=this.readWideChars(11),f=o(this,mt,"m",_t).call(this),u=o(this,mt,"m",_t).call(this),l=o(this,mt,"m",_t).call(this),d=this.readUint16(),m=this.readUint16(),p=this.readUint16(),y=this.readUint8(),w=this.readUint8();this.isSpinoff=r!==e||r!==i,this.frameCount=d,this.frameSpeed=y,this.framerate=Ct[y],this.duration=W(this.frameCount,this.framerate),this.thumbFrameIndex=m,this.layerVisibility={1:!(1&w),2:!(2&w),3:!(3&w)},this.meta={lock:!!(1&p),loop:!!(2&p),isSpinoff:this.isSpinoff,frameCount:d,frameSpeed:y,duration:this.duration,thumbIndex:m,timestamp:s,creationTimestamp:t,root:{username:n,fsid:i,region:ct(i),filename:f,isDsiFilename:28!==f.length},parent:{username:h,fsid:e,region:ct(e),filename:u,isDsiFilename:28!==u.length},current:{username:a,fsid:r,region:ct(r),filename:l,isDsiFilename:28!==l.length}}},Tt=function(){c(o(this,yt,"f").has("KFH")),this.seek(o(this,yt,"f").get("KFH").ptr+8+196);const t=this.readUint16(),s=this.readUint16();this.readUint16();const i=this.readUint8(),e=this.readUint8();this.frameCount=t,this.thumbFrameIndex=s,this.frameSpeed=i,this.framerate=Ct[i],this.duration=W(this.frameCount,this.framerate),this.layerVisibility={1:!(1&e),2:!(2&e),3:!(3&e)}},Et=function(){c(o(this,yt,"f").has("KMI")&&o(this,yt,"f").has("KMC"));const t=this.frameCount,s=o(this,yt,"f").get("KMI"),i=o(this,yt,"f").get("KMC");c(s.length/28>=t);const e=new Uint32Array(t),r=new Uint32Array(t),n=[];let h=s.ptr+8,f=i.ptr+12;for(let s=0;s<t;s++){this.seek(h+4);const t=this.readUint16(),i=this.readUint16(),o=this.readUint16();e[s]=h,r[s]=f,h+=28,f+=t+i+o,c(h<this.numBytes,`frame${s} meta pointer out of bounds`),c(f<this.numBytes,`frame${s} data pointer out of bounds`),n.push([t,i,o])}a(this,At,e,"f"),a(this,Ft,r,"f"),a(this,bt,n,"f")},Wt=function(){c(o(this,yt,"f").has("KSN"));let s=o(this,yt,"f").get("KSN").ptr+8;this.seek(s),this.bgmSpeed=this.readUint32(),c(this.bgmSpeed<=10),this.bgmrate=Ct[this.bgmSpeed];const i=new Uint32Array(this.buffer,s+4,20),e=new Map;e.set(t.FlipnoteAudioTrack.BGM,{ptr:s+=28,length:i[0]}),e.set(t.FlipnoteAudioTrack.SE1,{ptr:s+=i[0],length:i[1]}),e.set(t.FlipnoteAudioTrack.SE2,{ptr:s+=i[1],length:i[2]}),e.set(t.FlipnoteAudioTrack.SE3,{ptr:s+=i[2],length:i[3]}),e.set(t.FlipnoteAudioTrack.SE4,{ptr:s+=i[3],length:i[4]}),this.soundMeta=e},KwzParser.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,guessInitialBgmState:!0,initialBgmPredictor:null,initialBgmStepIndex:null,initialSePredictors:null,initialSeStepIndices:null},KwzParser.format=t.FlipnoteFormat.KWZ,KwzParser.width=320,KwzParser.height=240,KwzParser.aspect=3/4,KwzParser.numLayers=3,KwzParser.numLayerColors=2,KwzParser.rawSampleRate=16364,KwzParser.sampleRate=32768,KwzParser.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3,t.FlipnoteAudioTrack.SE4],KwzParser.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3,t.FlipnoteSoundEffectTrack.SE4],KwzParser.globalPalette=[Bt.WHITE,Bt.BLACK,Bt.RED,Bt.YELLOW,Bt.GREEN,Bt.BLUE,Bt.NONE],KwzParser.publicKey=Kt;const Rt=t=>F(t)?`${t.slice(14,16)}-${t.slice(12,14)}${t.slice(10,12)}-${t.slice(8,10)}${t.slice(6,8)}-${t.slice(4,6)}${t.slice(2,4)}${t.slice(0,2)}`.toLocaleLowerCase():null;var Gt=Object.freeze({__proto__:null,getFsidRegion:s=>F(s)?b(s):ft(s)?ct(s):t.FlipnoteRegion.UNKNOWN,getKwzFsidRegion:ct,getPpmFsidRegion:b,isFsid:t=>F(t)||ft(t),isKwzDsiLibraryFsid:ut,isKwzFsid:ft,isPpmFsid:F,kwzFsidFormat:lt,kwzFsidToPpmFsid:t=>ut(t)?`${t.slice(19,21)}${t.slice(17,19)}${t.slice(15,17)}${t.slice(12,14)}${t.slice(10,12)}${t.slice(7,9)}${t.slice(5,7)}${t.slice(2,4)}`.toUpperCase():null,kwzFsidUnformat:dt,ppmFsidToKwzFsidSuffix:Rt,ppmFsidToPossibleKwzFsids(t){const s=Rt(t);return s?["00"+s,"10"+s,"12"+s,"14"+s]:null}});const Ht=/^[0-9A-Z]{1}[0-9A-F]{5}_[0-9A-F]{13}_[0-9]{3}$/,Vt=/^[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}$/,qt=/^[0-5a-z]{28}$/,Qt="cwmfjordvegbalksnthpyxquiz012345";var Yt=Object.freeze({__proto__:null,isKwzFilename:t=>qt.test(t),isPpmBasicFilename:t=>Vt.test(t),isPpmFilename:t=>Ht.test(t),kwzFilenameDecode(t){const s=(t=>{const s=t.length;let i=0;const e=new Uint8Array(5*s/8);let r=0,n=0;for(let h=0;h<s;h++)n=n<<5|Qt.indexOf(t[h]),i+=5,i>=8&&(e[r++]=n>>>i-8&255,i-=8);return e})(t),i=new DataView(s.buffer);return{fsid:lt(f(s.slice(0,9))),created:T(i.getUint32(9,!0)),edited:T(i.getUint32(13,!0))}},kwzFilenameEncode(t){const s=new Uint8Array(17),i=new DataView(s.buffer),e=dt(t.fsid);return s.set(((t,s=!1)=>{const i=t.length,e=new Uint8Array(i/2);for(let s=0,r=0;s<i;s+=2)e[r++]=parseInt(t.slice(s,s+2),16);return s&&e.reverse(),e})(e)),i.setUint32(9,E(t.created),!0),i.setUint32(13,E(t.edited),!0),(t=>{const s=t.byteLength;let i=0,e="",r=0;for(let n=0;n<s;n++)for(r=r<<8|t[n],i+=8;i>=5;)e+=Qt[r>>>i-5&31],i-=5;return i>0&&(e+=Qt[r<<5-i&31]),e})(s)}});const Jt=[247,76,106,58,251,130,166,55,110,17,56,207,160,221,133,192,199,155,196,216,221,40,138,135,83,32,238,224,11,235,67,160,219,85,15,117,54,55,235,53,106,52,127,181,15,153,247,239,67,37,206,160,41,70,217,212,77,187,4,102,104,8,241,248];class BasePlaylistParser extends DataStream{constructor(t){super(t),this.entries=[]}addEntry(t){const s=t.split("/"),i=s.at(-1),e=t.lastIndexOf(".");this.entries.push({full:t,name:i,base:t.slice(0,e),ext:t.slice(e+1),folder:s.at(-2),parentFolder:s.at(-3)})}}class PpmPlaylist extends BasePlaylistParser{constructor(s){super(s),this.format=t.FlipnoteFormat.PPM;const i=this.bytes,e=this.numBytes;for(let t=0;t<e;t++)i[t]=i[t]^Jt[t%64];let r="";for(;!this.end();){const t=this.readChar();"\n"!==t?r+=t:(this.addEntry(r),r="")}}}class KwzPlaylist extends BasePlaylistParser{constructor(s){super(s),this.format=t.FlipnoteFormat.KWZ;const i=this.bytes,e=this.numBytes;for(let t=0;t<e;t++)i[t]=i[t]^Jt[t%61];let r="";this.seek(4);const n=this.readWideChar();for(;!this.end();){const t=this.readWideChar();t!==n?r+=t:(this.addEntry(r),r="")}}}const Zt={name:"url",matches(t){return"string"==typeof t},async load(t){const s=await fetch(t);return c(s.status>=200&&s.status<300,`Failed to load Flipnote from URL, response failed with status ${s.status}`),await s.arrayBuffer()}},Xt={name:"file",matches(t){return p&&"undefined"!=typeof File&&"undefined"!=typeof FileReader&&t instanceof File},async load(t){return t.arrayBuffer()}},ts={name:"blob",matches(t){return p&&"undefined"!=typeof Blob&&"undefined"!=typeof Response&&t instanceof Blob},async load(t){return t.arrayBuffer()}},ss={name:"node-buffer",matches(t){return w&&t instanceof Buffer},async load(t){return t.buffer}},is={name:"array-buffer",matches(t){return t instanceof ArrayBuffer},async load(t){return t}},es=new Map,rs=t=>{for(let[s,i]of es)if(i.matches(t))try{return i.load(t)}catch(t){d(`Failed to load Flipnote from source, loader "${s}" failed with error ${d}`)}d("No loader available for source type")},ns=t=>{es.set(t.name,t)};ns(is),ns(ss),ns(ts),ns(Xt),ns(Zt);var hs=Object.freeze({__proto__:null,clear:()=>es.clear(),list:()=>Object.fromEntries(es.entries()),load:rs,register:ns}),os=Object.freeze({__proto__:null,KwzPlaylist,PpmPlaylist,async parse(s,i){const e=await rs(i);return s===t.FlipnoteFormat.PPM||"ppm"===s?new PpmPlaylist(e):s===t.FlipnoteFormat.KWZ||"kwz"===s?new KwzPlaylist(e):void 0}});const as=async(t,s)=>{const i=await rs(t);return PpmParser.matchBuffer(i)?new PpmParser(i,s):KwzParser.matchBuffer(i)?new KwzParser(i,s):void d("Could not identify source as a valid Flipnote file")},fs=as;var us;t.PlayerEvent=void 0,(us=t.PlayerEvent||(t.PlayerEvent={})).t="any",us.Play="play",us.Pause="pause",us.CanPlay="canplay",us.CanPlayThrough="canplaythrough",us.SeekStart="seeking",us.SeekEnd="seeked",us.Duration="durationchange",us.Loop="loop",us.Ended="ended",us.VolumeChange="volumechange",us.Progress="progress",us.TimeUpdate="timeupdate",us.FrameUpdate="frameupdate",us.FrameNext="framenext",us.FramePrev="frameprev",us.FrameFirst="framefirst",us.FrameLast="framelast",us.Ready="ready",us.Load="load",us.LoadStart="loadstart",us.LoadedData="loadeddata",us.LoadedMeta="loadedmetadata",us.Emptied="emptied",us.Close="close",us.Error="error",us.Destroy="destroy";const cs=[t.PlayerEvent.Play,t.PlayerEvent.Pause,t.PlayerEvent.CanPlay,t.PlayerEvent.CanPlayThrough,t.PlayerEvent.SeekStart,t.PlayerEvent.SeekEnd,t.PlayerEvent.Duration,t.PlayerEvent.Loop,t.PlayerEvent.Ended,t.PlayerEvent.VolumeChange,t.PlayerEvent.Progress,t.PlayerEvent.TimeUpdate,t.PlayerEvent.FrameUpdate,t.PlayerEvent.FrameNext,t.PlayerEvent.FramePrev,t.PlayerEvent.FrameFirst,t.PlayerEvent.FrameLast,t.PlayerEvent.Ready,t.PlayerEvent.Load,t.PlayerEvent.LoadStart,t.PlayerEvent.LoadedData,t.PlayerEvent.LoadedMeta,t.PlayerEvent.Emptied,t.PlayerEvent.Close,t.PlayerEvent.Error],ls=t=>({length:t.length,start:s=>t[s][0],end:s=>t[s][1]}),ds=(t,s)=>t.toString().padStart(s,"0"),ms=t=>{const s=Math.floor(t%3600/60),i=Math.floor(t%60);return`${s}:${ds(i,2)}`};var ps;t.CanvasStereoscopicMode=void 0,(ps=t.CanvasStereoscopicMode||(t.CanvasStereoscopicMode={}))[ps.None=0]="None",ps[ps.Dual=1]="Dual",ps[ps.Anaglyph=2]="Anaglyph";const ys=5120,ws=5121,gs=5122,vs=5123,Ps=5124,As=5125,Fs=5126,bs={};{const t=bs;t[ys]=Int8Array,t[ws]=Uint8Array,t[gs]=Int16Array,t[vs]=Uint16Array,t[Ps]=Int32Array,t[As]=Uint32Array,t[Fs]=Float32Array,t[32819]=Uint16Array,t[32820]=Uint16Array,t[33635]=Uint16Array,t[5131]=Uint16Array,t[33640]=Uint32Array,t[35899]=Uint32Array,t[35902]=Uint32Array,t[36269]=Uint32Array,t[34042]=Uint32Array}function Ms(t){if(t instanceof Int8Array)return ys;if(t instanceof Uint8Array)return ws;if(t instanceof Uint8ClampedArray)return ws;if(t instanceof Int16Array)return gs;if(t instanceof Uint16Array)return vs;if(t instanceof Int32Array)return Ps;if(t instanceof Uint32Array)return As;if(t instanceof Float32Array)return Fs;throw new Error("unsupported typed array type")}function zs(t){if(t===Int8Array)return ys;if(t===Uint8Array)return ws;if(t===Uint8ClampedArray)return ws;if(t===Int16Array)return gs;if(t===Uint16Array)return vs;if(t===Int32Array)return Ps;if(t===Uint32Array)return As;if(t===Float32Array)return Fs;throw new Error("unsupported typed array type")}const Ss="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer},ks=new Map;function Us(t,s){if(!t||"object"!=typeof t)return!1;let i=ks.get(s);i||(i=new WeakMap,ks.set(s,i));let e=i.get(t);if(void 0===e){const r=Object.prototype.toString.call(t);e=r.substring(8,r.length-1)===s,i.set(t,e)}return e}function _s(t,s){return"undefined"!=typeof WebGLTexture&&Us(s,"WebGLTexture")}const xs=35044,Ts=34962,Es=5126,Ws="";function Is(t,s,i,e){if("undefined"!=typeof WebGLBuffer&&Us(s,"WebGLBuffer"))return s;i=i||Ts;const r=t.createBuffer();return function(t,s,i,e,r){t.bindBuffer(s,i),t.bufferData(s,e,r||xs)}(t,i,r,s,e),r}function Cs(t){return"indices"===t}const Bs=/coord|texture/i,Ks=/color|colour/i;function $s(t,s){if(Ss(t))return t;if(Ss(t.data))return t.data;Array.isArray(t)&&(t={data:t});let i=t.type?Ds(t.type):void 0;return i||(i=Cs(s)?Uint16Array:Float32Array),new i(t.data)}function Ds(t){return"number"==typeof t?function(t){const s=bs[t];if(!s)throw new Error("unknown gl type");return s}(t):t||Float32Array}function Ns(t,s){return{buffer:s.buffer,numValues:24,type:(i=s.type,"number"==typeof i?i:i?zs(i):Es),arrayType:Ds(s.type)};var i}function Ls(t,s){const i=s.data||s,e=Ds(s.type),r=i*e.BYTES_PER_ELEMENT,n=t.createBuffer();return t.bindBuffer(Ts,n),t.bufferData(Ts,r,s.drawType||xs),{buffer:n,numValues:i,type:zs(e),arrayType:e}}function Os(t,s,i){const e=$s(s,i);return{arrayType:e.constructor,buffer:Is(t,e,void 0,s.drawType),type:Ms(e),numValues:0}}function js(t,s){const i={};return Object.keys(s).forEach((function(e){if(!Cs(e)){const n=s[e],h=n.attrib||n.name||n.attribName||Ws+e;if(n.value){if(!Array.isArray(n.value)&&!Ss(n.value))throw new Error("array.value is not array or typedarray");i[h]={value:n.value}}else{let s;s=n.buffer&&n.buffer instanceof WebGLBuffer?Ns:"number"==typeof n||"number"==typeof n.data?Ls:Os;const{buffer:o,type:a,numValues:f,arrayType:u}=s(t,n,e),c=void 0!==n.normalize?n.normalize:(r=u)===Int8Array||r===Uint8Array,l=function(t,s,i){return t.numComponents||t.size||function(t,s){let i;if(i=Bs.test(t)?2:Ks.test(t)?4:3,s%i>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${i} but ${s} values is not evenly divisible by ${i}. You should specify it.`);return i}(s,i||function(t){return t.length?t:t.data}(t).length)}(n,e,f);i[h]={buffer:o,numComponents:l,type:a,normalize:c,stride:n.stride||0,offset:n.offset||0,divisor:void 0===n.divisor?void 0:n.divisor,drawType:n.drawType}}}var r})),t.bindBuffer(Ts,null),i}const Rs=["position","positions","a_position"];function Gs(t){return!!t.texStorage2D}const Hs=33984,Vs=34962,qs=5124,Qs=3553,Ys=34067,Js=32879,Zs=35866,Xs={};function ti(t,s){return Xs[s].bindPoint}function si(t,s){return function(i){t.uniform1i(s,i)}}function ii(t,s){return function(i){t.uniform1iv(s,i)}}function ei(t,s){return function(i){t.uniform2iv(s,i)}}function ri(t,s){return function(i){t.uniform3iv(s,i)}}function ni(t,s){return function(i){t.uniform4iv(s,i)}}function hi(t,s,i,e){const r=ti(0,s);return Gs(t)?function(s){let n,h;!s||_s(0,s)?(n=s,h=null):(n=s.texture,h=s.sampler),t.uniform1i(e,i),t.activeTexture(Hs+i),t.bindTexture(r,n),t.bindSampler(i,h)}:function(s){t.uniform1i(e,i),t.activeTexture(Hs+i),t.bindTexture(r,s)}}function oi(t,s,i,e,r){const n=ti(0,s),h=new Int32Array(r);for(let t=0;t<r;++t)h[t]=i+t;return Gs(t)?function(s){t.uniform1iv(e,h),s.forEach((function(s,e){let r,o;t.activeTexture(Hs+h[e]),!s||_s(0,s)?(r=s,o=null):(r=s.texture,o=s.sampler),t.bindSampler(i,o),t.bindTexture(n,r)}))}:function(s){t.uniform1iv(e,h),s.forEach((function(s,i){t.activeTexture(Hs+h[i]),t.bindTexture(n,s)}))}}function ai(t,s){return function(i){if(i.value)switch(t.disableVertexAttribArray(s),i.value.length){case 4:t.vertexAttrib4fv(s,i.value);break;case 3:t.vertexAttrib3fv(s,i.value);break;case 2:t.vertexAttrib2fv(s,i.value);break;case 1:t.vertexAttrib1fv(s,i.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(Vs,i.buffer),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,i.numComponents||i.size,i.type||5126,i.normalize||!1,i.stride||0,i.offset||0),t.vertexAttribDivisor&&t.vertexAttribDivisor(s,i.divisor||0)}}function fi(t,s){return function(i){if(i.value){if(t.disableVertexAttribArray(s),4!==i.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(s,i.value)}else t.bindBuffer(Vs,i.buffer),t.enableVertexAttribArray(s),t.vertexAttribIPointer(s,i.numComponents||i.size,i.type||qs,i.stride||0,i.offset||0),t.vertexAttribDivisor&&t.vertexAttribDivisor(s,i.divisor||0)}}function ui(t,s){return function(i){if(i.value){if(t.disableVertexAttribArray(s),4!==i.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(s,i.value)}else t.bindBuffer(Vs,i.buffer),t.enableVertexAttribArray(s),t.vertexAttribIPointer(s,i.numComponents||i.size,i.type||5125,i.stride||0,i.offset||0),t.vertexAttribDivisor&&t.vertexAttribDivisor(s,i.divisor||0)}}function ci(t,s,i){const e=i.size,r=i.count;return function(i){t.bindBuffer(Vs,i.buffer);const n=i.size||i.numComponents||e,h=n/r,o=i.type||5126,a=Xs[o].size*n,f=i.normalize||!1,u=i.offset||0,c=a/r;for(let e=0;e<r;++e)t.enableVertexAttribArray(s+e),t.vertexAttribPointer(s+e,h,o,f,a,u+c*e),t.vertexAttribDivisor&&t.vertexAttribDivisor(s+e,i.divisor||0)}}Xs[5126]={Type:Float32Array,size:4,setter:(t,s)=>function(i){t.uniform1f(s,i)},arraySetter:(t,s)=>function(i){t.uniform1fv(s,i)}},Xs[35664]={Type:Float32Array,size:8,setter:(t,s)=>function(i){t.uniform2fv(s,i)},cols:2},Xs[35665]={Type:Float32Array,size:12,setter:(t,s)=>function(i){t.uniform3fv(s,i)},cols:3},Xs[35666]={Type:Float32Array,size:16,setter:(t,s)=>function(i){t.uniform4fv(s,i)},cols:4},Xs[qs]={Type:Int32Array,size:4,setter:si,arraySetter:ii},Xs[35667]={Type:Int32Array,size:8,setter:ei,cols:2},Xs[35668]={Type:Int32Array,size:12,setter:ri,cols:3},Xs[35669]={Type:Int32Array,size:16,setter:ni,cols:4},Xs[5125]={Type:Uint32Array,size:4,setter:(t,s)=>function(i){t.uniform1ui(s,i)},arraySetter:(t,s)=>function(i){t.uniform1uiv(s,i)}},Xs[36294]={Type:Uint32Array,size:8,setter:(t,s)=>function(i){t.uniform2uiv(s,i)},cols:2},Xs[36295]={Type:Uint32Array,size:12,setter:(t,s)=>function(i){t.uniform3uiv(s,i)},cols:3},Xs[36296]={Type:Uint32Array,size:16,setter:(t,s)=>function(i){t.uniform4uiv(s,i)},cols:4},Xs[35670]={Type:Uint32Array,size:4,setter:si,arraySetter:ii},Xs[35671]={Type:Uint32Array,size:8,setter:ei,cols:2},Xs[35672]={Type:Uint32Array,size:12,setter:ri,cols:3},Xs[35673]={Type:Uint32Array,size:16,setter:ni,cols:4},Xs[35674]={Type:Float32Array,size:32,setter:(t,s)=>function(i){t.uniformMatrix2fv(s,!1,i)},rows:2,cols:2},Xs[35675]={Type:Float32Array,size:48,setter:(t,s)=>function(i){t.uniformMatrix3fv(s,!1,i)},rows:3,cols:3},Xs[35676]={Type:Float32Array,size:64,setter:(t,s)=>function(i){t.uniformMatrix4fv(s,!1,i)},rows:4,cols:4},Xs[35685]={Type:Float32Array,size:32,setter:(t,s)=>function(i){t.uniformMatrix2x3fv(s,!1,i)},rows:2,cols:3},Xs[35686]={Type:Float32Array,size:32,setter:(t,s)=>function(i){t.uniformMatrix2x4fv(s,!1,i)},rows:2,cols:4},Xs[35687]={Type:Float32Array,size:48,setter:(t,s)=>function(i){t.uniformMatrix3x2fv(s,!1,i)},rows:3,cols:2},Xs[35688]={Type:Float32Array,size:48,setter:(t,s)=>function(i){t.uniformMatrix3x4fv(s,!1,i)},rows:3,cols:4},Xs[35689]={Type:Float32Array,size:64,setter:(t,s)=>function(i){t.uniformMatrix4x2fv(s,!1,i)},rows:4,cols:2},Xs[35690]={Type:Float32Array,size:64,setter:(t,s)=>function(i){t.uniformMatrix4x3fv(s,!1,i)},rows:4,cols:3},Xs[35678]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Qs},Xs[35680]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Ys},Xs[35679]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Js},Xs[35682]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Qs},Xs[36289]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Zs},Xs[36292]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Zs},Xs[36293]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Ys},Xs[36298]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Qs},Xs[36299]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Js},Xs[36300]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Ys},Xs[36303]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Zs},Xs[36306]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Qs},Xs[36307]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Js},Xs[36308]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Ys},Xs[36311]={Type:null,size:0,setter:hi,arraySetter:oi,bindPoint:Zs};const li={};function di(t){const s=t.name;return s.startsWith("gl_")||s.startsWith("webgl_")}li[5126]={size:4,setter:ai},li[35664]={size:8,setter:ai},li[35665]={size:12,setter:ai},li[35666]={size:16,setter:ai},li[qs]={size:4,setter:fi},li[35667]={size:8,setter:fi},li[35668]={size:12,setter:fi},li[35669]={size:16,setter:fi},li[5125]={size:4,setter:ui},li[36294]={size:8,setter:ui},li[36295]={size:12,setter:ui},li[36296]={size:16,setter:ui},li[35670]={size:4,setter:fi},li[35671]={size:8,setter:fi},li[35672]={size:12,setter:fi},li[35673]={size:16,setter:fi},li[35674]={size:4,setter:ci,count:2},li[35675]={size:9,setter:ci,count:3},li[35676]={size:16,setter:ci,count:4};const mi=/(\.|\[|]|\w+)/g,pi=t=>t>="0"&&t<="9";function yi(t,s,i,e){const r=t.split(mi).filter((t=>""!==t));let n=0,h="";for(;;){const t=r[n++];h+=t;const o=pi(t[0]),a=o?parseInt(t):t;if(o&&(h+=r[n++]),n===r.length){i[a]=s;break}{const t=r[n++],s="["===t,o=i[a]||(s?[]:{});i[a]=o,i=o,e[h]=e[h]||function(t){return function(s){wi(t,s)}}(o),h+=t}}}function wi(t,s){for(const i in s){const e=t[i];"function"==typeof e?e(s[i]):wi(t[i],s[i])}}function gi(t,...s){const i=t.uniformSetters||t,e=s.length;for(let t=0;t<e;++t){const e=s[t];if(Array.isArray(e)){const t=e.length;for(let s=0;s<t;++s)gi(i,e[s])}else for(const t in e){const s=i[t];s&&s(e[t])}}}var vi,Pi,Ai,Fi,bi,Mi,zi,Si,ki,Ui,_i,xi,Ti,Ei,Wi,Ii,Ci,Bi,Ki,$i,Di,Ni,Li,Oi,ji,Ri,Gi,Hi,Vi,qi,Qi,Yi,Ji,Zi,Xi,te,se,ie,ee,re,ne,he,oe,ae,fe,ue,ce,le,de,me,pe,ye,we,ge,ve,Pe;class WebglCanvas{static isSupported(){if(!p)return!1;let t=document.createElement("canvas"),s=t.getContext("2d");const i=null!==s;return t=null,s=null,i}constructor(s,i=640,e=480,r={}){vi.add(this),this.supportedStereoscopeModes=[t.CanvasStereoscopicMode.None,t.CanvasStereoscopicMode.Dual],this.stereoscopeMode=t.CanvasStereoscopicMode.None,this.stereoscopeStrength=0,Pi.set(this,void 0),Ai.set(this,void 0),Fi.set(this,void 0),bi.set(this,void 0),Mi.set(this,new Uint32Array(16)),zi.set(this,void 0),Si.set(this,void 0),ki.set(this,void 0),Ui.set(this,void 0),_i.set(this,void 0),xi.set(this,new Map),Ti.set(this,new Map),Ei.set(this,new Map),Wi.set(this,!1),Ii.set(this,{programs:[],shaders:[],textures:[],buffers:[],frameBuffers:[]}),Ci.set(this,!1),Qi.set(this,(t=>{this.destroy(),t&&t.preventDefault(),o(this,Ci,"f")||o(this,Pi,"f").onlost(),a(this,Ci,!0,"f")})),Yi.set(this,(t=>{a(this,Ci,!1,"f"),o(this,vi,"m",Bi).call(this),o(this,Pi,"f").onrestored()})),y(),a(this,Pi,{...WebglCanvas.defaultOptions,...r},"f"),this.width=i,this.height=e,this.canvas=document.createElement("canvas"),this.canvas.addEventListener("webglcontextlost",o(this,Qi,"f"),!1),this.canvas.addEventListener("webglcontextrestored",o(this,Yi,"f"),!1),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--webgl",this.gl=this.canvas.getContext("webgl",{antialias:!1,alpha:!0}),s&&s.appendChild(this.canvas),o(this,vi,"m",Bi).call(this)}setCanvasSize(t,s){const i=o(this,Pi,"f").useDpi&&window.devicePixelRatio||1,e=t*i,r=s*i;this.width=t,this.height=s,this.canvas.width=e,this.canvas.height=r,this.dstWidth=e,this.dstHeight=r,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${s}px`,o(this,vi,"m",qi).call(this)}setNote(t){if(o(this,vi,"m",qi).call(this))return;const s=t.imageWidth,i=t.imageHeight;this.note=t,this.srcWidth=s,this.srcHeight=i,o(this,vi,"m",Vi).call(this,o(this,_i,"f"),s,i),o(this,vi,"m",Ri).call(this,o(this,zi,"f"),s,i),a(this,Si,new Uint32Array(s*i),"f"),a(this,ki,new Uint8Array(o(this,Si,"f").buffer),"f"),this.frameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(o(this,vi,"m",qi).call(this))return;const s=this.gl,i=t??this.note.getFramePalette(this.frameIndex)[0],[e,r,n,h]=i;s.clearColor(e/255,r/255,n/255,h/255),s.clear(s.COLOR_BUFFER_BIT)}drawFrame(s){if(o(this,vi,"m",qi).call(this))return;const i=this.gl,e=this.stereoscopeMode,r=this.stereoscopeStrength;this.frameIndex=s,e===t.CanvasStereoscopicMode.None?(o(this,vi,"m",Ki).call(this,s),o(this,vi,"m",Hi).call(this,null),o(this,vi,"m",$i).call(this,i.drawingBufferWidth,i.drawingBufferHeight)):e===t.CanvasStereoscopicMode.Dual&&(o(this,vi,"m",Ki).call(this,s,r,t.FlipnoteStereoscopicEye.Left),o(this,vi,"m",Hi).call(this,null,0,0,i.drawingBufferWidth/2,i.drawingBufferHeight),o(this,vi,"m",$i).call(this,i.drawingBufferWidth/2,i.drawingBufferHeight),o(this,vi,"m",Ki).call(this,s,r,t.FlipnoteStereoscopicEye.Right),o(this,vi,"m",Hi).call(this,null,i.drawingBufferWidth/2,0,i.drawingBufferWidth/2,i.drawingBufferHeight),o(this,vi,"m",$i).call(this,i.drawingBufferWidth/2,i.drawingBufferHeight))}requestStereoScopeMode(s){this.supportedStereoscopeModes.includes(s)?this.stereoscopeMode=s:this.stereoscopeMode=t.CanvasStereoscopicMode.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}isErrorState(){const t=this.gl;return null===t||t.getError()!==t.NO_ERROR}getDataUrl(t,s){return this.canvas.toDataURL(t,s)}async getBlob(t,s){return new Promise(((i,e)=>this.canvas.toBlob(i,t,s)))}destroy(){const t=o(this,Ii,"f"),s=this.gl,i=this.canvas;t.shaders.forEach((t=>{s.deleteShader(t)})),t.shaders=[],t.textures.forEach((t=>{s.deleteTexture(t)})),t.textures=[],t.buffers.forEach((t=>{s.deleteBuffer(t)})),t.buffers=[],t.frameBuffers.forEach((t=>{s.deleteFramebuffer(t)})),t.frameBuffers=[],t.programs.forEach((t=>{s.deleteProgram(t)})),t.programs=[],a(this,Mi,null,"f"),a(this,Si,null,"f"),a(this,ki,null,"f"),o(this,xi,"f").clear(),o(this,Ti,"f").clear(),o(this,Ei,"f").clear(),i&&i.parentElement&&(i.width=1,i.height=1,i.parentNode.removeChild(i))}}Pi=new WeakMap,Ai=new WeakMap,Fi=new WeakMap,bi=new WeakMap,Mi=new WeakMap,zi=new WeakMap,Si=new WeakMap,ki=new WeakMap,Ui=new WeakMap,_i=new WeakMap,xi=new WeakMap,Ti=new WeakMap,Ei=new WeakMap,Wi=new WeakMap,Ii=new WeakMap,Ci=new WeakMap,Qi=new WeakMap,Yi=new WeakMap,vi=new WeakSet,Bi=function(){this.setCanvasSize(this.width,this.height);const t=this.gl;if(o(this,vi,"m",qi).call(this))return;a(this,Ai,o(this,vi,"m",Di).call(this,"#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_uv;uniform bool u_flipY;uniform vec2 u_textureSize;uniform int u_3d_eye;uniform float u_3d_depth;uniform float u_3d_strength;void main(){vec4 pos=position;float depthDirection=u_3d_eye==0 ?-1.0 : 1.0;float depthShift=floor(u_3d_depth*u_3d_strength)/(u_textureSize.x/2.0)*depthDirection;pos.x+=depthShift;pos.y*=u_flipY ?-1.0 : 1.0;v_uv=texcoord;gl_Position=pos;}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;uniform int u_3d_mode;void main(){vec4 col=texture2D(u_tex,v_uv);if(col.a==0.0){discard;}gl_FragColor=col;}"),"f"),a(this,Fi,o(this,vi,"m",Di).call(this,"#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),"f"),a(this,bi,o(this,vi,"m",Li).call(this,-1,-1,2,2,1,1),"f"),o(this,vi,"m",Oi).call(this,o(this,Ai,"f"),o(this,bi,"f")),a(this,zi,o(this,vi,"m",ji).call(this,t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),"f"),a(this,Ui,o(this,vi,"m",ji).call(this,t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),"f"),a(this,_i,o(this,vi,"m",Gi).call(this,o(this,Ui,"f")),"f");const s=t.getExtension("WEBGL_debug_renderer_info"),i=t.getParameter(s.UNMASKED_RENDERER_WEBGL),e=navigator.userAgent,r=e.includes("Firefox")&&e.includes("Mac");a(this,Wi,r&&i.includes("Apple M"),"f")},Ki=function(s,i=0,e=t.FlipnoteStereoscopicEye.Left,r=!0){const n=this.gl,h=this.note,a=this.srcWidth,f=this.srcHeight,u=h.numLayers,c=h.getFrameLayerOrder(s),l=h.getFrameLayerDepths(s);o(this,vi,"m",Hi).call(this,o(this,_i,"f")),r&&this.clear(),n.useProgram(o(this,Ai,"f").program);for(let t=0;t<u;t++){const r=c[t];h.getLayerPixelsRgba(s,r,o(this,Si,"f"),o(this,Mi,"f")),gi(o(this,Ai,"f"),{u_flipY:!0,u_tex:o(this,zi,"f"),u_textureSize:[a,f],u_3d_mode:this.stereoscopeMode,u_3d_eye:e,u_3d_depth:l[r],u_3d_strength:i}),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,a,f,0,n.RGBA,n.UNSIGNED_BYTE,o(this,ki,"f")),n.drawElements(n.TRIANGLES,o(this,bi,"f").numElements,o(this,bi,"f").elementType,0)}},$i=function(t,s){if(o(this,vi,"m",qi).call(this))return;const i=this.gl;i.useProgram(o(this,Fi,"f").program),gi(o(this,Fi,"f"),{u_tex:o(this,Ui,"f"),u_textureSize:[this.srcWidth,this.srcHeight],u_screenSize:[t,s]}),i.drawElements(i.TRIANGLES,o(this,bi,"f").numElements,o(this,bi,"f").elementType,0)},Di=function(t,s){if(o(this,vi,"m",qi).call(this))return;const i=this.gl,e=o(this,vi,"m",Ni).call(this,i.VERTEX_SHADER,t),r=o(this,vi,"m",Ni).call(this,i.FRAGMENT_SHADER,s),n=i.createProgram();if(i.attachShader(n,e),i.attachShader(n,r),i.linkProgram(n),!i.getProgramParameter(n,i.LINK_STATUS)){const t=i.getProgramInfoLog(n);throw i.deleteProgram(n),new Error(t)}const h=function(t,s){const i=function(t,s){let i=0;function e(s,e,r){const n=e.name.endsWith("[0]"),h=e.type,o=Xs[h];if(!o)throw new Error(`unknown type: 0x${h.toString(16)}`);let a;if(o.bindPoint){const s=i;i+=e.size,a=n?o.arraySetter(t,h,s,r,e.size):o.setter(t,h,s,r,e.size)}else a=o.arraySetter&&n?o.arraySetter(t,r):o.setter(t,r);return a.location=r,a}const r={},n={},h=t.getProgramParameter(s,35718);for(let i=0;i<h;++i){const h=t.getActiveUniform(s,i);if(di(h))continue;let o=h.name;o.endsWith("[0]")&&(o=o.substr(0,o.length-3));const a=t.getUniformLocation(s,h.name);if(a){const t=e(0,h,a);r[o]=t,yi(o,t,n,r)}}return r}(t,s),e=function(t,s){const i={},e=t.getProgramParameter(s,35721);for(let r=0;r<e;++r){const e=t.getActiveAttrib(s,r);if(di(e))continue;const n=t.getAttribLocation(s,e.name),h=li[e.type],o=h.setter(t,n,h);o.location=n,i[e.name]=o}return i}(t,s),r={program:s,uniformSetters:i,attribSetters:e};return Gs(t)&&(r.uniformBlockSpec=function(t,s){const i=t.getProgramParameter(s,35718),e=[],r=[];for(let n=0;n<i;++n){r.push(n),e.push({});const i=t.getActiveUniform(s,n);e[n].name=i.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(i){const n=i[0],h=i[1];t.getActiveUniforms(s,r,t[n]).forEach((function(t,s){e[s][h]=t}))}));const n={},h=t.getProgramParameter(s,35382);for(let i=0;i<h;++i){const e=t.getActiveUniformBlockName(s,i),r={index:t.getUniformBlockIndex(s,e),usedByVertexShader:t.getActiveUniformBlockParameter(s,i,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(s,i,35398),size:t.getActiveUniformBlockParameter(s,i,35392),uniformIndices:t.getActiveUniformBlockParameter(s,i,35395)};r.used=r.usedByVertexShader||r.usedByFragmentShader,n[e]=r}return{blockSpecs:n,uniformData:e}}(t,s),r.transformFeedbackInfo=function(t,s){const i={},e=t.getProgramParameter(s,35971);for(let r=0;r<e;++r){const e=t.getTransformFeedbackVarying(s,r);i[e.name]={index:r,type:e.type,size:e.size}}return i}(t,s)),r}(i,n);return o(this,Ii,"f").programs.push(n),h},Ni=function(t,s){if(o(this,vi,"m",qi).call(this))return;const i=this.gl,e=i.createShader(t);if(i.shaderSource(e,s),i.compileShader(e),!i.getShaderParameter(e,i.COMPILE_STATUS)){const t=i.getShaderInfoLog(e);throw i.deleteShader(e),new Error(t)}return o(this,Ii,"f").shaders.push(e),e},Li=function(t,s,i,e,r,n){if(o(this,vi,"m",qi).call(this))return;const h=(r+1)*(n+1),a=r+1,f=new Float32Array(2*h),u=new Float32Array(2*h);let c=0,l=0;for(let h=0;h<=n;h++)for(let o=0;o<=r;o++){const a=o/r,d=h/n;f[c++]=t+i*a,f[c++]=s+e*d,u[l++]=a,u[l++]=d}const d=new Uint16Array(r*n*2*3);let m=0;for(let t=0;t<n;t++)for(let s=0;s<r;s++)d[m++]=(t+0)*a+s,d[m++]=(t+1)*a+s,d[m++]=(t+0)*a+s+1,d[m++]=(t+0)*a+s+1,d[m++]=(t+1)*a+s,d[m++]=(t+1)*a+s+1;const p=function(t,s,i){const e=js(t,s),r=Object.assign({},{});r.attribs=Object.assign({},{},e);const n=s.indices;if(n){const s=$s(n,"indices");r.indices=Is(t,s,34963),r.numElements=s.length,r.elementType=Ms(s)}else r.numElements||(r.numElements=function(t,s){let i,e;for(e=0;e<Rs.length&&(i=Rs[e],!(i in s))&&(i=Ws+i,!(i in s));++e);e===Rs.length&&(i=Object.keys(s)[0]);const r=s[i];if(!r.buffer)return 1;t.bindBuffer(Ts,r.buffer);const n=t.getBufferParameter(Ts,34660);var h;t.bindBuffer(Ts,null);const o=n/(5120===(h=r.type)||5121===h?1:5122===h||5123===h?2:5124===h||5125===h||h===Es?4:0),a=r.numComponents||r.size,f=o/a;if(f%1!=0)throw new Error(`numComponents ${a} not correct for length ${length}`);return f}(t,r.attribs));return r}(this.gl,{position:{numComponents:2,data:f},texcoord:{numComponents:2,data:u},indices:d});for(let t in p.attribs)o(this,Ii,"f").buffers.push(p.attribs[t].buffer);return p},Oi=function(t,s){var i,e,r;o(this,vi,"m",qi).call(this)||(i=this.gl,e=t.attribSetters,(r=s).vertexArrayObject?i.bindVertexArray(r.vertexArrayObject):(function(t,s){for(const i in s){const e=t[i];e&&e(s[i])}}(e.attribSetters||e,r.attribs),r.indices&&i.bindBuffer(34963,r.indices)))},ji=function(t,s,i,e=1,r=1){if(o(this,vi,"m",qi).call(this))return;const n=this.gl,h=n.createTexture();return n.bindTexture(n.TEXTURE_2D,h),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,s),n.texImage2D(n.TEXTURE_2D,0,t,e,r,0,t,n.UNSIGNED_BYTE,null),o(this,Ii,"f").textures.push(h),o(this,xi,"f").set(h,t),o(this,Ti,"f").set(h,{width:e,height:r}),h},Ri=function(t,s,i){if(o(this,vi,"m",qi).call(this))return;const e=this.gl,r=o(this,xi,"f").get(t);e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,r,s,i,0,r,e.UNSIGNED_BYTE,null),o(this,Ti,"f").set(t,{width:s,height:i})},Gi=function(t){if(o(this,vi,"m",qi).call(this))return;const s=this.gl,i=s.createFramebuffer();return s.bindFramebuffer(s.FRAMEBUFFER,i),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,t,0),o(this,Ii,"f").frameBuffers.push(i),o(this,Ei,"f").set(i,t),i},Hi=function(t,s,i,e,r){if(o(this,vi,"m",qi).call(this))return;const n=this.gl;if(null===t){if(n.bindFramebuffer(n.FRAMEBUFFER,null),o(this,Wi,"f")){const t=this.srcWidth,h=this.srcHeight,o=n.drawingBufferWidth/t,a=n.drawingBufferHeight/h,f=256===t?1:0;s=-((e=n.drawingBufferWidth*(o-f))-t*o),i=-((r=n.drawingBufferHeight*(a-f))-h*a)}n.viewport(s??0,i??0,e??n.drawingBufferWidth,r??n.drawingBufferHeight)}else{const h=o(this,Ei,"f").get(t),{width:a,height:f}=o(this,Ti,"f").get(h);n.bindFramebuffer(n.FRAMEBUFFER,t),n.viewport(s??0,i??0,e??a,r??f)}},Vi=function(t,s,i){if(o(this,vi,"m",qi).call(this))return;const e=o(this,Ei,"f").get(t);o(this,vi,"m",Ri).call(this,e,s,i)},qi=function(){const t=o(this,Ci,"f")||this.isErrorState();return t&&o(this,Qi,"f").call(this),t},WebglCanvas.defaultOptions={onlost(){},onrestored(){},useDpi:!0};class Html5Canvas{static isSupported(){if(!p)return!1;let t=document.createElement("canvas"),s=t.getContext("2d");const i=null!==s;return t=null,s=null,i}constructor(s,i,e,r={}){this.supportedStereoscopeModes=[t.CanvasStereoscopicMode.None],this.stereoscopeMode=t.CanvasStereoscopicMode.None,this.stereoscopeStrength=0,Ji.set(this,void 0),Zi.set(this,void 0),Xi.set(this,void 0),te.set(this,void 0),se.set(this,new Uint32Array(16)),ie.set(this,void 0),y(),a(this,Ji,{...Html5Canvas.defaultOptions,...r},"f"),this.width=i,this.height=e,this.canvas=document.createElement("canvas"),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--html5",this.ctx=this.canvas.getContext("2d"),a(this,Zi,document.createElement("canvas"),"f"),a(this,Xi,o(this,Zi,"f").getContext("2d"),"f"),c(null!==this.ctx&&null!==o(this,Xi,"f"),"Could not create HTML5 canvas"),s&&s.appendChild(this.canvas),this.setCanvasSize(i,e)}setCanvasSize(t,s){const i=this.canvas,e=o(this,Ji,"f").useDpi&&window.devicePixelRatio||1,r=t*e,n=s*e;this.width=t,this.height=s,this.dstWidth=r,this.dstHeight=n,i.style.width=`${t}px`,i.style.height=`${s}px`,i.width=r,i.height=n}setNote(t){const s=t.imageWidth,i=t.imageHeight;this.note=t,this.srcWidth=s,this.srcHeight=i,o(this,Zi,"f").width=s,o(this,Zi,"f").height=i,a(this,te,o(this,Xi,"f").createImageData(s,i),"f"),a(this,ie,new Uint32Array(o(this,te,"f").data.buffer),"f"),this.frameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(o(this,ie,"f").fill(0),this.ctx.clearRect(0,0,this.dstWidth,this.dstHeight),t){const[s,i,e,r]=t;this.ctx.fillStyle=`rgba(${s}, ${i}, ${e}, ${r})`,this.ctx.fillRect(0,0,this.dstWidth,this.dstHeight)}}drawFrame(t){this.clear(),o(this,Ji,"f").useSmoothing||(this.ctx.imageSmoothingEnabled=!1),this.note.getFramePixelsRgba(t,o(this,ie,"f"),o(this,se,"f")),o(this,Xi,"f").putImageData(o(this,te,"f"),0,0),this.ctx.drawImage(o(this,Zi,"f"),0,0,this.srcWidth,this.srcHeight,0,0,this.dstWidth,this.dstHeight),this.frameIndex=t}requestStereoScopeMode(s){this.supportedStereoscopeModes.includes(s)?this.stereoscopeMode=s:this.stereoscopeMode=t.CanvasStereoscopicMode.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}getDataUrl(t,s){return this.canvas.toDataURL(t,s)}async getBlob(t,s){return new Promise(((i,e)=>this.canvas.toBlob(i,t,s)))}destroy(){a(this,te,null,"f"),a(this,se,null,"f"),a(this,ie,null,"f"),this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null,o(this,Zi,"f").width=1,o(this,Zi,"f").height=1,a(this,Zi,null,"f")}}Ji=new WeakMap,Zi=new WeakMap,Xi=new WeakMap,te=new WeakMap,se=new WeakMap,ie=new WeakMap,Html5Canvas.defaultOptions={useDpi:!0,useSmoothing:!0};class UniversalCanvas{constructor(s,i=640,e=480,r={}){ee.add(this),this.isReady=!1,this.isHtml5=!1,this.supportedStereoscopeModes=[],this.stereoscopeMode=t.CanvasStereoscopicMode.None,this.stereoscopeStrength=1,re.set(this,[WebglCanvas,Html5Canvas]),ne.set(this,0),he.set(this,void 0),oe.set(this,{}),this.width=i,this.height=e,a(this,he,s,"f"),a(this,oe,r,"f"),o(this,ee,"m",ae).call(this,o(this,re,"f")[0])}fallbackIfPossible(){if(o(this,ne,"f")>=o(this,re,"f").length)throw new Error("No renderer to fall back to");a(this,ne,o(this,ne,"f")+1,"f"),o(this,ee,"m",ae).call(this,o(this,re,"f")[o(this,ne,"f")])}switchToHtml5(){o(this,ee,"m",ae).call(this,Html5Canvas)}setCanvasSize(t,s){const i=this.renderer;i.setCanvasSize(t,s),this.width=t,this.width=s,this.dstWidth=i.dstWidth,this.dstHeight=i.dstHeight}setNote(t){this.note=t,this.renderer.setNote(t),this.frameIndex=void 0,this.srcWidth=this.renderer.srcWidth,this.srcHeight=this.renderer.srcHeight}clear(t){this.renderer.clear(t)}drawFrame(t){this.renderer.drawFrame(t),this.frameIndex=t}forceUpdate(){this.renderer.forceUpdate()}requestStereoScopeMode(t){this.renderer.requestStereoScopeMode(t),this.stereoscopeMode=this.renderer.stereoscopeMode}getDataUrl(t,s){return this.renderer.getDataUrl()}async getBlob(t,s){return this.renderer.getBlob()}destroy(){this.renderer.destroy(),this.note=null}}re=new WeakMap,ne=new WeakMap,he=new WeakMap,oe=new WeakMap,ee=new WeakSet,ae=function(t){let s=!1;const i=new t(o(this,he,"f"),this.width,this.height,{...o(this,oe,"f"),onlost:()=>{s=!0,this.fallbackIfPossible()}});s||(this.note&&(i.setNote(this.note),i.frameIndex=this.renderer?.frameIndex,i.forceUpdate()),this.renderer&&this.renderer.destroy(),this.isHtml5=i instanceof Html5Canvas,this.isReady=!0,this.renderer=i,a(this,ne,o(this,re,"f").indexOf(t),"f"),this.supportedStereoscopeModes=i.supportedStereoscopeModes,i.stereoscopeStrength=this.stereoscopeStrength,this.requestStereoScopeMode(this.stereoscopeMode))};const Ae=p?window.AudioContext||window.webkitAudioContext:null;class WebAudioPlayer{constructor(){fe.add(this),this.useEq=!1,this.useAnalyser=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],ue.set(this,1),ce.set(this,!1),le.set(this,0),de.set(this,0),me.set(this,[]),pe.set(this,void 0),ye.set(this,void 0),we.set(this,void 0),y()}set volume(t){this.setVolume(t)}get volume(){return o(this,ue,"f")}set loop(t){a(this,ce,t,"f"),o(this,we,"f")&&(o(this,we,"f").loop=t)}get loop(){return o(this,ce,"f")}setBuffer(t,s){const i=o(this,fe,"m",ge).call(this),e=t.length,r=i.createBuffer(1,e,s),n=r.getChannelData(0);if(t instanceof Float32Array)n.set(t,0);else if(t instanceof Int16Array)for(let s=0;s<e;s++)n[s]=t[s]/32768;a(this,pe,r,"f"),this.sampleRate=s}setAnalyserEnabled(t){this.useAnalyser=t,o(this,fe,"m",Pe).call(this)}setVolume(t){a(this,ue,t,"f"),o(this,ye,"f")&&(o(this,ye,"f").gain.value=Math.pow(t,2))}playFrom(t){o(this,fe,"m",Pe).call(this),a(this,le,t,"f"),a(this,de,this.ctx.currentTime,"f"),o(this,we,"f").loop=o(this,ce,"f"),o(this,we,"f").start(0,t)}stop(){o(this,we,"f")&&o(this,we,"f").stop(0)}getCurrentTime(){return o(this,le,"f")+(this.ctx.currentTime-o(this,de,"f"))}async destroy(){this.stop();const t=o(this,fe,"m",ge).call(this);o(this,me,"f").forEach((t=>t.disconnect())),a(this,me,[],"f"),this.analyser=void 0,"closed"!==t.state&&"function"==typeof t.close&&await t.close(),a(this,pe,null,"f")}}var Fe,be,Me;ue=new WeakMap,ce=new WeakMap,le=new WeakMap,de=new WeakMap,me=new WeakMap,pe=new WeakMap,ye=new WeakMap,we=new WeakMap,fe=new WeakSet,ge=function(){return this.ctx||(this.ctx=new Ae),this.ctx},ve=function(t){const s=o(this,fe,"m",ge).call(this),i=this.eqSettings;let e=t;return i.forEach((([t,r],n)=>{const h=s.createBiquadFilter();o(this,me,"f").push(h),h.frequency.value=t,h.gain.value=r,0===n?h.type="lowshelf":n===i.length-1?h.type="highshelf":h.type="peaking",e.connect(h),e=h})),e},Pe=function(){const t=o(this,fe,"m",ge).call(this);a(this,me,[],"f");const s=t.createBufferSource();o(this,me,"f").push(s),s.buffer=o(this,pe,"f");const i=t.createGain();if(o(this,me,"f").push(i),this.useEq?o(this,fe,"m",ve).call(this,s).connect(i):s.connect(i),this.useAnalyser){const s=t.createAnalyser();o(this,me,"f").push(s),this.analyser=s,i.connect(s),s.connect(t.destination)}else this.analyser=void 0,i.connect(t.destination);a(this,we,s,"f"),a(this,ye,i,"f"),this.setVolume(o(this,ue,"f"))};class Player{constructor(s,i,e,r={}){Fe.add(this),this.duration=0,this.autoplay=!1,this.supportedEvents=cs,this.i=null,this.h=!1,this.o=1,this.u=!1,this.l=null,this.m=!1,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=s=>{if(!this.isPlaying)return;const i=s/1e3,e=this.duration,r=this.audio.getCurrentTime();let n=i-this.playbackStartTime;if(Math.abs(n%e-r%e)>.01&&(n=r),n>=e){if(!this.loop)return this.pause(),this.m=!0,void this.emit(t.PlayerEvent.Ended);this.playbackStartTime=i,this.emit(t.PlayerEvent.Loop)}this.setCurrentTime(n%e),this.playbackLoopId=requestAnimationFrame(this.playbackLoop)},y();const n="string"==typeof s?document.querySelector(s):s;this.parserSettings=r,this.renderer=new UniversalCanvas(n,i,e,{onlost:()=>this.emit(t.PlayerEvent.Error),onrestored:()=>this.reload()}),this.audio=new WebAudioPlayer,this.el=n}get src(){return this.i}set src(t){throw new Error("Setting a Player source has been deprecated, please use the load() method instead")}get paused(){return!this.isPlaying}set paused(t){t?this.pause():this.play()}get currentFrame(){return this.l}set currentFrame(t){this.setCurrentFrame(t)}get currentTime(){return this.isNoteLoaded?this.playbackTime:null}set currentTime(t){this.setCurrentTime(t)}get progress(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null}set progress(t){this.setProgress(t)}get volume(){return this.getVolume()}set volume(t){this.setVolume(t)}get muted(){return this.getMuted()}set muted(t){this.setMuted(t)}get loop(){return this.getLoop()}set loop(t){this.setLoop(t)}get framerate(){return this.note.framerate}get frameCount(){return this.note.frameCount}get frameSpeed(){return this.note.frameSpeed}get buffered(){return ls([[0,this.duration]])}get seekable(){return ls([[0,this.duration]])}get currentSrc(){return this.i}get videoWidth(){return this.isNoteLoaded?this.note.imageWidth:0}get videoHeight(){return this.isNoteLoaded?this.note.imageHeight:0}async load(s){if(this.isNoteLoaded&&this.closeNote(),this.i=s,!s)return this.openNote(this.note);this.emit(t.PlayerEvent.LoadStart);const[i,e]=await(async t=>{try{return[null,await t().catch((t=>{throw t}))]}catch(t){return[t,null]}})((()=>as(s,this.parserSettings)));if(i)throw this.emit(t.PlayerEvent.Error,i),new Error(`Error loading Flipnote: ${i.message}`);this.openNote(e)}async reload(){if(this.note)return await this.load(this.note.buffer)}async updateSettings(t){return this.parserSettings=t,await this.reload()}closeNote(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this.i=null,this.l=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clear()}openNote(s){this.isNoteLoaded&&this.closeNote(),this.note=s,this.meta=s.meta,this.emit(t.PlayerEvent.LoadedMeta),this.noteFormat=s.format,this.duration=s.duration,this.playbackTime=0,this.l=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=s.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(s.getAudioMasterPcm(),s.sampleRate),this.emit(t.PlayerEvent.CanPlay),this.emit(t.PlayerEvent.CanPlayThrough),this.setLoop(s.meta.loop),this.renderer.setNote(s),this.drawFrame(s.thumbFrameIndex),this.emit(t.PlayerEvent.LoadedData),this.emit(t.PlayerEvent.Load),this.emit(t.PlayerEvent.Ready),this.autoplay&&this.play()}setCurrentTime(s){this.assertNoteLoaded();const i=Math.floor(s/(1/this.framerate));this.setCurrentFrame(i),this.playbackTime=s,this.emit(t.PlayerEvent.Progress,this.progress)}getCurrentTime(){return this.currentTime}getTimeCounter(){return`${ms(Math.max(this.currentTime,0))} / ${ms(this.duration)}`}getFrameCounter(){return`${ds(this.currentFrame+1,3)} / ${ds(this.frameCount,3)}`}setProgress(t){this.assertNoteLoaded(),l(t,0,100,"progress"),this.currentTime=this.duration*(t/100)}getProgress(){return this.progress}async play(){if(this.assertNoteLoaded(),this.isPlaying)return;this.m&&(this.playbackTime=0,this.m=!1);const s=performance.now();this.playbackStartTime=s/1e3-this.playbackTime,this.isPlaying=!0,this.hasPlaybackStarted=!0,o(this,Fe,"m",be).call(this),this.playbackLoop(s),this.emit(t.PlayerEvent.Play)}pause(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),o(this,Fe,"m",Me).call(this),this.emit(t.PlayerEvent.Pause))}togglePlay(){this.isPlaying?this.pause():this.play()}getPaused(){return!this.isPlaying}getDuration(){return this.duration}getLoop(){return this.h}setLoop(t){this.h=t,this.audio.loop=t}toggleLoop(){this.setLoop(!this.h)}setCurrentFrame(s){this.assertNoteLoaded();const i=Math.max(0,Math.min(Math.floor(s),this.frameCount-1));(i!==this.currentFrame||this.showThumbnail)&&(this.l=i,this.drawFrame(i),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=i*(1/this.framerate),this.emit(t.PlayerEvent.SeekEnd)),this.emit(t.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(t.PlayerEvent.Progress,this.progress),this.emit(t.PlayerEvent.TimeUpdate,this.currentFrame))}nextFrame(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(t.PlayerEvent.FrameNext)}prevFrame(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(t.PlayerEvent.FramePrev)}lastFrame(){this.currentFrame=this.frameCount-1,this.emit(t.PlayerEvent.FrameLast)}firstFrame(){this.currentFrame=0,this.emit(t.PlayerEvent.FrameFirst)}thumbnailFrame(){this.currentFrame=this.note.thumbFrameIndex}startSeek(){this.isSeeking||(this.emit(t.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)}seek(t){this.isSeeking&&(this.progress=100*t)}endSeek(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1}drawFrame(t){this.renderer.drawFrame(t)}forceUpdate(){this.renderer.forceUpdate()}resize(t,s){s!==.75*t&&console.warn(`Canvas width to height ratio should be 3:4 for best results (got ${t}x${s})`),this.renderer.setCanvasSize(t,s),this.forceUpdate()}setLayerVisibility(t,s){this.note.layerVisibility[t]=s,this.layerVisibility[t]=s,this.forceUpdate()}getLayerVisibility(t){return this.layerVisibility[t]}toggleLayerVisibility(t){this.setLayerVisibility(t,!this.layerVisibility[t])}toggleAudioEq(){this.setAudioEq(!this.audio.useEq)}setAudioEq(t){this.isPlaying&&(this.wasPlaying=!0,o(this,Fe,"m",Me).call(this)),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,o(this,Fe,"m",be).call(this))}mute(){this.setMuted(!0)}unmute(){this.setMuted(!1)}setMuted(s){this.audio.volume=s?0:this.o,this.u=s,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getMuted(){return 0===this.volume||this.u}toggleMuted(){this.setMuted(!this.u)}setVolume(s){l(s,0,1,"volume"),this.o=s,this.audio.volume=s,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getVolume(){return this.u?0:this.o}seekToNextFrame(){this.nextFrame()}fastSeek(t){this.currentTime=t}canPlayType(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";default:return""}}getVideoPlaybackQuality(){return{creationTime:0,droppedVideoFrames:0,corruptedVideoFrames:0,totalVideoFrames:this.frameCount}}requestPictureInPicture(){throw new Error("Not implemented")}captureStream(){throw new Error("Not implemented")}on(t,s){const i=this.events;(Array.isArray(t)?t:[t]).forEach((t=>{i.has(t)?i.get(t).push(s):i.set(t,[s])}))}off(t,s){const i=this.events;(Array.isArray(t)?t:[t]).forEach((t=>{if(!i.has(t))return;const e=i.get(t);i.set(t,e.splice(e.indexOf(s),1))}))}emit(s,...i){const e=this.events;if(s!==t.PlayerEvent.t&&e.has(s)){e.get(s).forEach((t=>t.apply(null,i)));const t=`on${s}`,r=this;"function"==typeof r[t]&&r[t].apply(null,i)}e.has(t.PlayerEvent.t)&&e.get(t.PlayerEvent.t).forEach((t=>t.apply(null,[s,...i])))}clearEvents(){this.events.clear()}async destroy(){this.clearEvents(),this.emit(t.PlayerEvent.Destroy),this.closeNote(),await this.renderer.destroy(),await this.audio.destroy()}assertNoteLoaded(){c(this.isNoteLoaded,"No Flipnote is currently loaded in this player")}}Fe=new WeakSet,be=function(){this.audio.playFrom(this.currentTime)},Me=function(){this.audio.stop()};class EncoderBase{constructor(){this.dataUrl=null}getBuffer(){return c(w,"This feature is only available in NodeJS environments"),Buffer.from(this.getArrayBuffer())}getBlob(){return y(),new Blob([this.getArrayBuffer()],{type:this.mimeType})}getUrl(){return y(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())}revokeUrl(){y(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)}}const ze=5003,Se=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];class LzwCompressor{constructor(t,s,i){this.accum=new Uint8Array(256),this.htab=new Int32Array(ze),this.codetab=new Int32Array(ze),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=s,this.colorDepth=i,this.reset()}reset(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}char_out(t,s){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(s)}cl_block(t){this.cl_hash(ze),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)}cl_hash(t){for(var s=0;s<t;++s)this.htab[s]=-1}compress(t,s){var i,e,r,n,h,o,a;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,n=this.nextPixel(),a=0,i=ze;i<65536;i*=2)++a;a=8-a,o=ze,this.cl_hash(o),this.output(this.ClearCode,s);t:for(;-1!=(e=this.nextPixel());)if(i=(e<<12)+n,r=e<<a^n,this.htab[r]!==i){if(this.htab[r]>=0){h=o-r,0===r&&(h=1);do{if((r-=h)<0&&(r+=o),this.htab[r]===i){n=this.codetab[r];continue t}}while(this.htab[r]>=0)}this.output(n,s),n=e,this.free_ent<4096?(this.codetab[r]=this.free_ent++,this.htab[r]=i):this.cl_block(s)}else n=this.codetab[r];this.output(n,s),this.output(this.EOFCode,s)}encode(t,s){this.pixels=t,s.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,s),s.writeByte(0)}flush_char(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)}get_maxcode(t){return(1<<t)-1}nextPixel(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}output(t,s){for(this.cur_accum&=Se[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,s),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,s),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(s)}}}var ke,Ue,_e,xe,Te,Ee,We,Ie,Ce,Be,Ke,$e,De,Ne,Le;class GifImage extends EncoderBase{constructor(t,s,i={}){super(),ke.add(this),this.mimeType="gif/image",this.frameCount=0,Ue.set(this,void 0),_e.set(this,void 0),this.width=t,this.height=s,a(this,Ue,new ByteArray,"f"),this.settings={...GifImage.defaultSettings,...i},a(this,_e,new LzwCompressor(t,s,i.colorDepth),"f")}static fromFlipnote(t,s={}){const i=new GifImage(t.imageWidth,t.imageHeight,{delay:100/t.framerate,repeat:t.meta?.loop?-1:0,...s});i.palette=t.globalPalette;for(let s=0;s<t.frameCount;s++)i.writeFrame(t.getFramePixels(s));return i.finish(),i}static fromFlipnoteFrame(t,s,i={}){const e=new GifImage(t.imageWidth,t.imageHeight,{delay:0,repeat:0,...i});return e.palette=t.globalPalette,e.writeFrame(t.getFramePixels(s)),e.finish(),e}writeFrame(t){0===this.frameCount?o(this,ke,"m",xe).call(this,t):o(this,ke,"m",Te).call(this,t),this.frameCount+=1}finish(){o(this,Ue,"f").writeByte(59)}getArrayBuffer(){return o(this,Ue,"f").getBuffer()}getImage(){y();const t=new Image(this.width,this.height);return t.src=this.getUrl(),t}}Ue=new WeakMap,_e=new WeakMap,ke=new WeakSet,xe=function(t){o(this,ke,"m",Ee).call(this),o(this,ke,"m",Ie).call(this),o(this,ke,"m",Be).call(this),o(this,ke,"m",Ce).call(this),o(this,ke,"m",We).call(this),o(this,ke,"m",Ke).call(this),o(this,ke,"m",De).call(this,t)},Te=function(t){o(this,ke,"m",We).call(this),o(this,ke,"m",Ke).call(this),o(this,ke,"m",De).call(this,t)},Ee=function(){o(this,Ue,"f").writeChars("GIF89a")},We=function(){o(this,Ue,"f").writeByte(33),o(this,Ue,"f").writeByte(249),o(this,Ue,"f").writeByte(4),o(this,Ue,"f").writeByte(0),o(this,Ue,"f").writeU16(this.settings.delay),o(this,Ue,"f").writeByte(0),o(this,Ue,"f").writeByte(0)},Ie=function(){const t=this.palette,s=128|this.settings.colorDepth-1<<4|o(this,ke,"m",$e).call(this,t.length)-1;o(this,Ue,"f").writeU16(this.width),o(this,Ue,"f").writeU16(this.height),o(this,Ue,"f").writeBytes([s,0,0])},Ce=function(){o(this,Ue,"f").writeByte(33),o(this,Ue,"f").writeByte(255),o(this,Ue,"f").writeByte(11),o(this,Ue,"f").writeChars("NETSCAPE2.0"),o(this,Ue,"f").writeByte(3),o(this,Ue,"f").writeByte(1),o(this,Ue,"f").writeU16(this.settings.repeat),o(this,Ue,"f").writeByte(0)},Be=function(){const t=this.palette,s=1<<o(this,ke,"m",$e).call(this,t.length);for(let i=0;i<s;i++){let s=[0,0,0];i<t.length&&(s=t[i]),o(this,Ue,"f").writeByte(s[0]),o(this,Ue,"f").writeByte(s[1]),o(this,Ue,"f").writeByte(s[2])}},Ke=function(){o(this,Ue,"f").writeByte(44),o(this,Ue,"f").writeU16(0),o(this,Ue,"f").writeU16(0),o(this,Ue,"f").writeU16(this.width),o(this,Ue,"f").writeU16(this.height),o(this,Ue,"f").writeByte(0)},$e=function(t){return Math.max(Math.ceil(Math.log2(t)),1)},De=function(t){o(this,_e,"f").colorDepth=this.settings.colorDepth,o(this,_e,"f").reset(),o(this,_e,"f").encode(t,o(this,Ue,"f"))},GifImage.defaultSettings={delay:100,repeat:-1,colorDepth:8};class WavAudio extends EncoderBase{constructor(t,s=1,i=16){super(),Ne.set(this,void 0),Le.set(this,void 0),this.sampleRate=t,this.channels=s,this.bitsPerSample=i;const e=new ArrayBuffer(44),r=new DataStream(e);r.writeChars("RIFF"),r.writeUint32(0),r.writeChars("WAVE"),r.writeChars("fmt "),r.writeUint32(16),r.writeUint16(1),r.writeUint16(this.channels),r.writeUint32(this.sampleRate),r.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample),r.writeChars("data"),r.writeUint32(0),a(this,Ne,r,"f"),a(this,Le,null,"f")}static fromFlipnote(t){const s=t.sampleRate,i=new WavAudio(s,1,16),e=t.getAudioMasterPcm(s);return i.writeSamples(e),i}static fromFlipnoteTrack(t,s){const i=t.sampleRate,e=new WavAudio(i,1,16),r=t.getAudioTrackPcm(s,i);return e.writeSamples(r),e}writeSamples(t){let s=o(this,Ne,"f");s.seek(4),s.writeUint32(s.numBytes+t.byteLength),s.seek(40),s.writeUint32(t.byteLength),a(this,Le,t,"f")}getArrayBuffer(){const t=o(this,Ne,"f").bytes,s=new Uint8Array(o(this,Le,"f").buffer),i=new Uint8Array(o(this,Ne,"f").numBytes+o(this,Le,"f").byteLength);return i.set(t),i.set(s,t.byteLength),i.buffer}}Ne=new WeakMap,Le=new WeakMap,t.CanvasInterface=class{constructor(t,s,i,e){}},t.GifImage=GifImage,t.Html5Canvas=Html5Canvas,t.KwzParser=KwzParser,t.Player=Player,t.PlayerMixin=function(t){class PlayerMixinClass extends t{get renderer(){return this.player.renderer}get note(){return this.player.note}get noteFormat(){return this.player.noteFormat}get meta(){return this.player.meta}get duration(){return this.player.duration}get layerVisibility(){return this.player.layerVisibility}get autoplay(){return this.player.autoplay}set autoplay(t){this.player.autoplay=t}}for(let s of Reflect.ownKeys(Player.prototype)){let i=Object.getOwnPropertyDescriptor(Player.prototype,s);s in t.prototype||"constructor"===s||"name"===s||"prototype"===s||"string"==typeof s&&s.startsWith("#")||(i.value&&"function"==typeof i.value?Object.defineProperty(PlayerMixinClass.prototype,s,{...i,value(...t){return this.player[s](...t)}}):(i.get||i.set)&&Object.defineProperty(PlayerMixinClass.prototype,s,{...i,set(t){this.player[s]=t},get(){return this.player[s]}}))}return PlayerMixinClass},t.PpmParser=PpmParser,t.UniversalCanvas=UniversalCanvas,t.WavAudio=WavAudio,t.WebAudioPlayer=WebAudioPlayer,t.WebglCanvas=WebglCanvas,t.filename=Yt,t.id=Gt,t.loaders=hs,t.parse=as,t.parseSource=fs,t.playlist=os,t.supportedEvents=cs,t.version="6.0.1"}({});
//# sourceMappingURL=flipnote.min.js.map
