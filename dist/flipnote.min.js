/*!!
 * flipnote.js v6.0.1
 * https://flipnote.js.org
 * A JavaScript library for Flipnote Studio animation files
 * 2018 - 2024 James Daniel
 * Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
*/
!function(t){var s,i,e,r,h,n;t.FlipnoteRegion=void 0,(s=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",s.USA="USA",s.JPN="JPN",s.UNKNOWN="UNKNOWN",t.FlipnoteFormat=void 0,(i=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",i.KWZ="KWZ",function(t){t[t.Jpeg=0]="Jpeg",t[t.Rgba=1]="Rgba"}(e||(e={})),function(t){t[t.Left=0]="Left",t[t.Right=1]="Right"}(r||(r={})),t.FlipnoteAudioTrack=void 0,(h=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[h.BGM=0]="BGM",h[h.SE1=1]="SE1",h[h.SE2=2]="SE2",h[h.SE3=3]="SE3",h[h.SE4=4]="SE4",t.FlipnoteSoundEffectTrack=void 0,(n=t.FlipnoteSoundEffectTrack||(t.FlipnoteSoundEffectTrack={}))[n.SE1=1]="SE1",n[n.SE2=2]="SE2",n[n.SE3=3]="SE3",n[n.SE4=4]="SE4";class ByteArray{constructor(){this.pageSize=4096,this.allocSize=0,this.realSize=0,this.pages=[],this.numPages=0,this.pageIdx=0,this.pagePtr=0,this.realPtr=0,this.newPage()}set pointer(t){this.setPointer(t)}get pointer(){return this.realPtr}newPage(){this.pages[this.numPages]=new Uint8Array(this.pageSize),this.numPages=this.pages.length,this.allocSize=this.numPages*this.pageSize}setPointer(t){for(;t>=this.allocSize;)this.newPage();t>this.realSize&&(this.realSize=t),this.pageIdx=Math.floor(t/this.pageSize),this.pagePtr=t%this.pageSize,this.realPtr=t}writeByte(t){this.pages[this.pageIdx][this.pagePtr]=t,this.setPointer(this.realPtr+1)}writeBytes(t,s,i){for(let e=i||t.length,r=s||0;r<e;r++)this.writeByte(t[r])}writeChars(t){for(let s=0;s<t.length;s++)this.writeByte(t.charCodeAt(s))}writeU8(t){this.writeByte(255&t)}writeU16(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255)}writeU32(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255),this.writeByte(t>>>16&255),this.writeByte(t>>>24&255)}getBytes(){const t=new Uint8Array(this.realSize),s=this.numPages;for(let i=0;i<s;i++){const e=this.pages[i];i===s-1?t.set(e.slice(0,this.realSize%this.pageSize),i*this.pageSize):t.set(e,i*this.pageSize)}return t}getBuffer(){return this.getBytes().buffer}}class DataStream{constructor(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}get bytes(){return new Uint8Array(this.buffer)}get byteLength(){return this.data.byteLength}seek(t,s){switch(s){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;default:this.pointer=t}}readUint8(){const t=this.data.getUint8(this.pointer);return this.pointer+=1,t}writeUint8(t){this.data.setUint8(this.pointer,t),this.pointer+=1}readInt8(){const t=this.data.getInt8(this.pointer);return this.pointer+=1,t}writeInt8(t){this.data.setInt8(this.pointer,t),this.pointer+=1}readUint16(t=!0){const s=this.data.getUint16(this.pointer,t);return this.pointer+=2,s}writeUint16(t,s=!0){this.data.setUint16(this.pointer,t,s),this.pointer+=2}readInt16(t=!0){const s=this.data.getInt16(this.pointer,t);return this.pointer+=2,s}writeInt16(t,s=!0){this.data.setInt16(this.pointer,t,s),this.pointer+=2}readUint32(t=!0){const s=this.data.getUint32(this.pointer,t);return this.pointer+=4,s}writeUint32(t,s=!0){this.data.setUint32(this.pointer,t,s),this.pointer+=4}readInt32(t=!0){const s=this.data.getInt32(this.pointer,t);return this.pointer+=4,s}writeInt32(t,s=!0){this.data.setInt32(this.pointer,t,s),this.pointer+=4}readBytes(t){const s=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=s.byteLength,s}writeBytes(t){t.forEach((t=>this.writeUint8(t)))}readHex(t,s=!1){const i=this.readBytes(t);let e=[];for(let t=0;t<i.length;t++)e.push(i[t].toString(16).padStart(2,"0"));return s&&e.reverse(),e.join("").toUpperCase()}readChars(t){const s=this.readBytes(t);let i="";for(let t=0;t<s.length;t++){const e=s[t];if(0===e)break;i+=String.fromCharCode(e)}return i}writeChars(t){for(let s=0;s<t.length;s++){const i=t.charCodeAt(s);this.writeUint8(i)}}readWideChars(t){const s=new Uint16Array(this.data.buffer,this.pointer,t);let i="";for(let t=0;t<s.length;t++){const e=s[t];if(0==e)break;i+=String.fromCharCode(e)}return this.pointer+=s.byteLength,i}}const o=(t,s,i)=>t<s?s:t>i?i:t;function a(t,s="Assert failed"){t||c(s)}const u=(t,s,i,e="")=>a(t>=s&&t<=i,`flipnote.js error: ${e||"value"} ${t} should be between ${s} and ${i}`),c=(t="Assert failed")=>{throw new Error("flipnote.js error: "+t)},l=()=>y?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},f="undefined"!=typeof window&&void 0!==window.document,d=()=>a(f,"This feature is only available in browser environments"),y="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,p="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name;var m;!function(){if(!f)return function(){};document.createElement("a")}();class BaseParser extends DataStream{constructor(){super(...arguments),this[m]="Flipnote",this.titleFormats={COMMENT:"Comment by $USERNAME",FLIPNOTE:"Flipnote by $USERNAME",ICON:"Folder icon"},this.soundMeta=new Map,this.layerVisibility={1:!0,2:!0,3:!0},this.isFolderIcon=!1,this.isComment=!1,this.isDsiLibraryNote=!1}getTitle(t=this.titleFormats){return this.isFolderIcon?t.ICON:(this.isComment?t.COMMENT:t.FLIPNOTE).replace("$USERNAME",this.meta.current.username)}toString(){return this.getTitle()}*[(m=Symbol.toStringTag,Symbol.iterator)](){for(let t=0;t<this.frameCount;t++)yield t}getLayerPixels(t,s,i=new Uint8Array(this.imageWidth*this.imageHeight),e=0,h=r.Left){u(t,0,this.frameCount-1,"Frame index"),u(s,0,this.numLayers-1,"Layer index");const n=this.getFramePaletteIndices(t),o=s*this.numLayerColors,a=this.decodeFrame(t)[s],c=Math.floor(this.getFrameLayerDepths(t)[s]*e),l=h==r.Left?-c:c,f=this.srcWidth,d=this.imageWidth,y=this.imageWidth,p=this.imageHeight,m=this.imageOffsetX,w=this.imageOffsetY;if(i.fill(0),!this.layerVisibility[s+1])return i;for(let t=w,s=0;s<p;t++,s++)for(let e=m,r=0;r<y;e++,r++){const h=s*d+r+l;let u=a[t*f+e];0!==u&&(i[h]=n[o+u])}return i}getLayerPixelsRgba(t,s,i=new Uint32Array(this.imageWidth*this.imageHeight),e=new Uint32Array(16),h=0,n=r.Left){u(t,0,this.frameCount-1,"Frame index"),u(s,0,this.numLayers-1,"Layer index"),this.getFramePaletteUint32(t,e);const o=s*this.numLayerColors,a=this.decodeFrame(t)[s],c=Math.floor(this.getFrameLayerDepths(t)[s]*h),l=n==r.Left?-c:c,f=this.srcWidth,d=this.imageWidth,y=this.imageWidth-c,p=this.imageHeight,m=this.imageOffsetX,w=this.imageOffsetY;if(i.fill(0),!this.layerVisibility[s+1])return i;for(let t=w,s=0;s<p;t++,s++)for(let r=m,h=0;h<y;r++,h++){const n=s*d+h+l;let u=a[t*f+r];0!==u&&(i[n]=e[o+u])}return i}getFramePixels(t,s=new Uint8Array(this.imageWidth*this.imageHeight),i=0,e=r.Left){const h=this.srcWidth;this.imageWidth;const n=this.imageWidth,o=this.imageHeight,a=this.imageOffsetX,u=this.imageOffsetY,c=this.getFramePaletteIndices(t);s.fill(c[0]);const l=this.getFrameLayerOrder(t),f=this.getFrameLayerDepths(t),d=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const y=l[t],p=d[y],m=y*this.numLayerColors,w=Math.floor(f[y]*i),g=e==r.Left?-w:w;if(this.layerVisibility[y+1])for(let t=u,i=0;i<o;t++,i++)for(let e=a,r=0;r<n;e++,r++){const o=i*n+r+g;let a=p[t*h+e];0!==a&&(s[o]=c[m+a])}}return s}getFramePixelsRgba(t,s=new Uint32Array(this.imageWidth*this.imageHeight),i=new Uint32Array(16),e=0,h=r.Left){u(t,0,this.frameCount-1,"Frame index");const n=this.srcWidth,o=this.imageWidth,a=this.imageWidth,c=this.imageHeight,l=this.imageOffsetX,f=this.imageOffsetY;this.getFramePaletteUint32(t,i),s.fill(i[0]);const d=this.getFrameLayerOrder(t),y=this.getFrameLayerDepths(t),p=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const u=d[t];if(!this.layerVisibility[u+1])continue;const m=p[u],w=u*this.numLayerColors,g=Math.floor(y[u]*e),A=h==r.Left?-g:g;for(let t=f,e=0;t<c;t++,e++)for(let r=l,h=0;r<a;r++,h++){const a=e*o+h+A;let u=m[t*n+r];0!==u&&(s[a]=i[w+u])}}return s}getFramePaletteUint32(t,s=new Uint32Array(16)){u(t,0,this.frameCount-1,"Frame index");const i=this.getFramePalette(t);return s.fill(0),i.forEach((([t,i,e,r],h)=>s[h]=r<<24|e<<16|i<<8|t)),s}getSoundEffectFlagsForTrack(t){return this.getSoundEffectFlags().map((s=>s[t]))}isSoundEffectUsedOnFrame(t,s){return u(s,0,this.frameCount-1,"Frame index"),!!this.soundEffectTracks.includes(t)&&this.getFrameSoundEffectFlags(s)[t]}hasAudioTrack(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0}}const w=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,g=["01FACA7A4367FC5F","03D6E959E2F9A42D","03F80445160587FA","04068426E1008915","092A3EC8199FD5D5","0B8D56BA1BD441B8","0E61C75C9B5AD90B","14E494E35A443235"],A=t=>w.test(t)||g.includes(t),P=s=>{switch(s.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}},v=new Int8Array([-1,2,-1,2]),F=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),b=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),S=(t,s,i)=>i<0||i>=s?0:t[i],z=t=>{const s=t.length;let i=0;for(let e=0;e<s;e++){const s=t[e];(s<=-32768||s>=32767)&&(i+=1)}return i/s},U=t=>{const s=t.length;let i=0;for(let e=0;e<s;e++)i+=Math.pow(t[e],2);return Math.sqrt(i/s)},x=t=>new Date(1e3*(t+946684800)),T=(t,s)=>100*t*(1/s)/100,_=(()=>{if(f||p){const t=l();return(t.crypto||t.msCrypto).subtle}if(y)return((t,s)=>{try{return t.require(s)}catch{throw new Error(`Could not require(${s})`)}})(module,"crypto").webcrypto.subtle})(),E="RSASSA-PKCS1-v1_5",I=async(t,s)=>{const i=t.split("\n").filter((t=>!t.startsWith("-----")&&!t.endsWith("-----"))).join(""),e=atob(i),r=new Uint8Array(e.length).map(((t,s)=>e.charCodeAt(s)));return await _.importKey("spki",r.buffer,{name:E,hash:s},!1,["verify"])},C=async(t,s,i)=>await _.verify(E,t,s,i);var M;const B=[.5,.5,1,2,4,6,12,20,30],K={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},$=[4294967295,4283585106,4294967295,4288453788,4282665215,4283388360,4289506815,4278255360,4294918216,4290269009,4294945709,4278255360,4290205622,4278255360,4278255360,4278255360],k="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCPLwTL6oSflv+gjywi/sM0TUB\n90xqOvuCpjduETjPoN2FwMebxNjdKIqHUyDu4AvrQ6BDJc6gKUbZ1E27BGZoCPH4\n9zQRb+zAM6M9EjHwQ6BABr0u2TcF7xGg2uQ9MBWz9AfbVQ91NjfrNWo0f7UPmffv\n1VvixmTk1BCtavZxBwIDAQAB\n-----END PUBLIC KEY-----";class PpmParser extends BaseParser{static matchBuffer(t){const s=new Uint8Array(t.slice(0,4));return 1346458177==(s[0]<<24|s[1]<<16|s[2]<<8|s[3])}constructor(s,i={}){super(s),this.format=t.FlipnoteFormat.PPM,this[M]="Flipnote Studio PPM animation file",this.imageWidth=PpmParser.width,this.imageHeight=PpmParser.height,this.aspect=PpmParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=PpmParser.numLayers,this.numLayerColors=PpmParser.numLayerColors,this.publicKey=PpmParser.publicKey,this.srcWidth=PpmParser.width,this.audioTracks=PpmParser.audioTracks,this.soundEffectTracks=PpmParser.soundEffectTracks,this.rawSampleRate=PpmParser.rawSampleRate,this.sampleRate=PpmParser.sampleRate,this.globalPalette=PpmParser.globalPalette,this.prevDecodedFrame=null,this.decodeHeader(),this.decodeAnimationHeader(),this.decodeSoundHeader(),this.version>>4&15&&this.decodeMeta(),this.layerBuffers=[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],this.prevLayerBuffers=[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],this.lineEncodingBuffers=[new Uint8Array(PpmParser.height),new Uint8Array(PpmParser.height)],this.prevDecodedFrame=null}decodeHeader(){a(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16();let t=1696+this.frameDataLength+this.frameCount;t%4!=0&&(t+=4-t%4),a(t<this.byteLength),this.soundDataOffset=t}readFilename(){return`${this.readHex(3)}_${this.readChars(13)}_${this.readUint16().toString().padStart(3,"0")}`}decodeMeta(){a(1704<this.byteLength),this.seek(16);const t=this.readUint16(),s=this.readInt16(),i=this.readWideChars(11),e=this.readWideChars(11),r=this.readWideChars(11),h=this.readHex(8,!0),n=this.readHex(8,!0),o=this.readFilename(),u=this.readFilename(),c=this.readHex(8,!0);this.seek(154);const l=x(this.readInt32());this.seek(1702);const f=this.readUint16();this.thumbFrameIndex=s,this.layerVisibility={1:!(16&f),2:!(32&f),3:!1},this.isSpinoff=n!==h||n!==c,this.meta={lock:1===t,loop:1==(f>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:s,timestamp:l,root:{username:i,fsid:c,region:P(c),filename:null},parent:{username:e,fsid:h,region:P(h),filename:o},current:{username:r,fsid:n,region:P(n),filename:u}}}decodeAnimationHeader(){this.seek(1696);const t=this.readUint16(),s=t/4;a(s<=this.frameCount),this.seek(1704);const i=new Uint32Array(s);for(let e=0;e<s;e++){const s=1704+t+this.readUint32();a(s<this.byteLength,`Frame ${e} pointer is out of bounds`),i[e]=s}this.frameOffsets=i}decodeSoundHeader(){let s=this.soundDataOffset;this.seek(s);const i=this.readUint32(),e=this.readUint32(),r=this.readUint32(),h=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),a(this.frameSpeed<=8&&this.bgmSpeed<=8),s+=32,this.framerate=B[this.frameSpeed],this.duration=T(this.frameCount,this.framerate),this.bgmrate=B[this.bgmSpeed];const n=new Map;n.set(t.FlipnoteAudioTrack.BGM,{ptr:s,length:i}),n.set(t.FlipnoteAudioTrack.SE1,{ptr:s+=i,length:e}),n.set(t.FlipnoteAudioTrack.SE2,{ptr:s+=e,length:r}),n.set(t.FlipnoteAudioTrack.SE3,{ptr:s+=r,length:h}),this.soundMeta=n}isKeyFrame(t){return u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]),this.readUint8()>>7&1}getThumbnailImage(){this.seek(160);const t=this.readBytes(1536),s=new Uint32Array(3072);for(let i=0;i<48;i+=8)for(let e=0;e<64;e+=8)for(let r=0;r<8;r+=1)for(let h=0;h<8;h+=2){const n=e+h,o=i+r;s[64*o+n]=$[15&t[0]],s[64*o+n+1]=$[t[0]<<4&15]}return{format:e.Rgba,width:64,height:48,data:s.buffer}}decodeFrame(t){if(u(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame===t-1||this.isKeyFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);const s=this.readUint8(),i=s>>7&1,e=s>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);let r=0,h=0;e&&(r=this.readInt8(),h=this.readInt8());for(let t=0;t<2;t++){const s=this.lineEncodingBuffers[t];s.fill(0);for(let t=0;t<s.length;){let i=this.readUint8();0!==i?(s[t++]=3&i,s[t++]=i>>2&3,s[t++]=i>>4&3,s[t++]=i>>6&3):t+=4}}for(let t=0;t<2;t++){const s=this.layerBuffers[t],i=this.lineEncodingBuffers[t];for(let t=0;t<PpmParser.height;t++){let e=t*PpmParser.width;switch(i[t]){case 0:break;case 1:for(var n=this.readUint32(!1);0!==n;n<<=1,e+=8)if(2147483648&n){let t=this.readUint8();for(let i=0;0!==t;i++,t>>=1)s[e+i]=1&t}break;case 2:for(s.fill(1,e,e+PpmParser.width),n=this.readUint32(!1);0!==n;n<<=1,e+=8)if(2147483648&n){let t=this.readUint8();for(let i=0;i<8;i++,t>>=1)s[e+i]=1&t}break;case 3:for(let t=0,i=0;i<PpmParser.width;i++)i%8==0&&(t=this.readUint8()),s[e++]=1&t,t>>=1}}}const o=this.layerBuffers[0],a=this.layerBuffers[1],c=this.prevLayerBuffers[0],l=this.prevLayerBuffers[1];if(i||0!==r||0!==h){if(!i){const t=PpmParser.width,s=PpmParser.height,i=Math.max(r,0),e=Math.max(h,0),n=Math.min(t+r,t),u=Math.min(s+h,s),f=h*t+r;let d,y;for(let s=e;s<u;s++)for(let e=i;e<n;e++)d=s*t+e,y=d-f,o[d]^=c[y],a[d]^=l[y]}}else{const t=PpmParser.height*PpmParser.width;for(let s=0;s<t;s++)o[s]^=c[s],a[s]^=l[s]}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers}getFramePaletteIndices(t){u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]);const s=this.readUint8(),i=!!(1&~s),e=[i?0:1,i?0:1,2,3];return[i?1:0,e[s>>1&3],e[s>>3&3]]}getFramePalette(t){return u(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((t=>this.globalPalette[t]))}getIsKeyFrame(t){const s=1===this.isKeyFrame(t);return[s,s]}getFrameLayerDepths(t){return[0,0]}getFrameAuthor(t){return this.meta.current.fsid}getFrameCameraFlags(t){return[!1,!1]}getFrameLayerOrder(t){return[1,0]}decodeSoundFlags(){if(void 0!==this.soundFlags)return this.soundFlags;a(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);const t=this.frameCount,s=this.readBytes(t);this.soundFlags=new Array(t);for(let i=0;i<t;i++){const t=s[i];this.soundFlags[i]=[!!(1&t),!!(2&t),!!(4&t)]}return this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map((s=>({[t.FlipnoteSoundEffectTrack.SE1]:s[0],[t.FlipnoteSoundEffectTrack.SE2]:s[1],[t.FlipnoteSoundEffectTrack.SE3]:s[2],[t.FlipnoteSoundEffectTrack.SE4]:!1})))}getFrameSoundEffectFlags(s){u(s,0,this.frameCount-1,"Frame index"),this.seek(1696+this.frameDataLength+s);const i=this.readUint8();return{[t.FlipnoteSoundEffectTrack.SE1]:!!(1&i),[t.FlipnoteSoundEffectTrack.SE2]:!!(2&i),[t.FlipnoteSoundEffectTrack.SE3]:!!(4&i),[t.FlipnoteSoundEffectTrack.SE4]:!1}}getAudioTrackRaw(t){const s=this.soundMeta.get(t);return a(s.ptr+s.length<this.byteLength),this.seek(s.ptr),this.readBytes(s.length)}decodeAudioTrack(t){const s=this.getAudioTrackRaw(t),i=s.length,e=new Int16Array(2*i);let r=0,h=0,n=0,a=0,u=0,c=!0;for(;r<i;){n=c?15&s[r]:s[r++]>>4,c=!c;const t=b[a];let i=t>>3;1&n&&(i+=t>>2),2&n&&(i+=t>>1),4&n&&(i+=t),8&n&&(i=-i),u+=i,u=o(u,-32768,32767),a+=F[n],a=o(a,0,88),e[h++]=u}return e}getAudioTrackPcm(s,i=this.sampleRate){const e=this.decodeAudioTrack(s);let r=this.rawSampleRate;if(s===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==i?((t,s,i)=>{const e=t.length,r=e/s*i,h=new Int16Array(r),n=s/i;for(let s=0;s<r;s++)h[s]=S(t,e,Math.floor(s*n));return h})(e,r,i):e}pcmAudioMix(t,s,i=0){const e=t.length,r=s.length;for(let h=0;h<e&&!(i+h>r);h++){const e=s[i+h]+t[h]/2;s[i+h]=o(e,-32768,32767)}}getAudioMasterPcm(s=this.sampleRate){const i=Math.ceil(this.duration*s),e=new Int16Array(i),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),h=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(r){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,s);this.pcmAudioMix(i,e,0)}if(h||n||o){const i=s/this.framerate,r=h?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,s):null,a=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,s):null,u=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,s):null,c=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const s=Math.ceil(t*i),l=c[t];h&&l[0]&&this.pcmAudioMix(r,e,s),n&&l[1]&&this.pcmAudioMix(a,e,s),o&&l[2]&&this.pcmAudioMix(u,e,s)}}return this.audioClipRatio=z(e),e}getBody(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(0,t)}getSignature(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(t,t+128)}async verify(){const t=await I(k,"SHA-1");return await C(t,this.getSignature(),this.getBody())}}M=Symbol.toStringTag,PpmParser.defaultSettings={},PpmParser.format=t.FlipnoteFormat.PPM,PpmParser.width=256,PpmParser.height=192,PpmParser.aspect=3/4,PpmParser.numLayers=2,PpmParser.numLayerColors=1,PpmParser.rawSampleRate=8192,PpmParser.sampleRate=32768,PpmParser.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3],PpmParser.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3],PpmParser.globalPalette=[K.WHITE,K.BLACK,K.RED,K.BLUE],PpmParser.publicKey=k;const L=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,N=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/,D=["5f-fc67-437a-cafa01","2d-a4f9-e259-e9d603","fa-8705-1645-04f803","15-8900-e126-840604","d5-d59f-19c8-3e2a09","b8-41d4-1bba-568d0b","0b-d95a-9b5c-c7610e","35-3244-5ae3-94e414"],H=t=>L.test(t),R=t=>{if(N.test(t))return!0;for(let s of D)if(t.endsWith(s))return!0;return!1},G=s=>{if(R(s))switch(s.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}return t.FlipnoteRegion.UNKNOWN};var O;const W=[.2,.5,1,2,4,6,8,12,20,24,30],j={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},Q="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuv+zHAXXvbbtRqxADDeJ\nArX2b9RMxj3T+qpRg3FnIE/jeU3tj7eoDzsMduY+D/UT9CSnP+QHYY/vf0n5lqX9\ns6ljoZAmyUuruyj1e5Bg+fkDEu/yPEPQjqhbyywCyYL4TEAOJveopUBx9fdQxUJ6\nJ4J5oCE/Im1kFrlGW+puARiHmt3mmUyNzO8bI/Jx3cGSfoOHJG1foEaQsI5aaKqA\npBqxtzvwqMhudcZtAWSyRMBMlndvkRnVTDNTfTXLOYdHShCIgnKULCTH87uLBIP/\nnsmr4/bnQz8q2rp/HyVO+0yjR6mVr0NX5APJQ+6riJmGg3t3VOldhKP7aTHDUW+h\nkQIDAQAB\n-----END PUBLIC KEY-----",V=new Uint16Array(16);for(let t=0;t<16;t++)V[t]=(1<<t)-1;const q=new Uint8Array(52488),Y=new Uint8Array(52488);var J=0;for(let t=0;t<3;t++)for(let s=0;s<3;s++)for(let i=0;i<3;i++)for(let e=0;e<3;e++)for(let r=0;r<3;r++)for(let h=0;h<3;h++)for(let n=0;n<3;n++)for(let o=0;o<3;o++)q.set([s,t,e,i,h,r,o,n],J),Y.set([t,e,i,h,r,o,n,s],J),J+=8;const Z=new Uint8Array(256),X=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach(((t,s)=>{const i=8*t,e=q.subarray(i,i+8),r=Y.subarray(i,i+8);Z.set(e,8*s),X.set(r,8*s)}));class KwzParser extends BaseParser{static matchBuffer(t){const s=new Uint8Array(t.slice(0,4)),i=s[0]<<24|s[1]<<16|s[2]<<8;return 1262897152===i||1263092480===i}constructor(s,i={}){super(s),this.format=t.FlipnoteFormat.KWZ,this[O]="Flipnote Studio 3D KWZ animation file",this.imageWidth=KwzParser.width,this.imageHeight=KwzParser.height,this.aspect=KwzParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=KwzParser.numLayers,this.numLayerColors=KwzParser.numLayerColors,this.publicKey=KwzParser.publicKey,this.srcWidth=KwzParser.width,this.audioTracks=KwzParser.audioTracks,this.soundEffectTracks=KwzParser.soundEffectTracks,this.rawSampleRate=KwzParser.rawSampleRate,this.sampleRate=KwzParser.sampleRate,this.globalPalette=KwzParser.globalPalette,this.prevDecodedFrame=null,this.bitIndex=0,this.bitValue=0,this.settings={...KwzParser.defaultSettings,...i},this.layerBuffers=[new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height)],this.buildSectionMap(),this.sectionMap.has("KIC")?(this.isFolderIcon=!0,this.imageWidth=24,this.imageHeight=24,this.frameCount=1,this.frameSpeed=0,this.framerate=W[0],this.thumbFrameIndex=0,this.getFrameOffsets()):this.sectionMap.has("KSN")?(this.decodeMeta(),this.getFrameOffsets(),this.decodeSoundHeader()):(this.isComment=!0,this.decodeMeta(),this.getFrameOffsets()),this.settings.dsiLibraryNote&&(this.isDsiLibraryNote=!0),this.settings.borderCrop&&(this.isDsiLibraryNote?(this.imageOffsetX=32,this.imageOffsetY=24,this.imageWidth=256,this.imageHeight=192):this.isFolderIcon||(this.imageOffsetX=5,this.imageOffsetY=5,this.imageWidth=310,this.imageHeight=230))}buildSectionMap(){const t=this.byteLength-256,s=new Map;let i=0,e=0;for(;e<t&&i<6;){this.seek(e);const t=this.readChars(4).substring(0,3),r=this.readUint32();s.set(t,{ptr:e,length:r}),e+=r+8,i+=1}this.bodyEndOffset=e,this.sectionMap=s,a(s.has("KMC")&&s.has("KMI"))}readBits(t){if(this.bitIndex+t>16){const t=this.readUint16();this.bitValue|=t<<16-this.bitIndex,this.bitIndex-=16}const s=this.bitValue&V[t];return this.bitValue>>=t,this.bitIndex+=t,s}readFsid(){if(this.settings.dsiLibraryNote)return this.readHex(10,!0).slice(2,18);const t=this.readHex(10);return`${t.slice(0,4)}-${t.slice(4,8)}-${t.slice(8,12)}-${t.slice(12,18)}`.toLowerCase()}readFilename(){const t=this.pointer,s=this.readChars(28);if(28===s.length)return s;this.seek(t);const i=this.readHex(3),e=this.readChars(13),r=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),`${i}_${e}_${r}`}decodeMeta(){if(this.settings.quickMeta)return this.decodeMetaQuick();a(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);const t=x(this.readUint32()),s=x(this.readUint32());this.readUint32();const i=this.readFsid(),e=this.readFsid(),r=this.readFsid(),h=this.readWideChars(11),n=this.readWideChars(11),o=this.readWideChars(11),u=this.readFilename(),c=this.readFilename(),l=this.readFilename(),f=this.readUint16(),d=this.readUint16(),y=this.readUint16(),p=this.readUint8(),m=this.readUint8();this.isSpinoff=r!==e||r!==i,this.frameCount=f,this.frameSpeed=p,this.framerate=W[p],this.duration=T(this.frameCount,this.framerate),this.thumbFrameIndex=d,this.layerVisibility={1:!(1&m),2:!(2&m),3:!(3&m)},this.meta={lock:!!(1&y),loop:!!(2&y),isSpinoff:this.isSpinoff,frameCount:f,frameSpeed:p,duration:this.duration,thumbIndex:d,timestamp:s,creationTimestamp:t,root:{username:h,fsid:i,region:G(i),filename:u,isDsiFilename:28!==u.length},parent:{username:n,fsid:e,region:G(e),filename:c,isDsiFilename:28!==c.length},current:{username:o,fsid:r,region:G(r),filename:l,isDsiFilename:28!==l.length}}}decodeMetaQuick(){a(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);const t=this.readUint16(),s=this.readUint16();this.readUint16();const i=this.readUint8(),e=this.readUint8();this.frameCount=t,this.thumbFrameIndex=s,this.frameSpeed=i,this.framerate=W[i],this.duration=T(this.frameCount,this.framerate),this.layerVisibility={1:!(1&e),2:!(2&e),3:!(3&e)}}getFrameOffsets(){a(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));const t=this.frameCount,s=this.sectionMap.get("KMI"),i=this.sectionMap.get("KMC");a(s.length/28>=t);const e=new Uint32Array(t),r=new Uint32Array(t),h=[];let n=s.ptr+8,o=i.ptr+12;for(let s=0;s<t;s++){this.seek(n+4);const t=this.readUint16(),i=this.readUint16(),u=this.readUint16();e[s]=n,r[s]=o,n+=28,o+=t+i+u,a(n<this.byteLength,`frame${s} meta pointer out of bounds`),a(o<this.byteLength,`frame${s} data pointer out of bounds`),h.push([t,i,u])}this.frameMetaOffsets=e,this.frameDataOffsets=r,this.frameLayerSizes=h}decodeSoundHeader(){a(this.sectionMap.has("KSN"));let s=this.sectionMap.get("KSN").ptr+8;this.seek(s),this.bgmSpeed=this.readUint32(),a(this.bgmSpeed<=10),this.bgmrate=W[this.bgmSpeed];const i=new Uint32Array(this.buffer,s+4,20),e=new Map;e.set(t.FlipnoteAudioTrack.BGM,{ptr:s+=28,length:i[0]}),e.set(t.FlipnoteAudioTrack.SE1,{ptr:s+=i[0],length:i[1]}),e.set(t.FlipnoteAudioTrack.SE2,{ptr:s+=i[1],length:i[2]}),e.set(t.FlipnoteAudioTrack.SE3,{ptr:s+=i[2],length:i[3]}),e.set(t.FlipnoteAudioTrack.SE4,{ptr:s+=i[3],length:i[4]}),this.soundMeta=e}getThumbnailImage(){a(this.sectionMap.has("KTN"),"KTN section missing - Note that folder icons and comments do not contain thumbnail data");const t=this.sectionMap.get("KTN");this.seek(t.ptr+12);const s=this.readBytes(t.length-12);return{format:e.Jpeg,width:80,height:64,data:s.buffer}}getFramePaletteIndices(t){u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]);const s=this.readUint32();return[15&s,s>>8&15,s>>12&15,s>>16&15,s>>20&15,s>>24&15,s>>28&15]}getFramePalette(t){return u(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((t=>this.globalPalette[t]))}getFrameDiffingFlag(t){return u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]),this.readUint32()>>4&7}getIsKeyFrame(t){const s=this.getFrameDiffingFlag(t);return[!(1&s),!(2&s),!(4&s)]}getFrameLayerDepths(t){return u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]}getFrameAuthor(t){return u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+10),this.readFsid()}getFrameCameraFlags(t){this.seek(this.frameMetaOffsets[t]+26);const s=this.readUint8();return[!!(1&s),!!(2&s),!!(4&s)]}getFrameLayerOrder(t){u(t,0,this.frameCount-1,"Frame index");const s=this.getFrameLayerDepths(t);return[2,1,0].sort(((t,i)=>s[i]-s[t]))}decodeFrame(t,s=7,i=!1){if(u(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame!==t-1&&0!==t&&(i&&(s&=~this.getFrameDiffingFlag(t+1)),0!==s&&this.decodeFrame(t-1,s,!0));let e=this.frameDataOffsets[t];const r=this.frameLayerSizes[t];for(let t=0;t<3&&(!this.settings.dsiLibraryNote||3!==t);t++){this.seek(e);let i=r[t];e+=i;const h=this.layerBuffers[t];if(38===i)continue;if(!(s>>t&1))continue;this.bitIndex=16,this.bitValue=0;let n=0;for(let t=0;t<240;t+=128)for(let s=0;s<320;s+=128)for(let i=0;i<128;i+=8){const e=t+i;if(e>=240)break;for(let t=0;t<128;t+=8){const i=s+t;if(i>=320)break;if(n>0){n-=1;continue}let r=e*KwzParser.width+i;const o=this.readBits(3);if(0===o){const t=8*this.readBits(5),s=Z.subarray(t,t+8);h.set(s,r),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320)}else if(1===o){const t=8*this.readBits(13),s=q.subarray(t,t+8);h.set(s,r),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320),h.set(s,r+=320)}else if(2===o){const t=8*this.readBits(5),s=Z.subarray(t,t+8),i=X.subarray(t,t+8);h.set(s,r),h.set(i,r+=320),h.set(s,r+=320),h.set(i,r+=320),h.set(s,r+=320),h.set(i,r+=320),h.set(s,r+=320),h.set(i,r+=320)}else if(3===o){const t=8*this.readBits(13),s=q.subarray(t,t+8),i=Y.subarray(t,t+8);h.set(s,r),h.set(i,r+=320),h.set(s,r+=320),h.set(i,r+=320),h.set(s,r+=320),h.set(i,r+=320),h.set(s,r+=320),h.set(i,r+=320)}else if(4===o){const t=this.readBits(8);for(let s=1;s<255;s<<=1){if(t&s){const t=8*this.readBits(5),s=Z.subarray(t,t+8);h.set(s,r)}else{const t=8*this.readBits(13),s=q.subarray(t,t+8);h.set(s,r)}r+=320}}else{if(5===o){n=this.readBits(5);continue}if(7===o){let t,s,i=this.readBits(2);if(0!==this.readBits(1)){const e=8*this.readBits(5),r=8*this.readBits(5);t=Z.subarray(e,e+8),s=Z.subarray(r,r+8),i+=1}else{const i=8*this.readBits(13),e=8*this.readBits(13);t=q.subarray(i,i+8),s=q.subarray(e,e+8)}switch(i%4){case 0:h.set(t,r),h.set(s,r+=320),h.set(t,r+=320),h.set(s,r+=320),h.set(t,r+=320),h.set(s,r+=320),h.set(t,r+=320),h.set(s,r+=320);break;case 1:h.set(t,r),h.set(t,r+=320),h.set(s,r+=320),h.set(t,r+=320),h.set(t,r+=320),h.set(s,r+=320),h.set(t,r+=320),h.set(t,r+=320);break;case 2:h.set(t,r),h.set(s,r+=320),h.set(t,r+=320),h.set(t,r+=320),h.set(s,r+=320),h.set(t,r+=320),h.set(t,r+=320),h.set(s,r+=320);break;case 3:h.set(t,r),h.set(s,r+=320),h.set(s,r+=320),h.set(t,r+=320),h.set(s,r+=320),h.set(s,r+=320),h.set(t,r+=320),h.set(s,r+=320)}}}}}}return this.prevDecodedFrame=t,this.layerBuffers}decodeFrameSoundFlags(t){u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+23);const s=this.readUint8();return[!!(1&s),!!(2&s),!!(4&s),!!(8&s)]}decodeSoundFlags(){return void 0!==this.soundFlags||(this.soundFlags=new Array(this.frameCount).fill(!1).map(((t,s)=>this.decodeFrameSoundFlags(s)))),this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map((s=>({[t.FlipnoteSoundEffectTrack.SE1]:s[0],[t.FlipnoteSoundEffectTrack.SE2]:s[1],[t.FlipnoteSoundEffectTrack.SE3]:s[2],[t.FlipnoteSoundEffectTrack.SE4]:s[3]})))}getFrameSoundEffectFlags(s){const i=this.decodeFrameSoundFlags(s);return{[t.FlipnoteSoundEffectTrack.SE1]:i[0],[t.FlipnoteSoundEffectTrack.SE2]:i[1],[t.FlipnoteSoundEffectTrack.SE3]:i[2],[t.FlipnoteSoundEffectTrack.SE4]:i[3]}}getAudioTrackRaw(t){const s=this.soundMeta.get(t);return a(s.ptr+s.length<this.byteLength),new Uint8Array(this.buffer,s.ptr,s.length)}decodeAdpcm(t,s,i=0,e=0){const r=t.length;let h=0,n=0,a=0,u=0;for(let c=0;c<r;c++){let r=t[c],l=0;for(;l<8;)e<18||l>4?(n=3&r,a=b[e],u=a>>3,1&n&&(u+=a),2&n&&(u=-u),i+=u,e+=v[n],r>>=2,l+=2):(n=15&r,a=b[e],u=a>>3,1&n&&(u+=a>>2),2&n&&(u+=a>>1),4&n&&(u+=a),8&n&&(u=-u),i+=u,e+=F[n],r>>=4,l+=4),e=o(e,0,79),i=o(i,-2048,2047),s[h]=16*i,h+=1}return h}decodeAudioTrack(s){const i=this.settings,e=this.getAudioTrackRaw(s),r=60*this.rawSampleRate,h=new Int16Array(r);let n=0,o=40;if(this.isDsiLibraryNote)if(s===t.FlipnoteAudioTrack.BGM){let t=!0;if(null!==i.initialBgmPredictor&&(n=i.initialBgmPredictor,t=!1),null!==i.initialBgmStepIndex&&(o=i.initialBgmStepIndex,t=!1),t&&i.guessInitialBgmState){let t=4294967295,s=0;for(o=0;o<=40;o++){const i=this.decodeAdpcm(e,h,n,o),r=U(h.subarray(0,i));r<t&&(t=r,s=o)}o=s}}else{const t=this.soundEffectTracks.indexOf(s);Array.isArray(i.initialSePredictors)&&void 0!==i.initialSePredictors[t]&&(n=i.initialSePredictors[t]),Array.isArray(i.initialSeStepIndices)&&void 0!==i.initialSeStepIndices[t]&&(o=i.initialSeStepIndices[t])}const a=this.decodeAdpcm(e,h,n,o);return h.slice(0,a)}getAudioTrackPcm(s,i=this.sampleRate){const e=this.decodeAudioTrack(s);let r=this.rawSampleRate;if(s===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==i?((t,s,i)=>{const e=t.length,r=e/s*i,h=new Int16Array(r),n=s/i;for(let s=0,i=0,a=0,u=0;s<r;s++)i=s*n,a=Math.floor(i),u=i%1,h[s]=(o=S(t,e,a))+u*(S(t,e,a+1)-o);var o;return h})(e,r,i):e}pcmAudioMix(t,s,i=0){const e=t.length,r=s.length;for(let h=0;h<e&&!(i+h>r);h++){const e=s[i+h]+t[h];s[i+h]=o(e,-32768,32767)}}getAudioMasterPcm(s=this.sampleRate){const i=Math.ceil(this.duration*s),e=new Int16Array(i),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),h=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(r){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,s);this.pcmAudioMix(i,e,0)}if(h||n||o||a){const i=s/this.framerate,r=h?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,s):null,u=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,s):null,c=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,s):null,l=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,s):null,f=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const s=f[t],d=Math.ceil(t*i);h&&s[0]&&this.pcmAudioMix(r,e,d),n&&s[1]&&this.pcmAudioMix(u,e,d),o&&s[2]&&this.pcmAudioMix(c,e,d),a&&s[3]&&this.pcmAudioMix(l,e,d)}}return this.audioClipRatio=z(e),e}getBody(){const t=this.bodyEndOffset;return this.bytes.subarray(0,t)}getSignature(){const t=this.bodyEndOffset;return this.bytes.subarray(t,t+256)}async verify(){const t=await I(Q,"SHA-256");return await C(t,this.getSignature(),this.getBody())}}O=Symbol.toStringTag,KwzParser.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,guessInitialBgmState:!0,initialBgmPredictor:null,initialBgmStepIndex:null,initialSePredictors:null,initialSeStepIndices:null},KwzParser.format=t.FlipnoteFormat.KWZ,KwzParser.width=320,KwzParser.height=240,KwzParser.aspect=3/4,KwzParser.numLayers=3,KwzParser.numLayerColors=2,KwzParser.rawSampleRate=16364,KwzParser.sampleRate=32768,KwzParser.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3,t.FlipnoteAudioTrack.SE4],KwzParser.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3,t.FlipnoteSoundEffectTrack.SE4],KwzParser.globalPalette=[j.WHITE,j.BLACK,j.RED,j.YELLOW,j.GREEN,j.BLUE,j.NONE],KwzParser.publicKey=Q;const tt={name:"url",matches(t){return"string"==typeof t},async load(t){const s=await fetch(t);return a(s.status>=200&&s.status<300,`Failed to load Flipnote from URL, response failed with status ${s.status}`),await s.arrayBuffer()}},st={name:"file",matches(t){return f&&"undefined"!=typeof File&&"undefined"!=typeof FileReader&&t instanceof File},async load(t){return t.arrayBuffer()}},it={name:"blob",matches(t){return f&&"undefined"!=typeof Blob&&"undefined"!=typeof Response&&t instanceof Blob},async load(t){return t.arrayBuffer()}},et={name:"node-buffer",matches(t){return y&&t instanceof Buffer},async load(t){return t.buffer}},rt={name:"array-buffer",matches(t){return t instanceof ArrayBuffer},async load(t){return t}},ht=new Map,nt=t=>{for(let[s,i]of ht)if(i.matches(t))try{return i.load(t)}catch(t){c(`Failed to load Flipnote from source, loader "${s}" failed with error ${c}`)}c("No loader available for source type")},ot=t=>{ht.set(t.name,t)};ot(tt),ot(st),ot(it),ot(et),ot(rt);var at=Object.freeze({__proto__:null,loadSource:nt,registerLoader:ot});const ut=async(t,s)=>{const i=await nt(t);return PpmParser.matchBuffer(i)?new PpmParser(i,s):KwzParser.matchBuffer(i)?new KwzParser(i,s):void c("Could not identify source as a valid Flipnote file")},ct=ut;var lt;t.PlayerEvent=void 0,(lt=t.PlayerEvent||(t.PlayerEvent={})).t="any",lt.Play="play",lt.Pause="pause",lt.CanPlay="canplay",lt.CanPlayThrough="canplaythrough",lt.SeekStart="seeking",lt.SeekEnd="seeked",lt.Duration="durationchange",lt.Loop="loop",lt.Ended="ended",lt.VolumeChange="volumechange",lt.Progress="progress",lt.TimeUpdate="timeupdate",lt.FrameUpdate="frameupdate",lt.FrameNext="framenext",lt.FramePrev="frameprev",lt.FrameFirst="framefirst",lt.FrameLast="framelast",lt.Ready="ready",lt.Load="load",lt.LoadStart="loadstart",lt.LoadedData="loadeddata",lt.LoadedMeta="loadedmetadata",lt.Emptied="emptied",lt.Close="close",lt.Error="error",lt.Destroy="destroy";const ft=[t.PlayerEvent.Play,t.PlayerEvent.Pause,t.PlayerEvent.CanPlay,t.PlayerEvent.CanPlayThrough,t.PlayerEvent.SeekStart,t.PlayerEvent.SeekEnd,t.PlayerEvent.Duration,t.PlayerEvent.Loop,t.PlayerEvent.Ended,t.PlayerEvent.VolumeChange,t.PlayerEvent.Progress,t.PlayerEvent.TimeUpdate,t.PlayerEvent.FrameUpdate,t.PlayerEvent.FrameNext,t.PlayerEvent.FramePrev,t.PlayerEvent.FrameFirst,t.PlayerEvent.FrameLast,t.PlayerEvent.Ready,t.PlayerEvent.Load,t.PlayerEvent.LoadStart,t.PlayerEvent.LoadedData,t.PlayerEvent.LoadedMeta,t.PlayerEvent.Emptied,t.PlayerEvent.Close,t.PlayerEvent.Error],dt=t=>({length:t.length,start:s=>t[s][0],end:s=>t[s][1]}),yt=(t,s)=>t.toString().padStart(s,"0"),pt=t=>{const s=Math.floor(t%3600/60),i=Math.floor(t%60);return`${s}:${yt(i,2)}`};var mt;!function(t){t[t.None=0]="None",t[t.Dual=1]="Dual",t[t.Anaglyph=2]="Anaglyph"}(mt||(mt={}));const wt=5120,gt=5121,At=5122,Pt=5123,vt=5124,Ft=5125,bt=5126,St={};{const t=St;t[wt]=Int8Array,t[gt]=Uint8Array,t[At]=Int16Array,t[Pt]=Uint16Array,t[vt]=Int32Array,t[Ft]=Uint32Array,t[bt]=Float32Array,t[32819]=Uint16Array,t[32820]=Uint16Array,t[33635]=Uint16Array,t[5131]=Uint16Array,t[33640]=Uint32Array,t[35899]=Uint32Array,t[35902]=Uint32Array,t[36269]=Uint32Array,t[34042]=Uint32Array}function zt(t){if(t instanceof Int8Array)return wt;if(t instanceof Uint8Array)return gt;if(t instanceof Uint8ClampedArray)return gt;if(t instanceof Int16Array)return At;if(t instanceof Uint16Array)return Pt;if(t instanceof Int32Array)return vt;if(t instanceof Uint32Array)return Ft;if(t instanceof Float32Array)return bt;throw new Error("unsupported typed array type")}function Ut(t){if(t===Int8Array)return wt;if(t===Uint8Array)return gt;if(t===Uint8ClampedArray)return gt;if(t===Int16Array)return At;if(t===Uint16Array)return Pt;if(t===Int32Array)return vt;if(t===Uint32Array)return Ft;if(t===Float32Array)return bt;throw new Error("unsupported typed array type")}const xt="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer},Tt=new Map;function _t(t,s){if(!t||"object"!=typeof t)return!1;let i=Tt.get(s);i||(i=new WeakMap,Tt.set(s,i));let e=i.get(t);if(void 0===e){const r=Object.prototype.toString.call(t);e=r.substring(8,r.length-1)===s,i.set(t,e)}return e}function Et(t,s){return"undefined"!=typeof WebGLTexture&&_t(s,"WebGLTexture")}const It=35044,Ct=34962,Mt=5126,Bt="";function Kt(t,s,i,e){if("undefined"!=typeof WebGLBuffer&&_t(s,"WebGLBuffer"))return s;i=i||Ct;const r=t.createBuffer();return function(t,s,i,e,r){t.bindBuffer(s,i),t.bufferData(s,e,r||It)}(t,i,r,s,e),r}function $t(t){return"indices"===t}const kt=/coord|texture/i,Lt=/color|colour/i;function Nt(t,s){if(xt(t))return t;if(xt(t.data))return t.data;Array.isArray(t)&&(t={data:t});let i=t.type?Dt(t.type):void 0;return i||(i=$t(s)?Uint16Array:Float32Array),new i(t.data)}function Dt(t){return"number"==typeof t?function(t){const s=St[t];if(!s)throw new Error("unknown gl type");return s}(t):t||Float32Array}function Ht(t,s){return{buffer:s.buffer,numValues:24,type:(i=s.type,"number"==typeof i?i:i?Ut(i):Mt),arrayType:Dt(s.type)};var i}function Rt(t,s){const i=s.data||s,e=Dt(s.type),r=i*e.BYTES_PER_ELEMENT,h=t.createBuffer();return t.bindBuffer(Ct,h),t.bufferData(Ct,r,s.drawType||It),{buffer:h,numValues:i,type:Ut(e),arrayType:e}}function Gt(t,s,i){const e=Nt(s,i);return{arrayType:e.constructor,buffer:Kt(t,e,void 0,s.drawType),type:zt(e),numValues:0}}function Ot(t,s){const i={};return Object.keys(s).forEach((function(e){if(!$t(e)){const h=s[e],n=h.attrib||h.name||h.attribName||Bt+e;if(h.value){if(!Array.isArray(h.value)&&!xt(h.value))throw new Error("array.value is not array or typedarray");i[n]={value:h.value}}else{let s;s=h.buffer&&h.buffer instanceof WebGLBuffer?Ht:"number"==typeof h||"number"==typeof h.data?Rt:Gt;const{buffer:o,type:a,numValues:u,arrayType:c}=s(t,h,e),l=void 0!==h.normalize?h.normalize:(r=c)===Int8Array||r===Uint8Array,f=function(t,s,i){return t.numComponents||t.size||function(t,s){let i;if(i=kt.test(t)?2:Lt.test(t)?4:3,s%i>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${i} but ${s} values is not evenly divisible by ${i}. You should specify it.`);return i}(s,i||function(t){return t.length?t:t.data}(t).length)}(h,e,u);i[n]={buffer:o,numComponents:f,type:a,normalize:l,stride:h.stride||0,offset:h.offset||0,divisor:void 0===h.divisor?void 0:h.divisor,drawType:h.drawType}}}var r})),t.bindBuffer(Ct,null),i}const Wt=["position","positions","a_position"];function jt(t){return!!t.texStorage2D}const Qt=33984,Vt=34962,qt=5124,Yt=3553,Jt=34067,Zt=32879,Xt=35866,ts={};function ss(t,s){return ts[s].bindPoint}function is(t,s){return function(i){t.uniform1i(s,i)}}function es(t,s){return function(i){t.uniform1iv(s,i)}}function rs(t,s){return function(i){t.uniform2iv(s,i)}}function hs(t,s){return function(i){t.uniform3iv(s,i)}}function ns(t,s){return function(i){t.uniform4iv(s,i)}}function os(t,s,i,e){const r=ss(0,s);return jt(t)?function(s){let h,n;!s||Et(0,s)?(h=s,n=null):(h=s.texture,n=s.sampler),t.uniform1i(e,i),t.activeTexture(Qt+i),t.bindTexture(r,h),t.bindSampler(i,n)}:function(s){t.uniform1i(e,i),t.activeTexture(Qt+i),t.bindTexture(r,s)}}function as(t,s,i,e,r){const h=ss(0,s),n=new Int32Array(r);for(let t=0;t<r;++t)n[t]=i+t;return jt(t)?function(s){t.uniform1iv(e,n),s.forEach((function(s,e){let r,o;t.activeTexture(Qt+n[e]),!s||Et(0,s)?(r=s,o=null):(r=s.texture,o=s.sampler),t.bindSampler(i,o),t.bindTexture(h,r)}))}:function(s){t.uniform1iv(e,n),s.forEach((function(s,i){t.activeTexture(Qt+n[i]),t.bindTexture(h,s)}))}}function us(t,s){return function(i){if(i.value)switch(t.disableVertexAttribArray(s),i.value.length){case 4:t.vertexAttrib4fv(s,i.value);break;case 3:t.vertexAttrib3fv(s,i.value);break;case 2:t.vertexAttrib2fv(s,i.value);break;case 1:t.vertexAttrib1fv(s,i.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(Vt,i.buffer),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,i.numComponents||i.size,i.type||5126,i.normalize||!1,i.stride||0,i.offset||0),t.vertexAttribDivisor&&t.vertexAttribDivisor(s,i.divisor||0)}}function cs(t,s){return function(i){if(i.value){if(t.disableVertexAttribArray(s),4!==i.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(s,i.value)}else t.bindBuffer(Vt,i.buffer),t.enableVertexAttribArray(s),t.vertexAttribIPointer(s,i.numComponents||i.size,i.type||qt,i.stride||0,i.offset||0),t.vertexAttribDivisor&&t.vertexAttribDivisor(s,i.divisor||0)}}function ls(t,s){return function(i){if(i.value){if(t.disableVertexAttribArray(s),4!==i.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(s,i.value)}else t.bindBuffer(Vt,i.buffer),t.enableVertexAttribArray(s),t.vertexAttribIPointer(s,i.numComponents||i.size,i.type||5125,i.stride||0,i.offset||0),t.vertexAttribDivisor&&t.vertexAttribDivisor(s,i.divisor||0)}}function fs(t,s,i){const e=i.size,r=i.count;return function(i){t.bindBuffer(Vt,i.buffer);const h=i.size||i.numComponents||e,n=h/r,o=i.type||5126,a=ts[o].size*h,u=i.normalize||!1,c=i.offset||0,l=a/r;for(let e=0;e<r;++e)t.enableVertexAttribArray(s+e),t.vertexAttribPointer(s+e,n,o,u,a,c+l*e),t.vertexAttribDivisor&&t.vertexAttribDivisor(s+e,i.divisor||0)}}ts[5126]={Type:Float32Array,size:4,setter:(t,s)=>function(i){t.uniform1f(s,i)},arraySetter:(t,s)=>function(i){t.uniform1fv(s,i)}},ts[35664]={Type:Float32Array,size:8,setter:(t,s)=>function(i){t.uniform2fv(s,i)},cols:2},ts[35665]={Type:Float32Array,size:12,setter:(t,s)=>function(i){t.uniform3fv(s,i)},cols:3},ts[35666]={Type:Float32Array,size:16,setter:(t,s)=>function(i){t.uniform4fv(s,i)},cols:4},ts[qt]={Type:Int32Array,size:4,setter:is,arraySetter:es},ts[35667]={Type:Int32Array,size:8,setter:rs,cols:2},ts[35668]={Type:Int32Array,size:12,setter:hs,cols:3},ts[35669]={Type:Int32Array,size:16,setter:ns,cols:4},ts[5125]={Type:Uint32Array,size:4,setter:(t,s)=>function(i){t.uniform1ui(s,i)},arraySetter:(t,s)=>function(i){t.uniform1uiv(s,i)}},ts[36294]={Type:Uint32Array,size:8,setter:(t,s)=>function(i){t.uniform2uiv(s,i)},cols:2},ts[36295]={Type:Uint32Array,size:12,setter:(t,s)=>function(i){t.uniform3uiv(s,i)},cols:3},ts[36296]={Type:Uint32Array,size:16,setter:(t,s)=>function(i){t.uniform4uiv(s,i)},cols:4},ts[35670]={Type:Uint32Array,size:4,setter:is,arraySetter:es},ts[35671]={Type:Uint32Array,size:8,setter:rs,cols:2},ts[35672]={Type:Uint32Array,size:12,setter:hs,cols:3},ts[35673]={Type:Uint32Array,size:16,setter:ns,cols:4},ts[35674]={Type:Float32Array,size:32,setter:(t,s)=>function(i){t.uniformMatrix2fv(s,!1,i)},rows:2,cols:2},ts[35675]={Type:Float32Array,size:48,setter:(t,s)=>function(i){t.uniformMatrix3fv(s,!1,i)},rows:3,cols:3},ts[35676]={Type:Float32Array,size:64,setter:(t,s)=>function(i){t.uniformMatrix4fv(s,!1,i)},rows:4,cols:4},ts[35685]={Type:Float32Array,size:32,setter:(t,s)=>function(i){t.uniformMatrix2x3fv(s,!1,i)},rows:2,cols:3},ts[35686]={Type:Float32Array,size:32,setter:(t,s)=>function(i){t.uniformMatrix2x4fv(s,!1,i)},rows:2,cols:4},ts[35687]={Type:Float32Array,size:48,setter:(t,s)=>function(i){t.uniformMatrix3x2fv(s,!1,i)},rows:3,cols:2},ts[35688]={Type:Float32Array,size:48,setter:(t,s)=>function(i){t.uniformMatrix3x4fv(s,!1,i)},rows:3,cols:4},ts[35689]={Type:Float32Array,size:64,setter:(t,s)=>function(i){t.uniformMatrix4x2fv(s,!1,i)},rows:4,cols:2},ts[35690]={Type:Float32Array,size:64,setter:(t,s)=>function(i){t.uniformMatrix4x3fv(s,!1,i)},rows:4,cols:3},ts[35678]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Yt},ts[35680]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Jt},ts[35679]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Zt},ts[35682]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Yt},ts[36289]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Xt},ts[36292]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Xt},ts[36293]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Jt},ts[36298]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Yt},ts[36299]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Zt},ts[36300]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Jt},ts[36303]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Xt},ts[36306]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Yt},ts[36307]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Zt},ts[36308]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Jt},ts[36311]={Type:null,size:0,setter:os,arraySetter:as,bindPoint:Xt};const ds={};function ys(t){const s=t.name;return s.startsWith("gl_")||s.startsWith("webgl_")}ds[5126]={size:4,setter:us},ds[35664]={size:8,setter:us},ds[35665]={size:12,setter:us},ds[35666]={size:16,setter:us},ds[qt]={size:4,setter:cs},ds[35667]={size:8,setter:cs},ds[35668]={size:12,setter:cs},ds[35669]={size:16,setter:cs},ds[5125]={size:4,setter:ls},ds[36294]={size:8,setter:ls},ds[36295]={size:12,setter:ls},ds[36296]={size:16,setter:ls},ds[35670]={size:4,setter:cs},ds[35671]={size:8,setter:cs},ds[35672]={size:12,setter:cs},ds[35673]={size:16,setter:cs},ds[35674]={size:4,setter:fs,count:2},ds[35675]={size:9,setter:fs,count:3},ds[35676]={size:16,setter:fs,count:4};const ps=/(\.|\[|]|\w+)/g,ms=t=>t>="0"&&t<="9";function ws(t,s,i,e){const r=t.split(ps).filter((t=>""!==t));let h=0,n="";for(;;){const t=r[h++];n+=t;const o=ms(t[0]),a=o?parseInt(t):t;if(o&&(n+=r[h++]),h===r.length){i[a]=s;break}{const t=r[h++],s="["===t,o=i[a]||(s?[]:{});i[a]=o,i=o,e[n]=e[n]||function(t){return function(s){gs(t,s)}}(o),n+=t}}}function gs(t,s){for(const i in s){const e=t[i];"function"==typeof e?e(s[i]):gs(t[i],s[i])}}function As(t,...s){const i=t.uniformSetters||t,e=s.length;for(let t=0;t<e;++t){const e=s[t];if(Array.isArray(e)){const t=e.length;for(let s=0;s<t;++s)As(i,e[s])}else for(const t in e){const s=i[t];s&&s(e[t])}}}class WebglCanvas{static isSupported(){if(!f)return!1;let t=document.createElement("canvas"),s=t.getContext("2d");const i=null!==s;return t=null,s=null,i}constructor(t,s=640,i=480,e={}){this.supportedStereoscopeModes=[mt.None,mt.Dual],this.stereoscopeMode=mt.None,this.stereoscopeStrength=0,this.paletteBuffer=new Uint32Array(16),this.textureTypes=new Map,this.textureSizes=new Map,this.frameBufferTextures=new Map,this.applyFirefoxFix=!1,this.refs={programs:[],shaders:[],textures:[],buffers:[],frameBuffers:[]},this.isCtxLost=!1,this.handleContextLoss=t=>{this.destroy(),t&&t.preventDefault(),this.isCtxLost||this.options.onlost(),this.isCtxLost=!0},this.handleContextRestored=t=>{this.isCtxLost=!1,this.init(),this.options.onrestored()},d(),this.options={...WebglCanvas.defaultOptions,...e},this.width=s,this.height=i,this.canvas=document.createElement("canvas"),this.canvas.addEventListener("webglcontextlost",this.handleContextLoss,!1),this.canvas.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--webgl",this.gl=this.canvas.getContext("webgl",{antialias:!1,alpha:!0}),t&&t.appendChild(this.canvas),this.init()}init(){this.setCanvasSize(this.width,this.height);const t=this.gl;if(this.checkContextLoss())return;this.layerProgram=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_uv;uniform bool u_flipY;uniform vec2 u_textureSize;uniform int u_3d_eye;uniform float u_3d_depth;uniform float u_3d_strength;void main(){vec4 pos=position;float depthDirection=u_3d_eye==0 ?-1.0 : 1.0;float depthShift=floor(u_3d_depth*u_3d_strength)/(u_textureSize.x/2.0)*depthDirection;pos.x+=depthShift;pos.y*=u_flipY ?-1.0 : 1.0;v_uv=texcoord;gl_Position=pos;}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;uniform int u_3d_mode;void main(){vec4 col=texture2D(u_tex,v_uv);if(col.a==0.0){discard;}gl_FragColor=col;}"),this.upscaleProgram=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,1,1),this.setBuffersAndAttribs(this.layerProgram,this.quadBuffer),this.layerTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameBuffer=this.createFramebuffer(this.frameTexture);const s=t.getExtension("WEBGL_debug_renderer_info"),i=t.getParameter(s.UNMASKED_RENDERER_WEBGL),e=navigator.userAgent,r=e.includes("Firefox")&&e.includes("Mac");this.applyFirefoxFix=r&&i.includes("Apple M")}createProgram(t,s){if(this.checkContextLoss())return;const i=this.gl,e=this.createShader(i.VERTEX_SHADER,t),r=this.createShader(i.FRAGMENT_SHADER,s),h=i.createProgram();if(i.attachShader(h,e),i.attachShader(h,r),i.linkProgram(h),!i.getProgramParameter(h,i.LINK_STATUS)){const t=i.getProgramInfoLog(h);throw i.deleteProgram(h),new Error(t)}const n=function(t,s){const i=function(t,s){let i=0;function e(s,e,r){const h=e.name.endsWith("[0]"),n=e.type,o=ts[n];if(!o)throw new Error(`unknown type: 0x${n.toString(16)}`);let a;if(o.bindPoint){const s=i;i+=e.size,a=h?o.arraySetter(t,n,s,r,e.size):o.setter(t,n,s,r,e.size)}else a=o.arraySetter&&h?o.arraySetter(t,r):o.setter(t,r);return a.location=r,a}const r={},h={},n=t.getProgramParameter(s,35718);for(let i=0;i<n;++i){const n=t.getActiveUniform(s,i);if(ys(n))continue;let o=n.name;o.endsWith("[0]")&&(o=o.substr(0,o.length-3));const a=t.getUniformLocation(s,n.name);if(a){const t=e(0,n,a);r[o]=t,ws(o,t,h,r)}}return r}(t,s),e=function(t,s){const i={},e=t.getProgramParameter(s,35721);for(let r=0;r<e;++r){const e=t.getActiveAttrib(s,r);if(ys(e))continue;const h=t.getAttribLocation(s,e.name),n=ds[e.type],o=n.setter(t,h,n);o.location=h,i[e.name]=o}return i}(t,s),r={program:s,uniformSetters:i,attribSetters:e};return jt(t)&&(r.uniformBlockSpec=function(t,s){const i=t.getProgramParameter(s,35718),e=[],r=[];for(let h=0;h<i;++h){r.push(h),e.push({});const i=t.getActiveUniform(s,h);e[h].name=i.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(i){const h=i[0],n=i[1];t.getActiveUniforms(s,r,t[h]).forEach((function(t,s){e[s][n]=t}))}));const h={},n=t.getProgramParameter(s,35382);for(let i=0;i<n;++i){const e=t.getActiveUniformBlockName(s,i),r={index:t.getUniformBlockIndex(s,e),usedByVertexShader:t.getActiveUniformBlockParameter(s,i,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(s,i,35398),size:t.getActiveUniformBlockParameter(s,i,35392),uniformIndices:t.getActiveUniformBlockParameter(s,i,35395)};r.used=r.usedByVertexShader||r.usedByFragmentShader,h[e]=r}return{blockSpecs:h,uniformData:e}}(t,s),r.transformFeedbackInfo=function(t,s){const i={},e=t.getProgramParameter(s,35971);for(let r=0;r<e;++r){const e=t.getTransformFeedbackVarying(s,r);i[e.name]={index:r,type:e.type,size:e.size}}return i}(t,s)),r}(i,h);return this.refs.programs.push(h),n}createShader(t,s){if(this.checkContextLoss())return;const i=this.gl,e=i.createShader(t);if(i.shaderSource(e,s),i.compileShader(e),!i.getShaderParameter(e,i.COMPILE_STATUS)){const t=i.getShaderInfoLog(e);throw i.deleteShader(e),new Error(t)}return this.refs.shaders.push(e),e}createScreenQuad(t,s,i,e,r,h){if(this.checkContextLoss())return;const n=(r+1)*(h+1),o=r+1,a=new Float32Array(2*n),u=new Float32Array(2*n);let c=0,l=0;for(let n=0;n<=h;n++)for(let o=0;o<=r;o++){const f=o/r,d=n/h;a[c++]=t+i*f,a[c++]=s+e*d,u[l++]=f,u[l++]=d}const f=new Uint16Array(r*h*2*3);let d=0;for(let t=0;t<h;t++)for(let s=0;s<r;s++)f[d++]=(t+0)*o+s,f[d++]=(t+1)*o+s,f[d++]=(t+0)*o+s+1,f[d++]=(t+0)*o+s+1,f[d++]=(t+1)*o+s,f[d++]=(t+1)*o+s+1;const y=function(t,s,i){const e=Ot(t,s),r=Object.assign({},{});r.attribs=Object.assign({},{},e);const h=s.indices;if(h){const s=Nt(h,"indices");r.indices=Kt(t,s,34963),r.numElements=s.length,r.elementType=zt(s)}else r.numElements||(r.numElements=function(t,s){let i,e;for(e=0;e<Wt.length&&(i=Wt[e],!(i in s))&&(i=Bt+i,!(i in s));++e);e===Wt.length&&(i=Object.keys(s)[0]);const r=s[i];if(!r.buffer)return 1;t.bindBuffer(Ct,r.buffer);const h=t.getBufferParameter(Ct,34660);var n;t.bindBuffer(Ct,null);const o=h/(5120===(n=r.type)||5121===n?1:5122===n||5123===n?2:5124===n||5125===n||n===Mt?4:0),a=r.numComponents||r.size,u=o/a;if(u%1!=0)throw new Error(`numComponents ${a} not correct for length ${length}`);return u}(t,r.attribs));return r}(this.gl,{position:{numComponents:2,data:a},texcoord:{numComponents:2,data:u},indices:f});for(let t in y.attribs)this.refs.buffers.push(y.attribs[t].buffer);return y}setBuffersAndAttribs(t,s){var i,e,r;this.checkContextLoss()||(i=this.gl,e=t.attribSetters,(r=s).vertexArrayObject?i.bindVertexArray(r.vertexArrayObject):(function(t,s){for(const i in s){const e=t[i];e&&e(s[i])}}(e.attribSetters||e,r.attribs),r.indices&&i.bindBuffer(34963,r.indices)))}createTexture(t,s,i,e=1,r=1){if(this.checkContextLoss())return;const h=this.gl,n=h.createTexture();return h.bindTexture(h.TEXTURE_2D,n),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,s),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,s),h.texImage2D(h.TEXTURE_2D,0,t,e,r,0,t,h.UNSIGNED_BYTE,null),this.refs.textures.push(n),this.textureTypes.set(n,t),this.textureSizes.set(n,{width:e,height:r}),n}resizeTexture(t,s,i){if(this.checkContextLoss())return;const e=this.gl,r=this.textureTypes.get(t);e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,r,s,i,0,r,e.UNSIGNED_BYTE,null),this.textureSizes.set(t,{width:s,height:i})}createFramebuffer(t){if(this.checkContextLoss())return;const s=this.gl,i=s.createFramebuffer();return s.bindFramebuffer(s.FRAMEBUFFER,i),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,t,0),this.refs.frameBuffers.push(i),this.frameBufferTextures.set(i,t),i}useFramebuffer(t,s,i,e,r){if(this.checkContextLoss())return;const h=this.gl;if(null===t){if(h.bindFramebuffer(h.FRAMEBUFFER,null),this.applyFirefoxFix){const t=this.srcWidth,n=this.srcHeight,o=h.drawingBufferWidth/t,a=h.drawingBufferHeight/n,u=256===t?1:0;s=-((e=h.drawingBufferWidth*(o-u))-t*o),i=-((r=h.drawingBufferHeight*(a-u))-n*a)}h.viewport(s??0,i??0,e??h.drawingBufferWidth,r??h.drawingBufferHeight)}else{const n=this.frameBufferTextures.get(t),{width:o,height:a}=this.textureSizes.get(n);h.bindFramebuffer(h.FRAMEBUFFER,t),h.viewport(s??0,i??0,e??o,r??a)}}resizeFramebuffer(t,s,i){if(this.checkContextLoss())return;const e=this.frameBufferTextures.get(t);this.resizeTexture(e,s,i)}setCanvasSize(t,s){const i=this.options.useDpi&&window.devicePixelRatio||1,e=t*i,r=s*i;this.width=t,this.height=s,this.canvas.width=e,this.canvas.height=r,this.dstWidth=e,this.dstHeight=r,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${s}px`,this.checkContextLoss()}setNote(t){if(this.checkContextLoss())return;const s=t.imageWidth,i=t.imageHeight;this.note=t,this.srcWidth=s,this.srcHeight=i,this.resizeFramebuffer(this.frameBuffer,s,i),this.resizeTexture(this.layerTexture,s,i),this.layerTexturePixelBuffer=new Uint32Array(s*i),this.layerTexturePixels=new Uint8Array(this.layerTexturePixelBuffer.buffer),this.frameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(this.checkContextLoss())return;const s=this.gl,i=t??this.note.getFramePalette(this.frameIndex)[0],[e,r,h,n]=i;s.clearColor(e/255,r/255,h/255,n/255),s.clear(s.COLOR_BUFFER_BIT)}drawFrame(t){if(this.checkContextLoss())return;const s=this.gl,i=this.stereoscopeMode,e=this.stereoscopeStrength;this.frameIndex=t,i===mt.None?(this.drawLayers(t),this.useFramebuffer(null),this.upscale(s.drawingBufferWidth,s.drawingBufferHeight)):i===mt.Dual&&(this.drawLayers(t,e,r.Left),this.useFramebuffer(null,0,0,s.drawingBufferWidth/2,s.drawingBufferHeight),this.upscale(s.drawingBufferWidth/2,s.drawingBufferHeight),this.drawLayers(t,e,r.Right),this.useFramebuffer(null,s.drawingBufferWidth/2,0,s.drawingBufferWidth/2,s.drawingBufferHeight),this.upscale(s.drawingBufferWidth/2,s.drawingBufferHeight))}upscale(t,s){if(this.checkContextLoss())return;const i=this.gl;i.useProgram(this.upscaleProgram.program),As(this.upscaleProgram,{u_tex:this.frameTexture,u_textureSize:[this.srcWidth,this.srcHeight],u_screenSize:[t,s]}),i.drawElements(i.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}requestStereoScopeMode(t){this.supportedStereoscopeModes.includes(t)?this.stereoscopeMode=t:this.stereoscopeMode=mt.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}isErrorState(){const t=this.gl;return null===t||t.getError()!==t.NO_ERROR}drawLayers(t,s=0,i=r.Left,e=!0){const h=this.gl,n=this.note,o=this.srcWidth,a=this.srcHeight,u=n.numLayers,c=n.getFrameLayerOrder(t),l=n.getFrameLayerDepths(t);this.useFramebuffer(this.frameBuffer),e&&this.clear(),h.useProgram(this.layerProgram.program);for(let e=0;e<u;e++){const r=c[e];n.getLayerPixelsRgba(t,r,this.layerTexturePixelBuffer,this.paletteBuffer),As(this.layerProgram,{u_flipY:!0,u_tex:this.layerTexture,u_textureSize:[o,a],u_3d_mode:this.stereoscopeMode,u_3d_eye:i,u_3d_depth:l[r],u_3d_strength:s}),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,o,a,0,h.RGBA,h.UNSIGNED_BYTE,this.layerTexturePixels),h.drawElements(h.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}}checkContextLoss(){const t=this.isCtxLost||this.isErrorState();return t&&this.handleContextLoss(),t}getDataUrl(t,s){return this.canvas.toDataURL(t,s)}async getBlob(t,s){return new Promise(((i,e)=>this.canvas.toBlob(i,t,s)))}destroy(){const t=this.refs,s=this.gl,i=this.canvas;t.shaders.forEach((t=>{s.deleteShader(t)})),t.shaders=[],t.textures.forEach((t=>{s.deleteTexture(t)})),t.textures=[],t.buffers.forEach((t=>{s.deleteBuffer(t)})),t.buffers=[],t.frameBuffers.forEach((t=>{s.deleteFramebuffer(t)})),t.frameBuffers=[],t.programs.forEach((t=>{s.deleteProgram(t)})),t.programs=[],this.paletteBuffer=null,this.layerTexturePixelBuffer=null,this.layerTexturePixels=null,this.textureTypes.clear(),this.textureSizes.clear(),this.frameBufferTextures.clear(),i&&i.parentElement&&(i.width=1,i.height=1,i.parentNode.removeChild(i))}}WebglCanvas.defaultOptions={onlost(){},onrestored(){},useDpi:!0};class Html5Canvas{static isSupported(){if(!f)return!1;let t=document.createElement("canvas"),s=t.getContext("2d");const i=null!==s;return t=null,s=null,i}constructor(t,s,i,e={}){this.supportedStereoscopeModes=[mt.None],this.stereoscopeMode=mt.None,this.stereoscopeStrength=0,this.paletteBuffer=new Uint32Array(16),d(),this.options={...Html5Canvas.defaultOptions,...e},this.width=s,this.height=i,this.canvas=document.createElement("canvas"),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--html5",this.ctx=this.canvas.getContext("2d"),this.srcCanvas=document.createElement("canvas"),this.srcCtx=this.srcCanvas.getContext("2d"),a(null!==this.ctx&&null!==this.srcCtx,"Could not create HTML5 canvas"),t&&t.appendChild(this.canvas),this.setCanvasSize(s,i)}setCanvasSize(t,s){const i=this.canvas,e=this.options.useDpi&&window.devicePixelRatio||1,r=t*e,h=s*e;this.width=t,this.height=s,this.dstWidth=r,this.dstHeight=h,i.style.width=`${t}px`,i.style.height=`${s}px`,i.width=r,i.height=h}setNote(t){const s=t.imageWidth,i=t.imageHeight;this.note=t,this.srcWidth=s,this.srcHeight=i,this.srcCanvas.width=s,this.srcCanvas.height=i,this.frameImage=this.srcCtx.createImageData(s,i),this.frameBuffer=new Uint32Array(this.frameImage.data.buffer),this.frameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(this.frameBuffer.fill(0),this.ctx.clearRect(0,0,this.dstWidth,this.dstHeight),t){const[s,i,e,r]=t;this.ctx.fillStyle=`rgba(${s}, ${i}, ${e}, ${r})`,this.ctx.fillRect(0,0,this.dstWidth,this.dstHeight)}}drawFrame(t){this.clear(),this.options.useSmoothing||(this.ctx.imageSmoothingEnabled=!1),this.note.getFramePixelsRgba(t,this.frameBuffer,this.paletteBuffer),this.srcCtx.putImageData(this.frameImage,0,0),this.ctx.drawImage(this.srcCanvas,0,0,this.srcWidth,this.srcHeight,0,0,this.dstWidth,this.dstHeight),this.frameIndex=t}requestStereoScopeMode(t){this.supportedStereoscopeModes.includes(t)?this.stereoscopeMode=t:this.stereoscopeMode=mt.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}getDataUrl(t,s){return this.canvas.toDataURL(t,s)}async getBlob(t,s){return new Promise(((i,e)=>this.canvas.toBlob(i,t,s)))}destroy(){this.frameImage=null,this.paletteBuffer=null,this.frameBuffer=null,this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null,this.srcCanvas.width=1,this.srcCanvas.height=1,this.srcCanvas=null}}Html5Canvas.defaultOptions={useDpi:!0,useSmoothing:!0};class UniversalCanvas{constructor(t,s=640,i=480,e={}){this.isReady=!1,this.isHtml5=!1,this.supportedStereoscopeModes=[],this.stereoscopeMode=mt.None,this.stereoscopeStrength=1,this.rendererStack=[WebglCanvas,Html5Canvas],this.rendererStackIdx=0,this.options={},this.width=s,this.height=i,this.parent=t,this.options=e,this.setSubRenderer(this.rendererStack[0])}setSubRenderer(t){let s=!1;const i=new t(this.parent,this.width,this.height,{...this.options,onlost:()=>{s=!0,this.fallbackIfPossible()}});s||(this.note&&(i.setNote(this.note),i.frameIndex=this.renderer?.frameIndex,i.forceUpdate()),this.renderer&&this.renderer.destroy(),this.isHtml5=i instanceof Html5Canvas,this.isReady=!0,this.renderer=i,this.rendererStackIdx=this.rendererStack.indexOf(t),this.supportedStereoscopeModes=i.supportedStereoscopeModes,i.stereoscopeStrength=this.stereoscopeStrength,this.requestStereoScopeMode(this.stereoscopeMode))}fallbackIfPossible(){if(this.rendererStackIdx>=this.rendererStack.length)throw new Error("No renderer to fall back to");this.rendererStackIdx+=1,this.setSubRenderer(this.rendererStack[this.rendererStackIdx])}switchToHtml5(){this.setSubRenderer(Html5Canvas)}setCanvasSize(t,s){const i=this.renderer;i.setCanvasSize(t,s),this.width=t,this.width=s,this.dstWidth=i.dstWidth,this.dstHeight=i.dstHeight}setNote(t){this.note=t,this.renderer.setNote(t),this.frameIndex=void 0,this.srcWidth=this.renderer.srcWidth,this.srcHeight=this.renderer.srcHeight}clear(t){this.renderer.clear(t)}drawFrame(t){this.renderer.drawFrame(t),this.frameIndex=t}forceUpdate(){this.renderer.forceUpdate()}requestStereoScopeMode(t){this.renderer.requestStereoScopeMode(t),this.stereoscopeMode=this.renderer.stereoscopeMode}getDataUrl(t,s){return this.renderer.getDataUrl()}async getBlob(t,s){return this.renderer.getBlob()}destroy(){this.renderer.destroy(),this.note=null}}const Ps=f?window.AudioContext||window.webkitAudioContext:null;class WebAudioPlayer{constructor(){this.useEq=!1,this.useAnalyser=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this.i=1,this.h=!1,this.o=0,this.u=0,this.nodeRefs=[],d()}set volume(t){this.setVolume(t)}get volume(){return this.i}set loop(t){this.h=t,this.source&&(this.source.loop=t)}get loop(){return this.h}getCtx(){return this.ctx||(this.ctx=new Ps),this.ctx}setBuffer(t,s){const i=this.getCtx(),e=t.length,r=i.createBuffer(1,e,s),h=r.getChannelData(0);if(t instanceof Float32Array)h.set(t,0);else if(t instanceof Int16Array)for(let s=0;s<e;s++)h[s]=t[s]/32768;this.buffer=r,this.sampleRate=s}connectEqNodesTo(t){const s=this.getCtx(),i=this.eqSettings;let e=t;return i.forEach((([t,r],h)=>{const n=s.createBiquadFilter();this.nodeRefs.push(n),n.frequency.value=t,n.gain.value=r,0===h?n.type="lowshelf":h===i.length-1?n.type="highshelf":n.type="peaking",e.connect(n),e=n})),e}initNodes(){const t=this.getCtx();this.nodeRefs=[];const s=t.createBufferSource();this.nodeRefs.push(s),s.buffer=this.buffer;const i=t.createGain();if(this.nodeRefs.push(i),this.useEq?this.connectEqNodesTo(s).connect(i):s.connect(i),this.useAnalyser){const s=t.createAnalyser();this.nodeRefs.push(s),this.analyser=s,i.connect(s),s.connect(t.destination)}else this.analyser=void 0,i.connect(t.destination);this.source=s,this.gainNode=i,this.setVolume(this.i)}setAnalyserEnabled(t){this.useAnalyser=t,this.initNodes()}setVolume(t){this.i=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))}playFrom(t){this.initNodes(),this.o=t,this.u=this.ctx.currentTime,this.source.loop=this.h,this.source.start(0,t)}stop(){this.source&&this.source.stop(0)}getCurrentTime(){return this.o+(this.ctx.currentTime-this.u)}async destroy(){this.stop();const t=this.getCtx();this.nodeRefs.forEach((t=>t.disconnect())),this.nodeRefs=[],this.analyser=void 0,"closed"!==t.state&&"function"==typeof t.close&&await t.close(),this.buffer=null}}class Player{constructor(s,i,e,r={}){this.duration=0,this.autoplay=!1,this.supportedEvents=ft,this.l=null,this.h=!1,this.i=1,this.p=!1,this.m=null,this.A=!1,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=s=>{if(!this.isPlaying)return;const i=s/1e3,e=this.duration,r=this.audio.getCurrentTime();let h=i-this.playbackStartTime;if(Math.abs(h%e-r%e)>.01&&(h=r),h>=e){if(!this.loop)return this.pause(),this.A=!0,void this.emit(t.PlayerEvent.Ended);this.playbackStartTime=i,this.emit(t.PlayerEvent.Loop)}this.setCurrentTime(h%e),this.playbackLoopId=requestAnimationFrame(this.playbackLoop)},d();const h="string"==typeof s?document.querySelector(s):s;this.parserSettings=r,this.renderer=new UniversalCanvas(h,i,e,{onlost:()=>this.emit(t.PlayerEvent.Error),onrestored:()=>this.reload()}),this.audio=new WebAudioPlayer,this.el=h}get src(){return this.l}set src(t){throw new Error("Setting a Player source has been deprecated, please use the load() method instead")}get paused(){return!this.isPlaying}set paused(t){t?this.pause():this.play()}get currentFrame(){return this.m}set currentFrame(t){this.setCurrentFrame(t)}get currentTime(){return this.isNoteLoaded?this.playbackTime:null}set currentTime(t){this.setCurrentTime(t)}get progress(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null}set progress(t){this.setProgress(t)}get volume(){return this.getVolume()}set volume(t){this.setVolume(t)}get muted(){return this.getMuted()}set muted(t){this.setMuted(t)}get loop(){return this.getLoop()}set loop(t){this.setLoop(t)}get framerate(){return this.note.framerate}get frameCount(){return this.note.frameCount}get frameSpeed(){return this.note.frameSpeed}get buffered(){return dt([[0,this.duration]])}get seekable(){return dt([[0,this.duration]])}get currentSrc(){return this.l}get videoWidth(){return this.isNoteLoaded?this.note.imageWidth:0}get videoHeight(){return this.isNoteLoaded?this.note.imageHeight:0}async load(s){if(this.isNoteLoaded&&this.closeNote(),this.l=s,!s)return this.openNote(this.note);this.emit(t.PlayerEvent.LoadStart);const[i,e]=await(async t=>{try{return[null,await t().catch((t=>{throw t}))]}catch(t){return[t,null]}})((()=>ct(s,this.parserSettings)));if(i)throw this.emit(t.PlayerEvent.Error,i),new Error(`Error loading Flipnote: ${i.message}`);this.openNote(e)}async reload(){if(this.note)return await this.load(this.note.buffer)}async updateSettings(t){return this.parserSettings=t,await this.reload()}closeNote(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this.l=null,this.m=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clear()}openNote(s){this.isNoteLoaded&&this.closeNote(),this.note=s,this.meta=s.meta,this.emit(t.PlayerEvent.LoadedMeta),this.noteFormat=s.format,this.duration=s.duration,this.playbackTime=0,this.m=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=s.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(s.getAudioMasterPcm(),s.sampleRate),this.emit(t.PlayerEvent.CanPlay),this.emit(t.PlayerEvent.CanPlayThrough),this.setLoop(s.meta.loop),this.renderer.setNote(s),this.drawFrame(s.thumbFrameIndex),this.emit(t.PlayerEvent.LoadedData),this.emit(t.PlayerEvent.Load),this.emit(t.PlayerEvent.Ready),this.autoplay&&this.play()}setCurrentTime(s){this.assertNoteLoaded();const i=Math.floor(s/(1/this.framerate));this.setCurrentFrame(i),this.playbackTime=s,this.emit(t.PlayerEvent.Progress,this.progress)}getCurrentTime(){return this.currentTime}getTimeCounter(){return`${pt(Math.max(this.currentTime,0))} / ${pt(this.duration)}`}getFrameCounter(){return`${yt(this.currentFrame+1,3)} / ${yt(this.frameCount,3)}`}setProgress(t){this.assertNoteLoaded(),u(t,0,100,"progress"),this.currentTime=this.duration*(t/100)}getProgress(){return this.progress}async play(){if(this.assertNoteLoaded(),this.isPlaying)return;this.A&&(this.playbackTime=0,this.A=!1);const s=performance.now();this.playbackStartTime=s/1e3-this.playbackTime,this.isPlaying=!0,this.hasPlaybackStarted=!0,this.playAudio(),this.playbackLoop(s),this.emit(t.PlayerEvent.Play)}pause(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(t.PlayerEvent.Pause))}togglePlay(){this.isPlaying?this.pause():this.play()}getPaused(){return!this.isPlaying}getDuration(){return this.duration}getLoop(){return this.h}setLoop(t){this.h=t,this.audio.loop=t}toggleLoop(){this.setLoop(!this.h)}setCurrentFrame(s){this.assertNoteLoaded();const i=Math.max(0,Math.min(Math.floor(s),this.frameCount-1));(i!==this.currentFrame||this.showThumbnail)&&(this.m=i,this.drawFrame(i),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=i*(1/this.framerate),this.emit(t.PlayerEvent.SeekEnd)),this.emit(t.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(t.PlayerEvent.Progress,this.progress),this.emit(t.PlayerEvent.TimeUpdate,this.currentFrame))}nextFrame(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(t.PlayerEvent.FrameNext)}prevFrame(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(t.PlayerEvent.FramePrev)}lastFrame(){this.currentFrame=this.frameCount-1,this.emit(t.PlayerEvent.FrameLast)}firstFrame(){this.currentFrame=0,this.emit(t.PlayerEvent.FrameFirst)}thumbnailFrame(){this.currentFrame=this.note.thumbFrameIndex}startSeek(){this.isSeeking||(this.emit(t.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)}seek(t){this.isSeeking&&(this.progress=100*t)}endSeek(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1}drawFrame(t){this.renderer.drawFrame(t)}forceUpdate(){this.renderer.forceUpdate()}resize(t,s){s!==.75*t&&console.warn(`Canvas width to height ratio should be 3:4 for best results (got ${t}x${s})`),this.renderer.setCanvasSize(t,s),this.forceUpdate()}setLayerVisibility(t,s){this.note.layerVisibility[t]=s,this.layerVisibility[t]=s,this.forceUpdate()}getLayerVisibility(t){return this.layerVisibility[t]}toggleLayerVisibility(t){this.setLayerVisibility(t,!this.layerVisibility[t])}playAudio(){this.audio.playFrom(this.currentTime)}stopAudio(){this.audio.stop()}toggleAudioEq(){this.setAudioEq(!this.audio.useEq)}setAudioEq(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())}mute(){this.setMuted(!0)}unmute(){this.setMuted(!1)}setMuted(s){this.audio.volume=s?0:this.i,this.p=s,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getMuted(){return 0===this.volume||this.p}toggleMuted(){this.setMuted(!this.p)}setVolume(s){u(s,0,1,"volume"),this.i=s,this.audio.volume=s,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getVolume(){return this.p?0:this.i}seekToNextFrame(){this.nextFrame()}fastSeek(t){this.currentTime=t}canPlayType(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";default:return""}}getVideoPlaybackQuality(){return{creationTime:0,droppedVideoFrames:0,corruptedVideoFrames:0,totalVideoFrames:this.frameCount}}requestPictureInPicture(){throw new Error("Not implemented")}captureStream(){throw new Error("Not implemented")}on(t,s){const i=this.events;(Array.isArray(t)?t:[t]).forEach((t=>{i.has(t)?i.get(t).push(s):i.set(t,[s])}))}off(t,s){const i=this.events;(Array.isArray(t)?t:[t]).forEach((t=>{if(!i.has(t))return;const e=i.get(t);i.set(t,e.splice(e.indexOf(s),1))}))}emit(s,...i){const e=this.events;if(s!==t.PlayerEvent.t&&e.has(s)){e.get(s).forEach((t=>t.apply(null,i)));const t=`on${s}`,r=this;"function"==typeof r[t]&&r[t].apply(null,i)}e.has(t.PlayerEvent.t)&&e.get(t.PlayerEvent.t).forEach((t=>t.apply(null,[s,...i])))}clearEvents(){this.events.clear()}async destroy(){this.clearEvents(),this.emit(t.PlayerEvent.Destroy),this.closeNote(),await this.renderer.destroy(),await this.audio.destroy()}supports(t){const s=this.supportedEvents.includes(t),i="function"==typeof this[t];return s||i}assertNoteLoaded(){a(this.isNoteLoaded,"No Flipnote is currently loaded in this player")}}class EncoderBase{constructor(){this.dataUrl=null}getBuffer(){return a(y,"This feature is only available in NodeJS environments"),Buffer.from(this.getArrayBuffer())}getBlob(){return d(),new Blob([this.getArrayBuffer()],{type:this.mimeType})}getUrl(){return d(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())}revokeUrl(){d(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)}}const vs=5003,Fs=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];class LzwCompressor{constructor(t,s,i){this.accum=new Uint8Array(256),this.htab=new Int32Array(vs),this.codetab=new Int32Array(vs),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=s,this.colorDepth=i,this.reset()}reset(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}char_out(t,s){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(s)}cl_block(t){this.cl_hash(vs),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)}cl_hash(t){for(var s=0;s<t;++s)this.htab[s]=-1}compress(t,s){var i,e,r,h,n,o,a;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,h=this.nextPixel(),a=0,i=vs;i<65536;i*=2)++a;a=8-a,o=vs,this.cl_hash(o),this.output(this.ClearCode,s);t:for(;-1!=(e=this.nextPixel());)if(i=(e<<12)+h,r=e<<a^h,this.htab[r]!==i){if(this.htab[r]>=0){n=o-r,0===r&&(n=1);do{if((r-=n)<0&&(r+=o),this.htab[r]===i){h=this.codetab[r];continue t}}while(this.htab[r]>=0)}this.output(h,s),h=e,this.free_ent<4096?(this.codetab[r]=this.free_ent++,this.htab[r]=i):this.cl_block(s)}else h=this.codetab[r];this.output(h,s),this.output(this.EOFCode,s)}encode(t,s){this.pixels=t,s.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,s),s.writeByte(0)}flush_char(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)}get_maxcode(t){return(1<<t)-1}nextPixel(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}output(t,s){for(this.cur_accum&=Fs[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,s),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,s),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(s)}}}class GifImage extends EncoderBase{constructor(t,s,i={}){super(),this.mimeType="gif/image",this.frameCount=0,this.width=t,this.height=s,this.data=new ByteArray,this.settings={...GifImage.defaultSettings,...i},this.compressor=new LzwCompressor(t,s,i.colorDepth)}static fromFlipnote(t,s={}){const i=new GifImage(t.imageWidth,t.imageHeight,{delay:100/t.framerate,repeat:t.meta?.loop?-1:0,...s});i.palette=t.globalPalette;for(let s=0;s<t.frameCount;s++)i.writeFrame(t.getFramePixels(s));return i.finish(),i}static fromFlipnoteFrame(t,s,i={}){const e=new GifImage(t.imageWidth,t.imageHeight,{delay:0,repeat:0,...i});return e.palette=t.globalPalette,e.writeFrame(t.getFramePixels(s)),e.finish(),e}writeFrame(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1}finish(){this.data.writeByte(59)}writeFirstFrame(t){this.writeHeader(),this.writeLogicalScreenDescriptor(),this.writeColorTable(),this.writeNetscapeExt(),this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)}writeAdditionalFrame(t){this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)}writeHeader(){this.data.writeChars("GIF89a")}writeGraphicControlExt(){this.data.writeByte(33),this.data.writeByte(249),this.data.writeByte(4),this.data.writeByte(0),this.data.writeU16(this.settings.delay),this.data.writeByte(0),this.data.writeByte(0)}writeLogicalScreenDescriptor(){const t=this.palette,s=128|this.settings.colorDepth-1<<4|this.colorTableSize(t.length)-1;this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeBytes([s,0,0])}writeNetscapeExt(){this.data.writeByte(33),this.data.writeByte(255),this.data.writeByte(11),this.data.writeChars("NETSCAPE2.0"),this.data.writeByte(3),this.data.writeByte(1),this.data.writeU16(this.settings.repeat),this.data.writeByte(0)}writeColorTable(){const t=this.palette,s=1<<this.colorTableSize(t.length);for(let i=0;i<s;i++){let s=[0,0,0];i<t.length&&(s=t[i]),this.data.writeByte(s[0]),this.data.writeByte(s[1]),this.data.writeByte(s[2])}}writeImageDescriptor(){this.data.writeByte(44),this.data.writeU16(0),this.data.writeU16(0),this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeByte(0)}colorTableSize(t){return Math.max(Math.ceil(Math.log2(t)),1)}writePixels(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)}getArrayBuffer(){return this.data.getBuffer()}getImage(){d();const t=new Image(this.width,this.height);return t.src=this.getUrl(),t}}GifImage.defaultSettings={delay:100,repeat:-1,colorDepth:8};class WavAudio extends EncoderBase{constructor(t,s=1,i=16){super(),this.sampleRate=t,this.channels=s,this.bitsPerSample=i;const e=new ArrayBuffer(44),r=new DataStream(e);r.writeChars("RIFF"),r.writeUint32(0),r.writeChars("WAVE"),r.writeChars("fmt "),r.writeUint32(16),r.writeUint16(1),r.writeUint16(this.channels),r.writeUint32(this.sampleRate),r.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample),r.writeChars("data"),r.writeUint32(0),this.header=r,this.pcmData=null}static fromFlipnote(t){const s=t.sampleRate,i=new WavAudio(s,1,16),e=t.getAudioMasterPcm(s);return i.writeSamples(e),i}static fromFlipnoteTrack(t,s){const i=t.sampleRate,e=new WavAudio(i,1,16),r=t.getAudioTrackPcm(s,i);return e.writeSamples(r),e}writeSamples(t){let s=this.header;s.seek(4),s.writeUint32(s.byteLength+t.byteLength),s.seek(40),s.writeUint32(t.byteLength),this.pcmData=t}getArrayBuffer(){const t=this.header.bytes,s=new Uint8Array(this.pcmData.buffer),i=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return i.set(t),i.set(s,t.byteLength),i.buffer}}const bs=t=>A(t)?`${t.slice(14,16)}-${t.slice(12,14)}${t.slice(10,12)}-${t.slice(8,10)}${t.slice(6,8)}-${t.slice(4,6)}${t.slice(2,4)}${t.slice(0,2)}`.toLocaleLowerCase():null,Ss=t=>R(t)?`${t.slice(19,21)}${t.slice(17,19)}${t.slice(15,17)}${t.slice(12,14)}${t.slice(10,12)}${t.slice(7,9)}${t.slice(5,7)}${t.slice(2,4)}`.toUpperCase():null;var zs=Object.freeze({__proto__:null,getFsidRegion:s=>A(s)?P(s):H(s)?G(s):t.FlipnoteRegion.UNKNOWN,getKwzFsidRegion:G,getPpmFsidRegion:P,isFsid:t=>A(t)||H(t),isKwzDsiLibraryFsid:R,isKwzFsid:H,isPpmFsid:A,kwzFsidMatchesPpmFsid:(t,s)=>Ss(t)===s,kwzFsidToPpmFsid:Ss,ppmFsidToKwzFsidSuffix:bs,ppmFsidToPossibleKwzFsids(t){const s=bs(t);return s?["00"+s,"10"+s,"12"+s,"14"+s]:null}});t.CanvasInterface=class{constructor(t,s,i,e){}},t.GifImage=GifImage,t.Html5Canvas=Html5Canvas,t.KwzParser=KwzParser,t.Player=Player,t.PlayerMixin=function(t){class PlayerMixinClass extends t{get renderer(){return this.player.renderer}get audio(){return this.player.audio}get canvasEl(){return this.player.canvasEl}get note(){return this.player.note}get noteFormat(){return this.player.noteFormat}get meta(){return this.player.meta}get duration(){return this.player.duration}get layerVisibility(){return this.player.layerVisibility}get autoplay(){return this.player.autoplay}set autoplay(t){this.player.autoplay=t}}for(let s of Reflect.ownKeys(Player.prototype)){let i=Object.getOwnPropertyDescriptor(Player.prototype,s);s in t.prototype||"constructor"===s||"name"===s||"prototype"===s||(i.value&&"function"==typeof i.value?Object.defineProperty(PlayerMixinClass.prototype,s,{...i,value(...t){return this.player[s](...t)}}):(i.get||i.set)&&Object.defineProperty(PlayerMixinClass.prototype,s,{...i,set(t){this.player[s]=t},get(){return this.player[s]}}))}return PlayerMixinClass},t.PpmParser=PpmParser,t.UniversalCanvas=UniversalCanvas,t.WavAudio=WavAudio,t.WebAudioPlayer=WebAudioPlayer,t.WebglCanvas=WebglCanvas,t.id=zs,t.loaders=at,t.parse=ut,t.parseSource=ct,t.version="6.0.1"}({});
//# sourceMappingURL=flipnote.min.js.map
