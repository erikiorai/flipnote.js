/*!
 * flipnote.js v2.7.0
 * Browser-based playback of .ppm and .kwz animations from Flipnote Studio and Flipnote Studio 3D
 * 2018 James Daniel
 * github.com/jaames/flipnote.js
 * Flipnote Studio is (c) Nintendo Co., Ltd.
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.flipnote=t():e.flipnote=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,i),a.l=!0,a.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)i.d(r,a,function(t){return e[t]}.bind(null,a));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=7)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}();var a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.buffer=t,this._data=new DataView(t),this._offset=0}return r(e,[{key:"seek",value:function(e,t){switch(t){case 2:this._offset=this._data.byteLength+e;break;case 1:this._offset+=e;break;case 0:default:this._offset=e}}},{key:"readUint8",value:function(){var e=this._data.getUint8(this._offset);return this._offset+=1,e}},{key:"writeUint8",value:function(e){this._data.setUint8(this._offset,e),this._offset+=1}},{key:"readInt8",value:function(){var e=this._data.getInt8(this._offset);return this._offset+=1,e}},{key:"writeInt8",value:function(e){this._data.setInt8(this._offset,e),this._offset+=1}},{key:"readUint16",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this._data.getUint16(this._offset,e);return this._offset+=2,t}},{key:"writeUint16",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._data.setUint16(this._offset,e,t),this._offset+=2}},{key:"readInt16",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this._data.getInt16(this._offset,e);return this._offset+=2,t}},{key:"writeInt16",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._data.setInt16(this._offset,e,t),this._offset+=2}},{key:"readUint32",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this._data.getUint32(this._offset,e);return this._offset+=4,t}},{key:"writeUint32",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._data.setUint32(this._offset,e,t),this._offset+=4}},{key:"readInt32",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this._data.getInt32(this._offset,e);return this._offset+=4,t}},{key:"writeInt32",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._data.setInt32(this._offset,e,t),this._offset+=4}},{key:"readBytes",value:function(e){var t=new Uint8Array(this._data.buffer,this._offset,e);return this._offset+=t.byteLength,t}},{key:"writeBytes",value:function(e){var t=this;e.forEach(function(e){return t.writeUint8(e)})}},{key:"readHex",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.readBytes(e),r=[],a=0;a<i.length;a++)r.push(i[a].toString(16).padStart(2,"0"));return t&&r.reverse(),r.join("").toUpperCase()}},{key:"readUtf8",value:function(e){for(var t=this.readBytes(e),i="",r=0;r<t.length;r++){var a=t[r];if(0==a)break;i+=String.fromCharCode(a)}return i}},{key:"writeUtf8",value:function(e){for(var t=0;t<e.length;t++){var i=e.charCodeAt(t);this.writeUint8(i)}}},{key:"readUtf16",value:function(e){var t=new Uint16Array(this._data.buffer,this._offset,e);this._offset+=t.byteLength;for(var i="",r=0;r<t.length;r++){var a=t[r];if(0==a)break;i+=String.fromCharCode(a)}return i}},{key:"bytes",get:function(){return new Uint8Array(this.buffer)}},{key:"byteLength",get:function(){return this._data.byteLength}}]),e}();t.default=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dataStream=t.wavEncoder=t.gifEncoder=t.bitmapEncoder=t.kwzParser=t.ppmParser=t.parser=t.default=void 0;var r=l(i(8)),a=l(i(2)),n=l(i(3)),s=l(i(5)),o=l(i(17)),u=l(i(6)),h=l(i(18)),f=l(i(0));function l(e){return e&&e.__esModule?e:{default:e}}var c={version:"2.7.0",player:r.default,parser:a.default,ppmParser:n.default,kwzParser:s.default};t.default=c,t.parser=a.default,t.ppmParser=n.default,t.kwzParser=s.default,t.bitmapEncoder=o.default,t.gifEncoder=h.default,t.wavEncoder=u.default,t.dataStream=f.default},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=new DataView(e,0,4).getUint32(0);if(1346458177==t)return new r.default(e);if(1262897152==(4294967040&t))return new a.default(e);return null};var r=n(i(3)),a=n(i(5));function n(e){return e&&e.__esModule?e:{default:e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=function(e){return e&&e.__esModule?e:{default:e}}(i(0)),n=i(4);var s={1:.5,2:1,3:2,4:4,5:6,6:12,7:20,8:30},o=256,u=192,h={WHITE:[255,255,255],BLACK:[14,14,14],RED:[255,42,42],BLUE:[10,57,255]},f=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.type="PPM",i._decodeHeader(),i._decodeAnimationHeader(),i._decodeSoundHeader(),i._decodeMeta(),i.sampleRate=8192,i.palette=h,i._layers=[new Uint8Array(o*u),new Uint8Array(o*u)],i._prevLayers=[new Uint8Array(o*u),new Uint8Array(o*u)],i._prevDecodedFrame=null,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),r(t,[{key:"readFilename",value:function(){return[this.readHex(3),this.readUtf8(13),this.readUint16().toString().padStart(3,"0")].join("_")}},{key:"readLineEncoding",value:function(){for(var e=new Uint8Array(u),t=0;t<48;t++)for(var i=this.readUint8(),r=0;r<8;r+=2)e[4*t+r/2]=i>>r&3;return e}},{key:"_decodeHeader",value:function(){this.seek(0);this.readUint32();this._frameDataLength=this.readUint32(),this._soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()}},{key:"_decodeMeta",value:function(){this.seek(16);var e=this.readUint16(),t=this.readInt16(),i=this.readUtf16(11),r=this.readUtf16(11),a=this.readUtf16(11),n=this.readHex(8,!0),s=this.readHex(8,!0),o=this.readFilename(),u=this.readFilename(),h=this.readHex(8,!0);this.seek(154);var f=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var l=this.readUint16();this.thumbFrameIndex=t,this.meta={lock:e,loop:l>>1&1,frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:t,timestamp:f,spinoff:s!==n||s!==h,root:{filename:null,username:i,fsid:h},parent:{username:r,fsid:n,filename:o},current:{username:a,fsid:s,filename:u}}}},{key:"_decodeAnimationHeader",value:function(){var e=this;this.seek(1696);var t=this.readUint16();this.seek(1704),this._frameOffsets=new Uint32Array(t/4).map(function(i){return 1704+t+e.readUint32()})}},{key:"_decodeSoundHeader",value:function(){var e=1696+this._frameDataLength+this.frameCount;e%2!=0&&(e+=4-e%4),this.seek(e);var t=this.readUint32(),i=this.readUint32(),r=this.readUint32(),a=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),e+=32,this.framerate=s[this.frameSpeed],this.bgmrate=s[this.bgmSpeed],this.soundMeta={bgm:{offset:e,length:t},se1:{offset:e+=t,length:i},se2:{offset:e+=i,length:r},se3:{offset:e+=r,length:a}}}},{key:"isNewFrame",value:function(e){return this.seek(this._frameOffsets[e]),this.readUint8()>>7&1}},{key:"getFramePalette",value:function(e){this.seek(this._frameOffsets[e]);var t=this.palette,i=this.readUint8(),r=1&i,a=[t.BLACK,1==r?t.BLACK:t.WHITE,t.RED,t.BLUE];return[1==r?t.WHITE:t.BLACK,a[i>>1&3],a[i>>3&3]]}},{key:"decodeFrame",value:function(e){0===e||this._prevDecodedFrame===e-1||this.isNewFrame(e)||this.decodeFrame(e-1),this.seek(this._frameOffsets[e]);var t=this.readUint8(),i=t>>7&1,r=t>>5&3,a=0,n=0;this._prevLayers[0].set(this._layers[0]),this._prevLayers[1].set(this._layers[1]),this._prevDecodedFrame=e,this._layers[0].fill(0),this._layers[1].fill(0),r&&(a=this.readInt8(),n=this.readInt8());for(var s=[this.readLineEncoding(),this.readLineEncoding()],h=0;h<2;h++)for(var f=this._layers[h],l=0;l<u;l++){var c=l*o,d=s[h][l];switch(d){case 0:break;case 1:case 2:var v=this.readUint32(!1);for(2==d&&f.fill(255,c,c+o);4294967295&v;){if(2147483648&v)for(var y=this.readUint8(),m=0;m<8;m++)f[c+m]=y>>m&1?255:0;c+=8,v<<=1}break;case 3:for(;c<(l+1)*o;){for(y=this.readUint8(),m=0;m<8;m++)f[c+m]=y>>m&1?255:0;c+=8}}}if(!i)for(var p,_,g=0;g<u;g++)if(!(g-n<0)){if(g-n>=u)break;for(var b=0;b<o;b++)if(!(b-a<0)){if(b-a>=o)break;_=(p=b+g*o)-(a+n*o),this._layers[0][p]^=this._prevLayers[0][_],this._layers[1][p]^=this._prevLayers[1][_]}}return this._layers}},{key:"getLayerPixels",value:function(e,t){this._prevDecodedFrame!==e&&this.decodeFrame(e);for(var i=this._layers[t],r=new Uint8Array(49152),a=t+1,n=0;n<r.length;n++)0!==i[n]&&(r[n]=a);return r}},{key:"getFramePixels",value:function(e){var i=void 0;arguments.length>1&&void 0!==arguments[1]&&arguments[1]?i=this.getFramePalette(e).map(function(e){return t.globalPalette.indexOf(e)}):i=[0,1,2];var r=this.decodeFrame(e),a=new Uint8Array(49152);a.fill(i[0]);for(var n=0;n<a.length;n++){var s=r[0][n];r[1][n]&&(a[n]=i[2]),s&&(a[n]=i[1])}return a}},{key:"hasAudioTrack",value:function(e){var t=["bgm","se1","se2","se3"][e];return this.soundMeta[t].length>0}},{key:"decodeAudio",value:function(e){for(var t,i,r,a=this.soundMeta[e],s=new Uint8Array(this.buffer,a.offset,a.length),o=new Int16Array(2*s.length),u=0,h=0,f=0,l=0;l<s.length;l++)for(var c=s[l],d=0;d<8;)t=c>>d&15,i=h+n.ADPCM_SAMPLE_TABLE_4[t+16*f],r=f+n.ADPCM_INDEX_TABLE_4[t],r=Math.max(0,Math.min(r,79)),i=Math.max(-32767,Math.min(i,32767)),o[u]=i,u+=1,f=r,h=i,d+=4;return o}},{key:"decodeSoundFlags",value:function(){var e=this;return this.seek(1696+this._frameDataLength),new Array(this.frameCount).fill([]).map(function(t){var i=e.readUint8();return[1&i,i>>1&1,i>>2&1]})}}],[{key:"validateFSID",value:function(e){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(e)}},{key:"validateFilename",value:function(e){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(e)}}]),t}();t.default=f,f.width=o,f.height=u,f.globalPalette=[h.BLACK,h.WHITE,h.RED,h.BLUE]},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ADPCM_INDEX_TABLE_2=new Int8Array([-1,2,-1,2]),t.ADPCM_INDEX_TABLE_4=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]);for(var r=t.ADPCM_STEP_TABLE=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),a=t.ADPCM_SAMPLE_TABLE_2=new Int16Array(360),n=0;n<4;n++)for(var s=0;s<90;s++){var o=r[s],u=o>>3;1&n&&(u+=o),2&n&&(u=-u),a[n+4*s]=u}for(var h=t.ADPCM_SAMPLE_TABLE_4=new Int16Array(1440),f=0;f<16;f++)for(var l=0;l<90;l++){var c=r[l],d=c>>3;4&f&&(d+=c),2&f&&(d+=c>>1),1&f&&(d+=c>>2),8&f&&(d=-d),h[f+16*l]=d}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=function(e){return e&&e.__esModule?e:{default:e}}(i(0)),n=i(4);for(var s=[.2,.5,1,2,4,6,8,12,20,24,30],o={WHITE:[255,255,255],BLACK:[16,16,16],RED:[255,16,16],YELLOW:[255,231,0],GREEN:[0,134,49],BLUE:[0,56,206],NONE:[255,255,255]},u=["WHITE","BLACK","RED","YELLOW","GREEN","BLUE","NONE"],h=new Uint16Array([0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740]),f=new Uint16Array([0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100]),l=new Uint16Array(6561),c=[0,3,7,1,4,8,2,5,6],d=0,v=0;v<9;v++)for(var y=0;y<9;y++)for(var m=0;m<9;m++)for(var p=0;p<9;p++)l[d]=9*(9*(9*c[v]+c[y])+c[m])+c[p],d++;for(var _=new Uint16Array(52488),g=(c=[0,65280,255],0),b=0;b<3;b++)for(var w=0;w<3;w++)for(var k=0;k<3;k++)for(var U=0;U<3;U++)for(var E=0;E<3;E++)for(var A=0;A<3;A++)for(var P=0;P<3;P++)for(var F=0;F<3;F++)_.set([c[w],c[b],c[U],c[k],c[A],c[E],c[F],c[P]],g),g+=8;var T=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.type="KWZ",i._layers=[new Uint16Array(76800),new Uint16Array(76800),new Uint16Array(76800)],i._bitIndex=0,i._bitValue=0,i.load(),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),r(t,[{key:"load",value:function(){this.seek(0),this.sections={};for(var e=this.byteLength-256,t=0,i=0;t<e&&i<6;){this.seek(t);var r=this.readUtf8(4).substring(0,3),a=this.readUint32();this.sections[r]={offset:t,length:a},t+=a+8,i+=1}this._decodeMeta(),this._decodeFrameMeta(),this._decodeSoundHeader(),this.sampleRate=16364,this.palette=o,this._prevDecodedFrame=null}},{key:"readBits",value:function(e){if(this._bitIndex+e>16){var t=this.readUint16();this._bitValue|=t<<16-this._bitIndex,this._bitIndex-=16}var i=(1<<e)-1,r=this._bitValue&i;return this._bitValue>>=e,this._bitIndex+=e,r}},{key:"_decodeMeta",value:function(){this.seek(this.sections.KFH.offset+12);var e=new Date(1e3*(this.readUint32()+946684800)),t=new Date(1e3*(this.readUint32()+946684800)),i=(this.readUint32(),this.readHex(10)),r=this.readHex(10),a=this.readHex(10),n=this.readUtf16(11),o=this.readUtf16(11),u=this.readUtf16(11),h=this.readUtf8(28),f=this.readUtf8(28),l=this.readUtf8(28),c=this.readUint16(),d=this.readUint16(),v=this.readUint16(),y=this.readUint8();this.readUint8();this.frameCount=c,this.thumbFrameIndex=d,this.frameSpeed=y,this.framerate=s[y],this.meta={lock:1&v,loop:v>>1&1,frame_count:c,frame_speed:y,thumb_index:d,timestamp:t,creation_timestamp:e,root:{username:n,fsid:i,filename:h},parent:{username:o,fsid:r,filename:f},current:{username:u,fsid:a,filename:l}}}},{key:"_decodeFrameMeta",value:function(){this.frameMeta=[],this.frameOffsets=[],this.seek(this.sections.KMI.offset+8),g=this.sections.KMC.offset+12;for(var e=0;e<this.frameCount;e++){var t={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readHex(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(t),this.frameOffsets.push(g),g+=t.layerSize[0]+t.layerSize[1]+t.layerSize[2]}}},{key:"_decodeSoundHeader",value:function(){var e=this.sections.KSN.offset+8;this.seek(e);var t=this.readUint32();this.bgmSpeed=t,this.bgmrate=s[t];var i=new Uint32Array(this.buffer,e+4,20);this.soundMeta={bgm:{offset:e+=28,length:i[0]},se1:{offset:e+=i[0],length:i[1]},se2:{offset:e+=i[1],length:i[2]},se3:{offset:e+=i[2],length:i[3]},se4:{offset:e+=i[3],length:i[4]}}}},{key:"getDiffingFlag",value:function(e){return 7&~(this.frameMeta[e].flags>>4)}},{key:"getLayerDepths",value:function(e){return this.frameMeta[e].layerDepth}},{key:"getLayerOrder",value:function(e){var t=this.getLayerDepths(e);return[2,1,0].sort(function(e,i){return t[i]-t[e]})}},{key:"decodeFrame",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];i&&(t&=this.getDiffingFlag(e+1)),0!==e&&this._prevDecodedFrame!==e-1&&t&&this.decodeFrame(e-1,t=t,i=!0);for(var r=this.frameMeta[e],a=this.frameOffsets[e],n=0;n<3;n++){this.seek(a);var s=r.layerSize[n];if(a+=s,38!==s&&!(t>>n&!1)){this._bitIndex=16,this._bitValue=0;for(var o=0,u=0;u<240;u+=128)for(var c=0;c<320;c+=128)for(var d=0;d<128;d+=8){var v=u+d;if(v>=240)break;for(var y=0;y<128;y+=8){var m=c+y;if(m>=320)break;if(o)o-=1;else{var p=320*v+m,g=this._layers[n],b=this.readBits(3);if(0==b){var w=h[this.readBits(5)],k=_.subarray(8*w,8*w+8);g.set(k,p),g.set(k,p+320),g.set(k,p+640),g.set(k,p+960),g.set(k,p+1280),g.set(k,p+1600),g.set(k,p+1920),g.set(k,p+2240)}else if(1==b){var U=this.readBits(13),E=_.subarray(8*U,8*U+8);g.set(E,p),g.set(E,p+320),g.set(E,p+640),g.set(E,p+960),g.set(E,p+1280),g.set(E,p+1600),g.set(E,p+1920),g.set(E,p+2240)}else if(2==b){var A=this.readBits(5),P=h[A],F=f[A],T=_.subarray(8*P,8*P+8),x=_.subarray(8*F,8*F+8);g.set(T,p),g.set(x,p+320),g.set(T,p+640),g.set(x,p+960),g.set(T,p+1280),g.set(x,p+1600),g.set(T,p+1920),g.set(x,p+2240)}else if(3==b){var C=this.readBits(13),L=l[C],M=_.subarray(8*C,8*C+8),S=_.subarray(8*L,8*L+8);g.set(M,p),g.set(S,p+320),g.set(M,p+640),g.set(S,p+960),g.set(M,p+1280),g.set(S,p+1600),g.set(M,p+1920),g.set(S,p+2240)}else if(4==b)for(var O=this.readBits(8),B=0;B<8;B++){var I=0;I=O&1<<B?h[this.readBits(5)]:this.readBits(13);var D=_.subarray(8*I,8*I+8);g.set(D,p+320*B)}else{if(5==b){o=this.readBits(5);continue}if(7==b){var R=this.readBits(2),H=0,j=0;this.readBits(1)?(H=h[this.readBits(5)],j=h[this.readBits(5)],R=(R+1)%4):(H=this.readBits(13),j=this.readBits(13));var N=_.subarray(8*H,8*H+8),W=_.subarray(8*j,8*j+8);0==R?(g.set(N,p),g.set(W,p+320),g.set(N,p+640),g.set(W,p+960),g.set(N,p+1280),g.set(W,p+1600),g.set(N,p+1920),g.set(W,p+2240)):1==R?(g.set(N,p),g.set(N,p+320),g.set(W,p+640),g.set(N,p+960),g.set(N,p+1280),g.set(W,p+1600),g.set(N,p+1920),g.set(N,p+2240)):2==R?(g.set(N,p),g.set(W,p+320),g.set(N,p+640),g.set(N,p+960),g.set(W,p+1280),g.set(N,p+1600),g.set(N,p+1920),g.set(W,p+2240)):3==R&&(g.set(N,p),g.set(W,p+320),g.set(W,p+640),g.set(N,p+960),g.set(W,p+1280),g.set(W,p+1600),g.set(N,p+1920),g.set(W,p+2240))}}}}}}}return this._prevDecodedFrame=e,[new Uint8Array(this._layers[0].buffer),new Uint8Array(this._layers[1].buffer),new Uint8Array(this._layers[2].buffer)]}},{key:"getFramePalette",value:function(e){var t=this.frameMeta[e].flags;return[this.palette[u[15&t]],this.palette[u[t>>8&15]],this.palette[u[t>>12&15]],this.palette[u[t>>16&15]],this.palette[u[t>>20&15]],this.palette[u[t>>24&15]],this.palette[u[t>>28&15]]]}},{key:"getLayerPixels",value:function(e,t){this._prevDecodedFrame!==e&&this.decodeFrame(e);for(var i=this._layers[t],r=new Uint8Array(76800),a=2*t+1,n=0;n<i.length;n++){var s=i[n];65280&s?r[n]=a:255&s&&(r[n]=a+1)}return r}},{key:"getFramePixels",value:function(e){var i=this,r=void 0;if(arguments.length>1&&void 0!==arguments[1]&&arguments[1]){var a=this.getFramePalette(e);r=a.map(function(e){return t.globalPalette.indexOf(e)})}else r=[0,1,2,3,4,5,6];var n=new Uint8Array(76800);return n.fill(r[0]),this.getLayerOrder(e).forEach(function(t){for(var a=i.getLayerPixels(e,t),s=0;s<a.length;s++){var o=a[s];0!==o&&(n[s]=r[o])}}),n}},{key:"decodeSoundFlags",value:function(){return this.frameMeta.map(function(e){var t=e.soundFlags;return[1&t,t>>1&1,t>>2&1,t>>3&1]})}},{key:"hasAudioTrack",value:function(e){var t=["bgm","se1","se2","se3","se4"][e];return this.soundMeta[t].length>0}},{key:"decodeAudio",value:function(e){for(var t,i,r,a=this.soundMeta[e],s=new Int16Array(981840),o=0,u=new Uint8Array(this.buffer,a.offset,a.length),h=0,f=40,l=0;l<u.length;l++)for(var c=u[l],d=0;d<8;)f<18||6==d?(t=c>>d&3,i=h+n.ADPCM_SAMPLE_TABLE_2[t+4*f],r=f+n.ADPCM_INDEX_TABLE_2[t],d+=2):(t=c>>d&15,i=h+n.ADPCM_SAMPLE_TABLE_4[t+16*f],r=f+n.ADPCM_INDEX_TABLE_4[t],d+=4),r=Math.max(0,Math.min(r,79)),i=Math.max(-2048,Math.min(i,2048)),s[o]=16*i,o+=1,f=r,h=i;return s.slice(0,o)}}]),t}();t.default=T,T.width=320,T.height=240,T.globalPalette=[o.BLACK,o.WHITE,o.RED,o.YELLOW,o.GREEN,o.BLUE,o.NONE]},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=function(e){return e&&e.__esModule?e:{default:e}}(i(0));var n=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.sampleRate=t,this.channels=i,this.bitsPerSample=r;var n=new ArrayBuffer(44),s=new a.default(n);s.writeUtf8("RIFF"),s.writeUint32(0),s.writeUtf8("WAVE"),s.writeUtf8("fmt "),s.writeUint32(16),s.writeUint16(1),s.writeUint16(this.channels),s.writeUint32(this.sampleRate),s.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),s.writeUint16(this.bitsPerSample*this.channels/8),s.writeUint16(this.bitsPerSample),s.writeUtf8("data"),s.writeUint32(0),this.header=s,this.pcmData=null}return r(e,[{key:"writeFrames",value:function(e){var t=this.header;t.seek(4),t.writeUint32(t.byteLength+e.byteLength),t.seek(40),t.writeUint32(e.byteLength),this.pcmData=e}},{key:"getBlob",value:function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})}}]),e}();t.default=n},function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=u(i(9)),n=u(i(2)),s=u(i(12)),o=u(i(16));function u(e){return e&&e.__esModule?e:{default:e}}var h=function(){function e(t,i,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t="string"==typeof t?document.querySelector(t):t,this.canvas=new a.default(t,i,r),this._imgCanvas=new a.default(document.createElement("canvas"),i,r,{antialias:!0,preserveDrawingBuffer:!0}),this._isOpen=!1,this._events={},this.loop=!1,this.currentFrame=0,this.paused=!0,this.customPalette=null,this.audioTracks=[new o.default("se1"),new o.default("se2"),new o.default("se3"),new o.default("se4"),new o.default("bgm")],this.smoothRendering=!1}return r(e,[{key:"_load",value:function(e){var t=new n.default(e);this.note=t,this.meta=t.meta,this.type=t.type,this.frameCount=t.frameCount,this.frameSpeed=t.frameSpeed,this.fileLength=t.byteLength,this.loop=1==t.meta.loop,this.paused=!0,this._isOpen=!0,this.audioTracks.forEach(function(e){e.sampleRate=t.sampleRate}),this.customPalette&&this.setPalette(this.customPalette),this.note.hasAudioTrack(1)&&this.audioTracks[0].set(this.note.decodeAudio("se1"),1),this.note.hasAudioTrack(2)&&this.audioTracks[1].set(this.note.decodeAudio("se2"),1),this.note.hasAudioTrack(3)&&this.audioTracks[2].set(this.note.decodeAudio("se3"),1),"KWZ"===this.type&&this.note.hasAudioTrack(4)&&this.audioTracks[3].set(this.note.decodeAudio("se4"),1),this.note.hasAudioTrack(0)&&this.audioTracks[4].set(this.note.decodeAudio("bgm"),this._audiorate),this._seFlags=this.note.decodeSoundFlags(),this._playbackLoop=null,this._hasPlaybackStarted=!1,this.layerVisiblity={1:!0,2:!0,3:!0},this.setMode(this.type),this.setFrame(this.note.thumbFrameIndex),this.emit("load")}},{key:"open",value:function(e){var t=this;return this._isOpen&&this.close(),(0,s.default)(e).then(function(e){t._load(e)}).catch(function(e){console.error("Error loading Flipnote:",e)})}},{key:"close",value:function(){this.pause(),this.note=null,this._isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.frameCount=null,this.frameSpeed=null,this._frame=0;for(var e=0;e<this.audioTracks.length;e++)this.audioTracks[e].unset();this._seFlags=null,this._hasPlaybackStarted=null,this.canvas.clear(),this._imgCanvas.clear()}},{key:"destroy",value:function(){this.close(),this.canvas.destroy(),this._imgCanvas.destroy()}},{key:"_playFrameSe",value:function(e){for(var t=this._seFlags[e],i=0;i<t.length;i++)t[i]&&this.audioTracks[i].active&&this.audioTracks[i].start()}},{key:"_playBgm",value:function(){this.audioTracks[4].start(this.currentTime)}},{key:"_stopAudio",value:function(){for(var e=0;e<this.audioTracks.length;e++)this.audioTracks[e].stop()}},{key:"play",value:function(){var e=this;if(!this._isOpen||!this.paused)return null;this.paused=!1,this._hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this._frame=0),this._playBgm(),this._playbackLoop=setInterval(function(){e.paused&&clearInterval(e._playbackLoop),e.currentFrame>=e.frameCount-1?(e._stopAudio(),e.loop?(e.firstFrame(),e._playBgm(0),e.emit("playback:loop")):(e.pause(),e.emit("playback:end"))):(e._playFrameSe(e.currentFrame),e.nextFrame())},1e3/this.framerate),this._hasPlaybackStarted=!0,this.emit("playback:start")}},{key:"pause",value:function(){if(!this._isOpen||this.paused)return null;clearInterval(this._playbackLoop),this.paused=!0,this._stopAudio(),this.emit("playback:stop")}},{key:"getFrameImage",value:function(e,t,i,r,a){if(!this._isOpen)return null;var n=this._imgCanvas;return n.width===t&&n.height===i||n.resize(t,i),e="thumb"==e?this.note.thumbFrameIndex:Math.max(0,Math.min(e,this.frameCount-1)),this.drawFrame(e,n),n.toImage(r,a)}},{key:"setPalette",value:function(e){this.customPalette=e,this.note.palette=e,this.forceUpdate()}},{key:"setFrame",value:function(e){if(!this._isOpen||e===this.currentFrame)return null;e=Math.max(0,Math.min(Math.floor(e),this.frameCount-1)),this._frame=e,this._playbackFrameTime=0,this.drawFrame(e,this.canvas),this.emit("frame:update",this.currentFrame)}},{key:"drawFrame",value:function(e,t){var i=this,r=this.note.getFramePalette(e),a=this.note.decodeFrame(e);t.setPaperColor(r[0]),t.clear(),"PPM"==this.note.type?(this.layerVisiblity[2]&&t.drawLayer(a[1],256,192,r[2],[0,0,0,0]),this.layerVisiblity[1]&&t.drawLayer(a[0],256,192,r[1],[0,0,0,0])):"KWZ"==this.note.type&&this.note.getLayerOrder(e).forEach(function(e){i.layerVisiblity[e+1]&&t.drawLayer(a[e],320,240,r[2*e+1],r[2*e+2])})}},{key:"thumbnailFrame",value:function(){this.currentFrame=this.note.thumbFrameIndex}},{key:"nextFrame",value:function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1}},{key:"prevFrame",value:function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1}},{key:"lastFrame",value:function(){this.currentFrame=this.frameCount-1}},{key:"firstFrame",value:function(){this.currentFrame=0}},{key:"resize",value:function(e,t){this.canvas.resize(e,t),this.forceUpdate()}},{key:"setLayerVisibility",value:function(e,t){this.layerVisiblity[e]=t,this.forceUpdate()}},{key:"setSmoothRendering",value:function(e){var t=e?"linear":"nearest";this.canvas.setFilter(t),this.forceUpdate(),this.smoothRendering=e}},{key:"setMode",value:function(e){this.canvas.setMode(e),this._imgCanvas.setMode(e)}},{key:"forceUpdate",value:function(){this._isOpen&&this.drawFrame(this.currentFrame,this.canvas)}},{key:"on",value:function(e,t){var i=this._events;(i[e]||(i[e]=[])).push(t)}},{key:"off",value:function(e,t){var i=this._events[e];i&&i.splice(i.indexOf(t),1)}},{key:"emit",value:function(e){for(var t=this._events[e]||[],i=arguments.length,r=Array(i>1?i-1:0),a=1;a<i;a++)r[a-1]=arguments[a];for(var n=0;n<t.length;n++)t[n].apply(null,r)}},{key:"currentFrame",get:function(){return this._frame},set:function(e){this.setFrame(e)}},{key:"currentTime",get:function(){return this._isOpen?this.currentFrame*(1/this.framerate):null},set:function(e){this._isOpen&&e<this.duration&&e>0&&this.setFrame(Math.round(e/(1/this.framerate)))}},{key:"volume",get:function(){return this.audioTracks[3].audio.volume},set:function(e){for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].audio.volume=e}},{key:"muted",get:function(){return this.audioTracks[3].audio.muted},set:function(e){for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].audio.muted=e}},{key:"duration",get:function(){return this._isOpen?this.frameCount*(1/this.framerate):null}},{key:"framerate",get:function(){return this.note.framerate}},{key:"_audiorate",get:function(){return 1/this.note.bgmrate/(1/this.note.framerate)}}]),e}();t.default=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=s(i(10)),n=s(i(11));function s(e){return e&&e.__esModule?e:{default:e}}var o=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:640,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:480,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{antialias:!1,alpha:!1};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.width=t.width=i,this.height=t.height=r;var o=t.getContext("webgl",s),u=o.createProgram();this.program=u,this.el=t,this.gl=o,this.refs={shaders:[],textures:[],buffers:[]};var h=this._createShader(o.VERTEX_SHADER,a.default),f=this._createShader(o.FRAGMENT_SHADER,n.default);if(o.attachShader(u,h),o.attachShader(u,f),o.linkProgram(u),!o.getProgramParameter(u,o.LINK_STATUS)){var l=o.getProgramInfoLog(u);throw o.deleteProgram(u),new Error(l)}o.useProgram(u);var c=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,c),o.bufferData(o.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),o.STATIC_DRAW),o.enableVertexAttribArray(0),o.vertexAttribPointer(0,2,o.FLOAT,!1,0,0),this.refs.buffers.push(c),o.activeTexture(o.TEXTURE0);var d=o.createTexture();o.bindTexture(o.TEXTURE_2D,d),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),this.uniforms={};for(var v=o.getProgramParameter(u,o.ACTIVE_UNIFORMS),y=0;y<v;y++){var m=o.getActiveUniform(u,y).name;this.uniforms[m]=o.getUniformLocation(u,m)}o.uniform1i(this.uniforms.u_bitmap,0),this.setFilter("linear"),this.setMode("PPM"),this.refs.textures.push(d),o.enable(o.BLEND),o.blendFunc(o.ONE,o.ONE_MINUS_SRC_ALPHA)}return r(e,[{key:"_createShader",value:function(e,t){var i=this.gl,r=i.createShader(e);if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){var a=i.getShaderInfoLog(r);throw i.deleteShader(r),new Error(a)}return this.refs.shaders.push(r),r}},{key:"toImage",value:function(e,t){return this.el.toDataURL(e,t)}},{key:"setFilter",value:function(e){var t=this.gl;e="linear"==e?t.LINEAR:t.NEAREST,t.uniform1i(this.uniforms.u_isSmooth,"linear"==e?0:1),t.activeTexture(t.TEXTURE0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e)}},{key:"setMode",value:function(e){var t=this.gl;"PPM"===e?this.textureType=t.ALPHA:"KWZ"===e&&(this.textureType=t.LUMINANCE_ALPHA)}},{key:"setColor",value:function(e,t){this.gl.uniform4f(this.uniforms[e],t[0]/255,t[1]/255,t[2]/255,1)}},{key:"setPaperColor",value:function(e){this.gl.clearColor(e[0]/255,e[1]/255,e[2]/255,1)}},{key:"drawLayer",value:function(e,t,i,r,a,n){var s=this.gl;s.activeTexture(s.TEXTURE0),s.texImage2D(s.TEXTURE_2D,0,this.textureType,t,i,0,this.textureType,s.UNSIGNED_BYTE,e),this.setColor("u_color1",r),this.setColor("u_color2",a),s.drawArrays(s.TRIANGLES,0,6)}},{key:"resize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:640,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:480;this.el.width=e,this.el.height=t,this.width=e,this.height=t,this.gl.viewport(0,0,e,t)}},{key:"clear",value:function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}},{key:"destroy",value:function(){var e=this.refs,t=this.gl;e.shaders.forEach(function(e){t.deleteShader(e)}),e.shaders=[],e.textures.forEach(function(e){t.deleteTexture(e)}),e.textures=[],e.buffers.forEach(function(e){t.deleteBuffer(e)}),e.buffers=[],t.deleteProgram(this.program),t.canvas.width=1,t.canvas.height=1}}]),e}();t.default=o},function(e,t){e.exports="#define GLSLIFY 1\nattribute vec4 a_position;\nvarying vec2 v_texcoord;\nvoid main() {\n  gl_Position = a_position;\n  v_texcoord = a_position.xy * vec2(0.5, -0.5) + 0.5;\n}"},function(e,t){e.exports="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texcoord;\nuniform vec4 u_color1;\nuniform vec4 u_color2;\nuniform sampler2D u_bitmap;\nuniform bool u_isSmooth;\nvoid main() {\n  float weightColor1 = texture2D(u_bitmap, v_texcoord).a;\n  float weightColor2 = texture2D(u_bitmap, v_texcoord).r;\n  float alpha = 1.0;\n  if (u_isSmooth) {\n    weightColor1 = smoothstep(0.0, .9, weightColor1);\n    weightColor2 = smoothstep(0.0, .9, weightColor2);\n    float alpha = weightColor1 + weightColor2;\n  }\n  gl_FragColor = vec4(u_color1.rgb, alpha) * weightColor1 + vec4(u_color2.rgb, alpha) * weightColor2;\n}\n"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return new Promise(function(t,i){for(var r=0;r<o.length;r++){var a=o[r];if(a.matches(e)){a.load(e,t,i);break}}})};var r=s(i(13)),a=s(i(14)),n=s(i(15));function s(e){return e&&e.__esModule?e:{default:e}}var o=[r.default,a.default,n.default]},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={matches:function(e){return"string"==typeof e},load:function(e,t,i){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onreadystatechange=function(e){4===r.readyState&&(r.status>=200&&r.status<300?t(r.response):i({type:"httpError",status:r.status,statusText:r.statusText}))},r.send(null)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={matches:function(e){return e instanceof File},load:function(e,t,i){var r=new FileReader;r.onload=function(e){t(e.target.result)},r.onerror=function(e){i({type:"fileReadError"})},r.readAsArrayBuffer(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={matches:function(e){return e instanceof ArrayBuffer},load:function(e,t,i){t(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=function(e){return e&&e.__esModule?e:{default:e}}(i(6));var n=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=t,this.channelCount=1,this.bitsPerSample=16,this.sampleRate=0,this.playbackRate=1,this.audio=document.createElement("audio"),this.audio.preload=!0,this.active=!1}return r(e,[{key:"set",value:function(e,t){var i=new a.default(this.sampleRate*t,this.channelCount,this.bitsPerSample);i.writeFrames(e),this.url=window.URL.createObjectURL(i.getBlob()),this.audio.src=this.url,this.active=!0,this.playbackRate=t,this.length=e.length}},{key:"unset",value:function(){this.active&&(window.URL.revokeObjectURL(this.url),this.audio.src="",this.audio.load(),this.active=!1,this.playbackRate=1,this.length=null)}},{key:"start",value:function(e){this.active&&(this.audio.currentTime=e||0,this.audio.play())}},{key:"stop",value:function(){this.active&&this.audio.pause()}},{key:"duration",get:function(){return this.audio.duration}}]),e}();t.default=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}();t.roundToNearest=n;var a=function(e){return e&&e.__esModule?e:{default:e}}(i(0));function n(e,t){return Math.ceil(e/t)*t}var s=function(){function e(t,i,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.width=t,this.height=i,this.vWidth=n(t,4),this.vHeight=n(i,4),this.bpp=r,this.fileHeader=new a.default(new ArrayBuffer(14)),this.fileHeader.writeUtf8("BM"),this.dibHeader=new a.default(new ArrayBuffer(108)),this.dibHeader.writeUint32(108),this.dibHeader.writeInt32(t),this.dibHeader.writeInt32(i),this.dibHeader.writeUint16(1),this.dibHeader.writeUint16(r),this.dibHeader.writeUint32(3),this.dibHeader.writeUint32(this.vWidth*this.height/(r/8)),this.dibHeader.writeUint32(3780),this.dibHeader.writeUint32(3780),this.dibHeader.writeUint32(0),this.dibHeader.writeUint32(0),this.dibHeader.writeUint32(16711680),this.dibHeader.writeUint32(65280),this.dibHeader.writeUint32(255),this.dibHeader.writeUint32(4278190080),this.dibHeader.writeUtf8("Win ")}return r(e,[{key:"setFilelength",value:function(e){this.fileHeader.seek(2),this.fileHeader.writeUint32(e)}},{key:"setPixelOffset",value:function(e){this.fileHeader.seek(10),this.fileHeader.writeUint32(e)}},{key:"setCompression",value:function(e){this.dibHeader.seek(16),this.dibHeader.writeUint32(e)}},{key:"setPaletteCount",value:function(e){this.dibHeader.seek(32),this.dibHeader.writeUint32(e)}},{key:"setPalette",value:function(e){for(var t=new Uint32Array(Math.pow(2,this.bpp)),i=0;i<e.length;i++){var r=e[i%e.length];t[i]=4278190080|r[0]<<16|r[1]<<8|r[2]}this.setPaletteCount(t.length),this.setCompression(0),this.palette=t}},{key:"setPixels",value:function(e){var t=void 0,i=this.vWidth*this.height;switch(this.bpp){case 8:t=new Uint8Array(i);break;case 32:t=new Uint32Array(i)}for(var r=this.width,a=0;a<this.height;a++){var n=r*this.height-(a+1)*r,s=a*this.width;t.set(e.slice(n,n+this.width),s)}this.pixels=t}},{key:"getBlob",value:function(){var e=[this.fileHeader.buffer,this.dibHeader.buffer],t=this.fileHeader.byteLength+this.dibHeader.byteLength;switch(this.bpp){case 1:case 4:case 8:this.setFilelength(t+this.pixels.byteLength+this.palette.byteLength),this.setPixelOffset(t+this.palette.byteLength),e=e.concat([this.palette.buffer,this.pixels.buffer]);break;case 16:case 32:this.setFilelength(t+this.pixels.byteLength),this.setPixelOffset(t),e=e.concat([this.pixels.buffer])}return new Blob(e,{type:"image/bitmap"})}},{key:"getUrl",value:function(){return window.URL.createObjectURL(this.getBlob())}},{key:"getImage",value:function(){var e=new Image(this.width,this.height);return e.src=this.getUrl(),e}}],[{key:"fromFlipnoteFrame",value:function(t,i){var r=t.constructor,a=new e(r.width,r.height,8);return a.setPixels(t.getFramePixels(i)),a.setPalette(t.getFramePalette(i)),a}}]),e}();t.default=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=i(1),n=i(19),s=i(20);var o=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.width=t,this.height=i,this.delay=100,this.repeat=-1,this.colorDepth=8,this.palette=[],this.data=new n.ByteArray}return r(e,[{key:"init",value:function(){for(var e=this.palette.length/3,t=1;1<<t<e;t+=1);this.colorDepth=t,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt()}},{key:"writeHeader",value:function(){var e=new a.dataStream(new ArrayBuffer(13));e.writeUtf8("GIF89a"),e.writeUint16(this.width),e.writeUint16(this.height),e.writeUint8(128|this.colorDepth-1),e.writeUint8(0),e.writeUint8(0),this.data.writeBytes(new Uint8Array(e.buffer))}},{key:"writeColorTable",value:function(){var e=new Uint8Array(3*Math.pow(2,this.colorDepth));e.set(this.palette,0),this.data.writeBytes(e)}},{key:"writeGraphicsControlExt",value:function(){var e=new a.dataStream(new ArrayBuffer(8));e.writeBytes([33,249,4,0]),e.writeUint16(this.delay),e.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(e.buffer))}},{key:"writeNetscapeExt",value:function(){var e=new a.dataStream(new ArrayBuffer(19));e.writeBytes([33,255,11]),e.writeUtf8("NETSCAPE2.0"),e.writeUint8(3),e.writeUint8(1),e.writeUint16(this.repeat),this.data.writeBytes(new Uint8Array(e.buffer))}},{key:"writeImageDesc",value:function(){var e=new a.dataStream(new ArrayBuffer(10));e.writeUint8(44),e.writeUint16(0),e.writeUint16(0),e.writeUint16(this.width),e.writeUint16(this.height),e.writeUint8(0),this.data.writeBytes(new Uint8Array(e.buffer))}},{key:"writePixels",value:function(e){new s.LZWEncoder(this.width,this.height,e,this.colorDepth).encode(this.data)}},{key:"writeFrame",value:function(e){this.writeGraphicsControlExt(),this.writeImageDesc(),this.writePixels(e)}},{key:"getBuffer",value:function(){return this.data.getBuffer()}},{key:"getBlob",value:function(){return new Blob([this.getBuffer()],{type:"image/gif"})}},{key:"getUrl",value:function(){return window.URL.createObjectURL(this.getBlob())}},{key:"getImage",value:function(){var e=new Image(this.width,this.height);return e.src=this.getUrl(),e}}],[{key:"fromFlipnote",value:function(t){var i=t.constructor,r=new e(i.width,i.height);r.palette=i.globalPalette.flat(),r.delay=100/t.framerate,r.repeat=t.meta.loop?-1:0,r.init();for(var a=0;a<t.frameCount;a++)r.writeFrame(t.getFramePixels(a,!0));return r}},{key:"fromFlipnoteFrame",value:function(t,i){var r=t.constructor,a=new e(r.width,r.height);return a.palette=r.globalPalette.flat(),a.delay=100/t.framerate,a.repeat=t.meta.loop?-1:0,a.init(),a.writeFrame(t.getFramePixels(i,!0)),a}}]),e}();t.default=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}();(t.ByteArray=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.page=-1,this.pages=[],this.newPage()}return r(e,[{key:"newPage",value:function(){this.pages[++this.page]=new Uint8Array(e.pageSize),this.cursor=0}},{key:"getData",value:function(){var t=this,i=new Uint8Array(this.page*e.pageSize+this.cursor);return this.pages.map(function(r,a){a===t.page?i.set(r.slice(0,t.cursor),a*e.pageSize):i.set(r,a*e.pageSize)}),i}},{key:"getBuffer",value:function(){return this.getData().buffer}},{key:"writeByte",value:function(t){this.cursor>=e.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=t}},{key:"writeBytes",value:function(e,t,i){for(var r=i||e.length,a=t||0;a<r;a++)this.writeByte(e[a])}}]),e}()).pageSize=4096},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}();var a=5003,n=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];t.LZWEncoder=function(){function e(t,i,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.width=t,this.height=i,this.pixels=r,this.colorDepth=n,this.initCodeSize=Math.max(2,this.colorDepth),this.accum=new Uint8Array(256),this.htab=new Int32Array(a),this.codetab=new Int32Array(a),this.cur_accum=0,this.cur_bits=0,this.a_count,this.remaining,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}return r(e,[{key:"char_out",value:function(e,t){this.accum[this.a_count++]=e,this.a_count>=254&&this.flush_char(t)}},{key:"cl_block",value:function(e){cl_hash(a),this.free_ent=this.ClearCode+2,this.clear_flg=!0,output(this.ClearCode,e)}},{key:"cl_hash",value:function(e){for(var t=0;t<e;++t)this.htab[t]=-1}},{key:"compress",value:function(e,t){var i,r,n,s,o,u,h;for(this.g_init_bits=e,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<e-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,s=this.nextPixel(),h=0,i=a;i<65536;i*=2)++h;h=8-h,u=a,this.cl_hash(u),this.output(this.ClearCode,t);e:for(;-1!=(r=this.nextPixel());)if(i=(r<<12)+s,n=r<<h^s,this.htab[n]!==i){if(this.htab[n]>=0){o=u-n,0===n&&(o=1);do{if((n-=o)<0&&(n+=u),this.htab[n]===i){s=this.codetab[n];continue e}}while(this.htab[n]>=0)}this.output(s,t),s=r,this.free_ent<4096?(this.codetab[n]=this.free_ent++,this.htab[n]=i):this.cl_block(t)}else s=this.codetab[n];this.output(s,t),this.output(this.EOFCode,t)}},{key:"encode",value:function(e){e.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,e),e.writeByte(0)}},{key:"flush_char",value:function(e){this.a_count>0&&(e.writeByte(this.a_count),e.writeBytes(this.accum,0,this.a_count),this.a_count=0)}},{key:"get_maxcode",value:function(e){return(1<<e)-1}},{key:"nextPixel",value:function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}},{key:"output",value:function(e,t){for(this.cur_accum&=n[this.cur_bits],this.cur_bits>0?this.cur_accum|=e<<this.cur_bits:this.cur_accum=e,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,t),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),e==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,t),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(t)}}}]),e}()}]).default});
//# sourceMappingURL=flipnote.min.js.map