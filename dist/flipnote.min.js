/*!!
 flipnote.js v5.1.1 (web build)
 A JavaScript library for parsing, converting, and in-browser playback of the proprietary animation formats used by Nintendo's Flipnote Studio and Flipnote Studio 3D apps.
 Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
 2018 - 2021 James Daniel
 https://flipnote.js.org
 Keep on Flipnoting!
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).flipnote={})}(this,(function(t){"use strict";var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,r)};function r(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}var i=function(){return(i=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function n(t,e,r,i){return new(r||(r=Promise))((function(n,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))}function o(t,e){var r,i,n,o,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(n=2&o[0]?i.return:o[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,o[1])).done)return n;switch(i=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(n=s.trys,(n=n.length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){s.label=o[1];break}if(6===o[0]&&s.label<n[1]){s.label=n[1],n=o;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(o);break}n[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function s(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var i=Array(t),n=0;for(e=0;e<r;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,n++)i[n]=o[s];return i}var a=function(){function t(){this.pageSize=t.pageSize,this.currPageIndex=-1,this.pages=[],this.pointer=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.currPageIndex]=new Uint8Array(this.pageSize),this.currPage=this.pages[this.currPageIndex],this.pointer=0},t.prototype.getData=function(){for(var t=new Uint8Array(this.currPageIndex*this.pageSize+this.pointer),e=0;e<this.pages.length;e++){var r=this.pages[e];e===this.currPageIndex?t.set(r.slice(0,this.pointer),e*this.pageSize):t.set(r,e*this.pageSize)}return t},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(t){this.pointer>=this.pageSize&&this.newPage(),this.currPage[this.pointer++]=t},t.prototype.writeBytes=function(t,e,r){for(var i=r||t.length,n=e||0;n<i;n++)this.writeByte(t[n])},t.pageSize=2048,t}(),u=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,e){switch(e){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;case 0:default:this.pointer=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.pointer);return this.pointer+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.pointer,t),this.pointer+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.pointer);return this.pointer+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.pointer,t),this.pointer+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var e=this.data.getUint16(this.pointer,t);return this.pointer+=2,e},t.prototype.writeUint16=function(t,e){void 0===e&&(e=!0),this.data.setUint16(this.pointer,t,e),this.pointer+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var e=this.data.getInt16(this.pointer,t);return this.pointer+=2,e},t.prototype.writeInt16=function(t,e){void 0===e&&(e=!0),this.data.setInt16(this.pointer,t,e),this.pointer+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var e=this.data.getUint32(this.pointer,t);return this.pointer+=4,e},t.prototype.writeUint32=function(t,e){void 0===e&&(e=!0),this.data.setUint32(this.pointer,t,e),this.pointer+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var e=this.data.getInt32(this.pointer,t);return this.pointer+=4,e},t.prototype.writeInt32=function(t,e){void 0===e&&(e=!0),this.data.setInt32(this.pointer,t,e),this.pointer+=4},t.prototype.readBytes=function(t){var e=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=e.byteLength,e},t.prototype.writeBytes=function(t){var e=this;t.forEach((function(t){return e.writeUint8(t)}))},t.prototype.readHex=function(t,e){void 0===e&&(e=!1);for(var r=this.readBytes(t),i=[],n=0;n<r.length;n++)i.push(r[n].toString(16).padStart(2,"0"));return e&&i.reverse(),i.join("").toUpperCase()},t.prototype.readChars=function(t){for(var e=this.readBytes(t),r="",i=0;i<e.length;i++){var n=e[i];if(0===n)break;r+=String.fromCharCode(n)}return r},t.prototype.writeChars=function(t){for(var e=0;e<t.length;e++){var r=t.charCodeAt(e);this.writeUint8(r)}},t.prototype.readWideChars=function(t){for(var e=new Uint16Array(this.data.buffer,this.pointer,t),r="",i=0;i<e.length;i++){var n=e[i];if(0==n)break;r+=String.fromCharCode(n)}return this.pointer+=e.byteLength,r},t}();function h(t,e){if(void 0===e&&(e="Assert failed"),!t)throw console.trace(e),new Error(e)}function f(t,e,r,i){void 0===i&&(i=""),h(t>=e&&t<=r,"Value "+i+" should be between "+e+" and "+r)}var c="undefined"!=typeof window&&void 0!==window.document;function d(){return h(c,"This feature is only available in browser environments")}var l="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;function p(){return h(l,"This feature is only available in NodeJS environments")}function m(t){return new Date(1e3*(t+946684800))}function y(t,e){return 100*t*(1/e)/100}var g,v;!function(){if(!c)return function(){};var t=document.createElement("a")}();(g=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",g.KWZ="KWZ",(v=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[v.BGM=0]="BGM",v[v.SE1=1]="SE1",v[v.SE2=2]="SE2",v[v.SE3=3]="SE3",v[v.SE4=4]="SE4";var b=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.hasAudioTrack=function(t){return!!(this.soundMeta.hasOwnProperty(t)&&this.soundMeta[t].length>0)},e}(u),w=[{matches:function(t){return c&&"string"==typeof t},load:function(t,e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onreadystatechange=function(t){4===i.readyState&&(i.status>=200&&i.status<300?e(i.response):r({type:"httpError",status:i.status,statusText:i.statusText}))},i.send(null)}},{matches:function(t){return l&&"string"==typeof t},load:function(t,e,r){require("https").get(t,(function(t){var i=[];t.on("data",(function(t){return i.push(t)})),t.on("end",(function(){var t=Buffer.concat(i);e(t.buffer)})),t.on("error",(function(t){return r(t)}))}))}},{matches:function(t){return c&&"undefined"!=typeof File&&t instanceof File},load:function(t,e,r){h("undefined"!=typeof FileReader);var i=new FileReader;i.onload=function(t){e(i.result)},i.onerror=function(t){r({type:"fileReadError"})},i.readAsArrayBuffer(t)}},{matches:function(t){return l&&t instanceof Buffer},load:function(t,e,r){e(t.buffer)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,r){e(t)}}];function A(t,e,r){return t<e?e:t>r?r:t}function F(t,e,r){for(var i=t.length/e,n=new Int16Array(i*r),o=e/r,s=0;s<n.length;s++)n[s]=t[Math.floor(s*o)];return n}var x=new Int8Array([-1,2,-1,2]),T=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),P=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function S(t){for(var e=t.length,r=0,i=0;i<e;i++){var n=t[i];-32768!=n&&32767!=n||(r+=1)}return r/e}for(var _=[.5,.5,1,2,4,6,12,20,30],E={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},U=function(e){function i(r,n){var o=e.call(this,r)||this;return o.format=t.FlipnoteFormat.PPM,o.width=i.width,o.height=i.height,o.numLayers=i.numLayers,o.rawSampleRate=i.rawSampleRate,o.sampleRate=i.sampleRate,o.globalPalette=i.globalPalette,o.prevDecodedFrame=null,o.decodeHeader(),o.decodeAnimationHeader(),o.decodeSoundHeader(),0!=(o.version>>4&15)&&o.decodeMeta(),o.layerBuffers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],o.prevLayerBuffers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],o.lineEncodingBuffers=[new Uint8Array(i.height),new Uint8Array(i.height)],o.prevDecodedFrame=null,o}return r(i,e),i.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},i.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},i.prototype.decodeHeader=function(){h(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},i.prototype.readFilename=function(){return this.readHex(3)+"_"+this.readChars(13)+"_"+this.readUint16().toString().padStart(3,"0")},i.prototype.decodeMeta=function(){h(1704<this.byteLength),this.seek(16);var t=this.readUint16(),e=this.readInt16(),r=this.readWideChars(11),i=this.readWideChars(11),n=this.readWideChars(11),o=this.readHex(8,!0),s=this.readHex(8,!0),a=this.readFilename(),u=this.readFilename(),f=this.readHex(8,!0);this.seek(154);var c=m(this.readInt32());this.seek(1702);var d=this.readUint16();this.thumbFrameIndex=e,this.layerVisibility={1:0==(16&d),2:0==(32&d),3:!1},this.isSpinoff=s!==o||s!==f,this.meta={lock:1===t,loop:1==(d>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:e,timestamp:c,root:{filename:null,username:r,fsid:f},parent:{username:i,fsid:o,filename:a},current:{username:n,fsid:s,filename:u}}},i.prototype.decodeAnimationHeader=function(){this.seek(1696);var t=this.readUint16(),e=t/4;h(e<=this.frameCount),this.seek(1704);for(var r=new Uint32Array(e),i=0;i<e;i++){var n=1704+t+this.readUint32();h(n<this.byteLength,"Frame "+i+" pointer is out of bounds"),r[i]=n}this.frameOffsets=r},i.prototype.decodeSoundHeader=function(){var e,r=1696+this.frameDataLength+this.frameCount;h(r<this.byteLength),r%4!=0&&(r+=4-r%4),this.seek(r);var i=this.readUint32(),n=this.readUint32(),o=this.readUint32(),s=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),h(this.frameSpeed<=8&&this.bgmSpeed<=8),r+=32,this.framerate=_[this.frameSpeed],this.duration=y(this.frameCount,this.framerate),this.bgmrate=_[this.bgmSpeed],this.soundMeta=((e={})[t.FlipnoteAudioTrack.BGM]={ptr:r,length:i},e[t.FlipnoteAudioTrack.SE1]={ptr:r+=i,length:n},e[t.FlipnoteAudioTrack.SE2]={ptr:r+=n,length:o},e[t.FlipnoteAudioTrack.SE3]={ptr:r+=o,length:s},e)},i.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},i.prototype.decodeFrame=function(t){h(t>-1&&t<this.frameCount,"Frame index "+t+" out of bounds"),this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);var e=this.readUint8(),r=e>>7&1,n=e>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);var o=0,s=0;n&&(o=this.readInt8(),s=this.readInt8());for(var a=0;a<2;a++){(d=this.lineEncodingBuffers[a]).fill(0);for(var u=0;u<d.length;){var f=this.readUint8();0!==f?(d[u++]=3&f,d[u++]=f>>2&3,d[u++]=f>>4&3,d[u++]=f>>6&3):u+=4}}for(a=0;a<2;a++)for(var c=this.layerBuffers[a],d=this.lineEncodingBuffers[a],l=0;l<i.height;l++){var p=l*i.width;switch(d[l]){case 0:break;case 1:for(var m=this.readUint32(!1);0!==m;m<<=1,p+=8)if(2147483648&m)for(var y=this.readUint8(),g=0;0!==y;g++,y>>=1)c[p+g]=1&y;break;case 2:c.fill(1,p,p+i.width);for(m=this.readUint32(!1);0!==m;m<<=1,p+=8)if(2147483648&m)for(y=this.readUint8(),g=0;g<8;g++,y>>=1)c[p+g]=1&y;break;case 3:y=0;for(var v=0;v<i.width;v++)v%8==0&&(y=this.readUint8()),c[p++]=1&y,y>>=1}}var b=this.layerBuffers[0],w=this.layerBuffers[1],A=this.prevLayerBuffers[0],F=this.prevLayerBuffers[1];if(!r){var x=void 0,T=void 0;for(l=0;l<i.height;l++)if(!(l-s<0)){if(l-s>=i.height)break;for(var P=0;P<i.width;P++)if(!(P-o<0)){if(P-o>=i.width)break;T=(x=P+l*i.width)-(o+s*i.width),b[x]^=A[T],w[x]^=F[T]}}}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers},i.prototype.getFrameLayerOrder=function(t){return[0,1]},i.prototype.getFramePaletteIndices=function(t){this.seek(this.frameOffsets[t]);var e=this.readUint8(),r=1!=(1&e),i=[r?0:1,r?0:1,2,3];return[r?1:0,i[e>>1&3],i[e>>3&3]]},i.prototype.getFramePalette=function(t){var e=this;return this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,e){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),n=this.layerBuffers[e],o=new Uint8Array(i.width*i.height),s=r[e+1],a=0;a<o.length;a++)1===n[a]&&(o[a]=s);return o},i.prototype.getFramePixels=function(t){var e=this.getFramePaletteIndices(t),r=this.decodeFrame(t),n=new Uint8Array(i.width*i.height),o=r[0],s=r[1],a=e[0],u=e[1],h=e[2];n.fill(a);for(var f=0;f<n.length;f++){var c=o[f],d=s[f];1===c?n[f]=u:1===d&&(n[f]=h)}return n},i.prototype.decodeSoundFlags=function(){h(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);for(var t=this.frameCount,e=this.readBytes(t),r=new Array(t),i=0;i<t;i++){var n=e[i];r[i]=[0!=(1&n),0!=(2&n),0!=(4&n)]}return r},i.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta[t];return h(e.ptr+e.length<this.byteLength),this.seek(e.ptr),this.readBytes(e.length)},i.prototype.decodeAudioTrack=function(t){for(var e=this.getAudioTrackRaw(t),r=e.length,i=new Int16Array(2*r),n=0,o=0,s=0,a=0,u=0,h=!0;n<r;){s=h?15&e[n]:e[n++]>>4,h=!h;var f=P[a],c=f>>3;1&s&&(c+=f>>2),2&s&&(c+=f>>1),4&s&&(c+=f),8&s&&(c=-c),u=A(u+=c,-32768,32767),a=A(a+=T[s],0,88),i[o++]=u}return i},i.prototype.getAudioTrackPcm=function(e,r){void 0===r&&(r=this.sampleRate);var i=this.decodeAudioTrack(e),n=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){var o=1/this.bgmrate/(1/this.framerate);n=this.rawSampleRate*o}return n!==r?F(i,n,r):i},i.prototype.pcmAudioMix=function(t,e,r){void 0===r&&(r=0);for(var i=t.length,n=e.length,o=0;o<i&&!(r+o>n);o++){var s=e[r+o]+t[o]/2;e[r+o]=A(s,-32768,32767)}},i.prototype.getAudioMasterPcm=function(e){void 0===e&&(e=this.sampleRate);var r=Math.ceil(this.duration*e),i=new Int16Array(r),n=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),s=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(n){var u=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(u,i,0)}if(o||s||a)for(var h=e/this.framerate,f=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,c=s?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,d=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,l=this.decodeSoundFlags(),p=0;p<this.frameCount;p++){var m=Math.ceil(p*h),y=l[p];o&&y[0]&&this.pcmAudioMix(f,i,m),s&&y[1]&&this.pcmAudioMix(c,i,m),a&&y[2]&&this.pcmAudioMix(d,i,m)}return this.audioClipRatio=S(i),i},i.defaultSettings={},i.format=t.FlipnoteFormat.PPM,i.width=256,i.height=192,i.numLayers=2,i.rawSampleRate=8192,i.sampleRate=32768,i.globalPalette=[E.WHITE,E.BLACK,E.RED,E.BLUE],i}(b),k=[.2,.5,1,2,4,6,8,12,20,24,30],B={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},C=new Uint16Array(16),L=0;L<16;L++)C[L]=(1<<L)-1;for(var M=new Uint8Array(52488),I=new Uint8Array(52488),R=0,z=0;z<3;z++)for(var D=0;D<3;D++)for(var O=0;O<3;O++)for(var N=0;N<3;N++)for(var H=0;H<3;H++)for(var G=0;G<3;G++)for(var V=0;V<3;V++)for(var W=0;W<3;W++)M.set([D,z,N,O,G,H,W,V],R),I.set([z,N,O,G,H,W,V,D],R),R+=8;var j=new Uint8Array(256),q=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,e){var r=8*t,i=M.subarray(r,r+8),n=I.subarray(r,r+8);j.set(i,8*e),q.set(n,8*e)}));var K,X=function(e){function n(r,o){void 0===o&&(o={});var s=e.call(this,r)||this;return s.format=t.FlipnoteFormat.KWZ,s.width=n.width,s.height=n.height,s.numLayers=n.numLayers,s.rawSampleRate=n.rawSampleRate,s.sampleRate=n.sampleRate,s.globalPalette=n.globalPalette,s.prevFrameIndex=null,s.bitIndex=0,s.bitValue=0,s.settings=i(i({},n.defaultSettings),o),s.layers=[new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height)],s.buildSectionMap(),s.settings.quickMeta?s.decodeMetaQuick():s.decodeMeta(),s.getFrameOffsets(),s.decodeSoundHeader(),s}return r(n,e),n.prototype.buildSectionMap=function(){this.seek(0);for(var t=this.byteLength-256,e=new Map,r=0,i=0;i<t&&r<6;){this.seek(i);var n=this.readChars(4).substring(0,3),o=this.readUint32();e.set(n,{ptr:i,length:o}),i+=o+8,r+=1}this.sectionMap=e,h(e.has("KMC")&&e.has("KMI"))},n.prototype.readBits=function(t){if(this.bitIndex+t>16){var e=this.readUint16();this.bitValue|=e<<16-this.bitIndex,this.bitIndex-=16}var r=this.bitValue&C[t];return this.bitValue>>=t,this.bitIndex+=t,r},n.prototype.readFsid=function(){if(this.settings.dsiGalleryNote)return this.readHex(10,!0).slice(2,18);var t=this.readHex(10);return(t.slice(0,4)+"-"+t.slice(4,8)+"-"+t.slice(8,12)+"-"+t.slice(12,18)).toLowerCase()},n.prototype.readFilename=function(){var t=this.pointer,e=this.readChars(28);if(28===e.length)return e;this.seek(t);var r=this.readHex(3),i=this.readChars(13),n=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),r+"_"+i+"_"+n},n.prototype.decodeMeta=function(){h(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);var t=m(this.readUint32()),e=m(this.readUint32()),r=(this.readUint32(),this.readFsid()),i=this.readFsid(),n=this.readFsid(),o=this.readWideChars(11),s=this.readWideChars(11),a=this.readWideChars(11),u=this.readFilename(),f=this.readFilename(),c=this.readFilename(),d=this.readUint16(),l=this.readUint16(),p=this.readUint16(),g=this.readUint8(),v=this.readUint8();this.isSpinoff=n!==i||n!==r,this.frameCount=d,this.frameSpeed=g,this.framerate=k[g],this.duration=y(this.frameCount,this.framerate),this.thumbFrameIndex=l,this.layerVisibility={1:0==(1&v),2:0==(2&v),3:0==(3&v)},this.meta={lock:0!=(1&p),loop:0!=(2&p),isSpinoff:this.isSpinoff,frameCount:d,frameSpeed:g,duration:this.duration,thumbIndex:l,timestamp:e,creationTimestamp:t,root:{username:o,fsid:r,filename:u,isDsiFilename:28!==u.length},parent:{username:s,fsid:i,filename:f,isDsiFilename:28!==f.length},current:{username:a,fsid:n,filename:c,isDsiFilename:28!==c.length}}},n.prototype.decodeMetaQuick=function(){h(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);var t=this.readUint16(),e=this.readUint16(),r=(this.readUint16(),this.readUint8()),i=this.readUint8();this.frameCount=t,this.thumbFrameIndex=e,this.frameSpeed=r,this.framerate=k[r],this.duration=y(this.frameCount,this.framerate),this.layerVisibility={1:0==(1&i),2:0==(2&i),3:0==(3&i)}},n.prototype.getFrameOffsets=function(){h(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));var t=this.frameCount,e=this.sectionMap.get("KMI"),r=this.sectionMap.get("KMC");h(e.length/28>=t);for(var i=new Uint32Array(t),n=new Uint32Array(t),o=[],s=e.ptr+8,a=r.ptr+12,u=0;u<t;u++){this.seek(s+4);var f=this.readUint16(),c=this.readUint16(),d=this.readUint16();i[u]=s,n[u]=a,a+=f+c+d,h((s+=28)<this.byteLength,"frame"+u+" meta pointer out of bounds"),h(a<this.byteLength,"frame"+u+" data pointer out of bounds"),o.push([f,c,d])}this.frameMetaOffsets=i,this.frameDataOffsets=n,this.frameLayerSizes=o},n.prototype.decodeSoundHeader=function(){var e;h(this.sectionMap.has("KSN"));var r=this.sectionMap.get("KSN").ptr+8;this.seek(r),this.bgmSpeed=this.readUint32(),h(this.bgmSpeed<=10),this.bgmrate=k[this.bgmSpeed];var i=new Uint32Array(this.buffer,r+4,20);this.soundMeta=((e={})[t.FlipnoteAudioTrack.BGM]={ptr:r+=28,length:i[0]},e[t.FlipnoteAudioTrack.SE1]={ptr:r+=i[0],length:i[1]},e[t.FlipnoteAudioTrack.SE2]={ptr:r+=i[1],length:i[2]},e[t.FlipnoteAudioTrack.SE3]={ptr:r+=i[2],length:i[3]},e[t.FlipnoteAudioTrack.SE4]={ptr:r+=i[3],length:i[4]},e)},n.prototype.getFramePaletteIndices=function(t){this.seek(this.frameMetaOffsets[t]);var e=this.readUint32();return[15&e,e>>8&15,e>>12&15,e>>16&15,e>>20&15,e>>24&15,e>>28&15]},n.prototype.getFramePalette=function(t){var e=this;return this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},n.prototype.getFrameDiffingFlag=function(t){return this.seek(this.frameMetaOffsets[t]),this.readUint32()>>4&7},n.prototype.getFrameLayerSizes=function(t){return this.seek(this.frameMetaOffsets[t]+4),[this.readUint16(),this.readUint16(),this.readUint16()]},n.prototype.getFrameLayerDepths=function(t){return this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]},n.prototype.getFrameAuthor=function(t){return this.seek(this.frameMetaOffsets[t]+10),this.readHex(10)},n.prototype.getFrameSoundFlags=function(t){this.seek(this.frameMetaOffsets[t]+23);var e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e),0!=(8&e)]},n.prototype.getFrameCameraFlags=function(t){this.seek(this.frameMetaOffsets[t]+26);var e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e)]},n.prototype.getFrameLayerOrder=function(t){var e=this.getFrameLayerDepths(t);return[2,1,0].sort((function(t,r){return e[r]-e[t]}))},n.prototype.decodeFrame=function(t,e,r){void 0===e&&(e=7),void 0===r&&(r=!1),h(t>-1&&t<this.frameCount,"Frame index "+t+" out of bounds"),this.prevFrameIndex!==t-1&&0!==t&&(r&&(e&=~this.getFrameDiffingFlag(t+1)),0!==e&&this.decodeFrame(t-1,e,!0));for(var i=this.frameDataOffsets[t],o=this.frameLayerSizes[t],s=0;s<3&&(!this.settings.dsiGalleryNote||3!==s);s++){this.seek(i);var a=o[s];i+=a;var u=this.layers[s];if(38!==a&&0!=(e>>s&1)){this.bitIndex=16,this.bitValue=0;for(var f=0,c=0;c<240;c+=128)for(var d=0;d<320;d+=128)for(var l=0;l<128;l+=8){var p=c+l;if(p>=240)break;for(var m=0;m<128;m+=8){var y=d+m;if(y>=320)break;if(f>0)f-=1;else{var g=p*n.width+y,v=this.readBits(3);if(0===v){var b=8*this.readBits(5),w=j.subarray(b,b+8);u.set(w,g),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320)}else if(1===v){b=8*this.readBits(13),w=M.subarray(b,b+8);u.set(w,g),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320)}else if(2===v){b=8*this.readBits(5);var A=j.subarray(b,b+8),F=q.subarray(b,b+8);u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320)}else if(3===v){b=8*this.readBits(13),A=M.subarray(b,b+8),F=I.subarray(b,b+8);u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320)}else if(4===v)for(var x=this.readBits(8),T=1;T<255;T<<=1){if(x&T){b=8*this.readBits(5),w=j.subarray(b,b+8);u.set(w,g)}else{b=8*this.readBits(13),w=M.subarray(b,b+8);u.set(w,g)}g+=320}else{if(5===v){f=this.readBits(5);continue}if(7===v){var P=this.readBits(2);A=void 0,F=void 0;if(0!==this.readBits(1)){var S=8*this.readBits(5),_=8*this.readBits(5);A=j.subarray(S,S+8),F=j.subarray(_,_+8),P=(P+1)%4}else{S=8*this.readBits(13),_=8*this.readBits(13);A=M.subarray(S,S+8),F=M.subarray(_,_+8)}0===P?(u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320)):1===P?(u.set(A,g),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320)):2===P?(u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320),u.set(F,g+=320)):3===P&&(u.set(A,g),u.set(F,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320))}}}}}}}return this.prevFrameIndex=t,this.layers},n.prototype.getLayerPixels=function(t,e){this.prevFrameIndex!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),i=this.layers[e],o=new Uint8Array(n.width*n.height),s=2*e+1,a=0;a<i.length;a++){var u=i[a];1===u?o[a]=r[s]:2===u&&(o[a]=r[s+1])}return o},n.prototype.getFramePixels=function(t){this.prevFrameIndex!==t&&this.decodeFrame(t);var e=this.getFramePaletteIndices(t),r=this.getFrameLayerOrder(t),i=this.layers[r[2]],o=this.layers[r[1]],s=this.layers[r[0]],a=2*r[2],u=2*r[1],h=2*r[0];if(this.settings.dsiGalleryNote){var f;(f=new Uint8Array(n.width*n.height)).fill(e[0]);for(var c=n.width-64,d=n.height-48,l=n.width,p=32;p<d;p++)for(var m=p*l,y=24;y<c;y++){v=i[m],b=o[m];0!==v?f[m]=e[a+v]:0!==b&&(f[m]=e[u+b]),m+=1}return f}(f=new Uint8Array(n.width*n.height)).fill(e[0]);for(var g=0;g<f.length;g++){var v=i[g],b=o[g],w=s[g];0!==v?f[g]=e[a+v]:0!==b?f[g]=e[u+b]:0!==w&&(f[g]=e[h+w])}return f},n.prototype.decodeSoundFlags=function(){for(var t=[],e=0;e<this.frameCount;e++)t.push(this.getFrameSoundFlags(e));return t},n.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta[t];return h(e.ptr+e.length<this.byteLength),new Uint8Array(this.buffer,e.ptr,e.length)},n.prototype.decodeAudioTrack=function(t){var e=this.getAudioTrackRaw(t),r=new Int16Array(981840),i=0,n=0,o=0,s=0,a=0,u=0;this.settings.originalAudioSettings&&(o=40);for(var h=0;h<e.length;h++)for(var f=e[h],c=0;c<8;)o<18||c>4?(s=3&f,u=(a=P[o])>>3,1&s&&(u+=a),2&s&&(u=-u),n+=u,o+=x[s],f>>=2,c+=2):(s=15&f,u=(a=P[o])>>3,1&s&&(u+=a>>2),2&s&&(u+=a>>1),4&s&&(u+=a),8&s&&(u=-u),n+=u,o+=T[s],f>>=4,c+=4),o=A(o,0,79),n=A(n,-2048,2047),r[i]=16*n,i+=1;return r.slice(0,i)},n.prototype.getAudioTrackPcm=function(e,r){void 0===r&&(r=this.sampleRate);var i=this.decodeAudioTrack(e),n=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){var o=1/this.bgmrate/(1/this.framerate);n=this.rawSampleRate*o}return n!==r?F(i,n,r):i},n.prototype.pcmAudioMix=function(t,e,r){void 0===r&&(r=0);for(var i=t.length,n=e.length,o=0;o<i&&!(r+o>n);o++){var s=e[r+o]+t[o];e[r+o]=A(s,-32768,32767)}},n.prototype.getAudioMasterPcm=function(e){void 0===e&&(e=this.sampleRate);var r=Math.ceil(this.duration*e),i=new Int16Array(r),n=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),s=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),u=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(n){var h=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(h,i,0)}if(o||s||a||u)for(var f=e/this.framerate,c=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,d=s?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,l=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,p=u?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,e):null,m=0;m<this.frameCount;m++){var y=this.getFrameSoundFlags(m),g=Math.ceil(m*f);o&&y[0]&&this.pcmAudioMix(c,i,g),s&&y[1]&&this.pcmAudioMix(d,i,g),a&&y[2]&&this.pcmAudioMix(l,i,g),u&&y[3]&&this.pcmAudioMix(p,i,g)}return this.audioClipRatio=S(i),i},n.defaultSettings={quickMeta:!1,dsiGalleryNote:!1,originalAudioSettings:!1},n.format=t.FlipnoteFormat.KWZ,n.width=320,n.height=240,n.numLayers=3,n.rawSampleRate=16364,n.sampleRate=16364,n.globalPalette=[B.WHITE,B.BLACK,B.RED,B.YELLOW,B.GREEN,B.BLUE,B.NONE],n}(b);function Y(t,e){return function(t){return new Promise((function(e,r){for(var i=0;i<w.length;i++){var n=w[i];if(n.matches(t))return n.load(t,e,r)}r("No loader available for source type")}))}(t).then((function(t){return new Promise((function(r,i){var n=new Uint8Array(t.slice(0,4)),o=n[0]<<24|n[1]<<16|n[2]<<8|n[3];1346458177===o?r(new U(t,e)):1262897152==(4294967040&o)?r(new X(t,e)):i()}))}))}!function(t){t.__Any="any",t.Play="play",t.Pause="pause",t.CanPlay="canplay",t.CanPlayThrough="canplaythrough",t.SeekStart="seeking",t.SeekEnd="seeked",t.Duration="durationchange",t.Loop="loop",t.Ended="ended",t.VolumeChange="volumechange",t.Progress="progress",t.TimeUpdate="timeupdate",t.FrameUpdate="frameupdate",t.FrameNext="framenext",t.FramePrev="frameprev",t.FrameFirst="framefirst",t.FrameLast="framelast",t.Ready="ready",t.Load="load",t.LoadStart="loadstart",t.LoadedData="loadeddata",t.LoadedMeta="loadedmetadata",t.Emptied="emptied",t.Close="close",t.Error="error",t.Destroy="destroy"}(K||(K={}));var Z=[K.Play,K.Pause,K.CanPlay,K.CanPlayThrough,K.SeekStart,K.SeekEnd,K.Duration,K.Loop,K.Ended,K.VolumeChange,K.Progress,K.TimeUpdate,K.FrameUpdate,K.FrameNext,K.FramePrev,K.FrameFirst,K.FrameLast,K.Ready,K.Load,K.LoadStart,K.LoadedData,K.LoadedMeta,K.Emptied,K.Close,K.Error];function $(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const Q="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function J(t,e){return"undefined"!=typeof WebGLTexture&&e instanceof WebGLTexture}const tt="";function et(t,e,r,i){if(n=e,"undefined"!=typeof WebGLBuffer&&n instanceof WebGLBuffer)return e;var n;r=r||34962;const o=t.createBuffer();return function(t,e,r,i,n){t.bindBuffer(e,r),t.bufferData(e,i,n||35044)}(t,r,o,e,i),o}function rt(t){return"indices"===t}const it=/coord|texture/i,nt=/color|colour/i;function ot(t,e){let r;if(r=it.test(t)?2:nt.test(t)?4:3,e%r>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${r} but ${e} values is not evenly divisible by ${r}. You should specify it.`);return r}function st(t,e){if(Q(t))return t;if(Q(t.data))return t.data;Array.isArray(t)&&(t={data:t});let r=t.type;return r||(r=rt(e)?Uint16Array:Float32Array),new r(t.data)}function at(t,e){const r={};return Object.keys(e).forEach((function(i){if(!rt(i)){const o=e[i],s=o.attrib||o.name||o.attribName||tt+i;if(o.value){if(!Array.isArray(o.value)&&!Q(o.value))throw new Error("array.value is not array or typedarray");r[s]={value:o.value}}else{let e,a,u,h;if(o.buffer&&o.buffer instanceof WebGLBuffer)e=o.buffer,h=o.numComponents||o.size,a=o.type,u=o.normalize;else if("number"==typeof o||"number"==typeof o.data){const r=o.data||o,s=o.type||Float32Array,f=r*s.BYTES_PER_ELEMENT;a=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(s),u=void 0!==o.normalize?o.normalize:(n=s)===Int8Array||n===Uint8Array,h=o.numComponents||o.size||ot(i,r),e=t.createBuffer(),t.bindBuffer(34962,e),t.bufferData(34962,f,o.drawType||35044)}else{const r=st(o,i);e=et(t,r,void 0,o.drawType),a=$(r),u=void 0!==o.normalize?o.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(r),h=function(t,e){return t.numComponents||t.size||ot(e,function(t){return t.length?t:t.data}(t).length)}(o,i)}r[s]={buffer:e,numComponents:h,type:a,normalize:u,stride:o.stride||0,offset:o.offset||0,divisor:void 0===o.divisor?void 0:o.divisor,drawType:o.drawType}}}var n})),t.bindBuffer(34962,null),r}const ut=["position","positions","a_position"];function ht(t,e,r){const i=at(t,e),n=Object.assign({},r||{});n.attribs=Object.assign({},r?r.attribs:{},i);const o=e.indices;if(o){const e=st(o,"indices");n.indices=et(t,e,34963),n.numElements=e.length,n.elementType=$(e)}else n.numElements||(n.numElements=function(t,e){let r,i;for(i=0;i<ut.length&&(r=ut[i],!(r in e))&&(r=tt+r,!(r in e));++i);i===ut.length&&(r=Object.keys(e)[0]);const n=e[r];t.bindBuffer(34962,n.buffer);const o=t.getBufferParameter(34962,34660);var s;t.bindBuffer(34962,null);const a=o/(5120===(s=n.type)||5121===s?1:5122===s||5123===s?2:5124===s||5125===s||5126===s?4:0),u=n.numComponents||n.size,h=a/u;if(h%1!=0)throw new Error(`numComponents ${u} not correct for length ${length}`);return h}(t,n.attribs));return n}function ft(t){return!!t.texStorage2D}const ct={};function dt(t,e){return ct[e].bindPoint}function lt(t,e){return function(r){t.uniform1i(e,r)}}function pt(t,e){return function(r){t.uniform1iv(e,r)}}function mt(t,e){return function(r){t.uniform2iv(e,r)}}function yt(t,e){return function(r){t.uniform3iv(e,r)}}function gt(t,e){return function(r){t.uniform4iv(e,r)}}function vt(t,e,r,i){const n=dt(0,e);return ft(t)?function(e){let o,s;J(0,e)?(o=e,s=null):(o=e.texture,s=e.sampler),t.uniform1i(i,r),t.activeTexture(33984+r),t.bindTexture(n,o),t.bindSampler(r,s)}:function(e){t.uniform1i(i,r),t.activeTexture(33984+r),t.bindTexture(n,e)}}function bt(t,e,r,i,n){const o=dt(0,e),s=new Int32Array(n);for(let t=0;t<n;++t)s[t]=r+t;return ft(t)?function(e){t.uniform1iv(i,s),e.forEach((function(e,i){let n,a;t.activeTexture(33984+s[i]),J(0,e)?(n=e,a=null):(n=e.texture,a=e.sampler),t.bindSampler(r,a),t.bindTexture(o,n)}))}:function(e){t.uniform1iv(i,s),e.forEach((function(e,r){t.activeTexture(33984+s[r]),t.bindTexture(o,e)}))}}function wt(t,e){return function(r){if(r.value)switch(t.disableVertexAttribArray(e),r.value.length){case 4:t.vertexAttrib4fv(e,r.value);break;case 3:t.vertexAttrib3fv(e,r.value);break;case 2:t.vertexAttrib2fv(e,r.value);break;case 1:t.vertexAttrib1fv(e,r.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,r.numComponents||r.size,r.type||5126,r.normalize||!1,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function At(t,e){return function(r){if(r.value){if(t.disableVertexAttribArray(e),4!==r.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(e,r.value)}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.numComponents||r.size,r.type||5124,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function Ft(t,e){return function(r){if(r.value){if(t.disableVertexAttribArray(e),4!==r.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(e,r.value)}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.numComponents||r.size,r.type||5125,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function xt(t,e,r){const i=r.size,n=r.count;return function(r){t.bindBuffer(34962,r.buffer);const o=r.size||r.numComponents||i,s=o/n,a=r.type||5126,u=ct[a].size*o,h=r.normalize||!1,f=r.offset||0,c=u/n;for(let i=0;i<n;++i)t.enableVertexAttribArray(e+i),t.vertexAttribPointer(e+i,s,a,h,u,f+c*i),void 0!==r.divisor&&t.vertexAttribDivisor(e+i,r.divisor)}}ct[5126]={Type:Float32Array,size:4,setter:function(t,e){return function(r){t.uniform1f(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1fv(e,r)}}},ct[35664]={Type:Float32Array,size:8,setter:function(t,e){return function(r){t.uniform2fv(e,r)}}},ct[35665]={Type:Float32Array,size:12,setter:function(t,e){return function(r){t.uniform3fv(e,r)}}},ct[35666]={Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniform4fv(e,r)}}},ct[5124]={Type:Int32Array,size:4,setter:lt,arraySetter:pt},ct[35667]={Type:Int32Array,size:8,setter:mt},ct[35668]={Type:Int32Array,size:12,setter:yt},ct[35669]={Type:Int32Array,size:16,setter:gt},ct[5125]={Type:Uint32Array,size:4,setter:function(t,e){return function(r){t.uniform1ui(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1uiv(e,r)}}},ct[36294]={Type:Uint32Array,size:8,setter:function(t,e){return function(r){t.uniform2uiv(e,r)}}},ct[36295]={Type:Uint32Array,size:12,setter:function(t,e){return function(r){t.uniform3uiv(e,r)}}},ct[36296]={Type:Uint32Array,size:16,setter:function(t,e){return function(r){t.uniform4uiv(e,r)}}},ct[35670]={Type:Uint32Array,size:4,setter:lt,arraySetter:pt},ct[35671]={Type:Uint32Array,size:8,setter:mt},ct[35672]={Type:Uint32Array,size:12,setter:yt},ct[35673]={Type:Uint32Array,size:16,setter:gt},ct[35674]={Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniformMatrix2fv(e,!1,r)}}},ct[35675]={Type:Float32Array,size:36,setter:function(t,e){return function(r){t.uniformMatrix3fv(e,!1,r)}}},ct[35676]={Type:Float32Array,size:64,setter:function(t,e){return function(r){t.uniformMatrix4fv(e,!1,r)}}},ct[35685]={Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix2x3fv(e,!1,r)}}},ct[35686]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix2x4fv(e,!1,r)}}},ct[35687]={Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix3x2fv(e,!1,r)}}},ct[35688]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix3x4fv(e,!1,r)}}},ct[35689]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix4x2fv(e,!1,r)}}},ct[35690]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix4x3fv(e,!1,r)}}},ct[35678]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:3553},ct[35680]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:34067},ct[35679]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:32879},ct[35682]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:3553},ct[36289]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:35866},ct[36292]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:35866},ct[36293]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:34067},ct[36298]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:3553},ct[36299]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:32879},ct[36300]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:34067},ct[36303]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:35866},ct[36306]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:3553},ct[36307]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:32879},ct[36308]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:34067},ct[36311]={Type:null,size:0,setter:vt,arraySetter:bt,bindPoint:35866};const Tt={};function Pt(t){const e=t.name;return e.startsWith("gl_")||e.startsWith("webgl_")}function St(t,e){const r=t.uniformSetters||t,i=arguments.length;for(let t=1;t<i;++t){const e=arguments[t];if(Array.isArray(e)){const t=e.length;for(let i=0;i<t;++i)St(r,e[i])}else for(const t in e){const i=r[t];i&&i(e[t])}}}function _t(t,e){const r={program:e,uniformSetters:function(t,e){let r=0;function i(e,i,n){const o=i.size>1&&"[0]"===i.name.substr(-3),s=i.type,a=ct[s];if(!a)throw new Error("unknown type: 0x"+s.toString(16));let u;if(a.bindPoint){const e=r;r+=i.size,u=o?a.arraySetter(t,s,e,n,i.size):a.setter(t,s,e,n,i.size)}else u=a.arraySetter&&o?a.arraySetter(t,n):a.setter(t,n);return u.location=n,u}const n={},o=t.getProgramParameter(e,35718);for(let r=0;r<o;++r){const o=t.getActiveUniform(e,r);if(Pt(o))continue;let s=o.name;"[0]"===s.substr(-3)&&(s=s.substr(0,s.length-3));const a=t.getUniformLocation(e,o.name);a&&(n[s]=i(0,o,a))}return n}(t,e),attribSetters:function(t,e){const r={},i=t.getProgramParameter(e,35721);for(let n=0;n<i;++n){const i=t.getActiveAttrib(e,n);if(Pt(i))continue;const o=t.getAttribLocation(e,i.name),s=Tt[i.type],a=s.setter(t,o,s);a.location=o,r[i.name]=a}return r}(t,e)};return ft(t)&&(r.uniformBlockSpec=function(t,e){const r=t.getProgramParameter(e,35718),i=[],n=[];for(let o=0;o<r;++o){n.push(o),i.push({});const r=t.getActiveUniform(e,o);if(Pt(r))break;i[o].name=r.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(r){const o=r[0],s=r[1];t.getActiveUniforms(e,n,t[o]).forEach((function(t,e){i[e][s]=t}))}));const o={},s=t.getProgramParameter(e,35382);for(let r=0;r<s;++r){const i=t.getActiveUniformBlockName(e,r),n={index:t.getUniformBlockIndex(e,i),usedByVertexShader:t.getActiveUniformBlockParameter(e,r,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(e,r,35398),size:t.getActiveUniformBlockParameter(e,r,35392),uniformIndices:t.getActiveUniformBlockParameter(e,r,35395)};n.used=n.usedByVertexShader||n.usedByFragmentShader,o[i]=n}return{blockSpecs:o,uniformData:i}}(t,e),r.transformFeedbackInfo=function(t,e){const r={},i=t.getProgramParameter(e,35971);for(let n=0;n<i;++n){const i=t.getTransformFeedbackVarying(e,n);r[i.name]={index:n,type:i.type,size:i.size}}return r}(t,e)),r}Tt[5126]={size:4,setter:wt},Tt[35664]={size:8,setter:wt},Tt[35665]={size:12,setter:wt},Tt[35666]={size:16,setter:wt},Tt[5124]={size:4,setter:At},Tt[35667]={size:8,setter:At},Tt[35668]={size:12,setter:At},Tt[35669]={size:16,setter:At},Tt[5125]={size:4,setter:Ft},Tt[36294]={size:8,setter:Ft},Tt[36295]={size:12,setter:Ft},Tt[36296]={size:16,setter:Ft},Tt[35670]={size:4,setter:At},Tt[35671]={size:8,setter:At},Tt[35672]={size:12,setter:At},Tt[35673]={size:16,setter:At},Tt[35674]={size:4,setter:xt,count:2},Tt[35675]={size:9,setter:xt,count:3},Tt[35676]={size:16,setter:xt,count:4};var Et="#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}",Ut=function(){function t(e,r,n,o){var s=this;void 0===r&&(r=640),void 0===n&&(n=480),void 0===o&&(o={}),this.refs={programs:[],shaders:[],textures:[],buffers:[],framebuffers:[]},this.isCtxLost=!1,this.handleContextLoss=function(t){t.preventDefault(),s.destroy(),s.isCtxLost=!0,s.options.onlost()},this.handleContextRestored=function(t){s.isCtxLost=!1,s.init(),s.options.onrestored()},d(),this.el=e,this.width=r,this.height=n,this.options=i(i({},t.defaultOptions),o),e.addEventListener("webglcontextlost",this.handleContextLoss,!1),e.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.gl=e.getContext("webgl",{antialias:!1,alpha:!0}),this.init()}return t.prototype.init=function(){var t=this.gl;this.layerDrawProgram=this.createProgram(Et,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_palette;uniform sampler2D u_bitmap;uniform float u_paletteOffset;const vec4 transparent=vec4(0,0,0,0);void main(){float index=texture2D(u_bitmap,v_uv).a*255.;if(index>0.){gl_FragColor=texture2D(u_palette,vec2((u_paletteOffset+index)/8.,.5));}else{gl_FragColor=transparent;}}"),this.postProcessProgram=this.createProgram(Et,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,8,8),this.setBuffersAndAttribs(this.layerDrawProgram,this.quadBuffer),this.setBuffersAndAttribs(this.postProcessProgram,this.quadBuffer),this.paletteData=new Uint8Array(32),this.paletteTexture=this.createTexture(t.RGBA,t.NEAREST,t.CLAMP_TO_EDGE,8,1),this.layerTexture=this.createTexture(t.ALPHA,t.NEAREST,t.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameBuffer=this.createFrameBuffer(this.frameTexture),this.setCanvasSize(this.width,this.height)},t.prototype.createProgram=function(t,e){h(!this.isCtxLost);var r=this.gl,i=this.createShader(r.VERTEX_SHADER,t),n=this.createShader(r.FRAGMENT_SHADER,e),o=r.createProgram();if(r.attachShader(o,i),r.attachShader(o,n),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS)){var s=r.getProgramInfoLog(o);throw r.deleteProgram(o),new Error(s)}var a=_t(r,o);return this.refs.programs.push(o),a},t.prototype.createShader=function(t,e){h(!this.isCtxLost);var r=this.gl,i=r.createShader(t);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){var n=r.getShaderInfoLog(i);throw r.deleteShader(i),new Error(n)}return this.refs.shaders.push(i),i},t.prototype.createScreenQuad=function(t,e,r,i,n,o){h(!this.isCtxLost);for(var s=(n+1)*(o+1),a=n+1,u=new Float32Array(2*s),f=new Float32Array(2*s),c=0,d=0,l=0;l<=o;l++)for(var p=0;p<=n;p++){var m=p/n,y=l/o;u[c++]=t+r*m,u[c++]=e+i*y,f[d++]=m,f[d++]=y}var g=new Uint16Array(n*o*2*3),v=0;for(l=0;l<o;l++)for(p=0;p<n;p++)g[v++]=(l+0)*a+p,g[v++]=(l+1)*a+p,g[v++]=(l+0)*a+p+1,g[v++]=(l+0)*a+p+1,g[v++]=(l+1)*a+p,g[v++]=(l+1)*a+p+1;var b=ht(this.gl,{position:{numComponents:2,data:u},texcoord:{numComponents:2,data:f},indices:g});for(var w in b.attribs)this.refs.buffers.push(b.attribs[w].buffer);return b},t.prototype.setBuffersAndAttribs=function(t,e){var r=this.gl;!function(t,e){for(const r in e){const i=t[r];i&&i(e[r])}}(t.attribSetters,e.attribs),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,e.indices)},t.prototype.createTexture=function(t,e,r,i,n){void 0===i&&(i=1),void 0===n&&(n=1),h(!this.isCtxLost);var o=this.gl,s=o.createTexture();return o.bindTexture(o.TEXTURE_2D,s),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,r),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,r),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,e),o.texImage2D(o.TEXTURE_2D,0,t,i,n,0,t,o.UNSIGNED_BYTE,null),this.refs.textures.push(s),s},t.prototype.createFrameBuffer=function(t){h(!this.isCtxLost);var e=this.gl,r=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,r),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),this.refs.framebuffers.push(r),r},t.prototype.setCanvasSize=function(t,e){h(!this.isCtxLost);var r=window.devicePixelRatio||1,i=t*r,n=e*r;this.width=t,this.height=e,this.el.width=i,this.el.height=n,this.screenWidth=i,this.screenHeight=n,this.el.style.width=t+"px",this.el.style.height=e+"px"},t.prototype.setInputSize=function(t,e){var r=this.gl;this.textureWidth=t,this.textureHeight=e,r.bindTexture(r.TEXTURE_2D,this.frameTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.textureWidth,this.textureHeight,0,r.RGBA,r.UNSIGNED_BYTE,null)},t.prototype.clearFrameBuffer=function(t){h(!this.isCtxLost);var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),e.viewport(0,0,this.textureWidth,this.textureHeight);var r=t[0],i=t[1],n=t[2],o=t[3];e.clearColor(r/255,i/255,n/255,o/255),e.clear(e.COLOR_BUFFER_BIT)},t.prototype.setPalette=function(t){h(!this.isCtxLost),h(t.length<16);for(var e=this.gl,r=this.paletteData.fill(0),i=0,n=0;n<t.length;n++){var o=t[n],s=o[0],a=o[1],u=o[2],f=o[3];r[i++]=s,r[i++]=a,r[i++]=u,r[i++]=f}e.bindTexture(e.TEXTURE_2D,this.paletteTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,8,1,0,e.RGBA,e.UNSIGNED_BYTE,r)},t.prototype.drawPixels=function(t,e){var r=this,i=r.gl,n=r.layerDrawProgram,o=r.layerTexture,s=r.textureWidth,a=r.textureHeight;h(!this.isCtxLost),h(t.length===s*a),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.viewport(0,0,s,a),i.useProgram(n.program),i.bindTexture(i.TEXTURE_2D,o),i.texImage2D(i.TEXTURE_2D,0,i.ALPHA,s,a,0,i.ALPHA,i.UNSIGNED_BYTE,t),St(n,{u_palette:this.paletteTexture,u_paletteOffset:e,u_bitmap:o,u_textureSize:[s,a],u_screenSize:[i.drawingBufferWidth,i.drawingBufferHeight]}),i.drawElements(i.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.composite=function(){var t=this.gl;h(!this.isCtxLost),t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.useProgram(this.postProcessProgram.program),t.clear(t.COLOR_BUFFER_BIT),St(this.postProcessProgram,{u_flipY:!0,u_tex:this.frameTexture,u_textureSize:[this.textureWidth,this.textureHeight],u_screenSize:[t.drawingBufferWidth,t.drawingBufferHeight]}),t.drawElements(t.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.isErrorState=function(){var t=this.gl,e=t.getError();return e!=t.NO_ERROR&&e!=t.CONTEXT_LOST_WEBGL},t.prototype.isLost=function(){return this.gl.isContextLost()},t.prototype.destroy=function(){return n(this,void 0,void 0,(function(){var t,e;return o(this,(function(r){return t=this.refs,e=this.gl,t.shaders.forEach((function(t){e.deleteShader(t)})),t.shaders=[],t.framebuffers.forEach((function(t){e.deleteFramebuffer(t)})),t.framebuffers=[],t.textures.forEach((function(t){e.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){e.deleteBuffer(t)})),t.buffers=[],t.programs.forEach((function(t){e.deleteProgram(t)})),t.programs=[],this.paletteData=null,e.canvas.width=1,e.canvas.height=1,[2]}))}))},t.defaultOptions={onlost:function(){},onrestored:function(){}},t}(),kt=c?window.AudioContext||window.webkitAudioContext:null,Bt=function(){function t(){this.useEq=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this._volume=1,this._loop=!1,this.nodeRefs=[],d()}return Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t,this.source&&(this.source.loop=t)},enumerable:!1,configurable:!0}),t.prototype.getCtx=function(){return this.ctx||(this.ctx=new kt),this.ctx},t.prototype.setBuffer=function(t,e){var r=this.getCtx(),i=t.length,n=r.createBuffer(1,i,e),o=n.getChannelData(0);if(t instanceof Float32Array)o.set(t,0);else if(t instanceof Int16Array)for(var s=0;s<i;s++)o[s]=t[s]/32768;this.buffer=n,this.sampleRate=e},t.prototype.connectEqNodesTo=function(t){var e=this,r=this.getCtx(),i=this.eqSettings,n=t;return i.forEach((function(t,o){var s=t[0],a=t[1],u=r.createBiquadFilter();e.nodeRefs.push(u),u.frequency.value=s,u.gain.value=a,0===o?u.type="lowshelf":o===i.length-1?u.type="highshelf":u.type="peaking",n.connect(u),n=u})),n},t.prototype.initNodes=function(){var t=this.getCtx();this.nodeRefs=[];var e=t.createBufferSource();this.nodeRefs.push(e),e.buffer=this.buffer;var r=t.createGain();(this.nodeRefs.push(r),this.useEq)?this.connectEqNodesTo(e).connect(r):e.connect(r);e.connect(r),r.connect(t.destination),this.source=e,this.gainNode=r,this.setVolume(this._volume)},t.prototype.setVolume=function(t){this._volume=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))},t.prototype.playFrom=function(t){this.initNodes(),this.source.loop=this._loop,this.source.start(0,t)},t.prototype.stop=function(){this.source&&this.source.stop(0)},t.prototype.destroy=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return this.stop(),t=this.getCtx(),this.nodeRefs.forEach((function(t){return t.disconnect()})),this.nodeRefs=[],"closed"===t.state||"function"!=typeof t.close?[3,2]:[4,t.close()];case 1:e.sent(),e.label=2;case 2:return this.buffer=null,[2]}}))}))},t}();function Ct(t){return{length:t.length,start:function(e){return t[e][0]},end:function(e){return t[e][1]}}}function Lt(t,e){return t.toString().padStart(e,"0")}function Mt(t){return Math.floor(t%3600/60)+":"+Lt(Math.floor(t%60),2)}var It=function(){function e(t,e,r){var i=this;this.duration=0,this.autoplay=!1,this.supportedEvents=Z,this._src=null,this._loop=!1,this._volume=1,this._muted=!1,this._frame=null,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=function(t){if(i.isPlaying){var e=t/1e3,r=e-i.playbackStartTime;r>=i.duration&&(i.loop?(i.playbackStartTime=e,i.emit(K.Loop)):(i.pause(),i.emit(K.Ended))),i.setCurrentTime(r%i.duration),i.playbackLoopId=requestAnimationFrame(i.playbackLoop)}},d(),t="string"==typeof t?document.querySelector(t):t,this.renderer=new Ut(t,e,r,{onlost:function(){return i.emit(K.Error)},onrestored:function(){return i.load()}}),this.audio=new Bt,this.canvasEl=this.renderer.el}return Object.defineProperty(e.prototype,"src",{get:function(){return this._src},set:function(t){this.load(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"paused",{get:function(){return!this.isPlaying},set:function(t){t?this.pause():this.play()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentFrame",{get:function(){return this._frame},set:function(t){this.setCurrentFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return this.isNoteLoaded?this.playbackTime:null},set:function(t){this.setCurrentTime(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"progress",{get:function(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null},set:function(t){this.setProgress(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this.getVolume()},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"muted",{get:function(){return this.getMuted()},set:function(t){this.setMuted(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loop",{get:function(){return this.getLoop()},set:function(t){this.setLoop(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"buffered",{get:function(){return Ct([[0,this.duration]])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"seekable",{get:function(){return Ct([[0,this.duration]])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentSrc",{get:function(){return this._src},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"videoWidth",{get:function(){return this.isNoteLoaded?this.note.width:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"videoHeight",{get:function(){return this.isNoteLoaded?this.note.height:0},enumerable:!1,configurable:!0}),e.prototype.load=function(t){return void 0===t&&(t=null),n(this,void 0,void 0,(function(){var e=this;return o(this,(function(r){return this.isNoteLoaded&&this.closeNote(),t?(this.emit(K.LoadStart),[2,Y(t).then((function(r){e.openNote(r),e._src=t})).catch((function(t){throw e.emit(K.Error,t),new Error("Error loading Flipnote: "+t.message)}))]):[2,this.openNote(this.note)]}))}))},e.prototype.closeNote=function(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this._src=null,this._frame=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clearFrameBuffer([0,0,0,0])},e.prototype.openNote=function(t){this.isNoteLoaded&&this.closeNote(),this.note=t,this.meta=t.meta,this.emit(K.LoadedMeta),this.noteFormat=t.format,this.duration=t.duration,this.playbackTime=0,this._frame=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=t.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(t.getAudioMasterPcm(),t.sampleRate),this.emit(K.CanPlay),this.emit(K.CanPlayThrough),this.setLoop(t.meta.loop),this.renderer.setInputSize(t.width,t.height),this.drawFrame(t.thumbFrameIndex),this.emit(K.LoadedData),this.emit(K.Load),this.emit(K.Ready),this.autoplay&&this.play()},e.prototype.setCurrentTime=function(t){this.assertNoteLoaded();var e=Math.floor(t/(1/this.framerate));this.setCurrentFrame(e),this.playbackTime=t,this.emit(K.Progress,this.progress)},e.prototype.getCurrentTime=function(){return this.currentTime},e.prototype.getTimeCounter=function(){return Mt(Math.max(this.currentTime,0))+" / "+Mt(this.duration)},e.prototype.getFrameCounter=function(){return Lt(this.currentFrame+1,3)+" / "+Lt(this.frameCount,3)},e.prototype.setProgress=function(t){this.assertNoteLoaded(),f(t,0,100,"progress"),this.currentTime=this.duration*(t/100)},e.prototype.getProgress=function(){return this.progress},e.prototype.play=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){return this.assertNoteLoaded(),this.isPlaying||(this.isPlaying=!0,this.hasPlaybackStarted=!0,t=performance.now(),this.playbackStartTime=t/1e3-this.playbackTime,this.playAudio(),this.playbackLoop(t),this.emit(K.Play)),[2]}))}))},e.prototype.pause=function(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(K.Pause))},e.prototype.togglePlay=function(){this.isPlaying?this.pause():this.play()},e.prototype.getPaused=function(){return!this.isPlaying},e.prototype.getDuration=function(){return this.duration},e.prototype.getLoop=function(){return this._loop},e.prototype.setLoop=function(t){this._loop=t,this.audio.loop=t},e.prototype.toggleLoop=function(){this.setLoop(!this._loop)},e.prototype.setCurrentFrame=function(t){this.assertNoteLoaded();var e=Math.max(0,Math.min(Math.floor(t),this.frameCount-1));(e!==this.currentFrame||this.showThumbnail)&&(this._frame=e,this.drawFrame(e),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=e*(1/this.framerate),this.emit(K.SeekEnd)),this.emit(K.FrameUpdate,this.currentFrame),this.emit(K.Progress,this.progress),this.emit(K.TimeUpdate,this.currentFrame))},e.prototype.nextFrame=function(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(K.FrameNext)},e.prototype.prevFrame=function(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(K.FramePrev)},e.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1,this.emit(K.FrameLast)},e.prototype.firstFrame=function(){this.currentFrame=0,this.emit(K.FrameFirst)},e.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},e.prototype.startSeek=function(){this.isSeeking||(this.emit(K.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)},e.prototype.seek=function(t){this.isSeeking&&(this.progress=100*t)},e.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},e.prototype.drawFrame=function(e){var r=this.note,i=this.renderer,n=r.getFramePalette(e),o=r.decodeFrame(e),s=this.layerVisibility;if(i.setPalette(n),i.clearFrameBuffer(n[0]),r.format===t.FlipnoteFormat.PPM)s[2]&&i.drawPixels(o[1],1),s[1]&&i.drawPixels(o[0],0);else if(r.format===t.FlipnoteFormat.KWZ){var a=r.getFrameLayerOrder(e),u=a[0],h=a[1],f=a[2];s[u+1]&&i.drawPixels(o[u],2*u),s[h+1]&&i.drawPixels(o[h],2*h),s[f+1]&&i.drawPixels(o[f],2*f)}i.composite()},e.prototype.forceUpdate=function(){this.isNoteLoaded&&this.drawFrame(this.currentFrame)},e.prototype.resize=function(t,e){e!==.75*t&&console.warn("Canvas width to height ratio should be 3:4 for best results (got "+t+"x"+e+")"),this.renderer.setCanvasSize(t,e),this.forceUpdate()},e.prototype.setLayerVisibility=function(t,e){this.layerVisibility[t]=e,this.forceUpdate()},e.prototype.getLayerVisibility=function(t){return this.layerVisibility[t]},e.prototype.toggleLayerVisibility=function(t){this.setLayerVisibility(t,!this.layerVisibility[t])},e.prototype.playAudio=function(){this.audio.playFrom(this.currentTime)},e.prototype.stopAudio=function(){this.audio.stop()},e.prototype.toggleAudioEq=function(){this.setAudioEq(!this.audio.useEq)},e.prototype.setAudioEq=function(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())},e.prototype.mute=function(){this.setMuted(!0)},e.prototype.unmute=function(){this.setMuted(!1)},e.prototype.setMuted=function(t){this.audio.volume=t?0:this._volume,this._muted=t,this.emit(K.VolumeChange,this.audio.volume)},e.prototype.getMuted=function(){return 0===this.volume||this._muted},e.prototype.toggleMuted=function(){this.setMuted(!this._muted)},e.prototype.setVolume=function(t){f(t,0,1,"volume"),this._volume=t,this.audio.volume=t,this.emit(K.VolumeChange,this.audio.volume)},e.prototype.getVolume=function(){return this._muted?0:this._volume},e.prototype.seekToNextFrame=function(){this.nextFrame()},e.prototype.fastSeek=function(t){this.currentTime=t},e.prototype.canPlayType=function(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";case"video/vnd.nintendo.ugomemo.fykt":default:return""}},e.prototype.getVideoPlaybackQuality=function(){return{creationTime:0,droppedVideoFrames:0,totalVideoFrames:this.frameCount}},e.prototype.requestPictureInPicture=function(){throw new Error("Not implemented")},e.prototype.captureStream=function(){throw new Error("Not implemented")},e.prototype.on=function(t,e){var r=this.events;(Array.isArray(t)?t:[t]).forEach((function(t){r.has(t)?r.get(t).push(e):r.set(t,[e])}))},e.prototype.off=function(t,e){var r=this.events;(Array.isArray(t)?t:[t]).forEach((function(t){if(r.has(t)){var i=r.get(t);r.set(t,i.splice(i.indexOf(e),1))}}))},e.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var i=this.events;if(t!==K.__Any&&i.has(t)){i.get(t).forEach((function(t){return t.apply(null,e)}));var n="on"+t,o=this;"function"==typeof o[n]&&o[n].apply(null,e)}i.has(K.__Any)&&i.get(K.__Any).forEach((function(r){return r.apply(null,s([t],e))}))},e.prototype.clearEvents=function(){this.events.clear()},e.prototype.destroy=function(){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return this.clearEvents(),this.emit(K.Destroy),this.closeNote(),[4,this.renderer.destroy()];case 1:return t.sent(),[4,this.audio.destroy()];case 2:return t.sent(),[2]}}))}))},e.prototype.supports=function(t){var e=this.supportedEvents.includes(t),r="function"==typeof this[t];return e||r},e.prototype.assertNoteLoaded=function(){h(this.isNoteLoaded,"No Flipnote is currently loaded in this player")},e}(),Rt=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],zt=function(){function t(t,e,r){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.colorDepth=r,this.reset()}return t.prototype.reset=function(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0},t.prototype.char_out=function(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var e=0;e<t;++e)this.htab[e]=-1},t.prototype.compress=function(t,e){var r,i,n,o,s,a;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,o=this.nextPixel(),a=0,r=5003;r<65536;r*=2)++a;a=8-a,this.cl_hash(5003),this.output(this.ClearCode,e);t:for(;-1!=(i=this.nextPixel());)if(r=(i<<12)+o,n=i<<a^o,this.htab[n]!==r){if(this.htab[n]>=0){s=5003-n,0===n&&(s=1);do{if((n-=s)<0&&(n+=5003),this.htab[n]===r){o=this.codetab[n];continue t}}while(this.htab[n]>=0)}this.output(o,e),o=i,this.free_ent<4096?(this.codetab[n]=this.free_ent++,this.htab[n]=r):this.cl_block(e)}else o=this.codetab[n];this.output(o,e),this.output(this.EOFCode,e)},t.prototype.encode=function(t,e){this.pixels=t,e.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,e),e.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,e){for(this.cur_accum&=Rt[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}},t}(),Dt=function(){function t(e,r,n){void 0===n&&(n={}),this.frameCount=0,this.dataUrl=null,this.width=e,this.height=r,this.data=new a,this.settings=i(i({},t.defaultSettings),n),this.compressor=new zt(e,r,n.colorDepth)}return t.fromFlipnote=function(e,r){void 0===r&&(r={});var n=new t(e.width,e.height,i({delay:100/e.framerate,repeat:e.meta.loop?-1:0},r));n.palette=e.globalPalette;for(var o=0;o<e.frameCount;o++)n.writeFrame(e.getFramePixels(o));return n},t.fromFlipnoteFrame=function(e,r,n){void 0===n&&(n={});var o=new t(e.width,e.height,i({delay:100/e.framerate,repeat:-1},n));return o.palette=e.globalPalette,o.writeFrame(e.getFramePixels(r)),o},t.prototype.writeFrame=function(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1},t.prototype.writeFirstFrame=function(t){for(var e=this.palette.length,r=1;1<<r<e;r+=1)continue;this.settings.colorDepth=r,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt(),this.writeFrameHeader(),this.writePixels(t)},t.prototype.writeAdditionalFrame=function(t){this.writeFrameHeader(),this.writePixels(t)},t.prototype.writeHeader=function(){var t=new u(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.settings.colorDepth-1),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.settings.colorDepth)),e=0,r=0;r<this.palette.length;r+=1){var i=this.palette[r],n=i[0],o=i[1],s=i[2];i[3];t[e++]=n,t[e++]=o,t[e++]=s}this.data.writeBytes(t)},t.prototype.writeNetscapeExt=function(){var t=new u(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.settings.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeFrameHeader=function(){var t=new u(new ArrayBuffer(18)),e=this.settings.transparentBg?1:0;t.writeBytes([33,249,4,0|e]),t.writeUint16(this.settings.delay),t.writeBytes([0,0]),t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writePixels=function(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)},t.prototype.getArrayBuffer=function(){return this.data.getBuffer()},t.prototype.getBuffer=function(){return p(),Buffer.from(this.getArrayBuffer())},t.prototype.getBlob=function(){return d(),new Blob([this.getArrayBuffer()],{type:"image/gif"})},t.prototype.getUrl=function(){return d(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())},t.prototype.revokeUrl=function(){d(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)},t.prototype.getImage=function(){d();var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},t.defaultSettings={transparentBg:!1,delay:100,repeat:-1,colorDepth:8},t}(),Ot=function(){function t(t,e,r){void 0===e&&(e=1),void 0===r&&(r=16),this.sampleRate=t,this.channels=e,this.bitsPerSample=r;var i=new ArrayBuffer(44),n=new u(i);n.writeChars("RIFF"),n.writeUint32(0),n.writeChars("WAVE"),n.writeChars("fmt "),n.writeUint32(16),n.writeUint16(1),n.writeUint16(this.channels),n.writeUint32(this.sampleRate),n.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample),n.writeChars("data"),n.writeUint32(0),this.header=n,this.pcmData=null}return t.fromFlipnote=function(e){var r=e.sampleRate,i=new t(r,1,16),n=e.getAudioMasterPcm(r);return i.writeFrames(n),i},t.fromFlipnoteTrack=function(e,r){var i=e.sampleRate,n=new t(i,1,16),o=e.getAudioTrackPcm(r,i);return n.writeFrames(o),n},t.prototype.writeFrames=function(t){var e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t},t.prototype.getArrayBuffer=function(){var t=this.header.bytes,e=new Uint8Array(this.pcmData.buffer),r=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return r.set(t),r.set(e,t.byteLength),r.buffer},t.prototype.getBuffer=function(){return p(),Buffer.from(this.getArrayBuffer())},t.prototype.getBlob=function(){d();var t=this.getArrayBuffer();return new Blob([t],{type:"audio/wav"})},t}();t.GifImage=Dt,t.KwzParser=X,t.Player=It,t.PpmParser=U,t.WavAudio=Ot,t.parseSource=Y,t.version="5.1.1",Object.defineProperty(t,"__esModule",{value:!0})}));
