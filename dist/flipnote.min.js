/*!
 * flipnote.js v3.0.0-beta
 * Browser-based playback of .ppm and .kwz animations from Flipnote Studio and Flipnote Studio 3D
 * 2018 - 2019 James Daniel
 * github.com/jaames/flipnote.js
 * Flipnote Studio is (c) Nintendo Co., Ltd.
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.flipnote=e():t.flipnote=e()}("undefined"!=typeof self?self:this,function(){return function(t){var e={};function i(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(r,s,function(e){return t[e]}.bind(null,s));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=2)}([function(t,e){t.exports="#define GLSLIFY 1\nattribute vec4 a_position;\nvarying vec2 v_texel;\nvarying float v_scale;\nuniform vec2 u_textureSize;\nuniform vec2 u_screenSize;\n\nvoid main() {\n  gl_Position = a_position;\n  vec2 uv = a_position.xy * 0.5 + 0.5;\n  v_texel = uv * u_textureSize;\n  v_scale = floor(u_screenSize.y / u_textureSize.y + 0.01);\n}"},function(t,e){t.exports="precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_texel;\nvarying float v_scale;\nuniform vec4 u_color1;\nuniform vec4 u_color2;\nuniform sampler2D u_bitmap;\nuniform bool u_isSmooth;\nuniform vec2 u_textureSize;\nuniform vec2 u_screenSize;\n\nvoid main() {\n  vec2 texel_floored = floor(v_texel);\n  vec2 s = fract(v_texel);\n  float region_range = 0.5 - 0.5 / v_scale;\n  vec2 center_dist = s - 0.5;\n  vec2 f = (center_dist - clamp(center_dist, -region_range, region_range)) * v_scale + 0.5;\n  vec2 mod_texel = texel_floored + f;\n  vec2 coord = mod_texel.xy / u_textureSize.xy;\n  vec2 colorWeights = texture2D(u_bitmap, coord).ra;\n  gl_FragColor = vec4(u_color1.rgb, 1.0) * colorWeights.y + vec4(u_color2.rgb, 1.0) * colorWeights.x;\n}"},function(t,e,i){t.exports=i(3)},function(t,e,i){"use strict";var r;i.r(e),function(t){t[t.Begin=0]="Begin",t[t.Current=1]="Current",t[t.End=2]="End"}(r||(r={}));var s=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.cursor=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!0,configurable:!0}),t.prototype.seek=function(t,e){switch(e){case r.End:this.cursor=this.data.byteLength+t;break;case r.Current:this.cursor+=t;break;case r.Begin:default:this.cursor=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.cursor);return this.cursor+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.cursor,t),this.cursor+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.cursor);return this.cursor+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.cursor,t),this.cursor+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var e=this.data.getUint16(this.cursor,t);return this.cursor+=2,e},t.prototype.writeUint16=function(t,e){void 0===e&&(e=!0),this.data.setUint16(this.cursor,t,e),this.cursor+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var e=this.data.getInt16(this.cursor,t);return this.cursor+=2,e},t.prototype.writeInt16=function(t,e){void 0===e&&(e=!0),this.data.setInt16(this.cursor,t,e),this.cursor+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var e=this.data.getUint32(this.cursor,t);return this.cursor+=4,e},t.prototype.writeUint32=function(t,e){void 0===e&&(e=!0),this.data.setUint32(this.cursor,t,e),this.cursor+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var e=this.data.getInt32(this.cursor,t);return this.cursor+=4,e},t.prototype.writeInt32=function(t,e){void 0===e&&(e=!0),this.data.setInt32(this.cursor,t,e),this.cursor+=4},t.prototype.readBytes=function(t){var e=new Uint8Array(this.data.buffer,this.cursor,t);return this.cursor+=e.byteLength,e},t.prototype.writeBytes=function(t){var e=this;t.forEach(function(t){return e.writeUint8(t)})},t.prototype.readHex=function(t,e){void 0===e&&(e=!1);for(var i=this.readBytes(t),r=[],s=0;s<i.length;s++)r.push(i[s].toString(16).padStart(2,"0"));return e&&r.reverse(),r.join("").toUpperCase()},t.prototype.readUtf8=function(t){for(var e=this.readBytes(t),i="",r=0;r<e.length;r++){var s=e[r];if(0==s)break;i+=String.fromCharCode(s)}return i},t.prototype.writeUtf8=function(t){for(var e=0;e<t.length;e++){var i=t.charCodeAt(e);this.writeUint8(i)}},t.prototype.readUtf16=function(t){var e=new Uint16Array(this.data.buffer,this.cursor,t);this.cursor+=e.byteLength;for(var i="",r=0;r<e.length;r++){var s=e[r];if(0==s)break;i+=String.fromCharCode(s)}return i},t}(),n=[{matches:function(t){return"string"==typeof t},load:function(t,e,i){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(t){4===r.readyState&&(r.status>=200&&r.status<300?e(r.response):i({type:"httpError",status:r.status,statusText:r.statusText}))},r.send(null)}},{matches:function(t){return t instanceof File},load:function(t,e,i){var r=new FileReader;r.onload=function(t){e(r.result)},r.onerror=function(t){i({type:"fileReadError"})},r.readAsArrayBuffer(t)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,i){e(t)}}];for(var a=new Int8Array([-1,2,-1,2]),o=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),h=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),u=new Int16Array(360),f=0;f<4;f++)for(var c=0;c<90;c++){var d=(l=h[c])>>3;1&f&&(d+=l),2&f&&(d=-d),u[f+4*c]=d}var p=new Int16Array(1440);for(f=0;f<16;f++)for(c=0;c<90;c++){var l;d=(l=h[c])>>3;4&f&&(d+=l),2&f&&(d+=l>>1),1&f&&(d+=l>>2),8&f&&(d=-d),p[f+16*c]=d}for(var y=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),m=[null,.5,1,2,4,6,12,20,30],g={WHITE:[255,255,255],BLACK:[14,14,14],RED:[255,42,42],BLUE:[10,57,255]},b=function(t){function e(i){var r=t.call(this,i)||this;return r.type=e.type,r.width=e.width,r.height=e.height,r.palette=g,r.globalPalette=e.globalPalette,r.sampleRate=e.sampleRate,r.prevDecodedFrame=null,r.decodeHeader(),r.decodeAnimationHeader(),r.decodeSoundHeader(),r.decodeMeta(),r.layers=[new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height)],r.prevLayers=[new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height)],r.prevDecodedFrame=null,r}return y(e,t),e.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},e.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},e.prototype.readFilename=function(){return[this.readHex(3),this.readUtf8(13),this.readUint16().toString().padStart(3,"0")].join("_")},e.prototype.readLineEncoding=function(){for(var t=new Uint8Array(e.height),i=0;i<48;i++)for(var r=this.readUint8(),s=0;s<8;s+=2)t[4*i+s/2]=r>>s&3;return t},e.prototype.decodeHeader=function(){this.seek(0);this.readUint32();this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},e.prototype.decodeMeta=function(){this.seek(16);var t=this.readUint16(),e=this.readInt16(),i=this.readUtf16(11),r=this.readUtf16(11),s=this.readUtf16(11),n=this.readHex(8,!0),a=this.readHex(8,!0),o=this.readFilename(),h=this.readFilename(),u=this.readHex(8,!0);this.seek(154);var f=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=e,this.meta={lock:1===t,loop:1==(c>>1&1),frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:e,timestamp:f,spinoff:a!==n||a!==u,root:{filename:null,username:i,fsid:u},parent:{username:r,fsid:n,filename:o},current:{username:s,fsid:a,filename:h}}},e.prototype.decodeAnimationHeader=function(){var t=this;this.seek(1696);var e=this.readUint16();this.seek(1704),this.frameOffsets=new Uint32Array(e/4).map(function(i){return 1704+e+t.readUint32()})},e.prototype.decodeSoundHeader=function(){var t=1696+this.frameDataLength+this.frameCount;t%2!=0&&(t+=4-t%4),this.seek(t);var e=this.readUint32(),i=this.readUint32(),r=this.readUint32(),s=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),t+=32,this.framerate=m[this.frameSpeed],this.bgmrate=m[this.bgmSpeed],this.soundMeta={bgm:{offset:t,length:e},se1:{offset:t+=e,length:i},se2:{offset:t+=i,length:r},se3:{offset:t+=r,length:s}}},e.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},e.prototype.getFramePalette=function(t){this.seek(this.frameOffsets[t]);var e=this.palette,i=this.readUint8(),r=1&i,s=[e.BLACK,1==r?e.BLACK:e.WHITE,e.RED,e.BLUE];return[1==r?e.WHITE:e.BLACK,s[i>>1&3],s[i>>3&3]]},e.prototype.getLayerOrder=function(t){return[0,1]},e.prototype.decodeFrame=function(t){0===t||this.prevDecodedFrame===t-1||this.isNewFrame(t)||this.decodeFrame(t-1),this.seek(this.frameOffsets[t]);var i=this.readUint8(),r=i>>7&1,s=i>>5&3,n=0,a=0;this.prevLayers[0].set(this.layers[0]),this.prevLayers[1].set(this.layers[1]),this.prevDecodedFrame=t,this.layers[0].fill(0),this.layers[1].fill(0),s&&(n=this.readInt8(),a=this.readInt8());for(var o=[this.readLineEncoding(),this.readLineEncoding()],h=0;h<2;h++)for(var u=this.layers[h],f=0;f<e.height;f++){var c=o[h][f],d=f*e.width;switch(c){case 0:break;case 1:case 2:var p=this.readUint32(!1);for(2==c&&u.fill(255,d,d+e.width);4294967295&p;){if(2147483648&p)for(var l=this.readUint8(),y=0;y<8;y++)u[d+y]=l>>y&1?255:0;d+=8,p<<=1}break;case 3:for(;d<(f+1)*e.width;){for(l=this.readUint8(),y=0;y<8;y++)u[d+y]=l>>y&1?255:0;d+=8}}}if(!r)for(var m=void 0,g=void 0,b=0;b<e.height;b++)if(!(b-a<0)){if(b-a>=e.height)break;for(var v=0;v<e.width;v++)if(!(v-n<0)){if(v-n>=e.width)break;g=(m=v+b*e.width)-(n+a*e.width),this.layers[0][m]^=this.prevLayers[0][g],this.layers[1][m]^=this.prevLayers[1][g]}}return this.layers},e.prototype.getLayerPixels=function(t,i){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.layers[i],s=new Uint8Array(e.width*e.height),n=i+1,a=0;a<s.length;a++)0!==r[a]&&(s[a]=n);return s},e.prototype.getFramePixels=function(t,i){var r;(void 0===i&&(i=!1),i)?r=this.getFramePalette(t).map(function(t){return e.globalPalette.indexOf(t)}):r=[0,1,2];var s=this.decodeFrame(t),n=new Uint8Array(e.width*e.height);n.fill(r[0]);for(var a=0;a<n.length;a++){var o=s[0][a];s[1][a]&&(n[a]=r[2]),o&&(n[a]=r[1])}return n},e.prototype.hasAudioTrack=function(t){var e=["bgm","se1","se2","se3"][t];return this.soundMeta[e].length>0},e.prototype.decodeAudio=function(t){for(var e,i,r,s=this.soundMeta[t],n=new Uint8Array(this.buffer,s.offset,s.length),a=new Int16Array(2*n.length),h=0,u=0,f=0,c=0;c<n.length;c++)for(var d=n[c],l=0;l<8;)i=u+p[(e=d>>l&15)+16*f],r=f+o[e],r=Math.max(0,Math.min(r,79)),i=Math.max(-32767,Math.min(i,32767)),a[h]=i,h+=1,f=r,u=i,l+=4;return a},e.prototype.decodeSoundFlags=function(){var t=this;return this.seek(1696+this.frameDataLength),new Array(this.frameCount).fill([]).map(function(e){var i=t.readUint8();return[1&i,i>>1&1,i>>2&1]})},e.type="PPM",e.sampleRate=8192,e.width=256,e.height=192,e.globalPalette=[g.BLACK,g.WHITE,g.RED,g.BLUE],e}(s),v=new Uint16Array([0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740]),w=new Uint16Array([0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100]),U=new Uint16Array(6561),_=[0,3,7,1,4,8,2,5,6],A=0,x=0;x<9;x++)for(var F=0;F<9;F++)for(var P=0;P<9;P++)for(var E=0;E<9;E++)U[A]=9*(9*(9*_[x]+_[F])+_[P])+_[E],A++;var L=new Uint16Array(52488),S=(_=[0,65280,255],0);for(x=0;x<3;x++)for(F=0;F<3;F++)for(P=0;P<3;P++)for(E=0;E<3;E++)for(var T=0;T<3;T++)for(var C=0;C<3;C++)for(var k=0;k<3;k++)for(var B=0;B<3;B++)L.set([_[F],_[x],_[E],_[P],_[C],_[T],_[B],_[k]],S),S+=8;var I=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),O=[.2,.5,1,2,4,6,8,12,20,24,30],R={WHITE:[255,255,255],BLACK:[16,16,16],RED:[255,16,16],YELLOW:[255,231,0],GREEN:[0,134,49],BLUE:[0,56,206],NONE:[255,255,255]},D=function(t){function e(i){var r=t.call(this,i)||this;return r.type=e.type,r.width=e.width,r.height=e.height,r.palette=R,r.globalPalette=e.globalPalette,r.sampleRate=e.sampleRate,r.prevDecodedFrame=null,r.bitIndex=0,r.bitValue=0,r.layers=[new Uint16Array(e.width*e.height),new Uint16Array(e.width*e.height),new Uint16Array(e.width*e.height)],r.bitIndex=0,r.bitValue=0,r.load(),r}return I(e,t),e.prototype.load=function(){this.seek(0),this.sections={},this.frameMeta=[];for(var t=this.byteLength-256,e=0,i=0;e<t&&i<6;){this.seek(e);var r=this.readUtf8(4).substring(0,3),s=this.readUint32();this.sections[r]={offset:e,length:s},e+=s+8,i+=1}this.decodeMeta(),this.decodeFrameMeta(),this.decodeSoundHeader()},e.prototype.readBits=function(t){if(this.bitIndex+t>16){var e=this.readUint16();this.bitValue|=e<<16-this.bitIndex,this.bitIndex-=16}var i=(1<<t)-1,r=this.bitValue&i;return this.bitValue>>=t,this.bitIndex+=t,r},e.prototype.decodeMeta=function(){this.seek(this.sections.KFH.offset+12);var t=new Date(1e3*(this.readUint32()+946684800)),e=new Date(1e3*(this.readUint32()+946684800)),i=(this.readUint32(),this.readHex(10)),r=this.readHex(10),s=this.readHex(10),n=this.readUtf16(11),a=this.readUtf16(11),o=this.readUtf16(11),h=this.readUtf8(28),u=this.readUtf8(28),f=this.readUtf8(28),c=this.readUint16(),d=this.readUint16(),p=this.readUint16(),l=this.readUint8();this.readUint8();this.frameCount=c,this.thumbFrameIndex=d,this.frameSpeed=l,this.framerate=O[l],this.meta={lock:1==(1&p),loop:1==(p>>1&1),frame_count:c,frame_speed:l,thumb_index:d,timestamp:e,creation_timestamp:t,root:{username:n,fsid:i,filename:h},parent:{username:a,fsid:r,filename:u},current:{username:o,fsid:s,filename:f}}},e.prototype.decodeFrameMeta=function(){this.frameOffsets=new Uint32Array(this.frameCount),this.seek(this.sections.KMI.offset+8);for(var t=this.sections.KMC.offset+12,e=0;e<this.frameCount;e++){var i={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readHex(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(i),this.frameOffsets[e]=t,t+=i.layerSize[0]+i.layerSize[1]+i.layerSize[2]}},e.prototype.decodeSoundHeader=function(){var t=this.sections.KSN.offset+8;this.seek(t);var e=this.readUint32();this.bgmSpeed=e,this.bgmrate=O[e];var i=new Uint32Array(this.buffer,t+4,20);this.soundMeta={bgm:{offset:t+=28,length:i[0]},se1:{offset:t+=i[0],length:i[1]},se2:{offset:t+=i[1],length:i[2]},se3:{offset:t+=i[2],length:i[3]},se4:{offset:t+=i[3],length:i[4]}}},e.prototype.getDiffingFlag=function(t){return 7&~(this.frameMeta[t].flags>>4)},e.prototype.getLayerDepths=function(t){return this.frameMeta[t].layerDepth},e.prototype.getLayerOrder=function(t){var e=this.getLayerDepths(t);return[2,1,0].sort(function(t,i){return e[i]-e[t]})},e.prototype.decodeFrame=function(t,i,r){void 0===i&&(i=7),void 0===r&&(r=!1),r&&(i&=this.getDiffingFlag(t+1)),0!==t&&this.prevDecodedFrame!==t-1&&i&&this.decodeFrame(t-1,i=i,r=!0);for(var s=this.frameMeta[t],n=this.frameOffsets[t],a=0;a<3;a++){this.seek(n);var o=s.layerSize[a];if(n+=o,38!==o&&0!=(i>>a&1)){this.bitIndex=16,this.bitValue=0;for(var h=0,u=0;u<e.height;u+=128)for(var f=0;f<e.width;f+=128)for(var c=0;c<128;c+=8){var d=u+c;if(d>=e.height)break;for(var p=0;p<128;p+=8){var l=f+p;if(l>=e.width)break;if(h)h-=1;else{var y=d*e.width+l,m=this.layers[a],g=this.readBits(3);if(0==g){var b=v[this.readBits(5)],_=L.subarray(8*b,8*b+8);m.set(_,y),m.set(_,y+320),m.set(_,y+640),m.set(_,y+960),m.set(_,y+1280),m.set(_,y+1600),m.set(_,y+1920),m.set(_,y+2240)}else if(1==g){b=this.readBits(13),_=L.subarray(8*b,8*b+8);m.set(_,y),m.set(_,y+320),m.set(_,y+640),m.set(_,y+960),m.set(_,y+1280),m.set(_,y+1600),m.set(_,y+1920),m.set(_,y+2240)}else if(2==g){var A=this.readBits(5),x=v[A],F=w[A],P=L.subarray(8*x,8*x+8),E=L.subarray(8*F,8*F+8);m.set(P,y),m.set(E,y+320),m.set(P,y+640),m.set(E,y+960),m.set(P,y+1280),m.set(E,y+1600),m.set(P,y+1920),m.set(E,y+2240)}else if(3==g){x=this.readBits(13),F=U[x],P=L.subarray(8*x,8*x+8),E=L.subarray(8*F,8*F+8);m.set(P,y),m.set(E,y+320),m.set(P,y+640),m.set(E,y+960),m.set(P,y+1280),m.set(E,y+1600),m.set(P,y+1920),m.set(E,y+2240)}else if(4==g)for(var S=this.readBits(8),T=0;T<8;T++){b=0;b=S&1<<T?v[this.readBits(5)]:this.readBits(13);_=L.subarray(8*b,8*b+8);m.set(_,y+320*T)}else{if(5==g){h=this.readBits(5);continue}if(7==g){var C=this.readBits(2);x=0,F=0;this.readBits(1)?(x=v[this.readBits(5)],F=v[this.readBits(5)],C=(C+1)%4):(x=this.readBits(13),F=this.readBits(13));P=L.subarray(8*x,8*x+8),E=L.subarray(8*F,8*F+8);0==C?(m.set(P,y),m.set(E,y+320),m.set(P,y+640),m.set(E,y+960),m.set(P,y+1280),m.set(E,y+1600),m.set(P,y+1920),m.set(E,y+2240)):1==C?(m.set(P,y),m.set(P,y+320),m.set(E,y+640),m.set(P,y+960),m.set(P,y+1280),m.set(E,y+1600),m.set(P,y+1920),m.set(P,y+2240)):2==C?(m.set(P,y),m.set(E,y+320),m.set(P,y+640),m.set(P,y+960),m.set(E,y+1280),m.set(P,y+1600),m.set(P,y+1920),m.set(E,y+2240)):3==C&&(m.set(P,y),m.set(E,y+320),m.set(E,y+640),m.set(P,y+960),m.set(E,y+1280),m.set(E,y+1600),m.set(P,y+1920),m.set(E,y+2240))}}}}}}}return this.prevDecodedFrame=t,[new Uint8Array(this.layers[0].buffer),new Uint8Array(this.layers[1].buffer),new Uint8Array(this.layers[2].buffer)]},e.prototype.getFramePalette=function(t){var e=this.frameMeta[t].flags,i=[this.palette.WHITE,this.palette.BLACK,this.palette.RED,this.palette.YELLOW,this.palette.GREEN,this.palette.BLUE,this.palette.NONE];return[i[15&e],i[e>>8&15],i[e>>12&15],i[e>>16&15],i[e>>20&15],i[e>>24&15],i[e>>28&15]]},e.prototype.getLayerPixels=function(t,i){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.layers[i],s=new Uint8Array(e.width*e.height),n=2*i+1,a=0;a<r.length;a++){var o=r[a];65280&o?s[a]=n:255&o&&(s[a]=n+1)}return s},e.prototype.getFramePixels=function(t,i){var r,s=this;if(void 0===i&&(i=!1),i){var n=this.getFramePalette(t);r=n.map(function(t){return e.globalPalette.indexOf(t)})}else r=[0,1,2,3,4,5,6];var a=new Uint8Array(e.width*e.height);return a.fill(r[0]),this.getLayerOrder(t).forEach(function(e){for(var i=s.getLayerPixels(t,e),n=0;n<i.length;n++){var o=i[n];0!==o&&(a[n]=r[o])}}),a},e.prototype.decodeSoundFlags=function(){return this.frameMeta.map(function(t){var e=t.soundFlags;return[1&e,e>>1&1,e>>2&1,e>>3&1]})},e.prototype.hasAudioTrack=function(t){var e=["bgm","se1","se2","se3","se4"][t];return this.soundMeta[e].length>0},e.prototype.decodeAudio=function(t){for(var e,i,r,s=this.soundMeta[t],n=new Int16Array(981840),h=0,f=new Uint8Array(this.buffer,s.offset,s.length),c=0,d=40,l=0;l<f.length;l++)for(var y=f[l],m=0;m<8;)d<18||6==m?(i=c+u[(e=y>>m&3)+4*d],r=d+a[e],m+=2):(i=c+p[(e=y>>m&15)+16*d],r=d+o[e],m+=4),r=Math.max(0,Math.min(r,79)),i=Math.max(-2048,Math.min(i,2048)),n[h]=16*i,h+=1,d=r,c=i;return n.slice(0,h)},e.type="KWZ",e.sampleRate=16364,e.width=320,e.height=240,e.globalPalette=[R.BLACK,R.WHITE,R.RED,R.YELLOW,R.GREEN,R.BLUE,R.NONE],e}(s);function H(t){return function(t){return new Promise(function(e,i){for(var r=0;r<n.length;r++){var s=n[r];if(s.matches(t)){s.load(t,e,i);break}}})}(t).then(function(t){var e=new DataView(t,0,4).getUint32(0);return 1346458177===e?new b(t):1262897152==(4294967040&e)?new D(t):null})}var M,z,j=function(){function t(t,e,i){void 0===e&&(e=1),void 0===i&&(i=16),this.sampleRate=t,this.channels=e,this.bitsPerSample=i;var r=new ArrayBuffer(44),n=new s(r);n.writeUtf8("RIFF"),n.writeUint32(0),n.writeUtf8("WAVE"),n.writeUtf8("fmt "),n.writeUint32(16),n.writeUint16(1),n.writeUint16(this.channels),n.writeUint32(this.sampleRate),n.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample),n.writeUtf8("data"),n.writeUint32(0),this.header=n,this.pcmData=null}return t.prototype.writeFrames=function(t){var e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t},t.prototype.getBlob=function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})},t}(),N=function(){function t(t){this.playbackRate=1,this.id=t,this.channelCount=1,this.bitsPerSample=16,this.sampleRate=0,this.audio=document.createElement("audio"),this.audio.preload="auto",this.isActive=!1}return t.prototype.set=function(t,e){var i=new j(this.sampleRate*e,this.channelCount,this.bitsPerSample);i.writeFrames(t),this.url=window.URL.createObjectURL(i.getBlob()),this.audio.src=this.url,this.isActive=!0,this.playbackRate=e,this.length=t.length},Object.defineProperty(t.prototype,"duration",{get:function(){return this.audio.duration},enumerable:!0,configurable:!0}),t.prototype.unset=function(){this.isActive&&(window.URL.revokeObjectURL(this.url),this.audio.src="",this.audio.load(),this.isActive=!1,this.playbackRate=1,this.length=null)},t.prototype.start=function(t){void 0===t&&(t=0),this.isActive&&(this.audio.currentTime=t,this.audio.play())},t.prototype.stop=function(){this.isActive&&this.audio.pause()},t}(),W=i(0),G=i.n(W),V=i(1),K=i.n(V);!function(t){t[t.Vertex=WebGLRenderingContext.VERTEX_SHADER]="Vertex",t[t.Fragment=WebGLRenderingContext.FRAGMENT_SHADER]="Fragment"}(M||(M={})),function(t){t[t.Alpha=WebGLRenderingContext.ALPHA]="Alpha",t[t.LuminanceAlpha=WebGLRenderingContext.LUMINANCE_ALPHA]="LuminanceAlpha"}(z||(z={}));var X=function(){function t(t,e,i,r){void 0===e&&(e=640),void 0===i&&(i=480),void 0===r&&(r={antialias:!1,alpha:!1}),this.uniforms={},this.refs={shaders:[],textures:[],buffers:[]},this.width=t.width=e,this.height=t.height=i;var s=t.getContext("webgl",r),n=s.createProgram();this.el=t,this.gl=s,this.program=n;var a=this.createShader(M.Vertex,G.a),o=this.createShader(M.Fragment,K.a);if(s.attachShader(n,a),s.attachShader(n,o),s.linkProgram(n),!s.getProgramParameter(n,s.LINK_STATUS)){var h=s.getProgramInfoLog(n);throw s.deleteProgram(n),new Error(h)}s.useProgram(n);var u=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,u),s.bufferData(s.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),s.STATIC_DRAW),s.enableVertexAttribArray(0),s.vertexAttribPointer(0,2,s.FLOAT,!1,0,0),this.refs.buffers.push(u),s.activeTexture(s.TEXTURE0);var f=s.createTexture();s.bindTexture(s.TEXTURE_2D,f),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR);for(var c=s.getProgramParameter(n,s.ACTIVE_UNIFORMS),d=0;d<c;d++){var p=s.getActiveUniform(n,d).name;this.uniforms[p]=s.getUniformLocation(n,p)}s.uniform1i(this.uniforms.u_bitmap,0),this.setCanvasSize(this.width,this.height),this.refs.textures.push(f),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA)}return t.prototype.createShader=function(t,e){var i=this.gl,r=i.createShader(t);if(i.shaderSource(r,e),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){var s=i.getShaderInfoLog(r);throw i.deleteShader(r),new Error(s)}return this.refs.shaders.push(r),r},t.prototype.setInputSize=function(t,e){this.gl.uniform2f(this.uniforms.u_textureSize,t,e)},t.prototype.setCanvasSize=function(t,e){this.gl.uniform2f(this.uniforms.u_screenSize,t,e),this.el.width=t,this.el.height=e,this.width=t,this.height=e,this.gl.viewport(0,0,t,e)},t.prototype.setLayerType=function(t){this.textureType=t},t.prototype.toImage=function(t){return this.el.toDataURL(t)},t.prototype.setColor=function(t,e){this.gl.uniform4f(this.uniforms[t],e[0]/255,e[1]/255,e[2]/255,1)},t.prototype.setPaperColor=function(t){this.gl.clearColor(t[0]/255,t[1]/255,t[2]/255,1)},t.prototype.drawLayer=function(t,e,i,r,s){var n=this.gl;n.activeTexture(n.TEXTURE0),n.texImage2D(n.TEXTURE_2D,0,this.textureType,e,i,0,this.textureType,n.UNSIGNED_BYTE,t),this.setColor("u_color1",r),this.setColor("u_color2",s),n.drawArrays(n.TRIANGLES,0,6)},t.prototype.resize=function(t,e){void 0===t&&(t=640),void 0===e&&(e=480),this.setCanvasSize(t,e)},t.prototype.clear=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)},t.prototype.destroy=function(){var t=this.refs,e=this.gl;t.shaders.forEach(function(t){e.deleteShader(t)}),t.shaders=[],t.textures.forEach(function(t){e.deleteTexture(t)}),t.textures=[],t.buffers.forEach(function(t){e.deleteBuffer(t)}),t.buffers=[],e.deleteProgram(this.program),e.canvas.width=1,e.canvas.height=1},t}(),Y=function(t,e,i,r){return new(i||(i=Promise))(function(s,n){function a(t){try{h(r.next(t))}catch(t){n(t)}}function o(t){try{h(r.throw(t))}catch(t){n(t)}}function h(t){t.done?s(t.value):new i(function(e){e(t.value)}).then(a,o)}h((r=r.apply(t,e||[])).next())})},q=function(t,e){var i,r,s,n,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return n={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function o(n){return function(o){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!(s=(s=a.trys).length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=e.call(t,a)}catch(t){n=[6,t],r=0}finally{i=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,o])}}},Z=function(){function t(t,e,i){this.loop=!1,this.paused=!0,this.smoothRendering=!1,this.isOpen=!1,this.events={},this.frame=-1,this.playbackLoop=null,this.hasPlaybackStarted=!1,t="string"==typeof t?document.querySelector(t):t,this.canvas=new X(t,e,i),this.audioTracks=[new N("se1"),new N("se2"),new N("se3"),new N("se4"),new N("bgm")]}return Object.defineProperty(t.prototype,"currentFrame",{get:function(){return this.frame},set:function(t){this.setFrame(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return this.isOpen?this.currentFrame*(1/this.framerate):null},set:function(t){this.isOpen&&t<this.duration&&t>0&&this.setFrame(Math.round(t/(1/this.framerate)))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this.audioTracks[3].audio.volume},set:function(t){for(var e=0;e<this.audioTracks.length;e++)this.audioTracks[e].audio.volume=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"muted",{get:function(){return this.audioTracks[3].audio.muted},set:function(t){for(var e=0;e<this.audioTracks.length;e++)this.audioTracks[e].audio.muted=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"duration",{get:function(){return this.isOpen?this.frameCount*(1/this.framerate):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"audiorate",{get:function(){return 1/this.note.bgmrate/(1/this.note.framerate)},enumerable:!0,configurable:!0}),t.prototype.open=function(t){return Y(this,void 0,void 0,function(){var e=this;return q(this,function(i){return this.isOpen&&this.close(),[2,H(t).then(function(t){e.load(t)}).catch(function(t){console.error("Error loading Flipnote:",t)})]})})},t.prototype.load=function(t){this.note=t,this.meta=t.meta,this.type=t.type,this.loop=t.meta.loop,this.paused=!0,this.isOpen=!0,this.audioTracks.forEach(function(e){e.sampleRate=t.sampleRate}),this.note.hasAudioTrack(1)&&this.audioTracks[0].set(this.note.decodeAudio("se1"),1),this.note.hasAudioTrack(2)&&this.audioTracks[1].set(this.note.decodeAudio("se2"),1),this.note.hasAudioTrack(3)&&this.audioTracks[2].set(this.note.decodeAudio("se3"),1),"KWZ"===this.type&&this.note.hasAudioTrack(4)&&this.audioTracks[3].set(this.note.decodeAudio("se4"),1),this.note.hasAudioTrack(0)&&this.audioTracks[4].set(this.note.decodeAudio("bgm"),this.audiorate),this.seFlags=this.note.decodeSoundFlags(),this.playbackLoop=null,this.hasPlaybackStarted=!1,this.layerVisibility={1:!0,2:!0,3:!0},this.canvas.setInputSize(t.width,t.height),this.canvas.setLayerType("PPM"===this.type?z.Alpha:z.LuminanceAlpha),this.setFrame(this.note.thumbFrameIndex),this.emit("load")},t.prototype.close=function(){this.pause(),this.note=null,this.isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.frame=0;for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].unset();this.hasPlaybackStarted=null,this.canvas.clear()},t.prototype.destroy=function(){this.close(),this.canvas.destroy()},t.prototype.playFrameSe=function(t){for(var e=this.seFlags[t],i=0;i<e.length;i++)e[i]&&this.audioTracks[i].isActive&&this.audioTracks[i].start()},t.prototype.playBgm=function(){this.audioTracks[4].start(this.currentTime)},t.prototype.stopAudio=function(){for(var t=0;t<this.audioTracks.length;t++)this.audioTracks[t].stop()},t.prototype.play=function(){var t=this;if(!this.isOpen||!this.paused)return null;this.paused=!1,this.hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.frame=0),this.playBgm(),this.playbackLoop=window.setInterval(function(){t.paused&&clearInterval(t.playbackLoop),t.currentFrame>=t.frameCount-1?(t.stopAudio(),t.loop?(t.firstFrame(),t.playBgm(),t.emit("playback:loop")):(t.pause(),t.emit("playback:end"))):(t.playFrameSe(t.currentFrame),t.nextFrame())},1e3/this.framerate),this.hasPlaybackStarted=!0,this.emit("playback:start")},t.prototype.pause=function(){if(!this.isOpen||this.paused)return null;window.clearInterval(this.playbackLoop),this.paused=!0,this.stopAudio(),this.emit("playback:stop")},t.prototype.setPalette=function(t){this.note.palette=t,this.forceUpdate()},t.prototype.setFrame=function(t){if(!this.isOpen||t===this.currentFrame)return null;t=Math.max(0,Math.min(Math.floor(t),this.frameCount-1)),this.frame=t,this.drawFrame(t,this.canvas),this.emit("frame:update",this.currentFrame)},t.prototype.drawFrame=function(t,e){var i=this,r=this.note.getFramePalette(t),s=this.note.decodeFrame(t);e.setPaperColor(r[0]),e.clear(),"PPM"===this.note.type?(this.layerVisibility[2]&&e.drawLayer(s[1],256,192,r[2],[0,0,0,0]),this.layerVisibility[1]&&e.drawLayer(s[0],256,192,r[1],[0,0,0,0])):"KWZ"===this.note.type&&this.note.getLayerOrder(t).forEach(function(t){i.layerVisibility[t+1]&&e.drawLayer(s[t],320,240,r[2*t+1],r[2*t+2])})},t.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},t.prototype.nextFrame=function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1},t.prototype.prevFrame=function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1},t.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1},t.prototype.firstFrame=function(){this.currentFrame=0},t.prototype.resize=function(t,e){this.canvas.resize(t,e),this.forceUpdate()},t.prototype.setLayerVisibility=function(t,e){this.layerVisibility[t]=e,this.forceUpdate()},t.prototype.forceUpdate=function(){this.isOpen&&this.drawFrame(this.currentFrame,this.canvas)},t.prototype.on=function(t,e){var i=this.events;(i[t]||(i[t]=[])).push(e)},t.prototype.off=function(t,e){var i=this.events[t];i&&i.splice(i.indexOf(e),1)},t.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];for(var r=this.events[t]||[],s=0;s<r.length;s++)r[s].apply(null,e)},t}();function J(t,e){return Math.ceil(t/e)*e}var Q=function(){function t(t,e,i){this.width=t,this.height=e,this.vWidth=J(t,4),this.vHeight=J(e,4),this.bpp=i,this.fileHeader=new s(new ArrayBuffer(14)),this.fileHeader.writeUtf8("BM"),this.dibHeader=new s(new ArrayBuffer(108)),this.dibHeader.writeUint32(108),this.dibHeader.writeInt32(t),this.dibHeader.writeInt32(e),this.dibHeader.writeUint16(1),this.dibHeader.writeUint16(i),this.dibHeader.writeUint32(3),this.dibHeader.writeUint32(this.vWidth*this.height/(i/8)),this.dibHeader.writeUint32(3780),this.dibHeader.writeUint32(3780),this.dibHeader.writeUint32(0),this.dibHeader.writeUint32(0),this.dibHeader.writeUint32(16711680),this.dibHeader.writeUint32(65280),this.dibHeader.writeUint32(255),this.dibHeader.writeUint32(4278190080),this.dibHeader.writeUtf8("Win ")}return t.fromFlipnoteFrame=function(e,i){var r=new t(e.width,e.height,8);return r.setPixels(e.getFramePixels(i)),r.setPalette(e.getFramePalette(i)),r},t.prototype.setFilelength=function(t){this.fileHeader.seek(2),this.fileHeader.writeUint32(t)},t.prototype.setPixelOffset=function(t){this.fileHeader.seek(10),this.fileHeader.writeUint32(t)},t.prototype.setCompression=function(t){this.dibHeader.seek(16),this.dibHeader.writeUint32(t)},t.prototype.setPaletteCount=function(t){this.dibHeader.seek(32),this.dibHeader.writeUint32(t)},t.prototype.setPalette=function(t){for(var e=new Uint32Array(Math.pow(2,this.bpp)),i=0;i<t.length;i++){var r=t[i%t.length];e[i]=4278190080|r[0]<<16|r[1]<<8|r[2]}this.setPaletteCount(e.length),this.setCompression(0),this.palette=e},t.prototype.setPixels=function(t){var e,i=this.vWidth*this.height;switch(this.bpp){case 8:e=new Uint8Array(i);break;case 32:e=new Uint32Array(i)}for(var r=this.width,s=0;s<this.height;s++){var n=r*this.height-(s+1)*r,a=s*this.width;e.set(t.slice(n,n+this.width),a)}this.pixels=e},t.prototype.getBlob=function(){var t=[this.fileHeader.buffer,this.dibHeader.buffer],e=this.fileHeader.byteLength+this.dibHeader.byteLength;switch(this.bpp){case 1:case 4:case 8:this.setFilelength(e+this.pixels.byteLength+this.palette.byteLength),this.setPixelOffset(e+this.palette.byteLength),t=t.concat([this.palette.buffer,this.pixels.buffer]);break;case 16:case 32:this.setFilelength(e+this.pixels.byteLength),this.setPixelOffset(e),t=t.concat([this.pixels.buffer])}return new Blob(t,{type:"image/bitmap"})},t.prototype.getUrl=function(){return window.URL.createObjectURL(this.getBlob())},t.prototype.getImage=function(){var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},t}(),$=function(){function t(){this.page=-1,this.pages=[],this.cursor=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(t.pageSize),this.cursor=0},t.prototype.getData=function(){var e=this,i=new Uint8Array(this.page*t.pageSize+this.cursor);return this.pages.map(function(r,s){s===e.page?i.set(r.slice(0,e.cursor),s*t.pageSize):i.set(r,s*t.pageSize)}),i},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(e){this.cursor>=t.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=e},t.prototype.writeBytes=function(t,e,i){for(var r=i||t.length,s=e||0;s<r;s++)this.writeByte(t[s])},t.pageSize=4096,t}(),tt=5003,et=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],it=function(){function t(t,e,i,r){this.accum=new Uint8Array(256),this.htab=new Int32Array(tt),this.codetab=new Int32Array(tt),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.pixels=i,this.colorDepth=r,this.initCodeSize=Math.max(2,this.colorDepth),this.accum=new Uint8Array(256),this.htab=new Int32Array(tt),this.codetab=new Int32Array(tt),this.cur_accum=0,this.cur_bits=0,this.a_count,this.remaining,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}return t.prototype.char_out=function(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)},t.prototype.cl_block=function(t){this.cl_hash(tt),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var e=0;e<t;++e)this.htab[e]=-1},t.prototype.compress=function(t,e){var i,r,s,n,a,o,h;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,n=this.nextPixel(),h=0,i=tt;i<65536;i*=2)++h;h=8-h,o=tt,this.cl_hash(o),this.output(this.ClearCode,e);t:for(;-1!=(r=this.nextPixel());)if(i=(r<<12)+n,s=r<<h^n,this.htab[s]!==i){if(this.htab[s]>=0){a=o-s,0===s&&(a=1);do{if((s-=a)<0&&(s+=o),this.htab[s]===i){n=this.codetab[s];continue t}}while(this.htab[s]>=0)}this.output(n,e),n=r,this.free_ent<4096?(this.codetab[s]=this.free_ent++,this.htab[s]=i):this.cl_block(e)}else n=this.codetab[s];this.output(n,e),this.output(this.EOFCode,e)},t.prototype.encode=function(t){t.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,t),t.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,e){for(this.cur_accum&=et[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}},t}(),rt=function(){function t(t,e){this.delay=100,this.repeat=-1,this.colorDepth=8,this.palette=[],this.width=t,this.height=e,this.data=new $}return t.fromFlipnote=function(e){var i=new t(e.width,e.height);i.palette=e.globalPalette,i.delay=100/e.framerate,i.repeat=e.meta.loop?-1:0,i.init();for(var r=0;r<e.frameCount;r++)i.writeFrame(e.getFramePixels(r,!0));return i},t.fromFlipnoteFrame=function(e,i){var r=new t(e.width,e.height);return r.palette=e.globalPalette,r.delay=100/e.framerate,r.repeat=e.meta.loop?-1:0,r.init(),r.writeFrame(e.getFramePixels(i,!0)),r},t.prototype.init=function(){for(var t=this.palette.length,e=1;1<<e<t;e+=1);this.colorDepth=e,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt()},t.prototype.writeHeader=function(){var t=new s(new ArrayBuffer(13));t.writeUtf8("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.colorDepth-1),t.writeUint8(0),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.colorDepth)),e=0,i=0;i<t.length;e+=1,i+=3)t.set(this.palette[e],i);this.data.writeBytes(t)},t.prototype.writeGraphicsControlExt=function(){var t=new s(new ArrayBuffer(8));t.writeBytes([33,249,4,0]),t.writeUint16(this.delay),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeNetscapeExt=function(){var t=new s(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeUtf8("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeImageDesc=function(){var t=new s(new ArrayBuffer(10));t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writePixels=function(t){new it(this.width,this.height,t,this.colorDepth).encode(this.data)},t.prototype.writeFrame=function(t){this.writeGraphicsControlExt(),this.writeImageDesc(),this.writePixels(t)},t.prototype.getBuffer=function(){return this.data.getBuffer()},t.prototype.getBlob=function(){return new Blob([this.getBuffer()],{type:"image/gif"})},t.prototype.getUrl=function(){return window.URL.createObjectURL(this.getBlob())},t.prototype.getImage=function(){var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},t}();e.default={dataStream:s,kwzParser:D,ppmParser:b,player:Z,bitmapEncoder:Q,gifEncoder:rt,parseSource:H}}]).default});
//# sourceMappingURL=flipnote.min.js.map