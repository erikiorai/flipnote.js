/*!!
flipnote.js v5.2.1 (web build)
https://flipnote.js.org
A JavaScript library for parsing, converting, and in-browser playback of the proprietary animation formats used by Nintendo's Flipnote Studio and Flipnote Studio 3D apps.
2018 - 2021 James Daniel
Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
Keep on Flipnoting!
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).flipnote={})}(this,(function(t){"use strict";var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,r)};function r(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}var i=function(){return(i=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function n(t,e,r,i){return new(r||(r=Promise))((function(n,o){function a(t){try{u(i.next(t))}catch(t){o(t)}}function s(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}u((i=i.apply(t,e||[])).next())}))}function o(t,e){var r,i,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,i&&(n=2&o[0]?i.return:o[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,o[1])).done)return n;switch(i=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=a.trys,(n=n.length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],i=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function a(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var i=Array(t),n=0;for(e=0;e<r;e++)for(var o=arguments[e],a=0,s=o.length;a<s;a++,n++)i[n]=o[a];return i}var s=function(){function t(){this.pageSize=t.pageSize,this.currPageIndex=-1,this.pages=[],this.pointer=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.currPageIndex]=new Uint8Array(this.pageSize),this.currPage=this.pages[this.currPageIndex],this.pointer=0},t.prototype.getData=function(){for(var t=new Uint8Array(this.currPageIndex*this.pageSize+this.pointer),e=0;e<this.pages.length;e++){var r=this.pages[e];e===this.currPageIndex?t.set(r.slice(0,this.pointer),e*this.pageSize):t.set(r,e*this.pageSize)}return t},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(t){this.pointer>=this.pageSize&&this.newPage(),this.currPage[this.pointer++]=t},t.prototype.writeBytes=function(t,e,r){for(var i=r||t.length,n=e||0;n<i;n++)this.writeByte(t[n])},t.pageSize=2048,t}(),u=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,e){switch(e){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;case 0:default:this.pointer=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.pointer);return this.pointer+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.pointer,t),this.pointer+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.pointer);return this.pointer+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.pointer,t),this.pointer+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var e=this.data.getUint16(this.pointer,t);return this.pointer+=2,e},t.prototype.writeUint16=function(t,e){void 0===e&&(e=!0),this.data.setUint16(this.pointer,t,e),this.pointer+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var e=this.data.getInt16(this.pointer,t);return this.pointer+=2,e},t.prototype.writeInt16=function(t,e){void 0===e&&(e=!0),this.data.setInt16(this.pointer,t,e),this.pointer+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var e=this.data.getUint32(this.pointer,t);return this.pointer+=4,e},t.prototype.writeUint32=function(t,e){void 0===e&&(e=!0),this.data.setUint32(this.pointer,t,e),this.pointer+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var e=this.data.getInt32(this.pointer,t);return this.pointer+=4,e},t.prototype.writeInt32=function(t,e){void 0===e&&(e=!0),this.data.setInt32(this.pointer,t,e),this.pointer+=4},t.prototype.readBytes=function(t){var e=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=e.byteLength,e},t.prototype.writeBytes=function(t){var e=this;t.forEach((function(t){return e.writeUint8(t)}))},t.prototype.readHex=function(t,e){void 0===e&&(e=!1);for(var r=this.readBytes(t),i=[],n=0;n<r.length;n++)i.push(r[n].toString(16).padStart(2,"0"));return e&&i.reverse(),i.join("").toUpperCase()},t.prototype.readChars=function(t){for(var e=this.readBytes(t),r="",i=0;i<e.length;i++){var n=e[i];if(0===n)break;r+=String.fromCharCode(n)}return r},t.prototype.writeChars=function(t){for(var e=0;e<t.length;e++){var r=t.charCodeAt(e);this.writeUint8(r)}},t.prototype.readWideChars=function(t){for(var e=new Uint16Array(this.data.buffer,this.pointer,t),r="",i=0;i<e.length;i++){var n=e[i];if(0==n)break;r+=String.fromCharCode(n)}return this.pointer+=e.byteLength,r},t}(),h=new Int8Array([-1,2,-1,2]),f=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),c=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function l(t,e,r){return t<e?e:t>r?r:t}function d(t,e,r){return r<0||r>=e?0:t[r]}function p(t){for(var e=t.length,r=0,i=0;i<e;i++){var n=t[i];(n<=-32768||n>=32767)&&(r+=1)}return r/e}function m(t,e){if(void 0===e&&(e="Assert failed"),!t)throw console.trace(e),new Error(e)}function y(t,e,r,i){void 0===i&&(i=""),m(t>=e&&t<=r,"Value "+i+" should be between "+e+" and "+r)}var g="undefined"!=typeof window&&void 0!==window.document;function v(){return m(g,"This feature is only available in browser environments")}var b="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;var w;function A(t){return new Date(1e3*(t+946684800))}function F(t,e){return 100*t*(1/e)/100}(w=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",w.USA="USA",w.JPN="JPN",w.UNKNOWN="UNKNOWN";var x=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/;function T(t){return x.test(t)}function P(e){switch(e.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function S(e){if(T(e))switch(e.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}switch(e.slice(0,2)){case"00":return t.FlipnoteRegion.JPN;case"02":return t.FlipnoteRegion.USA;case"04":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}var _,E;!function(){if(!g)return function(){};var t=document.createElement("a")}();(_=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",_.KWZ="KWZ",(E=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[E.BGM=0]="BGM",E[E.SE1=1]="SE1",E[E.SE2=2]="SE2",E[E.SE3=3]="SE3",E[E.SE4=4]="SE4";for(var U=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.isFolderIcon=!1,e.isComment=!1,e.isDsiLibraryNote=!1,e}return r(e,t),e.prototype.hasAudioTrack=function(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0},e}(u),k=[.5,.5,1,2,4,6,12,20,30],C={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},L=function(e){function i(r,n){var o=e.call(this,r)||this;return o.format=t.FlipnoteFormat.PPM,o.imageWidth=i.width,o.imageHeight=i.height,o.imageOffsetX=0,o.imageOffsetY=0,o.numLayers=i.numLayers,o.rawSampleRate=i.rawSampleRate,o.sampleRate=i.sampleRate,o.globalPalette=i.globalPalette,o.prevDecodedFrame=null,o.decodeHeader(),o.decodeAnimationHeader(),o.decodeSoundHeader(),0!=(o.version>>4&15)&&o.decodeMeta(),o.layerBuffers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],o.prevLayerBuffers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],o.lineEncodingBuffers=[new Uint8Array(i.height),new Uint8Array(i.height)],o.prevDecodedFrame=null,o}return r(i,e),i.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},i.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},i.prototype.decodeHeader=function(){m(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},i.prototype.readFilename=function(){return this.readHex(3)+"_"+this.readChars(13)+"_"+this.readUint16().toString().padStart(3,"0")},i.prototype.decodeMeta=function(){m(1704<this.byteLength),this.seek(16);var t=this.readUint16(),e=this.readInt16(),r=this.readWideChars(11),i=this.readWideChars(11),n=this.readWideChars(11),o=this.readHex(8,!0),a=this.readHex(8,!0),s=this.readFilename(),u=this.readFilename(),h=this.readHex(8,!0);this.seek(154);var f=A(this.readInt32());this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=e,this.layerVisibility={1:0==(16&c),2:0==(32&c),3:!1},this.isSpinoff=a!==o||a!==h,this.meta={lock:1===t,loop:1==(c>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:e,timestamp:f,root:{username:r,fsid:h,region:P(h),filename:null},parent:{username:i,fsid:o,region:P(o),filename:s},current:{username:n,fsid:a,region:P(a),filename:u}}},i.prototype.decodeAnimationHeader=function(){this.seek(1696);var t=this.readUint16(),e=t/4;m(e<=this.frameCount),this.seek(1704);for(var r=new Uint32Array(e),i=0;i<e;i++){var n=1704+t+this.readUint32();m(n<this.byteLength,"Frame "+i+" pointer is out of bounds"),r[i]=n}this.frameOffsets=r},i.prototype.decodeSoundHeader=function(){var e=1696+this.frameDataLength+this.frameCount;m(e<this.byteLength),e%4!=0&&(e+=4-e%4),this.seek(e);var r=this.readUint32(),i=this.readUint32(),n=this.readUint32(),o=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),m(this.frameSpeed<=8&&this.bgmSpeed<=8),e+=32,this.framerate=k[this.frameSpeed],this.duration=F(this.frameCount,this.framerate),this.bgmrate=k[this.bgmSpeed];var a=new Map;a.set(t.FlipnoteAudioTrack.BGM,{ptr:e,length:r}),a.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=r,length:i}),a.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=i,length:n}),a.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=n,length:o}),this.soundMeta=a},i.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},i.prototype.decodeFrame=function(t){m(t>-1&&t<this.frameCount,"Frame index "+t+" out of bounds"),this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);var e=this.readUint8(),r=e>>7&1,n=e>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);var o=0,a=0;n&&(o=this.readInt8(),a=this.readInt8());for(var s=0;s<2;s++){(c=this.lineEncodingBuffers[s]).fill(0);for(var u=0;u<c.length;){var h=this.readUint8();0!==h?(c[u++]=3&h,c[u++]=h>>2&3,c[u++]=h>>4&3,c[u++]=h>>6&3):u+=4}}for(s=0;s<2;s++)for(var f=this.layerBuffers[s],c=this.lineEncodingBuffers[s],l=0;l<i.height;l++){var d=l*i.width;switch(c[l]){case 0:break;case 1:for(var p=this.readUint32(!1);0!==p;p<<=1,d+=8)if(2147483648&p)for(var y=this.readUint8(),g=0;0!==y;g++,y>>=1)f[d+g]=1&y;break;case 2:f.fill(1,d,d+i.width);for(p=this.readUint32(!1);0!==p;p<<=1,d+=8)if(2147483648&p)for(y=this.readUint8(),g=0;g<8;g++,y>>=1)f[d+g]=1&y;break;case 3:y=0;for(var v=0;v<i.width;v++)v%8==0&&(y=this.readUint8()),f[d++]=1&y,y>>=1}}var b=this.layerBuffers[0],w=this.layerBuffers[1],A=this.prevLayerBuffers[0],F=this.prevLayerBuffers[1];if(!r){var x=void 0,T=void 0;for(l=0;l<i.height;l++)if(!(l-a<0)){if(l-a>=i.height)break;for(var P=0;P<i.width;P++)if(!(P-o<0)){if(P-o>=i.width)break;T=(x=P+l*i.width)-(o+a*i.width),b[x]^=A[T],w[x]^=F[T]}}}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers},i.prototype.getFrameLayerOrder=function(t){return[0,1]},i.prototype.getFramePaletteIndices=function(t){this.seek(this.frameOffsets[t]);var e=this.readUint8(),r=1!=(1&e),i=[r?0:1,r?0:1,2,3];return[r?1:0,i[e>>1&3],i[e>>3&3]]},i.prototype.getFramePalette=function(t){var e=this;return this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,e){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),n=this.layerBuffers[e],o=new Uint8Array(i.width*i.height),a=r[e+1],s=0;s<o.length;s++)1===n[s]&&(o[s]=a);return o},i.prototype.getFramePixels=function(t){var e=this.getFramePaletteIndices(t),r=this.decodeFrame(t),n=new Uint8Array(i.width*i.height),o=r[0],a=r[1],s=e[0],u=e[1],h=e[2];n.fill(s);for(var f=0;f<n.length;f++){var c=o[f],l=a[f];1===c?n[f]=u:1===l&&(n[f]=h)}return n},i.prototype.decodeSoundFlags=function(){m(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);for(var t=this.frameCount,e=this.readBytes(t),r=new Array(t),i=0;i<t;i++){var n=e[i];r[i]=[0!=(1&n),0!=(2&n),0!=(4&n)]}return r},i.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta.get(t);return m(e.ptr+e.length<this.byteLength),this.seek(e.ptr),this.readBytes(e.length)},i.prototype.decodeAudioTrack=function(t){for(var e=this.getAudioTrackRaw(t),r=e.length,i=new Int16Array(2*r),n=0,o=0,a=0,s=0,u=0,h=!0;n<r;){a=h?15&e[n]:e[n++]>>4,h=!h;var d=c[s],p=d>>3;1&a&&(p+=d>>2),2&a&&(p+=d>>1),4&a&&(p+=d),8&a&&(p=-p),u=l(u+=p,-32768,32767),s=l(s+=f[a],0,88),i[o++]=u}return i},i.prototype.getAudioTrackPcm=function(e,r){void 0===r&&(r=this.sampleRate);var i=this.decodeAudioTrack(e),n=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){var o=1/this.bgmrate/(1/this.framerate);n=this.rawSampleRate*o}return n!==r?function(t,e,r){for(var i=t.length,n=i/e*r,o=new Int16Array(n),a=e/r,s=0;s<n;s++)o[s]=d(t,i,Math.floor(s*a));return o}(i,n,r):i},i.prototype.pcmAudioMix=function(t,e,r){void 0===r&&(r=0);for(var i=t.length,n=e.length,o=0;o<i&&!(r+o>n);o++){var a=e[r+o]+t[o]/2;e[r+o]=l(a,-32768,32767)}},i.prototype.getAudioMasterPcm=function(e){void 0===e&&(e=this.sampleRate);var r=Math.ceil(this.duration*e),i=new Int16Array(r),n=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),s=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(n){var u=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(u,i,0)}if(o||a||s)for(var h=e/this.framerate,f=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,c=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,l=s?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,d=this.decodeSoundFlags(),m=0;m<this.frameCount;m++){var y=Math.ceil(m*h),g=d[m];o&&g[0]&&this.pcmAudioMix(f,i,y),a&&g[1]&&this.pcmAudioMix(c,i,y),s&&g[2]&&this.pcmAudioMix(l,i,y)}return this.audioClipRatio=p(i),i},i.defaultSettings={},i.format=t.FlipnoteFormat.PPM,i.width=256,i.height=192,i.numLayers=2,i.rawSampleRate=8192,i.sampleRate=32768,i.globalPalette=[C.WHITE,C.BLACK,C.RED,C.BLUE],i}(U),B=[.2,.5,1,2,4,6,8,12,20,24,30],R={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},M=new Uint16Array(16),I=0;I<16;I++)M[I]=(1<<I)-1;for(var z=new Uint8Array(52488),N=new Uint8Array(52488),O=0,D=0;D<3;D++)for(var H=0;H<3;H++)for(var W=0;W<3;W++)for(var V=0;V<3;V++)for(var G=0;G<3;G++)for(var j=0;j<3;j++)for(var K=0;K<3;K++)for(var q=0;q<3;q++)z.set([H,D,V,W,j,G,q,K],O),N.set([D,V,W,j,G,q,K,H],O),O+=8;var X=new Uint8Array(256),Y=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,e){var r=8*t,i=z.subarray(r,r+8),n=N.subarray(r,r+8);X.set(i,8*e),Y.set(n,8*e)}));var $,J=function(e){function n(r,o){void 0===o&&(o={});var a=e.call(this,r)||this;return a.format=t.FlipnoteFormat.KWZ,a.imageWidth=n.width,a.imageHeight=n.height,a.imageOffsetX=0,a.imageOffsetY=0,a.numLayers=n.numLayers,a.rawSampleRate=n.rawSampleRate,a.sampleRate=n.sampleRate,a.globalPalette=n.globalPalette,a.prevFrameIndex=null,a.bitIndex=0,a.bitValue=0,a.settings=i(i({},n.defaultSettings),o),a.layers=[new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height)],a.buildSectionMap(),a.sectionMap.has("KIC")?(a.isFolderIcon=!0,a.imageWidth=24,a.imageHeight=24,a.frameCount=1,a.frameSpeed=0,a.framerate=B[0],a.thumbFrameIndex=0,a.getFrameOffsets()):a.sectionMap.has("KSN")?(a.decodeMeta(),a.getFrameOffsets(),a.decodeSoundHeader()):(a.isComment=!0,a.decodeMeta(),a.getFrameOffsets()),a}return r(n,e),n.prototype.buildSectionMap=function(){this.seek(0);for(var t=this.byteLength-256,e=new Map,r=0,i=0;i<t&&r<6;){this.seek(i);var n=this.readChars(4).substring(0,3),o=this.readUint32();e.set(n,{ptr:i,length:o}),i+=o+8,r+=1}this.sectionMap=e,m(e.has("KMC")&&e.has("KMI"))},n.prototype.readBits=function(t){if(this.bitIndex+t>16){var e=this.readUint16();this.bitValue|=e<<16-this.bitIndex,this.bitIndex-=16}var r=this.bitValue&M[t];return this.bitValue>>=t,this.bitIndex+=t,r},n.prototype.readFsid=function(){if(this.settings.dsiLibraryNote)return this.readHex(10,!0).slice(2,18);var t=this.readHex(10);return(t.slice(0,4)+"-"+t.slice(4,8)+"-"+t.slice(8,12)+"-"+t.slice(12,18)).toLowerCase()},n.prototype.readFilename=function(){var t=this.pointer,e=this.readChars(28);if(28===e.length)return e;this.seek(t);var r=this.readHex(3),i=this.readChars(13),n=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),r+"_"+i+"_"+n},n.prototype.decodeMeta=function(){if(this.settings.quickMeta)return this.decodeMetaQuick();m(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);var t=A(this.readUint32()),e=A(this.readUint32()),r=(this.readUint32(),this.readFsid()),i=this.readFsid(),n=this.readFsid(),o=this.readWideChars(11),a=this.readWideChars(11),s=this.readWideChars(11),u=this.readFilename(),h=this.readFilename(),f=this.readFilename(),c=this.readUint16(),l=this.readUint16(),d=this.readUint16(),p=this.readUint8(),y=this.readUint8();this.isSpinoff=n!==i||n!==r,this.frameCount=c,this.frameSpeed=p,this.framerate=B[p],this.duration=F(this.frameCount,this.framerate),this.thumbFrameIndex=l,this.layerVisibility={1:0==(1&y),2:0==(2&y),3:0==(3&y)},(T(n)||this.settings.dsiLibraryNote)&&(this.isDsiLibraryNote=!0),this.meta={lock:0!=(1&d),loop:0!=(2&d),isSpinoff:this.isSpinoff,frameCount:c,frameSpeed:p,duration:this.duration,thumbIndex:l,timestamp:e,creationTimestamp:t,root:{username:o,fsid:r,region:S(r),filename:u,isDsiFilename:28!==u.length},parent:{username:a,fsid:i,region:S(i),filename:h,isDsiFilename:28!==h.length},current:{username:s,fsid:n,region:S(n),filename:f,isDsiFilename:28!==f.length}}},n.prototype.decodeMetaQuick=function(){m(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);var t=this.readUint16(),e=this.readUint16(),r=(this.readUint16(),this.readUint8()),i=this.readUint8();this.frameCount=t,this.thumbFrameIndex=e,this.frameSpeed=r,this.framerate=B[r],this.duration=F(this.frameCount,this.framerate),this.layerVisibility={1:0==(1&i),2:0==(2&i),3:0==(3&i)}},n.prototype.getFrameOffsets=function(){m(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));var t=this.frameCount,e=this.sectionMap.get("KMI"),r=this.sectionMap.get("KMC");m(e.length/28>=t);for(var i=new Uint32Array(t),n=new Uint32Array(t),o=[],a=e.ptr+8,s=r.ptr+12,u=0;u<t;u++){this.seek(a+4);var h=this.readUint16(),f=this.readUint16(),c=this.readUint16();i[u]=a,n[u]=s,s+=h+f+c,m((a+=28)<this.byteLength,"frame"+u+" meta pointer out of bounds"),m(s<this.byteLength,"frame"+u+" data pointer out of bounds"),o.push([h,f,c])}this.frameMetaOffsets=i,this.frameDataOffsets=n,this.frameLayerSizes=o},n.prototype.decodeSoundHeader=function(){m(this.sectionMap.has("KSN"));var e=this.sectionMap.get("KSN").ptr+8;this.seek(e),this.bgmSpeed=this.readUint32(),m(this.bgmSpeed<=10),this.bgmrate=B[this.bgmSpeed];var r=new Uint32Array(this.buffer,e+4,20),i=new Map;i.set(t.FlipnoteAudioTrack.BGM,{ptr:e+=28,length:r[0]}),i.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=r[0],length:r[1]}),i.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=r[1],length:r[2]}),i.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=r[2],length:r[3]}),i.set(t.FlipnoteAudioTrack.SE4,{ptr:e+=r[3],length:r[4]}),this.soundMeta=i},n.prototype.getFramePaletteIndices=function(t){this.seek(this.frameMetaOffsets[t]);var e=this.readUint32();return[15&e,e>>8&15,e>>12&15,e>>16&15,e>>20&15,e>>24&15,e>>28&15]},n.prototype.getFramePalette=function(t){var e=this;return this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},n.prototype.getFrameDiffingFlag=function(t){return this.seek(this.frameMetaOffsets[t]),this.readUint32()>>4&7},n.prototype.getFrameLayerSizes=function(t){return this.seek(this.frameMetaOffsets[t]+4),[this.readUint16(),this.readUint16(),this.readUint16()]},n.prototype.getFrameLayerDepths=function(t){return this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]},n.prototype.getFrameAuthor=function(t){return this.seek(this.frameMetaOffsets[t]+10),this.readHex(10)},n.prototype.getFrameSoundFlags=function(t){this.seek(this.frameMetaOffsets[t]+23);var e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e),0!=(8&e)]},n.prototype.getFrameCameraFlags=function(t){this.seek(this.frameMetaOffsets[t]+26);var e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e)]},n.prototype.getFrameLayerOrder=function(t){var e=this.getFrameLayerDepths(t);return[2,1,0].sort((function(t,r){return e[r]-e[t]}))},n.prototype.decodeFrame=function(t,e,r){void 0===e&&(e=7),void 0===r&&(r=!1),m(t>-1&&t<this.frameCount,"Frame index "+t+" out of bounds"),this.prevFrameIndex!==t-1&&0!==t&&(r&&(e&=~this.getFrameDiffingFlag(t+1)),0!==e&&this.decodeFrame(t-1,e,!0));for(var i=this.frameDataOffsets[t],o=this.frameLayerSizes[t],a=0;a<3&&(!this.settings.dsiLibraryNote||3!==a);a++){this.seek(i);var s=o[a];i+=s;var u=this.layers[a];if(38!==s&&0!=(e>>a&1)){this.bitIndex=16,this.bitValue=0;for(var h=0,f=0;f<240;f+=128)for(var c=0;c<320;c+=128)for(var l=0;l<128;l+=8){var d=f+l;if(d>=240)break;for(var p=0;p<128;p+=8){var y=c+p;if(y>=320)break;if(h>0)h-=1;else{var g=d*n.width+y,v=this.readBits(3);if(0===v){var b=8*this.readBits(5),w=X.subarray(b,b+8);u.set(w,g),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320)}else if(1===v){b=8*this.readBits(13),w=z.subarray(b,b+8);u.set(w,g),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320)}else if(2===v){b=8*this.readBits(5);var A=X.subarray(b,b+8),F=Y.subarray(b,b+8);u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320)}else if(3===v){b=8*this.readBits(13),A=z.subarray(b,b+8),F=N.subarray(b,b+8);u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320)}else if(4===v)for(var x=this.readBits(8),T=1;T<255;T<<=1){if(x&T){b=8*this.readBits(5),w=X.subarray(b,b+8);u.set(w,g)}else{b=8*this.readBits(13),w=z.subarray(b,b+8);u.set(w,g)}g+=320}else{if(5===v){h=this.readBits(5);continue}if(7===v){var P=this.readBits(2);A=void 0,F=void 0;if(0!==this.readBits(1)){var S=8*this.readBits(5),_=8*this.readBits(5);A=X.subarray(S,S+8),F=X.subarray(_,_+8),P=(P+1)%4}else{S=8*this.readBits(13),_=8*this.readBits(13);A=z.subarray(S,S+8),F=z.subarray(_,_+8)}0===P?(u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320)):1===P?(u.set(A,g),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320)):2===P?(u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320),u.set(F,g+=320)):3===P&&(u.set(A,g),u.set(F,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320))}}}}}}}return this.prevFrameIndex=t,this.layers},n.prototype.getLayerPixels=function(t,e){this.prevFrameIndex!==t&&this.decodeFrame(t);for(var r=this.layers[e],i=this.getFramePaletteIndices(t),o=2*e+1,a=this.imageWidth,s=this.imageHeight,u=this.imageOffsetX,h=this.imageOffsetY,f=new Uint8Array(a*s),c=h,l=0;l<s;c++,l++)for(var d=u,p=0;p<a;d++,p++){var m=l*a+p,y=r[c*n.width+d];1===y?f[m]=i[o]:2===y&&(f[m]=i[o+1])}return f},n.prototype.getFramePixels=function(t){this.prevFrameIndex!==t&&this.decodeFrame(t);var e=this.getFrameLayerOrder(t),r=this.layers[e[2]],i=this.layers[e[1]],o=this.layers[e[0]],a=this.getFramePaletteIndices(t),s=2*e[2],u=2*e[1],h=2*e[0],f=this.imageWidth,c=this.imageHeight,l=this.imageOffsetX,d=this.imageOffsetY,p=new Uint8Array(f*c);p.fill(a[0]);for(var m=d,y=0;y<c;m++,y++)for(var g=l,v=0;v<f;g++,v++){var b=m*n.width+g,w=y*f+v,A=r[b],F=i[b],x=o[b];0!==A?p[w]=a[s+A]:0!==F?p[w]=a[u+F]:0!==x&&(p[w]=a[h+x])}return p},n.prototype.decodeSoundFlags=function(){for(var t=[],e=0;e<this.frameCount;e++)t.push(this.getFrameSoundFlags(e));return t},n.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta.get(t);return m(e.ptr+e.length<this.byteLength),new Uint8Array(this.buffer,e.ptr,e.length)},n.prototype.decodeAudioTrack=function(t){var e=this.getAudioTrackRaw(t),r=new Int16Array(981840),i=0,n=0,o=0,a=0,s=0,u=0;(this.settings.originalAudio||this.isDsiLibraryNote)&&(o=40);for(var d=0;d<e.length;d++)for(var p=e[d],m=0;m<8;)o<18||m>4?(a=3&p,u=(s=c[o])>>3,1&a&&(u+=s),2&a&&(u=-u),n+=u,o+=h[a],p>>=2,m+=2):(a=15&p,u=(s=c[o])>>3,1&a&&(u+=s>>2),2&a&&(u+=s>>1),4&a&&(u+=s),8&a&&(u=-u),n+=u,o+=f[a],p>>=4,m+=4),o=l(o,0,79),n=l(n,-2048,2047),r[i]=16*n,i+=1;return r.slice(0,i)},n.prototype.getAudioTrackPcm=function(e,r){void 0===r&&(r=this.sampleRate);var i=this.decodeAudioTrack(e),n=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){var o=1/this.bgmrate/(1/this.framerate);n=this.rawSampleRate*o}return n!==r?function(t,e,r){for(var i=t.length,n=i/e*r,o=new Int16Array(n),a=e/r,s=0,u=0,h=0,f=0;s<n;s++)u=s*a,h=Math.floor(u),f=u%1,o[s]=(1-f)*d(t,i,h)+f*d(t,i,h+1);return o}(i,n,r):i},n.prototype.pcmAudioMix=function(t,e,r){void 0===r&&(r=0);for(var i=t.length,n=e.length,o=0;o<i&&!(r+o>n);o++){var a=e[r+o]+t[o];e[r+o]=l(a,-32768,32767)}},n.prototype.getAudioMasterPcm=function(e){void 0===e&&(e=this.sampleRate);var r=Math.ceil(this.duration*e),i=new Int16Array(r),n=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),s=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),u=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(n){var h=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(h,i,0)}if(o||a||s||u)for(var f=e/this.framerate,c=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,l=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,d=s?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,m=u?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,e):null,y=0;y<this.frameCount;y++){var g=this.getFrameSoundFlags(y),v=Math.ceil(y*f);o&&g[0]&&this.pcmAudioMix(c,i,v),a&&g[1]&&this.pcmAudioMix(l,i,v),s&&g[2]&&this.pcmAudioMix(d,i,v),u&&g[3]&&this.pcmAudioMix(m,i,v)}return this.audioClipRatio=p(i),i},n.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,originalAudio:!1},n.format=t.FlipnoteFormat.KWZ,n.width=320,n.height=240,n.numLayers=3,n.rawSampleRate=16364,n.sampleRate=32768,n.globalPalette=[R.WHITE,R.BLACK,R.RED,R.YELLOW,R.GREEN,R.BLUE,R.NONE],n}(U),Z=[{matches:function(t){return g&&"string"==typeof t},load:function(t,e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onreadystatechange=function(t){4===i.readyState&&(i.status>=200&&i.status<300?e(i.response):r({type:"httpError",status:i.status,statusText:i.statusText}))},i.send(null)}},{matches:function(t){return b&&"string"==typeof t},load:function(t,e,r){require("https").get(t,(function(t){var i=[];t.on("data",(function(t){return i.push(t)})),t.on("end",(function(){var t=Buffer.concat(i);e(t.buffer)})),t.on("error",(function(t){return r(t)}))}))}},{matches:function(t){return g&&"undefined"!=typeof File&&t instanceof File},load:function(t,e,r){m("undefined"!=typeof FileReader);var i=new FileReader;i.onload=function(t){e(i.result)},i.onerror=function(t){r({type:"fileReadError"})},i.readAsArrayBuffer(t)}},{matches:function(t){return b&&t instanceof Buffer},load:function(t,e,r){e(t.buffer)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,r){e(t)}}];function Q(t,e){return function(t){return new Promise((function(e,r){for(var i=0;i<Z.length;i++){var n=Z[i];if(n.matches(t))return n.load(t,e,r)}r("No loader available for source type")}))}(t).then((function(t){return new Promise((function(r,i){var n=new Uint8Array(t.slice(0,4)),o=n[0]<<24|n[1]<<16|n[2]<<8|n[3];1346458177===o?r(new L(t,e)):1262897152==(4294967040&o)||1263092480==(4294967040&o)?r(new J(t,e)):i("Could not identify source as a valid Flipnote file")}))}))}!function(t){t.__Any="any",t.Play="play",t.Pause="pause",t.CanPlay="canplay",t.CanPlayThrough="canplaythrough",t.SeekStart="seeking",t.SeekEnd="seeked",t.Duration="durationchange",t.Loop="loop",t.Ended="ended",t.VolumeChange="volumechange",t.Progress="progress",t.TimeUpdate="timeupdate",t.FrameUpdate="frameupdate",t.FrameNext="framenext",t.FramePrev="frameprev",t.FrameFirst="framefirst",t.FrameLast="framelast",t.Ready="ready",t.Load="load",t.LoadStart="loadstart",t.LoadedData="loadeddata",t.LoadedMeta="loadedmetadata",t.Emptied="emptied",t.Close="close",t.Error="error",t.Destroy="destroy"}($||($={}));var tt=[$.Play,$.Pause,$.CanPlay,$.CanPlayThrough,$.SeekStart,$.SeekEnd,$.Duration,$.Loop,$.Ended,$.VolumeChange,$.Progress,$.TimeUpdate,$.FrameUpdate,$.FrameNext,$.FramePrev,$.FrameFirst,$.FrameLast,$.Ready,$.Load,$.LoadStart,$.LoadedData,$.LoadedMeta,$.Emptied,$.Close,$.Error];function et(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const rt="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function it(t,e){return"undefined"!=typeof WebGLTexture&&e instanceof WebGLTexture}const nt="";function ot(t,e,r,i){if(n=e,"undefined"!=typeof WebGLBuffer&&n instanceof WebGLBuffer)return e;var n;r=r||34962;const o=t.createBuffer();return function(t,e,r,i,n){t.bindBuffer(e,r),t.bufferData(e,i,n||35044)}(t,r,o,e,i),o}function at(t){return"indices"===t}const st=/coord|texture/i,ut=/color|colour/i;function ht(t,e){let r;if(r=st.test(t)?2:ut.test(t)?4:3,e%r>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${r} but ${e} values is not evenly divisible by ${r}. You should specify it.`);return r}function ft(t,e){if(rt(t))return t;if(rt(t.data))return t.data;Array.isArray(t)&&(t={data:t});let r=t.type;return r||(r=at(e)?Uint16Array:Float32Array),new r(t.data)}function ct(t,e){const r={};return Object.keys(e).forEach((function(i){if(!at(i)){const o=e[i],a=o.attrib||o.name||o.attribName||nt+i;if(o.value){if(!Array.isArray(o.value)&&!rt(o.value))throw new Error("array.value is not array or typedarray");r[a]={value:o.value}}else{let e,s,u,h;if(o.buffer&&o.buffer instanceof WebGLBuffer)e=o.buffer,h=o.numComponents||o.size,s=o.type,u=o.normalize;else if("number"==typeof o||"number"==typeof o.data){const r=o.data||o,a=o.type||Float32Array,f=r*a.BYTES_PER_ELEMENT;s=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(a),u=void 0!==o.normalize?o.normalize:(n=a)===Int8Array||n===Uint8Array,h=o.numComponents||o.size||ht(i,r),e=t.createBuffer(),t.bindBuffer(34962,e),t.bufferData(34962,f,o.drawType||35044)}else{const r=ft(o,i);e=ot(t,r,void 0,o.drawType),s=et(r),u=void 0!==o.normalize?o.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(r),h=function(t,e){return t.numComponents||t.size||ht(e,function(t){return t.length?t:t.data}(t).length)}(o,i)}r[a]={buffer:e,numComponents:h,type:s,normalize:u,stride:o.stride||0,offset:o.offset||0,divisor:void 0===o.divisor?void 0:o.divisor,drawType:o.drawType}}}var n})),t.bindBuffer(34962,null),r}const lt=["position","positions","a_position"];function dt(t,e,r){const i=ct(t,e),n=Object.assign({},r||{});n.attribs=Object.assign({},r?r.attribs:{},i);const o=e.indices;if(o){const e=ft(o,"indices");n.indices=ot(t,e,34963),n.numElements=e.length,n.elementType=et(e)}else n.numElements||(n.numElements=function(t,e){let r,i;for(i=0;i<lt.length&&(r=lt[i],!(r in e))&&(r=nt+r,!(r in e));++i);i===lt.length&&(r=Object.keys(e)[0]);const n=e[r];t.bindBuffer(34962,n.buffer);const o=t.getBufferParameter(34962,34660);var a;t.bindBuffer(34962,null);const s=o/(5120===(a=n.type)||5121===a?1:5122===a||5123===a?2:5124===a||5125===a||5126===a?4:0),u=n.numComponents||n.size,h=s/u;if(h%1!=0)throw new Error(`numComponents ${u} not correct for length ${length}`);return h}(t,n.attribs));return n}function pt(t){return!!t.texStorage2D}const mt={};function yt(t,e){return mt[e].bindPoint}function gt(t,e){return function(r){t.uniform1i(e,r)}}function vt(t,e){return function(r){t.uniform1iv(e,r)}}function bt(t,e){return function(r){t.uniform2iv(e,r)}}function wt(t,e){return function(r){t.uniform3iv(e,r)}}function At(t,e){return function(r){t.uniform4iv(e,r)}}function Ft(t,e,r,i){const n=yt(0,e);return pt(t)?function(e){let o,a;it(0,e)?(o=e,a=null):(o=e.texture,a=e.sampler),t.uniform1i(i,r),t.activeTexture(33984+r),t.bindTexture(n,o),t.bindSampler(r,a)}:function(e){t.uniform1i(i,r),t.activeTexture(33984+r),t.bindTexture(n,e)}}function xt(t,e,r,i,n){const o=yt(0,e),a=new Int32Array(n);for(let t=0;t<n;++t)a[t]=r+t;return pt(t)?function(e){t.uniform1iv(i,a),e.forEach((function(e,i){let n,s;t.activeTexture(33984+a[i]),it(0,e)?(n=e,s=null):(n=e.texture,s=e.sampler),t.bindSampler(r,s),t.bindTexture(o,n)}))}:function(e){t.uniform1iv(i,a),e.forEach((function(e,r){t.activeTexture(33984+a[r]),t.bindTexture(o,e)}))}}function Tt(t,e){return function(r){if(r.value)switch(t.disableVertexAttribArray(e),r.value.length){case 4:t.vertexAttrib4fv(e,r.value);break;case 3:t.vertexAttrib3fv(e,r.value);break;case 2:t.vertexAttrib2fv(e,r.value);break;case 1:t.vertexAttrib1fv(e,r.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,r.numComponents||r.size,r.type||5126,r.normalize||!1,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function Pt(t,e){return function(r){if(r.value){if(t.disableVertexAttribArray(e),4!==r.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(e,r.value)}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.numComponents||r.size,r.type||5124,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function St(t,e){return function(r){if(r.value){if(t.disableVertexAttribArray(e),4!==r.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(e,r.value)}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.numComponents||r.size,r.type||5125,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function _t(t,e,r){const i=r.size,n=r.count;return function(r){t.bindBuffer(34962,r.buffer);const o=r.size||r.numComponents||i,a=o/n,s=r.type||5126,u=mt[s].size*o,h=r.normalize||!1,f=r.offset||0,c=u/n;for(let i=0;i<n;++i)t.enableVertexAttribArray(e+i),t.vertexAttribPointer(e+i,a,s,h,u,f+c*i),void 0!==r.divisor&&t.vertexAttribDivisor(e+i,r.divisor)}}mt[5126]={Type:Float32Array,size:4,setter:function(t,e){return function(r){t.uniform1f(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1fv(e,r)}}},mt[35664]={Type:Float32Array,size:8,setter:function(t,e){return function(r){t.uniform2fv(e,r)}}},mt[35665]={Type:Float32Array,size:12,setter:function(t,e){return function(r){t.uniform3fv(e,r)}}},mt[35666]={Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniform4fv(e,r)}}},mt[5124]={Type:Int32Array,size:4,setter:gt,arraySetter:vt},mt[35667]={Type:Int32Array,size:8,setter:bt},mt[35668]={Type:Int32Array,size:12,setter:wt},mt[35669]={Type:Int32Array,size:16,setter:At},mt[5125]={Type:Uint32Array,size:4,setter:function(t,e){return function(r){t.uniform1ui(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1uiv(e,r)}}},mt[36294]={Type:Uint32Array,size:8,setter:function(t,e){return function(r){t.uniform2uiv(e,r)}}},mt[36295]={Type:Uint32Array,size:12,setter:function(t,e){return function(r){t.uniform3uiv(e,r)}}},mt[36296]={Type:Uint32Array,size:16,setter:function(t,e){return function(r){t.uniform4uiv(e,r)}}},mt[35670]={Type:Uint32Array,size:4,setter:gt,arraySetter:vt},mt[35671]={Type:Uint32Array,size:8,setter:bt},mt[35672]={Type:Uint32Array,size:12,setter:wt},mt[35673]={Type:Uint32Array,size:16,setter:At},mt[35674]={Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniformMatrix2fv(e,!1,r)}}},mt[35675]={Type:Float32Array,size:36,setter:function(t,e){return function(r){t.uniformMatrix3fv(e,!1,r)}}},mt[35676]={Type:Float32Array,size:64,setter:function(t,e){return function(r){t.uniformMatrix4fv(e,!1,r)}}},mt[35685]={Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix2x3fv(e,!1,r)}}},mt[35686]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix2x4fv(e,!1,r)}}},mt[35687]={Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix3x2fv(e,!1,r)}}},mt[35688]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix3x4fv(e,!1,r)}}},mt[35689]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix4x2fv(e,!1,r)}}},mt[35690]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix4x3fv(e,!1,r)}}},mt[35678]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:3553},mt[35680]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:34067},mt[35679]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:32879},mt[35682]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:3553},mt[36289]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:35866},mt[36292]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:35866},mt[36293]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:34067},mt[36298]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:3553},mt[36299]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:32879},mt[36300]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:34067},mt[36303]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:35866},mt[36306]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:3553},mt[36307]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:32879},mt[36308]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:34067},mt[36311]={Type:null,size:0,setter:Ft,arraySetter:xt,bindPoint:35866};const Et={};function Ut(t){const e=t.name;return e.startsWith("gl_")||e.startsWith("webgl_")}function kt(t,e){const r=t.uniformSetters||t,i=arguments.length;for(let t=1;t<i;++t){const e=arguments[t];if(Array.isArray(e)){const t=e.length;for(let i=0;i<t;++i)kt(r,e[i])}else for(const t in e){const i=r[t];i&&i(e[t])}}}function Ct(t,e){const r={program:e,uniformSetters:function(t,e){let r=0;function i(e,i,n){const o=i.name.endsWith("[0]"),a=i.type,s=mt[a];if(!s)throw new Error("unknown type: 0x"+a.toString(16));let u;if(s.bindPoint){const e=r;r+=i.size,u=o?s.arraySetter(t,a,e,n,i.size):s.setter(t,a,e,n,i.size)}else u=s.arraySetter&&o?s.arraySetter(t,n):s.setter(t,n);return u.location=n,u}const n={},o=t.getProgramParameter(e,35718);for(let r=0;r<o;++r){const o=t.getActiveUniform(e,r);if(Ut(o))continue;let a=o.name;a.endsWith("[0]")&&(a=a.substr(0,a.length-3));const s=t.getUniformLocation(e,o.name);s&&(n[a]=i(0,o,s))}return n}(t,e),attribSetters:function(t,e){const r={},i=t.getProgramParameter(e,35721);for(let n=0;n<i;++n){const i=t.getActiveAttrib(e,n);if(Ut(i))continue;const o=t.getAttribLocation(e,i.name),a=Et[i.type],s=a.setter(t,o,a);s.location=o,r[i.name]=s}return r}(t,e)};return pt(t)&&(r.uniformBlockSpec=function(t,e){const r=t.getProgramParameter(e,35718),i=[],n=[];for(let o=0;o<r;++o){n.push(o),i.push({});const r=t.getActiveUniform(e,o);if(Ut(r))break;i[o].name=r.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(r){const o=r[0],a=r[1];t.getActiveUniforms(e,n,t[o]).forEach((function(t,e){i[e][a]=t}))}));const o={},a=t.getProgramParameter(e,35382);for(let r=0;r<a;++r){const i=t.getActiveUniformBlockName(e,r),n={index:t.getUniformBlockIndex(e,i),usedByVertexShader:t.getActiveUniformBlockParameter(e,r,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(e,r,35398),size:t.getActiveUniformBlockParameter(e,r,35392),uniformIndices:t.getActiveUniformBlockParameter(e,r,35395)};n.used=n.usedByVertexShader||n.usedByFragmentShader,o[i]=n}return{blockSpecs:o,uniformData:i}}(t,e),r.transformFeedbackInfo=function(t,e){const r={},i=t.getProgramParameter(e,35971);for(let n=0;n<i;++n){const i=t.getTransformFeedbackVarying(e,n);r[i.name]={index:n,type:i.type,size:i.size}}return r}(t,e)),r}Et[5126]={size:4,setter:Tt},Et[35664]={size:8,setter:Tt},Et[35665]={size:12,setter:Tt},Et[35666]={size:16,setter:Tt},Et[5124]={size:4,setter:Pt},Et[35667]={size:8,setter:Pt},Et[35668]={size:12,setter:Pt},Et[35669]={size:16,setter:Pt},Et[5125]={size:4,setter:St},Et[36294]={size:8,setter:St},Et[36295]={size:12,setter:St},Et[36296]={size:16,setter:St},Et[35670]={size:4,setter:Pt},Et[35671]={size:8,setter:Pt},Et[35672]={size:12,setter:Pt},Et[35673]={size:16,setter:Pt},Et[35674]={size:4,setter:_t,count:2},Et[35675]={size:9,setter:_t,count:3},Et[35676]={size:16,setter:_t,count:4};var Lt="#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}",Bt=function(){function t(e,r,n,o){var a=this;void 0===r&&(r=640),void 0===n&&(n=480),void 0===o&&(o={}),this.refs={programs:[],shaders:[],textures:[],buffers:[],framebuffers:[]},this.isCtxLost=!1,this.handleContextLoss=function(t){t.preventDefault(),a.destroy(),a.isCtxLost=!0,a.options.onlost()},this.handleContextRestored=function(t){a.isCtxLost=!1,a.init(),a.options.onrestored()},v(),this.el=e,this.width=r,this.height=n,this.options=i(i({},t.defaultOptions),o),e.addEventListener("webglcontextlost",this.handleContextLoss,!1),e.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.gl=e.getContext("webgl",{antialias:!1,alpha:!0}),this.init()}return t.prototype.init=function(){var t=this.gl;this.layerDrawProgram=this.createProgram(Lt,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_palette;uniform sampler2D u_bitmap;uniform float u_paletteOffset;const vec4 transparent=vec4(0,0,0,0);void main(){float index=texture2D(u_bitmap,v_uv).a*255.;if(index>0.){gl_FragColor=texture2D(u_palette,vec2((u_paletteOffset+index)/8.,.5));}else{gl_FragColor=transparent;}}"),this.postProcessProgram=this.createProgram(Lt,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,8,8),this.setBuffersAndAttribs(this.layerDrawProgram,this.quadBuffer),this.setBuffersAndAttribs(this.postProcessProgram,this.quadBuffer),this.paletteData=new Uint8Array(32),this.paletteTexture=this.createTexture(t.RGBA,t.NEAREST,t.CLAMP_TO_EDGE,8,1),this.layerTexture=this.createTexture(t.ALPHA,t.NEAREST,t.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameBuffer=this.createFrameBuffer(this.frameTexture),this.setCanvasSize(this.width,this.height)},t.prototype.createProgram=function(t,e){m(!this.isCtxLost);var r=this.gl,i=this.createShader(r.VERTEX_SHADER,t),n=this.createShader(r.FRAGMENT_SHADER,e),o=r.createProgram();if(r.attachShader(o,i),r.attachShader(o,n),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS)){var a=r.getProgramInfoLog(o);throw r.deleteProgram(o),new Error(a)}var s=Ct(r,o);return this.refs.programs.push(o),s},t.prototype.createShader=function(t,e){m(!this.isCtxLost);var r=this.gl,i=r.createShader(t);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){var n=r.getShaderInfoLog(i);throw r.deleteShader(i),new Error(n)}return this.refs.shaders.push(i),i},t.prototype.createScreenQuad=function(t,e,r,i,n,o){m(!this.isCtxLost);for(var a=(n+1)*(o+1),s=n+1,u=new Float32Array(2*a),h=new Float32Array(2*a),f=0,c=0,l=0;l<=o;l++)for(var d=0;d<=n;d++){var p=d/n,y=l/o;u[f++]=t+r*p,u[f++]=e+i*y,h[c++]=p,h[c++]=y}var g=new Uint16Array(n*o*2*3),v=0;for(l=0;l<o;l++)for(d=0;d<n;d++)g[v++]=(l+0)*s+d,g[v++]=(l+1)*s+d,g[v++]=(l+0)*s+d+1,g[v++]=(l+0)*s+d+1,g[v++]=(l+1)*s+d,g[v++]=(l+1)*s+d+1;var b=dt(this.gl,{position:{numComponents:2,data:u},texcoord:{numComponents:2,data:h},indices:g});for(var w in b.attribs)this.refs.buffers.push(b.attribs[w].buffer);return b},t.prototype.setBuffersAndAttribs=function(t,e){var r=this.gl;!function(t,e){for(const r in e){const i=t[r];i&&i(e[r])}}(t.attribSetters,e.attribs),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,e.indices)},t.prototype.createTexture=function(t,e,r,i,n){void 0===i&&(i=1),void 0===n&&(n=1),m(!this.isCtxLost);var o=this.gl,a=o.createTexture();return o.bindTexture(o.TEXTURE_2D,a),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,r),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,r),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,e),o.texImage2D(o.TEXTURE_2D,0,t,i,n,0,t,o.UNSIGNED_BYTE,null),this.refs.textures.push(a),a},t.prototype.createFrameBuffer=function(t){m(!this.isCtxLost);var e=this.gl,r=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,r),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),this.refs.framebuffers.push(r),r},t.prototype.setCanvasSize=function(t,e){m(!this.isCtxLost);var r=window.devicePixelRatio||1,i=t*r,n=e*r;this.width=t,this.height=e,this.el.width=i,this.el.height=n,this.screenWidth=i,this.screenHeight=n,this.el.style.width=t+"px",this.el.style.height=e+"px"},t.prototype.setInputSize=function(t,e){var r=this.gl;this.textureWidth=t,this.textureHeight=e,r.bindTexture(r.TEXTURE_2D,this.frameTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.textureWidth,this.textureHeight,0,r.RGBA,r.UNSIGNED_BYTE,null)},t.prototype.clearFrameBuffer=function(t){m(!this.isCtxLost);var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),e.viewport(0,0,this.textureWidth,this.textureHeight);var r=t[0],i=t[1],n=t[2],o=t[3];e.clearColor(r/255,i/255,n/255,o/255),e.clear(e.COLOR_BUFFER_BIT)},t.prototype.setPalette=function(t){m(!this.isCtxLost),m(t.length<16);for(var e=this.gl,r=this.paletteData.fill(0),i=0,n=0;n<t.length;n++){var o=t[n],a=o[0],s=o[1],u=o[2],h=o[3];r[i++]=a,r[i++]=s,r[i++]=u,r[i++]=h}e.bindTexture(e.TEXTURE_2D,this.paletteTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,8,1,0,e.RGBA,e.UNSIGNED_BYTE,r)},t.prototype.drawPixels=function(t,e){var r=this,i=r.gl,n=r.layerDrawProgram,o=r.layerTexture,a=r.textureWidth,s=r.textureHeight;m(!this.isCtxLost),m(t.length===a*s),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.viewport(0,0,a,s),i.useProgram(n.program),i.bindTexture(i.TEXTURE_2D,o),i.texImage2D(i.TEXTURE_2D,0,i.ALPHA,a,s,0,i.ALPHA,i.UNSIGNED_BYTE,t),kt(n,{u_palette:this.paletteTexture,u_paletteOffset:e,u_bitmap:o,u_textureSize:[a,s],u_screenSize:[i.drawingBufferWidth,i.drawingBufferHeight]}),i.drawElements(i.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.composite=function(){var t=this.gl;m(!this.isCtxLost),t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.useProgram(this.postProcessProgram.program),t.clear(t.COLOR_BUFFER_BIT),kt(this.postProcessProgram,{u_flipY:!0,u_tex:this.frameTexture,u_textureSize:[this.textureWidth,this.textureHeight],u_screenSize:[t.drawingBufferWidth,t.drawingBufferHeight]}),t.drawElements(t.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.isErrorState=function(){var t=this.gl,e=t.getError();return e!=t.NO_ERROR&&e!=t.CONTEXT_LOST_WEBGL},t.prototype.isLost=function(){return this.gl.isContextLost()},t.prototype.destroy=function(){return n(this,void 0,void 0,(function(){var t,e;return o(this,(function(r){return t=this.refs,e=this.gl,t.shaders.forEach((function(t){e.deleteShader(t)})),t.shaders=[],t.framebuffers.forEach((function(t){e.deleteFramebuffer(t)})),t.framebuffers=[],t.textures.forEach((function(t){e.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){e.deleteBuffer(t)})),t.buffers=[],t.programs.forEach((function(t){e.deleteProgram(t)})),t.programs=[],this.paletteData=null,e.canvas.width=1,e.canvas.height=1,[2]}))}))},t.defaultOptions={onlost:function(){},onrestored:function(){}},t}(),Rt=g?window.AudioContext||window.webkitAudioContext:null,Mt=function(){function t(){this.useEq=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this._volume=1,this._loop=!1,this.nodeRefs=[],v()}return Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t,this.source&&(this.source.loop=t)},enumerable:!1,configurable:!0}),t.prototype.getCtx=function(){return this.ctx||(this.ctx=new Rt),this.ctx},t.prototype.setBuffer=function(t,e){var r=this.getCtx(),i=t.length,n=r.createBuffer(1,i,e),o=n.getChannelData(0);if(t instanceof Float32Array)o.set(t,0);else if(t instanceof Int16Array)for(var a=0;a<i;a++)o[a]=t[a]/32768;this.buffer=n,this.sampleRate=e},t.prototype.connectEqNodesTo=function(t){var e=this,r=this.getCtx(),i=this.eqSettings,n=t;return i.forEach((function(t,o){var a=t[0],s=t[1],u=r.createBiquadFilter();e.nodeRefs.push(u),u.frequency.value=a,u.gain.value=s,0===o?u.type="lowshelf":o===i.length-1?u.type="highshelf":u.type="peaking",n.connect(u),n=u})),n},t.prototype.initNodes=function(){var t=this.getCtx();this.nodeRefs=[];var e=t.createBufferSource();this.nodeRefs.push(e),e.buffer=this.buffer;var r=t.createGain();(this.nodeRefs.push(r),this.useEq)?this.connectEqNodesTo(e).connect(r):e.connect(r);e.connect(r),r.connect(t.destination),this.source=e,this.gainNode=r,this.setVolume(this._volume)},t.prototype.setVolume=function(t){this._volume=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))},t.prototype.playFrom=function(t){this.initNodes(),this.source.loop=this._loop,this.source.start(0,t)},t.prototype.stop=function(){this.source&&this.source.stop(0)},t.prototype.destroy=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return this.stop(),t=this.getCtx(),this.nodeRefs.forEach((function(t){return t.disconnect()})),this.nodeRefs=[],"closed"===t.state||"function"!=typeof t.close?[3,2]:[4,t.close()];case 1:e.sent(),e.label=2;case 2:return this.buffer=null,[2]}}))}))},t}();function It(t){return{length:t.length,start:function(e){return t[e][0]},end:function(e){return t[e][1]}}}function zt(t,e){return t.toString().padStart(e,"0")}function Nt(t){return Math.floor(t%3600/60)+":"+zt(Math.floor(t%60),2)}var Ot=function(){function e(t,e,r){var i=this;this.duration=0,this.autoplay=!1,this.supportedEvents=tt,this._src=null,this._loop=!1,this._volume=1,this._muted=!1,this._frame=null,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=function(t){if(i.isPlaying){var e=t/1e3,r=e-i.playbackStartTime;r>=i.duration&&(i.loop?(i.playbackStartTime=e,i.emit($.Loop)):(i.pause(),i.emit($.Ended))),i.setCurrentTime(r%i.duration),i.playbackLoopId=requestAnimationFrame(i.playbackLoop)}},v(),t="string"==typeof t?document.querySelector(t):t,this.renderer=new Bt(t,e,r,{onlost:function(){return i.emit($.Error)},onrestored:function(){return i.load()}}),this.audio=new Mt,this.canvasEl=this.renderer.el}return Object.defineProperty(e.prototype,"src",{get:function(){return this._src},set:function(t){this.load(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"paused",{get:function(){return!this.isPlaying},set:function(t){t?this.pause():this.play()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentFrame",{get:function(){return this._frame},set:function(t){this.setCurrentFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return this.isNoteLoaded?this.playbackTime:null},set:function(t){this.setCurrentTime(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"progress",{get:function(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null},set:function(t){this.setProgress(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this.getVolume()},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"muted",{get:function(){return this.getMuted()},set:function(t){this.setMuted(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loop",{get:function(){return this.getLoop()},set:function(t){this.setLoop(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"buffered",{get:function(){return It([[0,this.duration]])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"seekable",{get:function(){return It([[0,this.duration]])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentSrc",{get:function(){return this._src},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"videoWidth",{get:function(){return this.isNoteLoaded?this.note.imageWidth:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"videoHeight",{get:function(){return this.isNoteLoaded?this.note.imageHeight:0},enumerable:!1,configurable:!0}),e.prototype.load=function(t){return void 0===t&&(t=null),n(this,void 0,void 0,(function(){var e=this;return o(this,(function(r){return this.isNoteLoaded&&this.closeNote(),t?(this.emit($.LoadStart),[2,Q(t).then((function(r){e.openNote(r),e._src=t})).catch((function(t){throw e.emit($.Error,t),new Error("Error loading Flipnote: "+t.message)}))]):[2,this.openNote(this.note)]}))}))},e.prototype.closeNote=function(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this._src=null,this._frame=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clearFrameBuffer([0,0,0,0])},e.prototype.openNote=function(t){this.isNoteLoaded&&this.closeNote(),this.note=t,this.meta=t.meta,this.emit($.LoadedMeta),this.noteFormat=t.format,this.duration=t.duration,this.playbackTime=0,this._frame=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=t.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(t.getAudioMasterPcm(),t.sampleRate),this.emit($.CanPlay),this.emit($.CanPlayThrough),this.setLoop(t.meta.loop),this.renderer.setInputSize(t.imageWidth,t.imageHeight),this.drawFrame(t.thumbFrameIndex),this.emit($.LoadedData),this.emit($.Load),this.emit($.Ready),this.autoplay&&this.play()},e.prototype.setCurrentTime=function(t){this.assertNoteLoaded();var e=Math.floor(t/(1/this.framerate));this.setCurrentFrame(e),this.playbackTime=t,this.emit($.Progress,this.progress)},e.prototype.getCurrentTime=function(){return this.currentTime},e.prototype.getTimeCounter=function(){return Nt(Math.max(this.currentTime,0))+" / "+Nt(this.duration)},e.prototype.getFrameCounter=function(){return zt(this.currentFrame+1,3)+" / "+zt(this.frameCount,3)},e.prototype.setProgress=function(t){this.assertNoteLoaded(),y(t,0,100,"progress"),this.currentTime=this.duration*(t/100)},e.prototype.getProgress=function(){return this.progress},e.prototype.play=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){return this.assertNoteLoaded(),this.isPlaying||(this.isPlaying=!0,this.hasPlaybackStarted=!0,t=performance.now(),this.playbackStartTime=t/1e3-this.playbackTime,this.playAudio(),this.playbackLoop(t),this.emit($.Play)),[2]}))}))},e.prototype.pause=function(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit($.Pause))},e.prototype.togglePlay=function(){this.isPlaying?this.pause():this.play()},e.prototype.getPaused=function(){return!this.isPlaying},e.prototype.getDuration=function(){return this.duration},e.prototype.getLoop=function(){return this._loop},e.prototype.setLoop=function(t){this._loop=t,this.audio.loop=t},e.prototype.toggleLoop=function(){this.setLoop(!this._loop)},e.prototype.setCurrentFrame=function(t){this.assertNoteLoaded();var e=Math.max(0,Math.min(Math.floor(t),this.frameCount-1));(e!==this.currentFrame||this.showThumbnail)&&(this._frame=e,this.drawFrame(e),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=e*(1/this.framerate),this.emit($.SeekEnd)),this.emit($.FrameUpdate,this.currentFrame),this.emit($.Progress,this.progress),this.emit($.TimeUpdate,this.currentFrame))},e.prototype.nextFrame=function(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit($.FrameNext)},e.prototype.prevFrame=function(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit($.FramePrev)},e.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1,this.emit($.FrameLast)},e.prototype.firstFrame=function(){this.currentFrame=0,this.emit($.FrameFirst)},e.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},e.prototype.startSeek=function(){this.isSeeking||(this.emit($.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)},e.prototype.seek=function(t){this.isSeeking&&(this.progress=100*t)},e.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},e.prototype.drawFrame=function(e){var r=this.note,i=this.renderer,n=r.getFramePalette(e),o=r.decodeFrame(e),a=this.layerVisibility;if(i.setPalette(n),i.clearFrameBuffer(n[0]),r.format===t.FlipnoteFormat.PPM)a[2]&&i.drawPixels(o[1],1),a[1]&&i.drawPixels(o[0],0);else if(r.format===t.FlipnoteFormat.KWZ){var s=r.getFrameLayerOrder(e),u=s[0],h=s[1],f=s[2];a[u+1]&&i.drawPixels(o[u],2*u),a[h+1]&&i.drawPixels(o[h],2*h),a[f+1]&&i.drawPixels(o[f],2*f)}i.composite()},e.prototype.forceUpdate=function(){this.isNoteLoaded&&this.drawFrame(this.currentFrame)},e.prototype.resize=function(t,e){e!==.75*t&&console.warn("Canvas width to height ratio should be 3:4 for best results (got "+t+"x"+e+")"),this.renderer.setCanvasSize(t,e),this.forceUpdate()},e.prototype.setLayerVisibility=function(t,e){this.layerVisibility[t]=e,this.forceUpdate()},e.prototype.getLayerVisibility=function(t){return this.layerVisibility[t]},e.prototype.toggleLayerVisibility=function(t){this.setLayerVisibility(t,!this.layerVisibility[t])},e.prototype.playAudio=function(){this.audio.playFrom(this.currentTime)},e.prototype.stopAudio=function(){this.audio.stop()},e.prototype.toggleAudioEq=function(){this.setAudioEq(!this.audio.useEq)},e.prototype.setAudioEq=function(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())},e.prototype.mute=function(){this.setMuted(!0)},e.prototype.unmute=function(){this.setMuted(!1)},e.prototype.setMuted=function(t){this.audio.volume=t?0:this._volume,this._muted=t,this.emit($.VolumeChange,this.audio.volume)},e.prototype.getMuted=function(){return 0===this.volume||this._muted},e.prototype.toggleMuted=function(){this.setMuted(!this._muted)},e.prototype.setVolume=function(t){y(t,0,1,"volume"),this._volume=t,this.audio.volume=t,this.emit($.VolumeChange,this.audio.volume)},e.prototype.getVolume=function(){return this._muted?0:this._volume},e.prototype.seekToNextFrame=function(){this.nextFrame()},e.prototype.fastSeek=function(t){this.currentTime=t},e.prototype.canPlayType=function(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";case"video/vnd.nintendo.ugomemo.fykt":default:return""}},e.prototype.getVideoPlaybackQuality=function(){return{creationTime:0,droppedVideoFrames:0,totalVideoFrames:this.frameCount}},e.prototype.requestPictureInPicture=function(){throw new Error("Not implemented")},e.prototype.captureStream=function(){throw new Error("Not implemented")},e.prototype.on=function(t,e){var r=this.events;(Array.isArray(t)?t:[t]).forEach((function(t){r.has(t)?r.get(t).push(e):r.set(t,[e])}))},e.prototype.off=function(t,e){var r=this.events;(Array.isArray(t)?t:[t]).forEach((function(t){if(r.has(t)){var i=r.get(t);r.set(t,i.splice(i.indexOf(e),1))}}))},e.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var i=this.events;if(t!==$.__Any&&i.has(t)){i.get(t).forEach((function(t){return t.apply(null,e)}));var n="on"+t,o=this;"function"==typeof o[n]&&o[n].apply(null,e)}i.has($.__Any)&&i.get($.__Any).forEach((function(r){return r.apply(null,a([t],e))}))},e.prototype.clearEvents=function(){this.events.clear()},e.prototype.destroy=function(){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return this.clearEvents(),this.emit($.Destroy),this.closeNote(),[4,this.renderer.destroy()];case 1:return t.sent(),[4,this.audio.destroy()];case 2:return t.sent(),[2]}}))}))},e.prototype.supports=function(t){var e=this.supportedEvents.includes(t),r="function"==typeof this[t];return e||r},e.prototype.assertNoteLoaded=function(){m(this.isNoteLoaded,"No Flipnote is currently loaded in this player")},e}(),Dt=function(){function t(){this.dataUrl=null}return t.prototype.getBuffer=function(){return m(b,"This feature is only available in NodeJS environments"),Buffer.from(this.getArrayBuffer())},t.prototype.getBlob=function(){return v(),new Blob([this.getArrayBuffer()],{type:this.mimeType})},t.prototype.getUrl=function(){return v(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())},t.prototype.revokeUrl=function(){v(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)},t}(),Ht=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],Wt=function(){function t(t,e,r){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.colorDepth=r,this.reset()}return t.prototype.reset=function(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0},t.prototype.char_out=function(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var e=0;e<t;++e)this.htab[e]=-1},t.prototype.compress=function(t,e){var r,i,n,o,a,s;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,o=this.nextPixel(),s=0,r=5003;r<65536;r*=2)++s;s=8-s,this.cl_hash(5003),this.output(this.ClearCode,e);t:for(;-1!=(i=this.nextPixel());)if(r=(i<<12)+o,n=i<<s^o,this.htab[n]!==r){if(this.htab[n]>=0){a=5003-n,0===n&&(a=1);do{if((n-=a)<0&&(n+=5003),this.htab[n]===r){o=this.codetab[n];continue t}}while(this.htab[n]>=0)}this.output(o,e),o=i,this.free_ent<4096?(this.codetab[n]=this.free_ent++,this.htab[n]=r):this.cl_block(e)}else o=this.codetab[n];this.output(o,e),this.output(this.EOFCode,e)},t.prototype.encode=function(t,e){this.pixels=t,e.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,e),e.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,e){for(this.cur_accum&=Ht[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}},t}(),Vt=function(t){function e(r,n,o){void 0===o&&(o={});var a=t.call(this)||this;return a.mimeType="gif/image",a.frameCount=0,a.width=r,a.height=n,a.data=new s,a.settings=i(i({},e.defaultSettings),o),a.compressor=new Wt(r,n,o.colorDepth),a}return r(e,t),e.fromFlipnote=function(t,r){var n;void 0===r&&(r={});var o=new e(t.imageWidth,t.imageHeight,i({delay:100/t.framerate,repeat:(null===(n=t.meta)||void 0===n?void 0:n.loop)?-1:0},r));o.palette=t.globalPalette;for(var a=0;a<t.frameCount;a++)o.writeFrame(t.getFramePixels(a));return o},e.fromFlipnoteFrame=function(t,r,n){void 0===n&&(n={});var o=new e(t.imageWidth,t.imageHeight,i({delay:100/t.framerate,repeat:-1},n));return o.palette=t.globalPalette,o.writeFrame(t.getFramePixels(r)),o},e.prototype.writeFrame=function(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1},e.prototype.writeFirstFrame=function(t){for(var e=this.palette.length,r=1;1<<r<e;r+=1)continue;this.settings.colorDepth=r,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt(),this.writeFrameHeader(),this.writePixels(t)},e.prototype.writeAdditionalFrame=function(t){this.writeFrameHeader(),this.writePixels(t)},e.prototype.writeHeader=function(){var t=new u(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.settings.colorDepth-1),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},e.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.settings.colorDepth)),e=0,r=0;r<this.palette.length;r+=1){var i=this.palette[r],n=i[0],o=i[1],a=i[2];i[3];t[e++]=n,t[e++]=o,t[e++]=a}this.data.writeBytes(t)},e.prototype.writeNetscapeExt=function(){var t=new u(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.settings.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},e.prototype.writeFrameHeader=function(){var t=new u(new ArrayBuffer(18)),e=this.settings.transparentBg?1:0;t.writeBytes([33,249,4,0|e]),t.writeUint16(this.settings.delay),t.writeBytes([0,0]),t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},e.prototype.writePixels=function(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)},e.prototype.getArrayBuffer=function(){return this.data.getBuffer()},e.prototype.getImage=function(){v();var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},e.defaultSettings={transparentBg:!1,delay:100,repeat:-1,colorDepth:8},e}(Dt),Gt=function(t){function e(e,r,i){void 0===r&&(r=1),void 0===i&&(i=16);var n=t.call(this)||this;n.sampleRate=e,n.channels=r,n.bitsPerSample=i;var o=new ArrayBuffer(44),a=new u(o);return a.writeChars("RIFF"),a.writeUint32(0),a.writeChars("WAVE"),a.writeChars("fmt "),a.writeUint32(16),a.writeUint16(1),a.writeUint16(n.channels),a.writeUint32(n.sampleRate),a.writeUint32(n.sampleRate*n.bitsPerSample*n.channels/8),a.writeUint16(n.bitsPerSample*n.channels/8),a.writeUint16(n.bitsPerSample),a.writeChars("data"),a.writeUint32(0),n.header=a,n.pcmData=null,n}return r(e,t),e.fromFlipnote=function(t){var r=t.sampleRate,i=new e(r,1,16),n=t.getAudioMasterPcm(r);return i.writeSamples(n),i},e.fromFlipnoteTrack=function(t,r){var i=t.sampleRate,n=new e(i,1,16),o=t.getAudioTrackPcm(r,i);return n.writeSamples(o),n},e.prototype.writeSamples=function(t){var e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t},e.prototype.getArrayBuffer=function(){var t=this.header.bytes,e=new Uint8Array(this.pcmData.buffer),r=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return r.set(t),r.set(e,t.byteLength),r.buffer},e}(Dt);t.GifImage=Vt,t.KwzParser=J,t.Player=Ot,t.PpmParser=L,t.WavAudio=Gt,t.parseSource=Q,t.version="5.2.1",Object.defineProperty(t,"__esModule",{value:!0})}));
