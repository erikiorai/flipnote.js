/*!
 * flipnote.js v2.7.7
 * Browser-based playback of .ppm and .kwz animations from Flipnote Studio and Flipnote Studio 3D
 * 2018 James Daniel
 * github.com/jaames/flipnote.js
 * Flipnote Studio is (c) Nintendo Co., Ltd.
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.flipnote=e():t.flipnote=e()}("undefined"!=typeof self?self:this,function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=2)}([function(t,e){t.exports="#define GLSLIFY 1\nattribute vec4 a_position;\nvarying vec2 v_texcoord;\nvoid main() {\n  gl_Position = a_position;\n  v_texcoord = a_position.xy * vec2(0.5, -0.5) + 0.5;\n}"},function(t,e){t.exports="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texcoord;\nuniform vec4 u_color1;\nuniform vec4 u_color2;\nuniform sampler2D u_bitmap;\nuniform bool u_isSmooth;\nvoid main() {\n  float weightColor1 = texture2D(u_bitmap, v_texcoord).a;\n  float weightColor2 = texture2D(u_bitmap, v_texcoord).r;\n  float alpha = 1.0;\n  if (u_isSmooth) {\n    weightColor1 = smoothstep(0.0, .9, weightColor1);\n    weightColor2 = smoothstep(0.0, .9, weightColor2);\n    float alpha = weightColor1 + weightColor2;\n  }\n  gl_FragColor = vec4(u_color1.rgb, alpha) * weightColor1 + vec4(u_color2.rgb, alpha) * weightColor2;\n}\n"},function(t,e,r){t.exports=r(3)},function(t,e,r){"use strict";var i;r.r(e),function(t){t[t.Begin=0]="Begin",t[t.Current=1]="Current",t[t.End=2]="End"}(i||(i={}));var n=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.cursor=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!0,configurable:!0}),t.prototype.seek=function(t,e){switch(e){case i.End:this.cursor=this.data.byteLength+t;break;case i.Current:this.cursor+=t;break;case i.Begin:default:this.cursor=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.cursor);return this.cursor+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.cursor,t),this.cursor+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.cursor);return this.cursor+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.cursor,t),this.cursor+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var e=this.data.getUint16(this.cursor,t);return this.cursor+=2,e},t.prototype.writeUint16=function(t,e){void 0===e&&(e=!0),this.data.setUint16(this.cursor,t,e),this.cursor+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var e=this.data.getInt16(this.cursor,t);return this.cursor+=2,e},t.prototype.writeInt16=function(t,e){void 0===e&&(e=!0),this.data.setInt16(this.cursor,t,e),this.cursor+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var e=this.data.getUint32(this.cursor,t);return this.cursor+=4,e},t.prototype.writeUint32=function(t,e){void 0===e&&(e=!0),this.data.setUint32(this.cursor,t,e),this.cursor+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var e=this.data.getInt32(this.cursor,t);return this.cursor+=4,e},t.prototype.writeInt32=function(t,e){void 0===e&&(e=!0),this.data.setInt32(this.cursor,t,e),this.cursor+=4},t.prototype.readBytes=function(t){var e=new Uint8Array(this.data.buffer,this.cursor,t);return this.cursor+=e.byteLength,e},t.prototype.writeBytes=function(t){var e=this;t.forEach(function(t){return e.writeUint8(t)})},t.prototype.readHex=function(t,e){void 0===e&&(e=!1);for(var r=this.readBytes(t),i=[],n=0;n<r.length;n++)i.push(r[n].toString(16).padStart(2,"0"));return e&&i.reverse(),i.join("").toUpperCase()},t.prototype.readUtf8=function(t){for(var e=this.readBytes(t),r="",i=0;i<e.length;i++){var n=e[i];if(0==n)break;r+=String.fromCharCode(n)}return r},t.prototype.writeUtf8=function(t){for(var e=0;e<t.length;e++){var r=t.charCodeAt(e);this.writeUint8(r)}},t.prototype.readUtf16=function(t){var e=new Uint16Array(this.data.buffer,this.cursor,t);this.cursor+=e.byteLength;for(var r="",i=0;i<e.length;i++){var n=e[i];if(0==n)break;r+=String.fromCharCode(n)}return r},t}(),a=[{matches:function(t){return"string"==typeof t},load:function(t,e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onreadystatechange=function(t){4===i.readyState&&(i.status>=200&&i.status<300?e(i.response):r({type:"httpError",status:i.status,statusText:i.statusText}))},i.send(null)}},{matches:function(t){return t instanceof File},load:function(t,e,r){var i=new FileReader;i.onload=function(t){e(i.result)},i.onerror=function(t){r({type:"fileReadError"})},i.readAsArrayBuffer(t)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,r){e(t)}}];for(var o=new Int8Array([-1,2,-1,2]),s=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),h=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),u=new Int16Array(360),f=0;f<4;f++)for(var d=0;d<90;d++){var c=(l=h[d])>>3;1&f&&(c+=l),2&f&&(c=-c),u[f+4*d]=c}var p=new Int16Array(1440);for(f=0;f<16;f++)for(d=0;d<90;d++){var l;c=(l=h[d])>>3;4&f&&(c+=l),2&f&&(c+=l>>1),1&f&&(c+=l>>2),8&f&&(c=-c),p[f+16*d]=c}for(var y=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),m=[null,.5,1,2,4,6,12,20,30],v={WHITE:[255,255,255],BLACK:[14,14,14],RED:[255,42,42],BLUE:[10,57,255]},g=function(t){function e(r){var i=t.call(this,r)||this;return i.type=e.type,i.palette=v,i.prevDecodedFrame=null,i.decodeHeader(),i.decodeAnimationHeader(),i.decodeSoundHeader(),i.decodeMeta(),i.layers=[new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height)],i.prevLayers=[new Uint8Array(e.width*e.height),new Uint8Array(e.width*e.height)],i.prevDecodedFrame=null,i}return y(e,t),e.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},e.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},e.prototype.readFilename=function(){return[this.readHex(3),this.readUtf8(13),this.readUint16().toString().padStart(3,"0")].join("_")},e.prototype.readLineEncoding=function(){for(var t=new Uint8Array(e.height),r=0;r<48;r++)for(var i=this.readUint8(),n=0;n<8;n+=2)t[4*r+n/2]=i>>n&3;return t},e.prototype.decodeHeader=function(){this.seek(0);this.readUint32();this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},e.prototype.decodeMeta=function(){this.seek(16);var t=this.readUint16(),e=this.readInt16(),r=this.readUtf16(11),i=this.readUtf16(11),n=this.readUtf16(11),a=this.readHex(8,!0),o=this.readHex(8,!0),s=this.readFilename(),h=this.readFilename(),u=this.readHex(8,!0);this.seek(154);var f=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var d=this.readUint16();this.thumbFrameIndex=e,this.meta={lock:1===t,loop:1==(d>>1&1),frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:e,timestamp:f,spinoff:o!==a||o!==u,root:{filename:null,username:r,fsid:u},parent:{username:i,fsid:a,filename:s},current:{username:n,fsid:o,filename:h}}},e.prototype.decodeAnimationHeader=function(){var t=this;this.seek(1696);var e=this.readUint16();this.seek(1704),this.frameOffsets=new Uint32Array(e/4).map(function(r){return 1704+e+t.readUint32()})},e.prototype.decodeSoundHeader=function(){var t=1696+this.frameDataLength+this.frameCount;t%2!=0&&(t+=4-t%4),this.seek(t);var e=this.readUint32(),r=this.readUint32(),i=this.readUint32(),n=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),t+=32,this.framerate=m[this.frameSpeed],this.bgmrate=m[this.bgmSpeed],this.soundMeta={bgm:{offset:t,length:e},se1:{offset:t+=e,length:r},se2:{offset:t+=r,length:i},se3:{offset:t+=i,length:n}}},e.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},e.prototype.getFramePalette=function(t){this.seek(this.frameOffsets[t]);var e=this.palette,r=this.readUint8(),i=1&r,n=[e.BLACK,1==i?e.BLACK:e.WHITE,e.RED,e.BLUE];return[1==i?e.WHITE:e.BLACK,n[r>>1&3],n[r>>3&3]]},e.prototype.getLayerOrder=function(t){return[0,1]},e.prototype.decodeFrame=function(t){0===t||this.prevDecodedFrame===t-1||this.isNewFrame(t)||this.decodeFrame(t-1),this.seek(this.frameOffsets[t]);var r=this.readUint8(),i=r>>7&1,n=r>>5&3,a=0,o=0;this.prevLayers[0].set(this.layers[0]),this.prevLayers[1].set(this.layers[1]),this.prevDecodedFrame=t,this.layers[0].fill(0),this.layers[1].fill(0),n&&(a=this.readInt8(),o=this.readInt8());for(var s=[this.readLineEncoding(),this.readLineEncoding()],h=0;h<2;h++)for(var u=this.layers[h],f=0;f<e.height;f++){var d=s[h][f],c=f*e.width;switch(d){case 0:break;case 1:case 2:var p=this.readUint32(!1);for(2==d&&u.fill(255,c,c+e.width);4294967295&p;){if(2147483648&p)for(var l=this.readUint8(),y=0;y<8;y++)u[c+y]=l>>y&1?255:0;c+=8,p<<=1}break;case 3:for(;c<(f+1)*e.width;){for(l=this.readUint8(),y=0;y<8;y++)u[c+y]=l>>y&1?255:0;c+=8}}}if(!i)for(var m=void 0,v=void 0,g=0;g<e.height;g++)if(!(g-o<0)){if(g-o>=e.height)break;for(var b=0;b<e.width;b++)if(!(b-a<0)){if(b-a>=e.width)break;v=(m=b+g*e.width)-(a+o*e.width),this.layers[0][m]^=this.prevLayers[0][v],this.layers[1][m]^=this.prevLayers[1][v]}}return this.layers},e.prototype.getLayerPixels=function(t,r){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var i=this.layers[r],n=new Uint8Array(e.width*e.height),a=r+1,o=0;o<n.length;o++)0!==i[o]&&(n[o]=a);return n},e.prototype.getFramePixels=function(t,r){var i;(void 0===r&&(r=!1),r)?i=this.getFramePalette(t).map(function(t){return e.globalPalette.indexOf(t)}):i=[0,1,2];var n=this.decodeFrame(t),a=new Uint8Array(e.width*e.height);a.fill(i[0]);for(var o=0;o<a.length;o++){var s=n[0][o];n[1][o]&&(a[o]=i[2]),s&&(a[o]=i[1])}return a},e.prototype.hasAudioTrack=function(t){var e=["bgm","se1","se2","se3"][t];return this.soundMeta[e].length>0},e.prototype.decodeAudio=function(t){for(var e,r,i,n=this.soundMeta[t],a=new Uint8Array(this.buffer,n.offset,n.length),o=new Int16Array(2*a.length),h=0,u=0,f=0,d=0;d<a.length;d++)for(var c=a[d],l=0;l<8;)r=u+p[(e=c>>l&15)+16*f],i=f+s[e],i=Math.max(0,Math.min(i,79)),r=Math.max(-32767,Math.min(r,32767)),o[h]=r,h+=1,f=i,u=r,l+=4;return o},e.prototype.decodeSoundFlags=function(){var t=this;return this.seek(1696+this.frameDataLength),new Array(this.frameCount).fill([]).map(function(e){var r=t.readUint8();return[1&r,r>>1&1,r>>2&1]})},e.type="PPM",e.sampleRate=8192,e.width=256,e.height=192,e.globalPalette=[v.BLACK,v.WHITE,v.RED,v.BLUE],e}(n),b=new Uint16Array([0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740]),U=new Uint16Array([0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100]),w=new Uint16Array(6561),F=[0,3,7,1,4,8,2,5,6],E=0,A=0;A<9;A++)for(var x=0;x<9;x++)for(var L=0;L<9;L++)for(var _=0;_<9;_++)w[E]=9*(9*(9*F[A]+F[x])+F[L])+F[_],E++;var P=new Uint16Array(52488),S=(F=[0,65280,255],0);for(A=0;A<3;A++)for(x=0;x<3;x++)for(L=0;L<3;L++)for(_=0;_<3;_++)for(var T=0;T<3;T++)for(var C=0;C<3;C++)for(var I=0;I<3;I++)for(var O=0;O<3;O++)P.set([F[x],F[A],F[_],F[L],F[C],F[T],F[O],F[I]],S),S+=8;var M=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),R=[.2,.5,1,2,4,6,8,12,20,24,30],k={WHITE:[255,255,255],BLACK:[16,16,16],RED:[255,16,16],YELLOW:[255,231,0],GREEN:[0,134,49],BLUE:[0,56,206],NONE:[255,255,255]},D=function(t){function e(r){var i=t.call(this,r)||this;return i.type=e.type,i.palette=k,i.prevDecodedFrame=null,i.bitIndex=0,i.bitValue=0,i.layers=[new Uint16Array(e.width*e.height),new Uint16Array(e.width*e.height),new Uint16Array(e.width*e.height)],i.bitIndex=0,i.bitValue=0,i.load(),i}return M(e,t),e.prototype.load=function(){this.seek(0);for(var t=this.byteLength-256,e=0,r=0;e<t&&r<6;){this.seek(e);var i=this.readUtf8(4).substring(0,3),n=this.readUint32();this.sections[i]={offset:e,length:n},e+=n+8,r+=1}this.decodeMeta(),this.decodeFrameMeta(),this.decodeSoundHeader()},e.prototype.readBits=function(t){if(this.bitIndex+t>16){var e=this.readUint16();this.bitValue|=e<<16-this.bitIndex,this.bitIndex-=16}var r=(1<<t)-1,i=this.bitValue&r;return this.bitValue>>=t,this.bitIndex+=t,i},e.prototype.decodeMeta=function(){this.seek(this.sections.KFH.offset+12);var t=new Date(1e3*(this.readUint32()+946684800)),e=new Date(1e3*(this.readUint32()+946684800)),r=(this.readUint32(),this.readHex(10)),i=this.readHex(10),n=this.readHex(10),a=this.readUtf16(11),o=this.readUtf16(11),s=this.readUtf16(11),h=this.readUtf8(28),u=this.readUtf8(28),f=this.readUtf8(28),d=this.readUint16(),c=this.readUint16(),p=this.readUint16(),l=this.readUint8();this.readUint8();this.frameCount=d,this.thumbFrameIndex=c,this.frameSpeed=l,this.framerate=R[l],this.meta={lock:1==(1&p),loop:1==(p>>1&1),frame_count:d,frame_speed:l,thumb_index:c,timestamp:e,creation_timestamp:t,root:{username:a,fsid:r,filename:h},parent:{username:o,fsid:i,filename:u},current:{username:s,fsid:n,filename:f}}},e.prototype.decodeFrameMeta=function(){this.frameOffsets=new Uint32Array(this.frameCount),this.seek(this.sections.KMI.offset+8);for(var t=this.sections.KMC.offset+12,e=0;e<this.frameCount;e++){var r={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readHex(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(r),this.frameOffsets[e]=t,t+=r.layerSize[0]+r.layerSize[1]+r.layerSize[2]}},e.prototype.decodeSoundHeader=function(){var t=this.sections.KSN.offset+8;this.seek(t);var e=this.readUint32();this.bgmSpeed=e,this.bgmrate=R[e];var r=new Uint32Array(this.buffer,t+4,20);this.soundMeta={bgm:{offset:t+=28,length:r[0]},se1:{offset:t+=r[0],length:r[1]},se2:{offset:t+=r[1],length:r[2]},se3:{offset:t+=r[2],length:r[3]},se4:{offset:t+=r[3],length:r[4]}}},e.prototype.getDiffingFlag=function(t){return 7&~(this.frameMeta[t].flags>>4)},e.prototype.getLayerDepths=function(t){return this.frameMeta[t].layerDepth},e.prototype.getLayerOrder=function(t){var e=this.getLayerDepths(t);return[2,1,0].sort(function(t,r){return e[r]-e[t]})},e.prototype.decodeFrame=function(t,r,i){void 0===r&&(r=7),void 0===i&&(i=!1),i&&(r&=this.getDiffingFlag(t+1)),0!==t&&this.prevDecodedFrame!==t-1&&r&&this.decodeFrame(t-1,r=r,i=!0);for(var n=this.frameMeta[t],a=this.frameOffsets[t],o=0;o<3;o++){this.seek(a);var s=n.layerSize[o];if(a+=s,38!==s&&0!=(r>>o&1)){this.bitIndex=16,this.bitValue=0;for(var h=0,u=0;u<e.height;u+=128)for(var f=0;f<e.width;f+=128)for(var d=0;d<128;d+=8){var c=u+d;if(c>=e.height)break;for(var p=0;p<128;p+=8){var l=f+p;if(l>=e.width)break;if(h)h-=1;else{var y=c*e.width+l,m=this.layers[o],v=this.readBits(3);if(0==v){var g=b[this.readBits(5)],F=P.subarray(8*g,8*g+8);m.set(F,y),m.set(F,y+320),m.set(F,y+640),m.set(F,y+960),m.set(F,y+1280),m.set(F,y+1600),m.set(F,y+1920),m.set(F,y+2240)}else if(1==v){g=this.readBits(13),F=P.subarray(8*g,8*g+8);m.set(F,y),m.set(F,y+320),m.set(F,y+640),m.set(F,y+960),m.set(F,y+1280),m.set(F,y+1600),m.set(F,y+1920),m.set(F,y+2240)}else if(2==v){var E=this.readBits(5),A=b[E],x=U[E],L=P.subarray(8*A,8*A+8),_=P.subarray(8*x,8*x+8);m.set(L,y),m.set(_,y+320),m.set(L,y+640),m.set(_,y+960),m.set(L,y+1280),m.set(_,y+1600),m.set(L,y+1920),m.set(_,y+2240)}else if(3==v){A=this.readBits(13),x=w[A],L=P.subarray(8*A,8*A+8),_=P.subarray(8*x,8*x+8);m.set(L,y),m.set(_,y+320),m.set(L,y+640),m.set(_,y+960),m.set(L,y+1280),m.set(_,y+1600),m.set(L,y+1920),m.set(_,y+2240)}else if(4==v)for(var S=this.readBits(8),T=0;T<8;T++){g=0;g=S&1<<T?b[this.readBits(5)]:this.readBits(13);F=P.subarray(8*g,8*g+8);m.set(F,y+320*T)}else{if(5==v){h=this.readBits(5);continue}if(7==v){var C=this.readBits(2);A=0,x=0;this.readBits(1)?(A=b[this.readBits(5)],x=b[this.readBits(5)],C=(C+1)%4):(A=this.readBits(13),x=this.readBits(13));L=P.subarray(8*A,8*A+8),_=P.subarray(8*x,8*x+8);0==C?(m.set(L,y),m.set(_,y+320),m.set(L,y+640),m.set(_,y+960),m.set(L,y+1280),m.set(_,y+1600),m.set(L,y+1920),m.set(_,y+2240)):1==C?(m.set(L,y),m.set(L,y+320),m.set(_,y+640),m.set(L,y+960),m.set(L,y+1280),m.set(_,y+1600),m.set(L,y+1920),m.set(L,y+2240)):2==C?(m.set(L,y),m.set(_,y+320),m.set(L,y+640),m.set(L,y+960),m.set(_,y+1280),m.set(L,y+1600),m.set(L,y+1920),m.set(_,y+2240)):3==C&&(m.set(L,y),m.set(_,y+320),m.set(_,y+640),m.set(L,y+960),m.set(_,y+1280),m.set(_,y+1600),m.set(L,y+1920),m.set(_,y+2240))}}}}}}}return this.prevDecodedFrame=t,[new Uint8Array(this.layers[0].buffer),new Uint8Array(this.layers[1].buffer),new Uint8Array(this.layers[2].buffer)]},e.prototype.getFramePalette=function(t){var e=this.frameMeta[t].flags,r=[this.palette.WHITE,this.palette.BLACK,this.palette.RED,this.palette.YELLOW,this.palette.GREEN,this.palette.BLUE,this.palette.NONE];return[r[15&e],r[e>>8&15],r[e>>12&15],r[e>>16&15],r[e>>20&15],r[e>>24&15],r[e>>28&15]]},e.prototype.getLayerPixels=function(t,r){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var i=this.layers[r],n=new Uint8Array(e.width*e.height),a=2*r+1,o=0;o<i.length;o++){var s=i[o];65280&s?n[o]=a:255&s&&(n[o]=a+1)}return n},e.prototype.getFramePixels=function(t,r){var i,n=this;if(void 0===r&&(r=!1),r){var a=this.getFramePalette(t);i=a.map(function(t){return e.globalPalette.indexOf(t)})}else i=[0,1,2,3,4,5,6];var o=new Uint8Array(e.width*e.height);return o.fill(i[0]),this.getLayerOrder(t).forEach(function(e){for(var r=n.getLayerPixels(t,e),a=0;a<r.length;a++){var s=r[a];0!==s&&(o[a]=i[s])}}),o},e.prototype.decodeSoundFlags=function(){return this.frameMeta.map(function(t){var e=t.soundFlags;return[1&e,e>>1&1,e>>2&1,e>>3&1]})},e.prototype.hasAudioTrack=function(t){var e=["bgm","se1","se2","se3","se4"][t];return this.soundMeta[e].length>0},e.prototype.decodeAudio=function(t){for(var e,r,i,n=this.soundMeta[t],a=new Int16Array(981840),h=0,f=new Uint8Array(this.buffer,n.offset,n.length),d=0,c=40,l=0;l<f.length;l++)for(var y=f[l],m=0;m<8;)c<18||6==m?(r=d+u[(e=y>>m&3)+4*c],i=c+o[e],m+=2):(r=d+p[(e=y>>m&15)+16*c],i=c+s[e],m+=4),i=Math.max(0,Math.min(i,79)),r=Math.max(-2048,Math.min(r,2048)),a[h]=16*r,h+=1,c=i,d=r;return a.slice(0,h)},e.type="KWZ",e.sampleRate=16364,e.width=320,e.height=240,e.globalPalette=[k.BLACK,k.WHITE,k.RED,k.YELLOW,k.GREEN,k.BLUE,k.NONE],e}(n);function B(t){return function(t){return new Promise(function(e,r){for(var i=0;i<a.length;i++){var n=a[i];if(n.matches(t)){n.load(t,e,r);break}}})}(t).then(function(t){var e=new DataView(t,0,4).getUint32(0);return 1346458177===e?new g(t):1262897152==(4294967040&e)?new D(t):null})}var H,N,j,W,K=r(0),V=r.n(K),G=r(1),X=r.n(G);!function(t){t[t.Vertex=WebGLRenderingContext.VERTEX_SHADER]="Vertex",t[t.Fragment=WebGLRenderingContext.FRAGMENT_SHADER]="Fragment"}(H||(H={})),function(t){t[t.Alpha=WebGLRenderingContext.ALPHA]="Alpha",t[t.LuminanceAlpha=WebGLRenderingContext.LUMINANCE_ALPHA]="LuminanceAlpha"}(N||(N={})),function(t){t[t.Linear=WebGLRenderingContext.LINEAR]="Linear",t[t.Nearest=WebGLRenderingContext.NEAREST]="Nearest"}(j||(j={})),function(t){t[t.PPM=0]="PPM",t[t.KWZ=1]="KWZ"}(W||(W={}));var z=function(){function t(t,e,r,i){void 0===e&&(e=640),void 0===r&&(r=480),void 0===i&&(i={antialias:!1,alpha:!1}),this.uniforms={},this.refs={shaders:[],textures:[],buffers:[]},this.width=t.width=e,this.height=t.height=r;var n=t.getContext("webgl",i),a=n.createProgram();this.el=t,this.gl=n,this.program=a;var o=this.createShader(H.Vertex,V.a),s=this.createShader(H.Fragment,X.a);if(n.attachShader(a,o),n.attachShader(a,s),n.linkProgram(a),!n.getProgramParameter(a,n.LINK_STATUS)){var h=n.getProgramInfoLog(a);throw n.deleteProgram(a),new Error(h)}n.useProgram(a);var u=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,u),n.bufferData(n.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),n.STATIC_DRAW),n.enableVertexAttribArray(0),n.vertexAttribPointer(0,2,n.FLOAT,!1,0,0),this.refs.buffers.push(u),n.activeTexture(n.TEXTURE0);var f=n.createTexture();n.bindTexture(n.TEXTURE_2D,f),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(var d=n.getProgramParameter(a,n.ACTIVE_UNIFORMS),c=0;c<d;c++){var p=n.getActiveUniform(a,c).name;this.uniforms[p]=n.getUniformLocation(a,p)}n.uniform1i(this.uniforms.u_bitmap,0),this.setFilter(j.Linear),this.setMode(W.PPM),this.refs.textures.push(f),n.enable(n.BLEND),n.blendFunc(n.ONE,n.ONE_MINUS_SRC_ALPHA)}return t.prototype.createShader=function(t,e){var r=this.gl,i=r.createShader(t);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){var n=r.getShaderInfoLog(i);throw r.deleteShader(i),new Error(n)}return this.refs.shaders.push(i),i},t.prototype.setMode=function(t){t===W.PPM?this.textureType=N.Alpha:W.KWZ&&(this.textureType=N.LuminanceAlpha)},t.prototype.toImage=function(t){return this.el.toDataURL(t)},t.prototype.setFilter=function(t){var e=this.gl;e.uniform1i(this.uniforms.u_isSmooth,t===j.Linear?0:1),e.activeTexture(e.TEXTURE0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t)},t.prototype.setColor=function(t,e){this.gl.uniform4f(this.uniforms[t],e[0]/255,e[1]/255,e[2]/255,1)},t.prototype.setPaperColor=function(t){this.gl.clearColor(t[0]/255,t[1]/255,t[2]/255,1)},t.prototype.drawLayer=function(t,e,r,i,n){var a=this.gl;a.activeTexture(a.TEXTURE0),a.texImage2D(a.TEXTURE_2D,0,this.textureType,e,r,0,this.textureType,a.UNSIGNED_BYTE,t),this.setColor("u_color1",i),this.setColor("u_color2",n),a.drawArrays(a.TRIANGLES,0,6)},t.prototype.resize=function(t,e){void 0===t&&(t=640),void 0===e&&(e=480),this.el.width=t,this.el.height=e,this.width=t,this.height=e,this.gl.viewport(0,0,t,e)},t.prototype.clear=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)},t.prototype.destroy=function(){var t=this.refs,e=this.gl;t.shaders.forEach(function(t){e.deleteShader(t)}),t.shaders=[],t.textures.forEach(function(t){e.deleteTexture(t)}),t.textures=[],t.buffers.forEach(function(t){e.deleteBuffer(t)}),t.buffers=[],e.deleteProgram(this.program),e.canvas.width=1,e.canvas.height=1},t}(),Y=function(t,e,r,i){return new(r||(r=Promise))(function(n,a){function o(t){try{h(i.next(t))}catch(t){a(t)}}function s(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){t.done?n(t.value):new r(function(e){e(t.value)}).then(o,s)}h((i=i.apply(t,e||[])).next())})},Z=function(t,e){var r,i,n,a,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,i&&(n=2&a[0]?i.return:a[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,a[1])).done)return n;switch(i=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,i=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(n=(n=o.trys).length>0&&n[n.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){o.label=a[1];break}if(6===a[0]&&o.label<n[1]){o.label=n[1],n=a;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(a);break}n[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],i=0}finally{r=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},q=function(){function t(t,e,r){this.loop=!1,this.paused=!0,this.smoothRendering=!1,this.isOpen=!1,this.frame=0,this.playbackLoop=null,this.hasPlaybackStarted=!1,t="string"==typeof t?document.querySelector(t):t,this.canvas=new z(t,e,r)}return Object.defineProperty(t.prototype,"currentFrame",{get:function(){return this.frame},set:function(t){this.setFrame(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return this.isOpen?this.currentFrame*(1/this.framerate):null},set:function(t){this.isOpen&&t<this.duration&&t>0&&this.setFrame(Math.round(t/(1/this.framerate)))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"duration",{get:function(){return this.isOpen?this.frameCount*(1/this.framerate):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"audiorate",{get:function(){return 1/this.note.bgmrate/(1/this.note.framerate)},enumerable:!0,configurable:!0}),t.prototype.open=function(t){return Y(this,void 0,void 0,function(){var e=this;return Z(this,function(r){return this.isOpen&&this.close(),[2,B(t).then(function(t){e.load(t)}).catch(function(t){console.error("Error loading Flipnote:",t)})]})})},t.prototype.load=function(t){this.note=t,this.meta=t.meta,this.type=t.type,this.loop=t.meta.loop,this.paused=!0,this.isOpen=!0,this.playbackLoop=null,this.hasPlaybackStarted=!1,this.layerVisibility={1:!0,2:!0,3:!0},this.setMode("PPM"===this.type?W.PPM:W.KWZ),this.setFrame(this.note.thumbFrameIndex),this.emit("load")},t.prototype.close=function(){this.pause(),this.note=null,this.isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.frame=0,this.hasPlaybackStarted=null,this.canvas.clear()},t.prototype.destroy=function(){this.close(),this.canvas.destroy()},t.prototype.play=function(){var t=this;if(!this.isOpen||!this.paused)return null;this.paused=!1,this.hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.frame=0),this.playbackLoop=window.setInterval(function(){t.paused&&clearInterval(t.playbackLoop),t.currentFrame>=t.frameCount-1?t.loop?(t.firstFrame(),t.emit("playback:loop")):(t.pause(),t.emit("playback:end")):t.nextFrame()},1e3/this.framerate),this.hasPlaybackStarted=!0,this.emit("playback:start")},t.prototype.pause=function(){if(!this.isOpen||this.paused)return null;window.clearInterval(this.playbackLoop),this.paused=!0,this.emit("playback:stop")},t.prototype.setPalette=function(t){this.note.palette=t,this.forceUpdate()},t.prototype.setFrame=function(t){if(!this.isOpen||t===this.currentFrame)return null;t=Math.max(0,Math.min(Math.floor(t),this.frameCount-1)),this.frame=t,this.drawFrame(t,this.canvas),this.emit("frame:update",this.currentFrame)},t.prototype.drawFrame=function(t,e){var r=this,i=this.note.getFramePalette(t),n=this.note.decodeFrame(t);e.setPaperColor(i[0]),e.clear(),"PPM"===this.note.type?(this.layerVisibility[2]&&e.drawLayer(n[1],256,192,i[2],[0,0,0,0]),this.layerVisibility[1]&&e.drawLayer(n[0],256,192,i[1],[0,0,0,0])):"KWZ"===this.note.type&&this.note.getLayerOrder(t).forEach(function(t){r.layerVisibility[t+1]&&e.drawLayer(n[t],320,240,i[2*t+1],i[2*t+2])})},t.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},t.prototype.nextFrame=function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1},t.prototype.prevFrame=function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1},t.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1},t.prototype.firstFrame=function(){this.currentFrame=0},t.prototype.resize=function(t,e){this.canvas.resize(t,e),this.forceUpdate()},t.prototype.setLayerVisibility=function(t,e){this.layerVisibility[t]=e,this.forceUpdate()},t.prototype.setSmoothRendering=function(t){this.canvas.setFilter(t?j.Linear:j.Nearest),this.forceUpdate(),this.smoothRendering=t},t.prototype.setMode=function(t){this.canvas.setMode(t)},t.prototype.forceUpdate=function(){this.isOpen&&this.drawFrame(this.currentFrame,this.canvas)},t.prototype.on=function(t,e){var r=this.events;(r[t]||(r[t]=[])).push(e)},t.prototype.off=function(t,e){var r=this.events[t];r&&r.splice(r.indexOf(e),1)},t.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];for(var i=this.events[t]||[],n=0;n<i.length;n++)i[n].apply(null,e)},t}();e.default={DataStream:n,KwzParser:D,PpmParser:g,parseSource:B,Player:q}}]).default});
//# sourceMappingURL=flipnote.min.js.map