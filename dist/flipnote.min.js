/*!!
 flipnote.js v4.1.0 (web version)
 Browser-based playback of .ppm and .kwz animations from Flipnote Studio and Flipnote Studio 3D
 2018 - 2020 James Daniel
 github.com/jaames/flipnote.js
 Flipnote Studio is (c) Nintendo Co., Ltd.
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t=t||self).flipnote={})}(this,(function(t){"use strict";var i=[{matches:function(t){return"string"==typeof t},load:function(t,i,n){var s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onreadystatechange=function(t){4===s.readyState&&(s.status>=200&&s.status<300?i(s.response):n({type:"httpError",status:s.status,statusText:s.statusText}))},s.send(null)}},{matches:function(t){return"undefined"!=typeof File&&t instanceof File},load:function(t,i,n){if("undefined"!=typeof FileReader){var s=new FileReader;s.onload=function(t){i(s.result)},s.onerror=function(t){n({type:"fileReadError"})},s.readAsArrayBuffer(t)}else n()}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,i,n){i(t)}}];var n=function(t,i){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])})(t,i)};function s(t,i){function s(){this.constructor=t}n(t,i),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}var h=function(){return(h=Object.assign||function(t){for(var i,n=1,s=arguments.length;n<s;n++)for(var h in i=arguments[n])Object.prototype.hasOwnProperty.call(i,h)&&(t[h]=i[h]);return t}).apply(this,arguments)};function r(t,i,n,s){return new(n||(n=Promise))((function(h,r){function e(t){try{u(s.next(t))}catch(t){r(t)}}function o(t){try{u(s.throw(t))}catch(t){r(t)}}function u(t){var i;t.done?h(t.value):(i=t.value,i instanceof n?i:new n((function(t){t(i)}))).then(e,o)}u((s=s.apply(t,i||[])).next())}))}function e(t,i){var n,s,h,r,e={label:0,sent:function(){if(1&h[0])throw h[1];return h[1]},trys:[],ops:[]};return r={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function o(r){return function(o){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;e;)try{if(n=1,s&&(h=2&r[0]?s.return:r[0]?s.throw||((h=s.return)&&h.call(s),0):s.next)&&!(h=h.call(s,r[1])).done)return h;switch(s=0,h&&(r=[2&r[0],h.value]),r[0]){case 0:case 1:h=r;break;case 4:return e.label++,{value:r[1],done:!1};case 5:e.label++,s=r[1],r=[0];continue;case 7:r=e.ops.pop(),e.trys.pop();continue;default:if(!(h=e.trys,(h=h.length>0&&h[h.length-1])||6!==r[0]&&2!==r[0])){e=0;continue}if(3===r[0]&&(!h||r[1]>h[0]&&r[1]<h[3])){e.label=r[1];break}if(6===r[0]&&e.label<h[1]){e.label=h[1],h=r;break}if(h&&e.label<h[2]){e.label=h[2],e.ops.push(r);break}h[2]&&e.ops.pop(),e.trys.pop();continue}r=i.call(t,e)}catch(t){r=[6,t],s=0}finally{n=h=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,o])}}}var o,u=function(){function t(){this.page=-1,this.pages=[],this.cursor=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(t.pageSize),this.cursor=0},t.prototype.getData=function(){var i=this,n=new Uint8Array(this.page*t.pageSize+this.cursor);return this.pages.map((function(s,h){h===i.page?n.set(s.slice(0,i.cursor),h*t.pageSize):n.set(s,h*t.pageSize)})),n},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(i){this.cursor>=t.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=i},t.prototype.writeBytes=function(t,i,n){for(var s=n||t.length,h=i||0;h<s;h++)this.writeByte(t[h])},t.pageSize=4096,t}(),f=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.cursor=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,i){switch(i){case 2:this.cursor=this.data.byteLength+t;break;case 1:this.cursor+=t;break;case 0:default:this.cursor=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.cursor);return this.cursor+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.cursor,t),this.cursor+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.cursor);return this.cursor+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.cursor,t),this.cursor+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var i=this.data.getUint16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeUint16=function(t,i){void 0===i&&(i=!0),this.data.setUint16(this.cursor,t,i),this.cursor+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var i=this.data.getInt16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeInt16=function(t,i){void 0===i&&(i=!0),this.data.setInt16(this.cursor,t,i),this.cursor+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var i=this.data.getUint32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeUint32=function(t,i){void 0===i&&(i=!0),this.data.setUint32(this.cursor,t,i),this.cursor+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var i=this.data.getInt32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeInt32=function(t,i){void 0===i&&(i=!0),this.data.setInt32(this.cursor,t,i),this.cursor+=4},t.prototype.readBytes=function(t){var i=new Uint8Array(this.data.buffer,this.cursor,t);return this.cursor+=i.byteLength,i},t.prototype.writeBytes=function(t){var i=this;t.forEach((function(t){return i.writeUint8(t)}))},t.prototype.readHex=function(t,i){void 0===i&&(i=!1);for(var n=this.readBytes(t),s=[],h=0;h<n.length;h++)s.push(n[h].toString(16).padStart(2,"0"));return i&&s.reverse(),s.join("").toUpperCase()},t.prototype.readChars=function(t){for(var i=this.readBytes(t),n="",s=0;s<i.length;s++){var h=i[s];if(0===h)break;n+=String.fromCharCode(h)}return n},t.prototype.writeChars=function(t){for(var i=0;i<t.length;i++){var n=t.charCodeAt(i);this.writeUint8(n)}},t.prototype.readWideChars=function(t){for(var i=new Uint16Array(this.data.buffer,this.cursor,t),n="",s=0;s<i.length;s++){var h=i[s];if(0==h)break;n+=String.fromCharCode(h)}return this.cursor+=i.byteLength,n},t}();!function(t){t[t.BGM=0]="BGM",t[t.SE1=1]="SE1",t[t.SE2=2]="SE2",t[t.SE3=3]="SE3",t[t.SE4=4]="SE4"}(o||(o={}));var a=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return s(i,t),i.prototype.hasAudioTrack=function(t){return!!(this.soundMeta.hasOwnProperty(t)&&this.soundMeta[t].length>0)},i}(f);function c(t,i,n){return t<i?i:t>n?n:t}function v(t,i,n){for(var s=t.length/i,h=new Int16Array(s*n),r=(i<<8)/n,e=0;e<h.length;e++)h[e]=t[e*r>>8];return h}function l(t,i,n){void 0===n&&(n=0);for(var s=t.length,h=i.length,r=0;r<s&&!(n+r>h);r++){var e=i[n+r]+t[r]/2;i[n+r]=c(e,-32768,32767)}}for(var w=new Int8Array([-1,2,-1,2]),d=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),y=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),m=new Int16Array(360),b=0;b<4;b++)for(var g=0;g<90;g++){var A=(_=y[g])>>3;1&b&&(A+=_),2&b&&(A=-A),m[b+4*g]=A}var p=new Int16Array(1440);for(b=0;b<16;b++)for(g=0;g<90;g++){var _;A=(_=y[g])>>3;4&b&&(A+=_),2&b&&(A+=_>>1),1&b&&(A+=_>>2),8&b&&(A=-A),p[b+16*g]=A}for(var U=[.5,.5,1,2,4,6,12,20,30],x={WHITE:[255,255,255],BLACK:[14,14,14],RED:[255,42,42],BLUE:[10,57,255]},E=function(t){function i(n){var s=t.call(this,n)||this;return s.type=i.type,s.width=i.width,s.height=i.height,s.globalPalette=i.globalPalette,s.sampleRate=i.sampleRate,s.prevDecodedFrame=null,s.decodeHeader(),s.decodeAnimationHeader(),s.decodeSoundHeader(),0!=(s.version>>4&15)&&s.decodeMeta(),s.layers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],s.prevLayers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],s.prevDecodedFrame=null,s}return s(i,t),i.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},i.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},i.prototype.decodeHeader=function(){this.seek(0);this.readUint32();this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},i.prototype.readFilename=function(){return[this.readHex(3),this.readChars(13),this.readUint16().toString().padStart(3,"0")].join("_")},i.prototype.decodeMeta=function(){this.seek(16);var t=this.readUint16(),i=this.readInt16(),n=this.readWideChars(11),s=this.readWideChars(11),h=this.readWideChars(11),r=this.readHex(8,!0),e=this.readHex(8,!0),o=this.readFilename(),u=this.readFilename(),f=this.readHex(8,!0);this.seek(154);var a=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=i,this.meta={lock:1===t,loop:1==(c>>1&1),frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:i,timestamp:a,spinoff:e!==r||e!==f,root:{filename:null,username:n,fsid:f},parent:{username:s,fsid:r,filename:o},current:{username:h,fsid:e,filename:u}}},i.prototype.decodeAnimationHeader=function(){this.seek(1696);var t=this.readUint16(),i=t/4;this.seek(1704);for(var n=new Uint32Array(i),s=0;s<i;s++)n[s]=1704+t+this.readUint32();this.frameOffsets=n},i.prototype.decodeSoundHeader=function(){var t,i=1696+this.frameDataLength+this.frameCount;i%4!=0&&(i+=4-i%4),this.seek(i);var n=this.readUint32(),s=this.readUint32(),h=this.readUint32(),r=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),i+=32,this.framerate=U[this.frameSpeed],this.bgmrate=U[this.bgmSpeed],this.soundMeta=((t={})[o.BGM]={offset:i,length:n},t[o.SE1]={offset:i+=n,length:s},t[o.SE2]={offset:i+=s,length:h},t[o.SE3]={offset:i+=h,length:r},t)},i.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},i.prototype.getLayerOrder=function(t){return[0,1]},i.prototype.readLineEncoding=function(){for(var t=new Uint8Array(i.height),n=0,s=0;s<48;s++)for(var h=this.readUint8(),r=0;r<8;r+=2)t[n++]=h>>r&3;return t},i.prototype.decodeFrame=function(t){this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.seek(this.frameOffsets[t]);var n=this.readUint8(),s=n>>7&1,h=n>>5&3,r=0,e=0;this.prevLayers[0].set(this.layers[0]),this.prevLayers[1].set(this.layers[1]),this.prevDecodedFrame=t,this.layers[0].fill(0),this.layers[1].fill(0),h&&(r=this.readInt8(),e=this.readInt8());for(var o=[this.readLineEncoding(),this.readLineEncoding()],u=0;u<2;u++)for(var f=this.layers[u],a=0;a<i.height;a++){var c=o[u][a],v=a*i.width;switch(c){case 0:break;case 1:case 2:var l=this.readUint32(!1);for(2==c&&f.fill(255,v,v+i.width);4294967295&l;){if(2147483648&l)for(var w=this.readUint8(),d=0;d<8;d++)f[v+d]=w>>d&1?255:0;v+=8,l<<=1}break;case 3:for(;v<(a+1)*i.width;){for(w=this.readUint8(),d=0;d<8;d++)f[v+d]=w>>d&1?255:0;v+=8}}}var y=this.layers[0],m=this.layers[1],b=this.prevLayers[0],g=this.prevLayers[1];if(!s)for(var A=void 0,p=void 0,_=0;_<i.height;_++)if(!(_-e<0)){if(_-e>=i.height)break;for(var U=0;U<i.width;U++)if(!(U-r<0)){if(U-r>=i.width)break;p=(A=U+_*i.width)-(r+e*i.width),y[A]^=b[p],m[A]^=g[p]}}return this.layers},i.prototype.getFramePaletteIndices=function(t){this.seek(this.frameOffsets[t]);var i=this.readUint8(),n=1!=(1&i),s=[n?0:1,n?0:1,2,3];return[n?1:0,s[i>>1&3],s[i>>3&3]]},i.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,n){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var s=this.getFramePaletteIndices(t),h=this.layers[n],r=new Uint8Array(i.width*i.height),e=s[n+1],o=0;o<r.length;o++)0!==h[o]&&(r[o]=e);return r},i.prototype.getFramePixels=function(t){var n=this.getFramePaletteIndices(t),s=this.decodeFrame(t),h=new Uint8Array(i.width*i.height),r=s[0],e=s[1],o=n[0],u=n[1],f=n[2];h.fill(o);for(var a=0;a<h.length;a++){var c=r[a],v=e[a];0!==c?h[a]=u:0!==v&&(h[a]=f)}return h},i.prototype.decodeSoundFlags=function(){this.seek(1696+this.frameDataLength);for(var t=this.frameCount,i=this.readBytes(t),n=new Array(t),s=0;s<t;s++){var h=i[s];n[s]=[0!=(1&h),0!=(2&h),0!=(4&h)]}return n},i.prototype.getAudioTrackRaw=function(t){var i=this.soundMeta[t];return new Uint8Array(this.buffer,i.offset,i.length)},i.prototype.decodeAudioTrack=function(t){for(var i=this.getAudioTrackRaw(t),n=i.length,s=new Int16Array(2*n),h=0,r=0,e=0,o=0,u=0,f=!0;h<n;){e=f?15&i[h]:i[h++]>>4,f=!f;var a=y[o],v=a>>3;1&e&&(v+=a>>2),2&e&&(v+=a>>1),4&e&&(v+=a),8&e&&(v=-v),u=c(u+=v,-32768,32767),o=c(o+=d[e],0,88),s[r++]=u}return s},i.prototype.getAudioTrackPcm=function(t,i){void 0===i&&(i=32768);var n=this.decodeAudioTrack(t),s=this.sampleRate;if(t===o.BGM){var h=1/this.bgmrate/(1/this.framerate);s=this.sampleRate*h}return s!==i?v(n,s,i):n},i.prototype.getAudioMasterPcm=function(t){void 0===t&&(t=32768);var i=this.frameCount*(1/this.framerate),n=Math.floor(i*t),s=new Int16Array(n),h=this.hasAudioTrack(o.BGM),r=this.hasAudioTrack(o.SE1),e=this.hasAudioTrack(o.SE2),u=this.hasAudioTrack(o.SE3);h&&l(this.getAudioTrackPcm(o.BGM,t),s,0);if(r||e||u)for(var f=Math.floor(t/this.framerate),a=this.decodeSoundFlags(),c=r?this.getAudioTrackPcm(o.SE1,t):null,v=e?this.getAudioTrackPcm(o.SE2,t):null,w=u?this.getAudioTrackPcm(o.SE3,t):null,d=0;d<this.frameCount;d++){var y=f*d,m=a[d];r&&m[0]&&l(c,s,y),e&&m[1]&&l(v,s,y),u&&m[2]&&l(w,s,y)}return s},i.type="PPM",i.width=256,i.height=192,i.sampleRate=8192,i.outputSampleRate=32768,i.globalPalette=[x.WHITE,x.BLACK,x.RED,x.BLUE],i}(a),S=new Uint16Array(52488),k=[0,65280,255],F=0,I=0;I<3;I++)for(var O=0;O<3;O++)for(var j=0;j<3;j++)for(var M=0;M<3;M++)for(var L=0;L<3;L++)for(var B=0;B<3;B++)for(var P=0;P<3;P++)for(var W=0;W<3;W++)S.set([k[O],k[I],k[M],k[j],k[B],k[L],k[W],k[P]],F),F+=8;var R=new Uint16Array(52488);for(F=0,I=0;I<2187;I+=729)for(O=0;O<729;O+=243)for(j=0;j<243;j+=81)for(M=0;M<81;M+=27)for(L=0;L<27;L+=9)for(B=0;B<9;B+=3)for(P=0;P<3;P+=1)for(W=0;W<6561;W+=2187){var z=I+O+j+M+L+B+P+W,D=S.subarray(8*z,8*z+8);R.set(D,F),F+=8}var G=new Uint16Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,i){var n=S.subarray(8*t,8*t+8);G.set(n,8*i)}));var T=new Uint16Array(256);[0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100].forEach((function(t,i){var n=S.subarray(8*t,8*t+8);T.set(n,8*i)}));var C=[.2,.5,1,2,4,6,8,12,20,24,30],N={WHITE:[255,255,255],BLACK:[16,16,16],RED:[255,16,16],YELLOW:[255,231,0],GREEN:[0,134,49],BLUE:[0,56,206],NONE:[255,255,255]},K=function(t){function i(n){var s=t.call(this,n)||this;return s.type=i.type,s.width=i.width,s.height=i.height,s.globalPalette=i.globalPalette,s.sampleRate=i.sampleRate,s.prevDecodedFrame=null,s.bitIndex=0,s.bitValue=0,s.layers=[new Uint16Array(i.width*i.height),new Uint16Array(i.width*i.height),new Uint16Array(i.width*i.height)],s.bitIndex=0,s.bitValue=0,s.load(),s}return s(i,t),i.prototype.load=function(){this.seek(0),this.sections={},this.frameMeta=[];for(var t=this.byteLength-256,i=0,n=0;i<t&&n<6;){this.seek(i);var s=this.readChars(4).substring(0,3),h=this.readUint32();this.sections[s]={offset:i,length:h},i+=h+8,n+=1}this.decodeMeta(),this.decodeFrameMeta(),this.decodeSoundHeader()},i.prototype.readBits=function(t){if(this.bitIndex+t>16){var i=this.readUint16();this.bitValue|=i<<16-this.bitIndex,this.bitIndex-=16}var n=(1<<t)-1,s=this.bitValue&n;return this.bitValue>>=t,this.bitIndex+=t,s},i.prototype.decodeMeta=function(){this.seek(this.sections.KFH.offset+12);var t=new Date(1e3*(this.readUint32()+946684800)),i=new Date(1e3*(this.readUint32()+946684800)),n=(this.readUint32(),this.readHex(10)),s=this.readHex(10),h=this.readHex(10),r=this.readWideChars(11),e=this.readWideChars(11),o=this.readWideChars(11),u=this.readChars(28),f=this.readChars(28),a=this.readChars(28),c=this.readUint16(),v=this.readUint16(),l=this.readUint16(),w=this.readUint8();this.readUint8();this.frameCount=c,this.thumbFrameIndex=v,this.frameSpeed=w,this.framerate=C[w],this.meta={lock:1==(1&l),loop:1==(l>>1&1),frame_count:c,frame_speed:w,thumb_index:v,timestamp:i,creation_timestamp:t,root:{username:r,fsid:n,filename:u},parent:{username:e,fsid:s,filename:f},current:{username:o,fsid:h,filename:a}}},i.prototype.decodeFrameMeta=function(){this.frameOffsets=new Uint32Array(this.frameCount),this.seek(this.sections.KMI.offset+8);for(var t=this.sections.KMC.offset+12,i=0;i<this.frameCount;i++){var n={flags:this.readUint32(),layerSize:[this.readUint16(),this.readUint16(),this.readUint16()],frameAuthor:this.readHex(10),layerDepth:[this.readUint8(),this.readUint8(),this.readUint8()],soundFlags:this.readUint8(),cameraFlag:this.readUint32()};this.frameMeta.push(n),this.frameOffsets[i]=t,t+=n.layerSize[0]+n.layerSize[1]+n.layerSize[2]}},i.prototype.decodeSoundHeader=function(){var t;if(this.sections.hasOwnProperty("KSN")){var i=this.sections.KSN.offset+8;this.seek(i);var n=this.readUint32();this.bgmSpeed=n,this.bgmrate=C[n];var s=new Uint32Array(this.buffer,i+4,20);this.soundMeta=((t={})[o.BGM]={offset:i+=28,length:s[0]},t[o.SE1]={offset:i+=s[0],length:s[1]},t[o.SE2]={offset:i+=s[1],length:s[2]},t[o.SE3]={offset:i+=s[2],length:s[3]},t[o.SE4]={offset:i+=s[3],length:s[4]},t)}},i.prototype.getDiffingFlag=function(t){return 7&~(this.frameMeta[t].flags>>4)},i.prototype.getLayerDepths=function(t){return this.frameMeta[t].layerDepth},i.prototype.getLayerOrder=function(t){var i=this.getLayerDepths(t);return[2,1,0].sort((function(t,n){return i[n]-i[t]}))},i.prototype.decodeFrame=function(t,n,s){void 0===n&&(n=7),void 0===s&&(s=!1),s&&(n&=this.getDiffingFlag(t+1)),this.prevDecodedFrame!==t-1&&n&&0!==t&&this.decodeFrame(t-1,n=n,s=!0);for(var h=this.frameMeta[t],r=this.frameOffsets[t],e=0;e<3;e++){this.seek(r);var o=h.layerSize[e];if(r+=o,38!==o&&0!=(n>>e&1)){this.bitIndex=16,this.bitValue=0;for(var u=0,f=0;f<i.height;f+=128)for(var a=0;a<i.width;a+=128)for(var c=0;c<128;c+=8){var v=f+c;if(v>=i.height)break;for(var l=0;l<128;l+=8){var w=a+l;if(w>=i.width)break;if(u)u-=1;else{var d=v*i.width+w,y=this.layers[e],m=this.readBits(3);if(0==m){var b=this.readBits(5),g=G.subarray(8*b,8*b+8);y.set(g,d),y.set(g,d+320),y.set(g,d+640),y.set(g,d+960),y.set(g,d+1280),y.set(g,d+1600),y.set(g,d+1920),y.set(g,d+2240)}else if(1==m){b=this.readBits(13),g=S.subarray(8*b,8*b+8);y.set(g,d),y.set(g,d+320),y.set(g,d+640),y.set(g,d+960),y.set(g,d+1280),y.set(g,d+1600),y.set(g,d+1920),y.set(g,d+2240)}else if(2==m){var A=this.readBits(5),p=G.subarray(8*A,8*A+8),_=T.subarray(8*A,8*A+8);y.set(p,d),y.set(_,d+320),y.set(p,d+640),y.set(_,d+960),y.set(p,d+1280),y.set(_,d+1600),y.set(p,d+1920),y.set(_,d+2240)}else if(3==m){A=this.readBits(13),p=S.subarray(8*A,8*A+8),_=R.subarray(8*A,8*A+8);y.set(p,d),y.set(_,d+320),y.set(p,d+640),y.set(_,d+960),y.set(p,d+1280),y.set(_,d+1600),y.set(p,d+1920),y.set(_,d+2240)}else if(4==m)for(var U=this.readBits(8),x=0;x<8;x++)if(U&1<<x){b=this.readBits(5),g=G.subarray(8*b,8*b+8);y.set(g,d+320*x)}else{b=this.readBits(13),g=S.subarray(8*b,8*b+8);y.set(g,d+320*x)}else{if(5==m){u=this.readBits(5);continue}if(7==m){var E=this.readBits(2);p=void 0,_=void 0;if(this.readBits(1)){var k=this.readBits(5),F=this.readBits(5);p=G.subarray(8*k,8*k+8),_=G.subarray(8*F,8*F+8),E=(E+1)%4}else{k=this.readBits(13),F=this.readBits(13);p=S.subarray(8*k,8*k+8),_=S.subarray(8*F,8*F+8)}0==E?(y.set(p,d),y.set(_,d+320),y.set(p,d+640),y.set(_,d+960),y.set(p,d+1280),y.set(_,d+1600),y.set(p,d+1920),y.set(_,d+2240)):1==E?(y.set(p,d),y.set(p,d+320),y.set(_,d+640),y.set(p,d+960),y.set(p,d+1280),y.set(_,d+1600),y.set(p,d+1920),y.set(p,d+2240)):2==E?(y.set(p,d),y.set(_,d+320),y.set(p,d+640),y.set(p,d+960),y.set(_,d+1280),y.set(p,d+1600),y.set(p,d+1920),y.set(_,d+2240)):3==E&&(y.set(p,d),y.set(_,d+320),y.set(_,d+640),y.set(p,d+960),y.set(_,d+1280),y.set(_,d+1600),y.set(p,d+1920),y.set(_,d+2240))}}}}}}}return this.prevDecodedFrame=t,[new Uint8Array(this.layers[0].buffer),new Uint8Array(this.layers[1].buffer),new Uint8Array(this.layers[2].buffer)]},i.prototype.getFramePaletteIndices=function(t){var i=this.frameMeta[t].flags;return[15&i,i>>8&15,i>>12&15,i>>16&15,i>>20&15,i>>24&15,i>>28&15]},i.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,n){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var s=this.getFramePaletteIndices(t),h=this.layers[n],r=new Uint8Array(i.width*i.height),e=2*n+1,o=0;o<h.length;o++){var u=h[o];65280&u?r[o]=s[e]:255&u&&(r[o]=s[e+1])}return r},i.prototype.getFramePixels=function(t){var n=this,s=this.getFramePaletteIndices(t),h=new Uint8Array(i.width*i.height);return h.fill(s[0]),this.getLayerOrder(t).forEach((function(i){for(var s=n.getLayerPixels(t,i),r=0;r<s.length;r++){var e=s[r];0!==e&&(h[r]=e)}})),h},i.prototype.decodeSoundFlags=function(){return this.frameMeta.map((function(t){var i=t.soundFlags;return[0!=(1&i),0!=(2&i),0!=(4&i),0!=(8&i)]}))},i.prototype.getAudioTrackRaw=function(t){var i=this.soundMeta[t];return new Uint8Array(this.buffer,i.offset,i.length)},i.prototype.decodeAudioTrack=function(t){for(var i,n,s,h=this.getAudioTrackRaw(t),r=new Int16Array(981840),e=0,o=0,u=40,f=0;f<h.length;f++)for(var a=h[f],v=0;v<8;)u<18||6==v?(n=o+m[(i=a>>v&3)+4*u],s=u+w[i],v+=2):(n=o+p[(i=a>>v&15)+16*u],s=u+d[i],v+=4),s=c(s,0,79),n=c(n,-2047,2047),r[e]=16*n,e+=1,u=s,o=n;return r.slice(0,e)},i.prototype.getAudioTrackPcm=function(t,i){void 0===i&&(i=32768);var n=this.decodeAudioTrack(t),s=this.sampleRate;if(t===o.BGM){var h=1/this.bgmrate/(1/this.framerate);s=this.sampleRate*h}return s!==i?v(n,s,i):n},i.prototype.getAudioMasterPcm=function(t){void 0===t&&(t=32768);var i=this.frameCount*(1/this.framerate),n=Math.floor(i*t),s=new Int16Array(n),h=this.hasAudioTrack(o.BGM),r=this.hasAudioTrack(o.SE1),e=this.hasAudioTrack(o.SE2),u=this.hasAudioTrack(o.SE3),f=this.hasAudioTrack(o.SE4);h&&l(this.getAudioTrackPcm(o.BGM,t),s,0);if(r||e||u)for(var a=Math.floor(t/this.framerate),c=this.decodeSoundFlags(),v=r?this.getAudioTrackPcm(o.SE1,t):null,w=e?this.getAudioTrackPcm(o.SE2,t):null,d=u?this.getAudioTrackPcm(o.SE3,t):null,y=f?this.getAudioTrackPcm(o.SE4,t):null,m=0;m<this.frameCount;m++){var b=a*m,g=c[m];r&&g[0]&&l(v,s,b),e&&g[1]&&l(w,s,b),u&&g[2]&&l(d,s,b),f&&g[3]&&l(y,s,b)}return s},i.type="KWZ",i.width=320,i.height=240,i.sampleRate=16364,i.globalPalette=[N.WHITE,N.BLACK,N.RED,N.YELLOW,N.GREEN,N.BLUE,N.NONE],i}(a);function q(t){return function(t){return new Promise((function(n,s){i.forEach((function(i){i.matches(t)&&i.load(t,n,s)}))}))}(t).then((function(t){return new Promise((function(i,n){var s=new Uint8Array(t.slice(0,4)),h=s[0]<<24|s[1]<<16|s[2]<<8|s[3];1346458177===h?i(new E(t)):1262897152==(4294967040&h)?i(new K(t)):n()}))}))}var H,V=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],Y=function(){function t(t,i,n,s){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=i,this.pixels=n,this.colorDepth=s,this.initCodeSize=Math.max(2,this.colorDepth),this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.a_count,this.remaining,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}return t.prototype.char_out=function(t,i){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(i)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var i=0;i<t;++i)this.htab[i]=-1},t.prototype.compress=function(t,i){var n,s,h,r,e,o;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,r=this.nextPixel(),o=0,n=5003;n<65536;n*=2)++o;o=8-o,this.cl_hash(5003),this.output(this.ClearCode,i);t:for(;-1!=(s=this.nextPixel());)if(n=(s<<12)+r,h=s<<o^r,this.htab[h]!==n){if(this.htab[h]>=0){e=5003-h,0===h&&(e=1);do{if((h-=e)<0&&(h+=5003),this.htab[h]===n){r=this.codetab[h];continue t}}while(this.htab[h]>=0)}this.output(r,i),r=s,this.free_ent<4096?(this.codetab[h]=this.free_ent++,this.htab[h]=n):this.cl_block(i)}else r=this.codetab[h];this.output(r,i),this.output(this.EOFCode,i)},t.prototype.encode=function(t){t.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,t),t.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,i){for(this.cur_accum&=V[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(i)}},t}(),Z=function(){function t(t,i){this.delay=100,this.repeat=-1,this.colorDepth=8,this.palette=[],this.width=t,this.height=i,this.data=new u}return t.fromFlipnote=function(i){var n=new t(i.width,i.height);n.palette=i.globalPalette,n.delay=100/i.framerate,n.repeat=i.meta.loop?-1:0,n.init();for(var s=0;s<i.frameCount;s++)n.writeFrame(i.getFramePixels(s));return n},t.fromFlipnoteFrame=function(i,n){var s=new t(i.width,i.height);return s.palette=i.globalPalette,s.delay=100/i.framerate,s.repeat=i.meta.loop?-1:0,s.init(),s.writeFrame(i.getFramePixels(n)),s},t.prototype.init=function(){for(var t=this.palette.length,i=1;1<<i<t;i+=1)continue;this.colorDepth=i,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt()},t.prototype.writeHeader=function(){var t=new f(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.colorDepth-1),t.writeUint8(0),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.colorDepth)),i=0,n=0;i<this.palette.length;i+=1,n+=3)t.set(this.palette[i],n);this.data.writeBytes(t)},t.prototype.writeGraphicsControlExt=function(){var t=new f(new ArrayBuffer(8));t.writeBytes([33,249,4,0]),t.writeUint16(this.delay),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeNetscapeExt=function(){var t=new f(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeImageDesc=function(){var t=new f(new ArrayBuffer(10));t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writePixels=function(t){new Y(this.width,this.height,t,this.colorDepth).encode(this.data)},t.prototype.writeFrame=function(t){this.writeGraphicsControlExt(),this.writeImageDesc(),this.writePixels(t)},t.prototype.getBuffer=function(){return this.data.getBuffer()},t.prototype.getBlob=function(){return new Blob([this.getBuffer()],{type:"image/gif"})},t.prototype.getUrl=function(){return window.URL.createObjectURL(this.getBlob())},t.prototype.getImage=function(){var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},t}(),X=function(){function t(t,i,n){void 0===i&&(i=1),void 0===n&&(n=16),this.sampleRate=t,this.channels=i,this.bitsPerSample=n;var s=new ArrayBuffer(44),h=new f(s);h.writeChars("RIFF"),h.writeUint32(0),h.writeChars("WAVE"),h.writeChars("fmt "),h.writeUint32(16),h.writeUint16(1),h.writeUint16(this.channels),h.writeUint32(this.sampleRate),h.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),h.writeUint16(this.bitsPerSample*this.channels/8),h.writeUint16(this.bitsPerSample),h.writeChars("data"),h.writeUint32(0),this.header=h,this.pcmData=null}return t.fromFlipnote=function(i){var n=new t(44100,1,16),s=i.getAudioMasterPcm(44100);return n.writeFrames(s),n},t.fromFlipnoteTrack=function(i,n){var s=new t(44100,1,16),h=i.getAudioTrackPcm(n,44100);return s.writeFrames(h),s},t.prototype.writeFrames=function(t){var i=this.header;i.seek(4),i.writeUint32(i.byteLength+t.byteLength),i.seek(40),i.writeUint32(t.byteLength),this.pcmData=t},t.prototype.getBlob=function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})},t}();!function(t){t[t.Alpha=WebGLRenderingContext.ALPHA]="Alpha",t[t.LuminanceAlpha=WebGLRenderingContext.LUMINANCE_ALPHA]="LuminanceAlpha"}(H||(H={}));var J,Q=function(){function t(t,i,n,s){void 0===i&&(i=640),void 0===n&&(n=480),void 0===s&&(s={antialias:!1,alpha:!1}),this.uniforms={},this.refs={shaders:[],textures:[],buffers:[]};var h=t.getContext("webgl",s);this.el=t,this.gl=h,this.createProgram(),this.setCanvasSize(i,n),this.createScreenQuad(),this.createBitmapTexture(),h.enable(h.BLEND),h.blendEquation(h.FUNC_ADD),h.blendFunc(h.ONE,h.ONE_MINUS_SRC_ALPHA)}return t.prototype.createProgram=function(){var t=this.gl,i=t.createProgram();if(t.attachShader(i,this.createShader(t.VERTEX_SHADER,"#define GLSLIFY 1\nattribute vec4 a_position;varying vec2 v_texel;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){gl_Position=a_position;vec2 uv=a_position.xy*vec2(0.5,-0.5)+0.5;v_texel=uv*u_textureSize;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);}")),t.attachShader(i,this.createShader(t.FRAGMENT_SHADER,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_texel;varying float v_scale;uniform vec4 u_color1;uniform vec4 u_color2;uniform sampler2D u_bitmap;uniform bool u_isSmooth;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;vec2 colorWeights=texture2D(u_bitmap,coord).ra;gl_FragColor=vec4(u_color1.rgb,1.0)*colorWeights.y+vec4(u_color2.rgb,1.0)*colorWeights.x;}")),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){var n=t.getProgramInfoLog(i);throw t.deleteProgram(i),new Error(n)}t.useProgram(i);for(var s=t.getProgramParameter(i,t.ACTIVE_UNIFORMS),h=0;h<s;h++){var r=t.getActiveUniform(i,h).name;this.uniforms[r]=t.getUniformLocation(i,r)}this.program=i},t.prototype.createScreenQuad=function(){var t=this.gl,i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0),this.refs.buffers.push(i)},t.prototype.createBitmapTexture=function(){var t=this.gl;t.activeTexture(t.TEXTURE0);var i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.uniform1i(this.uniforms.u_bitmap,0),this.refs.textures.push(i)},t.prototype.createShader=function(t,i){var n=this.gl,s=n.createShader(t);if(n.shaderSource(s,i),n.compileShader(s),!n.getShaderParameter(s,n.COMPILE_STATUS)){var h=n.getShaderInfoLog(s);throw n.deleteShader(s),new Error(h)}return this.refs.shaders.push(s),s},t.prototype.setInputSize=function(t,i){this.gl.uniform2f(this.uniforms.u_textureSize,t,i)},t.prototype.setCanvasSize=function(t,i){var n=window.devicePixelRatio||1,s=t*n,h=i*n;this.el.width=s,this.el.height=h,this.width=s,this.height=h,this.gl.viewport(0,0,s,h),this.gl.uniform2f(this.uniforms.u_screenSize,s,h),this.el.style.width=t+"px",this.el.style.height=i+"px"},t.prototype.setLayerType=function(t){this.textureType=t},t.prototype.toImage=function(t){return this.el.toDataURL(t)},t.prototype.setColor=function(t,i){this.gl.uniform4f(this.uniforms[t],i[0]/255,i[1]/255,i[2]/255,1)},t.prototype.setPaperColor=function(t){this.gl.clearColor(t[0]/255,t[1]/255,t[2]/255,1)},t.prototype.drawLayer=function(t,i,n,s,h){var r=this.gl;r.texImage2D(r.TEXTURE_2D,0,this.textureType,i,n,0,this.textureType,r.UNSIGNED_BYTE,t),this.setColor("u_color1",s),this.setColor("u_color2",h),r.drawArrays(r.TRIANGLES,0,6)},t.prototype.resize=function(t,i){void 0===t&&(t=640),void 0===i&&(i=480),this.setCanvasSize(t,i)},t.prototype.clear=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)},t.prototype.destroy=function(){var t=this.refs,i=this.gl;t.shaders.forEach((function(t){i.deleteShader(t)})),t.shaders=[],t.textures.forEach((function(t){i.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){i.deleteBuffer(t)})),t.buffers=[],i.deleteProgram(this.program),i.canvas.width=1,i.canvas.height=1},t}(),$=window.AudioContext||window.webkitAudioContext,tt=function(){function t(){this.useEq=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this.t=1,this.ctx=new $}return Object.defineProperty(t.prototype,"volume",{get:function(){return this.t},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),t.prototype.setSamples=function(t,i){var n=t.length,s=this.ctx.createBuffer(1,n,i),h=s.getChannelData(0);if(t instanceof Float32Array)h.set(t,0);else if(t instanceof Int16Array)for(var r=0;r<n;r++)h[r]=t[r]/32767;this.buffer=s,this.sampleRate=i},t.prototype.connectEqNodesTo=function(t){var i=this.ctx,n=this.eqSettings,s=t;return n.forEach((function(t,h){var r=t[0],e=t[1],o=i.createBiquadFilter();0===h?o.type="lowshelf":h===n.length-1?o.type="highshelf":o.type="peaking",o.frequency.value=r,o.gain.value=e,s.connect(o),s=o})),s},t.prototype.initNodes=function(){var t=this.ctx,i=t.createBufferSource();i.buffer=this.buffer;var n=t.createGain();this.useEq?this.connectEqNodesTo(i).connect(n):i.connect(n);i.connect(n),n.connect(t.destination),this.source=i,this.gainNode=n,this.setVolume(this.t)},t.prototype.setVolume=function(t){this.t=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))},t.prototype.stop=function(){this.source.stop(0)},t.prototype.playFrom=function(t){this.initNodes(),this.source.start(0,t)},t}(),it=function(){var t=document.createElement("a");return function(i,n){var s=window.URL.createObjectURL(i);t.href=s,t.download=n,t.click(),window.URL.revokeObjectURL(s)}}(),nt=function(){function t(i,n,s){this.loop=!1,this.paused=!0,this.duration=0,this.isOpen=!1,this.events={},this.i=-1,this.s=-1,this.h=-1,this.hasPlaybackStarted=!1,this.wasPlaying=!1,this.isSeeking=!1,i="string"==typeof i?document.querySelector(i):i,this.canvas=new Q(i,n,s),this.audio=new tt,this.el=this.canvas.el,this.customPalette=null,this.state=h({},t.defaultState)}return t.prototype.saveWav=function(){var t=X.fromFlipnote(this.note);it(t.getBlob(),"audio.wav")},Object.defineProperty(t.prototype,"currentFrame",{get:function(){return this.s},set:function(t){this.setFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return this.isOpen?this.h:null},set:function(t){this.isOpen&&t<=this.duration&&t>=0&&(this.setFrame(Math.round(t/(1/this.framerate))),this.h=t,this.emit("progress",this.progress))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"progress",{get:function(){return this.isOpen?this.h/this.duration*100:0},set:function(t){this.currentTime=this.duration*(t/100)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this.audio.volume},set:function(t){this.audio.volume=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"muted",{get:function(){return!1},set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),t.prototype.setState=function(t){t=h(h({},this.state),t);this.state;this.emit("state:change")},t.prototype.open=function(t){return r(this,void 0,void 0,(function(){var i=this;return e(this,(function(n){return this.isOpen&&this.close(),[2,q(t).then((function(t){return i.load(t)})).catch((function(t){throw i.emit("error",t),console.error("Error loading Flipnote:",t),"Error loading Flipnote"}))]}))}))},t.prototype.close=function(){this.pause(),this.note=null,this.isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.s=null,this.h=null,this.duration=null,this.loop=null,this.hasPlaybackStarted=null,this.canvas.clear()},t.prototype.load=function(t){this.note=t,this.meta=t.meta,this.type=t.type,this.loop=t.meta.loop,this.duration=this.note.frameCount*(1/this.note.framerate),this.paused=!0,this.isOpen=!0,this.hasPlaybackStarted=!1,this.layerVisibility={1:!0,2:!0,3:!0};var i=this.audio.ctx.sampleRate,n=t.getAudioMasterPcm(i);this.audio.setSamples(n,i),this.canvas.setInputSize(t.width,t.height),this.canvas.setLayerType("PPM"===this.type?H.Alpha:H.LuminanceAlpha),this.setFrame(this.note.thumbFrameIndex),this.h=0,this.emit("load")},t.prototype.playAudio=function(){this.audio.playFrom(this.currentTime)},t.prototype.stopAudio=function(){this.audio.stop()},t.prototype.toggleEq=function(){this.stopAudio(),this.audio.useEq=!this.audio.useEq,this.playAudio()},t.prototype.playbackLoop=function(t){if(this.paused)return this.stopAudio(),null;var i=t/1e3,n=i-this.i;n>this.duration?this.loop?(this.currentTime=0,this.playAudio(),this.i=i,this.emit("playback:loop")):(this.pause(),this.emit("playback:end")):this.currentTime=n,requestAnimationFrame(this.playbackLoop.bind(this))},t.prototype.play=function(){if(window.__activeFlipnotePlayer=this,!this.isOpen||!this.paused)return null;this.hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.h=0),this.paused=!1,this.hasPlaybackStarted=!0,this.i=performance.now()/1e3-this.currentTime,this.playAudio(),requestAnimationFrame(this.playbackLoop.bind(this)),this.emit("playback:start")},t.prototype.pause=function(){if(!this.isOpen||this.paused)return null;this.paused=!0,this.stopAudio(),this.emit("playback:stop")},t.prototype.togglePlay=function(){this.paused?this.play():this.pause()},t.prototype.setFrame=function(t){this.isOpen&&t!==this.currentFrame&&(t=Math.max(0,Math.min(Math.floor(t),this.frameCount-1)),this.drawFrame(t),this.s=t,this.paused&&(this.h=t*(1/this.framerate),this.emit("progress",this.progress)),this.emit("frame:update",this.currentFrame))},t.prototype.nextFrame=function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1},t.prototype.prevFrame=function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1},t.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1},t.prototype.firstFrame=function(){this.currentFrame=0},t.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},t.prototype.startSeek=function(){this.isSeeking||(this.wasPlaying=!this.paused,this.pause(),this.isSeeking=!0)},t.prototype.seek=function(t){this.isSeeking&&(this.progress=t)},t.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},t.prototype.drawFrame=function(t){var i=this,n=this.note.width,s=this.note.height,h=this.note.getFramePalette(t),r=this.note.decodeFrame(t);this.canvas.setPaperColor(h[0]),this.canvas.clear(),"PPM"===this.note.type?(this.layerVisibility[2]&&this.canvas.drawLayer(r[1],n,s,h[2],[0,0,0,0]),this.layerVisibility[1]&&this.canvas.drawLayer(r[0],n,s,h[1],[0,0,0,0])):"KWZ"===this.note.type&&this.note.getLayerOrder(t).forEach((function(t){i.layerVisibility[t+1]&&i.canvas.drawLayer(r[t],n,s,h[2*t+1],h[2*t+2])}))},t.prototype.forceUpdate=function(){this.isOpen&&this.drawFrame(this.currentFrame)},t.prototype.resize=function(t,i){this.canvas.resize(t,i),this.forceUpdate()},t.prototype.setLayerVisibility=function(t,i){this.layerVisibility[t]=i,this.forceUpdate()},t.prototype.toggleLayerVisibility=function(t){this.setLayerVisibility(t,!this.layerVisibility[t])},t.prototype.on=function(t,i){var n=this.events;(n[t]||(n[t]=[])).push(i)},t.prototype.off=function(t,i){var n=this.events[t];n&&n.splice(n.indexOf(i),1)},t.prototype.emit=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];for(var s=this.events[t]||[],h=0;h<s.length;h++)s[h].apply(null,i)},t.prototype.clearEvents=function(){this.events={}},t.prototype.destroy=function(){this.close(),this.canvas.destroy()},t.defaultState={noteType:null,isNoteOpen:!1,paused:!1,hasPlaybackStarted:!1,frame:-1,time:-1,loop:!1,volume:1,muted:!1,layerVisibility:{1:!0,2:!0,3:!0},isSeeking:!1,wasPlaying:!1},t}();!function(t){t.version="4.1.0",t.player=nt,t.parseSource=q,t.kwzParser=K,t.ppmParser=E,t.gifEncoder=Z,t.wavEncoder=X}(J||(J={}));var st=J,ht=nt,rt=q,et=K,ot=E,ut=Z,ft=X;t.default=st,t.gifEncoder=ut,t.kwzParser=et,t.parseSource=rt,t.player=ht,t.ppmParser=ot,t.version="4.1.0",t.wavEncoder=ft,Object.defineProperty(t,"o",{value:!0})}));
