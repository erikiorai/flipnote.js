/*!!
 * flipnote.js v5.12.0
 * https://flipnote.js.org
 * A JavaScript library for Flipnote Studio animation files
 * 2018 - 2024 James Daniel
 * Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
*/
!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).flipnote={})}(this,(function(t){class ByteArray{constructor(){this.pageSize=4096,this.allocSize=0,this.realSize=0,this.pages=[],this.numPages=0,this.pageIdx=0,this.pagePtr=0,this.realPtr=0,this.newPage()}set pointer(t){this.setPointer(t)}get pointer(){return this.realPtr}newPage(){this.pages[this.numPages]=new Uint8Array(this.pageSize),this.numPages=this.pages.length,this.allocSize=this.numPages*this.pageSize}setPointer(t){for(;t>=this.allocSize;)this.newPage();t>this.realSize&&(this.realSize=t),this.pageIdx=Math.floor(t/this.pageSize),this.pagePtr=t%this.pageSize,this.realPtr=t}writeByte(t){this.pages[this.pageIdx][this.pagePtr]=t,this.setPointer(this.realPtr+1)}writeBytes(t,s,i){for(let e=i||t.length,r=s||0;r<e;r++)this.writeByte(t[r])}writeChars(t){for(let s=0;s<t.length;s++)this.writeByte(t.charCodeAt(s))}writeU8(t){this.writeByte(255&t)}writeU16(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255)}writeU32(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255),this.writeByte(t>>>16&255),this.writeByte(t>>>24&255)}getBytes(){const t=new Uint8Array(this.realSize),s=this.numPages;for(let i=0;i<s;i++){const e=this.pages[i];i===s-1?t.set(e.slice(0,this.realSize%this.pageSize),i*this.pageSize):t.set(e,i*this.pageSize)}return t}getBuffer(){return this.getBytes().buffer}}class DataStream{constructor(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}get bytes(){return new Uint8Array(this.buffer)}get byteLength(){return this.data.byteLength}seek(t,s){switch(s){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;default:this.pointer=t}}readUint8(){const t=this.data.getUint8(this.pointer);return this.pointer+=1,t}writeUint8(t){this.data.setUint8(this.pointer,t),this.pointer+=1}readInt8(){const t=this.data.getInt8(this.pointer);return this.pointer+=1,t}writeInt8(t){this.data.setInt8(this.pointer,t),this.pointer+=1}readUint16(t=!0){const s=this.data.getUint16(this.pointer,t);return this.pointer+=2,s}writeUint16(t,s=!0){this.data.setUint16(this.pointer,t,s),this.pointer+=2}readInt16(t=!0){const s=this.data.getInt16(this.pointer,t);return this.pointer+=2,s}writeInt16(t,s=!0){this.data.setInt16(this.pointer,t,s),this.pointer+=2}readUint32(t=!0){const s=this.data.getUint32(this.pointer,t);return this.pointer+=4,s}writeUint32(t,s=!0){this.data.setUint32(this.pointer,t,s),this.pointer+=4}readInt32(t=!0){const s=this.data.getInt32(this.pointer,t);return this.pointer+=4,s}writeInt32(t,s=!0){this.data.setInt32(this.pointer,t,s),this.pointer+=4}readBytes(t){const s=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=s.byteLength,s}writeBytes(t){t.forEach((t=>this.writeUint8(t)))}readHex(t,s=!1){const i=this.readBytes(t);let e=[];for(let t=0;t<i.length;t++)e.push(i[t].toString(16).padStart(2,"0"));return s&&e.reverse(),e.join("").toUpperCase()}readChars(t){const s=this.readBytes(t);let i="";for(let t=0;t<s.length;t++){const e=s[t];if(0===e)break;i+=String.fromCharCode(e)}return i}writeChars(t){for(let s=0;s<t.length;s++){const i=t.charCodeAt(s);this.writeUint8(i)}}readWideChars(t){const s=new Uint16Array(this.data.buffer,this.pointer,t);let i="";for(let t=0;t<s.length;t++){const e=s[t];if(0==e)break;i+=String.fromCharCode(e)}return this.pointer+=s.byteLength,i}}const s=new Int8Array([-1,2,-1,2]),i=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),e=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function r(t,s,i){return t<s?s:t>i?i:t}function n(t,s,i){return i<0||i>=s?0:t[i]}function h(t){const s=t.length;let i=0;for(let e=0;e<s;e++){const s=t[e];(s<=-32768||s>=32767)&&(i+=1)}return i/s}function o(t){const s=t.length;let i=0;for(let e=0;e<s;e++)i+=Math.pow(t[e],2);return Math.sqrt(i/s)}function a(t,s="Assert failed"){if(!t)throw new Error(s)}function u(t,s,i,e=""){a(t>=s&&t<=i,`${e||"value"} ${t} should be between ${s} and ${i}`)}function c(t,s){try{return t.require(s)}catch{throw new Error(`Could not require(${s})`)}}function l(){return y?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{}}const f="undefined"!=typeof window&&void 0!==window.document;function d(){return a(f,"This feature is only available in browser environments")}const y="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;function p(){return a(y,"This feature is only available in NodeJS environments")}const m="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,w=(()=>{if(f||m){const t=l();return(t.crypto||t.msCrypto).subtle}if(y)return c(module,"crypto").webcrypto.subtle})(),g="RSASSA-PKCS1-v1_5";async function A(t,s){const i=t.split("\n").filter((t=>!t.startsWith("-----")&&!t.endsWith("-----"))).join(""),e=atob(i),r=new Uint8Array(e.length).map(((t,s)=>e.charCodeAt(s)));return await w.importKey("spki",r.buffer,{name:g,hash:s},!1,["verify"])}async function P(t,s,i){return await w.verify(g,t,s,i)}function v(t){return new Date(1e3*(t+946684800))}function F(t,s){return 100*t*(1/s)/100}var b;t.FlipnoteRegion=void 0,(b=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",b.USA="USA",b.JPN="JPN",b.UNKNOWN="UNKNOWN";const S=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,z=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,U=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/,x=["01FACA7A4367FC5F","03D6E959E2F9A42D","03F80445160587FA","04068426E1008915","092A3EC8199FD5D5","0B8D56BA1BD441B8","0E61C75C9B5AD90B","14E494E35A443235"],T=x.map((t=>K(t)));function _(t){return S.test(t)||x.includes(t)}function E(t){return z.test(t)}function I(t){if(U.test(t))return!0;for(let s of T)if(t.endsWith(s))return!0;return!1}function C(s){switch(s.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function M(s){if(I(s))switch(s.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}switch(s.slice(0,2)){case"00":return t.FlipnoteRegion.JPN;case"02":return t.FlipnoteRegion.USA;case"04":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function B(t){return U.test(t)?(t.slice(19,21)+t.slice(17,19)+t.slice(15,17)+t.slice(12,14)+t.slice(10,12)+t.slice(7,9)+t.slice(5,7)+t.slice(2,4)).toUpperCase():null}function K(t){return S.test(t)?(t.slice(14,16)+t.slice(12,14)+"-"+t.slice(10,12)+t.slice(8,10)+"-"+t.slice(6,8)+t.slice(4,6)+"-"+t.slice(2,4)+t.slice(0,2)).toLowerCase():null}var k,L,N,D,$,R,H,G=Object.freeze({__proto__:null,get FlipnoteRegion(){return t.FlipnoteRegion},convertKwzFsidToPpmFsid:B,convertPpmFsidToKwzFsidSuffix:K,convertPpmFsidToPossibleKwzFsids(t){const s=K(t);return s?["00"+s,"10"+s,"12"+s,"14"+s]:null},getFsidRegion:s=>_(s)?C(s):E(s)?M(s):t.FlipnoteRegion.UNKNOWN,getKwzFsidRegion:M,getPpmFsidRegion:C,isFsid:t=>_(t)||E(t),isKwzDsiLibraryFsid:I,isKwzFsid:E,isPpmFsid:_,testKwzFsidMatchesPpmFsid:(t,s)=>B(t)==s});!function(){if(!f)return function(){};document.createElement("a")}(),t.FlipnoteFormat=void 0,(L=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",L.KWZ="KWZ",function(t){t[t.Jpeg=0]="Jpeg",t[t.Rgba=1]="Rgba"}(N||(N={})),function(t){t[t.Left=0]="Left",t[t.Right=1]="Right"}(D||(D={})),t.FlipnoteAudioTrack=void 0,($=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[$.BGM=0]="BGM",$[$.SE1=1]="SE1",$[$.SE2=2]="SE2",$[$.SE3=3]="SE3",$[$.SE4=4]="SE4",t.FlipnoteSoundEffectTrack=void 0,(R=t.FlipnoteSoundEffectTrack||(t.FlipnoteSoundEffectTrack={}))[R.SE1=1]="SE1",R[R.SE2=2]="SE2",R[R.SE3=3]="SE3",R[R.SE4=4]="SE4";class FlipnoteParserBase extends DataStream{constructor(){super(...arguments),this[k]="Flipnote",this.titleFormats={COMMENT:"Comment by $USERNAME",FLIPNOTE:"Flipnote by $USERNAME",ICON:"Folder icon"},this.soundMeta=new Map,this.layerVisibility={1:!0,2:!0,3:!0},this.isFolderIcon=!1,this.isComment=!1,this.isDsiLibraryNote=!1}getTitle(t=this.titleFormats){return this.isFolderIcon?t.ICON:(this.isComment?t.COMMENT:t.FLIPNOTE).replace("$USERNAME",this.meta.current.username)}toString(){return this.getTitle()}*[(k=Symbol.toStringTag,Symbol.iterator)](){for(let t=0;t<this.frameCount;t++)yield t}getLayerPixels(t,s,i=new Uint8Array(this.imageWidth*this.imageHeight),e=0,r=D.Left){u(t,0,this.frameCount-1,"Frame index"),u(s,0,this.numLayers-1,"Layer index");const n=this.getFramePaletteIndices(t),h=s*this.numLayerColors,o=this.decodeFrame(t)[s],a=Math.floor(this.getFrameLayerDepths(t)[s]*e),c=r==D.Left?-a:a,l=this.srcWidth,f=this.imageWidth,d=this.imageWidth,y=this.imageHeight,p=this.imageOffsetX,m=this.imageOffsetY;if(i.fill(0),!this.layerVisibility[s+1])return i;for(let t=m,s=0;s<y;t++,s++)for(let e=p,r=0;r<d;e++,r++){const a=s*f+r+c;let u=o[t*l+e];0!==u&&(i[a]=n[h+u])}return i}getLayerPixelsRgba(t,s,i=new Uint32Array(this.imageWidth*this.imageHeight),e=new Uint32Array(16),r=0,n=D.Left){u(t,0,this.frameCount-1,"Frame index"),u(s,0,this.numLayers-1,"Layer index"),this.getFramePaletteUint32(t,e);const h=s*this.numLayerColors,o=this.decodeFrame(t)[s],a=Math.floor(this.getFrameLayerDepths(t)[s]*r),c=n==D.Left?-a:a,l=this.srcWidth,f=this.imageWidth,d=this.imageWidth-a,y=this.imageHeight,p=this.imageOffsetX,m=this.imageOffsetY;if(i.fill(0),!this.layerVisibility[s+1])return i;for(let t=m,s=0;s<y;t++,s++)for(let r=p,n=0;n<d;r++,n++){const a=s*f+n+c;let u=o[t*l+r];0!==u&&(i[a]=e[h+u])}return i}getFramePixels(t,s=new Uint8Array(this.imageWidth*this.imageHeight),i=0,e=D.Left){const r=this.srcWidth;this.imageWidth;const n=this.imageWidth,h=this.imageHeight,o=this.imageOffsetX,a=this.imageOffsetY,u=this.getFramePaletteIndices(t);s.fill(u[0]);const c=this.getFrameLayerOrder(t),l=this.getFrameLayerDepths(t),f=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const d=c[t],y=f[d],p=d*this.numLayerColors,m=Math.floor(l[d]*i),w=e==D.Left?-m:m;if(this.layerVisibility[d+1])for(let t=a,i=0;i<h;t++,i++)for(let e=o,h=0;h<n;e++,h++){const o=i*n+h+w;let a=y[t*r+e];0!==a&&(s[o]=u[p+a])}}return s}getFramePixelsRgba(t,s=new Uint32Array(this.imageWidth*this.imageHeight),i=new Uint32Array(16),e=0,r=D.Left){u(t,0,this.frameCount-1,"Frame index");const n=this.srcWidth,h=this.imageWidth,o=this.imageWidth,a=this.imageHeight,c=this.imageOffsetX,l=this.imageOffsetY;this.getFramePaletteUint32(t,i),s.fill(i[0]);const f=this.getFrameLayerOrder(t),d=this.getFrameLayerDepths(t),y=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const u=f[t];if(!this.layerVisibility[u+1])continue;const p=y[u],m=u*this.numLayerColors,w=Math.floor(d[u]*e),g=r==D.Left?-w:w;for(let t=l,e=0;t<a;t++,e++)for(let r=c,a=0;r<o;r++,a++){const o=e*h+a+g;let u=p[t*n+r];0!==u&&(s[o]=i[m+u])}}return s}getFramePaletteUint32(t,s=new Uint32Array(16)){u(t,0,this.frameCount-1,"Frame index");const i=this.getFramePalette(t);return s.fill(0),i.forEach((([t,i,e,r],n)=>s[n]=r<<24|e<<16|i<<8|t)),s}getSoundEffectFlagsForTrack(t){return this.getSoundEffectFlags().map((s=>s[t]))}isSoundEffectUsedOnFrame(t,s){return u(s,0,this.frameCount-1,"Frame index"),!!this.soundEffectTracks.includes(t)&&this.getFrameSoundEffectFlags(s)[t]}hasAudioTrack(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0}}const W=[.5,.5,1,2,4,6,12,20,30],O={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},j=[4294967295,4283585106,4294967295,4288453788,4282665215,4283388360,4289506815,4278255360,4294918216,4290269009,4294945709,4278255360,4290205622,4278255360,4278255360,4278255360],Q="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCPLwTL6oSflv+gjywi/sM0TUB\n90xqOvuCpjduETjPoN2FwMebxNjdKIqHUyDu4AvrQ6BDJc6gKUbZ1E27BGZoCPH4\n9zQRb+zAM6M9EjHwQ6BABr0u2TcF7xGg2uQ9MBWz9AfbVQ91NjfrNWo0f7UPmffv\n1VvixmTk1BCtavZxBwIDAQAB\n-----END PUBLIC KEY-----";class PpmParser extends FlipnoteParserBase{constructor(s,i={}){super(s),this.format=t.FlipnoteFormat.PPM,this[H]="Flipnote Studio PPM animation file",this.imageWidth=PpmParser.width,this.imageHeight=PpmParser.height,this.aspect=PpmParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=PpmParser.numLayers,this.numLayerColors=PpmParser.numLayerColors,this.publicKey=PpmParser.publicKey,this.srcWidth=PpmParser.width,this.audioTracks=PpmParser.audioTracks,this.soundEffectTracks=PpmParser.soundEffectTracks,this.rawSampleRate=PpmParser.rawSampleRate,this.sampleRate=PpmParser.sampleRate,this.globalPalette=PpmParser.globalPalette,this.prevDecodedFrame=null,this.decodeHeader(),this.decodeAnimationHeader(),this.decodeSoundHeader(),this.version>>4&15&&this.decodeMeta(),this.layerBuffers=[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],this.prevLayerBuffers=[new Uint8Array(PpmParser.width*PpmParser.height),new Uint8Array(PpmParser.width*PpmParser.height)],this.lineEncodingBuffers=[new Uint8Array(PpmParser.height),new Uint8Array(PpmParser.height)],this.prevDecodedFrame=null}decodeHeader(){a(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16();let t=1696+this.frameDataLength+this.frameCount;t%4!=0&&(t+=4-t%4),a(t<this.byteLength),this.soundDataOffset=t}readFilename(){return`${this.readHex(3)}_${this.readChars(13)}_${this.readUint16().toString().padStart(3,"0")}`}decodeMeta(){a(1704<this.byteLength),this.seek(16);const t=this.readUint16(),s=this.readInt16(),i=this.readWideChars(11),e=this.readWideChars(11),r=this.readWideChars(11),n=this.readHex(8,!0),h=this.readHex(8,!0),o=this.readFilename(),u=this.readFilename(),c=this.readHex(8,!0);this.seek(154);const l=v(this.readInt32());this.seek(1702);const f=this.readUint16();this.thumbFrameIndex=s,this.layerVisibility={1:!(16&f),2:!(32&f),3:!1},this.isSpinoff=h!==n||h!==c,this.meta={lock:1===t,loop:1==(f>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:s,timestamp:l,root:{username:i,fsid:c,region:C(c),filename:null},parent:{username:e,fsid:n,region:C(n),filename:o},current:{username:r,fsid:h,region:C(h),filename:u}}}decodeAnimationHeader(){this.seek(1696);const t=this.readUint16(),s=t/4;a(s<=this.frameCount),this.seek(1704);const i=new Uint32Array(s);for(let e=0;e<s;e++){const s=1704+t+this.readUint32();a(s<this.byteLength,`Frame ${e} pointer is out of bounds`),i[e]=s}this.frameOffsets=i}decodeSoundHeader(){let s=this.soundDataOffset;this.seek(s);const i=this.readUint32(),e=this.readUint32(),r=this.readUint32(),n=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),a(this.frameSpeed<=8&&this.bgmSpeed<=8),s+=32,this.framerate=W[this.frameSpeed],this.duration=F(this.frameCount,this.framerate),this.bgmrate=W[this.bgmSpeed];const h=new Map;h.set(t.FlipnoteAudioTrack.BGM,{ptr:s,length:i}),h.set(t.FlipnoteAudioTrack.SE1,{ptr:s+=i,length:e}),h.set(t.FlipnoteAudioTrack.SE2,{ptr:s+=e,length:r}),h.set(t.FlipnoteAudioTrack.SE3,{ptr:s+=r,length:n}),this.soundMeta=h}isKeyFrame(t){return u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]),this.readUint8()>>7&1}getThumbnailImage(){this.seek(160);const t=this.readBytes(1536),s=new Uint32Array(3072);for(let i=0;i<48;i+=8)for(let e=0;e<64;e+=8)for(let r=0;r<8;r+=1)for(let n=0;n<8;n+=2){const h=e+n,o=i+r;s[64*o+h]=j[15&t[0]],s[64*o+h+1]=j[t[0]<<4&15]}return{format:N.Rgba,width:64,height:48,data:s.buffer}}decodeFrame(t){if(u(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame===t-1||this.isKeyFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);const s=this.readUint8(),i=s>>7&1,e=s>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);let r=0,n=0;e&&(r=this.readInt8(),n=this.readInt8());for(let t=0;t<2;t++){const s=this.lineEncodingBuffers[t];s.fill(0);for(let t=0;t<s.length;){let i=this.readUint8();0!==i?(s[t++]=3&i,s[t++]=i>>2&3,s[t++]=i>>4&3,s[t++]=i>>6&3):t+=4}}for(let t=0;t<2;t++){const s=this.layerBuffers[t],i=this.lineEncodingBuffers[t];for(let t=0;t<PpmParser.height;t++){let e=t*PpmParser.width;switch(i[t]){case 0:break;case 1:for(var h=this.readUint32(!1);0!==h;h<<=1,e+=8)if(2147483648&h){let t=this.readUint8();for(let i=0;0!==t;i++,t>>=1)s[e+i]=1&t}break;case 2:for(s.fill(1,e,e+PpmParser.width),h=this.readUint32(!1);0!==h;h<<=1,e+=8)if(2147483648&h){let t=this.readUint8();for(let i=0;i<8;i++,t>>=1)s[e+i]=1&t}break;case 3:for(let t=0,i=0;i<PpmParser.width;i++)i%8==0&&(t=this.readUint8()),s[e++]=1&t,t>>=1}}}const o=this.layerBuffers[0],a=this.layerBuffers[1],c=this.prevLayerBuffers[0],l=this.prevLayerBuffers[1];if(i||0!==r||0!==n){if(!i){const t=PpmParser.width,s=PpmParser.height,i=Math.max(r,0),e=Math.max(n,0),h=Math.min(t+r,t),u=Math.min(s+n,s),f=n*t+r;let d,y;for(let s=e;s<u;s++)for(let e=i;e<h;e++)d=s*t+e,y=d-f,o[d]^=c[y],a[d]^=l[y]}}else{const t=PpmParser.height*PpmParser.width;for(let s=0;s<t;s++)o[s]^=c[s],a[s]^=l[s]}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers}getFramePaletteIndices(t){u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]);const s=this.readUint8(),i=!!(1&~s),e=[i?0:1,i?0:1,2,3];return[i?1:0,e[s>>1&3],e[s>>3&3]]}getFramePalette(t){return u(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((t=>this.globalPalette[t]))}getIsKeyFrame(t){const s=1===this.isKeyFrame(t);return[s,s]}getFrameLayerDepths(t){return[0,0]}getFrameAuthor(t){return this.meta.current.fsid}getFrameCameraFlags(t){return[!1,!1]}getFrameLayerOrder(t){return[1,0]}decodeSoundFlags(){if(void 0!==this.soundFlags)return this.soundFlags;a(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);const t=this.frameCount,s=this.readBytes(t);this.soundFlags=new Array(t);for(let i=0;i<t;i++){const t=s[i];this.soundFlags[i]=[!!(1&t),!!(2&t),!!(4&t)]}return this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map((s=>({[t.FlipnoteSoundEffectTrack.SE1]:s[0],[t.FlipnoteSoundEffectTrack.SE2]:s[1],[t.FlipnoteSoundEffectTrack.SE3]:s[2],[t.FlipnoteSoundEffectTrack.SE4]:!1})))}getFrameSoundEffectFlags(s){u(s,0,this.frameCount-1,"Frame index"),this.seek(1696+this.frameDataLength+s);const i=this.readUint8();return{[t.FlipnoteSoundEffectTrack.SE1]:!!(1&i),[t.FlipnoteSoundEffectTrack.SE2]:!!(2&i),[t.FlipnoteSoundEffectTrack.SE3]:!!(4&i),[t.FlipnoteSoundEffectTrack.SE4]:!1}}getAudioTrackRaw(t){const s=this.soundMeta.get(t);return a(s.ptr+s.length<this.byteLength),this.seek(s.ptr),this.readBytes(s.length)}decodeAudioTrack(t){const s=this.getAudioTrackRaw(t),n=s.length,h=new Int16Array(2*n);let o=0,a=0,u=0,c=0,l=0,f=!0;for(;o<n;){u=f?15&s[o]:s[o++]>>4,f=!f;const t=e[c];let n=t>>3;1&u&&(n+=t>>2),2&u&&(n+=t>>1),4&u&&(n+=t),8&u&&(n=-n),l+=n,l=r(l,-32768,32767),c+=i[u],c=r(c,0,88),h[a++]=l}return h}getAudioTrackPcm(s,i=this.sampleRate){const e=this.decodeAudioTrack(s);let r=this.rawSampleRate;if(s===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==i?function(t,s,i){const e=t.length,r=e/s*i,h=new Int16Array(r),o=s/i;for(let s=0;s<r;s++)h[s]=n(t,e,Math.floor(s*o));return h}(e,r,i):e}pcmAudioMix(t,s,i=0){const e=t.length,n=s.length;for(let h=0;h<e&&!(i+h>n);h++){const e=s[i+h]+t[h]/2;s[i+h]=r(e,-32768,32767)}}getAudioMasterPcm(s=this.sampleRate){const i=Math.ceil(this.duration*s),e=new Int16Array(i),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(r){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,s);this.pcmAudioMix(i,e,0)}if(n||o||a){const i=s/this.framerate,r=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,s):null,h=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,s):null,u=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,s):null,c=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const s=Math.ceil(t*i),l=c[t];n&&l[0]&&this.pcmAudioMix(r,e,s),o&&l[1]&&this.pcmAudioMix(h,e,s),a&&l[2]&&this.pcmAudioMix(u,e,s)}}return this.audioClipRatio=h(e),e}getBody(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(0,t)}getSignature(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(t,t+128)}async verify(){const t=await A(Q,"SHA-1");return await P(t,this.getSignature(),this.getBody())}}var q;H=Symbol.toStringTag,PpmParser.defaultSettings={},PpmParser.format=t.FlipnoteFormat.PPM,PpmParser.width=256,PpmParser.height=192,PpmParser.aspect=3/4,PpmParser.numLayers=2,PpmParser.numLayerColors=1,PpmParser.rawSampleRate=8192,PpmParser.sampleRate=32768,PpmParser.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3],PpmParser.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3],PpmParser.globalPalette=[O.WHITE,O.BLACK,O.RED,O.BLUE],PpmParser.publicKey=Q;const Y=[.2,.5,1,2,4,6,8,12,20,24,30],V={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},J="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuv+zHAXXvbbtRqxADDeJ\nArX2b9RMxj3T+qpRg3FnIE/jeU3tj7eoDzsMduY+D/UT9CSnP+QHYY/vf0n5lqX9\ns6ljoZAmyUuruyj1e5Bg+fkDEu/yPEPQjqhbyywCyYL4TEAOJveopUBx9fdQxUJ6\nJ4J5oCE/Im1kFrlGW+puARiHmt3mmUyNzO8bI/Jx3cGSfoOHJG1foEaQsI5aaKqA\npBqxtzvwqMhudcZtAWSyRMBMlndvkRnVTDNTfTXLOYdHShCIgnKULCTH87uLBIP/\nnsmr4/bnQz8q2rp/HyVO+0yjR6mVr0NX5APJQ+6riJmGg3t3VOldhKP7aTHDUW+h\nkQIDAQAB\n-----END PUBLIC KEY-----",X=new Uint16Array(16);for(let t=0;t<16;t++)X[t]=(1<<t)-1;const Z=new Uint8Array(52488),tt=new Uint8Array(52488);var st=0;for(let t=0;t<3;t++)for(let s=0;s<3;s++)for(let i=0;i<3;i++)for(let e=0;e<3;e++)for(let r=0;r<3;r++)for(let n=0;n<3;n++)for(let h=0;h<3;h++)for(let o=0;o<3;o++)Z.set([s,t,e,i,n,r,o,h],st),tt.set([t,e,i,n,r,o,h,s],st),st+=8;const it=new Uint8Array(256),et=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach(((t,s)=>{const i=8*t,e=Z.subarray(i,i+8),r=tt.subarray(i,i+8);it.set(e,8*s),et.set(r,8*s)}));class KwzParser extends FlipnoteParserBase{constructor(s,i={}){super(s),this.format=t.FlipnoteFormat.KWZ,this[q]="Flipnote Studio 3D KWZ animation file",this.imageWidth=KwzParser.width,this.imageHeight=KwzParser.height,this.aspect=KwzParser.aspect,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=KwzParser.numLayers,this.numLayerColors=KwzParser.numLayerColors,this.publicKey=KwzParser.publicKey,this.srcWidth=KwzParser.width,this.audioTracks=KwzParser.audioTracks,this.soundEffectTracks=KwzParser.soundEffectTracks,this.rawSampleRate=KwzParser.rawSampleRate,this.sampleRate=KwzParser.sampleRate,this.globalPalette=KwzParser.globalPalette,this.prevDecodedFrame=null,this.bitIndex=0,this.bitValue=0,this.settings={...KwzParser.defaultSettings,...i},this.layerBuffers=[new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height),new Uint8Array(KwzParser.width*KwzParser.height)],this.buildSectionMap(),this.sectionMap.has("KIC")?(this.isFolderIcon=!0,this.imageWidth=24,this.imageHeight=24,this.frameCount=1,this.frameSpeed=0,this.framerate=Y[0],this.thumbFrameIndex=0,this.getFrameOffsets()):this.sectionMap.has("KSN")?(this.decodeMeta(),this.getFrameOffsets(),this.decodeSoundHeader()):(this.isComment=!0,this.decodeMeta(),this.getFrameOffsets()),this.settings.dsiLibraryNote&&(this.isDsiLibraryNote=!0),this.settings.borderCrop&&(this.isDsiLibraryNote?(this.imageOffsetX=32,this.imageOffsetY=24,this.imageWidth=256,this.imageHeight=192):this.isFolderIcon||(this.imageOffsetX=5,this.imageOffsetY=5,this.imageWidth=310,this.imageHeight=230))}buildSectionMap(){const t=this.byteLength-256,s=new Map;let i=0,e=0;for(;e<t&&i<6;){this.seek(e);const t=this.readChars(4).substring(0,3),r=this.readUint32();s.set(t,{ptr:e,length:r}),e+=r+8,i+=1}this.bodyEndOffset=e,this.sectionMap=s,a(s.has("KMC")&&s.has("KMI"))}readBits(t){if(this.bitIndex+t>16){const t=this.readUint16();this.bitValue|=t<<16-this.bitIndex,this.bitIndex-=16}const s=this.bitValue&X[t];return this.bitValue>>=t,this.bitIndex+=t,s}readFsid(){if(this.settings.dsiLibraryNote)return this.readHex(10,!0).slice(2,18);const t=this.readHex(10);return`${t.slice(0,4)}-${t.slice(4,8)}-${t.slice(8,12)}-${t.slice(12,18)}`.toLowerCase()}readFilename(){const t=this.pointer,s=this.readChars(28);if(28===s.length)return s;this.seek(t);const i=this.readHex(3),e=this.readChars(13),r=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),`${i}_${e}_${r}`}decodeMeta(){if(this.settings.quickMeta)return this.decodeMetaQuick();a(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);const t=v(this.readUint32()),s=v(this.readUint32());this.readUint32();const i=this.readFsid(),e=this.readFsid(),r=this.readFsid(),n=this.readWideChars(11),h=this.readWideChars(11),o=this.readWideChars(11),u=this.readFilename(),c=this.readFilename(),l=this.readFilename(),f=this.readUint16(),d=this.readUint16(),y=this.readUint16(),p=this.readUint8(),m=this.readUint8();this.isSpinoff=r!==e||r!==i,this.frameCount=f,this.frameSpeed=p,this.framerate=Y[p],this.duration=F(this.frameCount,this.framerate),this.thumbFrameIndex=d,this.layerVisibility={1:!(1&m),2:!(2&m),3:!(3&m)},this.meta={lock:!!(1&y),loop:!!(2&y),isSpinoff:this.isSpinoff,frameCount:f,frameSpeed:p,duration:this.duration,thumbIndex:d,timestamp:s,creationTimestamp:t,root:{username:n,fsid:i,region:M(i),filename:u,isDsiFilename:28!==u.length},parent:{username:h,fsid:e,region:M(e),filename:c,isDsiFilename:28!==c.length},current:{username:o,fsid:r,region:M(r),filename:l,isDsiFilename:28!==l.length}}}decodeMetaQuick(){a(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);const t=this.readUint16(),s=this.readUint16();this.readUint16();const i=this.readUint8(),e=this.readUint8();this.frameCount=t,this.thumbFrameIndex=s,this.frameSpeed=i,this.framerate=Y[i],this.duration=F(this.frameCount,this.framerate),this.layerVisibility={1:!(1&e),2:!(2&e),3:!(3&e)}}getFrameOffsets(){a(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));const t=this.frameCount,s=this.sectionMap.get("KMI"),i=this.sectionMap.get("KMC");a(s.length/28>=t);const e=new Uint32Array(t),r=new Uint32Array(t),n=[];let h=s.ptr+8,o=i.ptr+12;for(let s=0;s<t;s++){this.seek(h+4);const t=this.readUint16(),i=this.readUint16(),u=this.readUint16();e[s]=h,r[s]=o,h+=28,o+=t+i+u,a(h<this.byteLength,`frame${s} meta pointer out of bounds`),a(o<this.byteLength,`frame${s} data pointer out of bounds`),n.push([t,i,u])}this.frameMetaOffsets=e,this.frameDataOffsets=r,this.frameLayerSizes=n}decodeSoundHeader(){a(this.sectionMap.has("KSN"));let s=this.sectionMap.get("KSN").ptr+8;this.seek(s),this.bgmSpeed=this.readUint32(),a(this.bgmSpeed<=10),this.bgmrate=Y[this.bgmSpeed];const i=new Uint32Array(this.buffer,s+4,20),e=new Map;e.set(t.FlipnoteAudioTrack.BGM,{ptr:s+=28,length:i[0]}),e.set(t.FlipnoteAudioTrack.SE1,{ptr:s+=i[0],length:i[1]}),e.set(t.FlipnoteAudioTrack.SE2,{ptr:s+=i[1],length:i[2]}),e.set(t.FlipnoteAudioTrack.SE3,{ptr:s+=i[2],length:i[3]}),e.set(t.FlipnoteAudioTrack.SE4,{ptr:s+=i[3],length:i[4]}),this.soundMeta=e}getThumbnailImage(){a(this.sectionMap.has("KTN"),"KTN section missing - Note that folder icons and comments do not contain thumbnail data");const t=this.sectionMap.get("KTN");this.seek(t.ptr+12);const s=this.readBytes(t.length-12);return{format:N.Jpeg,width:80,height:64,data:s.buffer}}getFramePaletteIndices(t){u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]);const s=this.readUint32();return[15&s,s>>8&15,s>>12&15,s>>16&15,s>>20&15,s>>24&15,s>>28&15]}getFramePalette(t){return u(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((t=>this.globalPalette[t]))}getFrameDiffingFlag(t){return u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]),this.readUint32()>>4&7}getIsKeyFrame(t){const s=this.getFrameDiffingFlag(t);return[!(1&s),!(2&s),!(4&s)]}getFrameLayerDepths(t){return u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]}getFrameAuthor(t){return u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+10),this.readFsid()}getFrameCameraFlags(t){this.seek(this.frameMetaOffsets[t]+26);const s=this.readUint8();return[!!(1&s),!!(2&s),!!(4&s)]}getFrameLayerOrder(t){u(t,0,this.frameCount-1,"Frame index");const s=this.getFrameLayerDepths(t);return[2,1,0].sort(((t,i)=>s[i]-s[t]))}decodeFrame(t,s=7,i=!1){if(u(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame!==t-1&&0!==t&&(i&&(s&=~this.getFrameDiffingFlag(t+1)),0!==s&&this.decodeFrame(t-1,s,!0));let e=this.frameDataOffsets[t];const r=this.frameLayerSizes[t];for(let t=0;t<3&&(!this.settings.dsiLibraryNote||3!==t);t++){this.seek(e);let i=r[t];e+=i;const n=this.layerBuffers[t];if(38===i)continue;if(!(s>>t&1))continue;this.bitIndex=16,this.bitValue=0;let h=0;for(let t=0;t<240;t+=128)for(let s=0;s<320;s+=128)for(let i=0;i<128;i+=8){const e=t+i;if(e>=240)break;for(let t=0;t<128;t+=8){const i=s+t;if(i>=320)break;if(h>0){h-=1;continue}let r=e*KwzParser.width+i;const o=this.readBits(3);if(0===o){const t=8*this.readBits(5),s=it.subarray(t,t+8);n.set(s,r),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320)}else if(1===o){const t=8*this.readBits(13),s=Z.subarray(t,t+8);n.set(s,r),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(s,r+=320)}else if(2===o){const t=8*this.readBits(5),s=it.subarray(t,t+8),i=et.subarray(t,t+8);n.set(s,r),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320)}else if(3===o){const t=8*this.readBits(13),s=Z.subarray(t,t+8),i=tt.subarray(t,t+8);n.set(s,r),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320),n.set(s,r+=320),n.set(i,r+=320)}else if(4===o){const t=this.readBits(8);for(let s=1;s<255;s<<=1){if(t&s){const t=8*this.readBits(5),s=it.subarray(t,t+8);n.set(s,r)}else{const t=8*this.readBits(13),s=Z.subarray(t,t+8);n.set(s,r)}r+=320}}else{if(5===o){h=this.readBits(5);continue}if(7===o){let t,s,i=this.readBits(2);if(0!==this.readBits(1)){const e=8*this.readBits(5),r=8*this.readBits(5);t=it.subarray(e,e+8),s=it.subarray(r,r+8),i+=1}else{const i=8*this.readBits(13),e=8*this.readBits(13);t=Z.subarray(i,i+8),s=Z.subarray(e,e+8)}switch(i%4){case 0:n.set(t,r),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320);break;case 1:n.set(t,r),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(t,r+=320);break;case 2:n.set(t,r),n.set(s,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(s,r+=320);break;case 3:n.set(t,r),n.set(s,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320),n.set(s,r+=320),n.set(t,r+=320),n.set(s,r+=320)}}}}}}return this.prevDecodedFrame=t,this.layerBuffers}decodeFrameSoundFlags(t){u(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+23);const s=this.readUint8();return[!!(1&s),!!(2&s),!!(4&s),!!(8&s)]}decodeSoundFlags(){return void 0!==this.soundFlags||(this.soundFlags=new Array(this.frameCount).fill(!1).map(((t,s)=>this.decodeFrameSoundFlags(s)))),this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map((s=>({[t.FlipnoteSoundEffectTrack.SE1]:s[0],[t.FlipnoteSoundEffectTrack.SE2]:s[1],[t.FlipnoteSoundEffectTrack.SE3]:s[2],[t.FlipnoteSoundEffectTrack.SE4]:s[3]})))}getFrameSoundEffectFlags(s){const i=this.decodeFrameSoundFlags(s);return{[t.FlipnoteSoundEffectTrack.SE1]:i[0],[t.FlipnoteSoundEffectTrack.SE2]:i[1],[t.FlipnoteSoundEffectTrack.SE3]:i[2],[t.FlipnoteSoundEffectTrack.SE4]:i[3]}}getAudioTrackRaw(t){const s=this.soundMeta.get(t);return a(s.ptr+s.length<this.byteLength),new Uint8Array(this.buffer,s.ptr,s.length)}decodeAdpcm(t,n,h=0,o=0){const a=t.length;let u=0,c=0,l=0,f=0;for(let d=0;d<a;d++){let a=t[d],y=0;for(;y<8;)o<18||y>4?(c=3&a,l=e[o],f=l>>3,1&c&&(f+=l),2&c&&(f=-f),h+=f,o+=s[c],a>>=2,y+=2):(c=15&a,l=e[o],f=l>>3,1&c&&(f+=l>>2),2&c&&(f+=l>>1),4&c&&(f+=l),8&c&&(f=-f),h+=f,o+=i[c],a>>=4,y+=4),o=r(o,0,79),h=r(h,-2048,2047),n[u]=16*h,u+=1}return u}decodeAudioTrack(s){const i=this.settings,e=this.getAudioTrackRaw(s),r=60*this.rawSampleRate,n=new Int16Array(r);let h=0,a=40;if(this.isDsiLibraryNote)if(s===t.FlipnoteAudioTrack.BGM){let t=!0;if(null!==i.initialBgmPredictor&&(h=i.initialBgmPredictor,t=!1),null!==i.initialBgmStepIndex&&(a=i.initialBgmStepIndex,t=!1),t&&i.guessInitialBgmState){let t=4294967295,s=0;for(a=0;a<=40;a++){const i=this.decodeAdpcm(e,n,h,a),r=o(n.subarray(0,i));r<t&&(t=r,s=a)}a=s}}else{const t=this.soundEffectTracks.indexOf(s);Array.isArray(i.initialSePredictors)&&void 0!==i.initialSePredictors[t]&&(h=i.initialSePredictors[t]),Array.isArray(i.initialSeStepIndices)&&void 0!==i.initialSeStepIndices[t]&&(a=i.initialSeStepIndices[t])}const u=this.decodeAdpcm(e,n,h,a);return n.slice(0,u)}getAudioTrackPcm(s,i=this.sampleRate){const e=this.decodeAudioTrack(s);let r=this.rawSampleRate;if(s===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==i?function(t,s,i){const e=t.length,r=e/s*i,h=new Int16Array(r),o=s/i;for(let s=0,i=0,u=0,c=0;s<r;s++)i=s*o,u=Math.floor(i),c=i%1,h[s]=(a=n(t,e,u))+c*(n(t,e,u+1)-a);var a;return h}(e,r,i):e}pcmAudioMix(t,s,i=0){const e=t.length,n=s.length;for(let h=0;h<e&&!(i+h>n);h++){const e=s[i+h]+t[h];s[i+h]=r(e,-32768,32767)}}getAudioMasterPcm(s=this.sampleRate){const i=Math.ceil(this.duration*s),e=new Int16Array(i),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),u=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(r){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,s);this.pcmAudioMix(i,e,0)}if(n||o||a||u){const i=s/this.framerate,r=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,s):null,h=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,s):null,c=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,s):null,l=u?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,s):null,f=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const s=f[t],d=Math.ceil(t*i);n&&s[0]&&this.pcmAudioMix(r,e,d),o&&s[1]&&this.pcmAudioMix(h,e,d),a&&s[2]&&this.pcmAudioMix(c,e,d),u&&s[3]&&this.pcmAudioMix(l,e,d)}}return this.audioClipRatio=h(e),e}getBody(){const t=this.bodyEndOffset;return this.bytes.subarray(0,t)}getSignature(){const t=this.bodyEndOffset;return this.bytes.subarray(t,t+256)}async verify(){const t=await A(J,"SHA-256");return await P(t,this.getSignature(),this.getBody())}}q=Symbol.toStringTag,KwzParser.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,guessInitialBgmState:!0,initialBgmPredictor:null,initialBgmStepIndex:null,initialSePredictors:null,initialSeStepIndices:null},KwzParser.format=t.FlipnoteFormat.KWZ,KwzParser.width=320,KwzParser.height=240,KwzParser.aspect=3/4,KwzParser.numLayers=3,KwzParser.numLayerColors=2,KwzParser.rawSampleRate=16364,KwzParser.sampleRate=32768,KwzParser.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3,t.FlipnoteAudioTrack.SE4],KwzParser.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3,t.FlipnoteSoundEffectTrack.SE4],KwzParser.globalPalette=[V.WHITE,V.BLACK,V.RED,V.YELLOW,V.GREEN,V.BLUE,V.NONE],KwzParser.publicKey=J;const rt=[{matches:t=>f&&"string"==typeof t,load(t,s,i){const e=new XMLHttpRequest;e.open("GET",t,!0),e.responseType="arraybuffer",e.onreadystatechange=function(t){4===e.readyState&&(e.status>=200&&e.status<300?s(e.response):i({type:"httpError",status:e.status,statusText:e.statusText}))},e.send(null)}},{matches:t=>y&&"string"==typeof t,load(t,s,i){p(),c(module,"https").get(t,(t=>{const e=[];t.on("data",(t=>e.push(t))),t.on("end",(()=>{const t=Buffer.concat(e);s(t.buffer)})),t.on("error",(t=>i(t)))}))}},{matches:t=>f&&"undefined"!=typeof File&&"undefined"!=typeof FileReader&&t instanceof File,load(t,s,i){const e=new FileReader;e.onload=t=>{s(e.result)},e.onerror=t=>{i({type:"fileReadError"})},e.readAsArrayBuffer(t)}},{matches:t=>f&&"undefined"!=typeof Blob&&"undefined"!=typeof Response&&t instanceof Blob,load(t,s,i){new Response(t).arrayBuffer().then(s).catch(i)}},{matches:t=>y&&t instanceof Buffer,load(t,s,i){s(t.buffer)}},{matches:t=>t instanceof ArrayBuffer,load(t,s,i){s(t)}}];function nt(t,s=rt){return new Promise(((i,e)=>{for(let r=0;r<s.length;r++){const n=s[r];if(n.matches(t))return n.load(t,i,e)}e("No loader available for source type")}))}var ht;t.PlayerEvent=void 0,(ht=t.PlayerEvent||(t.PlayerEvent={})).t="any",ht.Play="play",ht.Pause="pause",ht.CanPlay="canplay",ht.CanPlayThrough="canplaythrough",ht.SeekStart="seeking",ht.SeekEnd="seeked",ht.Duration="durationchange",ht.Loop="loop",ht.Ended="ended",ht.VolumeChange="volumechange",ht.Progress="progress",ht.TimeUpdate="timeupdate",ht.FrameUpdate="frameupdate",ht.FrameNext="framenext",ht.FramePrev="frameprev",ht.FrameFirst="framefirst",ht.FrameLast="framelast",ht.Ready="ready",ht.Load="load",ht.LoadStart="loadstart",ht.LoadedData="loadeddata",ht.LoadedMeta="loadedmetadata",ht.Emptied="emptied",ht.Close="close",ht.Error="error",ht.Destroy="destroy";const ot=[t.PlayerEvent.Play,t.PlayerEvent.Pause,t.PlayerEvent.CanPlay,t.PlayerEvent.CanPlayThrough,t.PlayerEvent.SeekStart,t.PlayerEvent.SeekEnd,t.PlayerEvent.Duration,t.PlayerEvent.Loop,t.PlayerEvent.Ended,t.PlayerEvent.VolumeChange,t.PlayerEvent.Progress,t.PlayerEvent.TimeUpdate,t.PlayerEvent.FrameUpdate,t.PlayerEvent.FrameNext,t.PlayerEvent.FramePrev,t.PlayerEvent.FrameFirst,t.PlayerEvent.FrameLast,t.PlayerEvent.Ready,t.PlayerEvent.Load,t.PlayerEvent.LoadStart,t.PlayerEvent.LoadedData,t.PlayerEvent.LoadedMeta,t.PlayerEvent.Emptied,t.PlayerEvent.Close,t.PlayerEvent.Error];function at(t){return{length:t.length,start:s=>t[s][0],end:s=>t[s][1]}}function ut(t,s){return t.toString().padStart(s,"0")}function ct(t){return`${Math.floor(t%3600/60)}:${ut(Math.floor(t%60),2)}`}var lt;!function(t){t[t.None=0]="None",t[t.Dual=1]="Dual",t[t.Anaglyph=2]="Anaglyph"}(lt||(lt={}));const ft=5120,dt=5121,yt=5122,pt=5123,mt=5124,wt=5125,gt=5126;{const t={};t[ft]=Int8Array,t[dt]=Uint8Array,t[yt]=Int16Array,t[pt]=Uint16Array,t[mt]=Int32Array,t[wt]=Uint32Array,t[gt]=Float32Array,t[32819]=Uint16Array,t[32820]=Uint16Array,t[33635]=Uint16Array,t[5131]=Uint16Array,t[33640]=Uint32Array,t[35899]=Uint32Array,t[35902]=Uint32Array,t[36269]=Uint32Array,t[34042]=Uint32Array}function At(t){if(t instanceof Int8Array)return ft;if(t instanceof Uint8Array)return dt;if(t instanceof Uint8ClampedArray)return dt;if(t instanceof Int16Array)return yt;if(t instanceof Uint16Array)return pt;if(t instanceof Int32Array)return mt;if(t instanceof Uint32Array)return wt;if(t instanceof Float32Array)return gt;throw new Error("unsupported typed array type")}const Pt="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function vt(t,s){return"undefined"!=typeof WebGLTexture&&s instanceof WebGLTexture}const Ft=35044,bt=34962,St="";function zt(t,s,i,e){if("undefined"!=typeof WebGLBuffer&&s instanceof WebGLBuffer)return s;i=i||bt;const r=t.createBuffer();return function(t,s,i,e,r){t.bindBuffer(s,i),t.bufferData(s,e,r||Ft)}(t,i,r,s,e),r}function Ut(t){return"indices"===t}const xt=/coord|texture/i,Tt=/color|colour/i;function _t(t,s){let i;if(i=xt.test(t)?2:Tt.test(t)?4:3,s%i>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${i} but ${s} values is not evenly divisible by ${i}. You should specify it.`);return i}function Et(t,s){if(Pt(t))return t;if(Pt(t.data))return t.data;Array.isArray(t)&&(t={data:t});let i=t.type;return i||(i=Ut(s)?Uint16Array:Float32Array),new i(t.data)}const It=["position","positions","a_position"];function Ct(t){return!!t.texStorage2D}const Mt=33984,Bt=34962,Kt=3553,kt=34067,Lt=32879,Nt=35866,Dt={};function $t(t,s){return Dt[s].bindPoint}function Rt(t,s){return function(i){t.uniform1i(s,i)}}function Ht(t,s){return function(i){t.uniform1iv(s,i)}}function Gt(t,s){return function(i){t.uniform2iv(s,i)}}function Wt(t,s){return function(i){t.uniform3iv(s,i)}}function Ot(t,s){return function(i){t.uniform4iv(s,i)}}function jt(t,s,i,e){const r=$t(0,s);return Ct(t)?function(s){let n,h;vt(0,s)?(n=s,h=null):(n=s.texture,h=s.sampler),t.uniform1i(e,i),t.activeTexture(Mt+i),t.bindTexture(r,n),t.bindSampler(i,h)}:function(s){t.uniform1i(e,i),t.activeTexture(Mt+i),t.bindTexture(r,s)}}function Qt(t,s,i,e,r){const n=$t(0,s),h=new Int32Array(r);for(let t=0;t<r;++t)h[t]=i+t;return Ct(t)?function(s){t.uniform1iv(e,h),s.forEach((function(s,e){let r,o;t.activeTexture(Mt+h[e]),vt(0,s)?(r=s,o=null):(r=s.texture,o=s.sampler),t.bindSampler(i,o),t.bindTexture(n,r)}))}:function(s){t.uniform1iv(e,h),s.forEach((function(s,i){t.activeTexture(Mt+h[i]),t.bindTexture(n,s)}))}}function qt(t,s){return function(i){if(i.value)switch(t.disableVertexAttribArray(s),i.value.length){case 4:t.vertexAttrib4fv(s,i.value);break;case 3:t.vertexAttrib3fv(s,i.value);break;case 2:t.vertexAttrib2fv(s,i.value);break;case 1:t.vertexAttrib1fv(s,i.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(Bt,i.buffer),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,i.numComponents||i.size,i.type||5126,i.normalize||!1,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(s,i.divisor)}}function Yt(t,s){return function(i){if(i.value){if(t.disableVertexAttribArray(s),4!==i.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(s,i.value)}else t.bindBuffer(Bt,i.buffer),t.enableVertexAttribArray(s),t.vertexAttribIPointer(s,i.numComponents||i.size,i.type||5124,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(s,i.divisor)}}function Vt(t,s){return function(i){if(i.value){if(t.disableVertexAttribArray(s),4!==i.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(s,i.value)}else t.bindBuffer(Bt,i.buffer),t.enableVertexAttribArray(s),t.vertexAttribIPointer(s,i.numComponents||i.size,i.type||5125,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(s,i.divisor)}}function Jt(t,s,i){const e=i.size,r=i.count;return function(i){t.bindBuffer(Bt,i.buffer);const n=i.size||i.numComponents||e,h=n/r,o=i.type||5126,a=Dt[o].size*n,u=i.normalize||!1,c=i.offset||0,l=a/r;for(let e=0;e<r;++e)t.enableVertexAttribArray(s+e),t.vertexAttribPointer(s+e,h,o,u,a,c+l*e),void 0!==i.divisor&&t.vertexAttribDivisor(s+e,i.divisor)}}Dt[5126]={Type:Float32Array,size:4,setter:(t,s)=>function(i){t.uniform1f(s,i)},arraySetter:(t,s)=>function(i){t.uniform1fv(s,i)}},Dt[35664]={Type:Float32Array,size:8,setter:(t,s)=>function(i){t.uniform2fv(s,i)},cols:2},Dt[35665]={Type:Float32Array,size:12,setter:(t,s)=>function(i){t.uniform3fv(s,i)},cols:3},Dt[35666]={Type:Float32Array,size:16,setter:(t,s)=>function(i){t.uniform4fv(s,i)},cols:4},Dt[5124]={Type:Int32Array,size:4,setter:Rt,arraySetter:Ht},Dt[35667]={Type:Int32Array,size:8,setter:Gt,cols:2},Dt[35668]={Type:Int32Array,size:12,setter:Wt,cols:3},Dt[35669]={Type:Int32Array,size:16,setter:Ot,cols:4},Dt[5125]={Type:Uint32Array,size:4,setter:(t,s)=>function(i){t.uniform1ui(s,i)},arraySetter:(t,s)=>function(i){t.uniform1uiv(s,i)}},Dt[36294]={Type:Uint32Array,size:8,setter:(t,s)=>function(i){t.uniform2uiv(s,i)},cols:2},Dt[36295]={Type:Uint32Array,size:12,setter:(t,s)=>function(i){t.uniform3uiv(s,i)},cols:3},Dt[36296]={Type:Uint32Array,size:16,setter:(t,s)=>function(i){t.uniform4uiv(s,i)},cols:4},Dt[35670]={Type:Uint32Array,size:4,setter:Rt,arraySetter:Ht},Dt[35671]={Type:Uint32Array,size:8,setter:Gt,cols:2},Dt[35672]={Type:Uint32Array,size:12,setter:Wt,cols:3},Dt[35673]={Type:Uint32Array,size:16,setter:Ot,cols:4},Dt[35674]={Type:Float32Array,size:32,setter:(t,s)=>function(i){t.uniformMatrix2fv(s,!1,i)},rows:2,cols:2},Dt[35675]={Type:Float32Array,size:48,setter:(t,s)=>function(i){t.uniformMatrix3fv(s,!1,i)},rows:3,cols:3},Dt[35676]={Type:Float32Array,size:64,setter:(t,s)=>function(i){t.uniformMatrix4fv(s,!1,i)},rows:4,cols:4},Dt[35685]={Type:Float32Array,size:32,setter:(t,s)=>function(i){t.uniformMatrix2x3fv(s,!1,i)},rows:2,cols:3},Dt[35686]={Type:Float32Array,size:32,setter:(t,s)=>function(i){t.uniformMatrix2x4fv(s,!1,i)},rows:2,cols:4},Dt[35687]={Type:Float32Array,size:48,setter:(t,s)=>function(i){t.uniformMatrix3x2fv(s,!1,i)},rows:3,cols:2},Dt[35688]={Type:Float32Array,size:48,setter:(t,s)=>function(i){t.uniformMatrix3x4fv(s,!1,i)},rows:3,cols:4},Dt[35689]={Type:Float32Array,size:64,setter:(t,s)=>function(i){t.uniformMatrix4x2fv(s,!1,i)},rows:4,cols:2},Dt[35690]={Type:Float32Array,size:64,setter:(t,s)=>function(i){t.uniformMatrix4x3fv(s,!1,i)},rows:4,cols:3},Dt[35678]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Kt},Dt[35680]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:kt},Dt[35679]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Lt},Dt[35682]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Kt},Dt[36289]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Nt},Dt[36292]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Nt},Dt[36293]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:kt},Dt[36298]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Kt},Dt[36299]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Lt},Dt[36300]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:kt},Dt[36303]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Nt},Dt[36306]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Kt},Dt[36307]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Lt},Dt[36308]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:kt},Dt[36311]={Type:null,size:0,setter:jt,arraySetter:Qt,bindPoint:Nt};const Xt={};function Zt(t){const s=t.name;return s.startsWith("gl_")||s.startsWith("webgl_")}Xt[5126]={size:4,setter:qt},Xt[35664]={size:8,setter:qt},Xt[35665]={size:12,setter:qt},Xt[35666]={size:16,setter:qt},Xt[5124]={size:4,setter:Yt},Xt[35667]={size:8,setter:Yt},Xt[35668]={size:12,setter:Yt},Xt[35669]={size:16,setter:Yt},Xt[5125]={size:4,setter:Vt},Xt[36294]={size:8,setter:Vt},Xt[36295]={size:12,setter:Vt},Xt[36296]={size:16,setter:Vt},Xt[35670]={size:4,setter:Yt},Xt[35671]={size:8,setter:Yt},Xt[35672]={size:12,setter:Yt},Xt[35673]={size:16,setter:Yt},Xt[35674]={size:4,setter:Jt,count:2},Xt[35675]={size:9,setter:Jt,count:3},Xt[35676]={size:16,setter:Jt,count:4};const ts=/(\.|\[|]|\w+)/g,ss=t=>t>="0"&&t<="9";function is(t,s,i,e){const r=t.split(ts).filter((t=>""!==t));let n=0,h="";for(;;){const t=r[n++];h+=t;const o=ss(t[0]),a=o?parseInt(t):t;if(o&&(h+=r[n++]),n===r.length){i[a]=s;break}{const t=r[n++],s="["===t,o=i[a]||(s?[]:{});i[a]=o,i=o,e[h]=e[h]||function(t){return function(s){es(t,s)}}(o),h+=t}}}function es(t,s){for(const i in s){const e=t[i];"function"==typeof e?e(s[i]):es(t[i],s[i])}}function rs(t,...s){const i=t.uniformSetters||t,e=s.length;for(let t=0;t<e;++t){const e=s[t];if(Array.isArray(e)){const t=e.length;for(let s=0;s<t;++s)rs(i,e[s])}else for(const t in e){const s=i[t];s&&s(e[t])}}}class WebglCanvas{static isSupported(){if(!f)return!1;let t=document.createElement("canvas"),s=t.getContext("2d");const i=null!==s;return t=null,s=null,i}constructor(t,s=640,i=480,e={}){this.supportedStereoscopeModes=[lt.None,lt.Dual],this.stereoscopeMode=lt.None,this.stereoscopeStrength=0,this.paletteBuffer=new Uint32Array(16),this.textureTypes=new Map,this.textureSizes=new Map,this.frameBufferTextures=new Map,this.applyFirefoxFix=!1,this.refs={programs:[],shaders:[],textures:[],buffers:[],frameBuffers:[]},this.isCtxLost=!1,this.handleContextLoss=t=>{this.destroy(),t&&t.preventDefault(),this.isCtxLost||this.options.onlost(),this.isCtxLost=!0},this.handleContextRestored=t=>{this.isCtxLost=!1,this.init(),this.options.onrestored()},d(),this.options={...WebglCanvas.defaultOptions,...e},this.width=s,this.height=i,this.canvas=document.createElement("canvas"),this.canvas.addEventListener("webglcontextlost",this.handleContextLoss,!1),this.canvas.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--webgl",this.gl=this.canvas.getContext("webgl",{antialias:!1,alpha:!0}),t&&t.appendChild(this.canvas),this.init()}init(){this.setCanvasSize(this.width,this.height);const t=this.gl;if(this.checkContextLoss())return;this.layerProgram=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_uv;uniform bool u_flipY;uniform vec2 u_textureSize;uniform int u_3d_eye;uniform float u_3d_depth;uniform float u_3d_strength;void main(){vec4 pos=position;float depthDirection=u_3d_eye==0 ?-1.0 : 1.0;float depthShift=floor(u_3d_depth*u_3d_strength)/(u_textureSize.x/2.0)*depthDirection;pos.x+=depthShift;pos.y*=u_flipY ?-1.0 : 1.0;v_uv=texcoord;gl_Position=pos;}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;uniform int u_3d_mode;void main(){vec4 col=texture2D(u_tex,v_uv);if(col.a==0.0){discard;}gl_FragColor=col;}"),this.upscaleProgram=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,1,1),this.setBuffersAndAttribs(this.layerProgram,this.quadBuffer),this.layerTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameBuffer=this.createFramebuffer(this.frameTexture);const s=t.getExtension("WEBGL_debug_renderer_info"),i=t.getParameter(s.UNMASKED_RENDERER_WEBGL),e=navigator.userAgent,r=e.includes("Firefox")&&e.includes("Mac");this.applyFirefoxFix=r&&i.includes("Apple M")}createProgram(t,s){if(this.checkContextLoss())return;const i=this.gl,e=this.createShader(i.VERTEX_SHADER,t),r=this.createShader(i.FRAGMENT_SHADER,s),n=i.createProgram();if(i.attachShader(n,e),i.attachShader(n,r),i.linkProgram(n),!i.getProgramParameter(n,i.LINK_STATUS)){const t=i.getProgramInfoLog(n);throw i.deleteProgram(n),new Error(t)}const h=function(t,s){const i=function(t,s){let i=0;function e(s,e,r){const n=e.name.endsWith("[0]"),h=e.type,o=Dt[h];if(!o)throw new Error(`unknown type: 0x${h.toString(16)}`);let a;if(o.bindPoint){const s=i;i+=e.size,a=n?o.arraySetter(t,h,s,r,e.size):o.setter(t,h,s,r,e.size)}else a=o.arraySetter&&n?o.arraySetter(t,r):o.setter(t,r);return a.location=r,a}const r={},n={},h=t.getProgramParameter(s,35718);for(let i=0;i<h;++i){const h=t.getActiveUniform(s,i);if(Zt(h))continue;let o=h.name;o.endsWith("[0]")&&(o=o.substr(0,o.length-3));const a=t.getUniformLocation(s,h.name);if(a){const t=e(0,h,a);r[o]=t,is(o,t,n,r)}}return r}(t,s),e=function(t,s){const i={},e=t.getProgramParameter(s,35721);for(let r=0;r<e;++r){const e=t.getActiveAttrib(s,r);if(Zt(e))continue;const n=t.getAttribLocation(s,e.name),h=Xt[e.type],o=h.setter(t,n,h);o.location=n,i[e.name]=o}return i}(t,s),r={program:s,uniformSetters:i,attribSetters:e};return Ct(t)&&(r.uniformBlockSpec=function(t,s){const i=t.getProgramParameter(s,35718),e=[],r=[];for(let n=0;n<i;++n){r.push(n),e.push({});const i=t.getActiveUniform(s,n);e[n].name=i.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(i){const n=i[0],h=i[1];t.getActiveUniforms(s,r,t[n]).forEach((function(t,s){e[s][h]=t}))}));const n={},h=t.getProgramParameter(s,35382);for(let i=0;i<h;++i){const e=t.getActiveUniformBlockName(s,i),r={index:t.getUniformBlockIndex(s,e),usedByVertexShader:t.getActiveUniformBlockParameter(s,i,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(s,i,35398),size:t.getActiveUniformBlockParameter(s,i,35392),uniformIndices:t.getActiveUniformBlockParameter(s,i,35395)};r.used=r.usedByVertexShader||r.usedByFragmentShader,n[e]=r}return{blockSpecs:n,uniformData:e}}(t,s),r.transformFeedbackInfo=function(t,s){const i={},e=t.getProgramParameter(s,35971);for(let r=0;r<e;++r){const e=t.getTransformFeedbackVarying(s,r);i[e.name]={index:r,type:e.type,size:e.size}}return i}(t,s)),r}(i,n);return this.refs.programs.push(n),h}createShader(t,s){if(this.checkContextLoss())return;const i=this.gl,e=i.createShader(t);if(i.shaderSource(e,s),i.compileShader(e),!i.getShaderParameter(e,i.COMPILE_STATUS)){const t=i.getShaderInfoLog(e);throw i.deleteShader(e),new Error(t)}return this.refs.shaders.push(e),e}createScreenQuad(t,s,i,e,r,n){if(this.checkContextLoss())return;const h=(r+1)*(n+1),o=r+1,a=new Float32Array(2*h),u=new Float32Array(2*h);let c=0,l=0;for(let h=0;h<=n;h++)for(let o=0;o<=r;o++){const f=o/r,d=h/n;a[c++]=t+i*f,a[c++]=s+e*d,u[l++]=f,u[l++]=d}const f=new Uint16Array(r*n*2*3);let d=0;for(let t=0;t<n;t++)for(let s=0;s<r;s++)f[d++]=(t+0)*o+s,f[d++]=(t+1)*o+s,f[d++]=(t+0)*o+s+1,f[d++]=(t+0)*o+s+1,f[d++]=(t+1)*o+s,f[d++]=(t+1)*o+s+1;const y=function(t,s,i){const e=function(t,s){const i={};return Object.keys(s).forEach((function(e){if(!Ut(e)){const n=s[e],h=n.attrib||n.name||n.attribName||St+e;if(n.value){if(!Array.isArray(n.value)&&!Pt(n.value))throw new Error("array.value is not array or typedarray");i[h]={value:n.value}}else{let s,o,a,u;if(n.buffer&&n.buffer instanceof WebGLBuffer)s=n.buffer,u=n.numComponents||n.size,o=n.type,a=n.normalize;else if("number"==typeof n||"number"==typeof n.data){const i=n.data||n,h=n.type||Float32Array,c=i*h.BYTES_PER_ELEMENT;o=function(t){if(t===Int8Array)return ft;if(t===Uint8Array)return dt;if(t===Uint8ClampedArray)return dt;if(t===Int16Array)return yt;if(t===Uint16Array)return pt;if(t===Int32Array)return mt;if(t===Uint32Array)return wt;if(t===Float32Array)return gt;throw new Error("unsupported typed array type")}(h),a=void 0!==n.normalize?n.normalize:(r=h)===Int8Array||r===Uint8Array,u=n.numComponents||n.size||_t(e,i),s=t.createBuffer(),t.bindBuffer(bt,s),t.bufferData(bt,c,n.drawType||Ft)}else{const i=Et(n,e);s=zt(t,i,void 0,n.drawType),o=At(i),a=void 0!==n.normalize?n.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(i),u=function(t,s){return t.numComponents||t.size||_t(s,function(t){return t.length?t:t.data}(t).length)}(n,e)}i[h]={buffer:s,numComponents:u,type:o,normalize:a,stride:n.stride||0,offset:n.offset||0,divisor:void 0===n.divisor?void 0:n.divisor,drawType:n.drawType}}}var r})),t.bindBuffer(bt,null),i}(t,s),r=Object.assign({},{});r.attribs=Object.assign({},{},e);const n=s.indices;if(n){const s=Et(n,"indices");r.indices=zt(t,s,34963),r.numElements=s.length,r.elementType=At(s)}else r.numElements||(r.numElements=function(t,s){let i,e;for(e=0;e<It.length&&(i=It[e],!(i in s))&&(i=St+i,!(i in s));++e);e===It.length&&(i=Object.keys(s)[0]);const r=s[i];if(!r.buffer)return 1;t.bindBuffer(bt,r.buffer);const n=t.getBufferParameter(bt,34660);var h;t.bindBuffer(bt,null);const o=n/(5120===(h=r.type)||5121===h?1:5122===h||5123===h?2:5124===h||5125===h||5126===h?4:0),a=r.numComponents||r.size,u=o/a;if(u%1!=0)throw new Error(`numComponents ${a} not correct for length ${length}`);return u}(t,r.attribs));return r}(this.gl,{position:{numComponents:2,data:a},texcoord:{numComponents:2,data:u},indices:f});for(let t in y.attribs)this.refs.buffers.push(y.attribs[t].buffer);return y}setBuffersAndAttribs(t,s){var i,e,r;this.checkContextLoss()||(i=this.gl,e=t.attribSetters,(r=s).vertexArrayObject?i.bindVertexArray(r.vertexArrayObject):(function(t,s){for(const i in s){const e=t[i];e&&e(s[i])}}(e.attribSetters||e,r.attribs),r.indices&&i.bindBuffer(34963,r.indices)))}createTexture(t,s,i,e=1,r=1){if(this.checkContextLoss())return;const n=this.gl,h=n.createTexture();return n.bindTexture(n.TEXTURE_2D,h),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,s),n.texImage2D(n.TEXTURE_2D,0,t,e,r,0,t,n.UNSIGNED_BYTE,null),this.refs.textures.push(h),this.textureTypes.set(h,t),this.textureSizes.set(h,{width:e,height:r}),h}resizeTexture(t,s,i){if(this.checkContextLoss())return;const e=this.gl,r=this.textureTypes.get(t);e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,r,s,i,0,r,e.UNSIGNED_BYTE,null),this.textureSizes.set(t,{width:s,height:i})}createFramebuffer(t){if(this.checkContextLoss())return;const s=this.gl,i=s.createFramebuffer();return s.bindFramebuffer(s.FRAMEBUFFER,i),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,t,0),this.refs.frameBuffers.push(i),this.frameBufferTextures.set(i,t),i}useFramebuffer(t,s,i,e,r){if(this.checkContextLoss())return;const n=this.gl;if(null===t){if(n.bindFramebuffer(n.FRAMEBUFFER,null),this.applyFirefoxFix){const t=this.srcWidth,h=this.srcHeight,o=n.drawingBufferWidth/t,a=n.drawingBufferHeight/h,u=256===t?1:0;s=-((e=n.drawingBufferWidth*(o-u))-t*o),i=-((r=n.drawingBufferHeight*(a-u))-h*a)}n.viewport(s??0,i??0,e??n.drawingBufferWidth,r??n.drawingBufferHeight)}else{const h=this.frameBufferTextures.get(t),{width:o,height:a}=this.textureSizes.get(h);n.bindFramebuffer(n.FRAMEBUFFER,t),n.viewport(s??0,i??0,e??o,r??a)}}resizeFramebuffer(t,s,i){if(this.checkContextLoss())return;const e=this.frameBufferTextures.get(t);this.resizeTexture(e,s,i)}setCanvasSize(t,s){const i=this.options.useDpi&&window.devicePixelRatio||1,e=t*i,r=s*i;this.width=t,this.height=s,this.canvas.width=e,this.canvas.height=r,this.dstWidth=e,this.dstHeight=r,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${s}px`,this.checkContextLoss()}setNote(t){if(this.checkContextLoss())return;const s=t.imageWidth,i=t.imageHeight;this.note=t,this.srcWidth=s,this.srcHeight=i,this.resizeFramebuffer(this.frameBuffer,s,i),this.resizeTexture(this.layerTexture,s,i),this.layerTexturePixelBuffer=new Uint32Array(s*i),this.layerTexturePixels=new Uint8Array(this.layerTexturePixelBuffer.buffer),this.frameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(this.checkContextLoss())return;const s=this.gl,i=t??this.note.getFramePalette(this.frameIndex)[0],[e,r,n,h]=i;s.clearColor(e/255,r/255,n/255,h/255),s.clear(s.COLOR_BUFFER_BIT)}drawFrame(t){if(this.checkContextLoss())return;const s=this.gl,i=this.stereoscopeMode,e=this.stereoscopeStrength;this.frameIndex=t,i===lt.None?(this.drawLayers(t),this.useFramebuffer(null),this.upscale(s.drawingBufferWidth,s.drawingBufferHeight)):i===lt.Dual&&(this.drawLayers(t,e,D.Left),this.useFramebuffer(null,0,0,s.drawingBufferWidth/2,s.drawingBufferHeight),this.upscale(s.drawingBufferWidth/2,s.drawingBufferHeight),this.drawLayers(t,e,D.Right),this.useFramebuffer(null,s.drawingBufferWidth/2,0,s.drawingBufferWidth/2,s.drawingBufferHeight),this.upscale(s.drawingBufferWidth/2,s.drawingBufferHeight))}upscale(t,s){if(this.checkContextLoss())return;const i=this.gl;i.useProgram(this.upscaleProgram.program),rs(this.upscaleProgram,{u_tex:this.frameTexture,u_textureSize:[this.srcWidth,this.srcHeight],u_screenSize:[t,s]}),i.drawElements(i.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}requestStereoScopeMode(t){this.supportedStereoscopeModes.includes(t)?this.stereoscopeMode=t:this.stereoscopeMode=lt.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}isErrorState(){const t=this.gl;return null===t||t.getError()!==t.NO_ERROR}drawLayers(t,s=0,i=D.Left,e=!0){const r=this.gl,n=this.note,h=this.srcWidth,o=this.srcHeight,a=n.numLayers,u=n.getFrameLayerOrder(t),c=n.getFrameLayerDepths(t);this.useFramebuffer(this.frameBuffer),e&&this.clear(),r.useProgram(this.layerProgram.program);for(let e=0;e<a;e++){const a=u[e];n.getLayerPixelsRgba(t,a,this.layerTexturePixelBuffer,this.paletteBuffer),rs(this.layerProgram,{u_flipY:!0,u_tex:this.layerTexture,u_textureSize:[h,o],u_3d_mode:this.stereoscopeMode,u_3d_eye:i,u_3d_depth:c[a],u_3d_strength:s}),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,h,o,0,r.RGBA,r.UNSIGNED_BYTE,this.layerTexturePixels),r.drawElements(r.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)}}checkContextLoss(){const t=this.isCtxLost||this.isErrorState();return t&&this.handleContextLoss(),t}getDataUrl(t,s){return this.canvas.toDataURL(t,s)}async getBlob(t,s){return new Promise(((i,e)=>this.canvas.toBlob(i,t,s)))}destroy(){const t=this.refs,s=this.gl,i=this.canvas;t.shaders.forEach((t=>{s.deleteShader(t)})),t.shaders=[],t.textures.forEach((t=>{s.deleteTexture(t)})),t.textures=[],t.buffers.forEach((t=>{s.deleteBuffer(t)})),t.buffers=[],t.frameBuffers.forEach((t=>{s.deleteFramebuffer(t)})),t.frameBuffers=[],t.programs.forEach((t=>{s.deleteProgram(t)})),t.programs=[],this.paletteBuffer=null,this.layerTexturePixelBuffer=null,this.layerTexturePixels=null,this.textureTypes.clear(),this.textureSizes.clear(),this.frameBufferTextures.clear(),i&&i.parentElement&&(i.width=1,i.height=1,i.parentNode.removeChild(i))}}WebglCanvas.defaultOptions={onlost(){},onrestored(){},useDpi:!0};class Html5Canvas{static isSupported(){if(!f)return!1;let t=document.createElement("canvas"),s=t.getContext("2d");const i=null!==s;return t=null,s=null,i}constructor(t,s,i,e={}){this.supportedStereoscopeModes=[lt.None],this.stereoscopeMode=lt.None,this.stereoscopeStrength=0,this.paletteBuffer=new Uint32Array(16),d(),this.options={...Html5Canvas.defaultOptions,...e},this.width=s,this.height=i,this.canvas=document.createElement("canvas"),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--html5",this.ctx=this.canvas.getContext("2d"),this.srcCanvas=document.createElement("canvas"),this.srcCtx=this.srcCanvas.getContext("2d"),a(null!==this.ctx&&null!==this.srcCtx,"Could not create HTML5 canvas"),t&&t.appendChild(this.canvas),this.setCanvasSize(s,i)}setCanvasSize(t,s){const i=this.canvas,e=this.options.useDpi&&window.devicePixelRatio||1,r=t*e,n=s*e;this.width=t,this.height=s,this.dstWidth=r,this.dstHeight=n,i.style.width=`${t}px`,i.style.height=`${s}px`,i.width=r,i.height=n}setNote(t){const s=t.imageWidth,i=t.imageHeight;this.note=t,this.srcWidth=s,this.srcHeight=i,this.srcCanvas.width=s,this.srcCanvas.height=i,this.frameImage=this.srcCtx.createImageData(s,i),this.frameBuffer=new Uint32Array(this.frameImage.data.buffer),this.frameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(this.frameBuffer.fill(0),this.ctx.clearRect(0,0,this.dstWidth,this.dstHeight),t){const[s,i,e,r]=t;this.ctx.fillStyle=`rgba(${s}, ${i}, ${e}, ${r})`,this.ctx.fillRect(0,0,this.dstWidth,this.dstHeight)}}drawFrame(t){this.clear(),this.options.useSmoothing||(this.ctx.imageSmoothingEnabled=!1),this.note.getFramePixelsRgba(t,this.frameBuffer,this.paletteBuffer),this.srcCtx.putImageData(this.frameImage,0,0),this.ctx.drawImage(this.srcCanvas,0,0,this.srcWidth,this.srcHeight,0,0,this.dstWidth,this.dstHeight),this.frameIndex=t}requestStereoScopeMode(t){this.supportedStereoscopeModes.includes(t)?this.stereoscopeMode=t:this.stereoscopeMode=lt.None,this.forceUpdate()}forceUpdate(){void 0!==this.frameIndex&&this.drawFrame(this.frameIndex)}getDataUrl(t,s){return this.canvas.toDataURL(t,s)}async getBlob(t,s){return new Promise(((i,e)=>this.canvas.toBlob(i,t,s)))}destroy(){this.frameImage=null,this.paletteBuffer=null,this.frameBuffer=null,this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null,this.srcCanvas.width=1,this.srcCanvas.height=1,this.srcCanvas=null}}Html5Canvas.defaultOptions={useDpi:!0,useSmoothing:!0};class UniversalCanvas{constructor(t,s=640,i=480,e={}){this.isReady=!1,this.isHtml5=!1,this.supportedStereoscopeModes=[],this.stereoscopeMode=lt.None,this.stereoscopeStrength=1,this.rendererStack=[WebglCanvas,Html5Canvas],this.rendererStackIdx=0,this.options={},this.width=s,this.height=i,this.parent=t,this.options=e,this.setSubRenderer(this.rendererStack[0])}setSubRenderer(t){let s=!1;const i=new t(this.parent,this.width,this.height,{...this.options,onlost:()=>{s=!0,this.fallbackIfPossible()}});s||(this.note&&(i.setNote(this.note),i.frameIndex=this.renderer?.frameIndex,i.forceUpdate()),this.renderer&&this.renderer.destroy(),this.isHtml5=i instanceof Html5Canvas,this.isReady=!0,this.renderer=i,this.rendererStackIdx=this.rendererStack.indexOf(t),this.supportedStereoscopeModes=i.supportedStereoscopeModes,i.stereoscopeStrength=this.stereoscopeStrength,this.requestStereoScopeMode(this.stereoscopeMode))}fallbackIfPossible(){if(this.rendererStackIdx>=this.rendererStack.length)throw new Error("No renderer to fall back to");this.rendererStackIdx+=1,this.setSubRenderer(this.rendererStack[this.rendererStackIdx])}switchToHtml5(){this.setSubRenderer(Html5Canvas)}setCanvasSize(t,s){const i=this.renderer;i.setCanvasSize(t,s),this.width=t,this.width=s,this.dstWidth=i.dstWidth,this.dstHeight=i.dstHeight}setNote(t){this.note=t,this.renderer.setNote(t),this.frameIndex=void 0,this.srcWidth=this.renderer.srcWidth,this.srcHeight=this.renderer.srcHeight}clear(t){this.renderer.clear(t)}drawFrame(t){this.renderer.drawFrame(t),this.frameIndex=t}forceUpdate(){this.renderer.forceUpdate()}requestStereoScopeMode(t){this.renderer.requestStereoScopeMode(t),this.stereoscopeMode=this.renderer.stereoscopeMode}getDataUrl(t,s){return this.renderer.getDataUrl()}async getBlob(t,s){return this.renderer.getBlob()}destroy(){this.renderer.destroy(),this.note=null}}const ns=f?window.AudioContext||window.webkitAudioContext:null;class WebAudioPlayer{constructor(){this.useEq=!1,this.useAnalyser=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this.i=1,this.h=!1,this.o=0,this.u=0,this.nodeRefs=[],d()}set volume(t){this.setVolume(t)}get volume(){return this.i}set loop(t){this.h=t,this.source&&(this.source.loop=t)}get loop(){return this.h}getCtx(){return this.ctx||(this.ctx=new ns),this.ctx}setBuffer(t,s){const i=this.getCtx(),e=t.length,r=i.createBuffer(1,e,s),n=r.getChannelData(0);if(t instanceof Float32Array)n.set(t,0);else if(t instanceof Int16Array)for(let s=0;s<e;s++)n[s]=t[s]/32768;this.buffer=r,this.sampleRate=s}connectEqNodesTo(t){const s=this.getCtx(),i=this.eqSettings;let e=t;return i.forEach((([t,r],n)=>{const h=s.createBiquadFilter();this.nodeRefs.push(h),h.frequency.value=t,h.gain.value=r,0===n?h.type="lowshelf":n===i.length-1?h.type="highshelf":h.type="peaking",e.connect(h),e=h})),e}initNodes(){const t=this.getCtx();this.nodeRefs=[];const s=t.createBufferSource();this.nodeRefs.push(s),s.buffer=this.buffer;const i=t.createGain();if(this.nodeRefs.push(i),this.useEq?this.connectEqNodesTo(s).connect(i):s.connect(i),this.useAnalyser){const s=t.createAnalyser();this.nodeRefs.push(s),this.analyser=s,i.connect(s),s.connect(t.destination)}else this.analyser=void 0,i.connect(t.destination);this.source=s,this.gainNode=i,this.setVolume(this.i)}setAnalyserEnabled(t){this.useAnalyser=t,this.initNodes()}setVolume(t){this.i=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))}playFrom(t){this.initNodes(),this.o=t,this.u=this.ctx.currentTime,this.source.loop=this.h,this.source.start(0,t)}stop(){this.source&&this.source.stop(0)}getCurrentTime(){return this.o+(this.ctx.currentTime-this.u)}async destroy(){this.stop();const t=this.getCtx();this.nodeRefs.forEach((t=>t.disconnect())),this.nodeRefs=[],this.analyser=void 0,"closed"!==t.state&&"function"==typeof t.close&&await t.close(),this.buffer=null}}class Player{constructor(s,i,e,r={}){this.duration=0,this.autoplay=!1,this.supportedEvents=ot,this.l=null,this.h=!1,this.i=1,this.p=!1,this.m=null,this.A=!1,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.lastParser=void 0,this.lastLoaders=void 0,this.playbackLoop=s=>{if(!this.isPlaying)return;const i=s/1e3,e=this.duration,r=this.audio.getCurrentTime();let n=i-this.playbackStartTime;if(Math.abs(n%e-r%e)>.01&&(n=r),n>=e){if(!this.loop)return this.pause(),this.A=!0,void this.emit(t.PlayerEvent.Ended);this.playbackStartTime=i,this.emit(t.PlayerEvent.Loop)}this.setCurrentTime(n%e),this.playbackLoopId=requestAnimationFrame(this.playbackLoop)},d();const n="string"==typeof s?document.querySelector(s):s;this.parserSettings=r,this.renderer=new UniversalCanvas(n,i,e,{onlost:()=>this.emit(t.PlayerEvent.Error),onrestored:()=>this.reload()}),this.audio=new WebAudioPlayer,this.el=n}get src(){return this.l}set src(t){throw new Error("Setting a Player source has been deprecated, please use the load() method instead")}get paused(){return!this.isPlaying}set paused(t){t?this.pause():this.play()}get currentFrame(){return this.m}set currentFrame(t){this.setCurrentFrame(t)}get currentTime(){return this.isNoteLoaded?this.playbackTime:null}set currentTime(t){this.setCurrentTime(t)}get progress(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null}set progress(t){this.setProgress(t)}get volume(){return this.getVolume()}set volume(t){this.setVolume(t)}get muted(){return this.getMuted()}set muted(t){this.setMuted(t)}get loop(){return this.getLoop()}set loop(t){this.setLoop(t)}get framerate(){return this.note.framerate}get frameCount(){return this.note.frameCount}get frameSpeed(){return this.note.frameSpeed}get buffered(){return at([[0,this.duration]])}get seekable(){return at([[0,this.duration]])}get currentSrc(){return this.l}get videoWidth(){return this.isNoteLoaded?this.note.imageWidth:0}get videoHeight(){return this.isNoteLoaded?this.note.imageHeight:0}async load(s,i,e){if(this.isNoteLoaded&&this.closeNote(),this.l=s,!s)return this.openNote(this.note);this.emit(t.PlayerEvent.LoadStart);const[r,n]=await(async t=>{try{return[null,await t().catch((t=>{throw t}))]}catch(t){return[t,null]}})((()=>i(s,this.parserSettings,e)));if(r)throw this.emit(t.PlayerEvent.Error,r),new Error(`Error loading Flipnote: ${r.message}`);this.lastParser=i,this.lastLoaders=e,this.openNote(n)}async reload(){if(this.note&&this.lastParser)return await this.load(this.note.buffer,this.lastParser,this.lastLoaders)}async updateSettings(t){return this.parserSettings=t,await this.reload()}closeNote(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this.l=null,this.m=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clear()}openNote(s){this.isNoteLoaded&&this.closeNote(),this.note=s,this.meta=s.meta,this.emit(t.PlayerEvent.LoadedMeta),this.noteFormat=s.format,this.duration=s.duration,this.playbackTime=0,this.m=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=s.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(s.getAudioMasterPcm(),s.sampleRate),this.emit(t.PlayerEvent.CanPlay),this.emit(t.PlayerEvent.CanPlayThrough),this.setLoop(s.meta.loop),this.renderer.setNote(s),this.drawFrame(s.thumbFrameIndex),this.emit(t.PlayerEvent.LoadedData),this.emit(t.PlayerEvent.Load),this.emit(t.PlayerEvent.Ready),this.autoplay&&this.play()}setCurrentTime(s){this.assertNoteLoaded();const i=Math.floor(s/(1/this.framerate));this.setCurrentFrame(i),this.playbackTime=s,this.emit(t.PlayerEvent.Progress,this.progress)}getCurrentTime(){return this.currentTime}getTimeCounter(){return`${ct(Math.max(this.currentTime,0))} / ${ct(this.duration)}`}getFrameCounter(){return`${ut(this.currentFrame+1,3)} / ${ut(this.frameCount,3)}`}setProgress(t){this.assertNoteLoaded(),u(t,0,100,"progress"),this.currentTime=this.duration*(t/100)}getProgress(){return this.progress}async play(){if(this.assertNoteLoaded(),this.isPlaying)return;this.A&&(this.playbackTime=0,this.A=!1);const s=performance.now();this.playbackStartTime=s/1e3-this.playbackTime,this.isPlaying=!0,this.hasPlaybackStarted=!0,this.playAudio(),this.playbackLoop(s),this.emit(t.PlayerEvent.Play)}pause(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(t.PlayerEvent.Pause))}togglePlay(){this.isPlaying?this.pause():this.play()}getPaused(){return!this.isPlaying}getDuration(){return this.duration}getLoop(){return this.h}setLoop(t){this.h=t,this.audio.loop=t}toggleLoop(){this.setLoop(!this.h)}setCurrentFrame(s){this.assertNoteLoaded();const i=Math.max(0,Math.min(Math.floor(s),this.frameCount-1));(i!==this.currentFrame||this.showThumbnail)&&(this.m=i,this.drawFrame(i),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=i*(1/this.framerate),this.emit(t.PlayerEvent.SeekEnd)),this.emit(t.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(t.PlayerEvent.Progress,this.progress),this.emit(t.PlayerEvent.TimeUpdate,this.currentFrame))}nextFrame(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(t.PlayerEvent.FrameNext)}prevFrame(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(t.PlayerEvent.FramePrev)}lastFrame(){this.currentFrame=this.frameCount-1,this.emit(t.PlayerEvent.FrameLast)}firstFrame(){this.currentFrame=0,this.emit(t.PlayerEvent.FrameFirst)}thumbnailFrame(){this.currentFrame=this.note.thumbFrameIndex}startSeek(){this.isSeeking||(this.emit(t.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)}seek(t){this.isSeeking&&(this.progress=100*t)}endSeek(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1}drawFrame(t){this.renderer.drawFrame(t)}forceUpdate(){this.renderer.forceUpdate()}resize(t,s){s!==.75*t&&console.warn(`Canvas width to height ratio should be 3:4 for best results (got ${t}x${s})`),this.renderer.setCanvasSize(t,s),this.forceUpdate()}setLayerVisibility(t,s){this.note.layerVisibility[t]=s,this.layerVisibility[t]=s,this.forceUpdate()}getLayerVisibility(t){return this.layerVisibility[t]}toggleLayerVisibility(t){this.setLayerVisibility(t,!this.layerVisibility[t])}playAudio(){this.audio.playFrom(this.currentTime)}stopAudio(){this.audio.stop()}toggleAudioEq(){this.setAudioEq(!this.audio.useEq)}setAudioEq(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())}mute(){this.setMuted(!0)}unmute(){this.setMuted(!1)}setMuted(s){this.audio.volume=s?0:this.i,this.p=s,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getMuted(){return 0===this.volume||this.p}toggleMuted(){this.setMuted(!this.p)}setVolume(s){u(s,0,1,"volume"),this.i=s,this.audio.volume=s,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getVolume(){return this.p?0:this.i}seekToNextFrame(){this.nextFrame()}fastSeek(t){this.currentTime=t}canPlayType(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";default:return""}}getVideoPlaybackQuality(){return{creationTime:0,droppedVideoFrames:0,corruptedVideoFrames:0,totalVideoFrames:this.frameCount}}requestPictureInPicture(){throw new Error("Not implemented")}captureStream(){throw new Error("Not implemented")}on(t,s){const i=this.events;(Array.isArray(t)?t:[t]).forEach((t=>{i.has(t)?i.get(t).push(s):i.set(t,[s])}))}off(t,s){const i=this.events;(Array.isArray(t)?t:[t]).forEach((t=>{if(!i.has(t))return;const e=i.get(t);i.set(t,e.splice(e.indexOf(s),1))}))}emit(s,...i){const e=this.events;if(s!==t.PlayerEvent.t&&e.has(s)){e.get(s).forEach((t=>t.apply(null,i)));const t=`on${s}`,r=this;"function"==typeof r[t]&&r[t].apply(null,i)}e.has(t.PlayerEvent.t)&&e.get(t.PlayerEvent.t).forEach((t=>t.apply(null,[s,...i])))}clearEvents(){this.events.clear()}async destroy(){this.clearEvents(),this.emit(t.PlayerEvent.Destroy),this.closeNote(),await this.renderer.destroy(),await this.audio.destroy()}supports(t){const s=this.supportedEvents.includes(t),i="function"==typeof this[t];return s||i}assertNoteLoaded(){a(this.isNoteLoaded,"No Flipnote is currently loaded in this player")}}class EncoderBase{constructor(){this.dataUrl=null}getBuffer(){return p(),Buffer.from(this.getArrayBuffer())}getBlob(){return d(),new Blob([this.getArrayBuffer()],{type:this.mimeType})}getUrl(){return d(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())}revokeUrl(){d(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)}}const hs=5003,os=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];class LzwCompressor{constructor(t,s,i){this.accum=new Uint8Array(256),this.htab=new Int32Array(hs),this.codetab=new Int32Array(hs),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=s,this.colorDepth=i,this.reset()}reset(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}char_out(t,s){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(s)}cl_block(t){this.cl_hash(hs),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)}cl_hash(t){for(var s=0;s<t;++s)this.htab[s]=-1}compress(t,s){var i,e,r,n,h,o,a;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,n=this.nextPixel(),a=0,i=hs;i<65536;i*=2)++a;a=8-a,o=hs,this.cl_hash(o),this.output(this.ClearCode,s);t:for(;-1!=(e=this.nextPixel());)if(i=(e<<12)+n,r=e<<a^n,this.htab[r]!==i){if(this.htab[r]>=0){h=o-r,0===r&&(h=1);do{if((r-=h)<0&&(r+=o),this.htab[r]===i){n=this.codetab[r];continue t}}while(this.htab[r]>=0)}this.output(n,s),n=e,this.free_ent<4096?(this.codetab[r]=this.free_ent++,this.htab[r]=i):this.cl_block(s)}else n=this.codetab[r];this.output(n,s),this.output(this.EOFCode,s)}encode(t,s){this.pixels=t,s.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,s),s.writeByte(0)}flush_char(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)}get_maxcode(t){return(1<<t)-1}nextPixel(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}output(t,s){for(this.cur_accum&=os[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,s),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,s),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(s)}}}class GifImage extends EncoderBase{constructor(t,s,i={}){super(),this.mimeType="gif/image",this.frameCount=0,this.width=t,this.height=s,this.data=new ByteArray,this.settings={...GifImage.defaultSettings,...i},this.compressor=new LzwCompressor(t,s,i.colorDepth)}static fromFlipnote(t,s={}){const i=new GifImage(t.imageWidth,t.imageHeight,{delay:100/t.framerate,repeat:t.meta?.loop?-1:0,...s});i.palette=t.globalPalette;for(let s=0;s<t.frameCount;s++)i.writeFrame(t.getFramePixels(s));return i.finish(),i}static fromFlipnoteFrame(t,s,i={}){const e=new GifImage(t.imageWidth,t.imageHeight,{delay:0,repeat:0,...i});return e.palette=t.globalPalette,e.writeFrame(t.getFramePixels(s)),e.finish(),e}writeFrame(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1}finish(){this.data.writeByte(59)}writeFirstFrame(t){this.writeHeader(),this.writeLogicalScreenDescriptor(),this.writeColorTable(),this.writeNetscapeExt(),this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)}writeAdditionalFrame(t){this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)}writeHeader(){this.data.writeChars("GIF89a")}writeGraphicControlExt(){this.data.writeByte(33),this.data.writeByte(249),this.data.writeByte(4),this.data.writeByte(0),this.data.writeU16(this.settings.delay),this.data.writeByte(0),this.data.writeByte(0)}writeLogicalScreenDescriptor(){const t=this.palette,s=128|this.settings.colorDepth-1<<4|this.colorTableSize(t.length)-1;this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeBytes([s,0,0])}writeNetscapeExt(){this.data.writeByte(33),this.data.writeByte(255),this.data.writeByte(11),this.data.writeChars("NETSCAPE2.0"),this.data.writeByte(3),this.data.writeByte(1),this.data.writeU16(this.settings.repeat),this.data.writeByte(0)}writeColorTable(){const t=this.palette,s=1<<this.colorTableSize(t.length);for(let i=0;i<s;i++){let s=[0,0,0];i<t.length&&(s=t[i]),this.data.writeByte(s[0]),this.data.writeByte(s[1]),this.data.writeByte(s[2])}}writeImageDescriptor(){this.data.writeByte(44),this.data.writeU16(0),this.data.writeU16(0),this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeByte(0)}colorTableSize(t){return Math.max(Math.ceil(Math.log2(t)),1)}writePixels(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)}getArrayBuffer(){return this.data.getBuffer()}getImage(){d();const t=new Image(this.width,this.height);return t.src=this.getUrl(),t}}GifImage.defaultSettings={delay:100,repeat:-1,colorDepth:8};class WavAudio extends EncoderBase{constructor(t,s=1,i=16){super(),this.sampleRate=t,this.channels=s,this.bitsPerSample=i;const e=new ArrayBuffer(44),r=new DataStream(e);r.writeChars("RIFF"),r.writeUint32(0),r.writeChars("WAVE"),r.writeChars("fmt "),r.writeUint32(16),r.writeUint16(1),r.writeUint16(this.channels),r.writeUint32(this.sampleRate),r.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample*this.channels/8),r.writeUint16(this.bitsPerSample),r.writeChars("data"),r.writeUint32(0),this.header=r,this.pcmData=null}static fromFlipnote(t){const s=t.sampleRate,i=new WavAudio(s,1,16),e=t.getAudioMasterPcm(s);return i.writeSamples(e),i}static fromFlipnoteTrack(t,s){const i=t.sampleRate,e=new WavAudio(i,1,16),r=t.getAudioTrackPcm(s,i);return e.writeSamples(r),e}writeSamples(t){let s=this.header;s.seek(4),s.writeUint32(s.byteLength+t.byteLength),s.seek(40),s.writeUint32(t.byteLength),this.pcmData=t}getArrayBuffer(){const t=this.header.bytes,s=new Uint8Array(this.pcmData.buffer),i=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return i.set(t),i.set(s,t.byteLength),i.buffer}}t.CanvasInterface=class{constructor(t,s,i,e){}},t.GifImage=GifImage,t.Html5Canvas=Html5Canvas,t.KwzParser=KwzParser,t.Player=Player,t.PlayerMixin=function(t){class PlayerMixinClass extends t{get renderer(){return this.player.renderer}get audio(){return this.player.audio}get canvasEl(){return this.player.canvasEl}get note(){return this.player.note}get noteFormat(){return this.player.noteFormat}get meta(){return this.player.meta}get duration(){return this.player.duration}get layerVisibility(){return this.player.layerVisibility}get autoplay(){return this.player.autoplay}set autoplay(t){this.player.autoplay=t}}for(let s of Reflect.ownKeys(Player.prototype)){let i=Object.getOwnPropertyDescriptor(Player.prototype,s);s in t.prototype||"constructor"===s||"name"===s||"prototype"===s||(i.value&&"function"==typeof i.value?Object.defineProperty(PlayerMixinClass.prototype,s,{...i,value(...t){return this.player[s](...t)}}):(i.get||i.set)&&Object.defineProperty(PlayerMixinClass.prototype,s,{...i,set(t){this.player[s]=t},get(){return this.player[s]}}))}return PlayerMixinClass},t.PpmParser=PpmParser,t.UniversalCanvas=UniversalCanvas,t.WavAudio=WavAudio,t.WebAudioPlayer=WebAudioPlayer,t.WebglCanvas=WebglCanvas,t.loadSource=nt,t.parseSource=(t,s,i)=>nt(t,i).then((t=>new Promise(((i,e)=>{const r=new Uint8Array(t.slice(0,4)),n=r[0]<<24|r[1]<<16|r[2]<<8|r[3];1346458177===n?i(new PpmParser(t,s)):1262897152==(4294967040&n)||1263092480==(4294967040&n)?i(new KwzParser(t,s)):e("Could not identify source as a valid Flipnote file")})))),t.utils=G,t.version="5.12.0"}));
//# sourceMappingURL=flipnote.min.js.map
