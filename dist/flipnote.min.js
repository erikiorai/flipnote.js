/*!!
 flipnote.js v5.0.0 (web version)
 Javascript parsing and in-browser playback for the .PPM and .KWZ animation formats used by Flipnote Studio and Flipnote Studio 3D.
 Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't endorsed by them in any way.
 2018 - 2021 James Daniel
 github.com/jaames/flipnote.js
 Keep on Flipnoting!
*/
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t=t||self).flipnote={})}(this,(function(t){"use strict";var i=[{matches:function(t){return"string"==typeof t},load:function(t,i,n){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(t){4===r.readyState&&(r.status>=200&&r.status<300?i(r.response):n({type:"httpError",status:r.status,statusText:r.statusText}))},r.send(null)}},{matches:function(t){return"undefined"!=typeof File&&t instanceof File},load:function(t,i,n){if("undefined"!=typeof FileReader){var r=new FileReader;r.onload=function(t){i(r.result)},r.onerror=function(t){n({type:"fileReadError"})},r.readAsArrayBuffer(t)}else n()}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,i,n){i(t)}}];var n=function(t,i){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])})(t,i)};function r(t,i){function r(){this.constructor=t}n(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}var s=function(){return(s=Object.assign||function(t){for(var i,n=1,r=arguments.length;n<r;n++)for(var s in i=arguments[n])Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s]);return t}).apply(this,arguments)};function e(t,i,n,r){return new(n||(n=Promise))((function(s,e){function h(t){try{u(r.next(t))}catch(t){e(t)}}function o(t){try{u(r.throw(t))}catch(t){e(t)}}function u(t){var i;t.done?s(t.value):(i=t.value,i instanceof n?i:new n((function(t){t(i)}))).then(h,o)}u((r=r.apply(t,i||[])).next())}))}function h(t,i){var n,r,s,e,h={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function o(e){return function(o){return function(e){if(n)throw new TypeError("Generator is already executing.");for(;h;)try{if(n=1,r&&(s=2&e[0]?r.return:e[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,e[1])).done)return s;switch(r=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return h.label++,{value:e[1],done:!1};case 5:h.label++,r=e[1],e=[0];continue;case 7:e=h.ops.pop(),h.trys.pop();continue;default:if(!(s=h.trys,(s=s.length>0&&s[s.length-1])||6!==e[0]&&2!==e[0])){h=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){h.label=e[1];break}if(6===e[0]&&h.label<s[1]){h.label=s[1],s=e;break}if(s&&h.label<s[2]){h.label=s[2],h.ops.push(e);break}s[2]&&h.ops.pop(),h.trys.pop();continue}e=i.call(t,h)}catch(t){e=[6,t],r=0}finally{n=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,o])}}}var o,u=function(){function t(){this.pageSize=t.pageSize,this.currPageIndex=-1,this.pages=[],this.cursor=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.currPageIndex]=new Uint8Array(this.pageSize),this.currPage=this.pages[this.currPageIndex],this.cursor=0},t.prototype.getData=function(){for(var t=new Uint8Array(this.currPageIndex*this.pageSize+this.cursor),i=0;i<this.pages.length;i++){var n=this.pages[i];i===this.currPageIndex?t.set(n.slice(0,this.cursor),i*this.pageSize):t.set(n,i*this.pageSize)}return t},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(i){this.cursor>=t.pageSize&&this.newPage(),this.currPage[this.cursor++]=i},t.prototype.writeBytes=function(t,i,n){for(var r=n||t.length,s=i||0;s<r;s++)this.writeByte(t[s])},t.pageSize=4096,t}(),f=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.cursor=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,i){switch(i){case 2:this.cursor=this.data.byteLength+t;break;case 1:this.cursor+=t;break;case 0:default:this.cursor=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.cursor);return this.cursor+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.cursor,t),this.cursor+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.cursor);return this.cursor+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.cursor,t),this.cursor+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var i=this.data.getUint16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeUint16=function(t,i){void 0===i&&(i=!0),this.data.setUint16(this.cursor,t,i),this.cursor+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var i=this.data.getInt16(this.cursor,t);return this.cursor+=2,i},t.prototype.writeInt16=function(t,i){void 0===i&&(i=!0),this.data.setInt16(this.cursor,t,i),this.cursor+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var i=this.data.getUint32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeUint32=function(t,i){void 0===i&&(i=!0),this.data.setUint32(this.cursor,t,i),this.cursor+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var i=this.data.getInt32(this.cursor,t);return this.cursor+=4,i},t.prototype.writeInt32=function(t,i){void 0===i&&(i=!0),this.data.setInt32(this.cursor,t,i),this.cursor+=4},t.prototype.readBytes=function(t){var i=new Uint8Array(this.data.buffer,this.cursor,t);return this.cursor+=i.byteLength,i},t.prototype.writeBytes=function(t){var i=this;t.forEach((function(t){return i.writeUint8(t)}))},t.prototype.readHex=function(t,i){void 0===i&&(i=!1);for(var n=this.readBytes(t),r=[],s=0;s<n.length;s++)r.push(n[s].toString(16).padStart(2,"0"));return i&&r.reverse(),r.join("").toUpperCase()},t.prototype.readChars=function(t){for(var i=this.readBytes(t),n="",r=0;r<i.length;r++){var s=i[r];if(0===s)break;n+=String.fromCharCode(s)}return n},t.prototype.writeChars=function(t){for(var i=0;i<t.length;i++){var n=t.charCodeAt(i);this.writeUint8(n)}},t.prototype.readWideChars=function(t){for(var i=new Uint16Array(this.data.buffer,this.cursor,t),n="",r=0;r<i.length;r++){var s=i[r];if(0==s)break;n+=String.fromCharCode(s)}return this.cursor+=i.byteLength,n},t}();!function(t){t[t.BGM=0]="BGM",t[t.SE1=1]="SE1",t[t.SE2=2]="SE2",t[t.SE3=3]="SE3",t[t.SE4=4]="SE4"}(o||(o={}));var a=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return r(i,t),i.prototype.hasAudioTrack=function(t){return!!(this.soundMeta.hasOwnProperty(t)&&this.soundMeta[t].length>0)},i}(f);function c(t,i,n){return t<i?i:t>n?n:t}function l(t,i,n){for(var r=t.length/i,s=new Int16Array(r*n),e=i/n,h=0;h<s.length;h++)s[h]=t[Math.floor(h*e)];return s}function v(t,i,n){void 0===n&&(n=0);for(var r=t.length,s=i.length,e=0;e<r&&!(n+e>s);e++){var h=i[n+e]+t[e]/2;i[n+e]=c(h,-32768,32767)}}for(var y=new Int8Array([-1,2,-1,2]),d=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),p=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]),w=new Int16Array(360),A=0;A<4;A++)for(var b=0;b<90;b++){var m=(_=p[b])>>3;1&A&&(m+=_),2&A&&(m=-m),w[A+4*b]=m}var g=new Int16Array(1440);for(A=0;A<16;A++)for(b=0;b<90;b++){var _;m=(_=p[b])>>3;4&A&&(m+=_),2&A&&(m+=_>>1),1&A&&(m+=_>>2),8&A&&(m=-m),g[A+16*b]=m}for(var z=[.5,.5,1,2,4,6,12,20,30],U={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},S=function(t){function i(n,r){var s=t.call(this,n)||this;return s.type=i.type,s.width=i.width,s.height=i.height,s.globalPalette=i.globalPalette,s.rawSampleRate=i.rawSampleRate,s.sampleRate=i.sampleRate,s.prevDecodedFrame=null,s.decodeHeader(),s.decodeAnimationHeader(),s.decodeSoundHeader(),0!=(s.version>>4&15)&&s.decodeMeta(),s.layers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],s.prevLayers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],s.prevDecodedFrame=null,s}return r(i,t),i.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},i.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},i.prototype.decodeHeader=function(){this.seek(0);this.readUint32();this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},i.prototype.readFilename=function(){return[this.readHex(3),this.readChars(13),this.readUint16().toString().padStart(3,"0")].join("_")},i.prototype.decodeMeta=function(){this.seek(16);var t=this.readUint16(),i=this.readInt16(),n=this.readWideChars(11),r=this.readWideChars(11),s=this.readWideChars(11),e=this.readHex(8,!0),h=this.readHex(8,!0),o=this.readFilename(),u=this.readFilename(),f=this.readHex(8,!0);this.seek(154);var a=new Date(1e3*(this.readUint32()+946684800));this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=i,this.meta={lock:1===t,loop:1==(c>>1&1),frame_count:this.frameCount,frame_speed:this.frameSpeed,bgm_speed:this.bgmSpeed,thumb_index:i,timestamp:a,spinoff:h!==e||h!==f,root:{filename:null,username:n,fsid:f},parent:{username:r,fsid:e,filename:o},current:{username:s,fsid:h,filename:u}}},i.prototype.decodeAnimationHeader=function(){this.seek(1696);var t=this.readUint16(),i=t/4;this.seek(1704);for(var n=new Uint32Array(i),r=0;r<i;r++)n[r]=1704+t+this.readUint32();this.frameOffsets=n},i.prototype.decodeSoundHeader=function(){var t,i=1696+this.frameDataLength+this.frameCount;i%4!=0&&(i+=4-i%4),this.seek(i);var n=this.readUint32(),r=this.readUint32(),s=this.readUint32(),e=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),i+=32,this.framerate=z[this.frameSpeed],this.bgmrate=z[this.bgmSpeed],this.soundMeta=((t={})[o.BGM]={offset:i,length:n},t[o.SE1]={offset:i+=n,length:r},t[o.SE2]={offset:i+=r,length:s},t[o.SE3]={offset:i+=s,length:e},t)},i.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},i.prototype.getFrameLayerOrder=function(t){return[0,1]},i.prototype.readLineEncoding=function(){for(var t=new Uint8Array(i.height),n=0,r=0;r<48;r++)for(var s=this.readUint8(),e=0;e<8;e+=2)t[n++]=s>>e&3;return t},i.prototype.decodeFrame=function(t){this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.seek(this.frameOffsets[t]);var n=this.readUint8(),r=n>>7&1,s=n>>5&3,e=0,h=0;this.prevDecodedFrame=t,this.layers[0].fill(0),this.layers[1].fill(0),s&&(e=this.readInt8(),h=this.readInt8());for(var o=[this.readLineEncoding(),this.readLineEncoding()],u=0;u<2;u++)for(var f=this.layers[u],a=0;a<i.height;a++){var c=o[u][a],l=a*i.width;switch(c){case 0:break;case 1:case 2:var v=this.readUint32(!1);for(2==c&&f.fill(1,l,l+i.width);4294967295&v;){if(2147483648&v)for(var y=this.readUint8(),d=0;d<8;d++)f[l+d]=y>>d&1;l+=8,v<<=1}break;case 3:for(;l<(a+1)*i.width;){for(y=this.readUint8(),d=0;d<8;d++)f[l+d]=y>>d&1;l+=8}}}var p=this.layers[0],w=this.layers[1],A=this.prevLayers[0],b=this.prevLayers[1];if(!r)for(var m=void 0,g=void 0,_=0;_<i.height;_++)if(!(_-h<0)){if(_-h>=i.height)break;for(var z=0;z<i.width;z++)if(!(z-e<0)){if(z-e>=i.width)break;g=(m=z+_*i.width)-(e+h*i.width),p[m]^=A[g],w[m]^=b[g]}}return this.prevLayers[0].set(this.layers[0]),this.prevLayers[1].set(this.layers[1]),this.layers},i.prototype.getFramePaletteIndices=function(t){this.seek(this.frameOffsets[t]);var i=this.readUint8(),n=1!=(1&i),r=[n?0:1,n?0:1,2,3];return[n?1:0,r[i>>1&3],r[i>>3&3]]},i.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,n){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),s=this.layers[n],e=new Uint8Array(i.width*i.height),h=r[n+1],o=0;o<e.length;o++)1===s[o]&&(e[o]=h);return e},i.prototype.getFramePixels=function(t){var n=this.getFramePaletteIndices(t),r=this.decodeFrame(t),s=new Uint8Array(i.width*i.height),e=r[0],h=r[1],o=n[0],u=n[1],f=n[2];s.fill(o);for(var a=0;a<s.length;a++){var c=e[a],l=h[a];1===c?s[a]=u:1===l&&(s[a]=f)}return s},i.prototype.decodeSoundFlags=function(){this.seek(1696+this.frameDataLength);for(var t=this.frameCount,i=this.readBytes(t),n=new Array(t),r=0;r<t;r++){var s=i[r];n[r]=[0!=(1&s),0!=(2&s),0!=(4&s)]}return n},i.prototype.getAudioTrackRaw=function(t){var i=this.soundMeta[t];return this.seek(i.offset),this.readBytes(i.length)},i.prototype.decodeAudioTrack=function(t){for(var i=this.getAudioTrackRaw(t),n=i.length,r=new Int16Array(2*n),s=0,e=0,h=0,o=0,u=0,f=!0;s<n;){h=f?15&i[s]:i[s++]>>4,f=!f;var a=p[o],l=a>>3;1&h&&(l+=a>>2),2&h&&(l+=a>>1),4&h&&(l+=a),8&h&&(l=-l),u=c(u+=l,-32768,32767),o=c(o+=d[h],0,88),r[e++]=u}return r},i.prototype.getAudioTrackPcm=function(t,i){void 0===i&&(i=32768);var n=this.decodeAudioTrack(t),r=this.rawSampleRate;if(t===o.BGM){var s=Math.round(this.framerate/this.bgmrate);r=this.rawSampleRate*s}return r!==i?l(n,r,i):n},i.prototype.getAudioMasterPcm=function(t){void 0===t&&(t=32768);var i=this.frameCount*(1/this.framerate),n=Math.ceil(i*t),r=new Int16Array(n),s=this.hasAudioTrack(o.BGM),e=this.hasAudioTrack(o.SE1),h=this.hasAudioTrack(o.SE2),u=this.hasAudioTrack(o.SE3);s&&v(this.getAudioTrackPcm(o.BGM,t),r,0);if(e||h||u)for(var f=this.decodeSoundFlags(),a=e?this.getAudioTrackPcm(o.SE1,t):null,c=h?this.getAudioTrackPcm(o.SE2,t):null,l=u?this.getAudioTrackPcm(o.SE3,t):null,y=t/this.rawSampleRate,d=Math.round(this.rawSampleRate/this.framerate)*y,p=0;p<this.frameCount;p++){var w=(p+.5)*d,A=f[p];e&&A[0]&&v(a,r,w),h&&A[1]&&v(c,r,w),u&&A[2]&&v(l,r,w)}return r},i.type="PPM",i.width=256,i.height=192,i.rawSampleRate=8192,i.sampleRate=32768,i.globalPalette=[U.WHITE,U.BLACK,U.RED,U.BLUE],i}(a),T=new Uint8Array(52488),F=0,x=0;x<3;x++)for(var I=0;I<3;I++)for(var E=0;E<3;E++)for(var k=0;k<3;k++)for(var O=0;O<3;O++)for(var P=0;P<3;P++)for(var B=0;B<3;B++)for(var M=0;M<3;M++)T.set([I,x,k,E,P,O,M,B],F),F+=8;var j=new Uint8Array(52488);for(F=0,x=0;x<2187;x+=729)for(I=0;I<729;I+=243)for(E=0;E<243;E+=81)for(k=0;k<81;k+=27)for(O=0;O<27;O+=9)for(P=0;P<9;P+=3)for(B=0;B<3;B+=1)for(M=0;M<6561;M+=2187){var L=x+I+E+k+O+P+B+M,C=T.subarray(8*L,8*L+8);j.set(C,F),F+=8}var D=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,i){var n=T.subarray(8*t,8*t+8);D.set(n,8*i)}));var G=new Uint8Array(256);[0,3280,6560,3,729,2187,81,243,9,27,1,6,1458,4374,162,486,18,54,2,732,2916,2268,324,252,36,28,2460,820,4920,1640,5740,4100].forEach((function(t,i){var n=T.subarray(8*t,8*t+8);G.set(n,8*i)}));for(var N=[.2,.5,1,2,4,6,8,12,20,24,30],R={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},W=new Uint16Array(16),Y=0;Y<16;Y++)W[Y]=(1<<Y)-1;var K=function(t){function i(n,r){void 0===r&&(r={});var e=t.call(this,n)||this;return e.type=i.type,e.width=i.width,e.height=i.height,e.globalPalette=i.globalPalette,e.rawSampleRate=i.rawSampleRate,e.sampleRate=i.sampleRate,e.prevFrameIndex=null,e.bitIndex=0,e.bitValue=0,e.config=s(s({},i.defaultConfig),r),e.layers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],e.bitIndex=0,e.bitValue=0,e.load(),e}return r(i,t),i.prototype.load=function(){this.seek(0),this.sections={};for(var t=this.byteLength-256,i=0,n=0;i<t&&n<6;){this.seek(i);var r=this.readChars(4).substring(0,3),s=this.readUint32();this.sections[r]={offset:i,length:s},i+=s+8,n+=1}this.config.quickMeta?this.decodeMetaQuick():this.decodeMeta(),this.getFrameOffsets(),this.decodeSoundHeader()},i.prototype.readBits=function(t){if(this.bitIndex+t>16){var i=this.readUint16();this.bitValue|=i<<16-this.bitIndex,this.bitIndex-=16}var n=this.bitValue&W[t];return this.bitValue>>=t,this.bitIndex+=t,n},i.prototype.decodeMeta=function(){this.seek(this.sections.KFH.offset+12);var t=new Date(1e3*(this.readUint32()+946684800)),i=new Date(1e3*(this.readUint32()+946684800)),n=(this.readUint32(),this.readHex(10)),r=this.readHex(10),s=this.readHex(10),e=this.readWideChars(11),h=this.readWideChars(11),o=this.readWideChars(11),u=this.readChars(28),f=this.readChars(28),a=this.readChars(28),c=this.readUint16(),l=this.readUint16(),v=this.readUint16(),y=this.readUint8();this.readUint8();this.frameCount=c,this.thumbFrameIndex=l,this.frameSpeed=y,this.framerate=N[y],this.meta={lock:0!=(1&v),loop:0!=(2&v),frame_count:c,frame_speed:y,thumb_index:l,timestamp:i,creation_timestamp:t,root:{username:e,fsid:n,filename:u},parent:{username:h,fsid:r,filename:f},current:{username:o,fsid:s,filename:a}}},i.prototype.decodeMetaQuick=function(){this.seek(this.sections.KFH.offset+8+196);var t=this.readUint16(),i=this.readUint16(),n=(this.readUint16(),this.readUint8());this.readUint8();this.frameCount=t,this.thumbFrameIndex=i,this.frameSpeed=n,this.framerate=N[n]},i.prototype.getFrameOffsets=function(){for(var t=this.frameCount,i=this.sections.KMI,n=this.sections.KMC,r=new Uint32Array(t),s=new Uint32Array(t),e=[],h=i.offset+8,o=n.offset+12,u=0;u<t;u++){this.seek(h+4);var f=this.readUint16(),a=this.readUint16(),c=this.readUint16();r[u]=h,s[u]=o,h+=28,o+=f+a+c,e.push([f,a,c])}this.frameMetaOffsets=r,this.frameDataOffsets=s,this.frameLayerSizes=e},i.prototype.decodeSoundHeader=function(){var t;if(this.sections.hasOwnProperty("KSN")){var i=this.sections.KSN.offset+8;this.seek(i);var n=this.readUint32();this.bgmSpeed=n,this.bgmrate=N[n];var r=new Uint32Array(this.buffer,i+4,20);this.soundMeta=((t={})[o.BGM]={offset:i+=28,length:r[0]},t[o.SE1]={offset:i+=r[0],length:r[1]},t[o.SE2]={offset:i+=r[1],length:r[2]},t[o.SE3]={offset:i+=r[2],length:r[3]},t[o.SE4]={offset:i+=r[3],length:r[4]},t)}},i.prototype.getFramePaletteIndices=function(t){this.seek(this.frameMetaOffsets[t]);var i=this.readUint32();return[15&i,i>>8&15,i>>12&15,i>>16&15,i>>20&15,i>>24&15,i>>28&15]},i.prototype.getFrameDiffingFlag=function(t){return this.seek(this.frameMetaOffsets[t]),this.readUint32()>>4&7},i.prototype.getFrameLayerSizes=function(t){return this.seek(this.frameMetaOffsets[t]+4),[this.readUint16(),this.readUint16(),this.readUint16()]},i.prototype.getFrameLayerDepths=function(t){return this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]},i.prototype.getFrameAuthor=function(t){return this.seek(this.frameMetaOffsets[t]+10),this.readHex(10)},i.prototype.getFrameSoundFlags=function(t){this.seek(this.frameMetaOffsets[t]+23);var i=this.readUint8();return[0!=(1&i),0!=(2&i),0!=(3&i),0!=(4&i)]},i.prototype.getFrameLayerOrder=function(t){var i=this.getFrameLayerDepths(t);return[2,1,0].sort((function(t,n){return i[n]-i[t]}))},i.prototype.decodeFrame=function(t,n,r){void 0===n&&(n=7),void 0===r&&(r=!1),this.prevFrameIndex!==t-1&&0!==t&&(r&&(n&=~this.getFrameDiffingFlag(t+1)),0!==n&&this.decodeFrame(t-1,n,!0));for(var s=this.frameDataOffsets[t],e=this.frameLayerSizes[t],h=0;h<3&&(!this.config.dsiGalleryNote||3!==h);h++){this.seek(s);var o=e[h];if(s+=o,38!==o&&0!=(n>>h&1)){this.bitIndex=16,this.bitValue=0;for(var u=0,f=0;f<i.height;f+=128)for(var a=0;a<i.width;a+=128)for(var c=0;c<128;c+=8){var l=f+c;if(l>=i.height)break;for(var v=0;v<128;v+=8){var y=a+v;if(y>=i.width)break;if(u>0)u-=1;else{var d=l*i.width+y,p=this.layers[h],w=this.readBits(3);if(0==w){var A=this.readBits(5),b=D.subarray(8*A,8*A+8);p.set(b,d),p.set(b,d+320),p.set(b,d+640),p.set(b,d+960),p.set(b,d+1280),p.set(b,d+1600),p.set(b,d+1920),p.set(b,d+2240)}else if(1==w){A=this.readBits(13),b=T.subarray(8*A,8*A+8);p.set(b,d),p.set(b,d+320),p.set(b,d+640),p.set(b,d+960),p.set(b,d+1280),p.set(b,d+1600),p.set(b,d+1920),p.set(b,d+2240)}else if(2==w){var m=this.readBits(5),g=D.subarray(8*m,8*m+8),_=G.subarray(8*m,8*m+8);p.set(g,d),p.set(_,d+320),p.set(g,d+640),p.set(_,d+960),p.set(g,d+1280),p.set(_,d+1600),p.set(g,d+1920),p.set(_,d+2240)}else if(3==w){m=this.readBits(13),g=T.subarray(8*m,8*m+8),_=j.subarray(8*m,8*m+8);p.set(g,d),p.set(_,d+320),p.set(g,d+640),p.set(_,d+960),p.set(g,d+1280),p.set(_,d+1600),p.set(g,d+1920),p.set(_,d+2240)}else if(4==w)for(var z=this.readBits(8),U=d,S=0;S<8;S++){if(0!=(1&z)){A=this.readBits(5),b=D.subarray(8*A,8*A+8);p.set(b,U)}else{A=this.readBits(13),b=T.subarray(8*A,8*A+8);p.set(b,U)}z>>=1,U+=320}else{if(5==w){u=this.readBits(5);continue}if(7==w){var F=this.readBits(2);g=void 0,_=void 0;if(0!==this.readBits(1)){var x=this.readBits(5),I=this.readBits(5);g=D.subarray(8*x,8*x+8),_=D.subarray(8*I,8*I+8),F=(F+1)%4}else{x=this.readBits(13),I=this.readBits(13);g=T.subarray(8*x,8*x+8),_=T.subarray(8*I,8*I+8)}0==F?(p.set(g,d),p.set(_,d+320),p.set(g,d+640),p.set(_,d+960),p.set(g,d+1280),p.set(_,d+1600),p.set(g,d+1920),p.set(_,d+2240)):1==F?(p.set(g,d),p.set(g,d+320),p.set(_,d+640),p.set(g,d+960),p.set(g,d+1280),p.set(_,d+1600),p.set(g,d+1920),p.set(g,d+2240)):2==F?(p.set(g,d),p.set(_,d+320),p.set(g,d+640),p.set(g,d+960),p.set(_,d+1280),p.set(g,d+1600),p.set(g,d+1920),p.set(_,d+2240)):3==F&&(p.set(g,d),p.set(_,d+320),p.set(_,d+640),p.set(g,d+960),p.set(_,d+1280),p.set(_,d+1600),p.set(g,d+1920),p.set(_,d+2240))}}}}}}}return this.prevFrameIndex=t,this.layers},i.prototype.getFramePalette=function(t){var i=this;return this.getFramePaletteIndices(t).map((function(t){return i.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,n){this.prevFrameIndex!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),s=this.layers[n],e=new Uint8Array(i.width*i.height),h=2*n+1,o=0;o<s.length;o++){var u=s[o];1===u?e[o]=r[h]:2===u&&(e[o]=r[h+1])}return e},i.prototype.getFramePixels=function(t){this.prevFrameIndex!==t&&this.decodeFrame(t);var n=this.getFramePaletteIndices(t),r=this.getFrameLayerOrder(t),s=this.layers[r[2]],e=this.layers[r[1]],h=this.layers[r[0]],o=2*r[2],u=2*r[1],f=2*r[0];if(this.config.dsiGalleryNote){var a;(a=new Uint8Array(i.width*i.height)).fill(n[0]);for(var c=i.width-64,l=i.height-48,v=i.width,y=32;y<l;y++)for(var d=y*v,p=24;p<c;p++){A=s[d],b=e[d];0!==A?a[d]=n[o+A]:0!==b&&(a[d]=n[u+b]),d+=1}return a}(a=new Uint8Array(i.width*i.height)).fill(n[0]);for(var w=0;w<a.length;w++){var A=s[w],b=e[w],m=h[w];0!==A?a[w]=n[o+A]:0!==b?a[w]=n[u+b]:0!==m&&(a[w]=n[f+m])}return a},i.prototype.decodeSoundFlags=function(){for(var t=[],i=0;i<this.frameCount;i++)t.push(this.getFrameSoundFlags(i));return t},i.prototype.getAudioTrackRaw=function(t){var i=this.soundMeta[t];return new Uint8Array(this.buffer,i.offset,i.length)},i.prototype.decodeAudioTrack=function(t){for(var i,n,r,s=this.getAudioTrackRaw(t),e=new Int16Array(981840),h=0,o=0,u=40,f=0;f<s.length;f++)for(var a=s[f],l=0;l<8;)u<18||6==l?(n=o+w[(i=a>>l&3)+4*u],r=u+y[i],l+=2):(n=o+g[(i=a>>l&15)+16*u],r=u+d[i],l+=4),r=c(r,0,79),n=c(n,-2047,2047),e[h]=16*n,h+=1,u=r,o=n;return e.slice(0,h)},i.prototype.getAudioTrackPcm=function(t,i){void 0===i&&(i=32768);var n=this.decodeAudioTrack(t),r=this.rawSampleRate;if(t===o.BGM){var s=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*s}return r!==i?l(n,r,i):n},i.prototype.getAudioMasterPcm=function(t){void 0===t&&(t=32768);var i=this.frameCount*(1/this.framerate),n=Math.floor(i*t),r=new Int16Array(n),s=this.hasAudioTrack(o.BGM),e=this.hasAudioTrack(o.SE1),h=this.hasAudioTrack(o.SE2),u=this.hasAudioTrack(o.SE3),f=this.hasAudioTrack(o.SE4);s&&v(this.getAudioTrackPcm(o.BGM,t),r,0);if(e||h||u)for(var a=Math.floor(t/this.framerate),c=e?this.getAudioTrackPcm(o.SE1,t):null,l=h?this.getAudioTrackPcm(o.SE2,t):null,y=u?this.getAudioTrackPcm(o.SE3,t):null,d=f?this.getAudioTrackPcm(o.SE4,t):null,p=0;p<this.frameCount;p++){var w=this.getFrameSoundFlags(p),A=a*p;e&&w[0]&&v(c,r,A),h&&w[1]&&v(l,r,A),u&&w[2]&&v(y,r,A),f&&w[3]&&v(d,r,A)}return r},i.defaultConfig={quickMeta:!1,dsiGalleryNote:!1},i.type="KWZ",i.width=320,i.height=240,i.rawSampleRate=16364,i.sampleRate=32768,i.globalPalette=[R.WHITE,R.BLACK,R.RED,R.YELLOW,R.GREEN,R.BLUE,R.NONE],i}(a);function $(t,n){return function(t){return new Promise((function(n,r){i.forEach((function(i){i.matches(t)&&i.load(t,n,r)}))}))}(t).then((function(t){return new Promise((function(i,r){var s=new Uint8Array(t.slice(0,4)),e=s[0]<<24|s[1]<<16|s[2]<<8|s[3];1346458177===e?i(new S(t,n)):1262897152==(4294967040&e)?i(new K(t,n)):r()}))}))}var q=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],V=function(){function t(t,i,n,r){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=i,this.pixels=n,this.colorDepth=r,this.initCodeSize=Math.max(2,this.colorDepth),this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.a_count,this.remaining,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}return t.prototype.char_out=function(t,i){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(i)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var i=0;i<t;++i)this.htab[i]=-1},t.prototype.compress=function(t,i){var n,r,s,e,h,o;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,e=this.nextPixel(),o=0,n=5003;n<65536;n*=2)++o;o=8-o,this.cl_hash(5003),this.output(this.ClearCode,i);t:for(;-1!=(r=this.nextPixel());)if(n=(r<<12)+e,s=r<<o^e,this.htab[s]!==n){if(this.htab[s]>=0){h=5003-s,0===s&&(h=1);do{if((s-=h)<0&&(s+=5003),this.htab[s]===n){e=this.codetab[s];continue t}}while(this.htab[s]>=0)}this.output(e,i),e=r,this.free_ent<4096?(this.codetab[s]=this.free_ent++,this.htab[s]=n):this.cl_block(i)}else e=this.codetab[s];this.output(e,i),this.output(this.EOFCode,i)},t.prototype.encode=function(t){t.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,t),t.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,i){for(this.cur_accum&=q[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,i),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(i)}},t}(),H=function(){function t(i,n,r){void 0===r&&(r={}),this.palette=[],this.width=i,this.height=n,this.data=new u,this.meta=s(s({},t.defaultMeta),r)}return t.fromFlipnote=function(i,n){void 0===n&&(n={});var r=new t(i.width,i.height,s({delay:100/i.framerate,repeat:i.meta.loop?-1:0},n));r.palette=i.globalPalette,r.init();for(var e=0;e<i.frameCount;e++)r.writeFrame(i.getFramePixels(e));return r},t.fromFlipnoteFrame=function(i,n,r){void 0===r&&(r={});var e=new t(i.width,i.height,s({delay:100/i.framerate,repeat:-1},r));return e.palette=i.globalPalette,e.init(),e.writeFrame(i.getFramePixels(n)),e},t.prototype.init=function(){for(var t=this.palette.length,i=1;1<<i<t;i+=1)continue;this.meta.colorDepth=i,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt()},t.prototype.writeHeader=function(){var t=new f(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.meta.colorDepth-1),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.meta.colorDepth)),i=0,n=0;n<this.palette.length;n+=1){var r=this.palette[n],s=r[0],e=r[1],h=r[2];r[3];t[i++]=s,t[i++]=e,t[i++]=h}this.data.writeBytes(t)},t.prototype.writeNetscapeExt=function(){var t=new f(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.meta.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writeFrameHeader=function(){var t=new f(new ArrayBuffer(18)),i=this.meta.transparentBg?1:0;t.writeBytes([33,249,4,0|i]),t.writeUint16(this.meta.delay),t.writeBytes([0,0]),t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},t.prototype.writePixels=function(t){new V(this.width,this.height,t,this.meta.colorDepth).encode(this.data)},t.prototype.writeFrame=function(t){this.writeFrameHeader(),this.writePixels(t)},t.prototype.getBuffer=function(){return this.data.getBuffer()},t.prototype.getBlob=function(){return new Blob([this.getBuffer()],{type:"image/gif"})},t.prototype.getUrl=function(){return window.URL.createObjectURL(this.getBlob())},t.prototype.getImage=function(){var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},t.defaultMeta={transparentBg:!1,delay:100,repeat:-1,colorDepth:8},t}(),Z=function(){function t(t,i,n){void 0===i&&(i=1),void 0===n&&(n=16),this.sampleRate=t,this.channels=i,this.bitsPerSample=n;var r=new ArrayBuffer(44),s=new f(r);s.writeChars("RIFF"),s.writeUint32(0),s.writeChars("WAVE"),s.writeChars("fmt "),s.writeUint32(16),s.writeUint16(1),s.writeUint16(this.channels),s.writeUint32(this.sampleRate),s.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),s.writeUint16(this.bitsPerSample*this.channels/8),s.writeUint16(this.bitsPerSample),s.writeChars("data"),s.writeUint32(0),this.header=s,this.pcmData=null}return t.fromFlipnote=function(i){var n=i.sampleRate,r=new t(n,1,16),s=i.getAudioMasterPcm(n);return r.writeFrames(s),r},t.fromFlipnoteTrack=function(i,n){var r=i.sampleRate,s=new t(r,1,16),e=i.getAudioTrackPcm(n,r);return s.writeFrames(e),s},t.prototype.writeFrames=function(t){var i=this.header;i.seek(4),i.writeUint32(i.byteLength+t.byteLength),i.seek(40),i.writeUint32(t.byteLength),this.pcmData=t},t.prototype.getBlob=function(){return new Blob([this.header.buffer,this.pcmData.buffer],{type:"audio/wav"})},t}();function X(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const J="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function Q(t,i){return"undefined"!=typeof WebGLTexture&&i instanceof WebGLTexture}const tt="";function it(t,i,n,r){if(s=i,"undefined"!=typeof WebGLBuffer&&s instanceof WebGLBuffer)return i;var s;n=n||34962;const e=t.createBuffer();return function(t,i,n,r,s){t.bindBuffer(i,n),t.bufferData(i,r,s||35044)}(t,n,e,i,r),e}function nt(t){return"indices"===t}const rt=/coord|texture/i,st=/color|colour/i;function et(t,i){let n;if(n=rt.test(t)?2:st.test(t)?4:3,i%n>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${n} but ${i} values is not evenly divisible by ${n}. You should specify it.`);return n}function ht(t,i){if(J(t))return t;if(J(t.data))return t.data;Array.isArray(t)&&(t={data:t});let n=t.type;return n||(n=nt(i)?Uint16Array:Float32Array),new n(t.data)}function ot(t,i){const n={};return Object.keys(i).forEach((function(r){if(!nt(r)){const e=i[r],h=e.attrib||e.name||e.attribName||tt+r;if(e.value){if(!Array.isArray(e.value)&&!J(e.value))throw new Error("array.value is not array or typedarray");n[h]={value:e.value}}else{let i,o,u,f;if(e.buffer&&e.buffer instanceof WebGLBuffer)i=e.buffer,f=e.numComponents||e.size,o=e.type,u=e.normalize;else if("number"==typeof e||"number"==typeof e.data){const n=e.data||e,h=e.type||Float32Array,a=n*h.BYTES_PER_ELEMENT;o=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(h),u=void 0!==e.normalize?e.normalize:(s=h)===Int8Array||s===Uint8Array,f=e.numComponents||e.size||et(r,n),i=t.createBuffer(),t.bindBuffer(34962,i),t.bufferData(34962,a,e.drawType||35044)}else{const n=ht(e,r);i=it(t,n,void 0,e.drawType),o=X(n),u=void 0!==e.normalize?e.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(n),f=function(t,i){return t.numComponents||t.size||et(i,function(t){return t.length?t:t.data}(t).length)}(e,r)}n[h]={buffer:i,numComponents:f,type:o,normalize:u,stride:e.stride||0,offset:e.offset||0,divisor:void 0===e.divisor?void 0:e.divisor,drawType:e.drawType}}}var s})),t.bindBuffer(34962,null),n}const ut=["position","positions","a_position"];function ft(t,i,n){const r=ot(t,i),s=Object.assign({},n||{});s.attribs=Object.assign({},n?n.attribs:{},r);const e=i.indices;if(e){const i=ht(e,"indices");s.indices=it(t,i,34963),s.numElements=i.length,s.elementType=X(i)}else s.numElements||(s.numElements=function(t,i){let n,r;for(r=0;r<ut.length&&(n=ut[r],!(n in i))&&(n=tt+n,!(n in i));++r);r===ut.length&&(n=Object.keys(i)[0]);const s=i[n];t.bindBuffer(34962,s.buffer);const e=t.getBufferParameter(34962,34660);var h;t.bindBuffer(34962,null);const o=e/(5120===(h=s.type)||5121===h?1:5122===h||5123===h?2:5124===h||5125===h||5126===h?4:0),u=s.numComponents||s.size,f=o/u;if(f%1!=0)throw new Error(`numComponents ${u} not correct for length ${length}`);return f}(t,s.attribs));return s}function at(t){return!!t.texStorage2D}const ct={};function lt(t,i){return ct[i].bindPoint}function vt(t,i){return function(n){t.uniform1i(i,n)}}function yt(t,i){return function(n){t.uniform1iv(i,n)}}function dt(t,i){return function(n){t.uniform2iv(i,n)}}function pt(t,i){return function(n){t.uniform3iv(i,n)}}function wt(t,i){return function(n){t.uniform4iv(i,n)}}function At(t,i,n,r){const s=lt(0,i);return at(t)?function(i){let e,h;Q(0,i)?(e=i,h=null):(e=i.texture,h=i.sampler),t.uniform1i(r,n),t.activeTexture(33984+n),t.bindTexture(s,e),t.bindSampler(n,h)}:function(i){t.uniform1i(r,n),t.activeTexture(33984+n),t.bindTexture(s,i)}}function bt(t,i,n,r,s){const e=lt(0,i),h=new Int32Array(s);for(let t=0;t<s;++t)h[t]=n+t;return at(t)?function(i){t.uniform1iv(r,h),i.forEach((function(i,r){let s,o;t.activeTexture(33984+h[r]),Q(0,i)?(s=i,o=null):(s=i.texture,o=i.sampler),t.bindSampler(n,o),t.bindTexture(e,s)}))}:function(i){t.uniform1iv(r,h),i.forEach((function(i,n){t.activeTexture(33984+h[n]),t.bindTexture(e,i)}))}}function mt(t,i){return function(n){if(n.value)switch(t.disableVertexAttribArray(i),n.value.length){case 4:t.vertexAttrib4fv(i,n.value);break;case 3:t.vertexAttrib3fv(i,n.value);break;case 2:t.vertexAttrib2fv(i,n.value);break;case 1:t.vertexAttrib1fv(i,n.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,n.buffer),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,n.numComponents||n.size,n.type||5126,n.normalize||!1,n.stride||0,n.offset||0),void 0!==n.divisor&&t.vertexAttribDivisor(i,n.divisor)}}function gt(t,i){return function(n){if(n.value){if(t.disableVertexAttribArray(i),4!==n.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(i,n.value)}else t.bindBuffer(34962,n.buffer),t.enableVertexAttribArray(i),t.vertexAttribIPointer(i,n.numComponents||n.size,n.type||5124,n.stride||0,n.offset||0),void 0!==n.divisor&&t.vertexAttribDivisor(i,n.divisor)}}function _t(t,i){return function(n){if(n.value){if(t.disableVertexAttribArray(i),4!==n.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(i,n.value)}else t.bindBuffer(34962,n.buffer),t.enableVertexAttribArray(i),t.vertexAttribIPointer(i,n.numComponents||n.size,n.type||5125,n.stride||0,n.offset||0),void 0!==n.divisor&&t.vertexAttribDivisor(i,n.divisor)}}function zt(t,i,n){const r=n.size,s=n.count;return function(n){t.bindBuffer(34962,n.buffer);const e=n.size||n.numComponents||r,h=e/s,o=n.type||5126,u=ct[o].size*e,f=n.normalize||!1,a=n.offset||0,c=u/s;for(let r=0;r<s;++r)t.enableVertexAttribArray(i+r),t.vertexAttribPointer(i+r,h,o,f,u,a+c*r),void 0!==n.divisor&&t.vertexAttribDivisor(i+r,n.divisor)}}ct[5126]={Type:Float32Array,size:4,setter:function(t,i){return function(n){t.uniform1f(i,n)}},arraySetter:function(t,i){return function(n){t.uniform1fv(i,n)}}},ct[35664]={Type:Float32Array,size:8,setter:function(t,i){return function(n){t.uniform2fv(i,n)}}},ct[35665]={Type:Float32Array,size:12,setter:function(t,i){return function(n){t.uniform3fv(i,n)}}},ct[35666]={Type:Float32Array,size:16,setter:function(t,i){return function(n){t.uniform4fv(i,n)}}},ct[5124]={Type:Int32Array,size:4,setter:vt,arraySetter:yt},ct[35667]={Type:Int32Array,size:8,setter:dt},ct[35668]={Type:Int32Array,size:12,setter:pt},ct[35669]={Type:Int32Array,size:16,setter:wt},ct[5125]={Type:Uint32Array,size:4,setter:function(t,i){return function(n){t.uniform1ui(i,n)}},arraySetter:function(t,i){return function(n){t.uniform1uiv(i,n)}}},ct[36294]={Type:Uint32Array,size:8,setter:function(t,i){return function(n){t.uniform2uiv(i,n)}}},ct[36295]={Type:Uint32Array,size:12,setter:function(t,i){return function(n){t.uniform3uiv(i,n)}}},ct[36296]={Type:Uint32Array,size:16,setter:function(t,i){return function(n){t.uniform4uiv(i,n)}}},ct[35670]={Type:Uint32Array,size:4,setter:vt,arraySetter:yt},ct[35671]={Type:Uint32Array,size:8,setter:dt},ct[35672]={Type:Uint32Array,size:12,setter:pt},ct[35673]={Type:Uint32Array,size:16,setter:wt},ct[35674]={Type:Float32Array,size:16,setter:function(t,i){return function(n){t.uniformMatrix2fv(i,!1,n)}}},ct[35675]={Type:Float32Array,size:36,setter:function(t,i){return function(n){t.uniformMatrix3fv(i,!1,n)}}},ct[35676]={Type:Float32Array,size:64,setter:function(t,i){return function(n){t.uniformMatrix4fv(i,!1,n)}}},ct[35685]={Type:Float32Array,size:24,setter:function(t,i){return function(n){t.uniformMatrix2x3fv(i,!1,n)}}},ct[35686]={Type:Float32Array,size:32,setter:function(t,i){return function(n){t.uniformMatrix2x4fv(i,!1,n)}}},ct[35687]={Type:Float32Array,size:24,setter:function(t,i){return function(n){t.uniformMatrix3x2fv(i,!1,n)}}},ct[35688]={Type:Float32Array,size:48,setter:function(t,i){return function(n){t.uniformMatrix3x4fv(i,!1,n)}}},ct[35689]={Type:Float32Array,size:32,setter:function(t,i){return function(n){t.uniformMatrix4x2fv(i,!1,n)}}},ct[35690]={Type:Float32Array,size:48,setter:function(t,i){return function(n){t.uniformMatrix4x3fv(i,!1,n)}}},ct[35678]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:3553},ct[35680]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:34067},ct[35679]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:32879},ct[35682]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:3553},ct[36289]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:35866},ct[36292]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:35866},ct[36293]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:34067},ct[36298]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:3553},ct[36299]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:32879},ct[36300]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:34067},ct[36303]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:35866},ct[36306]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:3553},ct[36307]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:32879},ct[36308]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:34067},ct[36311]={Type:null,size:0,setter:At,arraySetter:bt,bindPoint:35866};const Ut={};function St(t){const i=t.name;return i.startsWith("gl_")||i.startsWith("webgl_")}function Tt(t,i){const n=t.uniformSetters||t,r=arguments.length;for(let t=1;t<r;++t){const i=arguments[t];if(Array.isArray(i)){const t=i.length;for(let r=0;r<t;++r)Tt(n,i[r])}else for(const t in i){const r=n[t];r&&r(i[t])}}}function Ft(t,i){const n={program:i,uniformSetters:function(t,i){let n=0;function r(i,r,s){const e=r.size>1&&"[0]"===r.name.substr(-3),h=r.type,o=ct[h];if(!o)throw new Error("unknown type: 0x"+h.toString(16));let u;if(o.bindPoint){const i=n;n+=r.size,u=e?o.arraySetter(t,h,i,s,r.size):o.setter(t,h,i,s,r.size)}else u=o.arraySetter&&e?o.arraySetter(t,s):o.setter(t,s);return u.location=s,u}const s={},e=t.getProgramParameter(i,35718);for(let n=0;n<e;++n){const e=t.getActiveUniform(i,n);if(St(e))continue;let h=e.name;"[0]"===h.substr(-3)&&(h=h.substr(0,h.length-3));const o=t.getUniformLocation(i,e.name);o&&(s[h]=r(0,e,o))}return s}(t,i),attribSetters:function(t,i){const n={},r=t.getProgramParameter(i,35721);for(let s=0;s<r;++s){const r=t.getActiveAttrib(i,s);if(St(r))continue;const e=t.getAttribLocation(i,r.name),h=Ut[r.type],o=h.setter(t,e,h);o.location=e,n[r.name]=o}return n}(t,i)};return at(t)&&(n.uniformBlockSpec=function(t,i){const n=t.getProgramParameter(i,35718),r=[],s=[];for(let e=0;e<n;++e){s.push(e),r.push({});const n=t.getActiveUniform(i,e);if(St(n))break;r[e].name=n.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(n){const e=n[0],h=n[1];t.getActiveUniforms(i,s,t[e]).forEach((function(t,i){r[i][h]=t}))}));const e={},h=t.getProgramParameter(i,35382);for(let n=0;n<h;++n){const r=t.getActiveUniformBlockName(i,n),s={index:t.getUniformBlockIndex(i,r),usedByVertexShader:t.getActiveUniformBlockParameter(i,n,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(i,n,35398),size:t.getActiveUniformBlockParameter(i,n,35392),uniformIndices:t.getActiveUniformBlockParameter(i,n,35395)};s.used=s.usedByVertexShader||s.usedByFragmentShader,e[r]=s}return{blockSpecs:e,uniformData:r}}(t,i),n.transformFeedbackInfo=function(t,i){const n={},r=t.getProgramParameter(i,35971);for(let s=0;s<r;++s){const r=t.getTransformFeedbackVarying(i,s);n[r.name]={index:s,type:r.type,size:r.size}}return n}(t,i)),n}Ut[5126]={size:4,setter:mt},Ut[35664]={size:8,setter:mt},Ut[35665]={size:12,setter:mt},Ut[35666]={size:16,setter:mt},Ut[5124]={size:4,setter:gt},Ut[35667]={size:8,setter:gt},Ut[35668]={size:12,setter:gt},Ut[35669]={size:16,setter:gt},Ut[5125]={size:4,setter:_t},Ut[36294]={size:8,setter:_t},Ut[36295]={size:12,setter:_t},Ut[36296]={size:16,setter:_t},Ut[35670]={size:4,setter:gt},Ut[35671]={size:8,setter:gt},Ut[35672]={size:12,setter:gt},Ut[35673]={size:16,setter:gt},Ut[35674]={size:4,setter:zt,count:2},Ut[35675]={size:9,setter:zt,count:3},Ut[35676]={size:16,setter:zt,count:4};var xt,It="#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}",Et=function(){function t(t,i,n){void 0===i&&(i=640),void 0===n&&(n=480),this.refs={programs:[],shaders:[],textures:[],buffers:[],framebuffers:[]};var r=t.getContext("webgl",{antialias:!1,alpha:!0});this.el=t,this.gl=r,this.layerDrawProgram=this.createProgram(It,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_palette;uniform sampler2D u_bitmap;uniform float u_paletteOffset;const vec4 transparent=vec4(0,0,0,0);void main(){float index=texture2D(u_bitmap,v_uv).a*255.;if(index>0.){gl_FragColor=texture2D(u_palette,vec2((u_paletteOffset+index)/255.,.5));}else{gl_FragColor=transparent;}}"),this.postProcessProgram=this.createProgram(It,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,8,8),this.setBuffersAndAttribs(this.layerDrawProgram,this.quadBuffer),this.setBuffersAndAttribs(this.postProcessProgram,this.quadBuffer),this.paletteTexture=this.createTexture(r.RGBA,r.NEAREST,r.CLAMP_TO_EDGE,256,1),this.layerTexture=this.createTexture(r.ALPHA,r.NEAREST,r.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(r.RGBA,r.LINEAR,r.CLAMP_TO_EDGE),this.frameBuffer=this.createFrameBuffer(this.frameTexture),this.setCanvasSize(i,n)}return t.prototype.createProgram=function(t,i){var n=this.gl,r=this.createShader(n.VERTEX_SHADER,t),s=this.createShader(n.FRAGMENT_SHADER,i),e=n.createProgram();if(n.attachShader(e,r),n.attachShader(e,s),n.linkProgram(e),!n.getProgramParameter(e,n.LINK_STATUS)){var h=n.getProgramInfoLog(e);throw n.deleteProgram(e),new Error(h)}var o=Ft(n,e);return this.refs.programs.push(e),o},t.prototype.createShader=function(t,i){var n=this.gl,r=n.createShader(t);if(n.shaderSource(r,i),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){var s=n.getShaderInfoLog(r);throw n.deleteShader(r),new Error(s)}return this.refs.shaders.push(r),r},t.prototype.createScreenQuad=function(t,i,n,r,s,e){for(var h=(s+1)*(e+1),o=s+1,u=new Float32Array(2*h),f=new Float32Array(2*h),a=0,c=0,l=0;l<=e;l++)for(var v=0;v<=s;v++){var y=v/s,d=l/e;u[a++]=t+n*y,u[a++]=i+r*d,f[c++]=y,f[c++]=d}var p=new Uint16Array(s*e*2*3),w=0;for(l=0;l<e;l++)for(v=0;v<s;v++)p[w++]=(l+0)*o+v,p[w++]=(l+1)*o+v,p[w++]=(l+0)*o+v+1,p[w++]=(l+0)*o+v+1,p[w++]=(l+1)*o+v,p[w++]=(l+1)*o+v+1;var A=ft(this.gl,{position:{numComponents:2,data:u},texcoord:{numComponents:2,data:f},indices:p});for(var b in A.attribs)this.refs.buffers.push(A.attribs[b].buffer);return A},t.prototype.setBuffersAndAttribs=function(t,i){var n=this.gl;!function(t,i){for(const n in i){const r=t[n];r&&r(i[n])}}(t.attribSetters,i.attribs),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i.indices)},t.prototype.createTexture=function(t,i,n,r,s){void 0===r&&(r=1),void 0===s&&(s=1);var e=this.gl,h=e.createTexture();return e.bindTexture(e.TEXTURE_2D,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,i),e.texImage2D(e.TEXTURE_2D,0,t,r,s,0,t,e.UNSIGNED_BYTE,null),this.refs.textures.push(h),h},t.prototype.createFrameBuffer=function(t){var i=this.gl,n=i.createFramebuffer();return i.bindFramebuffer(i.FRAMEBUFFER,n),i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0),this.refs.framebuffers.push(n),n},t.prototype.setCanvasSize=function(t,i){var n=window.devicePixelRatio||1,r=t*n,s=i*n;this.el.width=r,this.el.height=s,this.screenWidth=r,this.screenHeight=s,this.el.style.width=t+"px",this.el.style.height=i+"px"},t.prototype.setTextureSize=function(t,i){var n=this.gl;this.textureWidth=t,this.textureHeight=i,n.bindTexture(n.TEXTURE_2D,this.frameTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.textureWidth,this.textureHeight,0,n.RGBA,n.UNSIGNED_BYTE,null)},t.prototype.clearFrameBuffer=function(t){var i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.viewport(0,0,this.textureWidth,this.textureHeight);var n=t[0],r=t[1],s=t[2],e=t[3];i.clearColor(n/255,r/255,s/255,e/255),i.clear(i.COLOR_BUFFER_BIT)},t.prototype.setPalette=function(t){for(var i=this.gl,n=new Uint8Array(1024),r=0,s=0;s<t.length;s++){var e=t[s],h=e[0],o=e[1],u=e[2],f=e[3];n[r++]=h,n[r++]=o,n[r++]=u,n[r++]=f}i.bindTexture(i.TEXTURE_2D,this.paletteTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,256,1,0,i.RGBA,i.UNSIGNED_BYTE,n)},t.prototype.drawPixels=function(t,i){var n=this,r=n.gl,s=n.layerDrawProgram,e=n.layerTexture,h=n.textureWidth,o=n.textureHeight;r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer),r.viewport(0,0,h,o),r.useProgram(s.program),r.bindTexture(r.TEXTURE_2D,e),r.texImage2D(r.TEXTURE_2D,0,r.ALPHA,h,o,0,r.ALPHA,r.UNSIGNED_BYTE,t),Tt(s,{u_palette:this.paletteTexture,u_paletteOffset:i,u_bitmap:e,u_textureSize:[h,o],u_screenSize:[r.drawingBufferWidth,r.drawingBufferHeight]}),r.drawElements(r.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.composite=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.useProgram(this.postProcessProgram.program),t.clear(t.COLOR_BUFFER_BIT),Tt(this.postProcessProgram,{u_flipY:!0,u_tex:this.frameTexture,u_textureSize:[this.textureWidth,this.textureHeight],u_screenSize:[t.drawingBufferWidth,t.drawingBufferHeight]}),t.drawElements(t.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.resize=function(t,i){void 0===t&&(t=640),void 0===i&&(i=480),this.setCanvasSize(t,i)},t.prototype.destroy=function(){var t=this.refs,i=this.gl;t.shaders.forEach((function(t){i.deleteShader(t)})),t.shaders=[],t.framebuffers.forEach((function(t){i.deleteFramebuffer(t)})),t.framebuffers=[],t.textures.forEach((function(t){i.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){i.deleteBuffer(t)})),t.buffers=[],t.programs.forEach((function(t){i.deleteProgram(t)})),t.programs=[],i.canvas.width=1,i.canvas.height=1},t}(),kt=window.AudioContext||window.webkitAudioContext,Ot=function(){function t(){this.useEq=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this.t=1,this.ctx=new kt}return Object.defineProperty(t.prototype,"volume",{get:function(){return this.t},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),t.prototype.setSamples=function(t,i){var n=t.length,r=this.ctx.createBuffer(1,n,i),s=r.getChannelData(0);if(t instanceof Float32Array)s.set(t,0);else if(t instanceof Int16Array)for(var e=0;e<n;e++)s[e]=t[e]/32767;this.buffer=r,this.sampleRate=i},t.prototype.connectEqNodesTo=function(t){var i=this.ctx,n=this.eqSettings,r=t;return n.forEach((function(t,s){var e=t[0],h=t[1],o=i.createBiquadFilter();o.frequency.value=e,o.gain.value=h,0===s?o.type="lowshelf":s===n.length-1?o.type="highshelf":o.type="peaking",r.connect(o),r=o})),r},t.prototype.initNodes=function(){var t=this.ctx,i=t.createBufferSource();i.buffer=this.buffer;var n=t.createGain();this.useEq?this.connectEqNodesTo(i).connect(n):i.connect(n);i.connect(n),n.connect(t.destination),this.source=i,this.gainNode=n,this.setVolume(this.t)},t.prototype.setVolume=function(t){this.t=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))},t.prototype.stop=function(){this.source.stop(0)},t.prototype.playFrom=function(t){this.initNodes(),this.source.start(0,t)},t}(),Pt=function(){var t=document.createElement("a");return function(i,n){var r=window.URL.createObjectURL(i);t.href=r,t.download=n,t.click(),window.URL.revokeObjectURL(r)}}(),Bt=function(){function t(i,n,r){this.loop=!1,this.paused=!0,this.duration=0,this.isOpen=!1,this.events={},this.i=-1,this.s=-1,this.h=-1,this.hasPlaybackStarted=!1,this.wasPlaying=!1,this.isSeeking=!1,i="string"==typeof i?document.querySelector(i):i,this.canvas=new Et(i,n,r),this.audio=new Ot,this.el=this.canvas.el,this.customPalette=null,this.state=s({},t.defaultState)}return Object.defineProperty(t.prototype,"currentFrame",{get:function(){return this.s},set:function(t){this.setFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return this.isOpen?this.h:null},set:function(t){this.isOpen&&t<=this.duration&&t>=0&&(this.setFrame(Math.round(t/(1/this.framerate))),this.h=t,this.emit("progress",this.progress))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"progress",{get:function(){return this.isOpen?this.h/this.duration*100:0},set:function(t){this.currentTime=this.duration*(t/100)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this.audio.volume},set:function(t){this.audio.volume=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"muted",{get:function(){return!1},set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),t.prototype.setState=function(t){t=s(s({},this.state),t);this.state;this.emit("state:change")},t.prototype.open=function(t){return e(this,void 0,void 0,(function(){var i=this;return h(this,(function(n){return this.isOpen&&this.close(),[2,$(t).then((function(t){return i.load(t)})).catch((function(t){throw i.emit("error",t),console.error("Error loading Flipnote:",t),"Error loading Flipnote"}))]}))}))},t.prototype.close=function(){this.pause(),this.note=null,this.isOpen=!1,this.paused=!0,this.loop=null,this.meta=null,this.s=null,this.h=null,this.duration=null,this.loop=null,this.hasPlaybackStarted=null},t.prototype.load=function(t){this.note=t,this.meta=t.meta,this.type=t.type,this.loop=t.meta.loop,this.duration=this.note.frameCount*(1/this.note.framerate),this.paused=!0,this.isOpen=!0,this.hasPlaybackStarted=!1,this.layerVisibility={1:!0,2:!0,3:!0};var i=this.note.sampleRate,n=t.getAudioMasterPcm();this.audio.setSamples(n,i),this.canvas.setTextureSize(t.width,t.height),this.setFrame(this.note.thumbFrameIndex),this.h=0,this.emit("load")},t.prototype.playAudio=function(){this.audio.playFrom(this.currentTime)},t.prototype.stopAudio=function(){this.audio.stop()},t.prototype.toggleEq=function(){this.stopAudio(),this.audio.useEq=!this.audio.useEq,this.playAudio()},t.prototype.playbackLoop=function(t){if(this.paused)return this.stopAudio(),null;var i=t/1e3,n=i-this.i;n>this.duration?this.loop?(this.currentTime=0,this.playAudio(),this.i=i,this.emit("playback:loop")):(this.pause(),this.emit("playback:end")):this.currentTime=n,requestAnimationFrame(this.playbackLoop.bind(this))},t.prototype.play=function(){if(window.__activeFlipnotePlayer=this,!this.isOpen||!this.paused)return null;this.hasPlaybackStarted&&(this.loop||this.currentFrame!=this.frameCount-1)||(this.h=0),this.paused=!1,this.hasPlaybackStarted=!0,this.i=performance.now()/1e3-this.currentTime,this.playAudio(),requestAnimationFrame(this.playbackLoop.bind(this)),this.emit("playback:start")},t.prototype.pause=function(){if(!this.isOpen||this.paused)return null;this.paused=!0,this.stopAudio(),this.emit("playback:stop")},t.prototype.togglePlay=function(){this.paused?this.play():this.pause()},t.prototype.setFrame=function(t){this.isOpen&&t!==this.currentFrame&&(t=Math.max(0,Math.min(Math.floor(t),this.frameCount-1)),this.drawFrame(t),this.s=t,this.paused&&(this.h=t*(1/this.framerate),this.emit("progress",this.progress)),this.emit("frame:update",this.currentFrame))},t.prototype.nextFrame=function(){this.loop&&this.currentFrame>=this.frameCount-1?this.currentFrame=0:this.currentFrame+=1},t.prototype.prevFrame=function(){this.loop&&this.currentFrame<=0?this.currentFrame=this.frameCount-1:this.currentFrame-=1},t.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1},t.prototype.firstFrame=function(){this.currentFrame=0},t.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},t.prototype.startSeek=function(){this.isSeeking||(this.wasPlaying=!this.paused,this.pause(),this.isSeeking=!0)},t.prototype.seek=function(t){this.isSeeking&&(this.progress=t)},t.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},t.prototype.getMasterWav=function(){return Z.fromFlipnote(this.note)},t.prototype.saveMasterWav=function(){var t=this.getMasterWav();Pt(t.getBlob(),this.meta.current.filename+".wav")},t.prototype.getFrameGif=function(t,i){return void 0===i&&(i={}),H.fromFlipnoteFrame(this.note,t,i)},t.prototype.saveFrameGif=function(t,i){void 0===i&&(i={});var n=this.getFrameGif(t,i);Pt(n.getBlob(),this.meta.current.filename+"_"+t.toString().padStart(3,"0")+".gif")},t.prototype.getAnimatedGif=function(t){return void 0===t&&(t={}),H.fromFlipnote(this.note,t)},t.prototype.saveAnimatedGif=function(t){void 0===t&&(t={});var i=this.getAnimatedGif(t);Pt(i.getBlob(),this.meta.current.filename+".gif")},t.prototype.drawFrame=function(t){var i=this.note.getFramePalette(t),n=this.note.decodeFrame(t);if(this.canvas.setPalette(i),this.canvas.clearFrameBuffer(i[0]),"PPM"===this.note.type)this.layerVisibility[2]&&this.canvas.drawPixels(n[1],1),this.layerVisibility[1]&&this.canvas.drawPixels(n[0],0);else if("KWZ"===this.note.type){var r=this.note.getFrameLayerOrder(t),s=r[0],e=r[1],h=r[2];this.layerVisibility[s+1]&&this.canvas.drawPixels(n[s],2*s),this.layerVisibility[e+1]&&this.canvas.drawPixels(n[e],2*e),this.layerVisibility[h+1]&&this.canvas.drawPixels(n[h],2*h)}this.canvas.composite()},t.prototype.forceUpdate=function(){this.isOpen&&this.drawFrame(this.currentFrame)},t.prototype.resize=function(t,i){this.canvas.resize(t,i),this.forceUpdate()},t.prototype.setLayerVisibility=function(t,i){this.layerVisibility[t]=i,this.forceUpdate()},t.prototype.toggleLayerVisibility=function(t){this.setLayerVisibility(t,!this.layerVisibility[t])},t.prototype.on=function(t,i){var n=this.events;(n[t]||(n[t]=[])).push(i)},t.prototype.off=function(t,i){var n=this.events[t];n&&n.splice(n.indexOf(i),1)},t.prototype.emit=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];for(var r=this.events[t]||[],s=0;s<r.length;s++)r[s].apply(null,i)},t.prototype.clearEvents=function(){this.events={}},t.prototype.destroy=function(){this.close(),this.canvas.destroy()},t.defaultState={noteType:null,isNoteOpen:!1,paused:!1,hasPlaybackStarted:!1,frame:-1,time:-1,loop:!1,volume:1,muted:!1,layerVisibility:{1:!0,2:!0,3:!0},isSeeking:!1,wasPlaying:!1},t}();!function(t){t.version="5.0.0",t.Player=Bt,t.parseSource=$,t.KwzFile=K,t.PpmFile=S,t.GifEncoder=H,t.WavEncoder=Z,t.player=Bt,t.kwzParser=K,t.ppmParser=S,t.gifEncoder=H,t.wavEncoder=Z}(xt||(xt={}));var Mt=xt,jt=Bt,Lt=$,Ct=K,Dt=S,Gt=H,Nt=Z,Rt=Bt,Wt=K,Yt=S,Kt=H,$t=Z;t.GifEncoder=Gt,t.KwzFile=Ct,t.Player=jt,t.PpmFile=Dt,t.WavEncoder=Nt,t.default=Mt,t.gifEncoder=Kt,t.kwzParser=Wt,t.parseSource=Lt,t.player=Rt,t.ppmParser=Yt,t.version="5.0.0",t.wavEncoder=$t,Object.defineProperty(t,"o",{value:!0})}));
